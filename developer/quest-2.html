<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Story Weaver's Loom - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'developer' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Codex of Infinite Adventures</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Story Weaver&#39;s Loom</h1>
<hr>
<p>The Repository Nexus shimmered with a newfound energy as you prepared for the second challenge. This quest would take you into the Story Weaver’s Loom, the mysterious mechanism that spun raw repomix data into vibrant, thematic narratives. Your mission? To unravel the threads of the quest generation engine and understand how stories and adventures are woven seamlessly together. Prepare yourself — the heart of the adventure engine awaits!</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a>: Adventure Management and Orchestration</h3>
<p>This is the central class responsible for managing adventures in the system, handling user choices, orchestrating quest generation, and maintaining the overall state of the journey. The <code class="inline-code">AdventureManager</code> class serves as a mediator between various components, initializing adventures based on repository data and themes while keeping track of user progress through quests. It uses the <code class="inline-code">AdventureState</code> class to persist data like the current story, quests, and progress percentage. A highlight of its functionality is the ability to merge files defined in the <code class="inline-code">adventure.config.json</code> into the quests, ensuring each quest is tailored to its expected file scope.</p>
<p>Key methods include <code class="inline-code">initializeAdventure()</code>, which sets up the entire adventure framework by calling a language model to generate quests and stories. The <code class="inline-code">exploreQuest()</code> function stands out as the driving force of quest execution. It validates user input, caches completed quests for efficiency, and handles content generation dynamically based on project files. The clever caching mechanism through <code class="inline-code">state.questContentCache</code> ensures previously visited quests don&#39;t waste resources.</p>
<h4>Highlights</h4>
<ul>
<li>The <code class="inline-code">initializeAdventure</code> method ensures seamless integration of story generation with user-defined configurations.</li>
<li><code class="inline-code">exploreQuest</code> combines validation, execution, and caching into one method for a rich user experience.</li>
<li>Dynamic quest content generation avoids redundancy through effective state management and caching.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a>: The Engines of Thematic Creativity</h3>
<p>This file houses the mechanics that transform mundane repository code into rich, themed narratives. The <code class="inline-code">StoryGenerator</code> class is loaded with responsibilities: it prompts the LLM for unique story ideas using context from the repository, manages project-based themes, and ensures the narrative aligns with user expectations. The <code class="inline-code">generateStoryAndQuests()</code> method acts as the entry point for generating entire stories and quest lists. It queries the LLM using both repository analysis and optional <code class="inline-code">adventure.config.json</code> guidance. </p>
<p>The real magic of story crafting is also seen in the <code class="inline-code">generateQuestContent()</code> function, which transforms quest design into actionable adventures. These interactions dynamically weave in user-specified file data, ensuring adventures are personalized. Every generated quest gets checked against validation schemas (courtesy of the Zod library) to confirm the output conforms to structured expectations. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code> sets the narrative tone by creating an aligned story and quest structure for the repository context.</li>
<li>The <code class="inline-code">generateQuestContent</code> method injects user file analysis into quest-specific narratives for deeper immersion.</li>
<li>The use of schema validation ensures that all generated content adheres to well-defined structural standards.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a>: Configuration Parsing and Formatting</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file is responsible for parsing the <code class="inline-code">adventure.config.json</code> file to guide story and quest generation. The <code class="inline-code">parseAdventureConfig()</code> method reads and validates the JSON configuration, ensuring that any user-defined customizations are accurately incorporated. It also offers tools like <code class="inline-code">extractUniqueFilePaths()</code> to traverse the configuration and collect all file paths that are relevant to quests. </p>
<p>One of its standout features is <code class="inline-code">formatAdventureConfigForPrompt()</code>, which prepares the adventure configuration for LLM integration by systematically organizing quests, files, and their highlights. This function ensures that quests adhere to a pre-defined structure, and all crucial information is passed as context during story generation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code> enables structured handling of user-defined configurations to embed them into the quest logic.</li>
<li><code class="inline-code">extractUniqueFilePaths</code> ensures only required, valid file paths are considered during quest creation.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code> lays the groundwork for structured narrative prompts through detailed formatting.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<pre><code class="language-typescript">export class AdventureState {
  title: string | undefined = undefined;
  story: string | undefined = undefined;
  quests: Quest[] = [];
  completedQuests: Set&lt;string&gt; = new Set();
  questContentCache: Map&lt;string, { content: QuestContent; summary: string }&gt; = new Map();
  currentTheme: AdventureTheme | null = null;
  projectInfo: ProjectInfo | undefined = undefined;
  projectPath: string | undefined = undefined;

  get progressPercentage(): number {
    return this.quests.length &gt; 0 
      ? Math.round((this.completedQuests.size / this.quests.length) * 100)
      : 0;
  }
}
</code></pre>
<p>Managing the <code class="inline-code">AdventureState</code> is like running a ship’s log—everything from progress metrics to completed quests is meticulously tracked for smooth navigation.</p>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string
): Promise&lt;QuestContent&gt; {
  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: &#39;&#39;,
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST });
  if (!response.content || response.content.trim() === &#39;&#39;) throw new Error(&#39;LLM returned empty response for quest content&#39;);

  return { adventure: response.content.trim(), fileExploration: &#39;&#39;, codeSnippets: [], hints: [] };
}
</code></pre>
<p>This function crafts quest content with precision, much like a chef preparing a custom recipe by blending code context and quest narratives.</p>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return &#39;&#39;;
    
  let formatted = `## Quest Structure Guidelines\n`;
  for (const quest of (parsed as any).adventure.quests || []) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n${quest.description}\n`;
    for (const file of quest.files) formatted += `- **File:** ${file.path}\n`;
  }
  return formatted;
}
</code></pre>
<p>This function is like a mapmaker laying out every detail in a guide so the LLM doesn’t get &quot;lost&quot; when creating stories.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">questContentCache</code> in <code class="inline-code">adventure-manager.ts</code> to minimize redundant queries and improve adventure execution efficiency.</li>
<li>Review <code class="inline-code">zod</code> schemas in <code class="inline-code">story-generator.ts</code> to validate LLM responses during development or debugging sessions.</li>
<li>Extend <code class="inline-code">adventure-config.ts</code> to handle more complex user-defined structures like nested or file-specific highlights.</li>
</ul>
<hr>
<p>Congratulations on successfully merging the epic branch of &quot;The Story Weaver&#39;s Loom&quot; into your skillset repository—you&#39;re 25% through the production environment of this adventure, so keep refactoring your brilliance and deploying 🚀!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3: The Vault of Analytical Vision →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>