<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Repository Chronicles: Exploring the Architecture of AI-Driven Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The MCP Command Interface</h1>
<hr>
<p>Welcome to the exploration of the MCP Command Interface, an essential module within the adventure generator system. This layer is the control hub for the dynamic tools that make exploring vast repositories both interactive and gamified. Dive into the system&#39;s architecture to understand how requests are handled and tools are executed to enrich the user experience.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Integration</strong>: How does the <code class="inline-code">setupHandlers</code> method register and execute dynamic tools within the server?</li>
<li>‚ö° <strong>Transport Connection</strong>: What role does the <code class="inline-code">run</code> method play in connecting the transport and initializing the system workflow?</li>
<li>üõ°Ô∏è <strong>Graceful Termination Strategies</strong>: How does the <code class="inline-code">main</code> function ensure robust error handling and clean shutdown processes during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Repository Adventure Server</h3>
<p>The <code class="inline-code">server.ts</code> file manages the core server logic for handling requests, registering tools, and processing interactions dynamically. It encapsulates operations such as error handling, tool execution, request validation, and graceful shutdown procedures. Critical methods include <code class="inline-code">setupHandlers</code>, which binds requests to predefined tools, and <code class="inline-code">run</code>, which initializes the transport mechanism and preprocesses content in the background.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools for the server, validating input schemas and binding handlers for seamless interaction.</li>
<li><code class="inline-code">run</code>: Connects the transport layer and warms up the repository cache to optimize performance during user interactions.</li>
<li><code class="inline-code">main</code>: Handles server startup with safety measures for interruptions and unhandled promise rejections, ensuring reliable operation.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically binds interaction handlers for listing and executing tools.</li>
<li>Validates input arguments using Zod schemas to ensure robust error handling.</li>
<li>Provides structured responses to clients to facilitate seamless interaction.</li>
<li>Demonstrates server-side validation and error propagation techniques.</li>
<li>Optimizes tool execution flow by integrating schema conversion and handler invocation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server transport, creating a communication channel for user commands.</li>
<li>Prepares cached repository content to optimize subsequent operations.</li>
<li>Logs progress and actions for debugging and informational purposes.</li>
<li>Establishes the base configuration of the system for interactive workflows.</li>
<li>Demonstrates background processing for performance enhancement.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Manages server initialization with robust error handling for startup failures.</li>
<li>Implements signal-based shutdown for SIGINT and SIGTERM to ensure proper cleanup.</li>
<li>Logs unhandled promise rejections to detect system anomalies without interrupting operations.</li>
<li>Ensures safe server termination using structured error management practices.</li>
<li>Demonstrates techniques for handling failures during asynchronous operations.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tools and Handlers</h3>
<p>The <code class="inline-code">tools.ts</code> file defines the tools available to the server, exporting interactive handlers for repository exploration. The tools include functionalities such as starting an adventure, choosing a theme, exploring quests, and viewing progress. Each tool integrates tightly with the adventure manager to provide robust and interactive experiences.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initializes the adventure by analyzing repository content and suggesting themes.</li>
<li><code class="inline-code">choose_theme.handler</code>: Dynamically selects a thematic framework to contextualize the adventure experience.</li>
<li><code class="inline-code">explore_quest.handler</code>: Provides exploration functionalities for individual quests based on user inputs.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks and reports quest completion statuses and remaining tasks.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how <code class="inline-code">setupHandlers</code> leverages <code class="inline-code">zodToJsonSchema</code> for schema validation‚Äîit‚Äôs a powerful technique for JSON schema integration.</li>
<li>Observe the role of the <code class="inline-code">run</code> method in pre-generating content‚Äîit‚Äôs an optimization that reduces user wait times.</li>
<li>Explore how error handling in <code class="inline-code">main</code> ensures robustness‚Äîit‚Äôs a best practice for Node.js applications.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer! You&#39;ve successfully refactored your knowledge stack to implement the MCP Command Interface‚Äîmilestone logged at 20% completion; keep iterating toward the final deployment! üöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>