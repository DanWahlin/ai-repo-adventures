<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Lens of Discovery - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of Codecraft: Forge of Adventure</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Lens of Discovery</h1>
<hr>
<p>Delve into &quot;The Repository,&quot; the crystal-clear lens through which adventurers can unveil the unseen intricacies of codebases. In this quest, you harness the powers of code analysis and structured storytelling. Embark on the journey of creating targeted quests, identifying critical paths, and optimizing workflows. The Lens of Discovery offers tools to craft adventures from raw technical inputs, revealing untapped insights deep within the digital realm.</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Integration of Repomix for Content Extraction</h3>
<p>In this file, the <code class="inline-code">RepoAnalyzer</code> class bridges raw codebases with structured analytical output. By leveraging Repomix, developers can transform complex directories into consumable content for interactive quests. Core functions validate paths and ensure security, preventing intrusion risks. The <code class="inline-code">generateRepomixContext</code> method provides full project overviews while caching mechanisms optimize performance. Additionally, <code class="inline-code">generateTargetedContent</code> empowers focus on specific files, and <code class="inline-code">captureRepomixStdout</code> ensures reliable CLI execution under memory and timeout constraints.</p>
<h4>Highlights</h4>
<ul>
<li><strong>generateRepomixContext</strong>: Comprehensive project analysis with validation and caching.</li>
<li><strong>generateTargetedContent</strong>: Allows specific file targeting for tailored analysis.</li>
<li><strong>captureRepomixStdout</strong>: Ensures subprocess execution adheres to limits with timeout handling.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  // Check if adventure.config.json has specific files to include
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateTargetedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Fallback to full content generation: ${error}`);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = { style: options?.style || &#39;markdown&#39;, compress: options.compress !== false };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<p>This function acts like a magnifying glass scanning a library, validating paths for safety, caching frequent queries for efficiency, and extracting targeted context.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = { style: &#39;markdown&#39;, stdout: true, compress };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Targeted repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<p>This operation is akin to using a spotlight in a darkened room to focus solely on predefined landmarks while ignoring unrelated areas.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    let stdout = &#39;&#39;, stderr = &#39;&#39;, stdoutSize = 0, isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Subprocess timeout for ${cwd}`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        if (!isResolved) {
          isResolved = true;
          clearTimeout(timeout);
          repomix.kill(&#39;SIGKILL&#39;);
          reject(new Error(`Output exceeds buffer size (${stdoutSize} bytes).`));
        }
        return;
      }
      stdout += chunk;
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        code === 0 &amp;&amp; stdout.trim().length &gt; 0 ? resolve(stdout) : reject(new Error(`Subprocess failed. Exit code: ${code}`));
      }
    });

    repomix.on(&#39;error&#39;, (error) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        reject(new Error(`Subprocess spawn failed: ${error.message}`));
      }
    });
  });
}
</code></pre>
<p>Imagine setting a timer while boiling water: the timeout protects resources, ensuring no accidental overflow even under pressure.</p>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Use targeted content generation for faster insights when working with large repositories.</li>
<li><strong>Exploration Recommendation</strong>: Test configurations with adventure.config.json to refine content extraction.</li>
<li><strong>Next Steps</strong>: Expand usage to explore user-specified files interactively via quest integration.</li>
</ul>
<hr>
<p>You have revealed new facets of &quot;The Repository.&quot; However, the lens grants only as much wisdom as the wielder&#39;s intentions. Remember, every choice shapes the adventure ahead!</p>
<p>Congratulations! You‚Äôve successfully debugged the algorithm for Quest 3: The Lens of Discovery, unlocking 40% progress in your epic developer journey‚Äîkeep refactoring brilliance and iterating toward triumph! üöÄüëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Threads of Creation ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>