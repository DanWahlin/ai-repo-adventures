<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Seer‚Äôs Lens - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codekeeper's Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Seer&#39;s Lens</h1>
<hr>
<p>Troubling whispers echo through the enchanted repository as The Codekeeper uncovers a critical artifact: the Seer‚Äôs Lens. This magical tool sharpens the adventurer&#39;s vision, enabling them to peer into the heart of the code, separating signal from noise. With its guidance, brave developers can distill sprawling complexity into clarity, analyzing only what is essential to their quest. Two critical scrolls are presented, each bursting with layered secrets of optimization and response generation.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Lens of Focus</strong>: How does the analyzer optimize function-focused content from sprawling codebases, and what techniques are employed to safely process file paths?  </li>
<li>‚ö° <strong>Threads of Inquiry</strong>: How does the LLM client dynamically validate its configuration and construct requests for different AI providers?  </li>
<li>üõ°Ô∏è <strong>The Shield of Integrity</strong>: What mechanisms are in place for handling invalid configurations, error scenarios, and lengthy timeouts?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Code optimization and path validation</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as a critical tool for managing code complexity. It validates, normalizes, and filters target file paths to ensure only valid, secure, and necessary files are included. Furthermore, it optimizes extracted content for functions and patterns central to an adventure, conserving resources while maintaining focus on the core story.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Ensures the project path is correctly formatted and safe to use, preventing unexpected behavior.  </li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Deduplicates file paths, prevents path traversal attacks, and limits the number of files processed for security and efficiency.  </li>
<li><code class="inline-code">generateOptimizedContent</code>: Applies function-focused optimization, improving token usage by filtering and extracting only the most relevant code blocks.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Querying and interacting with large language models</h3>
<p>The <code class="inline-code">LLMClient</code> class enables seamless interactions with LLM APIs, dynamically adapting to specific configurations like OpenAI or Azure OpenAI. This class is critical to initiating requests, managing responses, and handling errors when engaging with external AI systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Constructs the proper request parameters to communicate with LLMs and handles response validation and error scenarios.  </li>
<li><code class="inline-code">constructor</code>: Initializes the client and determines the correct API provider and key to use based on the configuration.  </li>
<li><code class="inline-code">getApiKey</code>: Retrieves the appropriate API key, ensuring configurations for either standard OpenAI models or Azure-hosted GitHub models.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">/**
 * Validate project path to ensure it&#39;s a valid string
 */
private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  const trimmedPath = projectPath.trim();
  if (!trimmedPath || trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid data&#39;);
  }
}
</code></pre>
<ul>
<li>Validates the project path for expected types and format.  </li>
<li>Prevents invalid paths containing null bytes or other unsafe content.  </li>
<li>Protects filesystem operations by failing early on bad input.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Deduplicate paths and validate they are secure and exist
 */
private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50; // Limit for efficiency
  const projectRoot = path.resolve(projectPath);

  // Deduplication and security checks
  const safeFiles = [...new Set(targetFiles)].slice(0, MAX_TARGET_FILES).map(file =&gt; {
    const trimmed = file.trim();
    if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) return null;
    const fullPath = path.resolve(projectPath, file);
    if (!fullPath.startsWith(projectRoot + path.sep) || !fs.existsSync(fullPath)) return null;
    return path.relative(projectPath, fullPath);
  }).filter(Boolean);

  return safeFiles.sort(); // Consistent order
}
</code></pre>
<ul>
<li>Deduplicates and validates file paths for safety and consistency.  </li>
<li>Rejects entries outside the project directory or paths with traversal symbols.  </li>
<li>Limits the number of files processed, ensuring predictable performance.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Generate optimized content by focusing on critical functions
 */
async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (!safeFiles.length) throw new Error(&#39;No valid target files found&#39;);

  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}`;
  const cached = this.cache.get(cacheKey);

  const fullContent = cached ? cached.content : await this.generateTargetedContent(projectPath, safeFiles, compress);
  const optimizedContent = this.extractFunctionFocusedContent(fullContent);

  this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
  return optimizedContent;
}
</code></pre>
<ul>
<li>Integrates validation and content processing seamlessly.  </li>
<li>Caches optimized results for efficiency and reusability.  </li>
<li>Focuses on extracting only essential functions to reduce unnecessary data.</li>
</ul>
<hr>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">/**
 * Generate a response using the selected LLM API and model
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Constructs requests dynamically to fit diverse options and models.  </li>
<li>Handles JSON response cleaning, logging tokens, and error reports.  </li>
<li>Offers robust pre- and post-processing for clarity and reliability.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Client constructor - initialize dynamic configuration
 */
constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;Configuration for LLM is incomplete&#39;);
  }

  this.client = this.isAzureOpenAI()
    ? new AzureOpenAI({ endpoint: LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0], apiKey, apiVersion: LLM_API_VERSION })
    : new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
}
</code></pre>
<ul>
<li>Dynamically selects the API provider configuration based on the environment.  </li>
<li>Validates critical configuration values early to avoid runtime issues.  </li>
<li>Supports multi-provider architecture with Azure-specific setup as needed.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Retrieve the API key for the appropriate LLM provider
 */
private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN is required for Azure-hosted models&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY is required for general providers&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Differentiates between standard providers and Azure-hosted GitHub models.  </li>
<li>Retrieves appropriate keys based on configuration context.  </li>
<li>Ensures errors are caught early if keys are missing.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Master Code Optimization</strong>: Study how functions focus optimization in <code class="inline-code">repo-analyzer.ts</code> to design efficient content filters.  </li>
<li><strong>Dynamic LLM Queries</strong>: Review <code class="inline-code">llm-client.ts</code> to learn how to adapt APIs for multiple formats and providers.  </li>
<li><strong>Error Investigation</strong>: Pay special attention to logging and fallback methods to enhance debugging in unknown scenarios.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congrats, dev! You‚Äôve successfully debugged the Seer‚Äôs Lens module, refactored your skills, and deployed a 40% progress milestone‚Äîkeep optimizing towards the final build! üöÄüëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>