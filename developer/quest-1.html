<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository of Forgotten Codes: An Adventure Awaits</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Tool Interface</h1>
<hr>
<p>Far beneath the Repository of Forgotten Codes, streams of mystical data flicker and hum. You have found your first major challenge: uncovering the secrets of the MCP Tool Interface. This subsystem is the heart of developer interaction‚Äîa bridge between the user and the Repository&#39;s powerful tools. To restore its full capability, you must delve into its implementation, examine its dynamic configuration, and ensure the tools are safely executed. Brave adventurer, your journey into the interface of codecraft begins now. </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Compilation Insight</strong>: How does <code class="inline-code">setupHandlers</code> dynamically create and validate a list of tools for the MCP server? What technique ensures their correctness?</li>
<li>‚ö° <strong>Server Initialization Flow</strong>: What sequence of operations does the <code class="inline-code">run</code> function perform when starting the MCP server, and how does it prepare for incoming tool calls?</li>
<li>üõ°Ô∏è <strong>Safety Mechanisms in Command Execution</strong>: How does <code class="inline-code">main</code> ensure operational resilience, especially when faced with unexpected errors or shutdown signals?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The MCP Server Implementation</h3>
<p>This file defines the core structure of the <code class="inline-code">RepoAdventureServer</code>, which manages dynamic tool registration, execution, and a gamified server runtime. Additionally, it sets up critical safety mechanisms for graceful shutdowns and unhandled errors. The server connects to a Stdio-based transport for communication and pre-generates analysis content to ensure responsiveness.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists available tools, validates their schemas, and connects them to the server for execution, ensuring extensibility.</li>
<li><code class="inline-code">run</code> initializes the server transport, pre-generates cached repository content, and starts the main server loop.</li>
<li><code class="inline-code">main</code> coordinates server setup, monitors for shutdown signals, and handles unhandled promise rejections, ensuring stability during runtime.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li><code class="inline-code">setupHandlers</code> ensures tools are discoverable and safe to use by dynamically constructing a list of available tools with their respective schemas.</li>
<li>Zod schemas validate tool input, enforcing strict parameter correctness before execution.</li>
<li>The <code class="inline-code">CallToolRequestSchema</code> handler handles tool execution, raising custom <code class="inline-code">McpError</code> objects to gracefully report issues.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> method connects the server via Stdio transport, enabling communication with clients.</li>
<li>Pre-generating repository analysis data boosts efficiency and reduces runtime delays.</li>
<li>Detailed logs provide feedback during initialization, improving debuggability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li><code class="inline-code">main</code> initializes the <code class="inline-code">RepoAdventureServer</code> and robustly handles signals (<code class="inline-code">SIGINT</code>/<code class="inline-code">SIGTERM</code>) for smooth shutdowns.</li>
<li>Monitors and logs any unhandled promise rejections without halting server operations.</li>
<li>Critical errors during initialization trigger immediate termination with a detailed diagnostic log.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The MCP Tool Registry</h3>
<p>This file defines and registers the tools available in the MCP server. It provides a consolidated interface to import, manage, and expose tool-specific functionality.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> analyzes codebases and initializes the adventure setup, serving as the starting point for interaction.</li>
<li><code class="inline-code">choose_theme.handler</code> allows clients to select a narrative theme, influencing subsequent steps.</li>
<li><code class="inline-code">explore_quest.handler</code> processes individual quest steps, providing dynamic challenges and opportunities for learning.</li>
<li><code class="inline-code">view_progress.handler</code> monitors overall progress, displaying completed and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object aggregates all available tools, making them easily discoverable and manageable.</li>
<li>Each tool (e.g., <code class="inline-code">start_adventure</code>, <code class="inline-code">explore_quest</code>) is designed with modular handlers for maintainability and reuse.</li>
<li>This centralized registration approach simplifies tool expansion without requiring extensive refactoring.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tool Exploration</strong>: Use <code class="inline-code">setupHandlers</code> to trace how tools are dynamically included and validated.</li>
<li><strong>Error Analysis</strong>: Investigate <code class="inline-code">McpError</code> usage in <code class="inline-code">setupHandlers</code> for robust error reporting patterns.</li>
<li><strong>Server Insights</strong>: Follow the <code class="inline-code">run</code> and <code class="inline-code">main</code> methods to understand the server&#39;s initialization and shutdown design.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer! Quest 1: The MCP Tool Interface has been successfully compiled and deployed‚Äîyou&#39;re debugging your way to mastery with stellar precision! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>