<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Forge of the Protocol Keeper - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'developer' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Codex of Infinite Adventures</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Forge of the Protocol Keeper</h1>
<hr>
<p>The Repository Nexus stirred with life as the Codex of Infinite Adventures glowed brighter, announcing the arrival of a new challenge: &quot;The Forge of the Protocol Keeper.&quot; Beyond the gates of code-based mysticism lies a mighty protocol forge—a place that enables adventurers to find, wield, and shape tools to unlock the mysteries within their project. Here, developers must master the art of dynamic handlers and ensure their servers stand resilient against both errors and adventures alike. Pick up your virtual gear! It’s time to face what the forge has in store.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server protocol implementation</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> file acts as the foundation of the Repo Adventure MCP server, enabling interaction with the MCP tools through a robust stdio transport mechanism. At its heart is the <code class="inline-code">RepoAdventureServer</code> class, which encapsulates the entire server&#39;s lifecycle, from handler registration to transport initialization and graceful shutdown. Within the <code class="inline-code">setupHandlers()</code> method, the server dynamically registers handlers for managing tool requests with schemas powered by Zod for strict validation. This ensures that only well-formed inputs are passed to the tools.</p>
<p>The <code class="inline-code">run()</code> function adds another layer of brilliance to the class. It connects stdio transport seamlessly, while also pre-generating Repomix content in the background to warm up the system for incoming adventures. Finally, the <code class="inline-code">main()</code> function acts as the server entry point, handling key signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for graceful shutdown and ensuring unhandled promise rejections are logged for learning and debugging.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers()</code>: Registers MCP protocol handlers for dynamic tool listing and execution using schemas.</li>
<li><code class="inline-code">RepoAdventureServer.run()</code>: Initializes stdio transport and preloads Repomix content for efficiency.</li>
<li><code class="inline-code">main()</code>: Safeguards against unexpected crashes via signal handling and error logging.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool orchestration for adventure interaction</h3>
<p>This file is a bridge between the user and the adventure system, encapsulating the entire toolset that drives the immersive exploration. It includes imports from adventure utilities, configuration files, and the four pivotal tools: <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. Much of the magic here lies in the <code class="inline-code">tools</code> constant, which consolidates the adventure toolset to ensure each tool is seamlessly registered with the server.</p>
<p>The structure of this file emphasizes maintainability and modularity. By importing individual tools from their respective files, this file offers a clean entry point to interact with any granular aspect of the system. It is here that the adventure&#39;s interactive narrative comes alive, connecting the game&#39;s administrative backend with user-facing functionality.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Kicks off the narrative by analyzing repositories and presenting themes.</li>
<li><code class="inline-code">choose_theme.handler</code>: Customizes the gaming experience by generating storylines and quests.</li>
<li><code class="inline-code">explore_quest.handler</code>: Delivers individual quest experiences in an actionable and trackable format.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides real-time progress updates for the user&#39;s journey.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This code ensures that users interact with only validated tools by dynamically handling requests with structured schemas.</p>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>This consolidates the adventure tools in a maintainable and scalable format, ready for use by the MCP server.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Carefully validate inputs and schemas when implementing versatile tools to avoid breaking changes or unexpected user errors.</li>
<li>Consider extending the existing toolset with additional handler options, like saving and resuming adventures mid-session.</li>
<li>Explore <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a> to understand how the adventure flow orchestrates user progression and tracks state.</li>
</ul>
<hr>
<p>console.log(&quot;Mission Accomplished: &#39;The Forge of the Protocol Keeper&#39; compiled successfully—your codebase is now a ⭐ shining example of perseverance and modular architecture; onward to the next challenge!&quot;);</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: The Story Weaver's Loom →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>