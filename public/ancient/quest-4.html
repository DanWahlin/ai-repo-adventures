<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Pyramid‚Äôs Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Temple of Forgotten Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Pyramid‚Äôs Interface</h1>
<hr>
<p>Through a treacherous descent into the pyramid‚Äôs glowing core, you reach a chamber brimming with symbols that shift and flicker like ancient codes coming to life. This room, known as the Interface Sanctum, is said to bridge the ancient civilization‚Äôs digital mastery with their exploration of knowledge. As a daring seeker, your challenge is to decipher how the ancient system processes queries and interactions. The glyphs seem to point to two distinct components: one that analyzes and optimizes scripts and another that communicates directly with a mysterious &quot;thinking engine.&quot; Grasp these intricacies to proceed further into the pyramid‚Äôs depths.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Blueprint Validation</strong>: How do the glyph-based scripts ensure that requests are valid and safe within the sanctum?</li>
<li>‚ö° <strong>Command Pathways</strong>: How does the pyramid‚Äôs interface manage interactions between the analyzer and the &quot;thinking engine&quot;?</li>
<li>üõ°Ô∏è <strong>Guarding the Secrets</strong>: What measures ensure the sanctity of the pyramid‚Äôs processes when handling errors or timeouts?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: The Interface Glyph Decoder</h3>
<p>This sacred file governs the intricate rituals required to send queries to the ‚Äúthinking engine‚Äù and process its responses. It defines the mechanisms for constructing requests, validating responses, and handling any disruptions in the process. Observing its interplay will illuminate the mysterious connection between ancient thought and computational design.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Constructs queries for the engine and processes its results, while ensuring safety and integrity.</li>
<li><code class="inline-code">constructor</code>: Establishes the core connection to the ‚Äúthinking engine‚Äù and configures the interface based on environment parameters.</li>
<li><code class="inline-code">getApiKey</code>: Dynamically retrieves sacred keys needed to access the engine and ensures proper linkage.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: The Script Optimizer</h3>
<p>This file represents an intricate tool used to discern and refine the essence of encoded glyphs. It ensures that only the most relevant portions of scripts are extracted and analyzed. By traversing its implementation, you grasp the foundation of how ancient processors optimized their limited resources.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Produces a structured representation of all processes to support knowledge extraction during an adventure.</li>
<li><code class="inline-code">validateProjectPath</code>: Protects the sanctum by ensuring that improper or harmful paths are not permitted.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Orchestrates the subprocess which gathers insights from the glyph-based scripts.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        let content = this.validateResponse(completion);
        
        if (options?.responseFormat === &#39;json_object&#39;) {
            content = this.cleanJsonResponse(content);
        }
        
        this.logTokenUsage(completion);
        
        return { content };
    } catch (error) {
        this.logDetailedError(error, prompt);
        const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
        throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<ul>
<li>Implements the sacred formula for generating a query and ensuring its results retain integrity.</li>
<li>Breaks down tasks into manageable steps like parameter construction, execution, and validation.</li>
<li>Demonstrates key techniques for error logging and post-processing of responses.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
        throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
        const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
        this.client = new AzureOpenAI({
            endpoint: azureEndpoint,
            apiKey,
            apiVersion: LLM_API_VERSION,
            deployment: this.model
        });
    } else {
        this.client = new OpenAI({
            apiKey,
            baseURL: LLM_BASE_URL
        });
    }
}
</code></pre>
<ul>
<li>Creates a channel to the ‚Äúthinking engine‚Äù and configures it for specific needs such as Azure or OpenAI.</li>
<li>Dynamically organizes inputs and configurations for smooth functionality.</li>
<li>Validates critical environmental parameters to protect the ancient interface.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
        if (!GITHUB_TOKEN) {
            throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
        }
        return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) {
        throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Ensures proper linkage with external systems via carefully controlled environment variables.</li>
<li>Adds flexibility by supporting multiple sources for sacred access keys.</li>
<li>Protects against misconfiguration by halting when critical keys are missing.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    
    const configuredFiles = extractUniqueFilePaths(projectPath);
    if (configuredFiles.length &gt; 0) {
        try {
            return await this.generateOptimizedContent(projectPath, configuredFiles);
        } catch (error) {
            console.warn(`Failed to generate optimized content, falling back to targeted content: ${error instanceof Error ? error.message : String(error)}`);
            try {
                return await this.generateTargetedContent(projectPath, configuredFiles);
            } catch (fallbackError) {
                console.warn(`Failed to generate targeted content, falling back to full repomix content: ${fallbackError instanceof Error ? fallbackError.message : String(fallbackError)}`);
            }
        }
    }

    console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);

    const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }
    
    try {
        const ignorePatterns = [
            &#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;
        ];
        if (!options.includeTests) {
            ignorePatterns.push(&#39;**/*.test.ts&#39;, &#39;**/*.spec.ts&#39;, &#39;**/tests/**&#39;, &#39;**/test/**&#39;);
        }

        const cliOptions: CliOptions = {
            style: options.style || &#39;markdown&#39;,
            stdout: true,
            compress: options.compress !== false,
            ignore: ignorePatterns.join(&#39;,&#39;),
            removeComments: true,
            removeEmptyLines: true,
            noDirectoryStructure: true
        };

        const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
        
        this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
        
        return context;
    } catch (error) {
        throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
    }
}
</code></pre>
<ul>
<li>Represents the glyph analyzer, generating context from project scripts for structured interpretation.</li>
<li>Allows fallback mechanisms from optimized to full processing to ensure reliable operation.</li>
<li>Implements caching strategies to avoid redundant computations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (!trimmedPath) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    if (trimmedPath.includes(&#39;\0&#39;)) {
        throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<ul>
<li>Safeguards the system by validating project paths before analysis.</li>
<li>Prevents unsafe inputs such as null bytes and path traversal attempts.</li>
<li>Ensures that only meaningful paths are accepted into the sanctum.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
        const args = [
            ...directories,
            &#39;--stdout&#39;,
            &#39;--style&#39;, options.style || &#39;markdown&#39;
        ];

        if (options.compress) args.push(&#39;--compress&#39;);
        if (options.removeComments) args.push(&#39;--remove-comments&#39;);
        if (options.removeEmptyLines) args.push(&#39;--remove-empty-lines&#39;);
        if (options.noDirectoryStructure) args.push(&#39;--no-directory-structure&#39;);
        if (options.ignore) args.push(&#39;--ignore&#39;, options.ignore);
        if (options.include) args.push(&#39;--include&#39;, options.include);
        
        const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], {
            cwd,
            stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
        });

        let stdout = &#39;&#39;;
        let stderr = &#39;&#39;;
        let stdoutSize = 0;
        let isResolved = false;

        const timeout = setTimeout(() =&gt; {
            if (!isResolved) {
                console.warn(`Repomix subprocess timeout (${REPOMIX_SUBPROCESS_TIMEOUT}ms), killing process...`);
                repomix.kill(&#39;SIGTERM&#39;);
                setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
                isResolved = true;
                reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
            }
        }, REPOMIX_SUBPROCESS_TIMEOUT);

        repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
            const chunk = data.toString();
            stdoutSize += chunk.length;

            if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
                if (!isResolved) {
                    isResolved = true;
                    clearTimeout(timeout);
                    repomix.kill(&#39;SIGKILL&#39;);
                    reject(new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`));
                }
                return;
            }

            stdout += chunk;
        });

        repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
            stderr += data.toString();
        });

        repomix.on(&#39;close&#39;, (code) =&gt; {
            if (!isResolved) {
                isResolved = true;
                clearTimeout(timeout);

                if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
                    resolve(stdout);
                } else {
                    reject(new Error(`Repomix failed (exit ${code}): ${stderr.substring(0, 200)}`));
                }
            }
        });

        repomix.on(&#39;error&#39;, (error) =&gt; {
            if (!isResolved) {
                isResolved = true;
                clearTimeout(timeout);
                reject(new Error(`Repomix spawn failed: ${error.message}`));
            }
        });
    });
}
</code></pre>
<ul>
<li>Directs the sacred subprocess to analyze glyphs under specific constraints.</li>
<li>Implements graceful timeouts, ensuring that excessive delays do not harm system efficiency.</li>
<li>Captures and curates output for downstream processes, enabling smooth integration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace the flow of request construction in <code class="inline-code">LLMClient</code> to understand how interface parameters are customized.</li>
<li>Observe error handling mechanisms in both files for insights into maintaining system resilience.</li>
<li>Examine how caching in <code class="inline-code">RepoAnalyzer</code> enhances performance and prevents redundant processing.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Thou hast unlocked sacred wisdom within the Pyramid‚Äôs Interface, ascending yet closer to the zenith of thy noble quest‚Äîmay the ancient stars guide thee forth with valor and divine clarity! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>