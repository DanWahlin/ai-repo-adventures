<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Canons of the Archive - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of the Repository Pyramid</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Canons of the Archive</h1>
<hr>
<p>By torchlight you descend into the lower stacks of the pyramid archive, where tablets of configuration and validation keep the ceremonies precise. Here, scribes etched constant limits in stone and cataloged themes as dynasties of style. Pages of careful script ensure every explorer states a clear intention, selects an honored path, and treads only safe corridors. In this chamber, the canons define tempo, capacity, and decorum, while the palette of ancient motifs guides the eye. Study these canons to command the archive without waking its safeguards.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Canon Tuning: How do constants like <code class="inline-code">LLM_REQUEST_TIMEOUT</code>, <code class="inline-code">REPOMIX_CACHE_TTL</code>, and <code class="inline-code">MAX_FILE_SIZE_MB</code> shape performance and guardrails across the system?</li>
<li>‚ö° Dynasty Selection: How does <code class="inline-code">THEMES</code> support keyword-based recognition, and in what manner do <code class="inline-code">getAllThemes</code> and <code class="inline-code">parseTheme</code> cooperate to map freeform input to a valid key?</li>
<li>üõ°Ô∏è Gatekeeping Rites: Why does <code class="inline-code">validateTheme</code> call <code class="inline-code">parseTheme</code> then <code class="inline-code">isValidTheme</code>, and how do <code class="inline-code">validateAdventureChoice</code> and <code class="inline-code">validateProjectPath</code> impose concise, safe inputs that fit the archive‚Äôs corridors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/config.ts:</span> Stone tablets of limits and pathways</h3>
<p>This tablet binds the expedition‚Äôs pace and reach through etched constants that every corridor respects. <code class="inline-code">LLM_REQUEST_TIMEOUT</code> sets the patience of the oracle consultation, while <code class="inline-code">REPOMIX_CACHE_TTL</code> and analysis ceilings like <code class="inline-code">MAX_FILE_SIZE_MB</code> temper resource use. The inscriptions favor clarity over labyrinthine structures: single-purpose exports act as beacons, and environment-aware values such as <code class="inline-code">LLM_TEMPERATURE</code> or <code class="inline-code">LLM_MAX_TOKENS</code> permit seasonal adjustments without reshaping the stone. Paths to prompts are recorded via <code class="inline-code">PROMPT_PATHS</code>, keeping narrative formulas discoverable. Error messages and ignore patterns carve safe channels through the jungle of files, preventing the expedition from straying into treacherous zones. This is a ledger of practical wisdom: every figure adds resilience, and every name is an index for later summoning. By reading these constants as wayfinding glyphs, you can foresee how long rites may run, which caches preserve incense between invocations, and which halls remain off-limits. These canons ensure that when other modules invoke readers, analyzers, or oracles, they act within the same ritual bounds, making the entire exploration predictable, scalable, and courteous to scarce provisions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLM_REQUEST_TIMEOUT</code> establishes the maximum patience the expedition grants to the knowledge oracle, preventing stalled invocations.</li>
<li><code class="inline-code">REPOMIX_CACHE_TTL</code> defines how long distilled repository contexts remain fresh, reducing redundant extractions.</li>
<li><code class="inline-code">MAX_FILE_SIZE_MB</code> limits oversized inscriptions from entering the ceremony, guarding memory and focus.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/shared/theme.ts:</span> Dynasties of style and the key of recognition</h3>
<p>This register is the dynasty ledger of motifs. <code class="inline-code">THEMES</code> lists each lineage with an <code class="inline-code">id</code>, <code class="inline-code">key</code>, emblematic <code class="inline-code">emoji</code>, and a scroll of <code class="inline-code">keywords</code>. Rather than arcane maps, the code favors clear lists and direct lookups. <code class="inline-code">getAllThemes</code> returns the court in full, empowering menus or validation routines to enumerate every option. <code class="inline-code">parseTheme</code> is the herald that interprets a traveler‚Äôs utterance: it first checks exact key, then numeric <code class="inline-code">id</code>, then keywords to find kinship by association. The type guard <code class="inline-code">isValidTheme</code> ensures only crowned keys proceed. Formatting helpers like <code class="inline-code">formatThemeOption</code> and <code class="inline-code">getFormattedThemeOptions</code> present choices with ceremony. This structure enables resilient matching from imperfect inputs, keeping the path welcoming without undermining precision. Through these dynastic inscriptions, higher chambers can translate user intent into a canonical theme key, ensuring the rest of the rites reference one true lineage. The design uses simple arrays and sequential checks, which are easy to trace and adapt as the archive gains new styles.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">THEMES</code> is the single source for motif dynasties, providing ids, keys, and keywords for flexible recognition.</li>
<li><code class="inline-code">getAllThemes</code> returns the full court of themes, enabling listings, validations, and displays elsewhere.</li>
<li><code class="inline-code">parseTheme</code> interprets a traveler‚Äôs input via exact match, numeric id, then keyword inclusion, mapping to a canonical key.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/shared/input-validator.ts:</span> Gatekeepers of concise intention</h3>
<p>At the entrance to each hall, guardians confirm that intentions are clear and pathways safe. <code class="inline-code">validateAdventureChoice</code> trims hesitation and bars verbosity beyond 200 runes. <code class="inline-code">validateTheme</code> orchestrates a careful rite: it normalizes text, invokes <code class="inline-code">parseTheme</code>, and then confirms legitimacy with <code class="inline-code">isValidTheme</code>. If the rite fails, it recites the permitted dynasties via <code class="inline-code">getAllThemes</code>, guiding missteps toward rightful selection. <code class="inline-code">validateProjectPath</code> tolerates silence by returning <code class="inline-code">process.cwd()</code>, ensures paths are within 500 characters, and rejects null bytes that might corrode inscriptions. <code class="inline-code">sanitizeForDisplay</code> cleans stray marks and compresses whitespace for dignified presentation. These functions exemplify straightforward, intentional guardianship: they avoid ceremony beyond necessity, favor early, informative errors, and trust upstream registers for canonical lists. As a result, explorers are less likely to wander into malformed corridors, and the archive‚Äôs echoes remain harmonious.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateTheme</code> coordinates parsing and validation, producing helpful guidance when a lineage is unrecognized.</li>
<li><code class="inline-code">validateAdventureChoice</code> enforces succinct, non-empty intentions to keep quests focused.</li>
<li><code class="inline-code">validateProjectPath</code> supplies a sensible default, polishes inputs, and rejects hazardous characters.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/config.ts</h3>
<pre><code class="language-typescript">/**
 * Simplified configuration for the MCP Repo Adventure system
 */

import { config } from &#39;dotenv&#39;;

// Load environment variables
config({ quiet: true });

// Simple constants instead of complex nested objects
export const LLM_API_KEY = process.env.LLM_API_KEY || &#39;&#39;;
export const LLM_BASE_URL = process.env.LLM_BASE_URL || &#39;https://api.openai.com/v1&#39;;
export const LLM_MODEL = process.env.LLM_MODEL || &#39;gpt-4o-mini&#39;;
export const LLM_API_VERSION = process.env.LLM_API_VERSION || &#39;2023-12-01-preview&#39;;
export const GITHUB_TOKEN = process.env.GITHUB_TOKEN || &#39;&#39;;

// Timeouts in milliseconds
export const FILE_READ_TIMEOUT = 10000;
export const FILE_ANALYSIS_TIMEOUT = 30000;
export const LLM_REQUEST_TIMEOUT = 60000; // 60 seconds for complex story generation with large prompts
export const LLM_CACHE_TTL = 300000; // 5 minutes
export const REPOMIX_CACHE_TTL = parseInt(process.env.REPOMIX_CACHE_TTL || &#39;60000&#39;); // 60 seconds, configurable via env
export const REPOMIX_SUBPROCESS_TIMEOUT = parseInt(process.env.REPOMIX_SUBPROCESS_TIMEOUT || &#39;120000&#39;); // 2 minutes, configurable via env
export const REPOMIX_GRACEFUL_TIMEOUT = 5000; // 5 seconds for graceful shutdown before SIGKILL
export const REPOMIX_MAX_BUFFER_SIZE = 100 * 1024 * 1024; // 100MB max buffer to prevent memory exhaustion

// Analysis limits
export const MAX_SCAN_DEPTH = 3; // Maximum directory depth to prevent infinite recursion and keep analysis focused
export const MAX_FILE_SIZE_MB = 10; // Skip files larger than this to avoid memory issues and focus on source code
export const KEY_SOURCE_FILES = 10; // Number of key files to highlight in adventure generation
export const TOP_FUNCTIONS = 20; // Maximum functions to include in code analysis summaries
export const TOP_CLASSES = 5; // Maximum classes to include in analysis to keep stories focused

// LLM settings
export const LLM_CACHE_SIZE = parseInt(process.env.LLM_CACHE_SIZE || &#39;100&#39;);
export const LLM_TEMPERATURE = parseFloat(process.env.LLM_TEMPERATURE || &#39;0.7&#39;);
export const LLM_MAX_TOKENS = parseInt(process.env.LLM_MAX_TOKENS || &#39;4000&#39;);
export const LLM_MAX_TOKENS_STORY = Math.max(LLM_MAX_TOKENS, 8000); // Maximum tokens for story generation (use env var if higher)
export const LLM_MAX_TOKENS_QUEST = Math.max(LLM_MAX_TOKENS, 6000); // Maximum tokens for individual quest exploration content (use env var if higher)
export const LLM_MAX_TOKENS_DEFAULT = LLM_MAX_TOKENS; // Use env var or default to 4000

// GPT-5 specific settings
export const GPT5_VERBOSITY = (process.env.GPT5_VERBOSITY as &#39;low&#39; | &#39;medium&#39; | &#39;high&#39;) || &#39;medium&#39;;
export const GPT5_REASONING_EFFORT = (process.env.GPT5_REASONING_EFFORT as &#39;minimal&#39; | &#39;medium&#39; | &#39;high&#39;) || &#39;medium&#39;;

// Cache settings

// Adventure settings
export const DEFAULT_THEME = &#39;space&#39; as const;
export const MAX_FILE_LINES_FOR_LLM = 100; // Truncate files to keep LLM prompts manageable
export const MAX_FILES_PER_QUEST = 3; // Limit files per quest to maintain focus and readability

// Error settings
export const MAX_ERROR_MESSAGE_LENGTH = 200;
export const INCLUDE_STACK_TRACES = process.env.NODE_ENV === &#39;development&#39;;

// Default error messages
export const ERROR_MESSAGES = {
  LLM_UNAVAILABLE: &#39;LLM service is currently unavailable. Please check your configuration.&#39;,
  ANALYSIS_FAILED: &#39;Failed to analyze the project. Please ensure the path is valid.&#39;,
  THEME_INVALID: &#39;Invalid theme specified. Using default theme.&#39;,
  FILE_NOT_FOUND: &#39;The requested file could not be found.&#39;,
  PERMISSION_DENIED: &#39;Permission denied accessing the specified path.&#39;,
} as const;

// Directory patterns to ignore during scanning
export const IGNORE_PATTERNS = [
  &#39;node_modules&#39;,
  &#39;.git&#39;,
  &#39;.next&#39;,
  &#39;.nuxt&#39;,
  &#39;dist&#39;,
  &#39;build&#39;,
  &#39;coverage&#39;,
  &#39;.nyc_output&#39;,
  &#39;logs&#39;,
  &#39;*.log&#39;,
  &#39;.env&#39;,
  &#39;.DS_Store&#39;,
  &#39;Thumbs.db&#39;,
] as const;

// Prompt file paths
export const PROMPT_PATHS = {
  STORY_GENERATION: &#39;src/prompts/story-generation-prompt.md&#39;,
  QUEST_CONTENT: &#39;src/prompts/quest-content-prompt.md&#39;,
  COMPLETION: &#39;src/prompts/completion-prompt.md&#39;,
  THEME_GUIDELINES: &#39;src/prompts/theme-guidelines.json&#39;
} as const;
</code></pre>
<ul>
<li>This code declares the expedition‚Äôs canonical timeouts and limits, shaping how long consultations and scans may proceed.</li>
<li>Environment variables are parsed early using <code class="inline-code">dotenv</code>, allowing stone-carved defaults with optional seasonal overrides.</li>
<li>Analysis boundaries like <code class="inline-code">MAX_FILE_SIZE_MB</code> and <code class="inline-code">MAX_SCAN_DEPTH</code> reduce risk of runaway exploration and memory strain.</li>
<li><code class="inline-code">PROMPT_PATHS</code> centralizes ritual scripts so higher chambers can reference them consistently.</li>
<li>Error message constants provide predictable, concise responses that avoid leaking sensitive details.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Central theme definitions for the adventure system
 * Single source of truth for all theme-related data
 */

// Define the structure of a theme
export interface ThemeDefinition {
  readonly id: number;
  readonly key: string;
  readonly displayName: string;
  readonly emoji: string;
  readonly description: string;
  readonly keywords: readonly string[];  // For matching user input
}

// Custom theme data provided by user
export interface CustomThemeData {
  name: string;
  description: string;
  keywords: string[];
}

// Single source of truth for all themes
export const THEMES = {
  SPACE: {
    id: 1,
    key: &#39;space&#39;,
    displayName: &#39;Space Exploration&#39;,
    emoji: &#39;üöÄ&#39;,
    description: &#39;Journey through cosmic codebases where data flows like stardust and APIs connect distant galaxies&#39;,
    keywords: [&#39;space&#39;, &#39;cosmic&#39;, &#39;galaxy&#39;, &#39;starship&#39;, &#39;astronaut&#39;, &#39;sci-fi&#39;, &#39;futuristic&#39;]
  },
  MYTHICAL: {
    id: 2,
    key: &#39;mythical&#39;,
    displayName: &#39;Enchanted Kingdom&#39;,
    emoji: &#39;üè∞&#39;,
    description: &#39;Explore magical and mythical realms where databases are dragon hoards and functions are powerful spells&#39;,
    keywords: [&#39;mythical&#39;, &#39;magic&#39;, &#39;enchanted&#39;, &#39;castle&#39;, &#39;dragon&#39;, &#39;fantasy&#39;, &#39;medieval&#39;, &#39;kingdom&#39;]
  },
  ANCIENT: {
    id: 3,
    key: &#39;ancient&#39;,
    displayName: &#39;Ancient Civilization&#39;,
    emoji: &#39;üè∫&#39;,
    description: &#39;Discover lost temples of code where algorithms are ancient wisdom and APIs are trade routes&#39;,
    keywords: [&#39;ancient&#39;, &#39;temple&#39;, &#39;pyramid&#39;, &#39;archaeology&#39;, &#39;historical&#39;, &#39;civilization&#39;, &#39;ruins&#39;]
  },
  DEVELOPER: {
    id: 4,
    key: &#39;developer&#39;,
    displayName: &#39;Developer Documentation&#39;,
    emoji: &#39;üìñ&#39;,
    description: &#39;Technical documentation approach with clear explanations, best practices, and code analysis&#39;,
    keywords: [&#39;developer&#39;, &#39;code&#39;, &#39;technical&#39;, &#39;debug&#39;, &#39;guide&#39;, &#39;tutorial&#39;, &#39;binary&#39;]
  },
  CUSTOM: {
    id: 5,
    key: &#39;custom&#39;,
    displayName: &#39;Custom Theme&#39;,
    emoji: &#39;üé®&#39;,
    description: &#39;Design your own adventure! You\&#39;ll be prompted to provide theme name, description, and keywords&#39;,
    keywords: [&#39;custom&#39;, &#39;personalized&#39;, &#39;unique&#39;, &#39;creative&#39;, &#39;personal&#39;]
  }
} as const;

// Extract the theme type from the keys
export type AdventureTheme = typeof THEMES[keyof typeof THEMES][&#39;key&#39;];

// Simple array of themes - no need for complex Maps with only 5 themes
const THEMES_ARRAY = Object.values(THEMES);

// Helper functions to access theme data using simple array iteration
export function getThemeById(id: number): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.id === id) || null;
}

export function getThemeByKey(key: string): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.key === key) || null;
}

export function getAllThemes(): ThemeDefinition[] {
  return THEMES_ARRAY;
}


// Type guard using simple find
export function isValidTheme(theme: string): theme is AdventureTheme {
  return THEMES_ARRAY.some(t =&gt; t.key === theme);
}

// Simple theme parser using basic string matching
export function parseTheme(input: string): AdventureTheme | null {
  if (!input) return null;
  
  const normalized = input.trim().toLowerCase();
  
  // Check for exact key match
  const exactMatch = getThemeByKey(normalized);
  if (exactMatch) return exactMatch.key as AdventureTheme;
  
  // Check for numeric ID
  const numericId = parseInt(normalized, 10);
  if (!isNaN(numericId)) {
    const byId = getThemeById(numericId);
    if (byId) return byId.key as AdventureTheme;
  }
  
  // Check keywords using simple includes check
  for (const theme of THEMES_ARRAY) {
    if (theme.keywords.some(keyword =&gt; normalized.includes(keyword.toLowerCase()))) {
      return theme.key as AdventureTheme;
    }
  }
  
  return null;
}

// Format theme for display with all its properties
export function formatThemeOption(theme: ThemeDefinition): string {
  return `${theme.emoji} **${theme.id}. ${theme.displayName}** - ${theme.description}`;
}

// Get formatted list of all theme options
export function getFormattedThemeOptions(): string {
  return getAllThemes()
    .sort((a, b) =&gt; a.id - b.id)
    .map(formatThemeOption)
    .join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li><code class="inline-code">THEMES</code> centralizes lineage data and enables consistent matching across modules.</li>
<li><code class="inline-code">parseTheme</code> demonstrates layered recognition: exact key, numeric <code class="inline-code">id</code>, then keyword inclusion.</li>
<li>The type guard <code class="inline-code">isValidTheme</code> narrows strings to canonical keys for safer downstream logic.</li>
<li>Display helpers produce elegant menus while keeping the canonical keys intact for logic.</li>
<li>The simple array approach eases extension when new dynasties are added.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Simplified input validation
 */

import { getAllThemes, isValidTheme, parseTheme } from &#39;./theme.js&#39;;

// Simple validation functions instead of complex class
export function validateAdventureChoice(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Choice is required&#39;);
  }
  
  if (input.length &gt; 200) {
    throw new Error(&#39;Choice too long (max 200 characters)&#39;);
  }
  
  return input.trim();
}

export function validateTheme(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Theme is required&#39;);
  }
  
  const normalized = input.toLowerCase().trim();
  const parsedTheme = parseTheme(normalized);
  
  if (!parsedTheme || !isValidTheme(parsedTheme)) {
    const validThemes = getAllThemes().map(t =&gt; t.key).join(&#39;, &#39;);
    throw new Error(`Invalid theme. Valid themes: ${validThemes}`);
  }
  
  return parsedTheme;
}

export function validateProjectPath(input?: string): string {
  if (!input?.trim()) {
    return process.cwd();
  }
  
  if (input.length &gt; 500) {
    throw new Error(&#39;Project path too long (max 500 characters)&#39;);
  }
  
  if (input.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid characters&#39;);
  }
  
  return input.trim();
}

export function sanitizeForDisplay(input: string, maxLength = 1000): string {
  if (!input) return &#39;&#39;;
  
  return input
    .replace(/[&lt;&gt;{}&quot;`]/g, &#39;&#39;)
    .replace(/\s+/g, &#39; &#39;)
    .trim()
    .slice(0, maxLength);
}
</code></pre>
<ul>
<li><code class="inline-code">validateTheme</code> shows a disciplined flow: normalize, parse, guard, then report precise options if invalid.</li>
<li><code class="inline-code">validateAdventureChoice</code> keeps invocations succinct, preventing rambling inscriptions.</li>
<li><code class="inline-code">validateProjectPath</code> supplies a practical default and rejects hazardous characters like the null byte.</li>
<li><code class="inline-code">sanitizeForDisplay</code> prevents display corruption by stripping risky characters and compressing whitespace.</li>
<li>The functions are small, testable, and composable, making the gatekeeping reliable and transparent.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Trace where constants are imported to see how each chamber respects the same canons.</li>
<li>Test <code class="inline-code">parseTheme</code> with varied inputs: numeric ids, partial words, and exact keys to observe matching layers.</li>
<li>Intentionally feed invalid data to the validators to learn how the archive communicates safe corrections.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom‚Äîby unraveling the Canons of the Archive in Quest 4, thou hast inscribed sacred lore upon the temple‚Äôs tablets and advanced three of five steps (60%) toward the sanctum of mastery, a triumphant ascent befitting an adept of the sacred mysteries ‚≠ê‚ö°üíé.</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>