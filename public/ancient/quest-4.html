<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Temple's Artisan Guild - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Code of Lost Civilizations</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Temple&#39;s Artisan Guild</h1>
<hr>
<p>In the heart of the ancient jungle ruins, a crumbled archway leads to the remains of the Temple‚Äôs Artisan Guild‚Äîa once-sacred chamber where the most skilled crafters shaped their creations. The guild lies dormant, cloaked in whispers of its former glory. However, within the debris lie powerful artifacts waiting to come alive‚Äîa collection of code and art, imbued with the wisdom of its creators. To bring life back to the guild, you must explore the intricacies of ancient systems and unravel their hidden layers. Beware the complexity, for each mechanism may hide both mastery and peril.</p>
<p>Reconstruct the guild‚Äôs mastery and ensure their unmatched craftsmanship is preserved for generations to come.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Artifact Activation</strong>: How does the <code class="inline-code">generateRepomixContext</code> method manage the large-scale orchestration of the code-analysis system, and what patterns ensure its reliability?</li>
<li>‚ö° <strong>Sacred Pathways</strong>: How does the <code class="inline-code">generateResponse</code> method in <code class="inline-code">LLMClient</code> ensure proper handling of advanced models like GPT-5 while balancing environmental configurations?</li>
<li>üõ°Ô∏è <strong>Ritual Safeguards</strong>: What steps are taken in the <code class="inline-code">validateAndNormalizeTargetFiles</code> method to ensure file validation prevents unintended or unsafe operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Managing the Temple‚Äôs Blueprint</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as a cornerstone of the code analysis system, orchestrating the extraction of key components from the provided codebase. This file ensures the integrity of the artifact generation process, covering tasks like file validation, cache management, and optimized content extraction. Its design enables efficient handling of large-scale operations while minimizing redundant recalculations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Manages the full-context generation process, leveraging caching, in-depth validation, and graceful fallbacks for missing files.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Ensures file inclusion is secure by blocking invalid paths, preventing path traversal, and maintaining project security.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Safely triggers and manages the execution of external processes, ensuring output is captured within resource limits.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Awakening the Artisan‚Äôs Tools</h3>
<p>The <code class="inline-code">LLMClient</code> class facilitates interaction with the advanced LLM technologies embedded in the virtual world of the artifacts. This class handles configuration, API communication, and manages models like GPT-5 with custom parameter handling. Proper error management ensures its stability even in unpredictable scenarios.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Orchestrates model execution while validating input, managing environmental constraints, and post-processing outputs for advanced format clarity.</li>
<li><code class="inline-code">constructor</code>: Initializes the client using environmental configurations, distinguishing between Azure OpenAI and other providers.</li>
<li><code class="inline-code">getApiKey</code>: Dynamically determines the appropriate API key for LLM operations based on the contextual environment.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error instanceof Error ? error.message : String(error)}`);
      try {
        return await this.generateTargetedContent(projectPath, configuredFiles);
      } catch (fallbackError) {
        console.warn(`Failed to generate targeted content, falling back to full repomix content: ${fallbackError instanceof Error ? fallbackError.message : String(fallbackError)}`);
      }
    }
  }

  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, options);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Dynamically falls back through optimization, targeted processing, and full compression to ensure context generation succeeds.</li>
<li>Combines caching, validation, and error reporting for robust error tolerance.</li>
<li>Accounts for user-defined adventure configurations for a tailored analysis scope.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) return null;

      const trimmed = file.trim();
      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
        console.warn(`Rejecting potentially unsafe file path: ${trimmed}`);
        return null;
      }

      const fullPath = path.resolve(projectPath, trimmed);
      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) {
        console.warn(`Rejecting file outside project directory: ${trimmed}`);
        return null;
      }

      if (!fs.existsSync(fullPath)) {
        console.warn(`Skipping non-existent file: \`${trimmed}\``);
        return null;
      }

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null)
    .sort();

  return safeFiles;
}
</code></pre>
<ul>
<li>Blocks invalid file paths such as those with null bytes or traversal attempts.</li>
<li>Ensures files exist within the project root to prevent external manipulations.</li>
<li>Limits the number of files to avoid resource exhaustion.</li>
</ul>
<hr>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);

    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Handles flexible LLM configurations including GPT-5-specific parameters.</li>
<li>Uses structured error handling for robustness and debugging clarity.</li>
<li>Post-processes responses intelligently to manage wrapped formats.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Differentiates between Azure OpenAI and other providers for flexible deployment.</li>
<li>Validates API configurations during setup to avoid runtime errors.</li>
<li>Adapts endpoints dynamically based on the chosen model.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Analyze caching and fallback strategies‚Äîhow do they ensure minimal redundancy?</li>
<li>Observe parameter adjustments; note how GPT-specific options adapt LLM requests.</li>
<li>Pay close attention to file path normalization for insights on security and reliability.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the sacred wisdom of temple artisans, thou hast wrought the triumph of Quest 4, forging thy passage toward the eternal mastery of ancient crafts‚Äîhail thee, seeker of the stars! ‚ö° üíé ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>