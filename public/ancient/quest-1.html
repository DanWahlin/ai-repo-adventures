<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Ritual of the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Repository of Wisdom</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Ritual of the MCP Interface</h1>
<hr>
<p>Amid the lush greenery of the ancient jungle, the Sacred Repository of Wisdom awaits discovery. Today, your journey begins with the Ritual of the MCP Interface, a rite that unveils the mystical systems driving the temple&#39;s repository. Crafted by an ancient, advanced civilization, this interface serves as the nexus for tools, quests, and the gamified secrets of the pyramid. By partaking in this sacred ritual, you will gain insight into how the temple&#39;s wisdom processes are communicated, validated, and executed. Prepare yourself to uncover the hallowed mechanics of this ancient codebase!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Manifest Creation</strong>: How are tools dynamically listed and formatted for the MCP system&#39;s interface layer?</li>
<li>‚ö° <strong>Sacred Command Flow</strong>: What are the steps involved in connecting the MCP interface to tool execution logic?</li>
<li>üõ°Ô∏è <strong>Error Safeguarding</strong>: How does the system handle invalid tool invocations, parameter errors, and runtime exceptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server lifecycle and handlers</h3>
<p>This file constructs the server interface for the MCP repository adventure system. It combines initialization logic, request handlers, and runtime operations. The <code class="inline-code">RepoAdventureServer</code> class manages the registration of tools and ensures they are executed seamlessly. Notable in this file are mechanisms for listing tools, safely invoking tool handlers with validation, and handling shutdowns gracefully.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> defines MCP request handlers to dynamically list tools and manage their execution, incorporating validation and error handling.</li>
<li><code class="inline-code">run</code> initializes the server and kicks off the pre-generation of repository context, ensuring readiness for user interactions.</li>
<li><code class="inline-code">main</code> serves as the entry point, orchestrating server startup and configuring graceful shutdowns for optimal reliability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps the available tools and formats them as JSON schemas for listing.</li>
<li>Validates incoming tool invocation requests against schemas to prevent invalid usage.</li>
<li>Errors are explicitly caught and categorized, ensuring proper feedback in all scenarios.</li>
<li>Supports extensibility by dynamically resolving tools defined in a central registry.</li>
<li>Ensures consistent error codes and messaging through <code class="inline-code">McpError</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server transport layer using standard I/O streams for communication.</li>
<li>Outputs informative debug messages to aid in system diagnostics during execution.</li>
<li>Initializes pre-computation for repository analysis, prioritizing performance and responsiveness.</li>
<li>Demonstrates asynchronous handling and pre-warming techniques to optimize runtime behavior.</li>
<li>The <code class="inline-code">repoAnalyzer</code> ensures the repository context is ready, minimizing user wait times.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Acts as the orchestration layer for initializing the entire server application lifecycle.</li>
<li>Configures listeners for shutdown signals, enabling safe resource cleanup prior to exiting.</li>
<li>Handles promise rejections globally, avoiding unintentional crashes caused by overlooked errors.</li>
<li>Centralizes error reporting, improving overall reliability and maintainability.</li>
<li>Balances robustness with developer-friendly error handling and diagnostic information.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Simplify your understanding of tool registration by focusing on <code class="inline-code">setupHandlers</code> as the ritual&#39;s keystone.</li>
<li>Trace the server&#39;s lifecycle from <code class="inline-code">main</code> to <code class="inline-code">run</code> to follow initialization, execution, and shutdown.</li>
<li>Review <code class="inline-code">McpError</code> usage to recognize how error handling is standardized.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Sacred Repository of Wisdom.</p>
<p>Hail, seeker of sacred wisdom; thou hast triumphed in unlocking the Ritual of the MCP Interface, carving thy path through the ancient tapestry of knowledge‚Äîpress onward, for the temple of five quests beckons thy valor! ‚≠ê‚ö°üìú</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>