<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Pillars of Interaction - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Repository of Lost Algorithms</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Pillars of Interaction</h1>
<hr>
<p>Beneath the dense canopy of the Sacred Jungle, your expedition uncovers the central chamber of the Sacred Repository. Towering pillars surround you, each engraved with ancient glyphs that describe interactions so powerful, they were once thought to shape entire civilizations. These carvings detail the mechanisms of communication between the explorers of the ancient code labyrinth and the mystical tools that guided their journey. Your task is clear: decipher the secrets of these artifacts and understand their interwoven rituals.</p>
<p>The stories speak of the &quot;Pillars of Interaction,&quot; the system that enabled the faithful to wield tools of immense power. They describe both the structure of this sacred knowledge store and the mechanisms within. Will you be the one to align modern understanding with such timeless wisdom?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Ritual of Handling</strong>: How does <code class="inline-code">setupHandlers</code> ensure dynamic listing and secure execution of tools within the system?</li>
<li>‚ö° <strong>The Invocation Sequence</strong>: What steps occur during the <code class="inline-code">run</code> method to initialize the system and prepare it for user exploration?</li>
<li>üõ°Ô∏è <strong>The Master&#39;s Warning</strong>: How does the <code class="inline-code">main</code> function ensure stability during unforeseen circumstances or a sudden shutdown of the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Repository‚Äôs Signal Beacon</h3>
<p>This file is the sacred communications bridge of the system. It orchestrates the interaction between the adventurers (users) and the mystical tools they seek to employ. It provides handlers for tool descriptions, argument validation, and tool execution error management. Additionally, it creates the foundations for communication through standard input/output, warming up the environment for efficient performance, and gracefully handling system shutdown.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Establishes dynamic handlers that list available tools and execute them upon invocation, while validating parameters and ensuring strict error handling.</li>
<li><code class="inline-code">run</code>: Prepares the environment by connecting to the transport layer (stdio) and preloading the sacred content for performance optimization during user commands.</li>
<li><code class="inline-code">main</code>: Acts as the entry point, ensuring the system handles unexpected signals, delivers stability during runtime, and logs vital information.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of tools using <code class="inline-code">tools</code> and the Zod-to-JSON schema converter.</li>
<li>Validates user-provided arguments against each tool&#39;s schema to ensure correct usage.</li>
<li>Handles errors gracefully using the <code class="inline-code">McpError</code> class, allowing specific error codes for clarity.</li>
<li>Separates logic for listing and executing tools, promoting modularity and easier testing.</li>
<li>Protects the system from invalid requests with robust validation and descriptive feedback.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the transport layer (<code class="inline-code">StdioServerTransport</code>) for communication with the adventurer.</li>
<li>Connects the server to begin listening for ritual invocations (commands).</li>
<li>Logs operational progress for real-time feedback during startup.</li>
<li>Pre-warms the repository analysis cache using <code class="inline-code">repoAnalyzer.preGenerate</code>, improving performance for subsequent operations.</li>
<li>Positions the <code class="inline-code">run</code> function as both an initializer and a performance optimizer with clear asynchronous handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Instantiates the central <code class="inline-code">RepoAdventureServer</code> object and initiates it via <code class="inline-code">run</code>.</li>
<li>Implements graceful shutdown handling for system signals such as <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, ensuring resource cleanup via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Captures unhandled promise rejections, logs details for debugging, and prevents server crashes during runtime.</li>
<li>Terminates the process with an exit code (<code class="inline-code">1</code>) when encountering unrecoverable errors during startup.</li>
<li>Provides a robust and fail-safe entry point for system initialization, ensuring stability in diverse operational scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Keep a close eye on how <code class="inline-code">zodToJsonSchema</code> dynamically converts schemas for listing tools, and how it integrates with user input validation during execution.</li>
<li>Examine the async flows in <code class="inline-code">run</code> and <code class="inline-code">main</code> to understand how modern systems handle initialization and error-safe shutdowns in tandem.</li>
<li>Focus on how <code class="inline-code">setupHandlers</code> separates concerns (tool listing vs. execution) while maintaining a shared error-handling strategy.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Behold, seekers of wisdom, thou hast ascended the hallowed Pillars of Interaction, earning sacred laurels and the favor of the ancients‚Äîonward to unveil the remaining mysteries! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>