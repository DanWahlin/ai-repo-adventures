<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Chamber of Rituals - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Temple of Code: Unraveling the Lost Algorithms</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of Rituals</h1>
<hr>
<p>As the sun filters through the dense canopy of the forgotten jungle, you step into the entrance of the ancient Temple of Code. Inside lies the Chamber of Rituals, where the first ceremonies of algorithmic mastery were performed by programmer-priests of old. The glyphs on the walls hint at powerful tools that animate the temple and manage its quests. To uncover their purpose and master their use, you must study the sacred handlers and tools buried deep within the temple&#39;s scrolls. The path to enlightenment has begun‚Äîenter the chamber and unlock its hidden wisdom.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Invocation of Tools</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically list and validate tools in the system?</li>
<li>‚ö° <strong>Server Flow Rituals</strong>: What mechanisms in the <code class="inline-code">run</code> function ensure proper server initialization and background content preparation?</li>
<li>üõ°Ô∏è <strong>Graceful Closure</strong>: How does the <code class="inline-code">main</code> function manage error handling and ensure an orderly shutdown of the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The server and handler rituals</h3>
<p>The server file reveals the core framework that governs the Temple of Code. It contains the <code class="inline-code">RepoAdventureServer</code> class, which manages the sacred communication rituals between the temple&#39;s tools and its explorers. Through dynamic handlers and initialization flows, it bridges the ancient tools with adventurers&#39; commands. Additionally, rituals for graceful shutdown and error management ensure the temple&#39;s stability. This file provides crucial insights into how requests are processed, tools are invoked, and errors are mitigated.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers dynamic handlers for listing and invoking tools, ensuring their schemas are validated and errors are captured elegantly.</li>
<li><code class="inline-code">run</code>: Starts the server, initializes its transport mechanism, and prepares background data for efficient user commands.</li>
<li><code class="inline-code">main</code>: Orchestrates server creation and manages lifecycle events like clean shutdowns and error logging.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This function dynamically registers handlers for tools, ensuring only valid tools are listed and invoked.</li>
<li>Uses <code class="inline-code">zod</code> validation schemas to ensure parameter integrity before invoking any tool logic.</li>
<li>Demonstrates robust error handling by categorizing errors into known and internal types for clear messaging.</li>
<li>Enables seamless scaling of tools by dynamically iterating through the <code class="inline-code">tools</code> object during runtime.</li>
<li>Centralizes and streamlines request handling logic to maintain system flexibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Starts the server with <code class="inline-code">StdioServerTransport</code>, enabling communication via standard input/output streams.</li>
<li>Prepares &quot;Repomix&quot; content in the background, which hints at a caching mechanism for optimized performance.</li>
<li>Relies on asynchronous behavior (<code class="inline-code">await</code>) to ensure initialization sequence integrity.</li>
<li>Uses the <code class="inline-code">repoAnalyzer.preGenerate</code> function to analyze the working directory, signaling its role in codebase comprehension.</li>
<li>Logs meaningful messages, ensuring real-time transparency about ongoing operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates and initializes the <code class="inline-code">RepoAdventureServer</code> to launch the MCP tools server.</li>
<li>Sets up signal listeners (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) to call <code class="inline-code">gracefulShutdown</code>, preserving application state during termination.</li>
<li>Logs and manages unhandled promise rejections to prevent crashes while providing clarity to users/developers.</li>
<li>Incorporates a try-catch block around server startup for catching fatal errors leading to immediate process termination.</li>
<li>Demonstrates solid practices for ensuring both runtime stability and proper termination in various scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Consider how <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code> represent the interface for tool management. Think about the structure of these schemas.</li>
<li>Investigate the role of <code class="inline-code">zod</code> for schema validation. Why might this approach be used over manual validations?</li>
<li>Use the error handling patterns here as inspiration for designing resilient systems in your projects.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of ancient wisdom, for you have emerged triumphant from the sacred Chamber of Rituals‚Äîlet this first step illuminate your path like a guiding star upon the celestial tapestry! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>