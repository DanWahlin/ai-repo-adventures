<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Unveiling the Ritual Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Infinite Scripts</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Unveiling the Ritual Interface</h1>
<hr>
<p>Beneath the labyrinthine corridors of the Pyramid of Infinite Scripts, you encounter the Ritual Interface Chamber, a place of immense computational mystique. Here, the high sages have safeguarded the core glyphs that control the tools of the ancient server, an interface for harnessing their vast knowledge. The sacred wall inscriptions reveal how tools are summoned, how rituals are executed, and the heartbeat of this intricate system. As the chosen explorer, you must decode and comprehend these mysteries to unlock automated adventures that shape the modern age.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Invocation of Rituals</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically configure the tools and their validation mechanisms?</li>
<li>‚ö° <strong>Summoning the Server</strong>: What is the sequence invoked by the <code class="inline-code">run</code> function to connect the server transport and pre-generate content?</li>
<li>üõ°Ô∏è <strong>Guarding Against Chaos</strong>: How does <code class="inline-code">main</code> ensure graceful shutdown and handle unexpected errors during the server&#39;s lifecycle?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core server configuration and handler setup</h3>
<p>This file contains the essential setup for the MCP server, including initializing toolhandlers, validating input, executing tool workflows, and managing server connections. The <code class="inline-code">RepoAdventureServer</code> class is the foundation upon which interactions with the gamified repository tools are built. Pay particular attention to how handlers are bound dynamically and how the server operates in response to user commands.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Sets up the handlers for tool listing and execution, including schema validation and error management.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Connects the server transport and asynchronously warm-ups the content pipeline to enhance performance.</li>
<li><code class="inline-code">main</code>: Controls the lifecycle of the server, including startup, shutdown, and error handling protocols.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This function sets up rituals (tools) by defining request handlers dynamically for listing and executing tools, ensuring validation with Zod schemas.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> ritual initiates server transport, notifies the adventurer, and primes the artifact processing pipeline in the background.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<p>The <code class="inline-code">main</code> ritual protects the ancient system, ensuring proper shutdown and error resilience during initialization and operation.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Start your exploration with <code class="inline-code">setupHandlers</code> to see how the tools are dynamically registered and validated.</li>
<li>Look at the <code class="inline-code">run</code> function to understand the server startup sequence and its proactive approach to optimizing performance.</li>
<li>Study the <code class="inline-code">main</code> function to discover how safeguards are implemented to ensure a smooth adventuring experience.</li>
</ul>
<hr>
<p>Your understanding of the Ritual Interface has awakened the dormant powers within the Pyramid. The high sages nod in approval as you gain the knowledge to unveil sacred tools. Return when ready for your next challenge!</p>
<p>By the sacred tomes and the eternal flame of enlightenment, thou hast triumphantly unlocked the Ritual Interface, laying the first cornerstone of thy celestial journey! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>