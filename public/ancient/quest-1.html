<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Chamber of Ritual Protocols - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Secrets of the Code Pyramid</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of Ritual Protocols</h1>
<hr>
<p>In the heart of the ancient jungle pyramid, the Chamber of Ritual Protocols reveals a system of interconnected wisdom etched in the glyphs of an old civilization. This chamber is a gateway to understanding the mystical tools that govern the ritual workflows, coded in sacred patterns. To awaken its latent systems, adventurers must decipher the rituals encoded within, unveiling dynamic protocols and runtime flows that enable the pyramid&#39;s inner workings to thrive. Prepare to navigate the labyrinth of ancient interfaces that bind the tools to their purpose.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Invocation Rituals</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically connect tools to the system, ensuring flexibility in their invocation?</li>
<li>‚ö° <strong>Activation Protocol</strong>: What sequence of events does the <code class="inline-code">run</code> function follow to initialize and launch the ancient MCP server and pre-generate data pipelines?</li>
<li>üõ°Ô∏è <strong>Sacred Safety Mechanisms</strong>: How does the <code class="inline-code">main</code> function handle unexpected errors and ensure a graceful shutdown of the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Ancient MCP Server Core</h3>
<p>This file houses the sacred protocols managing the ritualistic server interface for the MCP adventure system. It binds tool invocation rites (<code class="inline-code">setupHandlers</code>) and activation sequences (<code class="inline-code">run</code>) to safeguard the pyramid&#39;s operations. Embedded deeply in its design are safety mechanisms (<code class="inline-code">main</code>) that preserve server functionality even in the face of inescapable turmoil.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic tool listing and execution, orchestrating the tools‚Äô descriptions and ensuring argument validation.</li>
<li><code class="inline-code">run</code>: Activates the MCP server using Stdio transport and pre-generates Repomix content to set the stage for immersive exploration.</li>
<li><code class="inline-code">main</code>: Oversees the system&#39;s lifecycle by initializing the MCP server, handling signal interruptions gracefully, and defending against unhandled rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists tools and their schemas for flexible invocation, adapting to newly added tool definitions.</li>
<li>It validates input parameters using Zod schemas for integrity and error-resistant execution.</li>
<li>Dynamic execution facilitates seamless handling of multiple tools, aligning with the adaptive nature of the MCP system.</li>
<li>Error handling ensures resilience by distinguishing between known errors (<code class="inline-code">McpError</code>) and unexpected failures, providing precise feedback.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes and connects the MCP server using the Stdio transport, ensuring compatibility with interactive environments.</li>
<li>Pre-generates content to accelerate workflows and provide users seamless access to their treasure troves of code insights.</li>
<li>The coupling of server activation and data caching ensures uninterrupted exploration, showcasing optimized architectural design.</li>
<li>Logs key events for transparency, aiding in troubleshooting and performance monitoring.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The function initializes the central server and establishes handlers for graceful system shutdown signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).</li>
<li>Captures and logs unhandled promise rejections to ensure the system remains operational while providing detailed diagnostics.</li>
<li>Uses cautious error management to prevent catastrophic shutdowns while safeguarding server integrity.</li>
<li>Ensures robustness during initialization by directly addressing startup failures, logging critical errors, and exiting cleanly when necessary.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate the use of <code class="inline-code">zodToJsonSchema</code> as a pattern for converting schemas into standardized formats for compatibility.</li>
<li>Observe the workflow of connecting handlers and initializing transport in <code class="inline-code">run</code> to design adaptive system setups.</li>
<li>Examine error propagation techniques in <code class="inline-code">setupHandlers</code> and <code class="inline-code">main</code> for building resilient server interfaces.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden within the jungle pyramid&#39;s chambers.</p>
<p>Hark, seeker of wisdom, thou hast unveiled the Chamber of Ritual Protocols and taken thy first sacred step upon the starry path of enlightenment‚Äîrejoice, for thy odyssey hath only just begun! ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>