<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Ritual of Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Codebase Chronicles: The Temple of Digital Wisdom</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Ritual of Tools</h1>
<hr>
<p>Beneath the ancient temple‚Äôs towering stone arches, the Ritual of Tools awaits discovery. The jungle whispers secrets of civilizations past, where the code-based artifacts were crafted to bridge wisdom and exploration. Here, the sacred relics of the MCP Tool Interface guide adventurers to weave powerful narratives through digital landscapes. As the temple‚Äôs guardian, your task is to unveil these rituals through decoding their purpose and mastering their operations. Within the treasures lie the mystical handlers, connected to quests, logic, and validation techniques. Prepare to explore, for treasures rarely reveal themselves without challenge.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Mapping the Relics</strong>: How do <code class="inline-code">setupHandlers</code> dynamically register tools and validate their input schemas in the MCP system?</li>
<li>‚ö° <strong>Invocation of Operations</strong>: What process governs the activation and initialization of the MCP server as detailed in <code class="inline-code">run</code> and <code class="inline-code">main</code>?</li>
<li>üõ°Ô∏è <strong>Safeguarding the Ritual</strong>: How does error handling within <code class="inline-code">setupHandlers</code> protect the system against invalid tool invocation or execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Sacramental Build of MCP Operations</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> file serves as the gateway to the sacred MCP Tool Interface, binding together handlers, error validation, and transport operations. Within this file, the ancient structures of <code class="inline-code">setupHandlers</code> and the operational <code class="inline-code">run</code> method balance dynamic tool registration with system flow. Their purpose revolves around the invocation of tools, ensuring input schemas are validated and errors are comprehensively managed without halting the ritual. The <code class="inline-code">main</code> program performs the final invocation to raise the server, connecting to the world via standard I/O transport and ensuring graceful shutdown when rituals conclude. The cohesive design preserves the temple‚Äôs wisdom and operational agility.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic tool registration, validating schemas via <code class="inline-code">zodToJsonSchema</code> and ensuring inputs align with expectations.</li>
<li><code class="inline-code">run</code>: Initiates the MCP server‚Äôs execution, pre-generating required content while setting up message transport.</li>
<li><code class="inline-code">main</code>: The final invocation for server execution, managing lifecycle events with signals and unhandled promise safeguards.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tool schemas using <code class="inline-code">zodToJsonSchema</code> for adherence to JSON standards without external references.</li>
<li>Ensures the proper execution of tools by catching and throwing <code class="inline-code">McpError</code> in case of invalid inputs or unknown tools.</li>
<li>Facilitates dynamic tool registration through <code class="inline-code">ListToolsRequestSchema</code> for seamless tool alignment with system capabilities.</li>
<li>Offers robust error-handling to maintain system integrity during execution interruptions.</li>
<li>Integrates modular design principles, enabling individual tool diagnostics and operational clarity.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the MCP tool interface using <code class="inline-code">StdioServerTransport</code>, establishing a modern input/output communication system.</li>
<li>Pre-generates required party mix content via <code class="inline-code">repoAnalyzer.preGenerate</code>, optimizing performance and reducing latency.</li>
<li>Logs server execution state, providing real-time feedback for operational monitoring.</li>
<li>Employs efficient asynchronous architecture for seamless initiation of the MCP storytelling tools.</li>
<li>Develops a system connection to current project paths, leveraging dynamic adaptability to project contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Executes the MCP server lifecycle with <code class="inline-code">main</code> as the central invocation point.</li>
<li>Manages process-level signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for graceful server shutdown when rituals conclude.</li>
<li>Logs and handles unhandled promise rejections without forcing shutdown during recoverable events.</li>
<li>Wraps server operations in robust error-handling mechanisms to guarantee launch stability.</li>
<li>Provides lifecycle orchestration for initialization and termination, safeguarding the sacred rituals.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Utilize <code class="inline-code">zodToJsonSchema</code> as a guide for mapping schema validations to JSON-compatible representations.</li>
<li>Explore the handler structure to dynamically analyze tools and their schemas for deeper architectural insights.</li>
<li>Examine how pre-generation caching in <code class="inline-code">run</code> improves operational efficiency and user experience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden in the codebase‚Äôs ancient wisdom.</p>
<p>Lo, seeker of wisdom, thy hands have mastered the sacred implements, and with this triumph, the ancient path unfolds before thee‚Äîpress onward under the eternal watch of the guiding stars! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>