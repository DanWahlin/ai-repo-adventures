<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Toolwright‚Äôs Forge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Ancient Algorithms</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Toolwright&#39;s Forge</h1>
<hr>
<p>In the shadowed depths of the jungle, the flickering flames of the fabled Toolwright‚Äôs Forge are said to smolder to this day. Legends claim that the forge, hidden within the Codex Obscurum, was built to empower ancient architects with instruments of unimaginable creativity and precision. It is whispered that the forge still crafts tools, imbued with ancient algorithms, that await a worthy discoverer to wield them. Your journey begins here: decipher the glyphs guiding the very tools of the pyramid itself! Will the secrets of the forge unlock your adventure?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph of Invocation</strong>: How are handlers dynamically registered for tool listing and execution within the <code class="inline-code">setupHandlers</code> function? </li>
<li>‚ö° <strong>Glyph of Conduction</strong>: How does the <code class="inline-code">run</code> function initialize and prepare the MCP server, ensuring a responsive and interactive experience? </li>
<li>üõ°Ô∏è <strong>Glyph of Safeguards</strong>: What techniques are used in <code class="inline-code">main</code> to handle errors, ensure graceful server shutdown, and manage exceptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> This file contains the entry point and core server functionality for the gamified MCP (Model Context Protocol) server. Within its confines are the secrets to setting up dynamic handlers for tools, ensuring proper server initialization, and configuring graceful error handling. All these elements work in harmony to breathe life into the adventure experience.</h3>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools and validates parameters, ensuring seamless integration and execution of quests.</li>
<li><code class="inline-code">run</code> activates the MCP server, establishes communication channels, and preloads repomix content for responsive operations.</li>
<li><code class="inline-code">main</code> governs the lifecycle of the MCP server, including robust error handling and the orchestration of shutdown procedures.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools from the <code class="inline-code">tools</code> object, transforming them into a list of available actions accessible via <code class="inline-code">ListToolsRequestSchema</code>.</li>
<li>Leverages <code class="inline-code">zodToJsonSchema</code> to convert Zod schemas into JSON Schema definitions, enabling precise validation and clear communication between client and tools.</li>
<li>Validates input parameters for each tool execution and provides detailed error feedback when validation fails.</li>
<li>Ensures error handling wraps execution failures in a standardized <code class="inline-code">McpError</code> to consistently propagate errors across the system.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Creates a <code class="inline-code">StdioServerTransport</code> instance to communicate via standard input/output, vital for connecting the server to its clients.</li>
<li>Asynchronously connects the MCP server to the transport layer, establishing its interactivity.</li>
<li>Logs server activation status and informs users of the cache warming process to enhance performance during operation.</li>
<li>Uses <code class="inline-code">repoAnalyzer.preGenerate</code> to preload analysis content, reducing latency for subsequent user interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Registers signal listeners for graceful shutdown (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) to ensure proper cleanup of resources before termination.</li>
<li>Monitors unhandled promise rejections, logging issues without interrupting normal server operations. This ensures stability in the event of unexpected errors.</li>
<li>Implements a catch-all try-catch block to handle fatal server errors, ensuring they result in an appropriate exit code (<code class="inline-code">1</code>) and do not compromise system integrity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>The <code class="inline-code">tools.js</code> file enumerates all tools available in the MCP pipeline. Cross-reference these definitions with the <code class="inline-code">setupHandlers</code> function to understand tool registration fully.</li>
<li>Look for how <code class="inline-code">repoAnalyzer</code> is used elsewhere to appreciate its role in preloading and analyzing repository data for faster interaction.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Harken, seeker of the sacred flame, thou hast conquered the rite of the Toolwright‚Äôs Forge‚Äîlet thy spirit ascend like a golden star upon the ancient firmament of wisdom! ‚≠ê‚ö°üìú</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>