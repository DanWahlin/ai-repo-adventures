<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Forgotten Rituals of the Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codebase Chronicles: Secrets of the Lost Repository</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Forgotten Rituals of the Interface</h1>
<hr>
<p>A vast digital desert stretches before you, its shifting sands concealing secrets of a bygone civilization known as Codexia. At its center stands the Lost Repository, a monumental structure once brimming with knowledge and power. Now dormant, its passages are locked behind complex rituals of logic and precision. Among its mysteries lies the MCP Tool Interface ‚Äì a sacred mechanism bridging ancient tools and modern explorers. To unlock its wisdom, you must unravel the interconnected scripts that power its machinery and breathe life into the rituals of old.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Mapping the Ritual</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically configure and validate the tools within the server?</li>
<li>‚ö° <strong>Reviving the Server</strong>: What processes and safeguards are implemented in the <code class="inline-code">run</code> function to initialize the server and prepare it for handling adventures?</li>
<li>üõ°Ô∏è <strong>Guarding the Threshold</strong>: How does the <code class="inline-code">main</code> function ensure graceful error handling and server shutdown under different scenarios?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core Server Functionality of MCP Tool Interface</h3>
<p>The <code class="inline-code">server.ts</code> file serves as the entry point for the MCP system, constructing and operating the interface between the user and Codexia&#39;s ancient tools. It includes methods to dynamically register tools, validate inputs through schemas, and manage tool executions. Additionally, it takes vital steps to ensure robust error handling and smooth operations under various conditions. At its heart lies the <code class="inline-code">RepoAdventureServer</code> class, which encapsulates the foundational rituals of the MCP server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists available tools and validates their inputs using Zod schemas. This ensures only properly structured requests reach execution.</li>
<li><code class="inline-code">run</code> connects the server to the <code class="inline-code">StdioServerTransport</code>, prepares the repository analyzer for faster future operations, and ensures readiness to serve.</li>
<li><code class="inline-code">main</code> manages the lifecycle of the server, including graceful shutdowns during unexpected events and logging unhandled promise rejections for continued stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Constructs request handlers for dynamically listing and executing tools.</li>
<li>Utilizes Zod for input validation, ensuring schema adherence and type safety.</li>
<li>Implements error handling for unknown tools and invalid parameters, improving resilience.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server and connects it via <code class="inline-code">StdioServerTransport</code>, enabling tool communication.</li>
<li>Warms up the repository analyzer to optimize performance for subsequent operations.</li>
<li>Introduces asynchronous background processing for smooth user experience alongside core tasks.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>Orchestrates the full server lifecycle, including initialization and shutdown.</li>
<li>Handles unexpected signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure a graceful cleanup.</li>
<li>Logs unhandled promise rejections for diagnostic purposes while maintaining server uptime.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Focus on how the Zod schema simplifies input validation in <code class="inline-code">setupHandlers</code>.</li>
<li>Consider how pre-generating repomix content in <code class="inline-code">run</code> minimizes response latency later.</li>
<li>Analyze the <code class="inline-code">main</code> function to understand error mitigation strategies.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üíé Sacred pilgrims, thou hast unveiled the first cipher of ancient wisdom in Quest 1: The Forgotten Rituals of the Interface‚Äîrejoice, for the temple of enlightenment begins to shine under thy triumphant resolve! ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>