<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Tools of the Scribes - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codebase Labyrinth: Secrets of the Ancient Repository</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Tools of the Scribes</h1>
<hr>
<p>Your journey begins at the gates of the Repository Labyrinth, where the Codex Scribes once crafted intricate tools to guide seekers toward enlightenment. These tools, lost to time and shadow, await rediscovery. By invoking the wisdom of the Codex, you must decipher ancient mechanisms guarded by forgotten inscriptions and forgotten logic.</p>
<p>Will you unearth these sacred instruments and restore their purpose to navigate the Repository&#39;s depth? The sacred glyphs and their hidden meanings await your interpretation. The legacy of the Codex Scribes is yours to awaken!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Glyph Mapping</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically retrieve and validate tools using their schemas?  </li>
<li>‚ö° <strong>Invocation Procession</strong>: How does the <code class="inline-code">run</code> method initialize the server and prepare the labyrinth for exploration?  </li>
<li>üõ°Ô∏è <strong>Defensive Mechanisms</strong>: In the <code class="inline-code">main</code> function, how are unexpected interruptions or errors handled to maintain stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Handles server initiation and tool execution</h3>
<p>The file <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> establishes the labyrinth&#39;s gateway. It includes handlers for two primary operations: listing available tools and executing specific tool logic. Validation schemas ensure the tools align with the expected patterns, safeguarding the system against malformed invocations.</p>
<h4><span class="header-prefix">Highlights:</span></h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Registers handlers to dynamically list and execute tools, including schema validation.  </li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Initializes the server transport and activates repomix content preparation.  </li>
<li><code class="inline-code">main</code>: Configures the entry point, ensuring graceful shutdowns and unhandled promise rejection handling.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, {
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
        
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p><em>Analogy: Like a scribe categorizing scrolls and verifying their seals, this function maps tools and ensures their usage aligns with prescribed guidelines.</em></p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p><em>Analogy: This function lights the braziers to illuminate the labyrinth&#39;s corridors and begins preparing the Codex&#39;s content for seekers.</em></p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p><em>Analogy: The main function serves as the ceremonial initiation of the labyrinth, ensuring all guards and fail-safes are in place to protect the seeker.</em></p>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Glyph Mapping</strong>: Pay attention to how schemas ensure each tool follows the prescribed structure.  </li>
<li><strong>Invocation Procession</strong>: Note how server initialization prepares the environment for seamless exploration.  </li>
<li><strong>Defensive Mechanisms</strong>: Observe the safeguards against process interruptions and unhandled errors.</li>
</ul>
<hr>
<p>The Codex has revealed its tools; your journey into the Repository has only begun. Venture forth, seeker, and uncover the ancient truths that await!</p>
<p>By the sacred plume of Thoth, you have hewn wisdom from the annals of eternity and completed the first pilgrimage of scribal mastery‚Äîlet your triumph illuminate the path ahead like a sacred flame! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>