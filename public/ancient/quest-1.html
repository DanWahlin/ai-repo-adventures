<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Ritual of Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Secrets of the Lost Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Ritual of Tools</h1>
<hr>
<p>Beneath the dense canopy of the digital jungle lies the first chamber of the Temple of Code: the Sanctum of Tools. Here, the ancients engineered the Ritual of Tools, a mechanism revered for turning intricate code into a living tapestry of interactivity. Your challenge begins in understanding how the tools of this sacred sanctum are summoned, how they are commanded, and how their invocations unlock gateways to new discoveries. Each line of code flows like ancient glyphs, awaiting your interpretation. Will you uncover the secrets embedded in this ritual?  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Invocation of the Sacred List</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically process and validate tools during the listing process?  </li>
<li>‚ö° <strong>Commands of Power</strong>: How does the tool execution mechanism ensure arguments meet the required structure and prevent unexpected errors?  </li>
<li>üõ°Ô∏è <strong>A Guardian‚Äôs Duty</strong>: What safeguards are implemented during <code class="inline-code">main</code> to defend against interruptions and system errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Codebase Ritual Execution</h3>
<p>The <code class="inline-code">server.ts</code> file represents the heart of the Ritual of Tools, where the <code class="inline-code">RepoAdventureServer</code> governs the management of tool listings and invocations. This primary script contains the logic to dynamically list the tools, validate user inputs, and gracefully handle unexpected errors during execution. Moreover, it centralizes key lifecycle commands like startup and shutdown, ensuring the system flows seamlessly during its operation.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: The keystone function that dynamically prepares available tools by inspecting their schemas, packaging metadata, and offering validation capabilities.  </li>
<li><code class="inline-code">run</code>: Activates the server along with a preparatory cache-generation phase, ensuring the user‚Äôs commands are answered responsively.  </li>
<li><code class="inline-code">main</code>: The ritual‚Äôs master orchestrator, handling startup sequences, shutdown signals, and unforeseen errors with resilience.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
    // Dynamic tool listing  
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
        const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
            name,  
            description: tool.description,  
            inputSchema: zodToJsonSchema(tool.schema, {   
                target: &#39;jsonSchema7&#39;,  
                $refStrategy: &#39;none&#39;  
            })  
        }));  

        return { tools: toolList };  
    });  

    // Dynamic tool execution  
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
        try {  
            const { name, arguments: args } = request.params;  

            if (!(name in tools)) {  
                throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
            }  

            const tool = tools[name as keyof typeof tools];  
              
            // Validate arguments using the tool&#39;s Zod schema  
            const validationResult = tool.schema.safeParse(args);  
            if (!validationResult.success) {  
                const errorMessages = validationResult.error.issues.map((err) =&gt;   
                    `${err.path.join(&#39;.&#39;)}: ${err.message}`  
                ).join(&#39;, &#39;);  
                throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
            }  

            // Execute the tool handler with validated arguments  
            return await tool.handler(validationResult.data as any);  

        } catch (error) {  
            if (error instanceof McpError) {  
                throw error;  
            }  
            throw new McpError(  
                ErrorCode.InternalError,  
                `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
            );  
        }  
    });  
}  
</code></pre>
<ul>
<li>Dynamically catalogs available tools by inspecting their <code class="inline-code">schema</code> and metadata.  </li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to generate a useable JSON schema representation for validation.  </li>
<li>Protects the system against improper tool calls with error mechanisms like <code class="inline-code">McpError</code>.  </li>
<li>Demonstrates flexible handling of user requests by separating schema validation and execution logic.  </li>
<li>Provides essential insight into how tool configurations move from static definitions to runtime usability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
    const transport = new StdioServerTransport();  
    await this.server.connect(transport);  
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  
    
    // Pre-generate repomix content for the current working directory to warm up the cache  
    // This happens in the background while waiting for user commands  
    const projectPath = process.cwd();  
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
    repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>Boots the MCP server through <code class="inline-code">StdioServerTransport</code>, enabling input-output handling.  </li>
<li>Triggers a pre-generation phase for faster repomix content utilities.  </li>
<li>Displays logging messages to help track startup and initialization progress.  </li>
<li>Shows how computational resources are pre-distributed to optimize tool execution latency during requests.  </li>
<li>Reinforces a predictable execution flow by informing the user about background pre-generation efforts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
    try {  
        const server = new RepoAdventureServer();  
          
        // Handle graceful shutdown for both signals  
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
            process.on(sig as NodeJS.Signals, gracefulShutdown)  
        );  
          
        // Handle unhandled promise rejections - log but don‚Äôt shutdown during normal operation  
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
            console.error(&#39;Unhandled promise rejection:&#39;, reason);  
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
        });  
          
        await server.run();  
    } catch (error) {  
        console.error(&#39;Fatal error starting MCP server:&#39;, error);  
        process.exit(1);  
    }  
}  
</code></pre>
<ul>
<li>Initiates and safeguards the entire system lifecycle via <code class="inline-code">new RepoAdventureServer()</code> and <code class="inline-code">gracefulShutdown</code>.  </li>
<li>Integrates safety-net handlers (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for controlled termination even during human interruptions.  </li>
<li>Logs all unhandled promise rejections for diagnostic purposes without halting the runtime.  </li>
<li>Serves as the global fail-safe for startup failures, capturing errors and exiting with explicit diagnostics.  </li>
<li>Illustrates a robust error-management design that prioritizes system stability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review the role of <code class="inline-code">zodToJsonSchema</code> in bridging schema validation between static tool definitions and runtime interactions.  </li>
<li>Trace how input/output flows from <code class="inline-code">setupHandlers</code> for both <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code> lifecycle phases.  </li>
<li>Reflect on how the system reduces latency with pre-generation (<code class="inline-code">repoAnalyzer.preGenerate</code>) and examines its impact on system performance.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Behold, seeker of wisdom! By mastering the Ritual of Tools, thou hast unlocked the first sacred stone on the path to enlightenment‚Äîonward to divine mastery! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>