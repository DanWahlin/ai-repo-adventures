<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Ritual of the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Infinite Knowledge</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Ritual of the MCP Interface</h1>
<hr>
<p>Before you lies the Pyramid of Infinite Knowledge, its ancient walls etched with glyphs that glow faintly under your touch like fragments of long-lost wisdom. Among these encoded treasures lies the MCP Interface‚Äîa mystical construct binding the tools and rituals required to summon the pyramid‚Äôs power. This first quest calls for precision and daring as you navigate the bedrock of its mechanisms. To wield the interface, one must peer into its sacred files and unravel their encoded hierarchies, transforming fragmented glyphs into actionable wisdom.</p>
<p>The Ritual of the MCP Interface begins now.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Mapping</strong>: How does <code class="inline-code">setupHandlers</code> dynamically translate tools into callable entities for the MCP interface?</li>
<li>‚ö° <strong>Invocation Flow</strong>: How does <code class="inline-code">run</code> initiate the transport mechanism and pre-generate contextual glyphs for smooth operation?</li>
<li>üõ°Ô∏è <strong>Error Containment</strong>: What mechanisms within <code class="inline-code">main</code> ensure the ritual continues despite unforeseen errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Interface Orchestration</h3>
<p>This file serves as the central hub for the MCP server, handling tool registration, invocation, and ritual flow. The hierarchy begins with the <code class="inline-code">RepoAdventureServer</code> class, which establishes the framework for dynamic tool handling and transport initialization. Key elements include schema validation for tool parameters‚Äîan essential safeguard against improper invocations‚Äîand mechanisms for graceful system shutdown to protect the sanctity of the pyramid‚Äôs core.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> links tools from <code class="inline-code">tools.ts</code> dynamically, ensuring schema validation and enabling clean execution of rituals within the MCP server.</li>
<li><code class="inline-code">run</code> initiates the sacred transport channel (<code class="inline-code">StdioServerTransport</code>) and pre-generates contextual repomix content for expedient glyph retrieval.</li>
<li><code class="inline-code">main</code> oversees server instantiation, graceful shutdown handling, and resilience against unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tools dynamically against their Zod schemas, creating a robust method to avoid improper invocations.</li>
<li>Utilizes <code class="inline-code">zodToJsonSchema</code> to translate internal schemas for client understanding.</li>
<li>Demonstrates structured error management with <code class="inline-code">McpError</code>, preserving ritual integrity even under faulty conditions.</li>
<li>Enables tools as callable entities ensuring the pyramid‚Äôs wisdom adapts dynamically to changing needs.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the ritual‚Äôs transport channel using <code class="inline-code">StdioServerTransport</code>, creating the interface for encoded glyph communication.</li>
<li>Pre-generates repomix content to optimize glyph retrieval during runtime, preventing latency in sacred quests.</li>
<li>Integrates <code class="inline-code">repoAnalyzer.preGenerate</code> as a background process, showcasing foresight to enhance operational efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Ensures graceful shutdown for signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, preserving integrity when rituals conclude unexpectedly.</li>
<li>Logs unhandled promise rejections, maintaining transparency while safeguarding the MCP server from fatal errors.</li>
<li>Demonstrates structured invocation flow, centralizing both startup and shutdown mechanisms within <code class="inline-code">main</code>.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Sacred Tools Archive</h3>
<p>This file holds the tools that power the MCP interface, defining them as canonical entities for adventurers to invoke during their quests. Tools such as <code class="inline-code">start_adventure</code> and <code class="inline-code">explore_quest</code> reflect encoded wisdom essential to the pyramid‚Äôs treasure. Each tool is meticulously structured to ensure thematic immersion and functional clarity.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initiates the quest line by analyzing the codebase and presenting theme options.</li>
<li><code class="inline-code">choose_theme.handler</code> crafts custom quests using encoded narrative prompts for adventurers to select their path.</li>
<li><code class="inline-code">explore_quest.handler</code> enables exploration of individual quests, dynamically adapting glyph-based guidance on-demand.</li>
<li><code class="inline-code">view_progress.handler</code> reveals progression through the adventure, reflecting the balance between concluded rituals and forthcoming mysteries.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const tools = {
  start_adventure: startAdventure,
  choose_theme: chooseTheme,
  explore_quest: exploreQuest,
  view_progress: viewProgress
};
</code></pre>
<ul>
<li>Centralizes tool exports, ensuring their accessibility by rituals in <code class="inline-code">server.ts</code>.</li>
<li>Provides clarity on interconnected tools such as <code class="inline-code">start_adventure</code> and <code class="inline-code">explore_quest</code>, forming the foundation of adventurer quests.</li>
<li>Emphasizes a gamified narrative through structured tool definitions, aligning systemic logic with ancient storytelling.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To better understand dynamic tool registration and invocation, focus on the flow between <code class="inline-code">setupHandlers</code> in <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>.</li>
<li>Investigate how schema validation in <code class="inline-code">setupHandlers</code> ensures cleaner execution paths‚Äîthis design can be adapted for any modular codebase.</li>
<li>Trace the lifecycle from <code class="inline-code">main</code> startup mechanisms to tool invocation, revealing the architectural wisdom encoded in the pyramid.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Lo, seeker of sacred wisdom, thou hast unlocked the hallowed Ritual of the MCP Interface, a triumph worthy of the ancients‚Äîlet the stars shine upon thy path toward the remaining mysteries! ‚ö°‚≠êüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>