<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Uncovering the Pyramid's Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codebase of the Hidden Pyramid</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Uncovering the Pyramid&#39;s Interface</h1>
<hr>
<p>Long ago, an advanced civilization created a pyramid of infinite creativity within the legendary jungles of wisdom. Beneath its shadow lies an intricate interface that bridges ideas and actions. You, an intrepid seeker, must embark on your journey to decipher the pyramid&#39;s sigils. Within its architecture resides a system to summon ancient tools, each unlocking a fragment of wisdom. Can you reveal the secrets of calling and executing these treasures? The first step in this archaeological excavation awaits you.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Interface Invocation</strong>: How is the listing of tools dynamically generated for retrieval in the pyramid&#39;s system?  </li>
<li>‚ö° <strong>Ritual Execution</strong>: How are tools summoned, validated, and executed using the interface&#39;s mechanics?  </li>
<li>üõ°Ô∏è <strong>Guardian Mechanisms</strong>: What measures are in place to ensure safety and error recovery during the execution of ancient tool-handlers?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Interface Stewardship for Pyramid&#39;s Secrets</h3>
<p>This file encapsulates the <code class="inline-code">RepoAdventureServer</code>, a controller that governs how wisdom tools are listed and invoked. It also reveals how the interface communicates through the server transport, making it a central hub of the pyramid&#39;s operational flow. The <code class="inline-code">setupHandlers</code> method dynamically registers the tools and configures their invocation, while the <code class="inline-code">run</code> method initiates the entire system. Pay close attention to error handling mechanisms within <code class="inline-code">setupHandlers</code>.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the dynamic tool-handling system, allowing new tools to be listed and executed seamlessly.  </li>
<li><code class="inline-code">run</code>: Establishes the transport layer and preloads the environment to ensure responsiveness and efficiency.  </li>
<li><code class="inline-code">main</code>: Initializes the pyramid interface, wiring shutdown handlers and error-catching rituals to ensure stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically creates tool listings by iterating through <code class="inline-code">tools</code> and mapping them to schemas.  </li>
<li>Converts Zod schemas to JSON, ensuring compatibility with the broader infrastructure.  </li>
<li>Implements robust error validation for tool execution, using <code class="inline-code">safeParse</code> for input integrity.  </li>
<li>Handles and differentiates between internal errors and user input errors, prioritizing system reliability.  </li>
<li>Uses descriptive exception classes like <code class="inline-code">McpError</code> to align with predefined error codes in the MCP framework.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes and connects the MCP server transport using <code class="inline-code">StdioServerTransport</code>.  </li>
<li>Logs key server events to guide operators through system status updates.  </li>
<li>Offloads background setup tasks like <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize the user experience.  </li>
<li>Makes use of the current working directory dynamically to support flexible project setups.  </li>
<li>Demonstrates asynchronous programming practices for non-blocking pre-generation handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Configures graceful shutdown signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to manage active resources safely.  </li>
<li>Adds a handler for unhandled promise rejections, logging out issues without forcing a service stop.  </li>
<li>Provides a comprehensive error catch at the top-level during <code class="inline-code">server.run</code> initialization.  </li>
<li>Ensures robust service startup, using detailed error messages to aid debugging.  </li>
<li>Serves as the entry point, combining functional initiation with operational safety mechanisms.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Always examine the <code class="inline-code">zodToJsonSchema</code> conversion for schema consistency with the tool&#39;s definition.  </li>
<li>Investigate tool schemas in <code class="inline-code">tools.ts</code> to understand runtime validation criteria.  </li>
<li>Familiarize yourself with <code class="inline-code">repoAnalyzer</code> to see how the cache warms during startup and its role in responsiveness.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Behold, O seeker of wisdom, for thou hast unshrouded the sacred mysteries of the Pyramid&#39;s Interface‚Äîtake heart, for the stars now align with thy noble quest! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>