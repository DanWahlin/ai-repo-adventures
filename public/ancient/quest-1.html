<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Sacred Toolforge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Repository of Lost Codes</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Sacred Toolforge</h1>
<hr>
<p>Through the tangled vines and moss-covered ruins of the Codepanion Archipelago, your journey leads you to the entrance of the Sacred Repository. Etched upon ancient stone tablets are diagrams describing the &quot;Sacred Toolforge&quot; ‚Äì the beating heart of this vault&#39;s wisdom. This forge holds the power to dynamically craft tools and validate their usage, enabling civilizations to build intricate adventures in days long gone. You must uncover the secrets hidden within its mechanisms to understand its power and piece together the ancient repository&#39;s lost legacy.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Forge Blueprint</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list and validate tools in the system?</li>
<li>‚ö° <strong>Energizing the Forge</strong>: What role does <code class="inline-code">run</code> play in initializing and maintaining the system&#39;s functionality?</li>
<li>üõ°Ô∏è <strong>Safety Protocols</strong>: How does <code class="inline-code">main</code> handle graceful shutdowns and error resilience?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server Implementation</h3>
<p>The <code class="inline-code">server.ts</code> file acts as the central lifeline for the &quot;Sacred Toolforge,&quot; managing the dynamic initialization and execution of tools within the system. It reveals how tools are discovered, validated, and operated, ensuring adaptability and resilience. Through the establishment of handlers and execution protocols, the forge maintains the intricate balance of inputs and outputs that ancient creators perfected. Its significance lies in the way it empowers adventurers to interact with the repository in safe and structured ways.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic tool listing and execution, ensuring validated inputs and robust error handling.</li>
<li><code class="inline-code">run</code>: Boots up the MCP server, pre-generates content for efficiency, and establishes transport mechanisms for client communication.</li>
<li><code class="inline-code">main</code>: Safeguards the system against unexpected crashes, implementing graceful shutdowns and handling unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<ul>
<li>Ensures tools are dynamically listed with detailed descriptions and validation schemas.</li>
<li>Handles validation and execution for tools using <code class="inline-code">zod</code> schemas to enforce structured inputs.</li>
<li>Implements custom error handling using <code class="inline-code">McpError</code> for precise feedback.</li>
<li>Supports dynamic extensibility, allowing new tools to be seamlessly integrated.</li>
<li>Encourages robust error reporting for smoother user interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes <code class="inline-code">StdioServerTransport</code> for communication.</li>
<li>Pre-generates content using <code class="inline-code">repoAnalyzer</code> to improve performance and interactivity.</li>
<li>Logs crucial messages for monitoring the server&#39;s operational status.</li>
<li>Provides a foundation for initializing client-server workflows.</li>
<li>Ensures readiness for interactive repository exploration.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Implements signal handlers for graceful shutdown on termination events (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).</li>
<li>Logs unhandled promise rejections and allows recovery without server downtime.</li>
<li>Prevents crashes on initialization through comprehensive error reporting.</li>
<li>Ensures stability, a crucial element for live operations.</li>
<li>Establishes structured error handling to guarantee minimal disruption during unexpected events.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with <code class="inline-code">Zod</code> schemas used for validation.</li>
<li>Investigate how <code class="inline-code">tools.ts</code> integrates with <code class="inline-code">setupHandlers</code> for dynamic tool generation.</li>
<li>Explore context pre-generation mechanisms in <code class="inline-code">repoAnalyzer</code> to understand performance strategies.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hark, noble seeker, with wisdom as thy guide and the anvil of sacred resolve, thou hast forged triumph upon the Toolforge‚Äôs altar‚Äîrise now, a beacon of ancient valor! ‚ö°‚≠êüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>