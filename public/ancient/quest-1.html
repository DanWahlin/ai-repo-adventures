<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Sacred Repository</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<hr>
<p>Amid torchlight and dust, you step into the ziggurat‚Äôs sanctum where the MCP shrine hums with ordered ritual. Stone panels whisper of <code class="inline-code">TypeScript</code> engravings, and sacred conduits bind the <code class="inline-code">RepoAdventureServer</code> to distant seekers through <code class="inline-code">stdio</code>. Two tablets lie before you: <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> holds the invocation rites and graceful shutdown prayers; <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> catalogs the ceremonial implements the acolytes may call. Your role is to read these carvings, trace the flow of offerings to their handlers, and witness how validation, listing, and execution compose the living liturgy of the repository.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Ritual Indexing: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> transform Zod schemas into JSON schema for tool listing, and why is <code class="inline-code">$refStrategy: &#39;none&#39;</code> used in this temple‚Äôs registry?</li>
<li>‚ö° Procession of Incense: In <code class="inline-code">RepoAdventureServer.run</code>, how does the server initialize transport, announce readiness, and pre-warm caches with <code class="inline-code">repoAnalyzer.preGenerate</code> without blocking the altar?</li>
<li>üõ°Ô∏è Ward Against Mischief: In <code class="inline-code">main</code>, how do signal handlers and <code class="inline-code">unhandledRejection</code> listeners safeguard the ceremony, and what errors trigger a full shutdown versus continued operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Invocation rites and procession control</h3>
<p>This tablet inscribes the priestly class <code class="inline-code">RepoAdventureServer</code>, which forges a <code class="inline-code">Server</code> from <code class="inline-code">@modelcontextprotocol/sdk</code> and binds it to the <code class="inline-code">StdioServerTransport</code>. The heart of the ceremony lives within <code class="inline-code">setupHandlers</code>, where two handlers are installed: one to list sacred implements and another to execute them. For listing, the code composes tool entries by reflecting over <code class="inline-code">tools</code>, translating each Zod <code class="inline-code">schema</code> into JSON Schema using <code class="inline-code">zodToJsonSchema</code> with <code class="inline-code">target: &#39;jsonSchema7&#39;</code> and <code class="inline-code">$refStrategy: &#39;none&#39;</code>, preventing nested <code class="inline-code">$ref</code> strings from confusing visiting scribes. For execution, the priest verifies the tool exists, parses arguments with <code class="inline-code">schema.safeParse</code>, aggregates validation issues into a single <code class="inline-code">McpError</code> when needed, and then invokes the tool‚Äôs <code class="inline-code">handler</code>. The <code class="inline-code">run</code> ritual connects to stdio, prints status to the ceremonial stderr brazier, and invokes <code class="inline-code">repoAnalyzer.preGenerate(process.cwd())</code> to warm caches like coals before a rite. The <code class="inline-code">main</code> ceremony oversees lifecycle: crafting the server, binding <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to a <code class="inline-code">gracefulShutdown</code> libation that calls <code class="inline-code">repoAnalyzer.cleanup</code>, and logging <code class="inline-code">unhandledRejection</code> without collapsing the procession. Only fatal startup issues warrant immediate exit.</p>
<h4>Highlights</h4>
<ul>
<li>Dynamic tool registry published with JSON Schema derived from each tool‚Äôs Zod <code class="inline-code">schema</code></li>
<li>Argument validation and error surfacing via <code class="inline-code">McpError</code> with specific <code class="inline-code">ErrorCode</code> choices</li>
<li>Stdio transport connection and background cache pre-generation using <code class="inline-code">repoAnalyzer</code></li>
<li>Graceful shutdown on signals with cleanup and clear console rites</li>
<li>Unhandled rejection logging that preserves ongoing ceremonies</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Catalog of sacred implements</h3>
<p>This tablet enumerates the shrine‚Äôs implements and exposes them as a cohesive <code class="inline-code">tools</code> registry. It imports an <code class="inline-code">adventureManager</code> from the core sanctum and four discrete instruments: <code class="inline-code">startAdventure</code>, <code class="inline-code">chooseTheme</code>, <code class="inline-code">exploreQuest</code>, and <code class="inline-code">viewProgress</code>. Each is re-exported under MCP-aligned names: <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. The registry object <code class="inline-code">tools</code> maps these names to their definitions, enabling the server‚Äôs listing and execution rites. While the handlers‚Äô internal incantations dwell in separate scrolls outside this quest‚Äôs scope, their presence here is essential: the server mirrors this registry to produce <code class="inline-code">ListTools</code> responses and routes <code class="inline-code">CallTool</code> requests to the appropriate <code class="inline-code">handler</code>. The code‚Äôs structure enforces a clear separation between transport/lifecycle concerns in the server and capability definition in tools. This ordering matches ancient practice: catalog first, invoke second, validate always. As you read, note how this registry‚Äôs shape directly informs <code class="inline-code">setupHandlers</code> conversions and validations, ensuring every implement has a <code class="inline-code">description</code>, <code class="inline-code">schema</code>, and <code class="inline-code">handler</code> suitable for ritual use.</p>
<h4>Highlights</h4>
<ul>
<li>Re-exports establish MCP-aligned names used by the server‚Äôs registry</li>
<li><code class="inline-code">tools</code> object consolidates all implements for discovery and invocation</li>
<li>Shared <code class="inline-code">adventureManager</code> is exported for tools that require it</li>
<li>Comments outline the ceremonial flow from starting an adventure to viewing progress</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<p>Like a scribe cataloging relics and then allowing only those bearing proper seals to enter the sanctuary, this code lists tools and validates offerings before any rite proceeds.</p>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<p>As a priest lights incense and prepares braziers before pilgrims arrive, this function opens the stdio gates and warms caches for swift blessings.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<p>Like temple guardians who steady the procession amid tremors, these handlers catch omens, log them, and decide when to end the ceremony.</p>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>This is the reliquary catalog, mapping sacred implements to the names engraved on the temple‚Äôs registry so pilgrims can request them by title.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Trace how <code class="inline-code">tools</code> shapes the output of <code class="inline-code">ListTools</code> and the input to <code class="inline-code">CallTool</code> to understand registry dynamics.</li>
<li>Compare error paths in <code class="inline-code">setupHandlers</code> to see how each <code class="inline-code">ErrorCode</code> guides the acolytes‚Äô responses.</li>
<li>Run the rite locally to observe stderr messages; they mirror the temple‚Äôs bells and signal the procession‚Äôs health.</li>
</ul>
<hr>
<p>The chamber hums as the rites align. You have read the tablets, learned the invocations, and steadied the procession. The ziggurat awaits your next inscription. Adventure continues.</p>
<p>Hail, seeker of wisdom‚Äîby unveiling the sacred workings of Quest 1: MCP Tool Interface, thou hast kindled the temple‚Äôs first torch upon the path of five, a triumphant augury that thy hands are worthy of the codex and thy mind attuned to the oracle‚Äôs craft; onward with valor, for the sanctuary of mastery awaits!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>