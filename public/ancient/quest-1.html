<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Rituals of the Codex Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Codex of Computational Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Rituals of the Codex Interface</h1>
<hr>
<p>In the dense overgrowth of an ancient jungle, you stand before the crumbling remains of a long-lost temple. The atmosphere hums with unseen energy as your torchlight reveals the Codex resting in a nondescript altar, its pages whispering secrets of forgotten computational rituals. To wield its power, you must decipher the Codex&#39;s interface ‚Äî the tools and machinery that animate interactive adventures. Only by mastering this knowledge can you awaken the repository‚Äôs mystical engines and continue your journey.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Mapping</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list and execute tools while ensuring schema validation?</li>
<li>‚ö° <strong>Invocation Mechanisms</strong>: How does the <code class="inline-code">run</code> function activate key components of the system and manage pre-execution setup?</li>
<li>üõ°Ô∏è <strong>Failsafe Protocols</strong>: What mechanisms ensure graceful handling of errors and unexpected interruptions in <code class="inline-code">main</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server initialization and request-handling rituals</h3>
<p>This file contains the core server logic for the repository exploration platform. The <code class="inline-code">RepoAdventureServer</code> class is the heart of the system, defining handlers for dynamically listing and executing tools based on schema-driven input validation. It also establishes communication with the server transport and performs essential setup at runtime. </p>
<p>The following highlights reveal how the system orchestrates its behavior:</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> defines dynamic handlers for tool listing and execution. It interacts with schemas, performs validation, and ensures only registered tools can be invoked.</li>
<li><code class="inline-code">run</code> initializes the server transport and links the system to its execution environment. It also leverages the <code class="inline-code">repoAnalyzer</code> to warm up content for user interactions.</li>
<li><code class="inline-code">main</code> serves as the entry point, managing server instantiation, signal listening for graceful shutdowns, and protection from unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists tools based on the <code class="inline-code">tools</code> registry, constructing JSON schemas for each one. </li>
<li>It validates execution arguments using Zod schemas, preventing malformed input from proceeding.</li>
<li>Error handling ensures that invalid or unknown tool invocations are captured and reported without crashing the server.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes connectivity using the <code class="inline-code">StdioServerTransport</code> for seamless user interaction.</li>
<li>Initiates the analyzer‚Äôs <code class="inline-code">preGenerate</code> function to proactively cache content for efficiency.</li>
<li>Acts as the entry point for activating the repository adventure, preparing the system for immediate user engagement.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Functions as the system‚Äôs main ritual, orchestrating startup logic and signal handling.</li>
<li>Registers handlers for graceful shutdown (<code class="inline-code">SIGINT</code>/<code class="inline-code">SIGTERM</code>) to ensure resource cleanup.</li>
<li>Implements rejection tracking to handle asynchronous anomalies without halting server operation.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Ancient tools for quest generation</h3>
<p>This file encapsulates the tools that bring the Codex‚Äôs functionality to life. Each tool represents a distinct capability, from starting adventures to guiding specific quests. These tools are exported and dynamically registered by the server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initializes adventure analysis, setting the stage for all other operations.</li>
<li><code class="inline-code">choose_theme.handler</code> offers users thematic customization, tailoring quests to their preferences.</li>
<li><code class="inline-code">explore_quest.handler</code> deep-dives into specific quests, providing interactive code exploration opportunities.</li>
<li><code class="inline-code">view_progress.handler</code> tracks user progress and visualizes future challenges.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Validation Rituals</strong>: Pay special attention to how Zod schemas organize and structure tool input/output validation.</li>
<li><strong>Server Flow</strong>: Follow the steps in <code class="inline-code">main</code> to understand how signals and edge cases are predicted and addressed.</li>
<li><strong>Code Linkage</strong>: Observe the connections between <code class="inline-code">setupHandlers</code> and the tools defined in <code class="inline-code">tools.ts</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>O seeker of wisdom, thou hast unveiled the first sacred veils of the Codex Interface with valor, and the celestial temple shines brighter for thy triumph‚Äîforge onward, for the ancients await thy ascension! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>