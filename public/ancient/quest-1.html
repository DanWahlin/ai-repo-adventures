<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Ritual of the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Ancient Systems</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Ritual of the MCP Interface</h1>
<hr>
<p>In the shadowed depths of the jungle, you stand before the Codex of Ancient Systems. One sacred plate bears the enigmatic inscriptions of the &quot;Ritual of the MCP Interface,&quot; where ancient scribes designed tools to weave tales, parse knowledge, and guide travelers through labyrinthine code repositories. With the wisdom of interconnected scripts and the flow of sacred commands, your mission is clear: decipher how the tools of old were validated, invoked, and sustained within the Codex&#39;s server temple.</p>
<p>The secrets of the Codex await. Will you unlock its intricate wisdom or fall amidst its sacred complexity? Let the ritual begin.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Hierophant&#39;s List</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically list tools and validate their inputs for ritualistic use?</li>
<li>‚ö° <strong>Flow of Invocation</strong>: What is the role of <code class="inline-code">main</code> in initializing the server and handling signals during runtime?</li>
<li>üõ°Ô∏è <strong>The Fail-Safe Nexus</strong>: How does <code class="inline-code">setupHandlers</code> safeguard against invalid tools and parameter mismatches during tool invocation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Server Temple</h3>
<p>The <code class="inline-code">server.ts</code> file is the heart of the MCP Interface, hosting the <code class="inline-code">RepoAdventureServer</code> class and its rituals for managing tools. This file defines the server setup, tool execution, error handling, and the main function for initializing the interface. By exploring its methods, you will uncover the temple&#39;s core mechanics and learn how tools and commands are processed with precision.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Establishes request handlers for listing and invoking rituals (tools), dynamically validating them using schema definitions.</li>
<li><code class="inline-code">run</code>: Activates the server, connects it to the transport system, and pre-generates repository data using the <code class="inline-code">repoAnalyzer</code>.</li>
<li><code class="inline-code">main</code>: Orchestrates server startup, signal handling, and graceful shutdown routines to maintain operational stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers requests for listing tools and executing them.</li>
<li>Converts tool schemas into standardized JSON schemas for validation.</li>
<li>Safeguards against invalid tool names and improper arguments, ensuring rituals are precise.</li>
<li>Uses the <code class="inline-code">zod</code> library for schema validation, highlighting the role of robust input checking.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initiates the MCP server and establishes connection with standard I/O transport.</li>
<li>Pre-generates content for the repository to improve tool responsiveness during operation.</li>
<li>Demonstrates a proactive approach to resource preparation, reducing latency for end-users.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Coordinates server initialization and ties it to signal listeners for smooth termination.</li>
<li>Implements defensive programming against unhandled promise rejections to ensure stability.</li>
<li>Emphasizes graceful shutdown through the <code class="inline-code">gracefulShutdown</code> function invocation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>If a particular tool isn&#39;t listed, cross-reference its schema in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>.</li>
<li>Study the <code class="inline-code">setupHandlers</code> pattern for best practices in request validation and modular tool integration.</li>
<li>When tracing errors, look into the <code class="inline-code">McpError</code> class to understand error code mapping.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Thy victorious completion of Quest 1: The Ritual of the MCP Interface hath unlocked the sacred portal of wisdom; with steadfast resolve, thou shalt ascend the celestial path of enlightenment in thy noble journey! ‚ö°üíéüó∫Ô∏è</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>