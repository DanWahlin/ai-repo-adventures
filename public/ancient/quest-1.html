<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Chamber of the Eternal Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Lost Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of the Eternal Interface</h1>
<hr>
<p>You stand before the Pyramid of Lost Code, an architectural marvel left by the ancient Codexius civilization. Legends whisper of the Chamber of the Eternal Interface hidden deep within, where sacred relics‚Äîthe Interface Glyphs‚Äîcontrol collaboration and communication in systems of software engineering. Your exploration begins at the main entrance, where mystical tools, guardians of code logic, await activation. But beware; unraveling the secrets of these glyphs is no trivial feat. Adventurer, prepare yourself to solve mysteries designed to test your ingenuity and skill.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Glyph Discovery</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically integrate and validate tools for the MCP server during initialization?</li>
<li>‚ö° <strong>Ritual Activation</strong>: What sequence of operations does <code class="inline-code">RepoAdventureServer.run</code> perform to activate the server and pre-generate repository content?</li>
<li>üõ°Ô∏è <strong>Obsidian Safety Protocol</strong>: How does <code class="inline-code">main</code> ensure graceful failure recovery and signal handling for the MCP system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Eternal Interface Engine</h3>
<p>This file defines the core MCP server and its operations for the Repo Adventure system. At its heart lies the <code class="inline-code">RepoAdventureServer</code> class, responsible for dynamically loading tools, validating their arguments using schemas, and providing an interface for user interaction. The sacred rituals involve request handling for tool listing and execution, coupled with graceful shutdown logic. Using constructs from modern JavaScript and schema validation patterns, it ensures safe and structured interaction. Explorers will unlock insights into how dynamic interfaces can power collaborative systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates input schemas, ensuring logical and error-free tool execution.</li>
<li><code class="inline-code">run</code>: Activates the MCP server via Stdio transport and pre-generates repository content for enhanced performance.</li>
<li><code class="inline-code">main</code>: Handles server startup and ensures graceful shutdown during errors or termination signals.</li>
</ul>
<hr>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, {
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools registered in the system, providing metadata and validation schemas for robust tool usage.</li>
<li>Uses <code class="inline-code">zod-to-json-schema</code>, converting input schemas to JSON Schema format for universal validation.</li>
<li>Handles execution of tool logic while validating user arguments, ensuring safety and minimizing errors.</li>
<li>Throws detailed error messages using <code class="inline-code">McpError</code> to guide users in correcting faulty parameters.</li>
<li>Demonstrates dynamic and adaptable design patterns in request handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server transport between MCP system and external interactions using <code class="inline-code">StdioServerTransport</code>.</li>
<li>Logs essential information for runtime, ensuring visibility into server operation.</li>
<li>Pre-generates repository content for the current project directory, optimizing future tool operations.</li>
<li>Uses <code class="inline-code">repoAnalyzer.preGenerate</code> for asynchronous content generation, showcasing efficient cache-warming techniques.</li>
<li>Demonstrates solid patterns for combining initialization with background task processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Initializes <code class="inline-code">RepoAdventureServer</code> and registers graceful shutdown handlers for termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).</li>
<li>Ensures recovery from unhandled promise rejections without shutting down the server.</li>
<li>Facilitates the cleanup of analytical resources using <code class="inline-code">repoAnalyzer.cleanup</code>.</li>
<li>Protects system integrity by ensuring proper shutdown in case of fatal errors during initialization.</li>
<li>Highlights robust design patterns for process management in long-running applications.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <code class="inline-code">zod-to-json-schema</code> empowers validation in <code class="inline-code">setupHandlers</code>.</li>
<li>Observe how <code class="inline-code">run</code> leverages asynchronous initialization for content optimization.</li>
<li>Examine graceful shutdown logic in <code class="inline-code">main</code> to learn error recovery best practices.</li>
</ul>
<hr>
<p>Your journey through the Chamber of the Eternal Interface continues‚Äîequip yourself with knowledge to navigate further mysteries!</p>
<p>O seeker of sacred wisdom, thou hast triumphed in the hallowed Chamber of the Eternal Interface‚Äîmay thy journey be blessed with the radiance of ancient stars and the strength of divine purpose! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>