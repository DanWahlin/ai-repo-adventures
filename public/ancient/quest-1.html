<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Hall of Ritual Design - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Ancient Knowledge</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Hall of Ritual Design</h1>
<hr>
<p>As you step into the first chamber of the Pyramid of Ancient Knowledge, you find yourself surrounded by walls covered in glowing glyphs. This is the Hall of Ritual Design, a place where the architects of wisdom constructed frameworks to breathe life into collaborative tools. Before you lies the mechanism of the mystical MCP Tool Interface, said to power all adventures across this ancient structure. Your goal is to investigate its sacred rituals and uncover the patterns that make these tools come alive.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Summoning Rituals</strong>: How does <code class="inline-code">RepoAdventureServer</code> dynamically configure and execute tools? What role does <code class="inline-code">setupHandlers</code> play in this process?</li>
<li>‚ö° <strong>Lifecycle Observations</strong>: How does the server initialize, manage connections, and handle failures through <code class="inline-code">run</code> and <code class="inline-code">main</code>? </li>
<li>üõ°Ô∏è <strong>Error Safeguards</strong>: What error handling mechanisms ensure the server remains stable during tool execution or unexpected issues?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Summoner of Adventures</h3>
<p>This file contains the core <code class="inline-code">RepoAdventureServer</code>, responsible for initializing the MCP server, loading tools, and handling their execution through sacred rituals. It utilizes <code class="inline-code">setupHandlers</code> to define and register dynamic tool functionalities like listing and invoking tools. The <code class="inline-code">run</code> function sets the server into action, while <code class="inline-code">main</code> ensures everything begins and ends with grace, managing unexpected disruptions with a robust shutdown sequence.</p>
<h4>Highlights</h4>
<ul>
<li><em><code class="inline-code">setupHandlers</code></em>: Defines the ancient rituals for managing tool listings and invocations.</li>
<li><em><code class="inline-code">run</code></em>: Activates the server, warms up caches, and prepares for user inputs.</li>
<li><em><code class="inline-code">main</code></em>: Oversees the server lifecycle, including graceful shutdown and error recovery.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<p>This function is the architect of the server&#39;s rituals, transforming tool definitions into dynamic capabilities.</p>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>This function awakens the server, establishing its connection and preparing the sacred &quot;repomix&quot; contents.</p>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
          // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}

main().catch((error) =&gt; {
    console.error(&#39;Unhandled error:&#39;, error);
    process.exit(1);
});
</code></pre>
<p>This function oversees the server&#39;s lifecycle, from its initiation to handling abrupt interruptions or fatal disruptions.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Repository of Rituals</h3>
<p>This file serves as a compendium of tools, organized to support various quests such as starting an adventure, choosing a theme, or tracking progress. It exports these tools so they can be dynamically invoked by the <code class="inline-code">RepoAdventureServer</code>.</p>
<h4>Highlights</h4>
<ul>
<li><em><code class="inline-code">start_adventure.handler</code></em>: The entry ritual for uncovering and presenting codebase analysis.</li>
<li><em><code class="inline-code">explore_quest.handler</code></em>: Powers the journey into individual challenges within an adventure.</li>
<li><em><code class="inline-code">view_progress.handler</code></em>: Displays progress and quest completion status.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<p>The handlers here link tool definitions to their functionalities, enabling their invocation through the server.</p>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>This object acts as a sacred index, cataloging all tools and their descriptions for easier access.</p>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
</code></pre>
<p>This shared manager facilitates session-based state and inter-tool coordination across different quests.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <code class="inline-code">setupHandlers</code> validates inputs and executes tool functionality.</li>
<li>Trace the flow between <code class="inline-code">startAdventure</code> in <code class="inline-code">tools.ts</code> and its corresponding rituals in <code class="inline-code">server.ts</code>.</li>
<li>Examine the error handling pattern within <code class="inline-code">CallToolRequestSchema</code> to understand fault tolerance mechanisms.</li>
</ul>
<hr>
<p>You uncover a deeper connection between the Hall&#39;s glyphs and the pyramid&#39;s structure itself. With newfound insight, you prepare for your next chapter of discovery.</p>
<p>Thou hast ascended the sacred steps of the Hall of Ritual Design, unveiling ancient wisdom with steadfast spirit‚Äîthy journey to enlightenment begins with valor! ‚ö°üó∫Ô∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>