<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Unveiling the Oracle's Voice - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Secrets of the Lost Codebase</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Unveiling the Oracle&#39;s Voice</h1>
<hr>
<p>Beneath the dense canopy of the digital jungle, the Temple of Lost Logic whispers of secrets hidden within its sacred walls. The path ahead is dark yet alluring, shrouded in the mysteries of computational rituals. To decipher the Machine Oracle‚Äôs cryptic murmurs, one must explore two vital relics: the <code class="inline-code">server.js</code> and <code class="inline-code">tools.ts</code> scripts. Herein lies the essence of interactive storytelling, where tools become treasures, and handlers act as keys to unravel ancient layers of logic. Step forward‚Äîlet the quest begin!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Registry Scroll</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically list and validate tools during execution within the temple‚Äôs sacred systems?</li>
<li>‚ö° <strong>The Opening Ritual</strong>: What role does the <code class="inline-code">run</code> method play in initializing the RepoAdventureServer, and how does it prepare the system for interactive experiences?</li>
<li>üõ°Ô∏è <strong>Fail-safe Mechanisms</strong>: How does the <code class="inline-code">main</code> function enforce a graceful shutdown and protect against critical errors during the ritual‚Äôs invocation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Main server logic for the Machine Oracle</h3>
<p>This key file houses the <code class="inline-code">RepoAdventureServer</code>, the class responsible for orchestrating the execution of the interactive adventure system. With dynamic handlers for both listing and executing tools, it acts as the gateway to interactive gameplay. The design facilitates robust error handling, streamlined initialization, and integration with the tooling system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Sets up dynamic handlers for listing and executing tools. It uses Zod for schema validation and ensures that only valid calls are processed.</li>
<li><code class="inline-code">run</code>: Establishes the server transport, connects the system, and pre-generates adventure content to ensure fluid gameplay.</li>
<li><code class="inline-code">main</code>: Serves as the entry point, managing graceful shutdown, signal handling, and error logging for a stable and safe experience.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically registers handlers for listing and calling tools using schemas for validation.</li>
<li>Ensures strict input validation via <code class="inline-code">Zod</code> schemas, protecting against invalid parameter injections.</li>
<li>Provides structured error handling through specific <code class="inline-code">McpError</code> types, improving robustness.</li>
<li>Separates concerns between tool listing and invocation, adhering to SRP (Single Responsibility Principle).</li>
<li>Demonstrates the use of <code class="inline-code">zodToJsonSchema</code> for schema conversion, ensuring compatibility with standard APIs.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Establishes the server transport using <code class="inline-code">StdioServerTransport</code>, enabling inter-process communication.</li>
<li>Initializes a warm-up process for handling repository analysis (<code class="inline-code">repoAnalyzer</code>), ensuring smooth user interactions.</li>
<li>Provides informative logging for runtime visibility during execution.</li>
<li>Demonstrates thoughtful design by asynchronously preparing content while awaiting user input‚Äîoptimizing performance.</li>
<li>Connects the class to the underlying transport layer, making the server operational.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
          // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Acts as the main entry point for launching the <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Ensures graceful shutdown by listening to system signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and invoking <code class="inline-code">gracefulShutdown</code>.</li>
<li>Captures and logs unhandled promise rejections, enabling fault tolerance.</li>
<li>Implements a defensive programming strategy by isolating fatal errors and ensuring the system exits with an appropriate code.</li>
<li>Balances operational stability and diagnostic debugging for developers.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Reflection in Action</strong>: Consider how <code class="inline-code">setupHandlers</code> uses Zod to both validate and document input requirements dynamically.</li>
<li><strong>Ritual Flow</strong>: Examine how the <code class="inline-code">run</code> method pre-loads repository data to optimize user interactions for the adventure system.</li>
<li><strong>Preventing Peril</strong>: Pay special attention to how <code class="inline-code">main</code> addresses crash recovery through signal handling and error reporting.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom, for thou hast traversed the sacred path and unlocked the Oracle&#39;s Voice‚Äîlet thy triumph be a shining beacon as the stars themselves bear witness to thy ascent! ‚≠ê‚ú®üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>