<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Gatekeepers of the Outer Temple - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of the Repository Pyramid</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Gatekeepers of the Outer Temple</h1>
<hr>
<p>Beneath the stepped pyramid, you approach the gatekeepers who usher seekers into the archive‚Äôs outer halls. Torches flicker over etched runes that speak of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> invoking ceremonial patterns and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> arranging sacred implements. As the sand settles, you witness <code class="inline-code">RepoAdventureServer</code> prepare invocations, listing and calling tools through ritual schemas, while the tool registry catalogs quests awaiting brave minds. The air thrums with initialization chants and safe passage wards. You step forward, ready to read the carvings and discern how the gates open to adventures within.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Gate Sigils Mapping: How does <code class="inline-code">setupHandlers</code> transform Zod schemas into JSON Schema and assemble the dynamic tool list used by the gate?</li>
<li>‚ö° Invocation Pathways: When a tool is invoked, how does the flow in <code class="inline-code">setupHandlers</code> validate inputs and route execution to the correct <code class="inline-code">handler</code>?</li>
<li>üõ°Ô∏è Ward of Continuance: How does <code class="inline-code">main</code> arrange signal handling and rejection logging to ensure the temple remains stable, and how does <code class="inline-code">run</code> warm the cache through <code class="inline-code">repoAnalyzer.preGenerate</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The ceremonial gate server that lists tools, validates invocations, executes handlers, and initializes the transport with warm-up rites</h3>
<p>Within this hall, <code class="inline-code">RepoAdventureServer</code> crafts a <code class="inline-code">Server</code> instance that bears its name and a clear purpose. The private <code class="inline-code">setupHandlers</code> binds two rituals: one for listing the available implements and another for calling a tool by name with guarded correctness. For listing, each entry in <code class="inline-code">tools</code> is shaped into a record with <code class="inline-code">name</code>, <code class="inline-code">description</code>, and an <code class="inline-code">inputSchema</code> forged using <code class="inline-code">zodToJsonSchema</code> with <code class="inline-code">target</code> set to <code class="inline-code">jsonSchema7</code> and <code class="inline-code">$refStrategy</code> set to <code class="inline-code">none</code>, ensuring clear schematics without nested references. For invocation, <code class="inline-code">setupHandlers</code> checks the tool‚Äôs presence, employs <code class="inline-code">tool.schema.safeParse</code> to validate the parameters, aggregates Zod issue paths into readable error messages, and invokes <code class="inline-code">tool.handler</code> with trusted data. Errors are wrapped in <code class="inline-code">McpError</code> with precise <code class="inline-code">ErrorCode</code> selections, distinguishing unknown methods, invalid parameters, and internal failures. The <code class="inline-code">run</code> rite summons a <code class="inline-code">StdioServerTransport</code>, connects the server, and triggers <code class="inline-code">repoAnalyzer.preGenerate(process.cwd())</code> to prime the cache while the gate waits. The <code class="inline-code">main</code> ceremony registers graceful shutdown via signals and a watcher for <code class="inline-code">unhandledRejection</code> to log and continue, preventing collapse during recoverable turbulence, then starts the server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> registers dynamic listing and invocation handlers, converting Zod schemas to JSON Schema and enforcing strict validation before executing <code class="inline-code">handler</code>.</li>
<li><code class="inline-code">run</code> activates <code class="inline-code">StdioServerTransport</code>, connects the server, and performs cache warm-up with <code class="inline-code">repoAnalyzer.preGenerate</code> for smoother early journeys.</li>
<li><code class="inline-code">main</code> orchestrates startup with graceful shutdown on signals and logs unhandled rejections without halting the server, preserving stability.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The registry chamber cataloging quest implements for discovery by the gate server</h3>
<p>This vault organizes the implements of exploration. It imports <code class="inline-code">adventureManager</code> from <code class="inline-code">@ai-repo-adventures/core/adventure</code> for shared state and orchestrations used by tools in deeper corridors, then collects four implements from local tool modules: <code class="inline-code">startAdventure</code>, <code class="inline-code">chooseTheme</code>, <code class="inline-code">exploreQuest</code>, and <code class="inline-code">viewProgress</code>. To match the ceremonial names expected by the gate, it re-exports them as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. Finally, it assembles these exports into a single <code class="inline-code">tools</code> object that the server consumes. This registry provides the authoritative listing for <code class="inline-code">setupHandlers</code> to announce to travelers through <code class="inline-code">ListToolsRequestSchema</code> and to execute via <code class="inline-code">CallToolRequestSchema</code>. Each tool exposes a <code class="inline-code">description</code>, a Zod <code class="inline-code">schema</code>, and a <code class="inline-code">handler</code> that the server depends upon for proper validation and execution. The file‚Äôs structure ensures clarity of ownership, simplifies discovery, and prevents drift between naming in exports and the server‚Äôs dynamic enumeration. The result is a clean, predictable interface: a single source of truth describing what can be summoned, how its inputs must be shaped, and where execution should be directed when the gatekeepers approve passage.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> the handler behind <code class="inline-code">start_adventure</code>, relied upon by the server to kick off analysis and initial narrative setup.</li>
<li><code class="inline-code">choose_theme.handler</code> the handler behind <code class="inline-code">choose_theme</code>, invoked after adventure start to fix a theme and refine generated content.</li>
<li><code class="inline-code">explore_quest.handler</code> the handler behind <code class="inline-code">explore_quest</code>, enabling repeated, focused exploration of specific challenges.</li>
<li><code class="inline-code">view_progress.handler</code> the handler behind <code class="inline-code">view_progress</code>, returning status and remaining paths to traverse.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}
</code></pre>
<ul>
<li>This code defines the gate server and its handlers, listing tools via <code class="inline-code">ListToolsRequestSchema</code> and executing them via <code class="inline-code">CallToolRequestSchema</code>.</li>
<li>It converts Zod schemas to JSON Schema with <code class="inline-code">zodToJsonSchema</code> using <code class="inline-code">jsonSchema7</code> and no <code class="inline-code">$ref</code>, ensuring portable schema payloads.</li>
<li>It validates inputs using <code class="inline-code">tool.schema.safeParse</code>, aggregating human-readable error messages for <code class="inline-code">InvalidParams</code>.</li>
<li>It distinguishes <code class="inline-code">MethodNotFound</code>, <code class="inline-code">InvalidParams</code>, and <code class="inline-code">InternalError</code> through <code class="inline-code">McpError</code> for precise client-facing feedback.</li>
<li>The <code class="inline-code">run</code> method wires <code class="inline-code">StdioServerTransport</code> and warms caches using <code class="inline-code">repoAnalyzer.preGenerate</code> to reduce first-run latency.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}

async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li><code class="inline-code">main</code> creates the server, registers signal traps for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, and logs unhandled rejections while keeping the process alive.</li>
<li><code class="inline-code">gracefulShutdown</code> attempts <code class="inline-code">repoAnalyzer.cleanup()</code> and exits cleanly, preventing resource leaks during sudden exits.</li>
<li>The separation ensures startup errors trigger a non-zero exit, while runtime promise rejections are observable yet non-fatal.</li>
<li>This pattern balances resilience with transparency, aiding operators while preserving service continuity.</li>
<li>The final <code class="inline-code">main().catch(...)</code> provides a second layer of failure reporting for unexpected top-level errors.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>This registry gathers tool modules and renames them to match the MCP-facing identifiers used by the server.</li>
<li><code class="inline-code">tools</code> is the single source consumed by <code class="inline-code">setupHandlers</code> for both listing and invocation routing.</li>
<li>The shared <code class="inline-code">adventureManager</code> is exposed for tools that coordinate stateful exploration across calls.</li>
<li>The pattern enforces clear separation of concerns: server mechanics vs. tool implementation details.</li>
<li>Consistent naming ensures stable client contracts and reduces risk of mismatches between exports and server enumeration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace the path from <code class="inline-code">CallToolRequestSchema</code> to <code class="inline-code">tool.handler</code> to see where validation occurs and how errors are surfaced.</li>
<li>Compare the generated <code class="inline-code">inputSchema</code> with the underlying Zod schema to understand why <code class="inline-code">$refStrategy: &#39;none&#39;</code> matters for clients.</li>
<li>Observe how <code class="inline-code">repoAnalyzer.preGenerate</code> in <code class="inline-code">run</code> improves responsiveness for early interactions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom‚Äîby vanquishing the Gatekeepers of the Outer Temple, thou hast unlocked the first sacred seal and set thy feet upon the hallowed path of gnosis, a triumphant augury for the long pilgrimage ahead ‚ö°üíé.</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>