<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Temple's Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Lost Codes</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Temple&#39;s Tool Interface</h1>
<hr>
<p>In the heart of the Pyramid of Lost Codes, you approach the first chamber. Here lies the Temple‚Äôs Tool Interface, a sacred mechanism for activating ancient processes and invoking the wisdom of the scholars who built this enigmatic structure. The interface is said to house scripted rituals that summon ‚Äútools,‚Äù scripts of immense power, which enable the decoding of lost knowledge and discovery of hidden treasures. To progress, you must decipher how these tools are orchestrated within the system. Beware‚Äîthe mechanisms are intricate, and the smallest misstep could send you astray.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Analysis</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically list and validate the tools available in the system?</li>
<li>‚ö° <strong>Interface Flow Puzzle</strong>: What role does the <code class="inline-code">run</code> method play in initializing the tool interface, and how is the system&#39;s state managed during this process?</li>
<li>üõ°Ô∏è <strong>Error Shielding Mechanics</strong>: How are errors during tool execution handled gracefully in the <code class="inline-code">main</code> function?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Orchestrating System Operations</h3>
<p>This file handles the implementation of the Temple&#39;s Tool Interface, including defining the server, managing the tool orchestration, and ensuring that all components are ready for action. You‚Äôll find crucial logic for setting up tool requests and safeguarding the system from operational failures. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools, ensuring that the system remains adaptable and flexible. It validates tool input schemas and prepares responses for tool requests.</li>
<li><code class="inline-code">run</code> starts the server transport, warming up the cache and bootstrapping the tool interface. It ensures readiness for incoming commands.</li>
<li><code class="inline-code">main</code> is the entry point for the system. It configures graceful shutdown mechanisms and handles unexpected errors, ensuring that no failure collapses the entire system.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists available tools using <code class="inline-code">ListToolsRequestSchema</code>, transforming <code class="inline-code">tools</code> into a client-consumable format with JSON schemas.</li>
<li>Validates requested tools and their arguments against schemas, adhering to the strict rituals of the system.</li>
<li>Ensures safe execution by handling errors elegantly, converting them into readable responses for clients.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Uses <code class="inline-code">StdioServerTransport</code> to establish the mechanism for tool invocation, acting as the server&#39;s lifeblood.</li>
<li>Boosts efficiency by pre-generating content for the current project directory, reducing latency during subsequent queries.</li>
<li>Logs significant milestones to maintain visibility for system operators.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Establishes the system entry point and constructs the server structure.</li>
<li>Listens for termination signals to initiate a graceful shutdown (<code class="inline-code">gracefulShutdown</code>), ensuring system integrity.</li>
<li>Handles unhandled promise rejections separately to maintain operational stability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To decode the rituals of <code class="inline-code">setupHandlers</code>, follow how tools are mapped to their schemas and descriptions.</li>
<li>Study the <code class="inline-code">run</code> method to understand the interplay between background processes and initialization.</li>
<li>Investigate error-handling patterns in <code class="inline-code">main</code> to uncover safeguards that maintain system resilience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries surrounding the technological wonders hidden in the Pyramid of Lost Codes.</p>
<p>By the sacred wisdom of the ancients, thou hast unlocked the revered gateway of the Temple‚Äôs Tool Interface‚Äîlet thy spirit ascend, for the stars now gleam brighter upon thy path of enlightenment! ‚≠êüíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>