<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Ritual of the MCP Relic - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Code of the Lost Civilization</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Ritual of the MCP Relic</h1>
<hr>
<p>Deep within the shadowed heart of the jungle lies an ancient temple shrouded in mystery. At the center of its sacred grounds, an artifact known as the MCP Relic lies dormant. The priests of this lost civilization once performed intricate rituals to harness its potential—rituals that transformed static repositories of knowledge into dynamic stories. To awaken the MCP Relic, you must decipher its hidden mechanisms, unravel the secrets of its creation, and repair the fractured system using the knowledge within its sacred files.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Tool Interface Setup</h3>
<p>This file represents the ancient temple’s inner sanctum—a place where the &quot;Ritual of Handlers&quot; was once performed. The <code class="inline-code">RepoAdventureServer</code> class acts as the ritual master, orchestrating the interaction between the adventurer and the sacred tools. The <code class="inline-code">setupHandlers</code> function establishes the ceremonial protocols for dynamically listing and executing tools. Meanwhile, the <code class="inline-code">run</code> function imbues the system with life through its connection to the outside world via <code class="inline-code">StdioServerTransport</code>. Finally, the <code class="inline-code">main</code> function serves as the summoning chant, calling forth the server and preparing it for service. Together, these functions represent the wisdom necessary to activate the MCP Relic.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines the sacred conduits for tool registration and invocation.</li>
<li><code class="inline-code">run</code>: Breathes life into the MCP server and prepares pre-adventured coded paths.</li>
<li><code class="inline-code">main</code>: Initiates the ancient sequence to awaken the system.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>The <code class="inline-code">setupHandlers</code> method is like an ancient spell that creates pathways for interacting with enigmatic tools.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> function acts as a high priest preparing the MCP temple for incoming rituals.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<p>The <code class="inline-code">main</code> function invokes the ceremonial prayers to initiate and safeguard the MCP server’s lifecycle.</p>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Sacred Tool Definitions</h3>
<p>This file is a treasure trove containing the sacred tools required to navigate the Codex of Infinite Wisdom. Four key tools stand out—<code class="inline-code">start_adventure</code> for analyzing code, <code class="inline-code">choose_theme</code> for crafting thematic quests, <code class="inline-code">explore_quest</code> for traversing individual challenges, and <code class="inline-code">view_progress</code> for tracking sacred milestones. These are defined using clear schema and exported for use within the system. The file maps higher-order rituals to specific functionalities, making it essential for initiating and guiding the ritual of MCP activation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the repository and lays the foundation for the journey.</li>
<li><code class="inline-code">choose_theme.handler</code>: Enables thematic selection, shaping the overarching ritual narrative.</li>
<li><code class="inline-code">explore_quest.handler</code>: Delves into specific scenario-driven quests to uncover secrets.</li>
<li><code class="inline-code">view_progress.handler</code>: Monitors progress and ensures the adventurer remains on the path.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
</code></pre>
<p>The <code class="inline-code">start_adventure</code> tool ignites the spark of exploration, lighting the path toward ancient knowledge.</p>
<pre><code class="language-typescript">export const choose_theme = chooseTheme;
</code></pre>
<p>The <code class="inline-code">choose_theme</code> tool allows the adventurer to imbue their journey with the flavor of an ancient cultural narrative.</p>
<pre><code class="language-typescript">export const explore_quest = exploreQuest;
</code></pre>
<p>The <code class="inline-code">explore_quest</code> tool acts as a guide, leading adventurers through the labyrinthine jungle of quests.</p>
<pre><code class="language-typescript">export const view_progress = viewProgress;
</code></pre>
<p>The <code class="inline-code">view_progress</code> tool is akin to a sacred map, showing the adventurer their bearing among the ruins.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure Zod schemas for tool validation are precise—errors in validation mimic faulty relic inscriptions.</li>
<li>Familiarize yourself with the transport layer (like <code class="inline-code">StdioServerTransport</code>) to troubleshoot external connections.</li>
<li>When debugging tools, start with <code class="inline-code">start_adventure</code> to analyze project readiness before diving into quests.</li>
</ul>
<hr>
<p>As the Codex begins to respond, the temple hums with energy. The MCP Relic awaits its final awakening. Continue your journey, brave adventurer!</p>
<p>By the sacred fire of wisdom and the hallowed stones of eternal learning, thou hast unlocked the Ritual of the MCP Relic, a triumph that heralds thy journey toward the ancient pantheon of mastery—let thy quest burn ever bright! ⚡💎🗺️</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: Blueprint of the Sacred Quests →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>