<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Pillars of Quest Generation - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Code of Lost Civilizations</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Pillars of Quest Generation</h1>
<hr>
<p>Beneath the overgrown canopies of the uncharted jungle, you unearth the Pillars of Quest Generation‚Äîancient constructs built to weave wisdom into structured paths of enlightenment. These towering monoliths pulse faintly with stored energy, hinting at their once-glorious operation. By decoding their mysterious glyphs and learning the intricacies of their rituals, you gain the power to reconstruct lost adventures and restore the pillars to their former might. Will you succeed in rekindling this ancient art?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Web of Rituals</strong>: How does <code class="inline-code">setupHandlers</code> dynamically configure and manage tool interactions within the system?</li>
<li>‚ö° <strong>The Lifeblood of the Pillars</strong>: What actions are performed during the <code class="inline-code">run</code> function to initialize and enhance system performance? </li>
<li>üõ°Ô∏è <strong>Guardian of the Realm</strong>: How does the <code class="inline-code">main</code> function ensure safe initialization and mitigate potential critical failures during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: Core server logic for the MCP system</h3>
<p>Within the depths of this ancient file lies the foundation of the &quot;Repo Adventure&quot; server, responsible for facilitating dynamic, interactive journeys. The class <code class="inline-code">RepoAdventureServer</code> embodies the structure, setting up handlers for tool interaction and transport mechanisms that convey knowledge to explorers. Relics of error handling and graceful recovery are also deeply embedded within its rituals, culminating in the final activation sequence.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the server to dynamically list and execute tools by validating inputs and delegating processing to handlers. This ensures modularity and adaptability for adventurers.</li>
<li><code class="inline-code">run</code>: Establishes the primary communication channel, initiates the transport layer, and primes background processes to optimize performance for future requests.</li>
<li><code class="inline-code">main</code>: Orchestrates the server‚Äôs initialization, handles critical signals like shutdown requests, and safeguards operations from unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>This code dynamically links tools to the server, allowing for modular additions without altering core functionality.</li>
<li>It uses structured schemas via <code class="inline-code">zodToJsonSchema</code> to validate tool inputs before execution, ensuring robustness.</li>
<li>By centralizing error handling with <code class="inline-code">McpError</code>, the code celebrates resilience‚Äîguarding against runtime mishaps.</li>
<li>The design shifts validation and execution to the server-side, promoting secure client-server boundaries.</li>
<li>Observing this ritual reveals the secrets of extensibility in ancient server architectures.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li><code class="inline-code">run</code> initializes the primary transport channel with <code class="inline-code">StdioServerTransport</code>‚Äîa simple but effective communication path.</li>
<li>It prints vital operational logs to help adventurers locate key entry points within the system.</li>
<li>By invoking <code class="inline-code">repoAnalyzer.preGenerate</code>, the server primes internal caches, improving response efficiency for subsequent operations.</li>
<li>Its synchronous initiation flow enables developers to predict and debug early-stage conflicts effortlessly.</li>
<li>Witnessing this process teaches adventurers the importance of initialization optimization in complex systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function ensures proper initialization by wrapping the process in robust <code class="inline-code">try-catch</code> logic.</li>
<li>It gracefully traps shutdown signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> via event listeners, ensuring smooth system termination.</li>
<li>Unhandled promise rejections are logged to aid debugging while keeping the server operational, showcasing how containment reduces downtime.</li>
<li>By encapsulating server operations within <code class="inline-code">main</code>, the design simplifies entry-point debugging and centralizes initialization steps.</li>
<li>Studying this implementation highlights the value of centralized failure recovery mechanisms in maintaining reliability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tool Alignment Insight</strong>: To expand the server‚Äôs capabilities, any new tools added must comply with the dynamic schema validation demonstrated in <code class="inline-code">setupHandlers</code>. Map out these interactions for deeper understanding.</li>
<li><strong>Transport Channel Study</strong>: Investigate the <code class="inline-code">StdioServerTransport</code> class used in <code class="inline-code">run</code> to see how ancient data flows within modern systems!</li>
<li><strong>Ritual Protection</strong>: Analyze how signals like <code class="inline-code">SIGINT</code> are intercepted to avoid abrupt server failure‚Äîan effective safeguard.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the ancient repository.</p>
<p>Hark, seeker of ancient wisdom, thou hast ascended the sacred Pillars of Quest Generation, and with this triumph, thy journey through the temple&#39;s luminescence shines at 20% completion‚Äîforge ahead, for the stars favor thy resolve! ‚ö°üó∫Ô∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>