<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Ritual Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Repository Chronicles: Secrets of the Ancient Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Ritual Tools</h1>
<hr>
<p>Among the ruins of the Sacred Repository, you uncover a chamber filled with scrolls and inscriptions describing ancient tools used to transform knowledge into artifacts of immense power. These Ritual Tools, complex yet elegant in design, served as conduits for adventurers to navigate the labyrinth of wisdom. To unlock their secrets, you must delve into the Repository&#39;s ceremonial code constructs, tracing their paths from initiation to execution. In doing so, you unravel how these tools bring forth creation in the digital domain.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Patterns</strong>: How does the system dynamically identify and validate tools for execution?  </li>
<li>‚ö° <strong>Command Lifecycle</strong>: In what way does the <code class="inline-code">run</code> method establish the Ritual Tools‚Äô operational sequence, and what role does pre-generation play?  </li>
<li>üõ°Ô∏è <strong>Error Handling Rites</strong>: How are failures in tool execution managed, and where are validation errors most prominently addressed?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Ritual Tool Execution Framework</h3>
<p>This file is the core server responsible for coordinating the Ritual Tools. It handles client requests, maps those requests to tools, validates input schemas, and ensures the seamless operation of the Sacred Repository. The code reveals dynamic mechanics for handling multiple tools, rigorous input validation utilizing schemas, and the server‚Äôs lifecycle from initialization to graceful shutdown.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Facilitates invocation of Ritual Tools by setting up handlers for listing tools dynamically and executing them based on defined schemas.  </li>
<li><code class="inline-code">run</code>: Establishes the server&#39;s operational flow, starting transports and pre-warming the Sacred Repository‚Äôs cache for enhanced performance.  </li>
<li><code class="inline-code">main</code>: Configures the lifecycle rituals, ensuring graceful shutdown and recovery mechanisms during unforeseen interruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools ensuring modularity ‚Äì tools are listed and validated against their schemas.  </li>
<li>Uses Zod for schema validation, guaranteeing parameter rigor before invoking handlers.  </li>
<li>Implements error-handling rituals with <code class="inline-code">McpError</code>, categorized into distinct codes for precise fault identification.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Activates transport mechanisms for external tool communication.  </li>
<li>Executes a pre-generation ritual to cache repository content, reducing latency during operations.  </li>
<li>Integrates error logging for smoother debugging without hindering runtime performance.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li><code class="inline-code">gracefulShutdown</code> ensures orderly termination rituals, preserving system integrity during interruptions.  </li>
<li>Prevents crashes from unhandled rejections by logging critical faults for further investigation.  </li>
<li>Establishes robust initialization rites for the MCP server lifecycle.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Ritual Tool Registry</h3>
<p>This file exposes the available Ritual Tools, enabling adventurers to interact with them seamlessly. Each tool is thoughtfully orchestrated, offering specialized utilities to navigate the Sacred Repository.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates the repository analysis process, priming adventurers to embark on their journeys.  </li>
<li><code class="inline-code">choose_theme.handler</code>: Guides users in selecting ancient motifs that shape quests.  </li>
<li><code class="inline-code">explore_quest.handler</code>: Enables adventurers to uncover specific mysteries within pre-designed narratives.  </li>
<li><code class="inline-code">view_progress.handler</code>: Visualizes ritual completions and pending tasks.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Clearly defines exportable Ritual Tools, allowing modular integration with MCP server operations.  </li>
<li>Promotes maintainability with organized separation of utilities.  </li>
<li>Bridges the ceremonial framework with tangible quest pathways for adventurers.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Compiles all Ritual Tools into a unified registry for streamlined management within services.  </li>
<li>Encapsulates tools with descriptive identifiers aligned to their roles in the repository rites.  </li>
<li>Simplifies MCP client interactions through centralized access.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore the connection between tool handlers and schemas to fully grasp their invocation mechanics.  </li>
<li>Investigate error management to understand how invalid input is ritualistically handled.  </li>
<li>Test the pre-generation caching system to appreciate its impact on quest navigation performance.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom, for thou hast unearthed the sacred Ritual Tools, illuminating thy path toward divine mastery‚Äîpress onward, for the stars themselves bear witness to thy triumph! ‚ö°‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>