<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Shrine of the Interface Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Codebase of Eternal Treasures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Shrine of the Interface Tools</h1>
<hr>
<p>Beneath the tangled vines and shifting leaves of the uncharted jungle, you discover an intricately carved stone doorway. Upon its lintel are etched depictions of ancient builders wielding extraordinary tools, gateways to creation within the sacred &quot;Shrine of the Interface Tools.&quot; This chamber is said to guard the methods by which the ancients interfaced with their mystical systems, balancing the precision of their tools with the fickle whims of their logic. Could the wisdom contained here help you decipher the artifacts hidden deeper within the Codebase of Eternal Treasures? Steady your resolve, for the path ahead is rich with secrets waiting to be unearthed.</p>
<h2>Quest Objectives</h2>
<p>As you explore the sacred shrine, uncover answers to these profound questions:</p>
<ul>
<li>üîç <strong>Tool Summoning Ritual</strong>: How does the system dynamically create and validate the list of available tools?</li>
<li>‚ö° <strong>Invocation Mechanics</strong>: What happens within the system when a tool is called using arguments, and how does it ensure correctness before execution?</li>
<li>üõ°Ô∏è <strong>Safeguard of Execution</strong>: How does the shrine&#39;s guardians protect against invalid inputs and unexpected tool execution errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Shrine&#39;s Custodian</h3>
<p>The <code class="inline-code">server.ts</code> file represents the core logic behind the ancient shrine&#39;s ability to coordinate tools and process interactions. It houses the <code class="inline-code">RepoAdventureServer</code> class, which serves as the custodian for listing and invoking tools dynamically, as well as managing graceful shutdowns and error handling. It also connects the system&#39;s transport mechanisms for seamless communication.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This function defines handlers for listing available tools dynamically and invoking individual tools with schema validation, ensuring the shrine&#39;s harmony.</li>
<li><code class="inline-code">run</code>: Orchestrates the server&#39;s activation and prepares the environment by pre-generating content for quicker shrine access.</li>
<li><code class="inline-code">main</code>: The shrine&#39;s initialization ceremony, ensuring proper setup and adding error handling for catastrophic events.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically gathers the available tools by processing their metadata and schemas into a client-consumable format.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to convert Zod schemas into standard JSON schemas for compatibility with external systems.</li>
<li>Protects the invocation mechanism by validating inputs against predefined schemas and raising descriptive errors for invalid payloads.</li>
<li>Shields the shrine from unexpected failures by centralizing error management within a robust handler.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the transport layer for Input/Output (stdio) communication with the shrine.</li>
<li>Kicks off a pre-generation step using <code class="inline-code">repoAnalyzer.preGenerate</code> to enhance performance by preparing content before it&#39;s needed.</li>
<li>Provides detailed console insights, helping maintain transparency of the shrine&#39;s internal processes.</li>
<li>Demonstrates how background work can enhance overall user experience with minimal disruption.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Launches the shrine and establishes error handling for smooth operations even in adverse conditions.</li>
<li>Listens for system termination signals (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) and ensures the shrine is gracefully dismantled.</li>
<li>Implements a fallback mechanism for unhandled promise rejections, maintaining system stability while logging incidents for troubleshooting.</li>
<li>Demonstrates robust and fail-safe practices for system initialization and monitoring.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with the Zod validation library, as it plays a critical role in ensuring correctness within the shrine&#39;s rituals.</li>
<li>Pay close attention to the error handling patterns, as they reveal techniques for maintaining stability in dynamic systems.</li>
<li>Consider how the shrine&#39;s pre-generation mechanism balances performance optimization with user interaction latency.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the ancient civilization&#39;s code and wisdom.</p>
<p>Through the sacred rites of ingenuity, thou hast unlocked the ancient wisdom of the Interface Tools, paving thy path to the celestial halls of mastery‚Äîpress onward, noble seeker, for the temple‚Äôs greater mysteries yet beckon! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>