<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Temple of HTML Relics - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Secrets of the Lost Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Temple of HTML Relics</h1>
<hr>
<p>Legend speaks of the Temple of HTML Relics, a sacred place where the fragments of wisdom once crafted by ancient codemasters await discovery. Situated within a jungle lush with untamed creativity, the temple contains an intricate mechanism that transforms these relics into narratives of adventure. Brave wanderers must face the temple&#39;s riddles and harness its relics to unearth the secrets of generating dynamic quests and exploration frameworks. Beware‚Äîthe ancient systems demand precise alignment of their code and structure, lest chaos ensue.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Ritual of Tool Invocation</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register tools and ensure their validity?</li>
<li>‚ö° <strong>Activation Ceremony</strong>: What initiation process does <code class="inline-code">run</code> follow to establish the MCP server, and why is pre-generating repomix content essential?</li>
<li>üõ°Ô∏è <strong>Path of Error Containment</strong>: How does the <code class="inline-code">main</code> function handle errors and ensure a graceful shutdown across edge cases and unexpected failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Establishing the Rituals of Adventure</h3>
<p>This file serves as the entryway to the sacred MCP server, where ancient mechanisms execute interactive storytelling frameworks. It constructs the server environment, binds tool handlers dynamically based on the repository&#39;s configuration, and safeguards server integrity through detailed error handling. The <code class="inline-code">RepoAdventureServer</code> class acts as the guiding architect, integrating tools with validation schemas while embracing the jungle&#39;s uncertainty via fallback mechanisms. Embedded in its initiation ceremony, the file also initiates repomix cache pre-generation‚Äîa preparatory ritual for efficient quest delivery.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This method dynamically lists tools from <code class="inline-code">tools.js</code> with metadata for their schemas using <code class="inline-code">zodToJsonSchema</code>. It also handles invocation requests, ensures validation of parameters, and executes tool-specific operations.</li>
<li><code class="inline-code">run</code>: Orchestrates the connection of the MCP server via <code class="inline-code">StdioServerTransport</code>, kickstarts repomix content caching for the project&#39;s directory, and prepares the server for runtime.</li>
<li><code class="inline-code">main</code>: Initializes the MCP server ritual, handles signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for graceful shutdowns, and logs unhandled promise rejections without interrupting server operation.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
        const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
            name,
            description: tool.description,
            inputSchema: zodToJsonSchema(tool.schema, { target: &#39;jsonSchema7&#39;, $refStrategy: &#39;none&#39; })
        }));
        return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
        try {
            const { name, arguments: args } = request.params;

            if (!(name in tools)) {
                throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
            }

            const tool = tools[name as keyof typeof tools];
            const validationResult = tool.schema.safeParse(args);
            if (!validationResult.success) {
                const errorMessages = validationResult.error.issues.map((err) =&gt; 
                    `${err.path.join(&#39;.&#39;)}: ${err.message}`
                ).join(&#39;, &#39;);
                throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
            }
            return await tool.handler(validationResult.data as any);
        } catch (error) {
            if (error instanceof McpError) {
                throw error;
            }
            throw new McpError(
                ErrorCode.InternalError,
                `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
            );
        }
    });
}
</code></pre>
<ul>
<li>Ensures dynamic listing of tools with metadata using Zod schema transformations for JSON.</li>
<li>Validates input arguments before invoking handlers, guarding against invalid requests and ambiguities.</li>
<li>Implements targeted error handling using custom error codes for both user and system-caused failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initiates the MCP server transport mechanism with <code class="inline-code">StdioServerTransport</code>, ensuring compatibility and efficiency.</li>
<li>Generates repomix cache as a preparatory measure to reduce latency during interactive quests.</li>
<li>Establishes environmental readiness for dynamic storytelling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
            process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
            console.error(&#39;Unhandled promise rejection:&#39;, reason);
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Handles OS termination signals to ensure the server cleans up and exits gracefully.</li>
<li>Logs and analyzes unhandled promise rejections without disrupting normal operations.</li>
<li>Encapsulates the MCP server initialization and shutdown procedures for robust management.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Codex of Ritual Tools</h3>
<p>This file is the sacred codex containing all tools for navigating quests and themes. It organizes tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>, binding their handlers to specific rituals within the Temple of HTML Relics. This structured approach enables explorers to proceed systematically, guided by the codebase&#39;s dynamic wisdom.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the project&#39;s codebase, enabling users to begin their journey through tailored themes.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates narrative frameworks bespoke to the user&#39;s chosen theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Enables navigators to delve into specific quests within the Repository of Ages.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides completion stats and tracks remaining quests, ensuring adventurers progress steadily.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
export const start_adventure = startAdventure;

// Export all tools for easy registration
export const tools = {
    start_adventure,
    choose_theme,
    explore_quest,
    view_progress
};
</code></pre>
<ul>
<li>Maps MCP tools into a unified structure for accessible registration by the server.</li>
<li>Streamlines tool organization and ensures alignment with interactive storytelling workflows.</li>
<li>Enables dynamic association of handlers with tool-specific execution models.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <code class="inline-code">zodToJsonSchema</code> is utilized for validation schemas to avoid request ambiguities.</li>
<li>Observe the caching strategy in <code class="inline-code">run</code> for its role in enhancing quest delivery performance.</li>
<li>Study the error management techniques, especially in <code class="inline-code">main</code>, to handle complex scenarios gracefully.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the sacred flame of wisdom, thou hast unearthed the ancient relics of HTML and ascended through the hallowed halls of the Temple‚Äîlet thy triumph light the path to glory with steadfast resolve! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>