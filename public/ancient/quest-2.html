<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Pyramid of Narrative Crafting - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Codex: Adventures in the Repository of Lost Wisdom</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Pyramid of Narrative Crafting</h1>
<hr>
<p>Ancient pathways twist and turn through the labyrinthine Repository of Lost Wisdom, leading you deeper into the temple. You find yourself at the foot of the fabled Pyramid of Narrative Crafting. Engraved on the pyramid&#39;s surface are intricate glyphs pulsating with light, promising the secrets of dynamic quest generation. As shadows play tricks on your eyes, an ethereal voice whispers, &quot;Decode the layers of narrative creation to shape the adventures of tomorrow.&quot; Your path is illuminated ‚Äì climb the pyramid and unveil its mysteries.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Crafting Clarity</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> organize and generate the adventure setup using project context and theme?  </li>
<li>‚ö° <strong>Quest Execution Mechanism</strong>: What steps does <code class="inline-code">AdventureManager.exploreQuest</code> perform to identify, validate, and execute a chosen quest?  </li>
<li>üõ°Ô∏è <strong>LLM Invocation</strong>: How does <code class="inline-code">StoryGenerator.generateQuestContent</code> utilize the LLM and manage its outputs in the quest context?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Responsible for managing the overarching adventure lifecycle, including initialization, quest selection, and execution.</h3>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Establishes the full adventure context, integrating quests and overarching story with provided project details and themes.</li>
<li><code class="inline-code">exploreQuest</code>: Processes user inputs to identify, validate, and execute specific quests, even handling cached content for revisited quests.</li>
<li><code class="inline-code">executeQuest</code>: Executes a given quest, fetches or generates content as needed, and caches results for efficient reuse.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = typeof storyResponse.story === &#39;string&#39; ? storyResponse.story : storyResponse.story.content;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Establishes the adventure&#39;s context by resetting the state and incorporating project, theme, and optional configs.</li>
<li>Employs LLM-powered generation (<code class="inline-code">StoryGenerator</code>) to dynamically create the narrative and quest structure.</li>
<li>Integrates external inputs like <code class="inline-code">adventure.config.json</code> to ensure adaptability in quest configuration and file inclusion.</li>
<li>Returns formatted adventure content with quest listings, preparing the user for exploration.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates and sanitizes user-provided choices to ensure input integrity.</li>
<li>Detects both progress-view requests and specific quest selections through <code class="inline-code">validateAndSanitizeChoice</code> and <code class="inline-code">findQuest</code>.</li>
<li>Provides a fallback mechanism for invalid inputs, returning choices for correction.</li>
<li>Centralizes exploration logic while delegating to <code class="inline-code">executeQuest</code> for task-specific operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async executeQuest(quest: Quest): Promise&lt;AdventureResult&gt; {
  // Validate prerequisites
  this.validateQuestPrerequisites();

  let content: QuestContent;
  let summary: string;

  // Check if quest content is already cached (completed quest)
  const cached = this.state.questContentCache.get(quest.id);
  if (cached) {
    // Use cached content - no LLM calls needed  
    console.log(`üîÑ Retrieving completed quest from cache...`);
    
    // Add a small delay to make the loading feel more natural
    await new Promise(resolve =&gt; setTimeout(resolve, 500));
    
    content = cached.content;
    summary = cached.summary;
    
    // Add visual indicator that this is cached content
    content = {
      ...content,
      adventure: `üîÑ **[REVISITING COMPLETED QUEST]**\n\n${content.adventure}`
    };
  } else {
    // Generate new quest content (LLM call)
    console.log(`üéØ Generating new content for quest: ${quest.title}`);
    content = await this.generateQuestContent(quest);
    
    // Generate completion summary (LLM call)
    summary = await this.generateCompletionSummary(quest);
    
    // Cache the content for future access
    this.state.questContentCache.set(quest.id, { content, summary });
  }
  
  // Mark as completed (or update completion if revisiting)
  this.markQuestCompleted(quest);

  // Return formatted result
  return this.createQuestResult(content, summary);
}
</code></pre>
<ul>
<li>Manages LLM-backed quest execution while avoiding redundant calls with efficient caching mechanisms.</li>
<li>Ensures robust validation by verifying prerequisites and checks like <code class="inline-code">validateQuestPrerequisites</code>.</li>
<li>Differentiates between new and revisited quests, enriching user experience with unique handling for each.</li>
<li>Creates structured results combining content and progress updates, completing the exploration cycle.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üó∫Ô∏è Use <code class="inline-code">adventure.config.json</code> as a blueprint for aligning quests with project files.</li>
<li>üß© Notice how caching minimizes re-computation, revealing insights into performance optimization.</li>
<li>‚úçÔ∏è Observe how LLM responses transform narratives dynamically, aiding adaptable system design.</li>
</ul>
<hr>
<p><strong>Tremendous wisdom lies uncovered at the pyramid&#39;s peak, adventurer! Proceed to unravel the next secret of the Repository.</strong></p>
<p>O seeker of wisdom, thou hast ascended the sacred Pyramid of Narrative Crafting and unlocked its ancient lore‚Äîmay thy storytelling journey shine eternal like the jeweled stars above! ‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>