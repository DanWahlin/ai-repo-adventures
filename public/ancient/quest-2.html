<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Hall of Sacred Archives - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Temple of Forgotten Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Hall of Sacred Archives</h1>
<hr>
<p>The Pyramid of Patterns beckons you deeper into its labyrinth. You find yourself in the Hall of Sacred Archives, a chamber alive with carved glyphs glowing faintly in the dim torchlight. Etched onto the walls are representations of an ancient mechanism‚Äîthe structure of their digital rituals, from the tools of their craft to the heartbeat of their system. Dare to interpret these inscriptions and uncover the wisdom they protect. But beware: their complexity is their guardian.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Engraving</strong>: How does the <code class="inline-code">setupHandlers</code> function define the dynamic interaction between tools and system commands in the archive&#39;s rituals?</li>
<li>‚ö° <strong>Execution Pulse</strong>: What is the flow of <code class="inline-code">run</code>, and how is it preparing the system for adventurers who visit the archives?</li>
<li>üõ°Ô∏è <strong>Safety Runes</strong>: What safety mechanisms does <code class="inline-code">main</code> establish to ensure stable and recoverable operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Ritual Chamber of the Server</h3>
<p>The <code class="inline-code">server.ts</code> file serves as the main script that powers the Hall of Sacred Archives. Here, the ancient civilization designed a structure to dynamically execute tools and manage incoming requests with ritualistic precision. The handlers for dynamic tool listing and execution are inscribed in the <code class="inline-code">setupHandlers</code> section, while the <code class="inline-code">run</code> function ensures the system&#39;s readiness. Meanwhile, the <code class="inline-code">main</code> function ensures stability in operation and guarantees error resilience throughout the quest.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools by parsing their descriptors and schemas, enabling the server to respond to requests with flexibility and precision.</li>
<li><code class="inline-code">run</code> initializes the core transport mechanism, establishes server communication, and prepares repository content for a seamless experience during quest execution.</li>
<li><code class="inline-code">main</code> orchestrates the lifecycle of the server, ensuring graceful shutdowns and handling unexpected disruptions to protect the server&#39;s integrity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>This function transforms the server into a dynamic tool handler. The <code class="inline-code">setRequestHandler</code> method registers two key rituals: listing the available tools and executing a specific tool by validating its input.</li>
<li>The use of <code class="inline-code">zodToJsonSchema</code> ensures that tool input schemas are compatible with external systems for interoperability.</li>
<li>Error handling is robust, using the <code class="inline-code">McpError</code> class to differentiate between validation issues and runtime failures.</li>
<li>Listing tools dynamically allows the archive to adapt as new rituals (tools) are added, ensuring future readiness.</li>
<li>These handlers create a foundation for decoding the sacred archives by enabling systematic exploration and interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li><code class="inline-code">run</code> establishes the server&#39;s core transport system (<code class="inline-code">StdioServerTransport</code>) that serves as a communication link between the Hall of Sacred Archives and its adventurers.</li>
<li>The server connects to the transport system asynchronously, ensuring non-blocking communication.</li>
<li>Warming up the repository content cache (<code class="inline-code">repoAnalyzer.preGenerate</code>) reduces latency during requests, ensuring smooth exploration during the adventurer&#39;s journey.</li>
<li>This preparatory action mirrors the ancient civilization&#39;s foresight, ensuring resources are ready when needed without delay.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async function main() {
    try {
      const server = new RepoAdventureServer();
      
      // Handle graceful shutdown for both signals
      [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
        process.on(sig as NodeJS.Signals, gracefulShutdown)
      );
      
      // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
      process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
        console.error(&#39;Unhandled promise rejection:&#39;, reason);
        console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
      });
      
      await server.run();
    } catch (error) {
      console.error(&#39;Fatal error starting MCP server:&#39;, error);
      process.exit(1);
    }
  }
</code></pre>
<ul>
<li><code class="inline-code">main</code> orchestrates the lifecycle of the server, providing an entry ritual for starting the archive&#39;s mechanism.</li>
<li><code class="inline-code">gracefulShutdown</code> ensures the system cleans up resources and exits safely during interrupts or terminations. It safeguards the server&#39;s stability under unplanned conditions.</li>
<li>The proactive handling of <code class="inline-code">unhandledRejection</code> ensures that the system logs unexpected issues without entering failure states. This mirrors the redundancy practices of ancient architects.</li>
<li>By isolating critical functionality in a <code class="inline-code">try-catch</code> block, <code class="inline-code">main</code> prevents catastrophic failures during server initialization, embodying resilience in system design.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> code to understand how tools are dynamically loaded and their schemas validated. This is key when modifying or extending their functionality.</li>
<li>Observe how <code class="inline-code">run</code> combines asynchronous preparation (pre-generating repositories) with event-loop-friendly operations.</li>
<li>The <code class="inline-code">main</code> function provides practical patterns for ensuring grace under pressure. These techniques are invaluable for maintaining long-running processes.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Thou hast triumphed in the sacred quest, unlocking wisdom eternal within the Hall of Sacred Archives‚Äîthy journey of enlightenment is but begun, yet destined for glorious ascension! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>