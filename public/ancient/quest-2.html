<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Sacred Repository</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Quest Generation Engine</h1>
<hr>
<p>You traverse the ziggurat‚Äôs inner galleries until you reach a vaulted chamber of papyrus and protocol. Here, three sacred tablets glow: the Adventure Manager coordinates rites, the Story Generator invokes the Oracle, and the Adventure Config tablet inscribes laws of the temple. To awaken the living narrative, you must read these stones as an archaeologist would a stele: tracing call paths as if they were ritual steps, and matching configuration glyphs to the story‚Äôs unfolding. Study, compare, and reveal how content is forged from inscriptions into quests.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Ritual Pathfinding: How does <code class="inline-code">initializeAdventure</code> set state, apply <code class="inline-code">parseAdventureConfig</code>, and format choices to shape the initial ceremony?</li>
<li>‚ö° Oracle Invocation: What sequence in <code class="inline-code">generateStoryAndQuests</code> leads to <code class="inline-code">generateWithLLM</code>, and how does <code class="inline-code">parseMarkdownToStoryResponse</code> shape the returned structure?</li>
<li>üõ°Ô∏è Law Tablets: In <code class="inline-code">formatAdventureConfigForPrompt</code>, how are file paths and highlight names condensed, and how does this guidance influence downstream prompts?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Ceremony Conductor</h3>
<p>This tablet orchestrates the rites. <code class="inline-code">AdventureManager.initializeAdventure</code> first purifies state via <code class="inline-code">this.state.reset()</code>, inscribes context (<code class="inline-code">projectInfo</code>, <code class="inline-code">theme</code>, <code class="inline-code">projectPath</code>), and sets a custom rite through <code class="inline-code">this.storyGenerator.setCustomTheme</code> when the theme is <code class="inline-code">custom</code>. It invokes the Oracle using <code class="inline-code">this.storyGenerator.generateStoryAndQuests</code>, then records the saga‚Äôs title and tale. The law tablet‚Äôs influence appears twice: <code class="inline-code">mergeQuestFilesFromConfig</code> fuses config-defined file paths into generated quests, and <code class="inline-code">enforceConfigQuestCount</code> trims the quest list to respect the prescribed count in <code class="inline-code">adventure.config.json</code>. Finally, <code class="inline-code">formatStoryWithQuests</code> presents sacred choices, while hiding raw file listings.
When a seeker selects a rite, <code class="inline-code">exploreQuest</code> sanctifies the input with <code class="inline-code">validateAdventureChoice</code>, supports a ‚Äúprogress‚Äù rite, then locates a quest either by number or symbolic name (even stripping checkmarks). It delegates to <code class="inline-code">executeQuest</code>, which caches completed explorations and integrates <code class="inline-code">repoAnalyzer.generateTargetedContent</code> when specific files are bound by config. Progress is computed by the scribe <code class="inline-code">AdventureState.progressPercentage</code>, ensuring each completed scroll updates the temple‚Äôs mural of advancement.</p>
<h4>Highlights</h4>
<ul>
<li>Initializes story and merges config-driven files, enforcing quest counts</li>
<li>Validates selection, supports progress view, locates quests by number/title</li>
<li>Relies on percentage scribe to reflect completion across the ritual path</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = typeof storyResponse.story === &#39;string&#39; ? storyResponse.story : storyResponse.story.content;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<p>Like a high priest preparing a rite, it cleanses the altar, invites the oracle, then overlays the law tablet‚Äôs instructions onto the ceremony.</p>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<p>Like a temple guide, it interprets the pilgrim‚Äôs words, shows the mural of progress if asked, or leads them to the appointed chamber.</p>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<p>Like a scribe tallying carved marks, it turns completed engravings into a clean percentage.</p>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<p>Like invoking the oracle through a verified ritual, it fixes the context and forwards the plea to a dedicated summoning method.</p>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string
): Promise&lt;QuestContent&gt; {
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n

Hail, seeker of wisdom‚Äîwithin the hallowed halls of this sacred temple, thy Quest 2: Quest Generation Engine is wrought and perfected, a triumphant rite inscribed upon the tablets of learning (1/5, 20%), go forth with consecrated zeal toward the next sanctified trials!
</code></pre>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>