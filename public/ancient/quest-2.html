<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Obelisks of Knowledge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Seekers of the Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Obelisks of Knowledge</h1>
<hr>
<p>In the sacred jungles of Codexia, you stumble upon towering structures of enigmatic design‚Äîthe Obelisks of Knowledge. These relics hum faintly with energy, radiating the wisdom of ancient code architects. Inscribed in cryptic patterns across their surfaces lies guidance for deciphering the Codebase. Your path is clear: you must awaken the obelisks by understanding their hidden mechanisms and unraveling the secrets locked within their towering forms.</p>
<p>The journey promises trials of interpretation, validation, and execution. Are you prepared to confront the wisdom of old and uncover the functions at the core of the Codebase&#39;s intricate design?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Invocation Rituals</strong>: How is the dynamic setup of tools and handlers managed within the sacred core of the server?</li>
<li>‚ö° <strong>Obelisk Awakening</strong>: What is the process that governs the activation and runtime flow of the server, and how do tools contribute to quests?</li>
<li>üõ°Ô∏è <strong>Ward of Protection</strong>: What error-handling mechanisms ensure safety during tool execution, and how does the server recover from missteps?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Core Obelisk</h3>
<p>This file houses the foundational <code class="inline-code">RepoAdventureServer</code> class as well as the <code class="inline-code">main</code> entry point, serving as the heart of the MCP server. Here, vital rituals for dynamic tool registration (<code class="inline-code">setupHandlers</code>) and server activation (<code class="inline-code">run</code>) are performed. These methods transform the server into a conduit for quest exploration, ensuring tools are validated, executed securely, and made available dynamically.</p>
<p>Key highlights explore dynamic tool invocation and error handling as cornerstones of safe and efficient code repository exploration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the dynamic scaffolding for tools, validating inputs and mapping patterns for quests.</li>
<li><code class="inline-code">run</code>: Powers the server&#39;s activation sequence, including background preparation for efficient exploration.</li>
<li><code class="inline-code">main</code>: The entry point for initializing the server while safeguarding operations with robust shutdown and error recovery protocols.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Establishes dynamic tool listing and execution pipelines, enabling modular tool integration and validation.</li>
<li>Implements input schema validation using Zod, safeguarding inputs while adhering to ancient coding standards.</li>
<li>Ensures robust error handling, distinguishing between known and unknown errors for clarity and security.</li>
<li>Lays the groundwork for decoupled tools, facilitating extensibility of adventures.</li>
<li>Highlights the critical reliance on <code class="inline-code">tools</code> exported from <code class="inline-code">tools.js</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Activates the server, connecting it to the transport layer for communication using standard I/O streams.</li>
<li>Implements pre-generation caching via <code class="inline-code">repoAnalyzer.preGenerate</code>, optimizing the exploration process.</li>
<li>Uses asynchronous patterns to ensure server readiness without blocking further execution.</li>
<li>Details deliberate choices in using <code class="inline-code">process.cwd()</code> to dynamically identify the current project path.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes and launches the server, while safeguarding against termination signals via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Addresses unhandled promise rejections and logs them, ensuring continued stability during runtime.</li>
<li>Employs defensive programming by wrapping the entire operation in a <code class="inline-code">try-catch</code> block to handle fatal errors gracefully.</li>
<li>Reinforces robust system design with modular shutdown processes and clear error messaging.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Tools Repository</h3>
<p>This file acts as the repository of tools‚Äîmechanisms for interacting with and exploring the Codebase&#39;s layers. Defined tools such as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and <code class="inline-code">explore_quest</code> are organized and exported for integration into the server&#39;s tool system. Each tool encapsulates a unique aspect of the ancient artifacts&#39; power.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Engages the initial analysis of the code repository, setting the stage for further exploration.</li>
<li><code class="inline-code">choose_theme.handler</code>: Facilitates the selection of a thematic lens, shaping subsequent quest generation.</li>
<li><code class="inline-code">explore_quest.handler</code>: Drives the exploration of individual quests, enabling archaeologists to delve deeper.</li>
<li><code class="inline-code">view_progress.handler</code>: Monitors adventurers‚Äô progress, ensuring alignment with overall objectives.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Re-exports key tools under MCP naming conventions for clarity and user accessibility.</li>
<li>Centralizes tool definitions for consistent registration in the server&#39;s dynamic system.</li>
<li>Facilitates seamless integration between new tools and the existing tool infrastructure through modular design.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Trace the Rituals</strong>: Follow the flow of how tools are dynamically listed, validated, and executed through the <code class="inline-code">setupHandlers</code> function.</li>
<li><strong>Map the Terrain</strong>: Observe how tools interact with the server foundation in <code class="inline-code">run</code> to ensure smooth execution.</li>
<li><strong>Secure Safe Passage</strong>: Study the use of Zod validation and error-handling strategies to protect against invalid inputs and runtime errors.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in the Codebase&#39;s sprawling maze of wisdom.</p>
<p>Hail, seeker of wisdom, for thou hast ascended the sacred steps of the Obelisks of Knowledge, unlocking the first gateway to enlightenment‚Äîmay thy journey continue bold and illumined as the stars above! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>