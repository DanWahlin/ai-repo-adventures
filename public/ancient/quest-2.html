<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Ceremonial Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Chronicles of the Sacred Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Ceremonial Nexus</h1>
<hr>
<p>In a shadowed corridor beneath the pyramid‚Äôs apex, a thin beam of sunlight pierces the gloom, illuminating a room filled with antiquated mechanisms and a labyrinth of glowing glyphs. This is the Ceremonial Nexus, a sacred juncture where the Codexian Scribes performed their most intricate rituals. These carvings speak of tools designed for collaboration within the repository of knowledge‚Äîartifacts that bring automation and exploration to life. In this chamber, your mission is to decipher the functions of the MCP Tool Interface and the systems it powers.  </p>
<p>Adventure awaits, explorer. Unlock the bonds of ancient automation!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Tool Invocation Rites</strong>: How does the MCP server dynamically list tools and validate requests for their usage inside the sacred interface?  </li>
<li>‚ö° <strong>Execution Flow of the Nexus</strong>: What happens from the moment the MCP server initializes to when it connects clients and runs critical operations?  </li>
<li>üõ°Ô∏è <strong>Error Defense Mechanisms</strong>: How does the server protect against invalid input, unknown tools, and unexpected failures during tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Core of the Ceremonial Interface</h3>
<p>This file defines the ancient <code class="inline-code">RepoAdventureServer</code>, which governs the MCP utility framework. Here, you will uncover the methods responsible for listing available tools, handling tool invocation requests, and lifecycle management for the MCP server. It employs schemas to validate inputs and outputs, ensuring reliable usage of tools‚Äîlike ancient glyphs requiring the right incantation to unlock their potential.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This method dynamically lists all tools available in the repository and ensures that input parameter validation is strict and schema-bound.  </li>
<li><code class="inline-code">run</code>: Orchestrates server initialization, connects transports, and warms up project-specific caches for an optimized experience.  </li>
<li><code class="inline-code">main</code>: The entry point of the server ritual, ensures structured shutdowns and recovery from unhandled failures.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<ul>
<li>Ensures all tools can be dynamically discovered and listed by invoking <code class="inline-code">zodToJsonSchema</code>, which bridges tool schemas into a readable JSON format.  </li>
<li>Input validations are performed robustly using Zod schemas, an essential safeguard against invalid or malformed tool requests.  </li>
<li>A structured fallback mechanism is employed through <code class="inline-code">McpError</code>, ensuring invalid inputs or execution failures are systematically addressed under proper codes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes MCP server transport via <code class="inline-code">StdioServerTransport</code>, illustrating how server communication is piped for external tool interaction.  </li>
<li>Implements a project-specific cache to optimize tool performance, powered by an asynchronous <code class="inline-code">repoAnalyzer.preGenerate</code>.  </li>
<li>Logs significant milestones, providing visibility into server activation and readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
          // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Acts as a sentinel of operational continuity with signal detection for planned shutdowns (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).  </li>
<li>Captures unhandled promise rejections to mitigate silent failures, maintaining server availability wherever recoverable.  </li>
<li>Provides structured execution flow, where <code class="inline-code">RepoAdventureServer</code> instantiation and running occur together with lifecycle handling.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Glyph Vault</h3>
<p>This file centralizes the repository‚Äôs revered tools, each representing an interactive capability for repo analysis. It is the single point of organization for tool declarations and reveals their purpose, schemas, and handlers.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates codebase analysis to create the foundation of exploratory quests.  </li>
<li><code class="inline-code">choose_theme.handler</code>: Powers theme-based customization for user engagement.  </li>
<li><code class="inline-code">explore_quest.handler</code>: Drives exploration of specific system functionalities, layering thematic curiosity with technical insight.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;

export const start_adventure = startAdventure.handler;
</code></pre>
<ul>
<li>Declares the handler that begins the exploration ritual, guiding interactions with user-selected codebases. This connects the MCP client to its primary purpose: discovery.</li>
</ul>
<hr>
<pre><code class="language-typescript">import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;

export const choose_theme = chooseTheme.handler;
</code></pre>
<ul>
<li>Encapsulates thematic definition and invokes the thematic construction API. This is essential for curating unique user experiences.</li>
</ul>
<hr>
<pre><code class="language-typescript">import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;

export const explore_quest = exploreQuest.handler;
</code></pre>
<ul>
<li>Orchestrates an interaction layer for users to navigate system functionalities directly. Serves as the primary vector for progress tracking.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Approach the <code class="inline-code">setupHandlers</code> function as the central binding of the ceremonial interface, linking tool definitions to runtime workflows.  </li>
<li>Trace the invocation pathways of <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and <code class="inline-code">explore_quest</code> to discern their integration points within the server‚Äôs flow.  </li>
<li>Expand deeper into tool schemas to better appreciate Zod‚Äôs role in command validation.</li>
</ul>
<h2>Completion Message</h2>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the sacred Ceremonial Nexus conquered and wisdom etched upon your scrolls, thou stand as a herald of ancient triumph‚Äîforge onward, seeker of divine enlightenment! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>