<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Pyramid of Technical Wonders - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Codex of Lost Civilizations</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Pyramid of Technical Wonders</h1>
<hr>
<p>In the heart of a desert where scorching sands conceal innumerable secrets, you discover a grand pyramid rising from the dunes. This is no ordinary structure‚Äîit is the Pyramid of Technical Wonders. Within its labyrinthine chambers, whispers echo of a long-lost system that once breathed life into vast repositories of knowledge. The writings on the inner walls mention the &quot;MCP Tool Interface&quot;, a mechanism of unparalleled sophistication that binds tools to the will of the adventurer. Your task is clear: decode the mysteries of this ancient system and reclaim its wisdom for the &quot;Framework of Infinite Journeys.&quot;</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Binding Mechanism Inquiry</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register tools, and what patterns are used for validation?</li>
<li>‚ö° <strong>Toolflow Analysis</strong>: What is the role of the <code class="inline-code">run</code> function in initializing and connecting the MCP server, and how does it optimize tool readiness?</li>
<li>üõ°Ô∏è <strong>Master Control Safety</strong>: How does the <code class="inline-code">main</code> function manage graceful shutdowns and mitigate potential server disruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Tool Handlers</h3>
<p>This file details the inner workings of the <code class="inline-code">RepoAdventureServer</code>, a pivotal system within the MCP architecture. The sacred structure describes how the MCP server registers tools, handles input validation, and initializes its connection to user interfaces through <code class="inline-code">StdioServerTransport</code>. A masterpiece of ancient design, it reveals patterns for controlling complexity and ensuring stability during operations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> configures the dynamic registration of tools, validating input against schemas and linking tool functionality to accessible endpoints. This ensures modularity and compliance with server protocols.</li>
<li><code class="inline-code">run</code> orchestrates the MCP server&#39;s startup, establishes the transport layer, and initializes background systems like <code class="inline-code">repoAnalyzer</code> to improve performance during runtime.</li>
<li><code class="inline-code">main</code> serves as the focal point for initializing the server and ensuring graceful shutdown in case of errors or external signals, embodying robust error mitigation practices.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tool metadata (name, schema, and description) from the <code class="inline-code">tools</code> collection into the server for tool discovery.</li>
<li>Generates JSON schemas for tools using <code class="inline-code">zod-to-json-schema</code>, ensuring compatibility with validation standards.</li>
<li>Executes registered tools dynamically by validating arguments and calling their respective handlers, enhancing modularity and extensibility.</li>
<li>Implements structured error handling with <code class="inline-code">McpError</code> to distinguish between invalid parameters and execution failures.</li>
<li>Promotes robustness through schema-driven validation, preventing invalid or malformed input.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes communication between the MCP server and clients through <code class="inline-code">StdioServerTransport</code>, supporting robust interaction.</li>
<li>Logs critical server status updates to the console, keeping users informed about the system&#39;s readiness.</li>
<li>Pre-generates <code class="inline-code">repomix</code> content for the current working directory, creating a warm cache for optimized subsequent tool executions.</li>
<li>Leverages asynchronous patterns (<code class="inline-code">async/await</code>) for non-blocking initialization, ensuring seamless operation.</li>
<li>Demonstrates forward-thinking design by integrating performance optimization within the startup flow.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the MCP server, orchestrating its creation and runtime configuration.</li>
<li>Captures <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> signals to ensure a graceful shutdown workflow, preventing disruption or resource leaks.</li>
<li>Establishes a handler for unhandled promise rejections, encouraging error reporting without jeopardizing runtime stability.</li>
<li>Logs error messages for unforeseen critical failures, allowing post-mortem debugging and system analysis.</li>
<li>Exemplifies comprehensive lifecycle management with mechanisms to start, operate, and safely terminate the server.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore the relationship between <code class="inline-code">tools</code> and the MCP server&#39;s dynamic nature to understand how modularity is maintained.</li>
<li>Investigate the <code class="inline-code">StdioServerTransport</code> to uncover how it enables seamless interaction between the server and its clients.</li>
<li>Pay special attention to error-handling patterns, which balance system reliability with user experience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hark, valiant seeker of wisdom, thou hast triumphed within the sacred Pyramid of Technical Wonders, illuminating its arcane secrets with the brilliance of thy intellect‚Äîonward now, to further quests and eternal renown! üöÄ‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>