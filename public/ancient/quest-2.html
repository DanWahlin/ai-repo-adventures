<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Forging the Threads of Story - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Secrets of the Lost Codebase</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Forging the Threads of Story</h1>
<hr>
<p>Your journey continues deeper into the towering &quot;Temple of Lost Logic,&quot; where the whispers of ancient computation grow louder. Before you lies the heart of the temple - a sacred hall adorned with shimmering glyphs etched into its metallic walls. These glyphs are the blueprints of the story itself, a script so intricate it can weave both purpose and chaos. Here, you must decipher the &quot;Threads of Story&quot; - a sacred ritual to generate the paths of adventure and bind them to the laws of their digital domain. The task ahead is rigorous, but the reward - the power to forge narratives and illuminate the machine‚Äôs purpose - will be invaluable.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Threads of Initialization</strong>: How does <code class="inline-code">initializeAdventure</code> structure the process of generating story and quests in the <code class="inline-code">AdventureManager</code>?</li>
<li>‚ö° <strong>Binding the Narrative</strong>: In the <code class="inline-code">generateStoryAndQuests</code> function of the <code class="inline-code">StoryGenerator</code>, what patterns guide the interaction between the Machine Oracle (LLM) and the quest&#39;s configuration files?</li>
<li>üõ°Ô∏è <strong>Reliquaries of Configuration</strong>: What mechanisms ensure the adventure configuration, as seen in the <code class="inline-code">parseAdventureConfig</code> function, is validated and its data safely extracted to support dynamic storytelling?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Hearth of Adventure Management</h3>
<p>This file holds the core <code class="inline-code">AdventureManager</code> class, responsible for preparing and executing adventures using a structured state machine, quest execution logic, and validation frameworks.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Prepares the adventure by resetting the state, generating quests with the story generator, and integrating configuration into the quest generation process.</li>
<li><code class="inline-code">exploreQuest</code>: Guides the user through the selection and execution of quests, handling choices with validation and execution caching.</li>
<li><code class="inline-code">progressPercentage</code>: A dynamic visual measure of the user‚Äôs progress through the adventure.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Serves as the main entry point for adventure generation by integrating project data, themes, and dynamic configuration.</li>
<li>Organizes the story output and modularizes preprocessors like <code class="inline-code">mergeQuestFilesFromConfig</code> to incorporate external configurations.</li>
<li>Ensures flexibility by supporting themes, customizations, and input validation for safe integration with other systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Implements the user navigation logic to handle quest selection, providing resilience against invalid or malformed inputs.</li>
<li>Integrates caching through <code class="inline-code">executeQuest</code> to optimize repeated operations and reduce redundant LLM-generation calls.</li>
<li>Strong validation logic supports both dynamic and thematic user input.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Offers a user-friendly progress representation, dynamically updated based on the number of completed quests.</li>
<li>Uses clean and efficient calculations to improve the readability and maintainability of state information.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> The Fabricator of Tales</h3>
<p>This file implements the <code class="inline-code">StoryGenerator</code>, a critical component that interfaces with the Machine Oracle (LLM) to extract dynamic storytelling elements and create quests that align with the given configuration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Orchestrates LLM calls for story and quest generation, ensuring proper context and fallback measures.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Processes and validates intricate Markdown responses into structured story objects.</li>
<li><code class="inline-code">generateQuestContent</code>: Crafts detailed quest content by processing codebase data with rich contextual prompts.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Coordinates the generation of thematic stories and quests by seamlessly integrating project metadata, themes, and the configuration stored in relevant files.</li>
<li>Ensures the theme validity with fallback mechanisms ensuring robust user experiences.</li>
<li>Establishes a key entry point for LLM interactions to bootstrap story elements.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);
  
  let title = &#39;&#39;;
  let story = &#39;&#39;;
  const quests: Quest[] = [];
  
  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};
  let titleFound = false;
  
  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      if (token.depth === 1) {
        title = token.text;
        titleFound = true;
        currentSection = &#39;story&#39;; // Assume content after H1 is story content
      } else if (token.depth === 3 &amp;&amp; (currentSection === &#39;quests&#39; || currentSection === &#39;adventures&#39;)) {
        // Save previous quest if exists
        if (currentQuest.title &amp;&amp; currentQuest.description) {
          quests.push({
            id: `quest-${quests.length + 1}`,
            title: currentQuest.title,
            description: currentQuest.description,
            codeFiles: currentQuest.codeFiles || []
          });
        }
        currentQuest = { title: token.text, description: &#39;&#39;, codeFiles: [] };
      }
    } else if (token.type === &#39;paragraph&#39; &amp;&amp; currentQuest.title) {
      currentQuest.description += token.text + &#39;\n\n&#39;;
    }
  }
  
  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push({
      id: `quest-${quests.length + 1}`,
      title: currentQuest.title,
      description: currentQuest.description.trim(),
      codeFiles: currentQuest.codeFiles || []
    });
  }
  
  return { title, story, quests };
}
</code></pre>
<ul>
<li>Provides a systematic way to tokenize and structure detailed Markdown responses, ensuring all narratives and quests are coherently integrated.</li>
<li>Converts unstructured LLM responses into structured objects, allowing downstream systems to access quest details effectively.</li>
<li>Ensures graceful handling of incomplete or malformed input through validation checks.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content...&#39;;

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST })
  );

  let cleanContent = response.content.trim();
  if (cleanContent.startsWith(&#39;```markdown&#39;)) {
    cleanContent = cleanContent.replace(/^```markdown\s*/, &#39;&#39;).replace(/\s*```$/, &#39;&#39;);
  }
  
  return {
    adventure: cleanContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Uses contextual prompts to craft precise and interactive quest content.</li>
<li>Applies strict response validation and formatting to ensure content integrity.</li>
<li>Directly links quest content to the user&#39;s selected narrative theme for immersive and targeted storytelling.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> The Keeper of Configured Relics</h3>
<p>This file governs the adventure configuration system, ensuring all artifacts follow the rules defined in their configuration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Handles the safe parsing and validation of <code class="inline-code">adventure.config.json</code>, a vital source of external data.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Dynamically identifies and filters unique file paths referenced by the configuration for efficient file exploration.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Converts configuration details into concise, LLM-optimized text for guiding quest generation.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Safeguards against malformed input by wrapping JSON parsing with robust error handling.</li>
<li>Centralizes the responsibility for loading and validating external configuration files.</li>
<li>Establishes strong guarantees that upstream systems receive only validated data.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (typeof node.path === &#39;string&#39; &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path.trim()))) {
      unique.add(node.path.trim());
    }
    const children = Array.isArray(node) ? node : Object.values(node);
    stack.push(...children);
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Combines abstraction and meticulous validation to dynamically extract useful file paths from adventure configuration.</li>
<li>Enhances code exploration efficiency by narrowing the focus to only referenced files.</li>
<li>Ensures compatibility with nested JSON structures for versatility.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  return adventure.quests.map(q =&gt; `### ${q.title}\nFiles: ${q.files.map(f =&gt; f.path).join(&#39;, &#39;)}`).join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Compresses and formats configuration data to optimize interaction with LLMs.</li>
<li>Eliminates redundant details, ensuring prompt-text limits are respected without losing critical information.</li>
<li>Designed with simplicity to reduce debugging needs and increase transparency.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Consider how themes shape the quest structure and uncover why some design patterns emphasize modularization.</li>
<li>Pay close attention to functions that handle JSON and Markdown validation to see how the risks of user-provided data are mitigated.</li>
<li>Use comments to trace the flow of configuration data from its source to the generated quest content.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Through thy sacred endeavor, thou hast woven the fateful strands of narrative, ascending one-fifth the celestial staircase toward enlightenment‚Äîmay thy path remain radiant with the wisdom of ancients! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>