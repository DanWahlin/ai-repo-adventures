<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Pyramid of Ancient Interfaces - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Secrets of the Lost Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Pyramid of Ancient Interfaces</h1>
<hr>
<p>The dense jungle canopy trembles as you descend deeper into the forgotten heart of civilization. Before you looms a towering pyramid, etched with glyphs and symbols of wisdom. This is the Pyramid of Ancient Interfaces, the locus where the fractured components of a ritualistic system first converge. Scholars believe the interface within governed the ‚Äúsacred tools,‚Äù encoded pathways that connected the Codex Templi to the stories it could tell. Your task is clear: venture inside, decode how these interfaces once interacted, and illuminate the hidden wisdom that lies within.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Interface Cartography</strong>: How does the <code class="inline-code">RepoAdventureServer</code> manage and validate interactions with external tools?</li>
<li>‚ö° <strong>Lifecycle Engineering</strong>: What initialization patterns are implemented within <code class="inline-code">RepoAdventureServer.run</code> to optimize tool availability and performance?</li>
<li>üõ°Ô∏è <strong>Ritual Fail-Safe</strong>: How does the <code class="inline-code">main</code> function handle unexpected disruptions or shutdowns during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core structure of the interactive storytelling server</h3>
<p>The <code class="inline-code">server.ts</code> file houses the foundation of the Repo Adventure MCP server, a gamified interface designed to link tools with user-driven exploration. The file contains key constructs that define how tools are listed, validated, and executed within the sacred repository ecosystem. Additionally, it ensures that errors are handled gracefully, minimizing interruptions to the journey.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic tool registration and execution flows using schemas for validation and execution safety.</li>
<li><code class="inline-code">run</code>: Initializes the server, connects to the transport layer, and triggers background processes such as cache pre-generation.</li>
<li><code class="inline-code">main</code>: Orchestrates the server lifecycle, handling graceful shutdowns and ensuring robust error-handling mechanisms.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<ul>
<li>Establishes schemas for dynamic tool listing and execution, aligning validation with tool requirements.</li>
<li>Incorporates error codes (<code class="inline-code">McpError</code>) to provide meaningful feedback on invalid tool execution or syntax.</li>
<li>Strengthens the interface against malformed requests by validating input using Zod schemas.</li>
<li>Handles misspecified tools gracefully while maintaining predictable server behavior.</li>
<li>Enables new tools to be seamlessly incorporated through the dynamic mapping.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server to a standardized I/O transport bridge, allowing seamless communication.</li>
<li>Enhances performance with asynchronous pre-generation of analysis data via <code class="inline-code">repoAnalyzer</code>.</li>
<li>Demonstrates modular server design through clear setup and execution stages.</li>
<li>Logs server initialization details to aid in system debugging and monitoring.</li>
<li>Provides an efficient starting point for further functionality customization.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
          // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Implements safety structures for sudden shutdown signals with a <code class="inline-code">gracefulShutdown</code> handler.</li>
<li>Ensures stability by monitoring for unhandled <code class="inline-code">Promise</code> rejections during runtime.</li>
<li>Logs fatal initialization errors and terminates cleanly on failure.</li>
<li>Encapsulates foundational lifecycle management logic, connecting setup and execution phases.</li>
<li>Models best practices for preserving the integrity of dependent services under duress.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to the use of Zod schemas for validation - these are the core of the tool interface system.</li>
<li>Curious about dynamic tool execution? Follow the request handlers to see how tool operations map back to <code class="inline-code">tools</code> definitions.</li>
<li>Take inspiration from the robust error-handling patterns to design resilient application interfaces.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of sacred knowledge, for thou hast triumphed in the Pyramid of Ancient Interfaces, etching thy wisdom upon the stars as the first holy stone in thy journey‚Äôs altar shines brightly!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>