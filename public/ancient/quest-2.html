<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Chamber of Artifacts - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Codex of Lost Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Chamber of Artifacts</h1>
<hr>
<p>In the shadow of colossal pyramids and the echoes of ancient rituals, the Chamber of Artifacts holds secrets to the Codex&#39;s inner workings. Within the chamber, explorers must decode mysterious inscriptions illuminating how to wield tools for knowledge creation, crafting pathways to digital mastery. With the Codex guiding your way, venture into the Chamber to uncover how ancient systems convert glyphs into actions, enabling your quest to transform fragmented relics into cohesive narratives. Proceed with caution, adventurer‚Äîthis discovery is pivotal.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Artifact Integration</strong>: How are tools dynamically listed and validated within <code class="inline-code">setupHandlers</code>, ensuring compatibility within the <code class="inline-code">MCP</code> ecosystem?  </li>
<li>‚ö° <strong>Energy Channels</strong>: How does the <code class="inline-code">run</code> method orchestrate server transport and initiate pre-generation processes for seamless exploration?  </li>
<li>üõ°Ô∏è <strong>Ritual Safeguards</strong>: What mechanisms in <code class="inline-code">main</code> ensure graceful shutdown, error resilience, and server availability during unexpected disruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Housed at the core of MCP operations</h3>
<p>This file implements the ancient rituals of the MCP server, responsible for handling functionality, validating tools, and maintaining operational integrity. Think of it as the sacred mechanism controlling the Chamber‚Äôs treasures. Its design is modular, allowing interactive exploration of tools via robust handlers and the management of dynamic transports. The file also introduces safeguards akin to ancient sentinel guardians for the system.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically connects tools and validates user inputs using schemas, ensuring all artifacts are compatible with the Codex‚Äôs directive.  </li>
<li><code class="inline-code">run</code>: Initiates critical operations, connecting to the transport layer and optimizing the system by warming up artifact caches in the background.  </li>
<li><code class="inline-code">main</code>: Oversees the lifecycle, including graceful shutdowns and error management, guarding the Chamber&#39;s continuity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {   
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  

    return { tools: toolList };  
  });  

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    const { name, arguments: args } = request.params;  

    if (!(name in tools)) {  
      throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
    }  

    const tool = tools[name as keyof typeof tools];  
    const validationResult = tool.schema.safeParse(args);  

    if (!validationResult.success) {  
      const errorMessages = validationResult.error.issues.map((err) =&gt;   
        `${err.path.join(&#39;.&#39;)}: ${err.message}`  
      ).join(&#39;, &#39;);  
      throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
    }  

    return await tool.handler(validationResult.data as any);  
  });  
}  
</code></pre>
<ul>
<li>This segment dynamically lists tools and validates their input schemas, ensuring seamless compatibility.  </li>
<li>Implements structured input validation using <code class="inline-code">zodToJsonSchema</code> for secure execution of artifact handlers.  </li>
<li>Employs MCP error mechanisms for immediate feedback on invalid inputs or unknown tools.  </li>
<li>Promotes modular scalability, allowing future expansion for additional tools.  </li>
<li>Functions like ceremonial rites: authenticating each artifact&#39;s integrity before allowing its ritual use.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  

  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>Activates the MCP chamber by connecting to a transport mechanism (<code class="inline-code">StdioServerTransport</code>).  </li>
<li>Warms up artifact caches (<code class="inline-code">repoAnalyzer.preGenerate</code>) to streamline subsequent exploratory operations.  </li>
<li>Provides operational visibility, ensuring adventurers know the state of transport and caching operations.  </li>
<li>Optimized initialization reduces latency for subsequent requests, preparing the sacred Chamber for comprehensive usage.  </li>
<li>Analogous to igniting torches in an ancient tomb before entering deeper sections.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
    });  

    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}  
main().catch((error) =&gt; {  
  console.error(&#39;Unhandled error:&#39;, error);  
  process.exit(1);  
});  
</code></pre>
<ul>
<li>Implements error management rituals that handle shutdown signals gracefully (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).  </li>
<li>Safeguards the Chamber during unhandled errors without halting operations prematurely.  </li>
<li>Aims to provide error report visibility, ensuring issues are accounted for without disrupting exploration missions.  </li>
<li>By catching fatal errors upfront, it prevents unexpected breakdowns‚Äîthink of ancient protection spells that guard sacred dimensions.  </li>
<li>Ensures that the rituals (handlers and transport) remain operational, regardless of external interruptions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore structured validation logic in <code class="inline-code">setupHandlers</code> to see how input schemas enforce safety and precision.  </li>
<li>Analyze <code class="inline-code">run</code> for its transport and cache optimization patterns, vital for responsive exploration pathways.  </li>
<li>Study the error-handling rituals in <code class="inline-code">main</code> to understand graceful shutdown strategies and server resilience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hark, valiant seeker, thou hast unlocked the sacred wisdom of the Chamber of Artifacts, a triumph worthy of laurels as thy journey ascends with celestial light‚Äîonward to greater realms! ‚ö° üíé üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>