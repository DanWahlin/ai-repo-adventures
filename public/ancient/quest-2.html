<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Scribes of the Inner Library - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of the Repository Pyramid</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h2>Quest 2: Scribes of the Inner Library</h2>
<p>Beneath the pyramid‚Äôs worn lintel, torchlight dances over engraved runes that mirror TypeScript glyphs. You step into the Inner Library, where scrolls hum with procedural lore. The scribes whisper of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a>, a steward that convenes explorers and tallies progress, and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a>, a loremaster that consults the oracle and fashions quests from analyzed codices. As dust settles, tablets reveal configuration marks entwined with narrative current, ensuring every rite aligns with carved parameters. Study their craft, seeker, and the archive will yield structured treasure.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Rune Alignment: How does <code class="inline-code">initializeAdventure</code> merge quest files from configuration while enforcing a count that matches carvings in <code class="inline-code">adventure.config.json</code>?</li>
<li>‚ö° Ritual Invocation Flow: When a traveler calls <code class="inline-code">exploreQuest</code>, how does control flow identify the target quest and decide between cached inscriptions and freshly summoned content?</li>
<li>üõ°Ô∏è Guardian Seals: What validation and timeout patterns in <code class="inline-code">generateStoryAndQuests</code> and <code class="inline-code">generateQuestContent</code> ensure safe, bounded consultations with the oracle client?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The expedition steward orchestrating story setup, quest selection, and progress record</h3>
<p>In this chamber, <code class="inline-code">AdventureManager</code> presides over expedition rites, backed by an <code class="inline-code">AdventureState</code> ledger. The rite of <code class="inline-code">initializeAdventure</code> clears previous sands, sets the current theme and project path, then invokes the storyteller to draft a new saga. It binds configured file paths onto generated quests via <code class="inline-code">mergeQuestFilesFromConfig</code>, and trims the quest list through <code class="inline-code">enforceConfigQuestCount</code> to honor the stone tablet‚Äôs limits. When an explorer presents a choice, <code class="inline-code">exploreQuest</code> sanitizes the inscription using <code class="inline-code">validateAdventureChoice</code>, interprets progress requests, and locates the matching quest by number, id, or title through helper seekers. Execution then flows to <code class="inline-code">executeQuest</code>, which validates preconditions, checks the cache, and either retrieves preserved parchment or summons fresh content and a completion summary. The steward marks completion and formats results alongside available choices, with <code class="inline-code">progressPercentage</code> reflecting how many tablets have been deciphered. Notice how targeted content generation consults <code class="inline-code">repoAnalyzer.generateTargetedContent</code> when quests specify <code class="inline-code">codeFiles</code>, otherwise it falls back to the broader repomix chronicle. These rituals ensure each journey is both faithful to configuration glyphs and responsive to the traveler‚Äôs chosen path.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code> establishes the expedition, delegates story creation to the storyteller, merges config-bound files into quests, and enforces the stone-set count‚Äîcrucial for aligning narrative with archive directives.</li>
<li><code class="inline-code">exploreQuest</code> validates inscriptions, interprets progress invocations, locates the intended quest, and channels the flow into execution‚Äîvital for consistent traveler experience.</li>
<li><code class="inline-code">generateQuestContent</code> gathers targeted code context or falls back to the grand chronicle, then requests thematic content from the storyteller‚Äîkey to producing precise, file-aware exploration rites.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Orchestrates the initial rite: resets state, sets theme and paths, and optionally installs <code class="inline-code">customThemeData</code>.</li>
<li>Delegates story and quest generation to the storyteller, then merges and truncates quests using configuration glyphs.</li>
<li>Keeps narrative and choices aligned by formatting the final presentation via <code class="inline-code">formatStoryWithQuests</code>.</li>
<li>Enforces archive authority through <code class="inline-code">mergeQuestFilesFromConfig</code> and <code class="inline-code">enforceConfigQuestCount</code>, binding generated content to stone-carved limits.</li>
<li>Ensures consistent starting conditions across journeys.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Treats the traveler‚Äôs inscription as a sacred input, sanitized by <code class="inline-code">validateAdventureChoice</code>.</li>
<li>Differentiates between a plea for progress and a quest selection using <code class="inline-code">isProgressRequest</code>.</li>
<li>Resolves the quest via number or name/id, guarding mis-selections with a not-found inscription.</li>
<li>Channels control into <code class="inline-code">executeQuest</code>, unifying flow for cached and new content retrieval.</li>
<li>Provides a single entry point for quest invocation clarity.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;
  
  // Use targeted content if quest has specific files, otherwise use full repomix content
  if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0 &amp;&amp; this.state.projectPath) {
    try {
      console.log(`üéØ Generating targeted content for ${quest.codeFiles.length} files`);
      codeContent = await repoAnalyzer.generateTargetedContent(
        this.state.projectPath,
        quest.codeFiles,
        false  // Use uncompressed content for detailed quest exploration
      );
    } catch (error) {
      console.warn(`Failed to generate targeted content, falling back to full repomix content:`, error);
      codeContent = this.state.projectInfo!.repomixContent;
    }
  } else {
    // Fallback to full repomix content
    codeContent = this.state.projectInfo!.repomixContent;
  }

  // Calculate quest position for completion message guidance
  const questPosition = this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1;
  const totalQuests = this.state.quests.length;

  return await this.storyGenerator.generateQuestContent(
    quest,
    this.state.currentTheme!,
    codeContent,
    questPosition,
    totalQuests
  );
}
</code></pre>
<ul>
<li>Assembles the scholarly corpus for the quest: targeted files when available, otherwise the grand repomix manuscript.</li>
<li>Guards against analysis failures by falling back gracefully, preserving the ritual‚Äôs continuity.</li>
<li>Computes positional context to inform completion inscriptions, anchoring feedback in journey progress.</li>
<li>Delegates final narrative weaving to the storyteller using the chosen theme and gathered code content.</li>
<li>Emphasizes resilience and precision in content gathering.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Entrusts the storyteller with project and path context, normalizing the theme via <code class="inline-code">validateTheme</code>.</li>
<li>Defers the heavy lifting to <code class="inline-code">generateWithLLM</code>, centralizing oracle consultation and parsing.</li>
<li>Establishes internal fields for consistent follow-up quest generation.</li>
<li>Ensures that the saga reflects allowed thematic customs before querying the oracle.</li>
<li>Maintains a narrow, focused surface for initial saga summoning.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n

Hail, seeker of wisdom‚Äîby inscribing the sacred tablets of Quest 2: Scribes of the Inner Library, thou hast carved the first fifth of thy odyssey (20%) upon the temple‚Äôs ledger, and the sanctum‚Äôs torches blaze in triumph to honor thy learned ascension‚Äîpress onward to further sanctify thy path, adept of the inner lore!
</code></pre>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>