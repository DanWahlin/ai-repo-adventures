<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Sacred Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Pyramid of Lost Codes</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Sacred Tool Interface</h1>
<hr>
<p>Centuries ago, when the Pyramid of Lost Codes was first conceived, its builders embedded mystical interfaces believed to control the flow of knowledge within. These sacred tools were locked behind layers of encoded logic, guarded by ancient mechanisms capable of adapting to any seeker‚Äôs ritual. Your task is set: examine the inscriptions and scripts that allow the tools to interact with the heart of the repository. These tools are your keys to unlocking the pyramid‚Äôs treasures‚Äîif you can decipher their purpose and invoke their power.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Invocation Ritual</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically register tools, and what practices safeguard their input configurations during invocation?</li>
<li>‚ö° <strong>Navigator&#39;s Flow</strong>: What is the process initiated by <code class="inline-code">RepoAdventureServer.run</code>, and how does background preprocessing prepare the pyramid‚Äôs repository map?</li>
<li>üõ°Ô∏è <strong>Guardian&#39;s Protocol</strong>: How does error handling in <code class="inline-code">main</code> ensure the stability and continuation of sacred operations during unforeseen interruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Rituals of the Interface</h3>
<p>The <code class="inline-code">server.ts</code> file is the cornerstone of the sacred tool interactions within the Pyramid of Lost Codes. It houses the mechanisms by which tools are assigned purpose and activated within the repository exploration framework. The <code class="inline-code">RepoAdventureServer</code>&#39;s methods serve as mystical handlers to access and orchestrate various tools. Particularly, the inner <code class="inline-code">setupHandlers</code> method provides dynamic tool registration, ensuring proper validation through schemas. Additionally, the <code class="inline-code">run</code> method establishes communication between the user and the pyramid‚Äôs core, initializing preprocessing tasks that unveil the repository‚Äôs treasures. Finally, the <code class="inline-code">main</code> function safeguards these operations via a protocol against disruptive errors, ensuring adventurers remain steadfast on their journey into the depths of the code.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically and validates incoming inputs using schemas to ensure accurate invocation rituals, preventing errors in interactions.</li>
<li><code class="inline-code">run</code>: Initializes sacred communication and prepares the pyramid‚Äôs repository map through preprocessing, enhancing adventurers‚Äô navigation during their quest.</li>
<li><code class="inline-code">main</code>: Ensures the stability of sacred operations with error-handling protocols during disruptions, preserving the continuity of the exploration.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
        const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
            name,
            description: tool.description,
            inputSchema: zodToJsonSchema(tool.schema, { 
                target: &#39;jsonSchema7&#39;,
                $refStrategy: &#39;none&#39;
            })
        }));

        return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
        try {
            const { name, arguments: args } = request.params;

            if (!(name in tools)) {
                throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
            }

            const tool = tools[name as keyof typeof tools];
            const validationResult = tool.schema.safeParse(args);

            if (!validationResult.success) {
                const errorMessages = validationResult.error.issues.map((err) =&gt; 
                    `${err.path.join(&#39;.&#39;)}: ${err.message}`
                ).join(&#39;, &#39;);
                throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
            }

            return await tool.handler(validationResult.data as any);
        } catch (error) {
            if (error instanceof McpError) {
                throw error;
            }
            throw new McpError(
                ErrorCode.InternalError,
                `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
            );
        }
    });
}
</code></pre>
<ul>
<li>Dynamically maps tools into the sacred interface, creating a repository of their capabilities for adventurers.</li>
<li>Validates invocation arguments using schemas, ensuring rituals adhere to structural rules and avoid missteps.</li>
<li>Leverages error handling to differentiate between invalid input mistakes and fatal execution errors, preserving system integrity.</li>
<li>Ensures tools are only registered if available, pinpointing failure pathways to protect the interface‚Äôs stability.</li>
<li>Uses dynamic mapping patterns to streamline tool registration and validation processes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server communication through a sacred ritual, linking the interface to its user.</li>
<li>Utilizes preprocessing via <code class="inline-code">repoAnalyzer.preGenerate</code> to create paths to repository artifacts, aiding adventurers during quests.</li>
<li>Background caching mechanisms enhance responsiveness and support seamless navigation even during heavy exploration tasks.</li>
<li>Activates tools in real-time, allowing adventurers to interact with the sacred knowledge while preparing hidden treasures.</li>
<li>Anchors operations with environmental awareness using <code class="inline-code">process.cwd</code>, reflecting the pyramid‚Äôs adaptability to varying repository terrain.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
            process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
            console.error(&#39;Unhandled promise rejection:&#39;, reason);
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Sets up protocols for graceful shutdown, ensuring the pyramid‚Äôs mechanisms persist without fatal interruptions.</li>
<li>Captures unhandled promise rejections to report them while allowing system operations to continue‚Äîpreserving progress even in unsafe conditions.</li>
<li>Uses centralized error handling to identify fatal issues during initialization, ensuring adventurers are warned of critical failures.</li>
<li>Allows dynamic signal-based shutdown, mimicking rituals to ensure the pyramid resets gracefully if interrupted.</li>
<li>Ensures operational readiness regardless of unforeseen errors, making the repository expedition reliable and resilient to disruptions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To fully grasp tool registration rituals, examine how schemas are mapped in <code class="inline-code">tools.ts</code> for alignment between assets and handlers.</li>
<li>Exploring the <code class="inline-code">repoAnalyzer</code> processing aids in understanding how content generation contributes to smooth navigational workflows.</li>
<li>Error handling within <code class="inline-code">main</code> is key to preserving expedition stability and should be studied as a safeguard for larger systems.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hallowed be thy triumph, seeker of wisdom, for thy dominion over &quot;The Sacred Tool Interface&quot; marks the first victorious step in the celestial odyssey toward the ancient quintet of enlightenment‚Äîmarch onward beneath the eternal gaze of the temple stars! ‚≠êüöÄüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>