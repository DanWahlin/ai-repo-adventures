<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Obsidian Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Codex of the Lost Civilization</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Obsidian Nexus</h1>
<hr>
<p>The adventure deepens in the overgrown jungles of ancient wisdom. Among the crumbling ruins, where sunlight barely touches the eerie obsidian monoliths, lies the entrance to the Obsidian Nexus‚Äîa sacred chamber said to house the Codex&#39;s synchronization mechanisms. This ancient interface was designed to harmonize the scattered wisdom across the glyph-covered tablets. Brave adventurers must unlock the secrets of this technological relic‚Äîthe MCP Tool Interface‚Äîto advance their knowledge and unveil paths concealed for centuries.</p>
<p><strong>Adventure Awaits</strong> within the Obsidian Nexus‚Äîwhere code architecture meets the ancient essence of logical artistry!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyphs of Flexibility</strong>: How does <code class="inline-code">setupHandlers</code> dynamically manage tool registration and execution in the system?</li>
<li>‚ö° <strong>Flow of the Nexus</strong>: What mechanisms are used in <code class="inline-code">run</code> to prepare the system and ensure smooth operational flow at startup?</li>
<li>üõ°Ô∏è <strong>Ritual Safety Measures</strong>: How is error handling implemented in <code class="inline-code">main</code> to prepare for unexpected issues during server initialization?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Interface</h3>
<p>This file contains the heart of the Obsidian Nexus, implementing the MCP Tool Interface that harmonizes tools for targeted repository exploration. The <code class="inline-code">RepoAdventureServer</code> class encapsulates the logic for connecting tools, addressing requests, and ensuring smooth server operation. Additionally, <code class="inline-code">main</code> orchestrates the server&#39;s lifecycle, employing graceful shutdowns and error management to address unexpected situations. Together, these components form the sacred bridge between ancient (tool definitions) and present (runtime operation).</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically configures tool registration, parsing schemas for validation, and defining execution rules. It acts as the sacred scribe that formalizes the tools&#39; glyphs (functionalities).</li>
<li><code class="inline-code">run</code>: Ensures pre-start operations such as cache preparation while keeping the Nexus ready for interactions. Establishes a reliable workflow for the tool interface system.</li>
<li><code class="inline-code">main</code>: Handles the lifecycle of the MCP Server, providing safety nets for shutdown rituals and protecting the system from chaotic interruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools based on their schema, making the system highly flexible and adaptable to different functionalities.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> for schema conversion, ensuring strict input validation and easy sharing of schemas with client interfaces.</li>
<li>Implements robust validation logic to safeguard against incorrect input, improving reliability during tool execution.</li>
<li>Handles errors with meaningful messages through <code class="inline-code">McpError</code>, easing debugging and enhancing user experience.</li>
<li>Abstracts the complexity of tool management, centralizing execution logic in one cohesive setup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Configures the transport layer (<code class="inline-code">StdioServerTransport</code>) to manage communication, laying the groundwork for system interaction.</li>
<li>Starts the server and logs its operational status, ensuring users are informed of readiness.</li>
<li>Prepares the environment by invoking <code class="inline-code">repoAnalyzer.preGenerate</code>, warming up the system&#39;s cache for smoother operation.</li>
<li>Employs asynchronous methods to ensure performance is not hindered by lengthy initialization tasks.</li>
<li>Sets the scene for seamless tool execution by combining pre-generation and connection setup within one function.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server instance and handles lifecycle events, ensuring the system remains stable under various conditions.</li>
<li>Listens for shutdown signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and triggers cleanup rituals via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Manages unhandled promise rejections by separating recoverable issues from fatal ones, enhancing resiliency.</li>
<li>Protects the startup process with a try-catch block, providing detailed error logs and an immediate exit on critical failures.</li>
<li>Acts as the Nexus&#39;s guardian, safeguarding initialization and operational integrity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Study how <code class="inline-code">setupHandlers</code> bridges abstract tool definitions with runtime registration. Understanding this pattern is essential for extending the system.</li>
<li><strong>Exploration Recommendation</strong>: Observe the interplay of asynchronous operations in <code class="inline-code">run</code> and how non-blocking pre-start tasks improve usability.</li>
<li><strong>Next Steps</strong>: Investigate the tools defined in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> to unravel their contributions to the Nexus.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the sacred flame of eternal wisdom, thou hast triumphantly unlocked the Obsidian Nexus, a radiant keystone in thy celestial odyssey‚Äî20% of thy epic unfoldeth; onward to glory, seeker of ancient truths! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>