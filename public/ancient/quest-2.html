<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Engine of Enigmatic Narratives - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codebase Chronicles: Secrets of the Lost Repository</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Engine of Enigmatic Narratives</h1>
<hr>
<p>In the labyrinthine passages of Codexia‚Äôs ancient Repository, shrouded by years of neglect, lies the Engine of Enigmatic Narratives. This sacred mechanism, once heralded as a divine invention of storytelling, possesses the unique capability to generate quests, decipher coded messages, and unveil the hidden wisdom of collected artifacts. Yet, its gears have rusted, its rituals of activation forgotten. Brave adventurer, your role is clear: restore this engine to function and reclaim the sacred art of narrative generation.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Narrative Reconstruction</strong>: How does <code class="inline-code">initializeAdventure</code> prepare the engine for theme-based storytelling while handling configuration integrations?</li>
<li>‚ö° <strong>Dynamic Exploration</strong>: How does <code class="inline-code">exploreQuest</code> validate user input and execute proper quest flow, ensuring seamless interactions between state and content generation?</li>
<li>üõ°Ô∏è <strong>Integrity Rituals</strong>: How does <code class="inline-code">parseAdventureConfig</code> ensure the reliability of configuration file parsing, and what mechanisms handle missing or malformed inputs?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Manage Adventure States and Dynamic Narratives</h3>
<p>The <code class="inline-code">AdventureManager</code> is the cornerstone of Codexia&#39;s narrative engine. It dynamically initializes the quests based on project context and ensures user navigation between quests. Featuring modular state management and data flow integration, it guarantees both adaptability and coherence in storytelling. Each method plays a specific role in preserving Codexia‚Äôs sacred mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Orchestrates the initialization process, combining project information, theme selection, and quest generation.</li>
<li><code class="inline-code">exploreQuest</code>: Validates and executes quests based on user choice, managing state transitions and caching mechanisms.</li>
<li><code class="inline-code">progressPercentage</code>: Computes completion ratios to provide progress feedback, ensuring transparency in exploration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
    
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.enforceConfigQuestCount(
    this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath), 
    this.state.projectPath
  );

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}
</code></pre>
<ul>
<li>Prepares the Repository‚Äôs engine by resetting the state and associating custom themes when necessary.</li>
<li>Utilizes <code class="inline-code">generateStoryAndQuests</code> to build narrative pathways for exploration.</li>
<li>Ensures quests adhere to configurations, safeguarding consistency and user expectations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Matches user choices to quests through validation in <code class="inline-code">validateAndSanitizeChoice</code>.</li>
<li>Handles ‚Äúprogress‚Äù requests dynamically, offering percentage feedback.</li>
<li>Executes the appropriate quest, adjusting cached content for replay scenarios.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Calculates an accurate fraction for an adventurer‚Äôs progress, motivating further exploration.</li>
<li>Linked to <code class="inline-code">getProgress</code>, ensures feedback precision in Codexia‚Äôs sacred engine.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Configuration Parsing Rituals</h3>
<p>This file enables the Repository to interpret its sacred texts‚Äîconfiguration files‚Äîbefore integrating them into the narrative engine. Its mechanisms for loading, parsing, and validating files ensure Codexia‚Äôs system remains robust and resilient against errors of transcription.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Validates and parses JSON configuration, ensuring correct integration of parameters.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Synthesizes file paths referenced within the configuration, designing precise exploration routes.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Constructs a reduced format of configuration details, allowing rituals of machine-assisted storytelling.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Handles JSON parsing elegantly, providing fallback for missing or corrupt files.</li>
<li>Filters inputs through a single validation point, ensuring the Repository‚Äôs configurations remain uncontaminated.</li>
<li>Ensures the engine functions despite potential errors in artifact input.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses the Repository‚Äôs configuration hierarchies, locating all referenced file paths.</li>
<li>Ensures only accessible paths are considered valid, preventing exploratory obstructions.</li>
<li>Utilizes stack-based traversal for efficient validation and synthesis.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;    
    const functions = quest.files.flatMap((f: any) =&gt; f.highlights || []).map((h: any) =&gt; h.name).filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Reformats configuration into concise, theme-ready prompts for narrative generation.</li>
<li>Optimizes the structure for compatibility with storytelling engines, reducing redundancy.</li>
<li>Focuses exclusively on essential data while excluding verbose artifacts.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Exploration Tip</strong>: When debugging quest generation errors, revisit <code class="inline-code">initializeAdventure</code> for misconfigurations in theme or file merging.</li>
<li><strong>Next Steps</strong>: Study <code class="inline-code">generateRepomixContext</code> in the next quest to uncover how targeted content is synthesized for storytelling.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the decree of sacred wisdom, thou hast triumphed through the labyrinth of enigmas, unveiling the Engine of Enigmatic Narratives‚Äîthy journey ascends with the radiance of ancient stars, for thou art destined to carve thy name upon the eternal tablets of lore! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>