<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Pyramid of Insight - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'ancient' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Lost Scrolls of Repoa: Unearthing the Codebound Mysteries</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Pyramid of Insight</h1>
<hr>
<p>As the morning sun pierced the thick canopy of the jungle, you stood on the brink of uncovering the hidden treasures within the Pyramid of Insight. Vines draped over ancient stone steps, and the air was thick with an aura of mystery. Within these hallowed chambers lies a fragment of the Scrolls of Codebound Wisdom‚Äîetched with cryptic guidance and intricate glyphs. The Pyramid is guarded by layers of intricate mechanisms, requiring sharp skills and resolve to traverse. With every step, the secrets of Repoa&#39;s architects grow nearer. Let us descend into the depths of wisdom!</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repomix Integration for Codebase Insight</h3>
<p>This file is the cornerstone of Repoa&#39;s artifact analysis, leveraging the <code class="inline-code">repomix</code> tool to extract meaningful content from codebases. The <code class="inline-code">RepoAnalyzer</code> class stands as the diligent scholar, transforming tangled code repositories into digestible formats for adventurers to interpret. With methods like <code class="inline-code">generateRepomixContext()</code> and <code class="inline-code">generateTargetedContent()</code>, it ensures the adventurer can explore both full and focused segments of the repository. Notably, the tool prioritizes security and efficiency, preventing path traversal and validating input to avoid mishaps. Its design highlights Repoa&#39;s architects&#39; foresight, with a caching mechanism optimizing repeated analyses. In essence, this file bridges the gap between chaotic codebases and structured knowledge, enabling you to decipher the glyphs that guard each quest&#39;s secrets.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext()</code>: Generates comprehensive codebase representations for adventurers.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles()</code>: Ensures secure and valid file handling, mitigating risks like path traversal.</li>
<li><code class="inline-code">captureRepomixStdout()</code>: Orchestrates the execution of <code class="inline-code">repomix</code> as a subprocess and captures meaningful output.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Guiding the Way with Language Models</h3>
<p>This file provides the magic that breathes life into the Pyramid‚Äôs riddles. The <code class="inline-code">LLMClient</code> class connects to various large language models (LLMs), acting as the Oracle of Repoa. Through <code class="inline-code">generateResponse()</code> and provider-specific configurations, such as <code class="inline-code">isAzureOpenAI()</code>, this file translates the ancient Scrolls of Codebound Wisdom into actionable guidance. Handling JSON-based responses and system timeouts ensures that even the most intricate riddles are answered smoothly. The class&#39;s specific design for multi-provider support shows the adaptability of ancient architects, making it a tool suitable for numerous temples and challenges.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse()</code>: Processes inputs and extracts wisdom from LLMs with robust error handling.</li>
<li><code class="inline-code">isAzureOpenAI()</code>: Dynamically configures the client for Azure-hosted models.</li>
<li><code class="inline-code">logDetailedError()</code>: Ensures clarity by meticulously logging errors and debugging details.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">/**
 * Validate and normalize target files for security and reliability
 * Prevents path traversal, ensures files exist, deduplicates, and limits count
 */
private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50; // Reasonable limit to prevent resource exhaustion
  const projectRoot = path.resolve(projectPath);
  
  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES) 
    .map(file =&gt; {
      const trimmed = file.trim();

      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
        console.warn(`Rejecting potentially unsafe file path: ${trimmed}`);
        return null;
      }

      const fullPath = path.resolve(projectPath, file);
      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) {
        console.warn(`Rejecting file outside project directory: ${file}`);
        return null;
      }

      if (!fs.existsSync(fullPath)) {
        console.warn(`Skipping non-existent file: \`${file}\``);
        return null;
      }

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null);

  return safeFiles;
}
</code></pre>
<p>It‚Äôs like a security checkpoint ensuring no unwanted guests get through while organizing the invite list neatly.</p>
<hr>
<pre><code class="language-typescript">/**
 * Generate repomix context for a project
 */
async generateRepomixContext(projectPath: string): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const cacheKey = `${path.resolve(projectPath)}:compressed`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, { compress: true });

  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });

  return context;
}
</code></pre>
<p>Think of this as the great library cataloging new scrolls when they don‚Äôt already exist in the archives.</p>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<p>This is the Oracle deciphering the adventurer‚Äôs question and returning its insights from the divine realms.</p>
<hr>
<pre><code class="language-typescript">/**
 * Format numbers in a friendly way (25000 -&gt; 25K)
 */
function formatTokenCount(tokens: number): string {
  if (tokens &gt;= 1000000) {
    return `${(tokens / 1000000).toFixed(1)}M`;
  }
  if (tokens &gt;= 1000) {
    return `${(tokens / 1000).toFixed(1)}K`;
  }
  return tokens.toString();
}
</code></pre>
<p>It‚Äôs like a scribe abbreviating long names into readable titles to save precious parchment space.</p>
<h2>Helpful Hints</h2>
<ul>
<li>To enhance analysis, focus on how <code class="inline-code">validateAndNormalizeTargetFiles()</code> prevents potential vulnerabilities.</li>
<li>If exploring alternate repositories, customize <code class="inline-code">generateRepomixContext()</code> for specific project types.</li>
<li>Delve deeper into <code class="inline-code">LLMClient</code> features to exploit its detailed logging for debugging potential riddles.</li>
</ul>
<hr>
<p>Behold, seeker of wisdom, you have unlocked another sacred glyph within the Pyramid of Insight‚Äîmay your ascent to the zenith of ancient knowledge be ever triumphant! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Sanctum of Eternal Configur... ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>