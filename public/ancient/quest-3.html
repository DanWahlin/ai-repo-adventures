<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Hall of the Insightful Oracle - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Codex of Computational Enlightenment</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Hall of the Insightful Oracle</h1>
<hr>
<p>In the heart of the ancient Vault of Algorithmia lies a sacred chamber known as the Hall of the Insightful Oracle. Here, wise inscriptions guide adventurers through the mysteries of automated analysis and computational reasoning. You are tasked with deciphering the secrets of the Oracle, leveraging its glyphs to unravel efficient workflows, evaluate code-based queries, and ensure the reliability of repository allegiances. The power of the Sacred Codex will aid you in summoning both precision and clarity.</p>
<p><strong>Tread carefully, adventurer!</strong> The Hall tests not just skill in action but wisdom in understanding.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph of Invocation</strong>: How is the LLM request built and integrated with different configurations, ensuring compatibility across providers?</li>
<li>‚ö° <strong>Token Tally Ritual</strong>: What mechanisms handle token usage tracking and ensure prompt adaptability during LLM requests?</li>
<li>üõ°Ô∏è <strong>Enigma of Validation</strong>: How are project paths and file operations safeguarded to prevent misuse or errors during repository analysis?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: The Insightful Oracle&#39;s Gateway</h3>
<p>The <code class="inline-code">llm-client.ts</code> file equips the system to interface with large language models (LLMs). It embodies the Oracle‚Äôs voice, creating responses and adapting to the constraints of both OpenAI and Azure OpenAI providers. Key features include dynamic configuration management (<code class="inline-code">getApiKey</code>, <code class="inline-code">isAzureOpenAI</code>), error handling, and token usage logging, enabling seamless interactions.</p>
<h4>Highlights</h4>
<ul>
<li><strong><code class="inline-code">LLMClient.constructor</code></strong>: Examines how the client is initialized based on provider and API.</li>
<li><strong><code class="inline-code">LLMClient.generateResponse</code></strong>: Manages response generation, including building requests and processing outputs.</li>
<li><strong><code class="inline-code">LLMClient.getApiKey</code></strong>: Focuses on determining the correct API key for different LLM endpoints.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<p>The constructor ensures the client adapts to the chosen LLM, initializing properties for either OpenAI or Azure OpenAI seamlessly.</p>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<p>This method constructs and executes LLM requests, processing outputs and logging token usage while ensuring robust error handling.</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<p><code class="inline-code">getApiKey</code> determines the access key for LLM providers, ensuring security and compatibility across integrations.</p>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: The Repository Sage</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file represents the Repository Sage, dedicated to extracting structured insights from the codebase. It protects its operations with validation rituals and caching strategies to ensure efficiency and safety. Here, the focus is on preparing data for content generation and ensuring the integrity of all inputs.</p>
<h4>Highlights</h4>
<ul>
<li><strong><code class="inline-code">RepoAnalyzer.validateProjectPath</code></strong>: Validates project paths to ensure no invalid or malicious inputs.</li>
<li><strong><code class="inline-code">RepoAnalyzer.generateTargetedContent</code></strong>: Produces focused content for specific repository files.</li>
<li><strong><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code></strong>: Manages subprocess execution of <code class="inline-code">repomix</code> while safeguarding resources.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<p>This function ensures project paths are valid and free from vulnerabilities such as null byte injections.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
    
  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
    
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);
    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
    return optimizedContent;
  } catch (error) {
    throw new Error(`Targeted content generation failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<p>The function securely generates and caches focused content for specific repository files, improving performance through reuse.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [
      ...directories,
      &#39;--stdout&#39;,
      &#39;--style&#39;, options.style || &#39;markdown&#39;
    ];

    if (options.compress) args.push(&#39;--compress&#39;);
    
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill();
        isResolved = true;
        reject(new Error(`Repomix timed out`));
      }
    }, 5000); // Adjust timeout as needed

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
      stdoutSize += data.length;
      if (stdoutSize &gt; 10_000_000) { // Arbitrary size limit
        repomix.kill();
        reject(new Error(`Output size exceeded`));
      }
    });

    repomix.on(&#39;close&#39;, () =&gt; resolve(stdout));
    repomix.on(&#39;error&#39;, reject);
  });
}
</code></pre>
<p>This subprocess handler ensures <code class="inline-code">repomix</code> operations are tightly controlled, protecting against excessive memory usage or infinite execution.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Examine how configurations adapt to different LLM providers for compatibility insights.</li>
<li>Focus on the structure of request handling to identify reusable patterns.</li>
<li>Investigate how validation rituals avoid malicious input exploitation.</li>
</ul>
<hr>
<p>You sense the Oracle‚Äôs glyphs illuminating‚Äîeach line of your quest has brought clarity! Return soon for more ancient wisdom.</p>
<p>Through the sacred corridors of wisdom&#39;s temple, thou hast unveiled the insights of the venerable Oracle‚Äîtake heart, noble seeker, for thy journey shines like a celestial jewel upon the tapestry of destiny! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>