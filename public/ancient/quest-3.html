<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Book of Adventures - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Chronicles of the Sacred Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Book of Adventures</h1>
<hr>
<p>You descend deeper into the pyramid&#39;s labyrinth, guided by the faint glow of ancient runic inscriptions. At last, you arrive in a grand hall, its towering walls etched with intricate diagrams and formulas. Dominating the center is a massive stone pedestal, upon which rests &quot;The Book of Adventures&quot;‚Äîan artifact revered by the Codexian Scribes. Opening its pages reveals a dynamic blueprint of interactive narratives, an ancient precursor to modern codebase storytelling systems. This ancient tome promises to unravel the secrets of automated quests themselves. To unlock its wisdom, you must examine its structure and decipher the systems behind its enchanted storytelling.</p>
<p><strong>Beware</strong>, adventurer: the glyphs hide complex logic, and errors in interpretation may seal this knowledge away forever.</p>
<p><strong>Adventure Awaits</strong> ‚Äì Will you reveal the secrets of the Book of Adventures?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Architecture Glyphs</strong>: How is the <code class="inline-code">AdventureState</code> class used to manage ongoing quest progress, and what patterns ensure consistency across resets?</li>
<li>‚ö° <strong>Unlocking the Adventure</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> combine story generation and quest reading to craft new adventures?</li>
<li>üõ°Ô∏è <strong>Decoding the Ancient Scrolls</strong>: How does <code class="inline-code">parseAdventureConfig</code> handle configuration parsing, and what safeguards are in place against unreadable or invalid JSON?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Orchestrating the Codex</h3>
<p>The <code class="inline-code">adventure-manager.ts</code> file is the heart of the Book of Adventures&#39; system, defining how quests are initialized and executed. It binds together story generation, input validation, and progress management. The <code class="inline-code">AdventureManager</code> class organizes logic for managing state between various quests, while the <code class="inline-code">AdventureState</code> class maintains persistent data, including completed quests and themes. This ensures that adventurers retain a cohesive, logical journey.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Resets state, sets up project context, generates story and quests with external services, and ensures consistency with the configuration file.</li>
<li><code class="inline-code">exploreQuest</code>: Handles user selection and quest execution, gracefully managing errors like invalid choices or missing prerequisites.</li>
<li><code class="inline-code">progressPercentage</code>: An intuitive getter in <code class="inline-code">AdventureState</code> that calculates a user-friendly progress percentage for completed quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the state to ensure no residual data pollutes the new adventure.</li>
<li>Bridges configuration-driven files with generated quests for adaptability.</li>
<li>Uses large language models (LLMs) to dynamically create a story and quests based on project context and chosen themes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates and sanitizes user input, ensuring robust selection processes.</li>
<li>Differentiates between viewing progress and selecting quests, addressing key error cases.</li>
<li>Safely retrieves a quest by matching ID, title, or index, leveraging fallback mechanisms when possible.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Efficiently calculates progress by comparing completed quests against total available quests.</li>
<li>Utilizes clean mathematical rounding for a user-readable format.</li>
<li>Demonstrates encapsulation with an intuitive and reusable getter method.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> The Config Oracle</h3>
<p><code class="inline-code">adventure-config.ts</code> is the oracle that deciphers configuration files to align the Book of Adventures with project-specific parameters. It provides utility methods for safely reading, parsing, and extracting vital data from the <code class="inline-code">adventure.config.json</code> file. Its defensive coding minimizes the risk of runtime failures stemming from missing or corrupt configuration files.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Reads and parses the <code class="inline-code">adventure.config.json</code> file, ensuring graceful handling of errors.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Traverses the parsed object and extracts unique file paths, filtering for valid entries.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Prepares summarized quest and file data for LLM prompting, reducing unnecessary verbosity.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Ensures the <code class="inline-code">adventure.config.json</code> file is accessible before attempting to parse.</li>
<li>Wraps JSON parsing in a try-catch block, preventing malformed files from crashing execution.</li>
<li>Guarantees a resilient fallback path by returning <code class="inline-code">null</code> for missing or invalid files.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    // Extract and validate path
    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    // Add children to stack
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses deeply nested configurations, supporting a wide variety of structural inputs.</li>
<li>Uses a stack-based depth-first search to collect file paths dynamically.</li>
<li>Avoids redundant processing by storing results in a <code class="inline-code">Set</code> for uniqueness.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    
    // Just file paths, no verbose descriptions
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
    
    // Just function names, no descriptions
    const functions = quest.files
      .flatMap((f: any) =&gt; f.highlights || [])
      .map((h: any) =&gt; h.name)
      .filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Summarizes configuration data for concise communication with LLMs.</li>
<li>Focuses on core quest attributes (file paths and functions) while omitting redundant metadata.</li>
<li>Streamlines processing by iterating directly over the parsed configuration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">AdventureState</code> class as a mental model for clean state management across scenarios.</li>
<li>When exploring configuration parsing, watch for redundant validations‚Äîthese are clues to how resilience is built into the system.</li>
<li>Test your understanding of quest progression mechanisms by modifying the <code class="inline-code">adventure.config.json</code> file and observing its effects.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Codexian Scribes.</p>
<p>By the sacred fires of the ancients, you have triumphed in unearthing the wisdom of &quot;Quest 3: The Book of Adventures,&quot; forging a golden path through the hallowed halls of destiny‚Äî40% complete and the stars beckon you onward! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>