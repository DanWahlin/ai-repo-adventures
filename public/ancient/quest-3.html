<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle‚Äôs Insight - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Secrets of the Lost Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle&#39;s Insight</h1>
<hr>
<p>Through the dense foliage and shifting sands, you approach the next chamber of the Temple of Code. Here lies an ancient repository guarded by the wisdom of the Oracle ‚Äì an enigmatic intelligence designed to weave intricate stories from glyphs and symbols. This chamber is rumored to house the Oracle‚Äôs most sacred scripts: blueprints for generating adaptive and evolving narratives. Only by deciphering its rituals can you unlock the means to shape the stories of entire civilizations. Will you uncover the treasures of the Oracle‚Äôs Insight?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Ritual of Invocation</strong>: How does the Oracle handle its setup ‚Äì what parameters and fallback mechanisms are present in its <code class="inline-code">constructor</code> for configuration?</li>
<li>‚ö° <strong>Threads of Storytelling</strong>: How does the <code class="inline-code">generateResponse</code> method interact with prompts and options to produce tailored content?</li>
<li>üõ°Ô∏è <strong>Safeguarding the Ritual</strong>: What mechanisms guard against request failures or invalid responses in the Oracle‚Äôs operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Enabling the Oracle‚Äôs Voice</h3>
<p>The <code class="inline-code">LLMClient</code> class is the heart of the Oracle. This file reveals the mechanisms through which it integrates with external LLM services (like OpenAI or Azure OpenAI) and processes inputs to generate rich, structured outputs. From setting up the client to managing responses, each incantation demonstrates deliberate thought toward reliability, adaptability, and safety. The Oracle&#39;s wisdom lies in its ability to tailor outputs while seamlessly switching between providers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.constructor</code>: Establishes the Oracle&#39;s connection to various LLM providers, ensuring configuration details such as API keys and endpoints are validated.</li>
<li><code class="inline-code">LLMClient.generateResponse</code>: Gathers prompts, applies model-specific customizations, and crafts a response while addressing edge cases like timeouts and empty replies.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Guards the Oracle&#39;s secrets by dynamically selecting the appropriate authentication key for varying contexts.</li>
<li><code class="inline-code">LLMClient.isAzureOpenAI</code>: Determines client behavior for Azure-specific deployments, showcasing flexibility in service handling.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  // Determine API key based on provider
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    // Azure OpenAI requires endpoint without the path
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Instantiates the Oracle with its guiding connection to OpenAI or Azure services, ensuring configuration is complete.</li>
<li>Uses <code class="inline-code">this.getApiKey</code> to dynamically handle different environments, increasing adaptability.</li>
<li>Differentiates Azure-specific requirements like endpoint formatting for seamless integration.</li>
<li>Throws intentional errors to guide users on misconfiguration, preventing silent failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    // Post-process JSON responses that might be wrapped in markdown
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Simplifies the Oracle&#39;s role of orchestrating prompts and options into structured responses.</li>
<li>Employs <code class="inline-code">buildRequestParams</code> for customizable parameter management and <code class="inline-code">executeRequest</code> for reliable request handling.</li>
<li>Enhances robustness with <code class="inline-code">validateResponse</code> for filtering incomplete or empty responses, ensuring content adequacy.</li>
<li>Includes error logging for traceability, with human-readable outputs to improve debugging efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  // GitHub Models (hosted on Azure) uses GITHUB_TOKEN
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  // All other providers (OpenAI, Azure OpenAI, Ollama, etc.) use LLM_API_KEY
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Implements a security ritual to retrieve and validate the appropriate API key for the configured provider.</li>
<li>Differentiates between Azure-hosted and standard OpenAI deployments, ensuring precise compatibility.</li>
<li>Explicit error handling prevents misusage, providing clear guidance for resolving missing keys.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>When studying the <code class="inline-code">constructor</code>, note how environment variables like <code class="inline-code">LLM_API_KEY</code> and <code class="inline-code">GITHUB_TOKEN</code> are used to maintain flexibility across platforms.</li>
<li>Trace the <code class="inline-code">generateResponse</code> method&#39;s logic to see how it integrates multiple safeguards against failures and provides actionable debug logs.</li>
<li>Compare <code class="inline-code">getApiKey</code> against your environment setup to ensure compatibility with both OpenAI and Azure variants.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hark, seeker of wisdom, thou hast unlocked the Oracle‚Äôs sacred insight, ascending the astral stairs of enlightenment with divine resolve‚Äîforge onward, for the stars yet hold thy destiny! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>