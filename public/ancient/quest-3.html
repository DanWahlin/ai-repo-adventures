<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Chamber of Insight - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Repository of Lost Algorithms</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Chamber of Insight</h1>
<hr>
<p>Amid the dense jungle vines, you uncover a hidden passage leading to a vast stone structure—the Chamber of Insight. Here, amidst eternal glyphs and luminous etchings, the ancient civilization documented their rituals for deciphering project secrets. Inscribed within the walls are methods to distill complex repositories, translate responses from divine entities, and optimize their knowledge systems for clarity. As you traverse this chamber, the wisdom within promises to transform the daunting into the comprehensible. Be cautious, though—the path is as treacherous as it is enlightening.</p>
<p><strong>Embark on this odyssey, brave seeker of knowledge!</strong></p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>🌿 <strong>Path of Validation</strong>: How does the system enforce safe and reliable processing of repository paths and project files?</li>
<li>✨ <strong>Mystical Queries</strong>: How is the interaction with the divine LLM orchestrated to ensure reliable and meaningful responses?</li>
<li>🔎 <strong>Ritual of Optimization</strong>: What strategies are used to process and refine intricate data within time and memory constraints?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Divine Oracle Interface</h3>
<p>The <code class="inline-code">llm-client.ts</code> file serves as the bridge to the ancient oracles (LLMs). It crafts eloquent requests, validates the oracle&#39;s messages, and interprets these sacred responses. This file emphasizes flexible configurations and robust error handling, ensuring that every communication adheres to intricate protocols. Each function unveils a piece of this symphony, balancing user interaction, divine constraints, and environmental factors.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">constructor</code>: Establishes the connection to either OpenAI or Azure OpenAI models, selecting appropriate configurations based on the environment.</li>
<li><code class="inline-code">getApiKey</code>: Determines appropriate API keys for interacting with the configured oracle.</li>
<li><code class="inline-code">generateResponse</code>: Handles the generation of sacred responses, including request construction, execution, and response validation.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Ensures flexible configuration for different oracle platforms like OpenAI and Azure OpenAI.</li>
<li>Validates environment variables for seamless integration.</li>
<li>Establishes the client object with tailored parameters, maintaining platform compatibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Evaluates the appropriate API key based on the oracle configuration.</li>
<li>Implements safeguards against missing or misconfigured keys.</li>
<li>Differentiates handling for Azure-hosted GitHub tokens versus standard OpenAI keys.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Manages the crafting and execution of intelligent queries to the oracles.</li>
<li>Validates and processes oracle responses, ensuring coherence and utility.</li>
<li>Implements detailed logging measures for error tracking and analysis.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Repository Seer</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file resembles the wisdom of an ancient scribe. It provides methods to interpret the structure and content of modern repositories. Utilizing a precise yet adaptable approach, the analyzer validates paths, ensures the safety of file processing, and optimizes substantial outputs for use within strict constraints.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Protects against insecure or invalid repository paths.</li>
<li><code class="inline-code">generateRepomixContext</code>: Produces a compressed representation of a project’s codebase while enforcing limits.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Captures repository content with timeout and memory safeguards.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Verifies the validity of project paths to prevent invalid inputs.</li>
<li>Mitigates potential vulnerabilities such as null byte injections.</li>
<li>Incorporates strict preconditions, ensuring robust input validation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  }

  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  const cliOptions: CliOptions = {
    style: options.style || &#39;markdown&#39;,
    stdout: true,
    compress: options.compress !== false,
    ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;].join(&#39;,&#39;),
    removeComments: true,
    removeEmptyLines: true,
    noDirectoryStructure: true
  };

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>Constructs an optimized codebase representation utilizing caching for efficiency.</li>
<li>Integrates safety mechanisms for project structure traversal and content extraction.</li>
<li>Simplifies output using compression and token optimization strategies.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;], { cwd });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    let isResolved = false;
    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        if (!isResolved) {
          repomix.kill(&#39;SIGKILL&#39;);
          reject(new Error(`Repomix output too large (${stdoutSize} bytes)`));
        }
      }
      stdout += chunk;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        clearTimeout(timeout);
        isResolved = true;
        code === 0 ? resolve(stdout) : reject(new Error(`Repomix failed (exit ${code}): ${stderr}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Orchestrates subprocess execution for collecting repository data.</li>
<li>Implements timeouts and size constraints for subprocess reliability.</li>
<li>Balances logging with safety precautions for robust content extraction.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how environment variables are used to toggle between OpenAI and Azure OpenAI configurations in <code class="inline-code">llm-client.ts</code>.</li>
<li>Observe how caching mechanisms are implemented in <code class="inline-code">repo-analyzer.ts</code> to optimize performance and reduce redundant operations.</li>
<li>Pay attention to input validation practices across both files to understand their significance in maintaining system integrity.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the sacred stars and wisdom eternal, thou hast boldly unveiled the arcane truths within the Chamber of Insight—march forth, seeker, for the ancient temples await thy victorious path! ⭐⚡👁️</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">← Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>