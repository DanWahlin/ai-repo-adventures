<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle‚Äôs Glyphs - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Temple of Code: Unraveling the Lost Algorithms</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle‚Äôs Glyphs</h1>
<hr>
<p>In the shadowed sanctuary of the third chamber within the Temple of Code lies the Oracle‚Äôs Glyphs, ancient symbols that grant wisdom to those who dare decode them. Inscribed upon weathered stone tablets and scattered among remnants of sacred texts, these glyphs reveal how the temple itself functions, bridging the wisdom of external forces and the repository‚Äôs intricate design. Today‚Äôs quest challenges you to unravel the cryptic workings of two foundational artifacts: the <code class="inline-code">RepoAnalyzer</code> and the <code class="inline-code">LLMClient</code>. Their interplay powers the temple‚Äôs hidden machinery, beckoning your understanding to harness their magic.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Decoding</strong>: How does <code class="inline-code">RepoAnalyzer.generateRepomixContext</code> handle large repositories while ensuring efficiency?</li>
<li>‚ö° <strong>Invocation Patterns</strong>: What specific elements enable <code class="inline-code">LLMClient.generateResponse</code> to interact with multiple external APIs effectively?</li>
<li>üõ°Ô∏è <strong>Ritual Fail-safes</strong>: How are errors captured and reported in both <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code> methods, ensuring balance amid uncertainty?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Connecting Wisdom from External Sources</h3>
<p>The <code class="inline-code">LLMClient</code> class acts as the Oracle‚Äôs connection to external forces, specifically large language models (LLMs) like OpenAI and AzureOpenAI. It configures and invokes the API endpoints needed for generating content based on the request parameters. This artifact manages keys, ensures compatibility for various LLMs, processes responses, and handles exceptions gracefully. The sacred functions within are carved to optimize API interaction, allowing the temple to weave complex prompts into magical responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Generates a response to a given prompt, utilizing optimization for GPT-specific models.</li>
<li><code class="inline-code">constructor</code>: Initializes API configurations, distinguishing between providers such as OpenAI and Azure.</li>
<li><code class="inline-code">getApiKey</code>: Retrieves the appropriate API key for the configured provider.</li>
<li><code class="inline-code">isAzureOpenAI</code>: Determines whether the LLM provider is Azure OpenAI instead of standard OpenAI.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Decoding the Temple‚Äôs Repository Glyphs</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as the key artifact for inspecting and decoding repository glyphs, granting structured insights to the temple‚Äôs workings. It works with filesystem paths to validate targets, optimize content extraction, and invoke subprocesses to generate compressed outputs of repository files. This artifact ensures the efficient generation of glyph-like summaries while safeguarding operational limits.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Constructs a compressed representation of a repository based on predefined settings and configurations.</li>
<li><code class="inline-code">generateTargetedContent</code>: Handles targeted extraction of files, applying robust validation.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Runs <code class="inline-code">npx repomix</code> as a subprocess to extract codebase context, safeguarding against excessive output or timeouts.</li>
<li><code class="inline-code">validateProjectPath</code>: Ensures the provided repository path meets basic safety and validity for processing.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>The function establishes the request parameters dynamically, adapting for different LLM models like GPT.</li>
<li>It validates and cleans the response, often optimizing for formats (e.g., JSON or markdown).</li>
<li>Error handling captures traceable issues, offering debugging guidance via detailed logs.</li>
<li>Completion token usage is monitored, upholding resource efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>The constructor initializes the Oracle-client with dynamic API configuration tailored to either Azure or OpenAI.</li>
<li>Providers are identified using the <code class="inline-code">isAzureOpenAI</code> method, ensuring correct connection pathways.</li>
<li>Key separation for GitHub-hosted models versus others preserves secure access management.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN required.&#39;);
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY required.&#39;);
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>This function simplifies the application of keys by distinguishing between providers and enforcing secure environment configuration.</li>
<li>Error reporting conditions clarify immediate feedback upon misconfiguration or missing variables.</li>
</ul>
<hr>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content: falling back.`);
      try {
        return await this.generateTargetedContent(projectPath, configuredFiles);
      } catch (fallbackError) {
        console.warn(`Fallback failed: generating full context.`);
      }
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;];
    
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;)
    };
    
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Validates the repository path while integrating settings like compression for optimized token use.</li>
<li>It operates as a layered fallback allowing retries for different generation stages before opting for full repository analysis.</li>
<li>Implements caching for efficiency, minimizing repeat processing of identical paths and settings.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be valid&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Protects against invalid or unsafe paths with checks for null bytes and empty strings.</li>
<li>Simplifies enforcement of reliable inputs for repository operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
      reject(new Error(`Timeout after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);
    
    repomix.stdout.on(&#39;data&#39;, data =&gt; { stdout += data.toString(); });
    repomix.stderr.on(&#39;data&#39;, data =&gt; { stderr += data.toString(); });
    repomix.on(&#39;close&#39;, code =&gt; {
      clearTimeout(timeout);
      if (code !== 0) reject(new Error(`Repomix failed: ${stderr}`));
      resolve(stdout);
    });
  });
}
</code></pre>
<ul>
<li>This function creates subprocesses to interface with <code class="inline-code">repomix</code>, adhering to limits for time and buffer capacity.</li>
<li>Includes timeout and graceful termination mechanisms for tightly controlled execution.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Detailed error logs in both <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code> serve as invaluable debugging tools.</li>
<li>Pay special attention to <code class="inline-code">generateRepomixContext</code> fallback flows to understand resilience in design.</li>
<li>Use <code class="inline-code">generateResponse</code> in <code class="inline-code">LLMClient</code> as a template for optimizing interactions with external APIs.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the Temple of Code.</p>
<p>Blessed seeker, thou hast unveiled the sacred Oracle‚Äôs Glyphs, etching thy wisdom upon the temple of knowledge‚Äîmarch forth, for the stars yet beckon thy triumphant ascent! ‚ö°üëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>