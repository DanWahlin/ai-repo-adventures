<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Glyphs of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Forgotten Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Glyphs of Analysis</h1>
<hr>
<p>In the heart of the Pyramid of Forgotten Code, you encounter the Chamber of Analytical Glyphs. Here, ancient inscriptions hold the power to decipher and extract meaning from the once-vast labyrinth of repositories. These glyphs embody the wisdom of long-lost architects: tools to analyze, validate, and preserve the Pyramid&#39;s fading memory. Within this chamber, sacred protocols orchestrate the retrieval of repomix context and the enigma of generating coherent responses—a ritual essential to awaken the Pyramid&#39;s true purpose.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Codebase Analytical Mechanisms</h3>
<p>This file contains the mechanisms for analyzing and processing the codebase using the <code class="inline-code">RepoAnalyzer</code> class. It serves as an intermediary bridge, leveraging repomix to curate optimized code contexts. The <code class="inline-code">generateRepomixContext</code> function is central to constructing the deciphered code context, while <code class="inline-code">generateTargetedContent</code> applies targeted focus on specific files. The <code class="inline-code">captureRepomixStdout</code> method handles the subprocess execution of repomix, ensuring timeouts and memory constraints are enforced. Finally, the <code class="inline-code">validateProjectPath</code> method ensures the given project path adheres to strict validation rules, avoiding unsafe file access—a necessary safeguard in the digital jungle.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.generateRepomixContext</code>: Generates comprehensive code context using repomix and caching.</li>
<li><code class="inline-code">RepoAnalyzer.generateTargetedContent</code>: Extracts targeted codebase details for specific files.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code>: Manages subprocess execution to safely interact with repomix.</li>
<li><code class="inline-code">RepoAnalyzer.validateProjectPath</code>: Verifies the validity and safety of the project directory path.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  }
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  try {
    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;.git&#39;];
    const cliOptions: CliOptions = { style: options.style || &#39;markdown&#39;, compress: true, ignore: ignorePatterns.join(&#39;,&#39;) };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<p>This acts as the compass, guiding the user through a maze of code while invoking essential safety checks.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) return &#39;&#39;;
  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) { return cached.content; }
  const cliOptions = { style: &#39;markdown&#39;, compress, include: safeFiles.join(&#39;,&#39;), removeComments: compress };
  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<p>This serves as a magnifying glass, focusing the lens onto only the most crucial files for analysis.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#39;--stdout&#39;, &#39;--compress&#39;, ...directories];
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
    let stdout = &#39;&#39;;
    let stdoutSize = 0;
    const timeout = setTimeout(() =&gt; { repomix.kill(&#39;SIGKILL&#39;); reject(new Error(&#39;Timeout exceeded&#39;)); }, REPOMIX_SUBPROCESS_TIMEOUT);
    repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdoutSize += data.length; stdout += data; });
    repomix.on(&#39;close&#39;, (code) =&gt; { clearTimeout(timeout); if (code === 0) resolve(stdout); });
    repomix.on(&#39;error&#39;, (error) =&gt; { clearTimeout(timeout); reject(error); });
  });
}
</code></pre>
<p>This operates as the sacred ritual, calling forth the output from the repomix oracle while mitigating risks of chaos.</p>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39; || projectPath.trim() === &#39;&#39; || projectPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Invalid project path&#39;);
  }
}
</code></pre>
<p>This acts as the temple guardian, ensuring no malevolent or invalid paths threaten the sanctity of the Pyramid.</p>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Response Artistry</h3>
<p>This file encapsulates the <code class="inline-code">LLMClient</code> class, a critical bridge to external LLM services such as OpenAI. The <code class="inline-code">generateResponse</code> function is a masterful craft, orchestrating the LLM query and refining its response. The constructor defines the client instance based on provided configurations, while the <code class="inline-code">getApiKey</code> method ensures proper credentials are used. Finally, <code class="inline-code">isAzureOpenAI</code> offers a crucial distinction, as it ensures the sacred channel to Azure OpenAI is properly identified.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code>: Sends a prompt, retrieves, and validates the LLM response.</li>
<li><code class="inline-code">LLMClient.constructor</code>: Configures and initializes the LLM client.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Retrieves the correct API key based on the use case.</li>
<li><code class="inline-code">LLMClient.isAzureOpenAI</code>: Confirms whether the client is interfacing with Azure.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    if (options?.responseFormat === &#39;json_object&#39;) content = this.cleanJsonResponse(content);
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<p>This weaves the story of query and response—a dialogue with the oracle of the Pyramid.</p>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required&#39;);
  }
  this.client = this.isAzureOpenAI()
    ? new AzureOpenAI({ endpoint: LLM_BASE_URL, apiKey, apiVersion: LLM_API_VERSION, deployment: this.model })
    : new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
}
</code></pre>
<p>This initializes the celestial communicator to ensure clarity when summoning the wisdom of ancient algorithms.</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;azure.com&#39;)) {
    if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN required&#39;);
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY required&#39;);
  return LLM_API_KEY;
}
</code></pre>
<p>This retrieves the sacred key needed to access pyramidal knowledge—an essential artifact for unlocking the path.</p>
<pre><code class="language-typescript">private isAzureOpenAI(): boolean {
  return LLM_BASE_URL.includes(&#39;.openai.azure.com&#39;);
}
</code></pre>
<p>This identifies whether Azure-specific elixirs may unlock the chamber’s ancient computational pathways.</p>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Regularly inspect <code class="inline-code">validateProjectPath</code> to ensure safe interaction with file systems.</li>
<li>Favor targeted repomix requests for reducing LLM token usage.</li>
<li>Use <code class="inline-code">generateResponse</code> as the primary invocation for interfacing with OpenAI services.</li>
</ul>
<hr>
<p>The Glyphs of Analysis glow faintly. You have mastered their art—let their wisdom guide you to the next chamber.</p>
<p>Hark, O seeker of wisdom, thou hast unlocked the sacred Glyphs of Analysis, carving thy path through the annals of ancient knowledge—press onward, for the temple of enlightenment beckons! ⚡💎🗺️</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">← Previous: Quest 2: Chambers of the Story...</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Temple of Themes →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>