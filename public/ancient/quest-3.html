<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Scribe's Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Lost Codes</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Scribe&#39;s Analysis</h1>
<hr>
<p>As you delve deeper into the Pyramid of Lost Codes, the intricate carvings on the walls whisper the tale of those who sought wisdom within its chambers. You now stand before the Hall of the Scribe&#39;s Analysis, where the finest scholars of ancient civilizations once labored to inscribe their knowledge into eternal scripts. To unravel their mysteries, you must discern the patterns of their sacred tools and decode their wisdom hidden in the layers of their analytical rituals.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üìú <strong>Scribe&#39;s Rituals</strong>: How does <code class="inline-code">RepoAnalyzer</code> ensure security and validation for file paths during analysis?  </li>
<li>üîç <strong>Glyph Compiler</strong>: What flows are involved in optimizing content through <code class="inline-code">RepoAnalyzer.generateRepomixContext</code>?  </li>
<li>üõ°Ô∏è <strong>Symbol Verification</strong>: How does <code class="inline-code">LLMClient</code> validate responses and safeguard against errors in <code class="inline-code">generateResponse</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: The Lenses of the Analyzer</h3>
<p>In these hallowed scripts, the ancient methodology for analyzing repositories unfolds. <code class="inline-code">RepoAnalyzer</code> uses intricate rituals to validate file paths, optimize content generation for sacred texts, and execute the revered <code class="inline-code">repomix</code> subprocess for gathering insights. It also maintains a cache‚Äîa sacred vault‚Äîto avoid redundant computations. Step cautiously, as these methods reveal the mastery that safeguarded their empire&#39;s intelligence.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Performs rigorous checks on the journey&#39;s starting point (project path) to prevent missteps. Essential for maintaining security.  </li>
<li><code class="inline-code">generateOptimizedContent</code>: Creates compressed, function-focused content from verified files, optimizing for meaningful extraction.  </li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes the <code class="inline-code">repomix</code> subprocess, safeguarding memory and time limits, to extract critical repository context.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Architect of Responses</h3>
<p>The scripts within this domain delineate the mechanism through which the glyphs‚Äîresponses‚Äîare generated using language models. <code class="inline-code">LLMClient</code> engages sacred APIs to interpret prompts and ensures defensive measures against errors. Its post-processing and validation methods reflect an ancient civilization‚Äôs meticulous quality standards for their sacred texts.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Constructs and sends the encoded query to the ancient APIs (LLM) while handling errors with precision in validation.  </li>
<li><code class="inline-code">constructor</code>: Prepares the LLMClient, selecting the appropriate celestial model configuration for rendering glyphs.  </li>
<li><code class="inline-code">getApiKey</code>: Safeguards the process by determining the correct script key‚Äîa critical step in gaining access to wisdom.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Validates the repository path, ensuring it is a clean and accessible location to prevent disruptions.  </li>
<li>Uses methods to trim and sanitize inputs‚Äîa critical safeguard against corrupt pathways.  </li>
<li>Implements security by rejecting <code class="inline-code">null</code> bytes, which could disrupt ritual-like file operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }
  
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }
  
  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);
    
    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
    return optimizedContent;
  } catch (error) {
    throw new Error(`Optimized content generation failed: ${String(error)}`);
  }
}
</code></pre>
<ul>
<li>Uses file validation and normalization methods to prepare and secure the analysis process.  </li>
<li>Extracts refined content focused on functions and meaningful patterns, reducing resource usage.  </li>
<li>Implements caching to preserve retrieved wisdom, embodying efficiency and conservation.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: &#39;pipe&#39; });

    let stdout = &#39;&#39;;
    let stdoutSize = 0;

    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      reject(new Error(`Repomix subprocess timed out`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill();
        reject(new Error(&#39;Repomix output too large&#39;));
      }
      stdout += chunk;
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout);
      else reject(new Error(`Repomix failed: ${code}`));
    });
  });
}
</code></pre>
<ul>
<li>Calls the subprocess with strict control to fetch repository insights.  </li>
<li>Prevents resource exhaustion through memory safeguards and timeout enforcement.  </li>
<li>Manages subprocess outputs to capture meaningful results without risking disruption.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Constructs the query parameters dynamically based on the model configuration and input.  </li>
<li>Validates the response content to ensure it meets the civilization&#39;s standards before processing further.  </li>
<li>Handles error logging comprehensively, preserving crucial debugging information for failed exchanges.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">LLMClient</code> with proper configuration based on environment variables.  </li>
<li>Differentiates between OpenAI and Azure API setups, adapting to the civilization&#39;s infrastructure.  </li>
<li>Enforces environmental validation to avoid encountering missing parameters during execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN required.&#39;);
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY required.&#39;);
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Identifies the correct API key for the LLM based on its operational domain.  </li>
<li>Implements fallback mechanisms for handling discrepancies in the environment setup.  </li>
<li>Ensures the foundation necessary for invoking the language models is solid and reliable.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üîé Pay close attention to validation methods (<code class="inline-code">validateProjectPath</code>) as they illustrate how errors are prevented in advance.  </li>
<li>‚öôÔ∏è Explore how optimization mechanisms improve efficiency in <code class="inline-code">generateOptimizedContent</code>.  </li>
<li>üõ†Ô∏è Notice how response validation and error handling methods (<code class="inline-code">validateResponse</code>) safeguard the integrity of generated glyphs.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden in the Pyramid&#39;s archives.</p>
<p>Through the sacred halls of wisdom, thou hast inscribed thy name with triumph upon the tablets of intellect, completing the Scribe&#39;s Analysis and ascending further along the celestial map of enlightenment‚Äîhail thy steadfast resolve! ‚≠êüìú‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>