<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle of the Texts - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Codex of Computational Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle of the Texts</h1>
<hr>
<p>You journey to the heart of a long-forgotten jungle temple and stand before the Oracle&#39;s Chamber of Codes. Here lies the <strong>Sacred Codex of Computational Wisdom</strong>, its pages illuminating how the ancients analyzed labyrinthine knowledge structures and harnessed the enigmatic power of machine learning to decode them. The Oracle&#39;s inscriptions speak of the <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code>‚Äîguardians of structured wisdom and generative insight. Unlocking their secrets requires careful study, for they hold the key to shaping coherent and rich adventures from scattered fragments of knowledge.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Structure Analysis</strong>: How does <code class="inline-code">RepoAnalyzer</code> handle project path validation and file normalization to ensure safety and reliability of user input?</li>
<li>‚ö° <strong>Invocation Rites</strong>: How does the <code class="inline-code">LLMClient</code> initialize its configurations for either OpenAI or Azure, and how does it dynamically handle different model types such as GPT-5?</li>
<li>üõ°Ô∏è <strong>Fail-Safe Mechanisms</strong>: What strategies are used in both <code class="inline-code">LLMClient</code> and <code class="inline-code">RepoAnalyzer</code> to handle errors, timeouts, or invalid responses to ensure system resilience and informed recovery?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Machine Learning Interface</h3>
<p>This file contains the implementation of the <code class="inline-code">LLMClient</code>, the Oracle&#39;s conduit to generative wisdom. It bridges environments like OpenAI and Azure OpenAI, allowing structured interactions with advanced textual models. The client is designed for flexibility and reliability, with robust error-handling mechanisms to ensure the service operates effectively even during failures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">constructor</code>: Initializes the API client and validates required configurations based on the model provider (e.g., OpenAI or Azure).</li>
<li><code class="inline-code">generateResponse</code>: Handles the invocation of the machine learning model, processes the response, and manages errors during model interaction.</li>
<li><code class="inline-code">buildRequestParams</code>: Constructs customized request parameters for interaction with different model types, including specific handling for GPT-5 configurations.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">LLMClient</code> based on the environment, choosing between OpenAI and Azure configurations.</li>
<li>Validates the API key (<code class="inline-code">LLM_API_KEY</code> or <code class="inline-code">GITHUB_TOKEN</code>) and ensures the <code class="inline-code">LLM_BASE_URL</code> is specified.</li>
<li>Selects appropriate initialization configurations; for Azure OpenAI, extracts the base endpoint and specifies deployment.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Builds request parameters, communicates with the model, and validates its response.</li>
<li>Implements error logging (e.g., <code class="inline-code">logDetailedError</code>) to capture failures and provide contextual information.</li>
<li>Scopes error recovery and logging mechanisms, ensuring efficiency in generative system pipelines.</li>
</ul>
<hr>
<pre><code class="language-typescript">private buildRequestParams(prompt: string, options?: LLMRequestOptions): OpenAIRequestParams {
  const requestParams: OpenAIRequestParams = {
    model: this.model,
    messages: [{ role: &#39;user&#39;, content: prompt }]
  };

  if (options?.responseFormat) {
    requestParams.response_format = { type: options.responseFormat };
  }

  if (this.isGPT5Model()) {
    requestParams.temperature = 1;
    requestParams.max_completion_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.verbosity = options?.verbosity || GPT5_VERBOSITY;
    requestParams.reasoning_effort = options?.reasoningEffort || GPT5_REASONING_EFFORT;
  } else {
    requestParams.temperature = LLM_TEMPERATURE; 
    requestParams.max_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
  }

  return requestParams;
}
</code></pre>
<ul>
<li>Dynamically builds API request payloads for multiple model types, customizing parameters like <code class="inline-code">temperature</code> and <code class="inline-code">max_tokens</code>.</li>
<li>Provides special handling for GPT-5 models, including verbosity and reasoning effort.</li>
<li>Accommodates various response formats (e.g., JSON, text) to suit application needs.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Knowledge Structuring Tool</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is the cornerstone for validating, analyzing, and optimizing repository files. It ensures that only well-structured content is passed to downline processes, reducing memory overhead and maximizing processing efficiency.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Ensures that user-provided repository paths are free of dangerous values and properly formatted.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Filters, normalizes, and validates file paths to prevent path traversal and optimize resources.</li>
<li><code class="inline-code">generateRepomixContext</code>: Executes a complete repository analysis, optionally integrating configuration to customize content for targeted file sets.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Validates project paths, checking for empty values and null bytes to prevent security risks.</li>
<li>Protects the system from malformed input by normalizing and sanitizing user inputs.</li>
<li>Raises errors immediately upon detecting invalid paths, ensuring reliable execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) return null;
      const trimmed = file.trim();
      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) return null;

      const fullPath = path.resolve(projectPath, file);
      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) return null;
      if (!fs.existsSync(fullPath)) return null;

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null);

  return safeFiles;
}
</code></pre>
<ul>
<li>Ensures file paths are checked for null bytes and unsafe traversal sequences (e.g., <code class="inline-code">..</code>).</li>
<li>Validates each file&#39;s existence and ensures it resides within the project directory.</li>
<li>Deduplicates and limits the file list to prevent overloads, improving processing efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  }

  const ignorePatterns = [
    &#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;
  ];

  const cliOptions: CliOptions = {
    style: options.style || &#39;markdown&#39;,
    stdout: true,
    compress: options.compress !== false,
    ignore: ignorePatterns.join(&#39;,&#39;),
    removeComments: true,
    removeEmptyLines: true,
    noDirectoryStructure: true,
  };

  return await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
}
</code></pre>
<ul>
<li>Analyzes the repository, harnessing <code class="inline-code">repomix</code> to extract and structure code in a compact, token-efficient format.</li>
<li>Accommodates custom file configurations for targeted exploration, while maintaining flexible defaults.</li>
<li>Validates and filters irrelevant or sensitive files (e.g., <code class="inline-code">node_modules</code>) to conserve resources.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Paths can harm your system if not sanitized properly‚Äîclosely inspect how the Oracle guards against unsafe values.</li>
<li>Notice how the system aligns machine configurations for OpenAI and Azure, revealing its modularity and versatility.</li>
<li>Investigate the handling of errors in both classes‚Äîresilience is the Oracle&#39;s key to enlightenment.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>O seeker of sacred knowledge, thou hast deciphered the Oracle of the Texts with wisdom unparalleled, ascending further upon the gilded path of enlightenment‚Äîtake heart, for the stars yet guide thee to glory eternal! ‚≠êüìú‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>