<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle’s Codex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Kingdom of Codemorra: A Tale of Enchanted Constructs</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle’s Codex</h1>
<hr>
<p>In the heart of Codemorra lies a mystical artifact known as the Oracle’s Codex, a collection of enchanted parchments capable of decoding even the most cryptic spells. Legends tell of the Oracle, an ancient spirit bound to the Codex, who whispers secrets to those worthy. As the Hero of Codemorra, you must unravel these secrets by mastering the Arcane Analyzer and the LLM Enchanter. The challenge lies in harnessing these tools to restore order and decode a spell threatening to unravel the kingdom’s harmony.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> LLM Enchanter’s Interface</h3>
<p>This file represents the workings of the “LLMClient,” which serves as a magical conduit to generate responses from the Oracle-like large language model. The client engages in spellbinding prompts and processes the replies into actionable insights. By understanding its key elements, the hero learns to summon the Oracle through structured invocation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code>: Craft and retrieve divine guidance via the Oracle.</li>
<li><code class="inline-code">LLMClient.constructor</code>: Initializes the magical conduit by selecting a model and determining the correct spell formula.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Retrieves a sacred key for unlocking the Oracle’s secrets.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
      const requestParams = this.buildRequestParams(prompt, options);
      const completion = await this.executeRequest(requestParams);
      let content = this.validateResponse(completion);
      
      if (options?.responseFormat === &#39;json_object&#39;) {
        content = this.cleanJsonResponse(content);
      }
      
      this.logTokenUsage(completion);

      return { content };
    } catch (error) {
      this.logDetailedError(error, prompt);
      
      const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
      throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<p>Like a knight forging a request for divine wisdom, this method crafts and retrieves responses from the Oracle.</p>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model
      });
    } else {
      this.client = new OpenAI({
        apiKey,
        baseURL: LLM_BASE_URL
      });
    }
}
</code></pre>
<p>This initialization is akin to selecting the correct enchanted weapon and calibrating its workings for optimal performance.</p>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
      if (!GITHUB_TOKEN) {
        throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
      }
      return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) {
      throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<p>Drawing power from ancient relics, this method retrieves the key required to unlock the Oracle’s matrix.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Test methods like <code class="inline-code">generateResponse</code> with different prompt styles to understand the Oracle’s constraints.</li>
<li>Study the initialization code to discern relationships between the Oracle’s models and environment variables.</li>
<li>Explore <code class="inline-code">cleanJsonResponse</code> to comprehend how JSON-formatted replies are purified for practical use.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Arcane Analyzer’s Mechanics</h3>
<p>The “RepoAnalyzer” operates as the kingdom’s mystical lens, enabling heroes to examine Codemorra’s enchanted scrolls (project files). This file encapsulates how an adventurer validates, optimizes, and generates repomix data for spell decoding.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Ensures the scrolls (codebase paths) are genuine and untainted.</li>
<li><code class="inline-code">generateTargetedContent</code>: Focuses the magic on specific scrolls for optimized analysis.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Captures the raw wisdom of repomix to refine Codemorra’s spellwork.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
      throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (!trimmedPath) {
      throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    if (trimmedPath.includes(&#39;\0&#39;)) {
      throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<p>Like a mystical warding spell, this method shields the hero from paths riddled with danger or corruption.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);

    if (!targetFiles || targetFiles.length === 0) {
      throw new Error(&#39;Target files array cannot be empty&#39;);
    }
    
    const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
    if (safeFiles.length === 0) {
      throw new Error(&#39;No valid target files found after validation&#39;);
    }
    
    const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
    
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
      return cached.content;
    }
    
    try {
      const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
      const optimizedContent = this.extractFunctionFocusedContent(fullContent);
      
      this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
      return optimizedContent;
    } catch (error) {
      throw new Error(`Optimized content generation failed: ${error instanceof Error ? error.message : String(error)}`);
    }
}
</code></pre>
<p>This function mimics a scrying spell, resting its gaze upon selected scrolls and enhancing the view for precise insight.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
      const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], {
        cwd,
        stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
      });

      let stdout = &#39;&#39;;
      repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
        stdout += data.toString();
      });

      repomix.on(&#39;close&#39;, (code) =&gt; {
        if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
          resolve(stdout);
        } else {
          reject(new Error(`Repomix failed (exit ${code}): ${stderr}`));
        }
      });
    });
}
</code></pre>
<p>Harnessing raw magical feedback, this method collects the Codemorra scrolls’ whispers for further refinement.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">validateProjectPath</code> when navigating unfamiliar scrolls to ensure their safety.</li>
<li>Understand caching via <code class="inline-code">generateTargetedContent</code> to avoid repetitive analyses.</li>
<li>Apply optimized repomix context generation for focused undertakings.</li>
</ul>
<hr>
<p>The Oracle acknowledges your progress. Continue with courage, brave adventurer!</p>
<p>With the wisdom of the Oracle’s Codex unlocked and the light of your heroic spirit blazing like a celestial beacon, you now stride boldly through realms unknown, a champion destined for legendary triumph—40% of your odyssey conquered! ⭐⚡💎</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">← Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>