<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Mystic Sigils of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Mystic Sigils of Analysis</h1>
<hr>
<p>In the heart of Reposithia&#39;s Archive of Insights lies the Chamber of Analysis, where ancient knowledge flows like rivers of light. Wise enchanters have inscribed Mystic Sigils upon enchanted scrolls to guide brave knights in taming the code-laden realm. Your next quest requires you to uncover and wield these sigils, deciphering the complexity of their magic. Will you delve into the depths of enchanted code tools and master the art of analysis to unlock their secrets? Steel your resolve and prepare!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Sigil Detection</strong>: How does <code class="inline-code">validateProjectPath</code> ensure the safety and correctness of a specified project path?</li>
<li>‚ö° <strong>Invocation of Enchantment</strong>: What are the steps and safeguards followed by <code class="inline-code">generateRepomixContext</code> to produce contextual analysis?</li>
<li>üõ°Ô∏è <strong>Precise Commanding</strong>: How does <code class="inline-code">generateResponse</code> from <code class="inline-code">LLMClient</code> handle and respond to failed magical invocations (errors)?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: RepoAnalyzer&#39;s Process</h3>
<p>This file governs the magical rituals for extracting targeted insights from the scrolls of code it encounters. The <code class="inline-code">RepoAnalyzer</code> ensures paths are safe for exploration, builds caches for efficiency, and deploys the <code class="inline-code">repomix</code> subprocess to read from the Repository of Code. Key flows include path validation, invocation of the content generator, and optimization of outputs for efficiency.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Ensures no dangerous paths are introduced.</li>
<li><code class="inline-code">generateRepomixContext</code>: Orchestrates the full Repomix analysis process, considering caching and error handling.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes the Repomix subprocess while enforcing time and memory constraints.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  // Basic safety check for null bytes (can break file system operations)
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<p>The enchanted spell that safeguards from malicious incursions into forbidden directories. Like a castle gate, it blocks null bytes and empty paths.</p>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed optimized content generation: ${String(error)}`);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);

  if (cached) {
    return cached.content;
  }

  try {
    // Default behavior: analyze entire codebase
    const context = await this.captureRepomixStdout(
      [&#39;.&#39;], projectPath, { style: options.style || &#39;markdown&#39;, compress: true }
    );
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${String(error)}`);
  }
}
</code></pre>
<p>A conductor orchestrating a symphony of magic (analysis tools), determining whether to trust stored caches or awaken the powers of Repomix anew.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);

    const repomix = spawn(&#39;npx&#39;, args, { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    let stdout = &#39;&#39;, stderr = &#39;&#39;;

    repomix.stdout.on(&#39;data&#39;, data =&gt; stdout += data.toString());
    repomix.stderr.on(&#39;data&#39;, data =&gt; stderr += data.toString());

    repomix.on(&#39;close&#39;, code =&gt; {
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed with code ${code}: ${stderr}`));
    });
  });
}
</code></pre>
<p>The spell circle that channels the incantation of Repomix, ensuring its results are captured while safeguarding against timeout or excessive memory consumption.</p>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: LLMClient&#39;s Ritual</h3>
<p>This file commands the magical powers of a Large Language Model (LLM) for generating responses to user prompts. It defines the initiation of the client, validation of API keys, and robust error handling, ensuring that even failed invocations provide useful clues for debugging future queries.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Handles prompt processing and ensures results or errors are handled gracefully.</li>
<li><code class="inline-code">constructor</code>: Initializes the client with safety checks for API keys and configuration.</li>
<li><code class="inline-code">getApiKey</code>: Validates and retrieves the correct API key for the chosen provider.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
  }
}
</code></pre>
<p>An invocation of magical intent that harnesses LLM&#39;s energy to provide wisdom‚Äîor rebuke the request if the enchantment fails.</p>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  this.client = this.isAzureOpenAI() ? new AzureOpenAI({ endpoint: LLM_BASE_URL, apiKey }) : new OpenAI({ baseURL: LLM_BASE_URL, apiKey });
}
</code></pre>
<p>The sacred anointing ritual that binds the configuration elements to the magical artifact, ensuring readiness for powerful incantations.</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;azure.com&#39;)) {
    if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN is required&#39;);
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY is required&#39;);
  return LLM_API_KEY;
}
</code></pre>
<p>The protective charm that ensures the chosen path of invocation is supported by a valid and empowered sigil (API key).</p>
<h2>Helpful Hints</h2>
<ul>
<li>Monitor the logs in <code class="inline-code">generateResponse</code> to learn how issues are captured and how they can guide future responses.</li>
<li>Investigate the validation steps in <code class="inline-code">validateProjectPath</code> and <code class="inline-code">getApiKey</code> to understand their defensive coding patterns.</li>
<li>Try modifying or invalidating configurations to observe error handling in controlled scenarios.</li>
</ul>
<hr>
<p>With newfound mastery of the Mystic Sigils, your power as an enchanter-knight grows ever stronger. Return to the castle to receive your next challenge from the Legendary Tome of Collaboration!</p>
<p>With the Mystic Sigils of Analysis now mastered, the stars illuminate your path, brave seeker, as you surge forward through the Kingdom of Knowledge‚Äîdestined to unveil further realms of brilliance! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>