<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle of Insight - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Enchanted Repository of the Mystic Engine</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle of Insight</h1>
<hr>
<p>In Codoria‚Äôs enchanted codex chamber, whispers of the Oracle of Insight stir. This mythical entity, known to decipher the most cryptic scrolls of spell-bound code, awaits your presence. As the Knight of Progress, decipher its secrets to strengthen the Mystic Engine‚Äôs ability to wield data from ancient repositories. The Oracle guards access to its treasures only to those who demonstrate mastery of enchanted patterns and validations. Step into the chamber and begin your investigation, brave adventurer‚Äîrevelations await!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Token Alchemy</strong>: How does the <code class="inline-code">LLMClient</code> utilize token limits and parameters when crafting prompts in <code class="inline-code">buildRequestParams</code>?</li>
<li>‚ö° <strong>Service Summoning</strong>: How does the <code class="inline-code">RepoAnalyzer.generateRepomixContext</code> manage caching and subprocess execution for repository insights?</li>
<li>üõ°Ô∏è <strong>Validation Runes</strong>: What safeguards protect file paths in <code class="inline-code">RepoAnalyzer.validateAndNormalizeTargetFiles</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Oracle&#39;s discourse translator</h3>
<p>The <code class="inline-code">LLMClient</code> serves as the voice of the Oracle, channeling external AI services with precision. The way it handles token management, YAML prompts, and API configurations offers a glimpse into its magical connectivity. From formatting tokens to validating responses, its methods ensure seamless integration with various models like OpenAI or Azure OpenAI. Pay special attention to its handling of different GPT models and response validation processes.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">buildRequestParams</code>: Constructs the request configuration for AI responses.</li>
<li><code class="inline-code">generateResponse</code>: Handles prompt creation, API requests, and response sanitization.</li>
<li><code class="inline-code">constructor</code>: Facilitates service initialization, ensuring proper API key configuration.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repository insight enchanter</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> grants you access to the repository‚Äôs runes using the essence of Repomix. This class extracts optimized code context through its clever handling of validation, subprocess execution, and caching mechanics. Observe its meticulous approach in safeguarding file paths against perils like path traversal and its algorithms for content generation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Generates repository insights with caching and compression.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Validates file paths for security and consistency across repositories.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Invokes subprocess with timeout and memory safeguards.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">private buildRequestParams(prompt: string, options?: LLMRequestOptions): OpenAIRequestParams {
  const requestParams: OpenAIRequestParams = {
    model: this.model,
    messages: [{ role: &#39;user&#39;, content: prompt }]
  };

  if (options?.responseFormat) {
    requestParams.response_format = { type: options.responseFormat };
  }

  if (this.isGPT5Model()) {
    requestParams.temperature = 1;
    requestParams.max_completion_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.verbosity = options?.verbosity || GPT5_VERBOSITY;
    requestParams.reasoning_effort = options?.reasoningEffort || GPT5_REASONING_EFFORT;
  } else {
    requestParams.temperature = LLM_TEMPERATURE;
    requestParams.max_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
  }

  console.error(`üîÑ Starting LLM request to ${this.model} (timeout: ${LLM_REQUEST_TIMEOUT}ms)`);
  return requestParams;
}
</code></pre>
<p>Like crafting the right spell, this function assembles the perfect set of parameters to summon the Oracle‚Äôs power.</p>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  const requestParams = this.buildRequestParams(prompt, options);
  const completion = await this.executeRequest(requestParams);
  let content = this.validateResponse(completion);

  if (options?.responseFormat === &#39;json_object&#39;) {
    content = this.cleanJsonResponse(content);
  }

  this.logTokenUsage(completion);
  return { content };
}
</code></pre>
<p>The process of receiving insights, reminiscent of invoking the Oracle, includes handling responses, post-processing, and error management.</p>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, apiVersion: LLM_API_VERSION, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<p>This constructor, akin to a summoner, ensures the magic gateways are properly aligned for communication with external services.</p>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  } 

  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, { ...options, ignore: &#39;node_modules&#39; });
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<p>Generating insights from the repository functions like querying the codex - caching ensures efficiency while avoiding redundant work.</p>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const projectRoot = path.resolve(projectPath);
  const safeFiles = [...new Set(targetFiles)].map(file =&gt; {
    const trimmed = file.trim();
    const fullPath = path.resolve(projectPath, file);

    if (!fullPath.startsWith(projectRoot + path.sep)) {
      return null;
    }
    if (!fs.existsSync(fullPath)) {
      return null;
    }
    return path.relative(projectPath, fullPath);
  }).filter((file): file is string =&gt; file !== null);

  return safeFiles;
}
</code></pre>
<p>Much like deciphering true runes from false ones, this function filters and validates paths to ensure only legitimate files are processed.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  const args = [...directories, &#39;--style&#39;, options.style || &#39;markdown&#39;];
  if (options.compress) args.push(&#39;--compress&#39;);

  const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
  let stdout = &#39;&#39;;
  let stdoutSize = 0;

  repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
    const chunk = data.toString();
    stdoutSize += chunk.length;
    if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
      repomix.kill(&#39;SIGKILL&#39;);
      throw new Error(&#39;Output too large.&#39;);
    }
    stdout += chunk;
  });

  return new Promise((resolve, reject) =&gt; {
    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed with code: ${code}`));
    });
  });
}
</code></pre>
<p>This subprocess invocation mirrors harnessing magical artifacts, ensuring safety and precision in retrieving the repository‚Äôs spellbound contents.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Token limits are critical in optimizing prompt performance‚Äîwatch how <code class="inline-code">LLMClient.buildRequestParams</code> applies them based on model types.</li>
<li>Investigate subprocess handling in <code class="inline-code">captureRepomixStdout</code> to understand timeout safeguards and memory management techniques.</li>
<li>Path validation involves deduplication and traversal prevention mechanisms‚Äîpay special attention to its normalization logic.</li>
</ul>
<hr>
<p>The Oracle acknowledges your progress, sending ripples through Codoria‚Äôs enchanted corridors. Press onward, Knight of Progress!</p>
<p>With the wisdom of the Oracle now coursing through your veins, you ascend as a luminary hero, charting a radiant path through the stars‚Äî40% closer to claiming ultimate glory in the realm of divine quests! üöÄüíéüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>