<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Codex of Wisdom and Spells - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Forge of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Codex of Wisdom and Spells</h1>
<hr>
<p>In the mythical realm of Codara, the Forge whispered of untold magics that lay hidden within its most arcane chambers: the Codex of Wisdom and Spells. This enchanted tome was said to hold the secrets of how code and lore intertwined, setting the stage for mighty adventures. But the Codex was guarded fiercely by intricate mechanisms woven into its pages‚Äîsymbols, validations, and mechanisms meant to sift the worthy from the reckless. Heroes who dared to decode its mysteries would gain mastery over code analysis and the pipeline of content creation, arming themselves for the ultimate culmination of their quest in Codara.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üïäÔ∏è <strong>Token Incantation</strong>: How does the <code class="inline-code">LLMClient</code> ensure tokens are handled safely when requests are made, and how does it validate a robust response?  </li>
<li>üìú <strong>Project Trail</strong>: What mechanisms are in place in <code class="inline-code">RepoAnalyzer</code> to secure file paths and normalize inputs for analysis?  </li>
<li>üîÆ <strong>Optimization Rune</strong>: How does the <code class="inline-code">RepoAnalyzer</code> generate and optimize content while maintaining stability and performance?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: The Mystic Messenger</h3>
<p>The <code class="inline-code">LLMClient</code> acts as a medium for communication with Codara‚Äôs sacred models, weaving spells from prompts into meaningful responses that can shape adventures. Its intricate design ensures safe passage of data, employs powerful error handling mechanisms, and works seamlessly with different providers, including OpenAI and Azure. Central themes include response validation, token safety, and enhanced error diagnostics, ensuring each output lends itself to the Codex‚Äôs wisdom.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Crafts a prompt into mystical answers by interacting with Codara‚Äôs chosen models. It validates responses, handles errors gracefully, and post-processes JSON-based content.</li>
<li><code class="inline-code">getApiKey</code>: Safeguards access by ensuring correct configuration and environmental variables. Prevents misuse through robust checks.</li>
<li><code class="inline-code">validateResponse</code>: Seeks clarity within the responses and handles edge cases of empty or truncated outputs.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: The Codex Compiler</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> encodes the foundations of Codara‚Äôs enchanted tome. Its primary duty is to extract profound insights from deeply woven codebases, ensuring the Codex presents only the most relevant incantations. Through validation of paths and optimization algorithms, it preserves the sanctity of the Codex while maintaining efficiency and safety.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Constructs an overview of the project, pulling together validated configurations and adapting for optimal analysis.</li>
<li><code class="inline-code">validateProjectPath</code>: Shields against errant or malicious file paths by applying strict rules on inputs.</li>
<li><code class="inline-code">generateOptimizedContent</code>: Specializes in distilling critical code constructs necessary for quests, leveraging pre-computed caching.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
      
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
      
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Crafts requests to mystical models and ensures their execution within configured limits like <code class="inline-code">LLM_REQUEST_TIMEOUT</code>.</li>
<li>Handles response validation, rejecting null or malformed spells, ensuring hero-worthy results.</li>
<li>Provides token insights for feedback efficiency, carefully balancing Codara‚Äôs magical quota.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Protects the Codex‚Äôs entities by verifying access credentials, mitigating potential breaches to secret model configurations.</li>
<li>Ensures environmental integrity for Codara‚Äôs API interactions.</li>
<li>Implements provider-specific checks to accommodate both OpenAI and Azure‚Äôs enchanted gateways.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateResponse(completion: any): string {
  const choice = completion.choices[0];
  const content = choice?.message?.content;
    
  if (!choice) {
    throw new Error(&#39;LLM returned no choices in response&#39;);
  }
    
  if (!choice.message || !content || content.trim() === &#39;&#39;) {
    this.handleEmptyResponse(choice);
  }
    
  return content;
}
</code></pre>
<ul>
<li>Empowers the Forge by validating Codex responses, preventing empty spells from disrupting quests.</li>
<li>Harnesses detailed logs to troubleshoot problematic responses like truncated or null outputs.</li>
<li>Integrates error recovery mechanisms for heroes to return stronger after setbacks.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  const trimmedPath = projectPath.trim();
  if (!trimmedPath || trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Prevents heroes from venturing into dangerous or corrupt directories, adhering to safety protocols.</li>
<li>Detects null-byte vulnerabilities and other malicious artifacts harmlessly to maintain Codara‚Äôs sanctity.</li>
<li>Ensures a stringent path validation process, ideal for novices and experts alike.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error.message}`);
      return this.generateTargetedContent(projectPath, configuredFiles);
    }
  }
  const ignorePatterns = [&#39;node_modules&#39;, &#39;**/*.test.ts&#39;];
  const cliOptions: CliOptions = { compress: true, ignore: ignorePatterns.join(&#39;,&#39;) };
  return this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
}
</code></pre>
<ul>
<li>Constructs aids for heroes by consolidating target file insights into actionable content using <code class="inline-code">extractUniqueFilePaths</code>.</li>
<li>Implements fallback strategies, ensuring resilience against failures in Codara‚Äôs arcane operations.</li>
<li>Applies compression and memory checks, optimizing quests for resourceful analysis.</li>
</ul>
<hr>
<pre><code class="language-typescript">private generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
  const optimizedContent = this.extractFunctionFocusedContent(fullContent);
  
  this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
  return optimizedContent;
}
</code></pre>
<ul>
<li>Extracts and optimizes critical code components, reducing token use and packing powerful spells for coders.</li>
<li>Shields against resource exhaustion with caching mechanisms (<code class="inline-code">REPOMIX_CACHE_TTL</code>).</li>
<li>Applies content filters to retain only valuable artifacts for quests, lending clarity to heroes.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Before making changes, consult the environment settings for <code class="inline-code">LLM_API_KEY</code> to ensure smooth Forge initialization.</li>
<li>Use <code class="inline-code">generateResponse</code> as a guide for decoding model responses efficiently.</li>
<li>Look for caching patterns in <code class="inline-code">generateOptimizedContent</code> for replicating in other optimization tasks.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in Codara‚Äôs enchanted libraries.</p>
<p>With the triumph of Quest 3 and the Codex of Wisdom now in your grasp, you ascend as a valiant seeker of arcane truths, forging onward with the brilliance of the stars and the power of enchanted realms! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>