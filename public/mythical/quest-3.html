<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Dragon of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Dragon of Analysis</h1>
<hr>
<p>In the heart of Codathia, whispers have emerged of a mighty Dragon of Analysis‚Äîan enigmatic force creating balance but also chaos in the realm‚Äôs flow of information. It slumbers deep within the enchanted caverns of CodeFlow, breathing the fire of computation. The kingdom&#39;s elders have entrusted you, courageous coder-knight, to navigate the labyrinthine spells and arcane machinery within two sacred scrolls: the <code class="inline-code">repo-analyzer</code> and the <code class="inline-code">llm-client</code>. Empowered by your Spellbook of Development, unravel the workings of these tools and tame the dragon to illuminate its purpose. Charge forth, brave one, into this analytical odyssey!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Token Economy</strong>: How does the <code class="inline-code">logTokenUsage</code> method in <code class="inline-code">LLMClient</code> track and report token consumption, and how is token formatting handled for clarity?</li>
<li>‚ö° <strong>Response Generation</strong>: How are <code class="inline-code">generateResponse</code> in <code class="inline-code">LLMClient</code> and <code class="inline-code">buildRequestParams</code> orchestrated to ensure the construction and delivery of an LLM query?</li>
<li>üõ°Ô∏è <strong>File Safeguard</strong>: How does <code class="inline-code">validateAndNormalizeTargetFiles</code> ensure the safety and integrity of file paths passed into the <code class="inline-code">RepoAnalyzer</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Orchestrating Communication with the Dragon</h3>
<p>This scroll serves as the primary interface with the mighty Dragon of Analysis, managing magical incantations and ensuring safe dialogue. The <code class="inline-code">LLMClient</code> class houses initialization spells and functions to summon responses from the dragon. Highlights for this file reveal intricate processes like token tracking, request building, and error management.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">logTokenUsage</code>: Reports token consumption details for each LLM exchange, formatted for readability and insight into resource usage.</li>
<li><code class="inline-code">generateResponse</code>: Constructs and validates outputs from LLM queries, incorporating error handling tailored to specific scenarios like timeouts or empty outputs.</li>
<li><code class="inline-code">buildRequestParams</code>: Assembles request parameters dynamically, ensuring compatibility with various LLM models like GPT-5.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Mapping the Labyrinthine Caverns</h3>
<p>This scroll wields the tools to analyze vast codebases, akin to drawing maps of the Dragon&#39;s cavern. It validates project paths, optimizes targeted content, and ensures safety through meticulous file handling. By exploring its functionality, we uncover crucial safeguards and optimizations for stable and secure analysis.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Guards against malformed or malicious project paths, performing essential validation.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Enforces security and reliability in file inputs, preventing traversal attacks and ensuring files exist within bounds.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Runs repomix (a subprocess) to generate content safely, with mechanisms to prevent memory exhaustion or infinite execution.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">private logTokenUsage(completion: any): void {
  if (!completion.usage) return;

  const promptTokens = completion.usage.prompt_tokens || 0;
  const completionTokens = completion.usage.completion_tokens || 0;
  const totalTokens = completion.usage.total_tokens || 0;

  const green = &#39;\x1b[32m&#39;;
  const reset = &#39;\x1b[0m&#39;;
  console.error(`üî¢ LLM Usage: ${green}${formatTokenCount(promptTokens)}${reset} prompt + ${green}${formatTokenCount(completionTokens)}${reset} response = ${green}${formatTokenCount(totalTokens)}${reset} total tokens\n`);
}
</code></pre>
<ul>
<li>Tracks the number of tokens consumed during LLM interaction, segregating them into prompt and response categories.</li>
<li>Uses the <code class="inline-code">formatTokenCount</code> utility function to convert large numbers (e.g., 25000 -&gt; 25K) for clear readability.</li>
<li>Highlights efficient resource tracking and aligns well with the Dragon analogy of consumption monitoring.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>A core invocation method to interact with the LLM, connecting the prompt and options with the Dragon&#39;s reasoning.</li>
<li>Reuses subfunctions like <code class="inline-code">buildRequestParams</code>, <code class="inline-code">validateResponse</code>, and <code class="inline-code">logTokenUsage</code> to maintain modularity and clarity.</li>
<li>Enforces downstream protections against malformed responses and details robust error handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">private buildRequestParams(prompt: string, options?: LLMRequestOptions): OpenAIRequestParams {
  const requestParams: OpenAIRequestParams = {
    model: this.model,
    messages: [{ role: &#39;user&#39;, content: prompt }]
  };

  if (options?.responseFormat) {
    requestParams.response_format = { type: options.responseFormat };
  }

  if (this.isGPT5Model()) {
    requestParams.temperature = 1;
    requestParams.max_completion_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.verbosity = options?.verbosity || GPT5_VERBOSITY;
    requestParams.reasoning_effort = options?.reasoningEffort || GPT5_REASONING_EFFORT;
  } else {
    requestParams.temperature = LLM_TEMPERATURE;
    requestParams.max_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
  }

  console.error(`üîÑ Starting LLM request to ${this.model} (timeout: ${LLM_REQUEST_TIMEOUT}ms, prompt length: ${prompt.length} chars)`);
  return requestParams;
}
</code></pre>
<ul>
<li>Defines the parameters and adaptations needed for both GPT-4 and GPT-5 compatibility, ensuring broad capabilities.</li>
<li>Centralizes LLM configurations such as temperature, token limits, and verbosity to reduce redundant logic.</li>
<li>Enables model-specific enhancements for tailored interactions with the LLM.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Protects against invalid or malicious inputs by verifying that project paths are valid strings.</li>
<li>Guards against null bytes (<code class="inline-code">\0</code>), a common vector for injection attacks in file systems.</li>
<li>Establishes a rigid criteria for path inputs, critical in scenarios dealing with sensitive code or environments.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) {
        return null;
      }

      const trimmed = file.trim();
      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
        console.warn(`Rejecting potentially unsafe file path: ${trimmed}`);
        return null;
      }

      return trimmed;
    })
    .filter((file): file is string =&gt; file !== null)
    .map(file =&gt; {
      const fullPath = path.resolve(projectPath, file);

      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) {
        console.warn(`Rejecting file outside project directory: ${file}`);
        return null;
      }

      if (!fs.existsSync(fullPath)) {
        console.warn(`Skipping non-existent file: \`${file}\``);
        return null;
      }

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null)
    .sort();

  return safeFiles;
}
</code></pre>
<ul>
<li>Eliminates duplicates and enforces a strict limit on the number of files to prevent resource exhaustion.</li>
<li>Rejects unsafe file paths (e.g., those with <code class="inline-code">..</code> for traversal) and invalid inputs.</li>
<li>Ensures all returned files exist within the project root, adding an additional layer of security.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [
      ...directories,
      &#39;--stdout&#39;,
      &#39;--style&#39;, options.style || &#39;markdown&#39;
    ];

    if (options.compress) args.push(&#39;--compress&#39;);
    if (options.removeComments) args.push(&#39;--remove-comments&#39;);
    if (options.removeEmptyLines) args.push(&#39;--remove-empty-lines&#39;);
    if (options.noDirectoryStructure) args.push(&#39;--no-directory-structure&#39;);
    if (options.ignore) args.push(&#39;--ignore&#39;, options.ignore);
    if (options.include) args.push(&#39;--include&#39;, options.include);

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], {
      cwd,
      stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
    });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        console.warn(`Repomix subprocess timeout (${REPOMIX_SUBPROCESS_TIMEOUT}ms), killing process...`);
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;

      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        if (!isResolved) {
          isResolved = true;
          clearTimeout(timeout);
          repomix.kill(&#39;SIGKILL&#39;);
          reject(new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`));
        }
        return;
      }

      stdout += chunk;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);

        if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
          resolve(stdout);
        } else {
          reject(new Error(`Repomix failed (exit ${code}): ${stderr.substring(0, 200)}`));
        }
      }
    });

    repomix.on(&#39;error&#39;, (error) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        reject(new Error(`Repomix spawn failed: ${error.message}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Executes the <code class="inline-code">repomix</code> CLI tool as a subprocess, capturing its output while enforcing time and memory limits.</li>
<li>Implements graceful shutdown procedures to free resources in case of timeouts or high memory usage.</li>
<li>Provides robust logging and error details to assist developers in debugging subprocess issues.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">logTokenUsage</code> to monitor interactions with LLM and identify patterns in token consumption.</li>
<li>Investigate <code class="inline-code">validateAndNormalizeTargetFiles</code> for insights into robust file security practices.</li>
<li>Study <code class="inline-code">generateResponse</code> to manage asynchronous workflows when dealing with external APIs.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the wisdom of stars forged in your mind and the dragon of analysis vanquished, the realm heralds your triumph, brave scholar‚Äîpress onward, for the kingdom&#39;s fate gleams brighter with every quest! ‚ö°‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>