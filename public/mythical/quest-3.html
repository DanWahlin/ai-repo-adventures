<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Legendary Scrolls - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Framework of Mythica</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Legendary Scrolls</h1>
<hr>
<p>In the enchanted kingdom of Mythica, you tread deeper into the mystical archives of the &quot;Code of Unity.&quot; Bound by spells of wisdom and imagination, it holds secrets that empower adventurers to create structured quests. However, rumor spreads of corrupted scrolls hidden deep within the artifact&#39;s essence, threatening to disrupt its magical balance. Your challenge is to analyze the core files and uncover the magic weaving through these scrolls. Only by solving its patterns can the kingdoms thrive with uninterrupted adventures.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scroll Validation Mysteries</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> ensure a smooth setup at the start of an adventure while handling multiple configurations?</li>
<li>‚ö° <strong>Weaving Magic Threads</strong>: How does <code class="inline-code">StoryGenerator.generateQuestContent</code> craft detailed quest stories by extracting scroll highlights and guiding themes?</li>
<li>üõ°Ô∏è <strong>Guarding Against Chaos</strong>: What role does <code class="inline-code">parseAdventureConfig</code> play in maintaining safe access and structured data for the quest configuration?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Adventure Initialization</h3>
<p>The <code class="inline-code">AdventureManager</code> is central to weaving the magic of quest creation and adventure flows. This file generates quests dynamically, validates adventure choices, and caches previously completed quests to optimize performance. By exploring <code class="inline-code">initializeAdventure</code>, you investigate how project information syncs with themes, config files, and scroll highlights, ensuring each adventure begins with complete harmony.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Sets up the adventure context by processing project information, themes, and additional config details. It‚Äôs vital for starting adventures correctly without missing scroll data.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Integrates config files with the generated quest structure and links scroll highlights with appropriate files.</li>
<li><code class="inline-code">executeQuest</code>: Handles the core logic for running a chosen quest, ensuring each scroll executes its intended magic seamlessly.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>This code initializes adventures by linking project data, themes, and configurations into the quest setup.</li>
<li>It synchronizes story generation with logical enforcement of quest count from configuration data.</li>
<li>Performance is optimized with modular generation to blend story with scroll combinations.</li>
<li>The encapsulated logic prevents corrupted or missing adventures while ensuring robust theme compatibility.</li>
<li>Observe the chained calls that flow from reset state to formatted quest output‚Äîeach weaving a magical quest seamlessly.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;
  
  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;
  
  // Create a map of quest titles to their file paths from the config
  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (filePaths.length &gt; 0) {
        configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
      }
    }
  }
  
  // Merge the files into the generated quests
  return quests.map((quest, index) =&gt; {
    // Primary matching: by quest order (index)
    const configQuests = adventure.quests;
    if (index &lt; configQuests.length &amp;&amp; configQuests[index] &amp;&amp; configQuests[index].files) {
      const files = configQuests[index].files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (files.length &gt; 0) {
        // Successfully matched files from config
        return { ...quest, codeFiles: files };
      }
    }
    
    // Fallback: try to match quest by title (case-insensitive partial match)
    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        // Successfully matched files via fallback
        return { ...quest, codeFiles: files };
      }
    }
    
    // No specific files found - quest will use general context
    return quest;
  });
}
</code></pre>
<ul>
<li>Merges magical quests with their associated scroll files by relying on structure from configurations.</li>
<li>Uses fallback logic to gracefully map titles or files if primary matching isn‚Äôt feasible.</li>
<li>Removes the possibility of mismatched quests due to file discrepancies.</li>
<li>This approach optimizes runtime flexibility while ensuring thematic correctness within the scroll framework.</li>
<li>Readers should notice how logic layers and fallback methods create resilience in merging files.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Scroll Highlight Extraction</h3>
<p>The <code class="inline-code">StoryGenerator</code> file crafts magical quests by integrating theme guidelines, scroll highlights, and project insights. By focusing on <code class="inline-code">generateQuestContent</code>, you unearth how story-specific code elements bind to themes, enabling seamless creation of mythical quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateQuestContent</code>: Transforms thematic guidelines and scroll highlights into detailed quest narratives. It ensures quests maintain both functionality and magical storytelling.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Extracts structured quest details from markdown responses, preserving mystical storytelling integrity.</li>
<li><code class="inline-code">removeLLMMetaCommentary</code>: Purifies structured outputs by isolating storytelling elements from unwanted LLM commentary.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n\n\nDo NOT include any conversational text outside the delimiters. Start the content immediately with the quest title.&#39;;

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST })
  );
  
  // Additional safety check - if markers are still present, remove them manually
  cleanContent = this.removeLLMMetaCommentary(cleanContent);
  
  return {
    adventure: cleanContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Enables magical quests by integrating code scrolls, theme guidelines, and content from <code class="inline-code">adventure.config</code>.</li>
<li>Enhances storytelling through layered prompts, ensuring narratives align with mythical vocabularies.</li>
<li>The structured handling of LLM responses binds scroll content to meaningful quests without errors.</li>
<li>This technique highlights the precise interplay between scroll files and adventurer paths in Mythica.</li>
<li>Readers should focus on modular handling of quests for reusability, showcasing robust patterns of magically woven adventures.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Config File Analysis</h3>
<p>This file safeguards the scroll repository, ensuring all paths are valid and configurations are unmarred by corruption. By studying <code class="inline-code">parseAdventureConfig</code>, adventurers will comprehend validation patterns crucial for scroll extraction.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Retrieves raw configurations for scroll validation. Its safe file reading prevents catastrophic failures.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Transforms raw JSON into structured configurations for quest creation while handling errors gracefully.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Ensures uniqueness in file references, maintaining an organized, corruption-free scroll repository.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Safeguards quests by validating JSON configurations and ensuring they remain unmarred during extraction.</li>
<li>Focuses on resilience to parsing errors, enabling adventurers to continue progress despite misconfigured scrolls.</li>
<li>Readers should observe how this function isolates logical fallbacks critical for mythical repository management.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tip for Mythical Adventures</strong>: Pay attention to the fallback logic, as resilience is key during quest execution.</li>
<li><strong>Exploration Recommendation</strong>: Analyze the layered narrative prompts to recreate the mythical storytelling magic.</li>
<li><strong>Next Steps</strong>: Use the insights from these spell files to bind additional creative components into future quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the enchanted land of Mythica. 
---END MARKDOWN---</p>
<p>Through the heroic might of your intellect and the guardianship of knowledge&#39;s sacred flame, you have triumphantly claimed the Legendary Scrolls, advancing deeper into the labyrinthine realms of wisdom‚Äîkeep shining as a star among questers! ‚≠ê ‚ö° üöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>