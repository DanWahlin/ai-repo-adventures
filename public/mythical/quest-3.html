<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle's Vision - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Kingdom of Code: An Enchanted Adventure</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle&#39;s Vision</h1>
<hr>
<p>In the heart of Codethia‚Äôs enchanted plains stands the Oracle‚Äôs Tower, a structure woven of shimmering glyphs and silver threads of magic. The Oracle resides here, a being who communes with the Book of Source itself. She has deciphered a mysterious ripple in the codex‚Äôs energies, revealing corrupted glyphs that could collapse Codethia‚Äôs logic-magic duality forever. To save the kingdom, she entrusts you with her vision‚Äîa quest to explore the sacred mechanics of analyzing and decoding patterns from fragmented spells.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Glyph Validation</strong>: How does <code class="inline-code">RepoAnalyzer</code> ensure that project paths and files are safeguarded against traversal or invalid entries?</li>
<li>‚ö° <strong>Oracle Insight</strong>: How does <code class="inline-code">RepoAnalyzer</code> generate optimized content focused on efficient and meaningful exploration?</li>
<li>üõ°Ô∏è <strong>Tower‚Äôs Defenses</strong>: How does <code class="inline-code">LLMClient</code> handle errors in LLM responses to prevent disruption in the magical codex?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Enchanted messaging between the kingdom and Codethia‚Äôs logic-magic bridge</h3>
<p>The Oracle‚Äôs conduit to the Book of Source relies on secure and intelligent mechanisms to process prompts and receive insights. <code class="inline-code">LLMClient</code> unites external constructs, including OpenAI‚Äôs enchanted frameworks, with adaptive techniques for dynamic interaction. This file unveils the critical spells governing prompt generation, configuration selection, and error handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.constructor</code>: Initializes the magical connection with the correct API settings, ensuring harmony between different enchanted realms (OpenAI and Azure).</li>
<li><code class="inline-code">LLMClient.generateResponse</code>: Evokes and processes logical-magic responses while preserving error debugging and validation.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Safeguards the codex by selecting appropriate access keys for the magical gateways.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Decoding fragmented glyphs within Codethia‚Äôs structure</h3>
<p><code class="inline-code">RepoAnalyzer</code>, akin to a mystical scribe, delves deep into Codethia‚Äôs corrupted fragments to uncover and transform essential rules. It validates paths, filters glyph corruption, and generates optimized insights through token-efficient analysis. By employing precautionary validations and enhanced security mechanisms, the analyzer ensures no vile energies escape containment.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.validateProjectPath</code>: Secures entry points by validating project paths with robust defense against null bytes and unsafe characters.</li>
<li><code class="inline-code">RepoAnalyzer.generateOptimizedContent</code>: Constructs refined spells that focus only on essential glyph connections to conserve magical energy.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code>: Channels large-scale enchanted outputs with strict memory protections and timeout controls.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;

    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model
      });
    } else {
      this.client = new OpenAI({
        apiKey,
        baseURL: LLM_BASE_URL
      });
    }
}
</code></pre>
<ul>
<li>Initializes communication between Codethia and external enchanted frameworks (OpenAI/Azure), ensuring compatibility.</li>
<li>Securely configures the API keys and base URLs to avoid configuration vulnerabilities.</li>
<li>Facilitates future adaptations by distinguishing between multiple magical gateways (OpenAI or Azure OpenAI).</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        let content = this.validateResponse(completion);

        if (options?.responseFormat === &#39;json_object&#39;) {
            content = this.cleanJsonResponse(content);
        }

        this.logTokenUsage(completion);
        return { content };
    } catch (error) {
        this.logDetailedError(error, prompt);
        const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
        throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<ul>
<li>Dynamically constructs magical responses based on input prompts and options for special Codethia-specific formats.</li>
<li>Includes defensive mechanisms like error logging and validation, improving fault resolution when glyph corruption disrupts.</li>
<li>Enhances debugging visibility with token usage logs, ensuring transparent functionality for long cascades.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
      if (!GITHUB_TOKEN) {
        throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
      }
      return GITHUB_TOKEN;
    }

    if (!LLM_API_KEY) {
      throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Validates and selects matching keys based on the provider type (OpenAI or GitHub-hosted Azure).</li>
<li>Differentiates access requirements for higher-security realms to prevent unauthorized entry.</li>
<li>Ensures completeness by enforcing key checks before the connection initiation.</li>
</ul>
<hr>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (!trimmedPath) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    if (trimmedPath.includes(&#39;\0&#39;)) {
        throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<ul>
<li>Executes rigorous validation to ensure integrity within Codethia‚Äôs project glyph pathways.</li>
<li>Prevents accidental introduction of corrupted characters such as null bytes or traversal symbols.</li>
<li>Supports fail-safe mechanisms by rejecting invalid entries early on, protecting the Oracle‚Äôs delicate spells.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);

    const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
    if (safeFiles.length === 0) {
        throw new Error(&#39;No valid target files found after validation&#39;);
    }

    const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }

    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);

    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
    return optimizedContent;
}
</code></pre>
<ul>
<li>Crafts refined glyph analyses tailored to focus upon vital parts of Codethia‚Äôs spells and avoiding fragmented inefficiency.</li>
<li>Integrates caching capabilities to maintain faster response times, preserving magical energy during repetitive tasks.</li>
<li>Introduces fail-safe caching and validation systems to ensure safe retrieval and analysis of glyph connections.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
        const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
        const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

        let stdout = &#39;&#39;;
        let stderr = &#39;&#39;;
        let isResolved = false;

        const timeout = setTimeout(() =&gt; {
            if (!isResolved) {
                repomix.kill(&#39;SIGTERM&#39;);
                setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
                isResolved = true;
                reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
            }
        }, REPOMIX_SUBPROCESS_TIMEOUT);

        repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
        repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });

        repomix.on(&#39;close&#39;, (code) =&gt; {
            if (!isResolved) {
                clearTimeout(timeout);
                isResolved = true;
                code === 0 ? resolve(stdout) : reject(new Error(`Repomix failed (exit ${code}): ${stderr}`));
            }
        });

        repomix.on(&#39;error&#39;, (error) =&gt; {
            if (!isResolved) {
                clearTimeout(timeout);
                isResolved = true;
                reject(new Error(`Repomix spawn failed: ${error.message}`));
            }
        });
    });
}
</code></pre>
<ul>
<li>Protects Codethia‚Äôs memory and resource limits while generating extensive glyph reads.</li>
<li>Includes advanced timeout mechanisms to shield against endless execution loops.</li>
<li>Makes use of safe subprocess handling to extract robust outputs while respecting Codethia‚Äôs defensive capabilities.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Investigate caching mechanisms in both files to preserve and optimize magical energy during analysis tasks.</li>
<li><strong>Exploration Recommendation</strong>: Focus on error handling patterns in <code class="inline-code">LLMClient</code> that address edge cases from external gateways or corrupted glyph responses.</li>
<li><strong>Next Steps</strong>: Look deeper into optimization functions (<code class="inline-code">extractFunctionFocusedContent</code>) from the analyzer in subsequent quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codethia‚Äôs enchanted systems.</p>
<p>With wisdom gleaned from the Oracle&#39;s Vision, you rise as a luminous hero, forging ahead through the realms of destiny‚Äîhail the 40% conquest of the legendary quest! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>