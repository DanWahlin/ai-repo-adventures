<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle‚Äôs Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Enchanted Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle‚Äôs Analysis</h1>
<hr>
<p>In the Kingdom of Codemyr, Queen Syntaxia has directed you to embark on a critical mission. The Repository Scroll, the enigmatic artifact that fuels the kingdom&#39;s magical infrastructure, grows restless. To comprehend its evolving intricacies, you must consult the Oracle of Constructs. She resides within the enchanted networks of Codemyr&#39;s analytical hub. The Oracle&#39;s wisdom lies within her spellbook‚Äìtwo sacred tomes: the <code class="inline-code">repo-analyzer.ts</code> manuscript and the <code class="inline-code">llm-client.ts</code> grimoire. These tomes detail how Codemyr&#39;s mystical tools analyze repositories and communicate with highly intelligent constructs beyond the kingdom. Your task is to decipher these scrolls and retrieve the essence of their magical workings to stabilize Codemyr.</p>
<p>Prepare yourself, Code Knight, for this shall test both your analytical prowess and your understanding of the surrounding enchantments! May your journey reveal the Oracle&#39;s intricate designs.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Path Validation Riddles</strong>: How does <code class="inline-code">RepoAnalyzer</code> ensure paths remain valid and secure during its operations?</li>
<li>‚ö° <strong>Invocation of Constructs</strong>: What patterns or methods does <code class="inline-code">LLMClient</code> use to summon and communicate with intelligent constructs, and how are requests dynamically shaped?</li>
<li>üõ°Ô∏è <strong>Safeguards of Execution</strong>: What techniques are employed in both <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code> to handle errors, timeouts, or unexpected conditions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repository Analysis Spellbook</h3>
<p>This file encapsulates the process of analyzing repository structures and generating optimized content for further consumption. At its core, the <code class="inline-code">RepoAnalyzer</code> Class acts as the kingdom&#39;s guide for traversing and preparing essential information. Methods within this class perform validations on paths, manage caching of results, and invoke external processes for generating repository context using the enchanted tool &quot;Repomix.&quot;</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Confirms the integrity and safety of the provided project path, preventing path traversal attacks and invalid inputs.</li>
<li><code class="inline-code">generateOptimizedContent</code>: Produces a purified output by extracting relevant functions, optimizing token usage, and caching results for efficiency.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes the mystical &quot;Repomix&quot; CLI, capturing its output with rigorous timeout and memory safeguards.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Validates input to ensure the project path is non-empty and free from harmful null bytes.</li>
<li>Protects against malformed inputs which may disrupt the kingdom&#39;s enchanted systems.</li>
<li>Serves as an essential barrier against accidental or targeted misuse.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);
    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
    return optimizedContent;
  } catch (error) {
    throw new Error(`Optimized content generation failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Builds an optimized representation of target files by first validating their safety.</li>
<li>Applies caching to minimize repeated processing, essential for large repositories.</li>
<li>Extracts function-focused content for more efficient token usage within the kingdom&#39;s magical constructs.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [
      ...directories,
      &#39;--stdout&#39;,
      &#39;--style&#39;, options.style || &#39;markdown&#39;
    ];

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    const timeout = setTimeout(() =&gt; {
      repomix.kill();
      reject(new Error(`Timeout after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; stdout += data.toString());
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; stderr += data.toString());
    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout);
      else reject(new Error(`Repomix failed (${code}): ${stderr}`));
    });
  });
}
</code></pre>
<ul>
<li>Executes the &quot;Repomix&quot; tool to generate repository context, ensuring timely execution with strict timeout handling.</li>
<li>Handles memory and processing safeguards to prevent resource exhaustion during invocation.</li>
<li>Facilitates communication between Codemyr&#39;s analyzers and the mystical components of Repomix.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Constructs Invocation Codex</h3>
<p>The <code class="inline-code">LLMClient</code> serves as the medium for summoning intelligent constructs residing within Codemyr&#39;s mystical network. It performs validation, dynamic request-building, and processing responses all while maintaining strict control over errors and timeouts. The constructs provide essential insights to power Codemyr&#39;s systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Builds and submits a prompt to the construct while applying validation and post-processing to its response.</li>
<li><code class="inline-code">constructor</code>: Configures the <code class="inline-code">LLMClient</code> with the appropriate API key and model provider for handling various constructs within the kingdom.</li>
<li><code class="inline-code">getApiKey</code>: Dynamically determines the correct API key for the constructs, ensuring compatibility with providers like OpenAI or Azure&#39;s mystical gateways.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Summons constructs with a dynamically configured <code class="inline-code">requestParams</code>, supporting advanced features like verbosity and reasoning effort.</li>
<li>Ensures post-processing, such as cleaning JSON responses from embedded markdown or logging token usage for transparency.</li>
<li>Implements detailed error-logging to safeguard Codemyr&#39;s systems against adverse scenarios.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, apiVersion: LLM_API_VERSION, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Initializes communication with the kingdom&#39;s constructs by setting the correct configuration for OpenAI or Azure-based gateways.</li>
<li>Dynamically adapts to the provider&#39;s requirements, ensuring compatibility and a seamless experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models.&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Chooses the appropriate key for communication with constructs based on the specified URL.</li>
<li>Differentiates between environments to ensure Codemyr&#39;s magical systems align with secure access requirements.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To unravel the Oracle‚Äôs secrets, observe how path validation in <code class="inline-code">RepoAnalyzer</code> guards against malicious usage.</li>
<li>Focus on how <code class="inline-code">generateResponse</code> adapts prompts dynamically based on model-specific requirements, enforcing intricate designs.</li>
<li>Reflect upon timeout handling and fault resilience in <code class="inline-code">captureRepomixStdout</code> and the <code class="inline-code">generateResponse</code> invocation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the Oracle‚Äôs foresight now woven into your tapestry of triumph, noble hero, your journey through the realms sparkles with wisdom as you ascend toward destiny‚Äôs radiant crown! ‚ö°üíéüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>