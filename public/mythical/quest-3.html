<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Quest Forge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Chronicles of Codeia</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Quest Forge</h1>
<hr>
<p>In the heart of Codeia lies the mystical Quest Forge, where coding adventures are forged into artifacts of wisdom. To mend the weakening threads of the <strong>Repository Grimoire</strong>, you must delve into the art of crafting quests for others who will continue your path. By exploring the inner mechanics of quest generation, you will gain the ability to weave tales that breathe life into the grimoire&#39;s logic and ensure the kingdom‚Äôs stability.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Forge Interpretation</strong>: How does the <code class="inline-code">AdventureManager.initializeAdventure</code> use the provided theme and project context to generate quests from the grimoire?</li>
<li>‚ö° <strong>Dynamic Blueprint</strong>: What patterns enable <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> to craft compelling storylines and align quests with the adventure theme?</li>
<li>üõ°Ô∏è <strong>Safety Enchantment</strong>: How does <code class="inline-code">parseAdventureConfig</code> ensure safe parsing of config files, even with errors or invalid data?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Overseeing Quest Creation</h3>
<p>This file houses the <code class="inline-code">AdventureManager</code>, a central class responsible for initiating adventures and managing quests. It bridges the gap between configuration files, project context, and quest narratives generated by the <code class="inline-code">StoryGenerator</code>. Key logic here maps user input, validates selections, and integrates adventure configurations into quest creation. By understanding its execution flow, adventurers will see how quests are dynamically aligned with project-based contexts to maintain thematic coherence.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Kicks off the journey by resetting state, deriving context, and generating themed quests using the <code class="inline-code">StoryGenerator</code>.</li>
<li><code class="inline-code">exploreQuest</code>: Executes a quest based on the adventurer‚Äôs choice, retrieving cached quest content or generating new adventures dynamically.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Combines quest files from <code class="inline-code">adventure.config.json</code> with LLM-generated quests for seamless integration of input data.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Crafting the Hero&#39;s Journey</h3>
<p>In the depths of this file lies the <code class="inline-code">StoryGenerator</code>, which wields the magic of AI to create elaborate quests. From extracting highlights in configuration files to shaping story chapters, it defines the narrative flow that adventurers experience within Codeia. This enchanting class combines theme-specific prompts, markdown parsing, and project analysis to deliver contextually relevant storylines and code-focused challenges.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Crafting overarching adventures and individual quests by combining project context with adventure themes.</li>
<li><code class="inline-code">generateQuestContent</code>: Builds detailed quest insights using markdown structure guided by specified files, themes, and LLM prompts.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Transforms LLM-provided markdown into structured story responses for quests, ensuring token validation and parsing accuracy.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Config as the Spellbook</h3>
<p>The spellbook guiding Codeia‚Äôs adventures lies in this file, which enables config file management for dynamic quest generation. Methods here validate data, extract unique file paths, and prepare lightweight versions of the config for AI-guided storytelling. Understanding these algorithms reveals how the <strong>Repository Grimoire</strong> connects external configurations to internal narratives.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Parses the raw adventure config file safely, handling errors gracefully to ensure stability.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Retrieves all valid file paths referenced in the adventure config, ensuring that only existing files are recognized.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Condenses config files into thematic summaries optimized for LLM-guided storytelling.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);

  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets all previous adventure state to prepare for a fresh journey.</li>
<li>Integrates story generation with configuration file validation to ensure quest relevance.</li>
<li>Smoothly aligns quests with the selected theme and enriches them using project-specific details.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Maps user input to quest discovery, handling invalid choices or progress requests.</li>
<li>Retrieves cached quests or dynamically generates new content, promoting efficiency and thematic consistency.</li>
<li>Ensures that every choice serves a purpose, whether completing a quest or tracking overall progress.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;
  
  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;
  
  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (filePaths.length &gt; 0) {
        configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
      }
    }
  }
  
  return quests.map((quest, index) =&gt; {
    const configQuests = adventure.quests;
    if (index &lt; configQuests.length &amp;&amp; configQuests[index] &amp;&amp; configQuests[index].files) {
      const files = configQuests[index].files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (files.length &gt; 0) {
        return { ...quest, codeFiles: files };
      }
    }

    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        return { ...quest, codeFiles: files };
      }
    }

    return quest;
  });
}
</code></pre>
<ul>
<li>Matches quests with their corresponding file references in the adventure configuration.</li>
<li>Balances user-provided config data with LLM-generated quests to ensure seamless integration.</li>
<li>Strengthens the adaptability of quests by accommodating both predefined and dynamic contexts.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Centralizes story generation by combining project-specific data with validated themes.</li>
<li>Utilizes LLM-based designs to create both broad story arcs and individual quest narratives.</li>
<li>Ensures that thematic direction aligns closely with the project and configuration details.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content...&#39;;

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST })
  );
  
  return { adventure: response.content.trim(), fileExploration: &#39;&#39;, codeSnippets: [], hints: [] };
}
</code></pre>
<ul>
<li>Builds detailed quests using theme-aware prompts and contextual project code snippets.</li>
<li>Refines LLM-generated content into markdown-suitable structures for educational storytelling.</li>
<li>Incorporates adventure configuration instructions for deeper thematic alignment.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);

  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];
  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};

  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      currentSection = token.depth === 1 ? &#39;story&#39; : token.text.toLowerCase();
    } else if (token.type === &#39;paragraph&#39; &amp;&amp; currentQuest.title) {
      currentQuest.description += token.text + &#39;\n\n&#39;;
    }
  }

  return { title, story: story.trim(), quests };
}
</code></pre>
<ul>
<li>Converts markdown responses from LLM into structured story and quest data.</li>
<li>Ensures robust handling of tokens for dynamic extraction of titles, storylines, and quest components.</li>
<li>Maintains thematic consistency by parsing markdown content into schema-validated objects.</li>
</ul>
<hr>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;

  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Converts raw configuration text into structured JSON objects.</li>
<li>Integrates error handling to ensure invalid or missing config files don‚Äôt disrupt quest generation.</li>
<li>Acts as a filtration layer, ensuring safe data manipulation.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (node?.path &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path.trim()))) {
      unique.add(node.path.trim());
    }

    Object.values(node || {}).forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Extracts file paths from all referenced configuration nodes, validating path existence.</li>
<li>Utilizes iterative stack-based exploration for comprehensive file path identification.</li>
<li>Ensures safe and accurate discovery of project-relevant files for quest integration.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  return adventure.quests
    .map(quest =&gt; `### ${quest.title}\nFiles: ${quest.files.map((f: any) =&gt; f.path).join(&#39;, &#39;)}\n\n`)
    .join(&#39;&#39;);
}
</code></pre>
<ul>
<li>Creates condensed summaries of configuration files ideal for LLM-guided narratives.</li>
<li>Focuses on relevant quest data while optimizing readability and thematic integration.</li>
<li>Removes redundant descriptions to ensure concise storytelling prompts.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üöÄ Leverage the AdventureManager to track how quests are synthesized across file structures.</li>
<li>üìò Examine how StoryGenerator validates theme adherence and aligns project data with quests.</li>
<li>üîì Unlock the utility of AdventureConfig by exploring its safe parsing and condensation techniques.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in the mythical kingdom of Codeia.</p>
<p>By the radiant light of the astral forge, you have wielded the wisdom of heroes and claimed triumph in Quest 3, blazing boldly through the mythical lands with valor‚Äî40% of your epic journey now shines like celestial diamonds! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>