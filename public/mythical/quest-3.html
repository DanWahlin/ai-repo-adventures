<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Wizardry of Codemiria's Counsel - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Codemiria</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Wizardry of Codemiria&#39;s Counsel</h1>
<hr>
<p>In the heart of the mythical land of Codemiria, whispers of an ancient and arcane council echo through the air. The Wizardry of Codemiria&#39;s Counsel is home to the most gifted architects of magical frameworks, their craft so precise it intertwines seamlessly with the kingdom&#39;s enchanted infrastructure. The artifacts of their wisdom‚Äîthe <code class="inline-code">LLMClient</code> and <code class="inline-code">RepoAnalyzer</code>‚Äîhold the keys to unlocking Codemiria&#39;s potential. Your task is to peer into the mystical scripts and discern the secrets fueling these enchanted constructs. Only by unraveling their essence can the kingdom progress in this grand transformation.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Channeling the Arcane</strong>: How does the <code class="inline-code">LLMClient</code> summon and configure its connection to external magical entities (APIs)?</li>
<li>‚ö° <strong>Flow of Mystical Energy</strong>: How does the <code class="inline-code">RepoAnalyzer</code> validate and orchestrate content paths for wizardry operations?</li>
<li>üõ°Ô∏è <strong>Safeguards of the Spellweave</strong>: What mechanisms are in place to ensure robust error handling during the operation of <code class="inline-code">LLMClient</code> and <code class="inline-code">RepoAnalyzer</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Enchanter‚Äôs Gateway</h3>
<p>The <code class="inline-code">LLMClient</code> is a spellbinding entity that bridges Codemiria to external dimensions of knowledge, represented as API interactions. Acting as a master of delegation, it weaves together user prompts and mystical responses based on personalized configurations. This client is critical to ensuring that all external communications are seamless, secure, and optimized for the council‚Äôs wisdom.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.constructor</code>: Initializes the client while determining the type of API and validating configurations such as <code class="inline-code">LLM_API_KEY</code> and <code class="inline-code">LLM_BASE_URL</code>.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Determines which mystical key (e.g., <code class="inline-code">LLM_API_KEY</code>, <code class="inline-code">GITHUB_TOKEN</code>) is needed to access the external knowledge realms.</li>
<li><code class="inline-code">LLMClient.generateResponse</code>: Creates a structured message request, fields external responses, validates the output, and handles format conversions.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">export class LLMClient {
  private client: OpenAI | AzureOpenAI;
  private model: string;

  constructor() {
    this.model = LLM_MODEL;
    
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model,
      });
    } else {
      this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
    }
  }
}
</code></pre>
<ul>
<li>Validates that essential configuration variables, such as <code class="inline-code">LLM_BASE_URL</code> and API keys, are present and accurate.</li>
<li>Implements modular handling for two providers (<code class="inline-code">OpenAI</code> and <code class="inline-code">AzureOpenAI</code>), allowing flexibility in magical protocols.</li>
<li>Differentiates between Azure and standard APIs for deployment efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
        throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Ensures security by dynamically selecting the correct API key based on the base URL.</li>
<li>Implements error handling to alert users of any missing values during setup.</li>
<li>Supports multiple access keys (<code class="inline-code">LLM_API_KEY</code>, <code class="inline-code">GITHUB_TOKEN</code>), emphasizing modularity and extensibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Handles key operational tasks such as generating API requests and managing responses.</li>
<li>Incorporates post-processing for specific formats (<code class="inline-code">json_object</code>), enhancing user utility.</li>
<li>Implements detailed error logging for debugging and robustness.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Pathbinder‚Äôs Chronicle</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is a vital component for navigating Codemiria&#39;s vast repository of magical scripts. By validating project paths, securing file integrity, and optimizing content generation, this artifact ensures that heroic quests are conducted efficiently and securely.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.validateProjectPath</code>: Ensures the sanctity of the provided project path through stringent validation.</li>
<li><code class="inline-code">RepoAnalyzer.generateTargetedContent</code>: Crafts optimized magical blueprints by validating target files and extracting only essential components.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code>: Harnesses external scripts to generate context for quests, while enforcing memory and timeout protections.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures the validity of the project path by checking for null bytes, empty strings, and invalid types.</li>
<li>Implements strict constraints to prevent filesystem errors and security vulnerabilities.</li>
<li>Encourages best practices in validating user input for critical operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);

  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedRepomixContent(projectPath, targetFiles, compress);
    this.cache.set(cacheKey, { content: fullContent, timestamp: Date.now() });
    return fullContent;
  } catch (error) {
    throw new Error(`Targeted content generation failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Validates user-provided file paths to ensure security and prevent unintended access.</li>
<li>Leverages caching to enhance performance during repeated operations.</li>
<li>Dynamically handles content within specified constraints (e.g., compression options).</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories], {
      cwd,
      stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
    });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
          resolve(stdout);
        } else {
          reject(new Error(`Repomix failed: ${stderr}`));
        }
      }
    });
  });
}
</code></pre>
<ul>
<li>Orchestrates an external command (<code class="inline-code">npx repomix</code>) to gather project insights while enforcing resource protections.</li>
<li>Mitigates risks such as excessive memory usage (<code class="inline-code">REPOMIX_MAX_BUFFER_SIZE</code>) and timeouts.</li>
<li>Provides robust subprocess error handling and graceful shutdown procedures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Consider tracing how <code class="inline-code">LLMClient</code> dynamically adjusts its behavior for different API systems based on the <code class="inline-code">isAzureOpenAI</code> function.</li>
<li>Follow the path of content generation in <code class="inline-code">RepoAnalyzer.generateTargetedContent</code> to see how files are validated, normalized, and transformed.</li>
<li>Pay close attention to how caching mechanisms improve efficiency across both classes.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the wisdom of Codemiria now woven into your spellbound arsenal, brave seeker, your journey blazes brighter‚Äîlet this victory thunder across the lands as a herald of the hero you are becoming! ‚ö°üíéüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>