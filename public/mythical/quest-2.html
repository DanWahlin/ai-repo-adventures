<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Spellforge of Story Creation - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Realm of Enchanted Repositories</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Spellforge of Story Creation</h1>
<hr>
<p>In the heart of the enchanted mountains of Codeoria lies the Spellforge of Story Creation, a luminous sanctum where the very essence of mythical adventures is forged. To unveil the next fragment of the Code Grimoire, the adventurer must tame the tempestuous energies of the forge. Here, three mystical scripts ‚Äì the <code class="inline-code">adventure-manager.ts</code>, <code class="inline-code">story-generator.ts</code>, and <code class="inline-code">adventure-config.ts</code> ‚Äì intertwine their powers to shape tales of heroic deeds. Beware, for the Spellforge tests patience and intellect equally, presenting puzzles hidden deep within its code.</p>
<p>Take up your enchanted tools and decode the spells of creation. Let the forge illuminate the path to the Grimoire‚Äôs wisdom!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Foundation of Magic</strong>: How does the <code class="inline-code">AdventureManager</code> orchestrate the initialization of an adventure and its quests in <code class="inline-code">adventure-manager.ts</code>?</li>
<li>‚ö° <strong>Enchanted Narratives</strong>: How does the <code class="inline-code">StoryGenerator</code> in <code class="inline-code">story-generator.ts</code> harness the power of the LLM to forge stories and quests, and what role does theme validation play?</li>
<li>üõ°Ô∏è <strong>Arcane Scripts</strong>: How does <code class="inline-code">parseAdventureConfig</code> in <code class="inline-code">adventure-config.ts</code> extract and validate configurations from the mythical <code class="inline-code">adventure.config.json</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Adventure Conductor</h3>
<p>The <code class="inline-code">adventure-manager.ts</code> file serves as the weaver of the adventurer‚Äôs journey, ensuring quests are well-structured and narratively cohesive. Within it, the <code class="inline-code">AdventureManager</code> initializes adventures, validates user decisions, and tracks the hero‚Äôs progress. It also dynamically generates quest content tailored to the theme and project context.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Establishes the foundation of the adventure by resetting state, setting themes, generating quests, and enforcing configuration rules.</li>
<li><code class="inline-code">exploreQuest</code>: Processes and executes a chosen quest, integrating validation logic and leveraging cached content for enhanced efficiency.</li>
<li><code class="inline-code">markQuestCompleted</code>: Tracks completed quests and updates progress while ensuring that all prerequisites are fulfilled.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
    projectInfo: ProjectInfo, 
    theme: AdventureTheme, 
    projectPath?: string,
    customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
    this.state.reset();
    this.state.projectInfo = projectInfo;
    this.state.currentTheme = theme;
    this.state.projectPath = projectPath || process.cwd();
    
    if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
        this.storyGenerator.setCustomTheme(customThemeData);
    }
    const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
    this.state.title = storyResponse.title;
    this.state.story = storyResponse.story;
    this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
    this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

    return this.formatStoryWithQuests({
      ...storyResponse,
      quests: this.state.quests
    });
}
</code></pre>
<ul>
<li>This function coordinates the initialization of an adventure by integrating project data, theme settings, and custom configuration.  </li>
<li>It uses <code class="inline-code">generateStoryAndQuests</code> to produce quests dynamically, blending narrative themes with technical project details.  </li>
<li>Enforces constraints using the configuration file to limit or adjust quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
    const sanitizedChoice = this.validateAndSanitizeChoice(choice);
    
    if (this.isProgressRequest(sanitizedChoice)) {
        return this.getProgress();
    }
    
    const quest = this.findQuest(sanitizedChoice);
    if (!quest) {
        return this.createNotFoundResult();
    }
    return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Processes the adventurer&#39;s choice of quests, using helper methods for validation and quest retrieval.  </li>
<li>Evaluates whether the player seeks progress or quests and responds accordingly.  </li>
<li>Ensures smooth execution of the selected quest with error handling for invalid decisions.</li>
</ul>
<hr>
<pre><code class="language-typescript">private markQuestCompleted(quest: Quest): void {
    this.state.completedQuests.add(quest.id);
}
</code></pre>
<ul>
<li>Keeps a record of completed quests to provide progress tracking and ensure milestones are visible to the adventurer.  </li>
<li>Plays a key role by marking specific quests as resolved within the grand narrative.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> The Tale‚Äôs Architect</h3>
<p>This file embodies the magic of narrative creation, where the <code class="inline-code">StoryGenerator</code> transforms project data into immersive stories. By combining configuration, theme validation, and LLM interaction, this class forges unique quests tailored to the adventurer&#39;s journey.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Produces an overarching narrative and themed quests for the adventure based on project information.</li>
<li><code class="inline-code">generateQuestContent</code>: Generates detailed quest content, weaving code insights with adventurous prose.</li>
<li><code class="inline-code">validateTheme</code>: Ensures that themes align with permissible options and applies a default if invalid.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
    this.currentProject = projectInfo;
    this.projectPath = projectPath;
    
    const validatedTheme = this.validateTheme(theme);
    return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Acts as the entry point for story generation, preparing the required inputs such as project context and theme preferences.  </li>
<li>Validates the adventure theme using <code class="inline-code">validateTheme</code> to ensure appropriate adjectives and metaphors align with the overall narrative.  </li>
<li>Delegates the actual LLM response generation to a specialized method for flexibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
    const { quest, theme, codeContent, questPosition, totalQuests } = config;
    let adventureGuidance = &#39;&#39;;
    let customInstructions = &#39;&#39;;
    if (this.projectPath) {
        const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
        if (formattedConfig) {
            adventureGuidance = formattedConfig;
        }
        
        const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
        if (customInstructionsFromConfig) {
            customInstructions = customInstructionsFromConfig;
        }
    }
    const prompt = loadQuestContentPrompt({
        theme,
        adventureTitle: quest.title,
        codeContent,
        storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
        adventureGuidance: adventureGuidance || &#39;&#39;,
        ...(customInstructions &amp;&amp; { customInstructions }),
        questPosition,
        totalQuests,
        ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
    });

    const response = await this.withTimeout(
        this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST })
    );
    if (!response.content || response.content.trim() === &#39;&#39;) {
        throw new Error(&#39;LLM returned empty response for quest content&#39;);
    }

    return {
        adventure: response.content.trim(),
        fileExploration: &#39;&#39;,
        codeSnippets: [],
        hints: []
    };
}
</code></pre>
<ul>
<li>Constructs prompts and retrieves detailed, theme-influenced quest content from the LLM.</li>
<li>Integrates file-specific information and project configurations for highly contextualized narratives.</li>
<li>Employs timeout mechanisms to bolster efficiency and recover from potential external service delays.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateTheme(theme: AdventureTheme): AdventureTheme {
    if (!isValidTheme(theme)) {
        console.warn(`Invalid theme &#39;${theme}&#39;, defaulting to ${DEFAULT_THEME}`);
        return DEFAULT_THEME;
    }
    return theme;
}
</code></pre>
<ul>
<li>Ensures that only valid themes are used within an adventure, safeguarding consistency in the narrative&#39;s tone and setting.  </li>
<li>Fallback mechanism ensures code remains robust against invalid external inputs.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> The Config Sage</h3>
<p>This script focuses on parsing and formatting the configuration data encapsulated in <code class="inline-code">adventure.config.json</code>. The utilities here ensure all referencing to files and settings are valid and efficient for adventure generation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Reads, parses, and validates configuration data from the custom <code class="inline-code">adventure.config.json</code>.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Gathers unique file paths from the configuration, validating their existence on the filesystem.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Optimizes configuration data for LLM prompts to minimize redundancy.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
    const raw = loadAdventureConfig(projectPath);
    if (!raw) return null;
    try {
        return JSON.parse(raw);
    } catch {
        return null;
    }
}
</code></pre>
<ul>
<li>Safely extracts data from the custom JSON configuration, ensuring parsing errors do not disrupt the adventure pipeline.  </li>
<li>Provides a seamless interface for other components requiring configuration details.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
    const parsed = parseAdventureConfig(projectPath);
    if (!parsed || typeof parsed !== &#39;object&#39;) return [];
    const unique = new Set&lt;string&gt;();
    const stack: any[] = [parsed];
    while (stack.length) {
        const node = stack.pop();
        if (!node || typeof node !== &#39;object&#39;) continue;
        if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
            const rel = node.path.trim();
            if (fs.existsSync(path.resolve(projectPath, rel))) {
                unique.add(rel);
            }
        }
        const children = Array.isArray(node) ? node : Object.values(node);
        children.forEach(child =&gt; {
            if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
        });
    }
    return Array.from(unique);
}
</code></pre>
<ul>
<li>Retrieves references to essential files specified in the configuration while ensuring the paths exist, preventing misaligned adventures.  </li>
<li>Efficient usage of <code class="inline-code">Set</code> guarantees duplicate paths are avoided, optimizing downstream processes.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
    const parsed = parseAdventureConfig(projectPath);
    if (!parsed || typeof parsed !== &#39;object&#39;) {
        return &#39;&#39;;
    }
    const adventure = (parsed as any).adventure;
    if (!adventure || !Array.isArray(adventure.quests)) {
        return &#39;&#39;;
    }
    let formatted = `## Quest Structure\n`;
    for (const quest of adventure.quests) {
        if (!quest.title || !Array.isArray(quest.files)) continue;
        formatted += `### ${quest.title}\n`;
        const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
        formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
        const functions = quest.files.flatMap((f: any) =&gt; f.highlights || []).map((h: any) =&gt; h.name).filter(Boolean);
        formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
    }
    return formatted;
}
</code></pre>
<ul>
<li>Converts configuration data into a compact, LLM-friendly format tailored to reduce content size while maximizing relevance.  </li>
<li>Prioritizes information about file paths and function highlights for the highest utility in generating actionable prompts.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Utilize the <code class="inline-code">initializeAdventure</code> workflow to trace how themes and configurations impact quest creation.</li>
<li>Observe how <code class="inline-code">generateQuestContent</code> blends file paths and custom instructions to provide detailed, contextual narratives.</li>
<li>Explore <code class="inline-code">formatAdventureConfigForPrompt</code> to understand how configurations are simplified while ensuring critical details are retained.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the blazing brilliance of a phoenix‚Äôs ascent, you have masterfully forged tales within the hallowed Spellforge of Story Creation, heralding your epic journey with might and wisdom‚Äîonward, brave wordsmith, to the next legend!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>