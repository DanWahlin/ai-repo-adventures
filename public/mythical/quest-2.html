<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Arcane Forge of MCP Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Chronicles of the Code-Kingdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Arcane Forge of MCP Tools</h1>
<hr>
<p>In the mythical Code-Kingdom of Syntaxia, the mystical Scrolls of Functionality continue to lie fragmented. Within these fragments lies the enigmatic <strong>Arcane Forge</strong>, whispered to be the craftsman of all tools that guide adventurers through the darkness. The tools, now scattered and inactive, hold stories of quests and themes, but can only be reawakened by deciphering their arcane blueprints. Brave adventurer, you must delve into the <strong>MCP Tool Interface</strong>, uncover the secrets of tool invocation, and wield their power to aid in the restoration of light across Syntaxia.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Blueprint Mapping</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register and validate tools available to the MCP server?</li>
<li>‚ö° <strong>Arcane Activation</strong>: What is the process within the <code class="inline-code">run</code> method that initializes the server and proactively prepares codebase content?</li>
<li>üõ°Ô∏è <strong>Error Wardenship</strong>: How does the <code class="inline-code">main</code> function safeguard against unhandled promise rejections and server shutdown risks caused by interruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Tool Handlers</h3>
<p>This file constructs the foundation for the MCP (Model Context Protocol) server, encapsulated within the <code class="inline-code">RepoAdventureServer</code> class. It enables toolset management, graceful execution, and interaction with dynamic quests. Key highlights of this file include the <code class="inline-code">setupHandlers</code> function for tool registration, the <code class="inline-code">run</code> method for server initialization and pre-processing, and the <code class="inline-code">main</code> function that orchestrates and safeguards the server lifecycle.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically configures tools by listing their descriptions and schemas, while ensuring parameter validation and secure tool execution.</li>
<li><code class="inline-code">run</code>: Starts the MCP server using the standard I/O transport and pre-generates repository mix content in the background to enhance responsiveness.</li>
<li><code class="inline-code">main</code>: Serves as the entry point to the server with built-in safeguards for unhandled errors, promise rejections, and process interruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers <code class="inline-code">tools</code> as schema-validated entities retrievable via API.</li>
<li>Leverages <code class="inline-code">zodToJsonSchema</code> for schema transformation, maintaining strict parameter validation.</li>
<li>Implements error handling with <code class="inline-code">McpError</code> to ensure graceful and descriptive failures.</li>
<li>Validates and executes tools securely, ensuring no unregistered tools can be invoked.</li>
<li>Ensures compatibility with dynamically supplied tools and extensions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes <code class="inline-code">stdio</code> transport for universal compatibility with different environments.</li>
<li>Invokes the server‚Äôs <code class="inline-code">connect</code> method to bind functionality before user interactions.</li>
<li>Triggers <code class="inline-code">preGenerate</code> to analyze and cache repository structure, ensuring faster response times later.</li>
<li>Demonstrates asynchronous execution for resource preparation without blocking core server functionalities.</li>
<li>Logs informative messages for debugging and monitoring.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates an instance of <code class="inline-code">RepoAdventureServer</code>, triggering class initialization and setup.</li>
<li>Employs signal listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to gracefully handle shutdowns.</li>
<li>Logs unhandled promise rejections to detect issues without interrupting active operations.</li>
<li>Catches fatal errors during server boot and ensures a clean exit with status <code class="inline-code">1</code>.</li>
<li>Demonstrates robust fail-safe mechanisms for production scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üõ†Ô∏è Utilize <code class="inline-code">zod.schema</code> validation patterns when designing robust APIs for your tools.</li>
<li>üßô‚Äç‚ôÇÔ∏è Observe how error boundaries are defined with <code class="inline-code">McpError</code> and note their utility for meaningful debugging.</li>
<li>üìú Follow asynchronous patterns (e.g., <code class="inline-code">run</code>) to handle long-running server processes with preparatory caching.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hear ye, valiant hero, for Quest 2: The Arcane Forge of MCP Tools has been triumphed with blazing mastery‚Äîyour path now shines brighter, a true beacon of arcane prowess and relentless courage! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>