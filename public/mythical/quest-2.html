<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository of Living Quests</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest Generation Engine</h1>
<hr>
<p>In the jade-lit halls of the Codekeep, quills of living oak inscribe destinies from raw repositories. The <code class="inline-code">AdventureManager</code> is the quest marshal, binding tales to law and guiding heroes through sanctioned paths. The <code class="inline-code">StoryGenerator</code> is the mystic scribe, coaxing sagas from arcane prompts with time wards and theme sigils. And etched upon a granite lectern rests <code class="inline-code">adventure-config.ts</code>, a charter whose runes decide which scrolls and highlights are worthy. Step forth, champion, and read the spells that birth adventures from code.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Rune Concordance: How does <code class="inline-code">AdventureManager.initializeAdventure</code> merge adventure-config runes with generated quests, and what happens when the config defines fewer quests than the LLM?</li>
<li>‚ö° Scribe‚Äôs Channeling: In <code class="inline-code">StoryGenerator.generateQuestContent</code>, how are prompts assembled from <code class="inline-code">formatAdventureConfigForPrompt</code> and <code class="inline-code">extractCustomInstructions</code>, and what fallback cleansing occurs when delimiters are missing?</li>
<li>üõ°Ô∏è Ward of Constraints: How does <code class="inline-code">AdventureState.progressPercentage</code> quantify progress, and how do <code class="inline-code">AdventureManager.exploreQuest</code> and its helpers guard against invalid choices while supporting cached revisits?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The quest marshal that initializes sagas, merges config-guided files, enforces quest counts, validates choices, executes quests, and tracks progress</h3>
<p>Within these keeps, <code class="inline-code">AdventureManager</code> orchestrates the lifecycle from story birth to quest completion. <code class="inline-code">initializeAdventure</code> resets state, binds theme, and invokes the <code class="inline-code">StoryGenerator</code> to weave a canonical story. Crucially, it aligns generated quests with project law via <code class="inline-code">mergeQuestFilesFromConfig</code> and trims surplus via <code class="inline-code">enforceConfigQuestCount</code>, ensuring lore matches the <code class="inline-code">adventure.config.json</code> charter. The <code class="inline-code">exploreQuest</code> path sanctifies user choices with <code class="inline-code">validateAdventureChoice</code>, recognizes progress requests through <code class="inline-code">isProgressRequest</code>, and resolves quests by number, id, or title (even stripping heraldic emojis). When executing, the marshal favors cached scrolls for completed quests, embeds revisit markers, and otherwise consults the scribe for new content and a completion summary. Error wards ensure a project and theme exist before casting LLM spells. Progress is tallied with <code class="inline-code">AdventureState.progressPercentage</code>, and listings adorn completed quests with checkmarks while preserving number order. The design emphasizes reliable flow, bounded by config rules, and reusability through caching and helper segmentation. Investigate how file lists from config override or augment generated quests, how truncation is decided by config lengths, and how formatted outputs shape the adventurer‚Äôs choices and narrative return.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code> sets context, generates a story and quests, merges file paths from config, enforces quest counts, and formats the opening narrative with choices.</li>
<li><code class="inline-code">exploreQuest</code> validates the adventurer‚Äôs choice, supports progress viewing, resolves quests by number/id/title, and executes the chosen quest with caching and summaries.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code> computes journey completion as a percentage of finished quests against the total, guiding progress messages and choice adornments.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Initializes the saga: resets state, binds theme and path, and optionally sets custom theme data.</li>
<li>Invokes <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> to obtain canonical story and quests.</li>
<li>Integrates <code class="inline-code">adventure.config.json</code> by merging file paths into quests and enforcing quest count limits.</li>
<li>Returns a formatted opening narrative including quest listings.</li>
<li>Demonstrates configuration-driven control layered atop LLM-generated content.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates and sanitizes user input via <code class="inline-code">validateAdventureChoice</code>.</li>
<li>Supports progress view detection ahead of quest resolution.</li>
<li>Resolves a quest by multiple identifiers and handles not-found with guided choices.</li>
<li>Delegates execution to a dedicated method that handles caching, generation, and summaries.</li>
<li>Encapsulates user-driven flow with protective gates and clear outcomes.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Defines <code class="inline-code">AdventureState.progressPercentage</code> as a computed getter bridging state to UI messaging.</li>
<li>Uses safe division with empty-quest handling to avoid invalid arithmetic.</li>
<li>Rounds to whole numbers for clean status displays.</li>
<li>Centralizes progress math to avoid duplication and drift.</li>
<li>Enables consistent progress reporting across views and summaries.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n

Huzzah, valiant hero‚Äîby forging the Quest Generation Engine of Quest 2, you have etched runes of mastery upon the kingdom‚Äôs codex and advanced your saga to 1/5 quests (20% complete), a radiant milestone worthy of laurels and legend!
</code></pre>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>