<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Tome of the Mystic Knights - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository of Code Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Tome of the Mystic Knights</h1>
<hr>
<p>In the mythical Kingdom of Codexia, the air carries tales of brave seekers who decoded the arcane mechanisms hidden within enchanted scrolls to shape legendary adventures. Your journey now brings you before the revered Tome of the Mystic Knights, guarded by lines of runes and locks of logic. Within this quest, you must unravel the secrets of the powerful MCP Tool Interface, a magical construct that facilitates the creation of immersive tales. Your task is to delve into its foundations, uncover its mechanics, and prepare for future challenges.</p>
<p>Beware, bold adventurer, for enchanted scripts weave intricate threads, and only those with clarity of mind may prevail. May your courage hold firm as you decode the magic!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Rituals</strong>: How does the <code class="inline-code">RepoAdventureServer</code> dynamically list and execute tools, and what validation protects the magical process?</li>
<li>‚ö° <strong>Flow of Enchantment</strong>: How do <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code> ensure the MCP Tool Interface runs smoothly and responds to quests intelligently?</li>
<li>üõ°Ô∏è <strong>Error Warding</strong>: What error-handling mechanisms keep the system from breaking under unexpected invocation requests or tool failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The MCP Tool Interface Orchestrator</h3>
<p>The <code class="inline-code">server.ts</code> file defines the <code class="inline-code">RepoAdventureServer</code> class, responsible for managing the MCP server. This enchanted construct ensures that tools are dynamically listed, their inputs validated, and handlers configured for seamless workflow. The <code class="inline-code">run</code> method connects the magical threads of the system, while <code class="inline-code">main</code> initiates the entire process and safeguards against critical failures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically sets handlers for listing tools and executing them with robust validation using schemas.</li>
<li><code class="inline-code">run</code>: Establishes the server&#39;s connection while pre-generating cached files to enhance performance during quests.</li>
<li><code class="inline-code">main</code>: Acts as the central entry point, orchestrating the initialization and ensuring resilience with graceful shutdowns and error management.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers two handlers: one for listing available tools (<code class="inline-code">ListToolsRequestSchema</code>) and another for executing specific tools (<code class="inline-code">CallToolRequestSchema</code>).</li>
<li>Zod schemas ensure that all inputs to the tools are validated before execution, protecting the server from invalid or malformed requests.</li>
<li>The structure provides clear and specific error messaging to guide users or developers towards resolving issues efficiently.</li>
<li>By separating tool validation and execution, the system achieves modularity and robustness in handling quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> function prepares the server by establishing a standard input/output transport connection.</li>
<li>Background cache pre-generation (<code class="inline-code">repoAnalyzer.preGenerate</code>) optimizes the system for faster quest responses while reducing latency during exploration.</li>
<li>The design ensures non-blocking operations, allowing adventurers to initiate commands while pre-processing continues.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function acts as the starting point of the server, initializing the <code class="inline-code">RepoAdventureServer</code> and ensuring the interface remains operational despite runtime errors.</li>
<li>It captures system signals (e.g., <code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to execute a controlled shutdown process using the <code class="inline-code">gracefulShutdown</code> function.</li>
<li>An error logging mechanism for <code class="inline-code">unhandledRejection</code> ensures visibility into issues without interrupting critical operations.</li>
<li>This resilience and fault tolerance are crucial for managing multiple quests concurrently without disrupting adventurers.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Mystic Arsenal</h3>
<p>This file serves as the registry of all available tools within the MCP Tool Interface. It exports critical functionalities, such as initializing adventures and tracking progress, and maintains a centralized configuration of tools for easy management and scalability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Kicks off the journey by analyzing the codebase and invoking initial quest setup routines.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows adventurers to select an adventure theme, tailoring the experience to their preferences.</li>
<li><code class="inline-code">explore_quest.handler</code>: Provides the mechanisms to investigate and decode specific quests dynamically.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks adventurers&#39; progress across quests and informs them of their current standing.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Pay attention to how <code class="inline-code">setupHandlers</code> separates concerns between validation and execution for better error recovery.</li>
<li><strong>Exploration Recommendation</strong>: Look deeper into how the <code class="inline-code">tools</code> objects are structured in <code class="inline-code">tools.ts</code> to understand how modularity enables scalability.</li>
<li><strong>Next Steps</strong>: Once you‚Äôve uncovered the secrets of the MCP Tool Interface, move forward to understand the quest generation system and unlock richer adventures.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the radiance of the celestial stars and the valor of a true seeker, you have unearthed the sacred Tome of the Mystic Knights‚Äîyour epic journey is ignited, noble hero, with 20% of your legend already forged! ‚ö°üëÅÔ∏è‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>