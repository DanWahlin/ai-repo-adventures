<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Knights of the MCP Citadel - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Chronicles of Codeia</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Knights of the MCP Citadel</h1>
<hr>
<p>As you traverse the labyrinthine corridors of Castle Codeia, you arrive at the towering gates of the legendary MCP Citadel. It is here that the Knights of MCP guard the sacred pathways through which spells of exploration are cast. These knights, known as the codemasters, hold the knowledge to summon and wield enchanted tools that breathe life into dormant codebases. But dark magics threaten their order‚Äîkey rites have become erratic, and ancient safeguards falter. It is your quest to restore their sacred ceremonies by delving deep into the mystic scrolls of <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>. Will you take up the mantle and mend the Citadel&#39;s rites?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Summoning Rites</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically list and validate tools before invoking them?</li>
<li>‚ö° <strong>Citadel Rituals</strong>: What strategies are employed by the <code class="inline-code">run</code> function to initialize the server and handle background preparation?</li>
<li>üõ°Ô∏è <strong>Safeguards for the Enchanted Glyphs</strong>: How does the <code class="inline-code">CallToolRequestSchema</code> handler validate input parameters to maintain the integrity of the codebase spells?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Central MCP Command</h3>
<p>The <code class="inline-code">server.ts</code> script is the lifeblood of the MCP Citadel. This file defines and orchestrates the server that powers the entire tool interface. At its heart, the <code class="inline-code">RepoAdventureServer</code> class takes responsibility for invoking the enchanted tools registered in <code class="inline-code">tools.ts</code>. The server dynamically lists the tools and validates their input to ensure seamless tool invocation. Key features include graceful shutdown rituals, caching pre-generation for enhanced performance, and robust error handling to prevent interruptions in the sacred ceremonies.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This function binds handlers for listing and invoking tools. It ensures that each tool has its schema converted into JSON for validation and also processes execution requests.</li>
<li><code class="inline-code">run</code>: This function activates the MCP server using <code class="inline-code">StdioServerTransport</code>. It also triggers the pre-generation of repository content to optimize user experience during exploration.</li>
<li><code class="inline-code">main</code>: The starting point of the program, ensuring the server is initialized correctly and equipped to handle unexpected interruptions or errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues
          .map((err) =&gt; `${err.path.join(&#39;.&#39;)}: ${err.message}`)
          .join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li><strong>Purpose</strong>: This code registers handlers for tool listing and execution. It ensures tools are described dynamically and validates execution parameters using schemas.</li>
<li><strong>Patterns</strong>: Dynamic object mapping and validation using JSON schemas highlight modularity and strict typing benefits.</li>
<li><strong>Error Handling</strong>: By distinguishing between MCP errors and unexpected issues, the function protects the server&#39;s stability.</li>
<li><strong>Importance</strong>: This guarantees only legitimate tools and valid inputs can invoke system functionality.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li><strong>Initialization</strong>: Starts the MCP server and sets up communication via <code class="inline-code">StdioServerTransport</code>.</li>
<li><strong>Background Tasks</strong>: By pre-generating repository content, it minimizes delays during runtime requests.</li>
<li><strong>Design Insight</strong>: Decoupling pre-generation logic from main operations ensures responsiveness and user experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; process.on(sig as NodeJS.Signals, gracefulShutdown));
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li><strong>Primary Role</strong>: Bootstraps the MCP server and prepares it for signal interruptions or unhandled promise rejections.</li>
<li><strong>Robustness</strong>: Centralizes error handling for critical startup failures, preserving system integrity.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Enchanted MCP Utilities</h3>
<p>This file defines the tools of the MCP Citadel. Each tool represents a bespoke enchantment for exploring and managing code. The tools are modular, with handlers that define their specific magical functionality. The <code class="inline-code">tools</code> object aggregates these enchantments for server registration and dynamic invocation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Begins an adventure by analyzing the codebase, setting the stage for exploration.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows users to select a narrative theme, customizing the quest experience.</li>
<li><code class="inline-code">explore_quest.handler</code>: Unlocks individual quests, enabling focused exploration on selected topics.</li>
<li><code class="inline-code">view_progress.handler</code>: Reveals the adventurer‚Äôs current status, showing completed and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li><strong>Encapsulation</strong>: Simplifies export and registration by unifying all tools into a single object.</li>
<li><strong>Dynamic Handling</strong>: Facilitates dynamic referencing and invocation via <code class="inline-code">server.ts</code>.</li>
<li><strong>Ease of Maintenance</strong>: Modular design ensures each tool can evolve independently while remaining cohesive.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tool Management</strong>: Pay close attention to how schemas are used for validation in <code class="inline-code">setupHandlers</code>. This is a key concept for ensuring tool reliability.</li>
<li><strong>Error Logs</strong>: The server logs are your guide when debugging tool execution errors during runtime.</li>
<li><strong>Cohesion</strong>: Notice how <code class="inline-code">tools.ts</code> and <code class="inline-code">server.ts</code> interact‚Äîtheir coordination is vital for system functionality.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With courage forged in starlight and wisdom tempered by ancient scrolls, you have vanquished the trials of the MCP Citadel, earning your place among the legendary champions‚Äîonward, victorious hero, for the realm awaits your continued glory! ‚ö°üëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>