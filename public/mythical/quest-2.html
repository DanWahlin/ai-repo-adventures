<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Mystic Tools of the MCP Keep - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic Tools of the MCP Keep</h1>
<hr>
<p>In the heart of the enchanted MCP Keep lies a repository of ancient tools, guarded by the mystical energies of the adventurer&#39;s code. These tools are the domain of Codethra‚Äôs digital artificers, designed to wield the Book of Adventures itself. However, the Keep has been silenced by corrupted handlers, leaving the tools inert. To awaken Codethra‚Äôs legendary power, you must decipher the spells within the Keep‚Äôs structured scripts and understand the incantations that unite these relics to their purpose. Will you unlock their potential, brave soul?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Invocation Mysteries</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register and validate tools in the MCP system?</li>
<li>‚ö° <strong>Server Awakening</strong>: What process does <code class="inline-code">run</code> follow to initialize the MCP keep and prepare the tools for activation?</li>
<li>üõ°Ô∏è <strong>Resilience Charms</strong>: How does <code class="inline-code">main</code> ensure graceful handling of errors, signals, and unexpected interruptions during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The Server of the Mystic Keep</h3>
<p>This file contains the foundation of the MCP server, designed to facilitate interaction with the tools in the Keep. The <code class="inline-code">RepoAdventureServer</code> centralizes the logic for initializing, validating, and executing tools. It offers dynamic capabilities such as listing all available tools and invoking them based on client requests. Essential functions like <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code> bring the MCP Keep to life. Each of these plays a key role in ensuring the tools are both accessible and secure.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic handlers for listing and calling tools in the MCP. Validates inputs using schemas to ensure all invocations are safe.</li>
<li><code class="inline-code">run</code>: Bootstraps the MCP server using a transport layer and performs preliminary setup tasks, including caching operations to improve tool response time.</li>
<li><code class="inline-code">main</code>: Acts as the entry point, handling error scenarios, signal interruptions, and unexpected promise rejections with resilience.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps over <code class="inline-code">tools</code> to produce a structured tool list with descriptions and input schemas rendered as JSON.</li>
<li>Validates tool arguments using Zod schema, ensuring that only properly formatted inputs are processed.</li>
<li>Provides robust error handling through the <code class="inline-code">McpError</code> class, gracefully handling issues such as invalid parameters or tools not found.</li>
<li>Prevents unexpected crashes by isolating error scenarios during execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server communication via <code class="inline-code">StdioServerTransport</code>, enabling bidirectional interchange with the MCP tool interface.</li>
<li>Provides logging to track server readiness, ensuring adventurers know when the MCP is operational.</li>
<li>Utilizes <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize performance by warming up the tool‚Äôs cache, reducing delays in client interactions.</li>
<li>Sets up the groundwork for the dungeon-like &quot;repomix&quot; content, necessary for smooth adventuring.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the MCP server by creating an instance of <code class="inline-code">RepoAdventureServer</code>, anchoring the entire Keep&#39;s operations.</li>
<li>Detects and gracefully handles process termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to allow for proper cleanup.</li>
<li>Ensures resilience by logging unhandled promise rejections rather than crashing the process, maintaining operational continuity.</li>
<li>Safeguards the startup process with a try-catch block to capture and handle critical failures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure your tools meet the expected schema structure when handling client requests.</li>
<li>Familiarize yourself with Zod validation techniques for both static and dynamic use cases.</li>
<li>Review error logs carefully when developing new tools to integrate seamlessly with the server runtime.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Huzzah, valiant scholar! Through wit and will, you have claimed the Mystic Tools of the MCP Keep, illuminating the first star on your legendary quest-map‚Äîforge onward to eternal glory! ‚≠ê‚öîÔ∏è‚ú®</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>