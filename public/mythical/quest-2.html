<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Mystic Guildhall - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Framework of Mythica</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic Guildhall</h1>
<hr>
<p>In the kingdom&#39;s ancient heart, where the gilded spires of the Mystic Guildhall touch the enchanted skies, lies the nerve center for crafting magical quests and decoding ancient wisdom. The Code of Unity here springs to life, ensuring harmony across all realms. Yet, to shield its secrets from lurking shadows, you must investigate the guild&#39;s inner workings. Explore the spellcraft of tools, the mystical transport used by guild scribes, and the intelligent protocols that keep the kingdom&#39;s grand quests fluid and vibrant.</p>
<p>Your journey into the Guildhall&#39;s magical depths begins here, brave seeker!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Alchemy</strong>: How does the server dynamically list and validate the tools available for adventurers?</li>
<li>‚ö° <strong>Guild Transport Magic</strong>: What process does the guild use to establish a connection with adventurers and handle their requests?</li>
<li>üõ°Ô∏è <strong>Error Wardings</strong>: How does the system safeguard its function against missteps, such as invalid tools or internal errors, to maintain harmony?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Mystic Transport</h3>
<p>This enchanted file represents the transport skeleton of the guild, responsible for handling incoming adventurer queries, validating their intentions, and relaying requests to the repository&#39;s secrets. The <code class="inline-code">RepoAdventureServer</code> class is the centerpiece, combining transport spells with handlers for magical tools. Its design ensures that only valid invocations are carried out, aligning appropriate tools with their mystical schemas while shielding the guildhall against chaos.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: These spells construct the framework for listing tools dynamically and validating adventurer inputs.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: The gateway spell that activates the enchanted server, preparing the guildhall for connections and caching pivotal content in the background.</li>
<li><code class="inline-code">main</code>: The summoning sequence that initiates the server and protects the guild from interruptions or rogue errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically discovers tools and maps their schemas using Zod for JSON validations, making the system flexible and robust.</li>
<li>Ensures inputs conform to their expected structure through schema validation before tools are invoked.</li>
<li>Centralizes error handling to provide clear feedback for adventurers without crashing the server.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes a Stdio transport spell to link adventurer tools to the Mystic Guildhall&#39;s server.</li>
<li>Initializes a background caching mechanism to improve quest response fluidity.</li>
<li>Emits notifications to aid administrators in monitoring the server‚Äôs readiness and operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Anchors the Mystic Guildhall‚Äôs startup process, guarding against initial missteps with comprehensive error logging.</li>
<li>Implements signal-based graceful shutdowns to protect the artifact&#39;s stability during interruptions.</li>
<li>Maintains resilience by isolating recoverable errors without halting the entire system.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>ü™Ñ Explore the use of dynamic schemas to see how flexibility is embedded in the server.</li>
<li>üîó Consider the integration of error codes and their impact on debugging tools that support adventurers.</li>
<li>‚ú® Check the background caching to understand how it boosts performance while handling quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>The celestial fates herald your triumph, valiant seeker, as you claim dominion over the Mystic Guildhall and illuminate the path to legendary mastery‚Äîonward toward the stars of your epic odyssey! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>