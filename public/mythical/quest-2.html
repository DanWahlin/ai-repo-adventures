<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Omnipotent Scepter of Command - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Chronicles of the Code Kingdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Omnipotent Scepter of Command</h1>
<hr>
<p>Within the vast Repository Tower, whispers speak of a mighty artifact‚Äîthe Omnipotent Scepter of Command. This enchanted scepter is said to channel untold magical spells with precision, calling forth tools and commanding them to execute complex feats. Bound in mystic scrolls and layered with the TypeScript incantations, the true power of the Scepter lies in its ability to validate, strategize, and seamlessly command execution. However, the enchantments within have grown unstable, and the unraveling magic threatens the balance of all operations. You must delve into the arcane depths of the tower to rekindle its power and usher in harmony once more. </p>
<p>Brace yourself, adventurer, for the spellbinding journey into magic‚Äôs strongest core begins now.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scepter Wielding</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically validate available tools and execute them safely?</li>
<li>‚ö° <strong>Arcane Flow</strong>: What mechanisms in the <code class="inline-code">run</code> function establish and sustain the server&#39;s communication and pre-processing activities?</li>
<li>üõ°Ô∏è <strong>Mystic Safeguards</strong>: How do the <code class="inline-code">main</code> function and <code class="inline-code">gracefulShutdown</code> ensure a safe and robust handling of unexpected interruptions and errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Magic Core of Command</h3>
<p>The <code class="inline-code">server.ts</code> file unveils the heart of the enchantment system, housing the <code class="inline-code">RepoAdventureServer</code>‚Äîa class that orchestrates how spells (tools) are executed and controlled. It dynamically lists available tools, validates mystical spell arguments using schemas, and ensures harmonious interaction. Key supporting functions include <code class="inline-code">main</code> (for server initialization) and <code class="inline-code">gracefulShutdown</code> (for safe dismantling during interruptions). This file is the prime source of the Scepter‚Äôs power.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines how the scepter dynamically lists available tools and executes handler spells with strict validation, ensuring balance.</li>
<li><code class="inline-code">run</code>: Activates the server, connects it to the transport network, and warms up magical caches for enhanced performance.</li>
<li><code class="inline-code">main</code>: Manages the lifecycle of the scepter, ensuring proper initialization and implementing interwoven shutdown mechanisms, ensuring no power goes awry.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The Tools of Conjurors</h3>
<p>The <code class="inline-code">tools.ts</code> file acts as the repository of the kingdom‚Äôs most potent mystical tools, defining each with precision. It organizes tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>, all of which harness standardized schemas to ensure balanced spellcasting. This structure allows tools to be invoked by the scepter and utilized seamlessly within quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the Repository Tower and presents adventurers with entrance options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates custom storylines and enchanting quests tailored to the adventurer‚Äôs chosen themes.</li>
<li><code class="inline-code">explore_quest.handler</code>: Aims to unearth the secrets and inner workings of an active quest.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides enchanted feedback on quest completion rates and available paths forward.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists available tools by transforming each into a contextualized JSON schema.</li>
<li>Validates parameters against schemas before execution, ensuring safety and predictability for each spell (tool).</li>
<li>Handles errors gracefully, ensuring harmonious server interactions in cases of invalid or unknown tools.</li>
<li>Separates tool discovery logic from execution, creating a modular structure that maintains clarity.</li>
<li>Avoids undefined behavior by wrapping potential failures in a customizable error-handling framework.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes a robust channel of communication through the Stdio network, ensuring seamless interaction between the scepter and its tools.</li>
<li>Warms up the Repository caching system in the background, optimizing performance for subsequent commands.</li>
<li>Utilizes <code class="inline-code">process.cwd</code> to focus on the intended project scope, ensuring adaptability across different directories.</li>
<li>Keeps preparations non-blocking, allowing the server to respond to commands without delay.</li>
<li>Highlights pre-emptive design by caching major resources upfront to avoid runtime bottlenecks.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes and robustly manages the scepter‚Äôs lifecycle by invoking the <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Implements graceful shutdown for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, ensuring session safety during interruptions.</li>
<li>Monitors unhandled promise rejections, mitigating runtime crashes while maintaining logging for further analysis.</li>
<li>Centralizes error handling for startup into a focused block, simplifying debugging and recovery.</li>
<li>Ensures readiness for both normal situations and unpredictable interruptions through lifecycle safeguards.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes all tools in an organized export, creating a straightforward registration mechanism for handlers.</li>
<li>Maintains modularity by separating tool definitions into distinct files, enhancing code maintainability.</li>
<li>Standardizes naming conventions (<code class="inline-code">snake_case</code>) for external access.</li>
<li>Ensures all tools are accessible through the primary server interface by gathering them here.</li>
<li>Sets up tools for seamless integration with handler functions defined in <code class="inline-code">server.ts</code>.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as a blueprint for designing dynamic, validated interfaces in your own systems.</li>
<li>Investigate how lifecycle management (e.g., <code class="inline-code">gracefulShutdown</code>) prevents data loss or corruption during unexpected terminations.</li>
<li>Consider how the modular tool organization (<code class="inline-code">tools.ts</code>) simplifies adding new commands without modifying core server logic.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, valiant seeker of wisdom, for you have wrested the Omnipotent Scepter of Command from the annals of enigma, marking but the blazing dawn of your journey through this epic odyssey‚Äî20% complete and destined for eternal glory! ‚ö°üëÅÔ∏èüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>