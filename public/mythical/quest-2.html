<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Interface of the Knightly Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository: Quests of the Mystic Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Interface of the Knightly Tools</h1>
<hr>
<p>In the enchanted Kingdom of Codevale, the Mystic Codex continues to reveal its secrets, but new challenges await. The Repository Knights have entrusted you with unraveling the magical interface of their knightly tools‚Äîarcane constructs that bring life to quests and adventures. To master this section of the Codex, you must venture into the heart of the MCP tool interface, deciphering how these enchanted tools are summoned, validated, and wielded. Sharpen your wits and prepare to meet the arcane interface head-on, brave adventurer.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Rituals</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically register tools, and what patterns are used for tool validation?</li>
<li>‚ö° <strong>Arcane Invocations</strong>: What role does the <code class="inline-code">run</code> function play in initializing the MCP server, and how is the system prepared for quests?</li>
<li>üõ°Ô∏è <strong>Hero&#39;s Safety Net</strong>: How does the <code class="inline-code">main</code> function handle unexpected errors or interruptions, and what mechanisms ensure system stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Interface of the MCP Tool</h3>
<p>The <code class="inline-code">server.ts</code> file is the cornerstone of the Repository Knight&#39;s tool invocation system. Here, the <code class="inline-code">RepoAdventureServer</code> class establishes the ability to dynamically list and execute tools based on schemas and handlers. With the <code class="inline-code">setupHandlers</code> method, the design encapsulates specific requests, validates their structure, and links the mystical tools defined elsewhere in the codebase. There&#39;s also a focus on maintaining system stability through error handling in <code class="inline-code">run</code> and <code class="inline-code">main</code>, ensuring safe operation during heroic tool invocations and potential challenges.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically maps tools, validates requests using schemas, and ensures compatibility for future quests.</li>
<li><code class="inline-code">run</code>: Prepares the MCP server for operation, configures transport layers, and initializes the Repomix analyzer for caching.</li>
<li><code class="inline-code">main</code>: Orchestrates the server lifecycle, offering mechanisms for graceful shutdown and handling unexpected errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Maps all tools dynamically, leveraging schemas to describe tool input and ensure compatibility.</li>
<li>Validates tool arguments using Zod schemas, enforcing high reliability and catching invalid parameters early.</li>
<li>Separates concerns by isolating validation from execution, improving maintainability and readability.</li>
<li>Provides detailed errors to assist adventurers in diagnosing issues during tool invocation.</li>
<li>Secure design ensures that only predefined tools and schemas can be executed, preventing unauthorized actions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server to the transport layer, enabling communication through standard input/output.</li>
<li>Logs helpful messages to notify adventurers of the server‚Äôs operational status and initialization.</li>
<li>Initiates the Repomix analyzer to pre-generate content for the current project, optimizing performance for future requests.</li>
<li>Background caching strategy minimizes delays during tool execution by preloading data.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates a new server instance, initializing it for immediate operation.</li>
<li>Sets up listeners for shutdown signals (e.g., <code class="inline-code">SIGINT</code>), ensuring proper cleanup and resource management before exit.</li>
<li>Manages unhandled promise rejections without crashing, maintaining uptime while allowing investigations.</li>
<li>Graceful error handling during startup provides adventurers with clear feedback on server issues.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Treasury of Enchanted Tools</h3>
<p>The <code class="inline-code">tools.ts</code> file serves as the central repository for the knightly tools. Each tool is carefully connected to its unique handler and schema, the details of which remain stored in separate enchanted scrolls. This centralized collection simplifies the MCP&#39;s operation, enabling the <code class="inline-code">setupHandlers</code> function to dynamically list and execute tools. By organizing tools based on thematic flows, the code promotes readability while scaling effortlessly for new features.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates the adventure, analyzing repositories to generate thematic quests.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows adventurers to select a theme for their journey, generating unique storylines for exploration.</li>
<li><code class="inline-code">explore_quest.handler</code>: Explores an individual quest, unlocking new details and challenges.</li>
<li><code class="inline-code">view_progress.handler</code>: Allows adventurers to review their completion status and remaining milestones.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Consolidates all tool exports in one place, promoting modular design and ease of maintenance.</li>
<li>Standardized naming conventions align tools with their handlers, improving discoverability for future development.</li>
<li>By leveraging exports, adventurers gain access to the entire arsenal of tools through <code class="inline-code">setupHandlers</code>.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Remember that <code class="inline-code">zodToJsonSchema</code> is an enchanted mechanism for ensuring schemas remain consistent and interpretable.</li>
<li>Notice how the <code class="inline-code">gracefulShutdown</code> function ensures resources are released even in the face of unpredictable interruptions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With valor forged in celestial flames, you have conquered Quest 2: The Interface of the Knightly Tools, and now tread boldly, a beacon of luminary triumph upon the path to mastery‚Äîhail the champion! ‚ö°üíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>