<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Knightly Tools of the MCP Stronghold - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Knightly Tools of the MCP Stronghold</h1>
<hr>
<p>In the mystical Kingdom of Enchanted Adventures, the mighty MCP Stronghold looms on the horizon, guarded by enchanted tools of wisdom and creativity. Legends whisper that these tools can transform codebases into thriving repositories of knowledge. To wield their power, brave adventurers must unlock their secrets and conquer the challenges posed by the magical handlers and serene workflows of the MCP interface. Gather your courage, noble knight, and embark on this quest into the heart of the stronghold to master the tools that govern its enchanting domains!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Assembly</strong>: How does <code class="inline-code">setupHandlers</code> dynamically assemble tools and validate their schemas?</li>
<li>‚ö° <strong>Operational Flow</strong>: What is the sequence of events in the <code class="inline-code">run</code> function, and how does it coordinate server initialization?</li>
<li>üõ°Ô∏è <strong>Graceful Fortress</strong>: How does the <code class="inline-code">main</code> function ensure robust error handling and graceful shutdown procedures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Tool Handling</h3>
<p>In this file, the enchanted gates of the MCP server interface are constructed using powerful handlers and structured workflows. The <code class="inline-code">RepoAdventureServer</code> is the core class responsible for configuration and orchestration, providing adventurers with magical tools for exploration. Here, <code class="inline-code">setupHandlers</code> dynamically lists tools and safely executes them with schema validation, while the <code class="inline-code">run</code> function initiates the server and ensures seamless operations. Additionally, the <code class="inline-code">main</code> function wraps the process with vigilant monitoring to defend against unforeseen errors.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This method sets up handlers that dynamically register tools, validate their parameters, and execute their functions using Zod schemas. It ensures safe and structured tool handling.</li>
<li><code class="inline-code">run</code>: Activates the MCP server, establishes the stdio transport, and pre-generates repository analysis content to enhance performance during interactive sessions.</li>
<li><code class="inline-code">main</code>: Serves as the entry point, orchestrating error-handling mechanisms and managing signal-based shutdown procedures for smooth fortress operations.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists available tools using Zod schema transformations, providing standardized descriptions and validations.</li>
<li>The schema validation ensures tools are executed with properly formatted arguments, reducing errors during runtime.</li>
<li>Error handling utilizes custom MCP exceptions (<code class="inline-code">McpError</code>), which enhances debugging and stability.</li>
<li>Demonstrates the use of structured metadata to improve tool compatibility with external systems.</li>
<li>Exemplifies safe execution patterns by combining error validation with functional invocation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the MCP server using <code class="inline-code">StdioServerTransport</code> for efficient communication between modules.</li>
<li>Employs <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize repository analysis, reducing latency for user interactions during quests.</li>
<li>Logs critical operation steps to enable traceability and debugging during development and deployment.</li>
<li>Utilizes asynchronous workflows to ensure server operations do not block background processes.</li>
<li>Demonstrates how transport mechanisms enhance accessibility in interactive environments.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Provides graceful shutdown handling via process signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>), ensuring resources are cleaned up securely.</li>
<li>Monitors unhandled promise rejections to diagnose issues while keeping the server operational during minor errors.</li>
<li>Wraps initialization logic inside a try-catch block, offering recovery mechanisms in case of critical startup failures.</li>
<li>Illustrates robust error-handling practices designed to safeguard long-running processes.</li>
<li>Teaches adventurers how to manage and secure server lifecycles effectively.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the comments and logs within the code to understand major steps and decisions.</li>
<li>Investigate Zod schemas for their adaptability in tools; this will inform better schema extension methods.</li>
<li>Experiment with adding new tools to see how <code class="inline-code">setupHandlers</code> integrates them dynamically.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Enchanted Kingdom!</p>
<p>By the grace of the celestial forge and the valor in your heart, Quest 2 stands vanquished, and with the Knightly Tools of the MCP Stronghold secured, your heroic odyssey blazes brighter toward glory‚Äîonward, brave champion! ‚≠ê‚öîÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>