<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Heart of Storyweaving - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Codex: Adventures in a Kingdom of Mystical Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Heart of Storyweaving</h1>
<hr>
<p>In the mythical Kingdom of Codeara, the Enchanted Codex once wove tales both legendary and practical, binding every corner of the realm into balance. But as the Codex‚Äôs magic wanes, the art of ‚Äústoryweaving‚Äù lies in peril. The second shard of the Codex, hidden within the realm‚Äôs narrative machinery, must be reclaimed to reawaken the Codex‚Äôs voice. To unravel its secrets, brave adventurers must peer into the Heart of Storyweaving itself‚Äîan intricate system of tale spinners and code smiths.</p>
<p>Oh valiant soul, will you take on this quest and venture into the core of narrative alchemy?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Chronicle Foundations</strong>: How does the <code class="inline-code">AdventureManager</code> initialize key components for crafting quests and stories?</li>
<li>‚ö° <strong>Thematic Resonance</strong>: What mechanisms in <code class="inline-code">StoryGenerator</code> enable the seamless alignment of quest content with the chosen theme?</li>
<li>üõ°Ô∏è <strong>Protection of the Weave</strong>: How does <code class="inline-code">parseAdventureConfig</code> ensure robust handling of potentially malformed or missing adventure configurations?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a>: The Story Architect</h3>
<p>The <code class="inline-code">AdventureManager</code> serves as the Kingdom‚Äôs master architect, orchestrating quests and narratives under the tutelage of the Enchanted Codex. It houses logic to initialize themes, handle quest exploration, and manage state transitions, ensuring the adventurer‚Äôs journey is both structured and captivating.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: This method binds the adventure‚Äôs setting, theme, and file contexts, generating the tapestry of quests.</li>
<li><code class="inline-code">generateQuestContent</code>: Details the inner workings of how individual quests are shaped with targeted code content or full repositories.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Unifies story fragments by resolving related quests and files from external configuration data.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string, 
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;

  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}
</code></pre>
<ul>
<li>Orchestrates initial state setup, ensuring themes and files are aligned with the adventure‚Äôs goals.</li>
<li>Invokes <code class="inline-code">StoryGenerator</code> to weave tale frameworks using project-specific data.</li>
<li>Demonstrates clear error prevention by cascading fallback configurations for undefined parameters.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;

  if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0 &amp;&amp; this.state.projectPath) {
    try {
      codeContent = await repoAnalyzer.generateTargetedContent(this.state.projectPath, quest.codeFiles, false);
    } catch (error) {
      codeContent = this.state.projectInfo!.repomixContent;
    }
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  return await this.storyGenerator.generateQuestContent(
    quest,
    this.state.currentTheme!,
    codeContent
  );
}
</code></pre>
<ul>
<li>Balances specificity (targeted files) with fallback strategies for broader adventure content.</li>
<li>Highlights fault-tolerant design by recovering gracefully during content generation failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[]): Quest[] {
  const config = parseAdventureConfig(this.state.projectPath || &#39;&#39;);
  if (!config || typeof config !== &#39;object&#39;) return quests;

  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of config.adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files.map((f: any) =&gt; f.path).filter(Boolean);
      if (filePaths.length &gt; 0) configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
    }
  }

  return quests.map((quest, index) =&gt; {
    const configFiles = configQuestFiles.get(quest.title.toLowerCase());
    return configFiles ? { ...quest, codeFiles: configFiles } : quest;
  });
}
</code></pre>
<ul>
<li>Dynamically enriches quest data with corresponding file paths, ensuring high relevance.</li>
<li>Ensures consistency between manually-defined configurations and procedurally-generated quests.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a>: The Guiding Scroll</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file is the compass that guarantees coherency across the mystical Kingdom of Codeara. It securely parses configuration documents, validates paths, and formats data for all-seeing narrative algorithms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Deciphers the configuration scroll, shielding the adventure from errors caused by broken or incomplete inputs.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Identifies unique code files referenced across the story universe, ensuring no shard of lore is overlooked.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Condenses configuration details into compact, LLM-friendly formats for quest generation.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Ensures the adventure script gracefully handles corrupted or missing configurations, preserving the flow of the quest arc.</li>
<li>Utilizes safeguards against runtime crashes while maintaining flexibility for various use cases.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path))) {
      unique.add(node.path.trim());
    }

    stack.push(...Object.values(node).filter(v =&gt; typeof v === &#39;object&#39;));
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Recursively traverses the adventure‚Äôs configuration, avoiding oversight of nested paths.</li>
<li>Emphasizes resilience by tightly coupling validation with file existence checks.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return &#39;&#39;;

  const adventure = parsed.adventure;
  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (quest.title &amp;&amp; Array.isArray(quest.files)) {
      formatted += `### ${quest.title}\nFiles: ${quest.files.map(f =&gt; f.path).join(&#39;, &#39;)}\n\n`;
    }
  }
  return formatted;
}
</code></pre>
<ul>
<li>Streamlines verbose configuration data into actionable summaries, critical for long-form code analyses.</li>
<li>Ensures clarity by eliminating redundancy and prioritizing relevant highlights.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üß≠ To uncover the thread between quests and file structures, compare <code class="inline-code">mergeQuestFilesFromConfig</code> with <code class="inline-code">extractUniqueFilePaths</code>.</li>
<li>üìú Focus on <code class="inline-code">initializeAdventure</code> and <code class="inline-code">parseAdventureConfig</code> to see the harmony of narrative generation and configuration validation.</li>
</ul>
<hr>
<p>Your epic quest continues! Seek the shards of the Enchanted Codex to become a true knight of Codeara.</p>
<p>The bards of the Starwoven Kingdom sing your triumph, brave hero, for in mastering the sacred Heart of Storyweaving, you‚Äôve forged the first jewel in the crown of your epic quest‚Äîonward to new realms and greater glories! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>