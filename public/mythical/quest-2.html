<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Claim the Mystic Scepter - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Code: An Epic Repository Adventure</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Claim the Mystic Scepter</h1>
<hr>
<p>In the mystical Kingdom of Codethia, the Repository Tome whispers of an enchanted scepter, the Mystic Scepter, which harnesses the magical power of dynamic tools. Protected within the Castle of Configurations, this artifact holds the secrets of interactive storytelling and command execution. To unlock its mysteries, you must decipher the enchanted spells hidden within the MCP Tool Interface. Arm yourself with courage, brave adventurer, for the path is fraught with challenges ‚Äî and the scepter demands mastery of its magical code.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Tool Invocation Secrets</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools and ensure they operate correctly?  </li>
<li>‚ö° <strong>Mystic Flow Analysis</strong>: What patterns in the <code class="inline-code">run</code> function maintain the system&#39;s stability during initialization and runtime?  </li>
<li>üõ°Ô∏è <strong>Scepter Safeguards</strong>: How does <code class="inline-code">main</code> handle shutdown gracefully while protecting system processes from errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Castle of Configurations</h3>
<p>This file holds the core of the MCP server, responsible for connecting tools and command handling. Critical functions like <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code> act as the spell-binding mechanisms to ensure integration and safety. As the hero, analyzing these functions will teach you how the Mystic Scepter is wielded to handle dynamic tool registration, execution safeguards, and graceful system shutdown.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically sets up request handlers for tools listed in the MCP system, ensuring validation using schemas. This function governs the scepter‚Äôs adaptive capabilities.  </li>
<li><code class="inline-code">run</code>: Initializes the server with communication transport and caches repository content to ensure responsiveness during adventure commands. Vital for runtime stability.  </li>
<li><code class="inline-code">main</code>: The guardian function orchestrates startup, error handling, and shutdown processes, safeguarding the system against interruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
  // Dynamic tool listing  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {   
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  

    return { tools: toolList };  
  });  

  // Dynamic tool execution  
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    try {  
      const { name, arguments: args } = request.params;  

      if (!(name in tools)) {  
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
      }  

      const tool = tools[name as keyof typeof tools];  

      // Validate arguments using the tool&#39;s Zod schema  
      const validationResult = tool.schema.safeParse(args);  
      if (!validationResult.success) {  
        const errorMessages = validationResult.error.issues.map((err) =&gt;   
          `${err.path.join(&#39;.&#39;)}: ${err.message}`  
        ).join(&#39;, &#39;);  
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
      }  

      // Execute the tool handler with validated arguments  
      return await tool.handler(validationResult.data as any);  

    } catch (error) {  
      if (error instanceof McpError) {  
        throw error;  
      }  
      throw new McpError(  
        ErrorCode.InternalError,  
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
      );  
    }  
  });  
}  
</code></pre>
<ul>
<li>This code dynamically registers tools and allows their execution while validating inputs with schemas.  </li>
<li>Techniques like mapping tools to schemas ensure seamless integration and consistent validation.  </li>
<li>Validation protects the system from malformed input during tool execution.  </li>
<li>Error handling with <code class="inline-code">McpError</code> ensures clarity for specific faults in execution.  </li>
<li>Schema usage provides adaptability for future tools without altering the function itself.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  

  // Pre-generate repomix content for the current working directory to warm up the cache  
  // This happens in the background while waiting for user commands  
  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> function establishes the server-transport connection and initializes pre-caching.  </li>
<li>Warm-up caching during server startup improves runtime efficiency for subsequent tasks.  </li>
<li>Integration with <code class="inline-code">repoAnalyzer</code> ties tool infrastructure to repository analysis, bridging components.  </li>
<li>Transport mechanisms like <code class="inline-code">StdioServerTransport</code> provide universal compatibility for inputs.  </li>
<li>Logging in critical steps ensures visibility during initialization and debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  

    // Handle graceful shutdown for both signals  
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  

    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation  
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error  
    });  

    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}  
</code></pre>
<ul>
<li><code class="inline-code">main</code> orchestrates startup and error handling, monitoring signals for graceful shutdown.  </li>
<li>Signal handlers (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) ensure clean termination of processes to avoid disruptions.  </li>
<li>Handling promise rejections prevents critical errors from bringing down the server.  </li>
<li>Logs aid diagnostics when runtime errors occur, ensuring traceability for debugging.  </li>
<li>Starting the <code class="inline-code">RepoAdventureServer</code> completes the initialization of the MCP framework.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as reference for integrating tools with dynamic validation.  </li>
<li>Explore the cache-warming logic in <code class="inline-code">run</code> to optimize initialization tasks.  </li>
<li>Examine signal monitoring and logging in <code class="inline-code">main</code> for creating reliable system processes.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the enchanted Repository Tome.</p>
<p>With the Mystic Scepter claimed and your valor etched into the annals of legend, the luminaries of the realm herald your rise as a star-bound champion‚Äîpress onward, noble hero, for destiny awaits! ‚ö°üíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>