<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Arcane Interface of the Eternal Spells - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Codebase of Eldoria</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Arcane Interface of the Eternal Spells</h1>
<hr>
<p>In the kingdom of Eldoria, the Repository of Mystical Scrolls is safeguarded by enchantments so complex that not even the wisest of wizards can wield them without the aid of the Arcane Interface. This Interface, forged through spells of interactive storytelling, allows brave adventurers to explore the coded fabric of the realm itself. In this quest, you will delve into the Arcane Interface, learning how tools of exploration are conjured and summoned, uncovering the magics behind their execution.</p>
<p>Your path leads to the MCP&#39;s enchanted files, keys to understanding the generators of mythical quests. Wield your knowledge wisely and discover the spells behind the server&#39;s core operations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Binding Runes</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register and validate the available mystical tools in the server?</li>
<li>‚ö° <strong>Summoning Rituals</strong>: How does the <code class="inline-code">run</code> method enchant the server to process commands using magical transports?</li>
<li>üõ°Ô∏è <strong>Protections Against Chaos</strong>: How does the <code class="inline-code">main</code> function ensure graceful error handling during both normal operations and unanticipated failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core Interface of the MCP</h3>
<p>The file <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> defines the primary server class, the <code class="inline-code">RepoAdventureServer</code>, that orchestrates the Arcane Interface. Within these walls, the handlers for tool listing and execution are forged, dynamic functionalities are established, and real-time communication protocols are implemented. Three primary methods stand out like enchanted glyphs etched on ancient stone: <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code>.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This private method binds the server with its dynamic tools, enabling adventurers to list and invoke magical artifacts. It validates implemented schemas and gracefully handles invalid requests.</li>
<li><code class="inline-code">run</code>: The incantation that breathes life into the server, connecting it to the transport layer and initiating the cache for smoother operations.</li>
<li><code class="inline-code">main</code>: The guardian of the server&#39;s lifecycle, ensuring a seamless startup and protecting against chaotic shutdowns or spell misfires.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Registers dynamic handlers for tool listing and execution, enabling flexibility and expandability without altering core code.</li>
<li>Utilizes <code class="inline-code">zodToJsonSchema</code> for translating schemas, maintaining a robust and validated interface for tools.</li>
<li>Provides error handling for invalid tools and parameters, safeguarding system stability.</li>
<li>Demonstrates clean separation of tool validation and execution, showcasing modular design practices.</li>
<li>Easily extensible with new tools, as the handler dynamically maps them from the <code class="inline-code">tools</code> object.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Initiates the server by connecting to the <code class="inline-code">StdioServerTransport</code>, enabling standard communication protocols.</li>
<li>Outputs helpful logs during initialization to indicate server readiness.</li>
<li>Pre-generates project cache with <code class="inline-code">repoAnalyzer</code>, optimizing operational efficiency.</li>
<li>Demonstrates a non-blocking warm-up mechanism to prevent startup delays.</li>
<li>Highlights integration between server setup and external analysis tools like <code class="inline-code">repoAnalyzer</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Initializes the primary server instance and orchestrates its startup process with error handling.</li>
<li>Listens for shutdown signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to invoke safe cleanup routines.</li>
<li>Catches unhandled promise rejections to prevent crashes, enabling robust operation even in unanticipated scenarios.</li>
<li>Outputs helpful error messages while ensuring non-recoverable errors trigger a controlled shutdown.</li>
<li>Reinforces the server‚Äôs resilience with well-defined lifecycle management practices.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To expand the interface, add tools to the <code class="inline-code">tools</code> object in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> and ensure proper schema definitions.</li>
<li>Investigate lifecycle hooks to better understand the seamless integration of transport and tools.</li>
<li>Study how schemas are dynamically validated to gain insights into the modularity of the design.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the mastery of the Arcane Interface of the Eternal Spells, you have unlocked the wisdom of enchanted relics, proving your valor and ascending as a true arcane champion in the mythical tapestry of questing glory! ‚ö°‚ú®üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>