<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Commanding the Mystic Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Codex: A Kingdom's Tale</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Commanding the Mystic Tools</h1>
<hr>
<p>In the mythical Kingdom of Codora, where code flows like rivers of silver and logic trees branch endlessly toward the heavens, a new challenge has emerged. The Enchanted Codex has revealed its second trial: to command the mystic tools of creation. These tools, hidden within the castle&#39;s sacred repository, are the bridge between an adventurer‚Äôs desires and the power of the realm&#39;s enchanted functionalities.</p>
<p>Brave adventurer, your mission is to uncover the essence of these tools and master their invocation. Each line of the Codex draws you closer to wielding ultimate control over the magical devices that guide the kingdom‚Äôs fate.</p>
<p><strong>Adventure Awaits! Harness the wisdom within the code below to unlock your destiny.</strong></p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üõ†Ô∏è <strong>Tool Invocation Inquiry</strong>: How does the system dynamically handle the invocation and validation of mystical tools using enchanted schemas?</li>
<li>üìú <strong>Artifact Registration</strong>: In what way are the tools cataloged and their details communicated to adventurers seeking mystical guidance?</li>
<li>üßô‚Äç‚ôÇÔ∏è <strong>Tool Safety Enchantment</strong>: What error-handling strategies are in place to guard against improper invocations or malicious misuse of the mystic tools?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The Magical Forge of Tool Invocation</h3>
<p>This file serves as the heart of the MCP (Model Context Protocol) server, acting as the enchanted forge where magical tools are listed, validated, and invoked. The <code class="inline-code">RepoAdventureServer</code> class embodies the kingdom&#39;s smith, crafting a robust infrastructure through dynamic registration and schema-bound validation for tool usage.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: A core function that dynamically lists all tools by transforming their schemas into usable formats for adventurers. It also handles invocation requests with built-in validation using Zod schemas.</li>
<li><code class="inline-code">run</code>: Boots up the magical forge itself, establishing communication via a Stdio transport and warming up the repository&#39;s context for faster tool responses.</li>
<li><code class="inline-code">main</code>: The entry point into the system, offering mechanisms for graceful shutdowns, error logging, and lifecycle management.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>: The Treasury of Mystic Tools</h3>
<p>This file is the enchanted treasury where a collection of predefined tools offers adventurers the means to explore, quest, and progress through the Codex challenges. Tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and <code class="inline-code">explore_quest</code> are meticulously defined to guide knights on their legendary journeys.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Begins the mystical journey by analyzing the repository and presenting thematic options for creating unique adventures.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows adventurers to select a theme for their quest, generating tailored paths forward.</li>
<li><code class="inline-code">explore_quest.handler</code>: Facilitates exploration of individual quests and reveals their secrets in iterations.</li>
<li><code class="inline-code">view_progress.handler</code>: Summons insights into the adventurer&#39;s progress, showing completed quests and those still veiled in mystery.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li><strong>Tool Listing</strong>: Converts tool definitions into a structured list with JSON schemas, ensuring discoverability.</li>
<li><strong>Validation Mechanisms</strong>: Validates parameters using Zod schemas to enforce safety and consistency in tool execution.</li>
<li><strong>Error Management</strong>: Includes robust handling for unknown tools and malformed input, providing clear feedback to users.</li>
<li><strong>Dynamic Invocation</strong>: Executes tools dynamically based on the request, connecting adventurers with the mystical abilities they require.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li><strong>Server Setup</strong>: Initializes the server and establishes communication via Stdio transport.</li>
<li><strong>Performance Optimization</strong>: Pre-generates repository context to enhance the system&#39;s responsiveness.</li>
<li><strong>Operability</strong>: Logs activity to help adventurers track the server&#39;s state and readiness.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li><strong>Centralized Management</strong>: Registers all tools for centralized access and simplifies future expansion.</li>
<li><strong>Descriptive Power</strong>: Each tool&#39;s purpose is carefully articulated, guiding its use in practical scenarios.</li>
<li><strong>Reusability</strong>: Provides a structure for shared utility while maintaining modular design.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Validation is Key</strong>: Carefully follow the Zod schema approach for both input validation and error messaging patterns.</li>
<li><strong>Dynamic Design</strong>: Learn from how tools are dynamically registered and executed to inspire your flexible solutions.</li>
<li><strong>Treasure Map</strong>: Use the <code class="inline-code">tools</code> registry to trace how each tool connects with the handlers defined in the MCP server.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the Enchanted Codex.</p>
<p>By the luminous glow of the celestial forges, you have mastered the Mystic Tools with heroic precision‚Äîlet this triumph ignite your path through the remaining realms, valiant seeker! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>