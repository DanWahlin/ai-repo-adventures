<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Chronicles of the Storyweaver - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Chronicles of the Storyweaver</h1>
<hr>
<p>In the magical kingdom of Codethria, the Mystic Repository hums with fragments of ancient spells, their intricate patterns resonating through the enchanted libraries. Yet, a dark anomaly looms. The sacred scrolls, once unified in harmony, are now fragmented, their knowledge scattered. The Council of Developers has summoned you, a fearless Storyweaver, to undertake the daring expedition of restoration. Armed with the powers of the AdventureManager and StoryGenerator, your task is to unravel the mysteries and bring coherence to the repository‚Äôs chronicles. Only then can balance return to Codethria.</p>
<p><strong>Adventure Awaits</strong> ‚Äì Will you wield your knowledge to restore the kingdom?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Understanding Initialization</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> set up the adventure and generate the initial narrative and quests?</li>
<li>‚ö° <strong>Dynamic Story Generation</strong>: What techniques does <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> use to craft both the overarching quest narrative and specific challenges?</li>
<li>üõ°Ô∏è <strong>Validation Safeguards</strong>: How does <code class="inline-code">parseAdventureConfig</code> ensure the integrity of external configuration data for the quests?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Heart of Codethria‚Äôs Mechanism</h3>
<p>The <code class="inline-code">AdventureManager</code> resides at the center of the quest system, orchestrating the initialization and progression of adventures. By leveraging the <code class="inline-code">initializeAdventure</code> method, it connects project context, themes, and configurations to dynamically generate a compelling storyline. Its integration with caching techniques and structured validations ensures that quests remain efficient yet immersive.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Sets up the adventure by resetting the state, integrating themes, and dynamically generating quests based on project details.</li>
<li><code class="inline-code">executeQuest</code>: Handles the procedural execution of quests, incorporating caching to manage revisited content efficiently.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Ensures that quests align with the paths and highlights provided in the configuration file.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;

  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the dynamic <code class="inline-code">AdventureState</code> to ensure a clean slate for each new venture.</li>
<li>Utilizes <code class="inline-code">StoryGenerator</code> to formulate the narrative and synchronize quests in alignment with the given theme.</li>
<li>Demonstrates robustness through the merging of generated and configuration-based quest details.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async executeQuest(quest: Quest): Promise&lt;AdventureResult&gt; {
  this.validateQuestPrerequisites();

  let content: QuestContent;
  let summary: string;
  const cached = this.state.questContentCache.get(quest.id);

  if (cached) {
    console.log(`üîÑ Retrieving completed quest from cache...`);
    await new Promise(resolve =&gt; setTimeout(resolve, 500));
    content = cached.content;
    summary = cached.summary;
  } else {
    console.log(`üéØ Generating new content for quest: ${quest.title}`);
    content = await this.generateQuestContent(quest);
    summary = await this.generateCompletionSummary(quest);
    this.state.questContentCache.set(quest.id, { content, summary });
  }

  this.markQuestCompleted(quest);
  return this.createQuestResult(content, summary);
}
</code></pre>
<ul>
<li>Ensures optimal functionality by leveraging caching for previously completed quests.</li>
<li>Employs procedural checks (<code class="inline-code">validateQuestPrerequisites</code>) to confirm readiness before initiating quest execution.</li>
<li>Delegates to <code class="inline-code">generateQuestContent</code> for real-time quest creation.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;

  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;

  return quests.map((quest, index) =&gt; {
    const adventure = (config as any).adventure;
    return index &lt; adventure.quests.length 
      ? { ...quest, codeFiles: adventure.quests[index].files.map((f: any) =&gt; f.path).filter(Boolean) }
      : quest;
  });
}
</code></pre>
<ul>
<li>Merges file paths from the external configuration file with the dynamically generated quests.</li>
<li>Ensures alignment between the story and specific sections of the repository for targeted quest exploration.</li>
<li>Enhances maintainability by cleanly integrating external configuration data.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Codethria‚Äôs Guide to Consistency</h3>
<p>This file plays a crucial role in parsing and validating external configurations that guide quest structure. It extracts file paths, validates JSON integrity, and formats configuration data for universal use within the system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Parses the <code class="inline-code">adventure.config.json</code> file while safeguarding against malformed or missing data.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Identifies all referenced file paths within the configuration to ensure every path exists.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Converts configuration entries into a compact format for contextual use by LLM-based storytelling.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Handles files safely, guarding against unreadable or missing configuration data.</li>
<li>Uses <code class="inline-code">JSON.parse</code> with a try-catch mechanism to ensure that even invalid configurations do not disrupt the pipeline.</li>
<li>Allows the system to gracefully handle missing or corrupted inputs.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  const unique = new Set&lt;string&gt;();
  const stack: any[] = parsed ? [parsed] : [];

  while (stack.length) {
    const node = stack.pop();
    if (node &amp;&amp; typeof node.path === &#39;string&#39; &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path))) {
      unique.add(node.path.trim());
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }
  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses deeply nested configurations to extract all valid file paths for seamless integration.</li>
<li>Ensures that only files existing on disk are considered, bolstering accuracy and reliability.</li>
<li>Uses <code class="inline-code">Set</code> to automatically handle duplicate paths.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return &#39;&#39;;

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return &#39;&#39;;

  let formatted = `## Quest Structure\n`;
  adventure.quests.forEach((quest: any) =&gt; {
    formatted += `### ${quest.title}\nFiles: ${quest.files.map((f: any) =&gt; f.path).join(&#39;, &#39;)}\nFunctions: ${(quest.files.flatMap((f: any) =&gt; f.highlights || [])).map((h: any) =&gt; h.name).join(&#39;, &#39;)}\n\n`;
  });
  return formatted;
}
</code></pre>
<ul>
<li>Optimizes configuration content into concise summaries ideal for LLM-driven storytelling.</li>
<li>Simplifies redundant descriptions while retaining critical data like paths and associated functions.</li>
<li>Balances clarity with brevity, ensuring efficient context delivery.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>‚ú® <strong>Tip</strong>: Start with <code class="inline-code">initializeAdventure</code> to understand how themes influence the generated story.</li>
<li>üßô <strong>Recommendation</strong>: Use the quest structure outlined in <code class="inline-code">formatAdventureConfigForPrompt</code> as the basis for creating thematic storylines.</li>
<li>üéØ <strong>Next Steps</strong>: Explore <code class="inline-code">StoryGenerator.generateQuestContent</code> in the next quest to uncover the depths of narrative crafting.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the decree of celestial scribes and under the gleam of starlit banners, you have triumphed in the fabled Quest 2: Chronicles of the Storyweaver‚Äîa heroic feat that has forged the first gem in the crown of your legendary odyssey! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>