<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Interface of Cooperation - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository of Quests</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Interface of Cooperation</h1>
<hr>
<p>Within the mystic Kingdom of Repoheim, the ancient prophecy tells of the Enchanted Repository, guarded fiercely by protocols of harmony and spells of structure. The first step on your journey is to master the Mystic Interface of Cooperation, an artifact that summons and binds the tools of creation through intricate logic. Only by deciphering its mechanisms and understanding its enchanted workflow can you wield its power to progress further in your mythical quest.</p>
<p>Brave seeker, let the quest begin and delve into the magical realm of the MCP Tool Interface, which powers the enchanted cooperation between tools and their handlers. Success here shall illuminate your path to further adventures within the Kingdom of Repoheim!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Riddles</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically list and validate the tools in the repository, and what are its magical validation mechanisms?</li>
<li>‚ö° <strong>Server Flow Insights</strong>: How does the <code class="inline-code">run</code> method initialize the MCP server, and how does cache pre-generation enhance the system&#39;s responsiveness?</li>
<li>üõ°Ô∏è <strong>Graceful Shutdown Protocols</strong>: How does the <code class="inline-code">main</code> function handle error recovery and graceful shutdown, guarding the kingdom against unforeseen calamities?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Core MCP Server</h3>
<p>The file, <code class="inline-code">server.ts</code>, is the operational heart of the enchanted MCP server that powers tool invocation and interaction. It binds the Server of Repoheim to its dynamic tools and manages critical operations like setting handlers, running the server, and shutting down gracefully. Within it lies the spell to validate tools dynamically (<code class="inline-code">setupHandlers</code>), an essential focus for understanding the control over repository-based adventuring tools. The file also orchestrates the server startup through <code class="inline-code">run</code> while gracefully handling disruptions in <code class="inline-code">main</code>. This robust infrastructure ensures a seamless magical experience for users traversing the codebase.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: A dynamic handler function that registers tools, transforms their schemas into compatible formats, and validates user input when invoking tools.</li>
<li><code class="inline-code">run</code>: A vital method that initializes the stdio transport for the server, generates cached content ahead of use, and activates the magic of the MCP system.</li>
<li><code class="inline-code">main</code>: The entry point of the MCP server, managing startup, signal handling, and resolution of unhandled rejections for uninterrupted operation.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists all tools, incorporating their descriptions and schemas into a unified structure for effortless discovery.</li>
<li>Converts schemas using <code class="inline-code">zodToJsonSchema</code>, enabling seamless integration and ensuring compatibility.</li>
<li>Implements error handling for cases where tools are unknown or validate input with malformed schemas, preserving system integrity.</li>
<li>Empowers interactive exploration by validating tool arguments against predefined schemas before execution.</li>
<li>Handles thrown errors gracefully, returning comprehensive descriptions of issues for debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the standard input/output (stdio) transport to connect the MCP server with external systems, facilitating communication.</li>
<li>Signals server startup with a console message, confirming its operational state to adventurers.</li>
<li>Enhances user interaction speed by pre-generating cached analysis data for the current project directory, thereby reducing response times.</li>
<li>Relies on asynchronous operations to prevent blocking server startup, maintaining responsiveness.</li>
<li>Ensures system readiness by warming up the cache while awaiting user commands, enhancing the magical experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates and initializes the RepoAdventureServer to harness its magical capabilities.</li>
<li>Sets up handlers for system signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure graceful shutdown, safeguarding system integrity.</li>
<li>Logs unhandled promise rejections without crashing the server, highlighting issues for reporting without downtime.</li>
<li>Guards against fatal errors by halting execution with a comprehensive log message for debugging.</li>
<li>Completes server setup with asynchronous operations, invoking the <code class="inline-code">run</code> method to activate the enchanted MCP system.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Use the handler validation pattern demonstrated in <code class="inline-code">setupHandlers</code> when designing magical interfaces for ensuring inputs meet expected standards.</li>
<li><strong>Exploration Recommendation</strong>: Examine the startup process in <code class="inline-code">main</code> to understand how signal handling can be used to maintain operational integrity during unexpected disruptions.</li>
<li><strong>Next Steps</strong>: Investigate how tools like <code class="inline-code">start_adventure</code> are implemented to appreciate the cooperative relationship between handlers and callable tools.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>The valiant heroes have unlocked the sacred harmony of the Mystic Interface, weaving the first gleaming thread in the tapestry of five golden quests‚Äîonward to glory, their legend begins! ‚ö°üíéüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>