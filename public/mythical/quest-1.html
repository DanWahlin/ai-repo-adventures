<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Castle of the Mystic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Codex of Mystic Quests</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Castle of the Mystic Interface</h1>
<hr>
<p>In the mystical Kingdom of Computarion, a towering castle looms‚Äîthe Castle of the Mystic Interface. Its enchanted halls contain the sacred <code class="inline-code">setupHandlers</code> scroll, whose spells bind tools to their magical purposes. Guarded by the <code class="inline-code">run</code> spell, which empowers the castle‚Äôs mystical machinery, and the cryptic <code class="inline-code">main</code> incantation that gives life to the adventure, these artifacts are key to reclaiming the Enchanted Codex. But beware, brave adventurer, for dark tests‚Äîencoded in riddles‚Äîawait those unworthy of wielding such power.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Repository Server Core</h3>
<p>This file holds the enchanting scripts needed to bind the magic of Computarion‚Äôs MCP tools into a functional server. The <code class="inline-code">RepoAdventureServer</code> class is the heart of this castle, defining the <code class="inline-code">setupHandlers</code> function to summon available tools and ensure their correct behavior. The <code class="inline-code">run</code> method weaves the castle&#39;s operational spells, connecting to the mystical <code class="inline-code">StdioServerTransport</code>. Finally, the <code class="inline-code">main</code> function acts as the lifeblood, orchestrating the harmonious awakening of the server while watching for disruptive elemental signals like <code class="inline-code">SIGINT</code>.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Implements dynamic listing and invocation for MCP tools.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Configures the spellwork necessary to operate the server.</li>
<li><code class="inline-code">main</code>: Governs the overall initialization flow and prepares for external disruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
        const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
            name,
            description: tool.description,
            inputSchema: zodToJsonSchema(tool.schema, { 
              target: &#39;jsonSchema7&#39;,
              $refStrategy: &#39;none&#39;
            })
        }));

        return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
        try {
            const { name, arguments: args } = request.params;

            if (!(name in tools)) {
                throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
            }

            const tool = tools[name as keyof typeof tools];
            
            // Validate arguments using the tool&#39;s Zod schema
            const validationResult = tool.schema.safeParse(args);
            if (!validationResult.success) {
                const errorMessages = validationResult.error.issues.map((err) =&gt; 
                    `${err.path.join(&#39;.&#39;)}: ${err.message}`
                ).join(&#39;, &#39;);
                throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
            }

            // Execute the tool handler with validated arguments
            return await tool.handler(validationResult.data as any);

        } catch (error) {
            if (error instanceof McpError) {
                throw error;
            }
            throw new McpError(
                ErrorCode.InternalError,
                `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
            );
        }
    });
}
</code></pre>
<p>This is like writing the castle‚Äôs rulebook‚Äîtools are cataloged and their behaviors validated before activating.</p>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>This spell ignites the castle‚Äôs inner mechanisms, calling forth the server‚Äôs operational energy flow.</p>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
            process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
            console.error(&#39;Unhandled promise rejection:&#39;, reason);
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<p>The wizard-like summoning of <code class="inline-code">main</code> ensures the castle‚Äôs awakening amidst unpredicted disruptions.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Plan your quest&#39;s order of study: start with <code class="inline-code">setupHandlers</code> to grasp the tool registration framework.</li>
<li>Test the server locally by observing its connection message in the console during <code class="inline-code">run</code>.</li>
<li>Focus on how errors are managed‚Äîimmensely useful for debugging your future adventures.</li>
</ul>
<hr>
<p>Congratulations, you have deciphered the magic of the Castle of the Mystic Interface. The next fragment of the codex awaits!</p>
<p>With valor unmatched, you have conquered the Castle of the Mystic Interface, unlocking the first jewel of wisdom on your legendary quest toward mastery‚Äîonward, noble traveler, destiny awaits! ‚≠êüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>