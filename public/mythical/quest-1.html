<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Guild of Adventurers - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository: Chronicles of Code and Magic</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Guild of Adventurers</h1>
<hr>
<p>In the shadow of Castle Code, the Guild of Adventurers prepares their latest expedition. They safeguard the magic of exploration, transforming mysteries into enlightenment. As the seeker of mythical truths, your first challenge is to decode the enchanted scripts defining the guild&#39;s ability to handle dynamic tools and interact with users through magical channels. Will you navigate the golden pathways written within, and emerge with the wisdom to bind projects to their questful tales?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Scroll Mysteries</strong>: How does the <code class="inline-code">setupHandlers</code> function orchestrate dynamic tool listing and execution, including error handling mechanisms?</li>
<li>‚ö° <strong>Transport Pathways</strong>: What is the role of <code class="inline-code">run</code> in initializing the MCP server and pre-generating content?</li>
<li>üõ°Ô∏è <strong>Final Incantation Guard</strong>: How does the <code class="inline-code">main</code> function ensure safe startup and shutdown procedures in the presence of unforeseen errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Definition</h3>
<p>The <code class="inline-code">server.ts</code> file is the cornerstone of the Guild of Adventurers, managing tools as they navigate the enchanted Repository of Knowledge. Here lies the <code class="inline-code">RepoAdventureServer</code> class, where handlers for dynamic tool listing and execution are woven with error validation spells. The <code class="inline-code">run</code> function opens the magical pathways for server transport and pre-generates code insights. Finally, <code class="inline-code">main</code> guards the guild against unexpected calamities, assuring a graceful shutdown and error resilience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Implements tool listing and execution, validating arguments using schemas, and encapsulating error responses with <code class="inline-code">McpError</code>.</li>
<li><code class="inline-code">run</code>: Connects the MCP server via transport channels and pre-generates <code class="inline-code">repomix</code> content to enhance user experience.</li>
<li><code class="inline-code">main</code>: Manages initialization and shutdown rituals while safeguarding against unhandled events.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });
  
  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This function acts as the enchanted librarian, validating and executing tool magic with precision to avoid dangerous mishaps.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> function is akin to the knight&#39;s steed, carrying the server&#39;s magic across the lands and warming caches for a smooth journey.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The <code class="inline-code">main</code> function is the castle sentry, safeguarding the realm from destructive errors while preparing the server for combat.</p>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Test the <code class="inline-code">setupHandlers</code> implementation by examining tools returned from <code class="inline-code">ListToolsRequestSchema</code> and executing a valid tool via <code class="inline-code">CallToolRequestSchema</code>.</li>
<li>Analyze the server transport flow in <code class="inline-code">run</code> for insights into caching and initialization.</li>
<li>Simulate error events (e.g., SIGINT) to observe graceful shutdown procedures from <code class="inline-code">main</code>.</li>
</ul>
<hr>
<p>The Guild salutes your courage. Your heroic exploration of the MCP server spells marks the beginning of your quest mastery. Onward, seeker ‚Äì harmony awaits across the kingdoms.</p>
<p>With the valor of a fledgling hero and the spark of destiny ignited, Quest 1: The Guild of Adventurers has been conquered‚Äîmay this triumph herald the forging of a legendary saga! ‚ö°‚≠êüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>