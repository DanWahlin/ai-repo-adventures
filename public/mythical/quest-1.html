<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Palace of Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Codex: Adventures in a Kingdom of Mystical Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Palace of Tools</h1>
<hr>
<p>In the mystical heart of the Kingdom of Codeara lies the enigmatic Palace of Tools. This palace is said to house enchanted artifacts, each imbued with the power to manipulate the very essence of code. However, a hidden curse prevents these tools from being wielded freely‚Äîonly the worthy may align them with the kingdom‚Äôs ancient Server of Spells. To unlock their magic, an adventurer must study the Palace‚Äôs structure, decipher its arcane handlers, and ignite its latent powers. Dare you undertake this perilous journey through the coded corridors?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Manifestation Rites</strong>: How does <code class="inline-code">setupHandlers</code> dynamically manage and validate the tools within the system?  </li>
<li>‚ö° <strong>Invocation of Enchanted Powers</strong>: What steps does the <code class="inline-code">run</code> function take to initialize and prepare the adventure server for use?  </li>
<li>üõ°Ô∏è <strong>Fortress Defense Mechanisms</strong>: How does the <code class="inline-code">main</code> function ensure the stability of the server even in the face of unexpected challenges?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Server of Spells</h3>
<p>The <code class="inline-code">server.ts</code> file lays down the foundation for the mystical Server of Spells. It defines the <code class="inline-code">RepoAdventureServer</code> class, which acts as the orchestrator of all tool-based interactions. The three key magical rituals here‚Äî<code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code>‚Äîform the backbone of the adventure system. These functions dynamically summon tools, manage incoming spell requests, and invoke the overarching adventure server. They also feature intricate mechanisms for error handling, ensuring the system remains resilient even when faced with unpredictable magical disruptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists the tools available in the system and validates their parameters, ensuring only properly formed invocations succeed.</li>
<li><code class="inline-code">run</code> prepares the server, connects transport layers, and warms up critical caches to ready the server for immediate interaction.</li>
<li><code class="inline-code">main</code> activates the adventure server and establishes safeguards to handle system signals, promise rejections, and graceful shutdowns.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This function enables dynamic management of tools through protocols like <code class="inline-code">ListToolsRequestSchema</code>.</li>
<li>It validates tool inputs using Zod schemas, which ensures argument integrity for accurate execution.</li>
<li>Error handling is robust, with specific error codes assigned for missing tools and invalid parameters.</li>
<li>By mapping tool information dynamically, this code ensures an extensible system that seamlessly integrates new functionalities.</li>
<li>The design leverages standard schemas for compatibility and external tool registration.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> function initializes the server‚Äôs transport layer, enabling communication between the core system and tools.</li>
<li>It logs critical startup information, keeping the adventurer apprised of active processes.</li>
<li>Background cache generation enhances performance for future requests, creating a smoother user experience.</li>
<li>The <code class="inline-code">StdioServerTransport</code> integration demonstrates modularity, allowing for easier swapping or upgrading of transport systems.</li>
<li>The focus on readiness ensures the server can respond dynamically even while preloading resources.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function encapsulates the server lifecycle, from instantiation to activation.</li>
<li>It ensures graceful handling of system interrupts (like <code class="inline-code">SIGINT</code>), preventing abrupt shutdowns that could corrupt ongoing processes.</li>
<li>Logging unhandled promise rejections maintains system insight without forcibly stopping execution, reinforcing reliability.</li>
<li>Error handling for server initialization protects against startup failures due to unforeseen issues.</li>
<li>Combining signals with robust error handling guarantees that the system is both stable and user-aware.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how schemas are used in <code class="inline-code">setupHandlers</code>‚Äîthis technique ensures flexibility and extensibility as new tools are added.</li>
<li>Notice the use of <code class="inline-code">process.cwd()</code> in <code class="inline-code">run</code> for project-specific initialization.</li>
<li>Observe how graceful shutdowns are managed in <code class="inline-code">main</code>. These patterns are critical for building systems that operate in volatile environments.</li>
</ul>
<hr>
<p>The enchantment of the Server of Spells is now clear, adventurer. Carry this wisdom as you traverse through the Palace‚Äôs mysterious halls!</p>
<p>üåü Hail, noble adventurer, for thy valor and cunning hath illuminated the fabled Palace of Tools, raising thy first banner of triumph in this epic odyssey‚Äîonward to eternal glory! üöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>