<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Tools of Codara - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Forge of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Tools of Codara</h1>
<hr>
<p>In the mythical realm of Codara, a kingdom flourished where enchanted scrolls held the power of creation. These scrolls, infused with spells, wove tools, stories, and adventures to guide brave coders. At the heart of Codara was the enchanted Forge, a magical source of storytelling prowess. Yet, its wisdom could only be tapped by adventurers embarking on the Quest to master the Mystic Tools ‚Äì ancient artifacts that harmonized the enchanting scrolls. The journey began in the arcane library of the Mystic Code Processor, where the whispered tools lay dormant, awaiting a worthy hero. Adventure awaits, brave one!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Unveiling the Mystic Handlers</strong>: How does <code class="inline-code">setupHandlers</code> dynamically configure and validate tools to ensure the Forge&#39;s harmony?</li>
<li>‚ö° <strong>Summoning the Forge&#39;s Power</strong>: How does <code class="inline-code">run</code> initialize the Forge for operations and pre-generative content for seamless adventures?</li>
<li>üõ°Ô∏è <strong>Safeguarding the Forge</strong>: How does the <code class="inline-code">main</code> function prepare the system for threats like abrupt shutdowns or unhandled errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Codara Gateway</h3>
<p>This file is the entry point for the gamified server hosting Codara&#39;s adventures. It houses the foundational class <code class="inline-code">RepoAdventureServer</code>, which configures tools, handles user commands, and ensures system resilience. Additionally, the <code class="inline-code">main</code> function governs server start-up and ensures graceful handling of unexpected errors or shutdowns, mirroring the reliability of a mystic guardian.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists and validates tools, ensuring that only enchanted tools aligned with the Forge&#39;s schema are configured.</li>
<li><code class="inline-code">run</code> initializes the server and its magical transport while pre-generating structured content for user quests.</li>
<li><code class="inline-code">main</code> orchestrates server instantiation, configures graceful shutdowns, and handles potential initialization errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists all tools from the <code class="inline-code">tools</code> module by extracting their <code class="inline-code">name</code>, <code class="inline-code">description</code>, and validated input schema.</li>
<li>Uses Zod schemas to enforce strict input validation, preventing invalid parameters from disrupting the Forge.</li>
<li>Error handling elegantly distinguishes between user and system errors, providing meaningful feedback to users.</li>
<li>Encourages modular tool development by decoupling tool definitions and server execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes a <code class="inline-code">StdioServerTransport</code> to handle input/output, making the system compatible with command-line operations.</li>
<li>Connects the server to begin processing user input and tool requests.</li>
<li>Pre-generates content with <code class="inline-code">repoAnalyzer</code> for smoother user interactions by warming up caches in the background.</li>
<li>Outputs diagnostic information to help monitor server status and potential setup issues.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates an instance of <code class="inline-code">RepoAdventureServer</code>, setting the foundation for operational adventures.</li>
<li>Attaches signal listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to invoke <code class="inline-code">gracefulShutdown</code>, ensuring resource cleanup.</li>
<li>Monitors for unhandled promise rejections to log issues without destabilizing the server.</li>
<li>Implements robust top-level error handling during server initialization to prevent silent failures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Navigating Handlers</strong>: Follow the <code class="inline-code">setupHandlers</code> logic to understand how tools are dynamically integrated using schemas.</li>
<li><strong>Performance Insights</strong>: Investigate how <code class="inline-code">run</code> minimizes latency by warming caches with pre-generated content.</li>
<li><strong>Error Guards</strong>: Examine how <code class="inline-code">main</code> mitigates errors and prepares for unexpected shutdowns, ensuring system resilience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codara&#39;s enchanted libraries.</p>
<p>By the decree of the Celestial Scribes, your triumphant mastery of Quest 1‚ÄîThe Mystic Tools of Codara‚Äîhas ignited the eternal flame of heroism within the Kingdom of Scholars, advancing you toward the legendary path of enlightenment! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>