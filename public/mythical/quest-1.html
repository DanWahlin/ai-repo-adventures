<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Secrets of the Mystic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Codemiria</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Secrets of the Mystic Interface</h1>
<hr>
<p>In the mythical land of Codemiria, where logic and magic intertwine, the enchanted Scroll of Adventures has summoned knights of code to unravel the mysteries of the Mystic Interface. The illustrious Kingdom of Code relies on its heroic wizards to maintain the enchanted pipelines and tools that drive the realm forward. The first step in this grand journey reveals the secrets of the Mystic MCP Tool Interface, tasked with knitting the magical threads between tool invocation and quest progression. Brave adventurer, your path begins here!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Spellbinding</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically register and validate magical tools?</li>
<li>‚ö° <strong>Mystical Activation</strong>: How does <code class="inline-code">RepoAdventureServer.run</code> ignite the enchanted MCP server and prime the kingdom&#39;s transformative workflows?</li>
<li>üõ°Ô∏è <strong>Feral Errors</strong>: What protective measures in the <code class="inline-code">main</code> function safeguard the MCP server from unexpected magical disruptions during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Mystic MCP Tool Interface</h3>
<p>This file houses the core spells of the Mystic Interface, including dynamic tool registration and execution. The <code class="inline-code">RepoAdventureServer</code> class serves as the kingdom&#39;s enchanted gatekeeper, designed to orchestrate validation, execution, and communication of tools within Codemiria‚Äôs magical constructs. The file blends orchestrated initialization and real-time error intervention, ensuring the kingdom‚Äôs enchanted systems remain stable amidst chaotic quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists magical tools from <code class="inline-code">tools</code>, validates input schemas using enchanted Zod spells, and seamlessly executes tools during quests.</li>
<li><code class="inline-code">run</code> initiates the MCP server with <code class="inline-code">StdioServerTransport</code>, pre-generates mystical contents using <code class="inline-code">repoAnalyzer</code>, and sets the groundwork for seamless operations.</li>
<li><code class="inline-code">main</code> creates resilience against magical disruptions via graceful shutdown signals and unhandled rejection management, preserving the kingdom‚Äôs stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tools dynamically with schemas generated using Zod, ensuring input safety when magical parameters are received.</li>
<li>Provides robust error handling through <code class="inline-code">McpError</code> to guard against invalid invocations and execution malfunctions.</li>
<li>Simplifies tool registration using <code class="inline-code">Object.entries</code>, translating the enchanted tools list for seamless integration into the server.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initiates the MCP server with <code class="inline-code">StdioServerTransport</code> to establish the kingdom‚Äôs communication network.</li>
<li>Invokes <code class="inline-code">repoAnalyzer.preGenerate</code> to prime repomix content in the background, boosting server readiness for magical quests.</li>
<li>Console messages provide diagnostic feedback to aid realm wizards during server activation and cache preparation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Captures system signals (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>), enabling graceful shutdown and protection of mystical resources during emergencies.</li>
<li>Monitors unhandled promise rejections to maintain continuous operation of the MCP server despite magical glitches.</li>
<li>Initializes the heart of the MCP server through the <code class="inline-code">RepoAdventureServer.run</code> function, ensuring readiness to serve the kingdom‚Äôs enchanted quests.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Keep an eye on Zod schema transformations, as they play a pivotal role in validating magical spells.</li>
<li>Investigate <code class="inline-code">McpError</code> usage‚Äîit‚Äôs a crucial safeguard against tool invocation instability.</li>
<li>Follow the server activation sequence to understand how initialization ties into background content generation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codemiria‚Äôs enchanted systems.</p>
<p>Huzzah, noble adventurer! By unraveling the arcane glyphs of the Mystic Interface, you have unlocked the first starbound secret, proving your mettle as a true Luminary of Lore‚Äîonward to brighter conquests! ‚ö°‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>