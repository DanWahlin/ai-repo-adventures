<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Council of Bridges - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Enchanted Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Council of Bridges</h1>
<hr>
<p>You awaken in a coded kingdom where scrolls of logic bind castles of modules, and enchanted tools weave stories from your project‚Äôs soul. You learn the codebase conjures mythical adventures from repositories, forging quests that teach through magic: servers speak with wizards, analyzers read arcane files, and themes guide the saga. With each charm cast by <code class="inline-code">llm-client.ts</code> and each rune validated by <code class="inline-code">input-validator.ts</code>, your path unfolds toward a grand chronicle. Unite these powers, brave coder-knight, and the kingdom‚Äôs lore will reveal your project‚Äôs true legend. Adventure Awaits ‚Äì Choose your quest wisely, brave adventurer!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Bridge Mapping: How does <code class="inline-code">setupHandlers</code> transform the <code class="inline-code">tools</code> registry into a discoverable list with precise <code class="inline-code">inputSchema</code> enchantments?</li>
<li>‚ö° Signal Sigils: In <code class="inline-code">main</code>, how do signal listeners and unhandled rejection whispers preserve the server‚Äôs resilience without abrupt shutdowns?</li>
<li>üõ°Ô∏è Ward Weaving: How does the Call Tool path in <code class="inline-code">setupHandlers</code> enforce validation using Zod and raise <code class="inline-code">McpError</code> wards for different failure types?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Council‚Äôs conduit that binds the server to its magical tools</h3>
<p>This file raises the Council of Bridges, where the MCP <code class="inline-code">Server</code> convenes with the realm‚Äôs tools to serve callers across the land. The <code class="inline-code">RepoAdventureServer</code> constructs a <code class="inline-code">Server</code> with name, version, and capability sigils, then invokes <code class="inline-code">setupHandlers</code> to weave two crucial bridges: one for listing tools and one for invoking them. Through these bridges, the council reveals each tool‚Äôs lore (<code class="inline-code">description</code>) and its ritual form (<code class="inline-code">inputSchema</code>) derived from Zod via <code class="inline-code">zodToJsonSchema</code>, a transmutation circle ensuring clients send shaped offerings. When a caller seeks to wield a tool, <code class="inline-code">setupHandlers</code> validates parameters with <code class="inline-code">schema.safeParse</code>, assembles clear error incantations on failure, and throws potent <code class="inline-code">McpError</code> glyphs (<code class="inline-code">MethodNotFound</code>, <code class="inline-code">InvalidParams</code>, <code class="inline-code">InternalError</code>), so chaos remains caged.</p>
<p>In <code class="inline-code">run</code>, the standard streams crystallize a <code class="inline-code">StdioServerTransport</code> so the court can converse with summoners. Then a background rite warms caches as <code class="inline-code">repoAnalyzer.preGenerate</code> for the current path, speeding later divinations without blocking audience with the council. The outermost <code class="inline-code">main</code> ceremony installs gentle signal wards for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, invoking <code class="inline-code">gracefulShutdown</code> to tidy via <code class="inline-code">repoAnalyzer.cleanup</code>. It also listens for unhandled promise omens, logging them while keeping the server‚Äôs beacon lit. Together, these patterns form a steadfast fortress: discoverable tools, validated invocations, steady transport, and calm recovery.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> maps the living registry in <code class="inline-code">tools</code> to a formal list response and enforces guarded execution with Zod validation and <code class="inline-code">McpError</code> wards. This keeps the bridge safe and predictable.</li>
<li><code class="inline-code">run</code> awakens the server on stdio, then kindles a background cache warm-up through <code class="inline-code">repoAnalyzer.preGenerate</code>, improving performance without stalling the court‚Äôs opening.</li>
<li><code class="inline-code">main</code> orchestrates lifecycle sigils for termination and unhandled rejections, ensuring stability, graceful exits, and actionable logging for continued service.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}
</code></pre>
<ul>
<li>This code composes the bridge between summoners and tools, registering handlers for discovery and invocation.</li>
<li>It uses <code class="inline-code">zodToJsonSchema</code> to publish precise <code class="inline-code">inputSchema</code>, enabling clients to shape offerings correctly.</li>
<li>The guarded try/catch with <code class="inline-code">McpError</code> ensures clear fault lines: unknown tools, invalid parameters, and internal mishaps.</li>
<li><code class="inline-code">run</code> chooses stdio transport for broad compatibility and kicks off <code class="inline-code">repoAnalyzer.preGenerate</code> as a background boon.</li>
<li>Notice the non-blocking warm-up pattern: performance improves without delaying readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}

async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li><code class="inline-code">gracefulShutdown</code> is a closing ward that attempts <code class="inline-code">repoAnalyzer.cleanup</code> and exits with honor.</li>
<li><code class="inline-code">main</code> binds signal sigils and unhandled rejection watchers, balancing safety with uptime.</li>
<li>Errors during startup trigger an immediate, explicit exit, preserving deterministic behavior.</li>
<li>The final <code class="inline-code">main().catch</code> net ensures any stray omen is logged and handled decisively.</li>
<li>Together, these patterns form a robust lifecycle: predictable exits, resilient operation, and clear telemetry.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace how Zod schemas become JSON Schema with <code class="inline-code">zodToJsonSchema</code> to align client offerings with tool rituals.</li>
<li>Follow the flow from <code class="inline-code">ListToolsRequestSchema</code> to <code class="inline-code">CallToolRequestSchema</code> to see how discovery informs safe invocation.</li>
<li>Consider extending tools in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> next, then observe how they auto-appear via <code class="inline-code">setupHandlers</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, valiant hero‚Äîby convening the Council of Bridges you have forged the first pact of wisdom in this grand saga, and though the kingdom‚Äôs ledger still reads 0/4 quests complete, your triumphant chartering of Quest 1 marks a legendary dawn upon the road to glory, a beacon of resolve and mastery that will guide you to greater conquests ahead!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>