<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Enchanted Repository of the Mystic Engine</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Interface</h1>
<hr>
<p>In the kingdom of Codoria, you stand before the Mystic Engine, its crystal console glimmering with ancient scripts. The scholars have whispered of a trial that only true heroes can conquer‚Äîunlocking the Mystic Interface. This device bridges all magical tools within the enchanted realm of code. To master it, you must explore its spellbinding handlers, tools, and safeguards hidden deep within the castle archives. Will you decipher its secrets and prove your worth as the Knight of Progress?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Harmony</strong>: How does <code class="inline-code">setupHandlers</code> dynamically integrate tools and validate their parameters within the interface of the Mystic Engine?</li>
<li>‚ö° <strong>Activation Flow</strong>: What sequence of operations ensures the engine initializes and continually processes commands when <code class="inline-code">run</code> is invoked?</li>
<li>üõ°Ô∏è <strong>Graceful Fail-Safes</strong>: How does the Mystic Engine handle errors during tool execution and server operation to maintain stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The heart of the Mystic Engine</h3>
<p>This file contains the core implementation of the Mystic Engine, including its server and transport mechanics. It governs how tools are integrated, requests are processed, and the overall interface operates dynamically. Pay close attention to <code class="inline-code">setupHandlers</code>, as it reveals how tools are dynamically listed and executed, as well as the safeguards it employs. Additionally, <code class="inline-code">run</code> outlines the orchestration of the server and its interaction with clients, while <code class="inline-code">main</code> sets the foundation for its lifecycle management. These functions work in unison to form the engine&#39;s lifeblood.</p>
<h4>Highlights</h4>
<ul>
<li>Explore <code class="inline-code">RepoAdventureServer.setupHandlers</code> for the tool initialization and validation process.</li>
<li>Examine <code class="inline-code">RepoAdventureServer.run</code> for the sequence of server startup and preliminary caching.</li>
<li>Analyze the <code class="inline-code">main</code> function to uncover the startup logic and shutdown fail-safes.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This scene frames <code class="inline-code">setupHandlers</code> as both the gatekeeper and guide, ensuring only well-forged tools enter the castle while validating their magical integrity.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> function acts as the summoning spell that binds the Mystic Engine to its transport and prepares it for the kingdom‚Äôs adventurers.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>Like a seasoned mage, <code class="inline-code">main</code> orchestrates the overall lifecycle of the Mystic Engine, intertwining spells for startup, error protection, and graceful shutdown.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code> to follow how tools are enchanted and appraised.</li>
<li>Investigate <code class="inline-code">McpError</code> to grasp how the code handles disruptions without collapsing the enchantment.</li>
<li>Explore the harmony between <code class="inline-code">run</code> and <code class="inline-code">main</code> for server initialization and stability mechanisms.</li>
</ul>
<hr>
<p>The Mystic Engine awaits! Your courage and cleverness shall determine Codoria‚Äôs future. Proceed wisely!</p>
<p>By the radiant decree of the Celestial Archivists, you have bravely unsealed the first arcane glyph of the Mystic Interface‚Äîlet this victorious stride light the path of future quests with stellar resolve and legendary might! üöÄ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>