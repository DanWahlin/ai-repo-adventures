<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Unravel the Mystic Code (MCP Tool Interface) - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Enchanted Adventures of the Codebound Kingdom</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Unravel the Mystic Code</h1>
<hr>
<p>In the magical realm of Codethia, a grim shadow threatens the enchanted framework that keeps the kingdom thriving. Fragments of the Mystic Code, once unified by wisdom scrolls, are scattered across the land. Brave Knight of Syntax, your journey begins within the castle‚Äôs hidden archives. Using the MCP Tool Interface, you must uncover the sacred spells nested within its two mystical scrolls‚Äîthe <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>. Only by deciphering their secrets can you restore balance and set forth to the next heroic challenge.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Mysteries</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools, and what validations ensure the knights choose correctly?</li>
<li>‚ö° <strong>Summoning Spells</strong>: How does <code class="inline-code">run</code> establish the magical transport, and what preemptive actions prepare the realm for exploration?</li>
<li>üõ°Ô∏è <strong>Guardians of Syntax</strong>: What strategies does the <code class="inline-code">main</code> function use to safeguard the magical code and ensure graceful shutdowns?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Configuration and Tool Handler Setup</h3>
<p>This file is the heart of MCP‚Äôs operation within Codethia, serving as the enchanted framework managing tools and interactions. It carefully constructs and connects the <code class="inline-code">Server</code> entity, empowering knights to journey through mystic quests. <code class="inline-code">setupHandlers</code> dynamically enlists powerful tools to the arsenal, ensuring alignment with Zod schemas for tool invocation safety. Meanwhile, <code class="inline-code">run</code> activates the transport system and pre-generates repomix content, preparing adventurers for smooth exploration. The <code class="inline-code">main</code> function ensures the safeguarding of operation while managing interruptions and errors.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically enlists tools and validates knight invocations through Zod schemas, preventing improper usage.</li>
<li><code class="inline-code">run</code>: Establishes the server transport and pre-generates repomix content, creating a seamless exploration process.</li>
<li><code class="inline-code">main</code>: Manages high-level control flow, integrating graceful shutdowns and error handling for uninterrupted adventures.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools into the MCP server, building a scalable handler structure.</li>
<li>Leverages Zod schemas for input validation, ensuring knights invoke tools properly.</li>
<li>Provides robust error handling mechanisms using <code class="inline-code">McpError</code>, protecting the integrity of tool execution.</li>
<li>Extracts tool details dynamically, simplifying future expansion of available tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server using <code class="inline-code">StdioServerTransport</code>, enabling seamless communication.</li>
<li>Executes repomix content pre-generation to optimize the knights‚Äô exploration experience.</li>
<li>Utilizes asynchronous actions for improved responsiveness during initialization.</li>
<li>Integrates project path retrieval and caching strategies for efficient content pipeline support.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal handling for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, ensuring graceful server shutdown.</li>
<li>Captures unhandled promise rejections, logging them without disrupting ongoing operations.</li>
<li>Uses high-level exception handling to prevent fatal errors, maintaining reliability under unexpected conditions.</li>
<li>Integrates the <code class="inline-code">RepoAdventureServer</code>, establishing the primary quest execution environment.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Definitions and MCP Integration</h3>
<p>This file represents the mystical arsenal used by adventurers within Codethia. Each tool‚Äîsuch as <code class="inline-code">start_adventure</code> and <code class="inline-code">explore_quest</code>‚Äîis a manifest designed to support knights in their exploration. Organized and centrally exported within the <code class="inline-code">tools</code> object, they allow seamless registration into the server runtime, unifying their descriptions and schema enforcement so the MCP framework operates flawlessly.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and initializes themed adventures, setting the narrative foundation.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a custom story and quests based on selected themes, empowering knights to choose their path.</li>
<li><code class="inline-code">explore_quest.handler</code>: Guides knights through individual challenges, enabling iterative exploration of the realm.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides completion updates, ensuring adventurers monitor their heroic journey.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports tools in a consolidated object, facilitating centralized management and streamlined registration.</li>
<li>Ensures tight coupling of each tool‚Äôs functionality with its schema, maintaining system accuracy.</li>
<li>Encourages modular addition or modification of tools with minimal impact on the overall MCP tool interface.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review validation mechanisms in <code class="inline-code">setupHandlers</code> to understand correct invocation patterns for tools.</li>
<li>Explore pre-generation strategies in <code class="inline-code">run</code> to discover how caching optimizes user experience.</li>
<li>Study graceful shutdown techniques in <code class="inline-code">main</code> to adopt best practices for error handling and system stability.</li>
</ul>
<hr>
<p>Excellent work! Venture onward to reveal deeper mysteries and illuminate Codethia with the light of knowledge.</p>
<p>By the radiant stars of the ever-knowing cosmos, noble hero, you have unlocked the ancient Mystic Code, forging the first triumph in your legendary quest‚Äîmay your quill of wisdom glow ever brighter!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>