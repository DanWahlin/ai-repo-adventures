<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Castle‚Äôs Enchanted Doors - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Castle‚Äôs Enchanted Doors</h1>
<hr>
<p>In the magical kingdom of Codethria, the Mystic Repository&#39;s balance has been shattered, and its enchanted doors now refuse to yield to those who lack the knowledge of their spells. The Council of Developers has summoned you to investigate the very fabric of this enigmatic stronghold. Your first task is to examine the castle‚Äôs mystical framework‚Äîdelving into the code behind its interactive pathways and decoding the mechanisms of its tools. Will you unlock the secrets of the Repository and earn its trust?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Enchantment</strong>: How are tools dynamically listed and validated for requests? What mechanisms prevent improper invocations?</li>
<li>‚ö° <strong>Castle&#39;s Lifeblood Flow</strong>: What happens during the server initialization, and how is the adventure pre-generated for seamless gameplay?</li>
<li>üõ°Ô∏è <strong>Guardians of the Gate</strong>: What protective measures are in place to handle unexpected errors or invalid interactions with the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Enchanting the Castle&#39;s Core</h3>
<p>The <code class="inline-code">server.ts</code> file forms the enchanted heart of the Repository&#39;s system. Here, the <code class="inline-code">RepoAdventureServer</code> provides the magical infrastructure that ensures the tools can assist adventurers. Key spells include the dynamic handlers for listing and executing tools, validating their input against codified rules (Zod schemas), and safeguarding the system from errors. The <code class="inline-code">run</code> function breathes life into the server, initializing transports and triggering background processes to prepare the castle for new explorers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures request handlers for dynamically listing tools and validating input schemas, ensuring only valid spells can be invoked.</li>
<li><code class="inline-code">run</code>: Activates the server transport, initializes the system, and pre-generates Repository content, paving the way for new heroes.</li>
<li><code class="inline-code">main</code>: Oversees the grand initialization ceremony. It handles signals for graceful shutdowns and ensures unhandled rejections are logged without disrupting the server.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Defines handlers that dynamically list all available tools and their properties.</li>
<li>Converts Zod schemas into JSON schema definitions, ensuring input requirements are clear.</li>
<li>Validates tool invocation arguments and executes tools only if they meet precise criteria.</li>
<li>Implements robust error handling mechanisms to differentiate between known and unknown issues.</li>
<li>Guards the Repository‚Äôs functionality by isolating invalid inputs from wider system disruptions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server communication through the <code class="inline-code">StdioServerTransport</code> spell.</li>
<li>Logs server activation and provides insight into its operational state for developers.</li>
<li>Initiates background content generation to enhance performance during exploration phases.</li>
<li>Uses the current working directory as the project path, reinforcing adaptability for different repos.</li>
<li>Ensures adventurers experience smooth, uninterrupted journeys through pre-cache warming.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Invokes key components, orchestrating the startup flow for the MCP server.</li>
<li>Implements signal listeners to handle <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> gracefully, cleaning up before shutting down.</li>
<li>Captures unhandled promise rejections to avoid server crashes while providing adequate logging.</li>
<li>Differentiates between catastrophic and recoverable errors with clear decision-making conditions.</li>
<li>Wraps the server invocation in an error-handling construct, ensuring a controlled environment.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tip</strong>: Pay attention to Zod schema integration for dynamic validation. It‚Äôs a powerful mechanism to ensure safe and accurate tool interactions.</li>
<li><strong>Recommendation</strong>: Observe how the <code class="inline-code">setupHandlers</code> function lays the groundwork for scalable and flexible tool management.</li>
<li><strong>Next Steps</strong>: Investigate the tools‚Äô detailed implementations in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> for insights into individual capabilities.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>The stars of the astral kingdom gleam in your honor, brave hero, as you triumphantly unlock the Enchanted Doors and embark on the path to legendary glory! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>