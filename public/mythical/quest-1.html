<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Gatekeepers of Toolhaven - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository of Aetheria</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Gatekeepers of Toolhaven</h1>
<hr>
<p>In the mystical land of Aetheria, your journey begins in Toolhaven ‚Äì the enchanted workshop of the Repository of Codes. Here, the &quot;Mystic Gatekeepers&quot; guard the spells that bind Aetheria&#39;s knowledge. However, their balance has been disrupted by the Chaos of Bugs. To restore harmony, you must face the gatekeepers and decode the secrets behind their operation. Within the sacred scrolls, you‚Äôll uncover the magical incantations that manage tools and their invocation. Brave apprentice, the fate of Aetheria lies in your hands!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Invocation Rituals</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list tools and handle requests for tool execution?  </li>
<li>‚ö° <strong>Arcane Flows</strong>: What role does the <code class="inline-code">run</code> method play in initializing the enchanted server&#39;s operation?  </li>
<li>üõ°Ô∏è <strong>Safeguarding Spells</strong>: How are errors and interruptions handled during the server&#39;s lifecycle, especially in <code class="inline-code">main</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core of the Mystic Gatekeepers</h3>
<p>This file contains the implementation of the enchanted server responsible for managing Aetheria&#39;s tool invocations. It ensures smooth interaction with tools, including dynamic listing and secure execution. The methods included here also handle lifecycle management and error mitigation, aligning the system with the mystical values of order and safety.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This method dynamically lists tools and sets up handlers for tool execution requests. It ensures that available tools and their parameters are validated before invocation.</li>
<li><code class="inline-code">run</code>: The central function that connects the server to the mythical transport layer and prepares the enchanted cache for faster tool execution.</li>
<li><code class="inline-code">main</code>: The entry point of the server, managing critical lifecycle flows, setting up signals for graceful shutdowns, and handling unhandled promise rejections to maintain system stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of tools with descriptions and input schemas by leveraging <code class="inline-code">zodToJsonSchema</code>.</li>
<li>Validates tool arguments using Zod schemas, ensuring secure and error-resistant interactions.</li>
<li>Maps tool execution requests to appropriate handlers, logging any exceptions as part of robust error management.</li>
<li>Centralizes tool management, maintaining consistency and extensibility in handling tool invocation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server&#39;s transport layer using <code class="inline-code">StdioServerTransport</code> for interactive communication.</li>
<li>Logs server status to ensure visibility during the tool&#39;s operation.</li>
<li>Warm-up caching (<code class="inline-code">preGenerate</code>) enhances performance by preparing data in advance.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Registers graceful shutdowns via <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> signals to prevent unexpected data loss.</li>
<li>Manages unhandled promise rejections with robust logging mechanisms.</li>
<li>Includes lifecycle error handling to ensure a resilient operation during initialization failures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Consider <code class="inline-code">setupHandlers</code> the &quot;index of spells&quot; for aligning tools with their purpose. Investigate how Zod schemas enforce consistency.</li>
<li>The <code class="inline-code">run</code> method functions as your server&#39;s heart ‚Äì warm-up actions like <code class="inline-code">preGenerate</code> demonstrate performance optimization techniques.</li>
<li><code class="inline-code">main</code> exemplifies harmony between broader lifecycle management and detailed error handling strategies.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the valor of a true hero, you have unlocked the ancient secrets of the Mystic Gatekeepers of Toolhaven‚Äîan epic first triumph on your legendary journey through the Kingdom of Five Quests! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>