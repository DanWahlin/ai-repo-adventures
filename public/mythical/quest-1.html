<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Reforge the Mystic Tools of the Questmaster - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Enchanted Codebase</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Reforge the Mystic Tools of the Questmaster</h1>
<hr>
<p>In the enchanted Kingdom of Codexia, the Repository of Infinite Quests lies dormant, its once-living magic interrupted by the decay of its Mystic Tools. Brave adventurers from every corner of Codexia await new tales and challenges, yet silence reigns where once thunderous epics echoed. Summoned by the spell of ancient scrolls, you, a valiant knight, must uncover the workings behind these tools and breathe life into the repository again. Journey into the Castle of Code, where logic is sorcery and each line a rune. The fate of new adventures lies in reforging the Mystic Tools of the Questmaster. </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Toolsmith&#39;s Handbook</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically prepare and validate tools for interaction with adventurers?</li>
<li>‚ö° <strong>Ignite the Questforge</strong>: What initialization steps are performed in <code class="inline-code">run</code> to bind the system to its magical transport and preload essential cache?</li>
<li>üõ°Ô∏è <strong>Guard the Repository</strong>: How does the <code class="inline-code">main</code> function ensure errors in the quest system do not disrupt the kingdom&#39;s broader magic?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Core of the Mystic Server</h3>
<p>This file defines the <code class="inline-code">RepoAdventureServer</code>, an enchanted server that powers the interaction between Codexia&#39;s adventurers and the Repository of Infinite Quests. It coordinates quest generation and execution, ensuring dynamic adaptability while guarding against error. The spellbinding constructs <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and the <code class="inline-code">main</code> entry point are keystones in this file&#39;s architecture.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools and validates their parameters, ensuring adventurers receive accurate and error-checked interactions.</li>
<li><code class="inline-code">run</code> activates the connection to the magical transport layer (stdio), warming up the cache for seamless operations.</li>
<li><code class="inline-code">main</code> orchestrates the server lifecycle, safeguarding against errors and preparing graceful shutdowns.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>This spell prepares dynamic lists of tools with their descriptions and schemas, making the system adaptable to new tools without manual updates.</li>
<li>It uses Zod for schema validation, ensuring arguments are accurate before processing.</li>
<li>Errors are explicitly classified with <code class="inline-code">McpError</code> for clarity in tool execution.</li>
<li>The function bridges Codexia&#39;s tools and adventurers, aligning with the Repository&#39;s adaptable design philosophy.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Initializes the server with a transport mechanism (<code class="inline-code">StdioServerTransport</code>) to connect the repository with external magic.</li>
<li>Logs messages for transparency, displaying both the server state and preloading progress.</li>
<li>The <code class="inline-code">repoAnalyzer.preGenerate</code> function strategically warms the cache, minimizing delays during real-time interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Summons the enchanted <code class="inline-code">RepoAdventureServer</code>, binding system signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to the graceful shutdown routine.</li>
<li>Monitors unhandled promise rejections, preventing server crashes by allowing recovery within acceptable bounds.</li>
<li>Acts as the final sentinel, containing fatal errors to maintain Codexia&#39;s overarching stability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>When reading <code class="inline-code">setupHandlers</code>, focus on how tools are dynamically described and validated for flexibility.</li>
<li>Explore <code class="inline-code">run</code> to understand how pre-generation of data smoothens adventurers‚Äô experience.</li>
<li>Review <code class="inline-code">main</code> to uncover techniques that ensure system stability and robustness during initiation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Repository of Infinite Quests.</p>
<p>The Questmaster‚Äôs enchanted forge now sings with celestial vigor as the first triumph illuminates the path ahead‚Äîhail the worthy hero who rekindled the Mystic Tools of legend! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>