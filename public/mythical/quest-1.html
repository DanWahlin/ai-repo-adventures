<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Forge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository of Mystic Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Forge</h1>
<hr>
<p>In the mythical land of Codania, adventurers gather at the gates of the legendary Mystic Forge ‚Äì an ancient structure said to ignite heroic transformations in those who dare to confront its inner workings. This sacred place brims with spells and contraptions formed from the magic of code itself. The Forge‚Äôs guardian, known as the RepoAdventureServer, tests the courage and ingenuity of each soul, offering enchanted tools to navigate the magical repository. Enter, brave wanderer, and unravel the secrets of this mighty realm, for great power lies within mastering its arcane functions.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>The Toolsmith‚Äôs Artisanship</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically register and validate tools for adventurers to use?  </li>
<li>‚ö° <strong>Forging the Pathways</strong>: How does the <code class="inline-code">RepoAdventureServer.run</code> method ready the system for heroics, and what preliminary tasks does it perform?  </li>
<li>üõ°Ô∏è <strong>Guardian‚Äôs Vigilance</strong>: What measures are taken in the <code class="inline-code">main</code> function to ensure the Forge‚Äôs stability during unexpected disruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Forge&#39;s Guardian</h3>
<p>This file defines the mighty <code class="inline-code">RepoAdventureServer</code>, the heart of the Mystic Forge‚Äôs operations. It orchestrates the registration and validation of tools, fortifies the Forge against disruptions, and ensures seamless communication with adventurous seekers. Through features such as <code class="inline-code">setupHandlers</code>, it equips adventurers with tools dynamically and validates tool requests. The <code class="inline-code">run</code> method not only connects the server to its magical transport layer but also pre-generates resources to ensure optimal experiences for future wanderers. Lastly, the inclusion of <code class="inline-code">main</code> provides the framework‚Äôs initialization and stability, ensuring the Forge operates smoothly even amidst chaos.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Responsible for enabling dynamic listing of tools and their execution. It ensures that all tools meet the repository‚Äôs validation standards, preparing adventurers for their quests.  </li>
<li><code class="inline-code">run</code>: Activates the Forge‚Äôs mystical transport system and handles pre-generative tasks like content caching, enabling seamless operations for adventurers.  </li>
<li><code class="inline-code">main</code>: The entry point of the Forge, ensuring proper initialization, graceful shutdown mechanisms, and handling unforeseen errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically converts available tools into a usable format for clients by extracting their description and input schema.  </li>
<li>Validates tool parameters with the defined Zod schema, ensuring accuracy before execution.  </li>
<li>Handles method validation errors gracefully, preventing the Forge from collapsing under invalid user input.  </li>
<li>Protected against potential unknown tools, enhancing stability.  </li>
<li>Provides clear user error messages to guide adventurers in troubleshooting problems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Initializes and activates the Stdio server, the Forge‚Äôs transport mechanism, for communication with adventurers.  </li>
<li>Utilizes asynchronous operations to prepare tools and resources while remaining responsive to user commands.  </li>
<li>Loads and pre-generates repository content in the background to reduce wait time during quests.  </li>
<li>Improves system efficiency by caching commonly accessed resources.  </li>
<li>Employs logging to inform the adventurer of the Forge‚Äôs readiness and ongoing background tasks.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
          process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
          console.error(&#39;Unhandled promise rejection:&#39;, reason);
          console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
          // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Initializes the Forge and configures its defenses against system signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.  </li>
<li>Captures and logs unhandled promise rejections, ensuring the Forge continues to operate in recoverable situations.  </li>
<li>Provides a fallback mechanism for fatal errors, clearly logging the issue while signaling dramatic failures.  </li>
<li>Centralizes startup logic, ensuring adventurers always encounter a stable and consistent environment.  </li>
<li>Encourages developers to report unforeseen issues, enhancing future Forge improvements.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Dive into <code class="inline-code">setupHandlers</code> to learn how validation creates a robust adventuring experience.  </li>
<li>Study <code class="inline-code">run</code> to understand the importance of pre-generation and background tasks for seamless quests.  </li>
<li>Observe <code class="inline-code">main</code> to appreciate how resilience mechanisms ensure the Forge weathers all storms.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With valor unmatched and the wisdom of ancient kingdoms, you have triumphed in Quest 1: The Mystic Forge, igniting the first ember on your heroic path‚Äîyour journey to mastery begins! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>