<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Codebook of Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Realm of Enchanted Repositories</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Codebook of Tools</h1>
<hr>
<p>In the mystical Kingdom of Codeoria, a legendary prophecy speaks of an artifact ‚Äì the Code Grimoire ‚Äì split into enigmatic chapters. For the first chapter, brave knights must seek the Mystic Codebook of Tools. This enchanted volume binds the essence of all tools used to conjure interactive quests. However, it is protected by spells of dynamic validation and guarded by the mythical Schema Sentinel. To claim the Codebook, adventurers must decipher its creation and unleash its full potential.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Mapping Magical Tools</strong>: How does the system dynamically list and describe tools, ensuring they serve their purpose without causing havoc?</li>
<li>‚ö° <strong>Flow of the Enchantment</strong>: What is the flow of initializing and running the enchanted server to handle multiple requests from adventurers?</li>
<li>üõ°Ô∏è <strong>Guarding Against Chaos</strong>: How does the system validate input and handle errors or unexpected tool usage?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The Enchanted Server</h3>
<p>This file houses the <code class="inline-code">RepoAdventureServer</code> class, the cornerstone of the Mystic Codebook‚Äôs functionality. It initializes the magical server, enabling adventurers to interact with the enchanted tools. Key features include dynamic tool management and input validation, ensuring that heroes do not invoke forbidden spells or mishandle the enchanted artifacts. This creation showcases a central <code class="inline-code">run</code> method for starting its operations and a <code class="inline-code">setupHandlers</code> method to define the spells of tool listing and execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools and validates input schemas, invoking their handlers safely.</li>
<li><code class="inline-code">run</code> initializes the transport layer and pre-generates content to empower adventurers without delay.</li>
<li><code class="inline-code">main</code> orchestrates the server startup and handles unexpected interruptions gracefully.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps and lists tools, ensuring that their names, descriptions, and input schemas are accessible to adventurers.</li>
<li>Validates input arguments for tools against their <code class="inline-code">Zod</code> schemas to prevent errors during handling.</li>
<li>Explicitly handles unknown tools and provides meaningful error messages for invalid parameters.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes communication with adventurers through the <code class="inline-code">StdioServerTransport</code>, ensuring seamless interactions.</li>
<li>Pre-generates repository content to enhance performance, reducing lag during quests.</li>
<li>Outputs informative messages, maintaining awareness of system status and cache preparation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Ensures graceful shutdown to avoid disruptions when adventurers end their journey or when errors occur.</li>
<li>Catches unhandled promise rejections while keeping the server operational for resilience.</li>
<li>Initializes the primary server logic and provides recovery mechanisms for unforeseen circumstances.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Follow the <code class="inline-code">setupHandlers</code> structure to learn how dynamic content can simplify tool management.</li>
<li>Investigate how <code class="inline-code">run</code> pre-generates content for smoother quest interactions.</li>
<li>Be curious about error-handling mechanisms used in <code class="inline-code">main</code> for robust and graceful operations.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, brave scholar, for with the unearthing of the Mystic Codebook of Tools, you have forged the first star in the constellation of wisdom‚Äôs eternal kingdom‚Äînow onward, champion, to illuminate the path that awaits! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>