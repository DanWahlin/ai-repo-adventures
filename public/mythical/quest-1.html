<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Realm of Mystic Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Enchanted Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Realm of Mystic Tools</h1>
<hr>
<p>In the magical Kingdom of Codemyr, where enchanted spells power every castle and village, the Repository Scroll has whispered rumors of the Realm of Mystic Tools. These mystical implements hold the key to decoding the scroll&#39;s mysterious constructs. Queen Syntaxia summons you, the valiant Code Knight, to begin your legendary adventure by uncovering the mechanisms behind these enchanted tools. Armed with your code-wielding prowess, delve into the kingdom‚Äôs enchanted files to unravel their secrets and safeguard Codemyr&#39;s treasures!</p>
<h2>Quest Objectives</h2>
<p>As you explore the mystical code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Ritual</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically list and execute enchanted tools in response to scroll queries?</li>
<li>‚ö° <strong>Server Enchantment Process</strong>: What initialization steps in <code class="inline-code">run</code> prepare the MCP Server to connect transports and pre-generate magical content for adventurers?</li>
<li>üõ°Ô∏è <strong>Error Safeguarding</strong>: How does <code class="inline-code">main</code> handle edge cases, unexpected errors, and protect the kingdom&#39;s systems during server startup?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server and Handlers</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> file establishes the magical server, called RepoAdventureServer, that manages enchanted tools and directs adventurers. This file contains three primary highlights: <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code>. <code class="inline-code">setupHandlers</code> dynamically manages tool invocation via client requests, validating inputs and executing appropriate handlers. The <code class="inline-code">run</code> method sets up the server transport, while <code class="inline-code">main</code> launches the server with error-handling mechanisms fit for a Code Knight protecting against system faults.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists registered tools and executes their handlers by validating input schemas using <code class="inline-code">zod-to-json-schema</code>. Critical for guiding adventurers through tool-based quests.</li>
<li><code class="inline-code">run</code>: Initializes the network transport and pre-generates repository content to ensure smooth adventuring experiences. Essential to server readiness.</li>
<li><code class="inline-code">main</code>: Orchestrates server startup, implementing robust error handling to safeguard the magical system against unforeseen dangers like unhandled rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically builds tool lists using input schemas defined in <code class="inline-code">tools</code>.</li>
<li>Ensures robust input validation using <code class="inline-code">zod.safeParse</code>, preventing malformed data errors.</li>
<li>Centralizes tool execution logic, simplifying future tool extensions.</li>
<li>Uses <code class="inline-code">McpError</code> objects for clear error messaging to adventurers.</li>
<li>Shields the system from invalid data by proactively validating parameters.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server using <code class="inline-code">StdioServerTransport</code>, enabling communication with adventurers via standard input/output.</li>
<li>Displays server status messages to ensure adventurers are informed of readiness.</li>
<li>Proactively pre-generates repository context using <code class="inline-code">repoAnalyzer.preGenerate</code>, reducing content generation latency during quests.</li>
<li>Leverages <code class="inline-code">process.cwd()</code> to automatically detect the current project directory.</li>
<li>Prioritizes seamless setup for efficient magical explorations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal handling (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for safe shutdown of the server during interruptions.</li>
<li>Logs unhandled promise rejections to allow troubleshooting without server termination.</li>
<li>Protects server startup using a <code class="inline-code">try-catch</code> block, ensuring fatal errors are caught and logged.</li>
<li>Ensures Codemyr‚Äôs magical system is resilient against runtime errors.</li>
<li>Provides maintainable logging mechanisms for adventurers and developers alike to track server activity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Using the <code class="inline-code">setupHandlers</code> logic, experiment with adding new tools by defining schemas and handlers in <code class="inline-code">tools.ts</code>.</li>
<li>Pay attention to input validation techniques in <code class="inline-code">setupHandlers</code>. Explore how errors are constructed for user-friendly feedback.</li>
<li>Investigate <code class="inline-code">run</code> pre-generation logic to optimize quest initialization times based on repository size.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codemyr and protect its enchanted systems.</p>
<p>With valor that echoes through enchanted realms, thou hast triumphed in Quest 1: Realm of Mystic Tools ‚Äî may the stars guide thee onward to the splendors of thy heroic saga! ‚ö°‚≠êüöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>