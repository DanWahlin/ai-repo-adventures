<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Knights of the MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Realm of Codaria</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Knights of the MCP Tool Interface</h1>
<hr>
<p>In the mystical realm of Codaria, the ancient Castle Configura hums with the magic of enchanted scripts. Within its wizard-towered halls, the knights of the MCP Tool Interface ready their arms to combat the Chaos Bug. This nefarious foe corrupts functionality and disrupts the harmony of spellbinding code. Brave adventurer, your journey begins here. You must explore the lore captured within the MCP‚Äôs arcane files to uncover how tools are forged and quests are shaped. Wield these magical implements to restore order to Codaria‚Äôs code-charmed lands!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Mapping Chronicles</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools and validate their descriptions and schemas?</li>
<li>‚ö° <strong>Command Summoning Path</strong>: How does the <code class="inline-code">run</code> method initialize the system and pre-generate repository content for seamless interaction?</li>
<li>üõ°Ô∏è <strong>Error Cleansing Ritual</strong>: How does <code class="inline-code">main</code> handle shutdown signals and protect the system from unruly errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Foundations</h3>
<p>This file reveals the wisdom of the MCP server‚Äôs inner workings. It constructs the enchanted backbone that supports tool registration and execution. Through <code class="inline-code">setupHandlers</code>, knights ensure their tools are initiated with proper magical descriptions and parameters validated using schemas. The <code class="inline-code">run</code> method prepares the realm for interactive use, warming caches to guard against interruption. Finally, <code class="inline-code">main</code> invokes the MCP server‚Äôs startup and handles potential disruptions gracefully. These functions exemplify Codaria‚Äôs spellcraft, ensuring its enchanted systems remain resilient.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: This method dynamically registers tools, validating their configurations. It ensures tools are described and their input schemas are correctly mapped using <code class="inline-code">zodToJsonSchema</code>.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Initializes the MCP server transport, connects the magical interface, and pre-generates repository insights with <code class="inline-code">repoAnalyzer.preGenerate</code>.</li>
<li><code class="inline-code">main</code>: Handles MCP server startup while safeguarding against interruptions like shutdown signals or promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tools dynamically using <code class="inline-code">zodToJsonSchema</code>, ensuring input schemas are mapped to JSON schema definitions.</li>
<li>Protects against invalid tool execution with comprehensive error handling using <code class="inline-code">McpError</code>.</li>
<li>Demonstrates a modular approach to tool invocation and validation, centralizing logic for consistent tool configuration.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the MCP server via <code class="inline-code">StdioServerTransport</code>, initializing communication through a sturdy neural pathway for command exchange.</li>
<li>Prepares the repository landscape by invoking <code class="inline-code">repoAnalyzer.preGenerate</code>, warming the cache for optimal subsequent interactions.</li>
<li>Ensures seamless initiation of interactions by avoiding delays in analyzer setup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Handles graceful shutdown through <code class="inline-code">process.on</code>, ensuring resources are cleaned once signals are captured (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).</li>
<li>Monitors unhandled rejections without triggering server shutdown, offering resilience against unexpected conditions.</li>
<li>Establishes robust MCP server initialization logic, preparing the enchanted script realms for uninterrupted workflow.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To understand how tools are registered and validated, focus on <code class="inline-code">setupHandlers</code> and its usage of Zod schemas.</li>
<li>Investigating <code class="inline-code">run</code> will provide insight into system initialization and preemptive caching mechanisms.</li>
<li>Observe <code class="inline-code">main</code> for strategies to protect the server from abrupt interruptions or unhandled promise rejections.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within Codaria‚Äôs enchanted code realms.</p>
<p>Behold, brave hero, thou hast conquered the arcane trials of Quest 1: Knights of the MCP Tool Interface, ascending as a true champion of the digital realm‚Äîmarch onward to further glory! ‚öîÔ∏èüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>