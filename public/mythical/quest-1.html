<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Castle of the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Mystic Chronicles of Codethoria</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Castle of the MCP Interface</h1>
<hr>
<p>In the enchanted realm of Codethoria, whispers abound of a foreboding fortress: the Castle of the MCP Interface. This bastion, guarded by powerful utility spells and fortified with dynamic code enchantments, holds the key to unlocking the realm‚Äôs mythical Repo Adventures. However, the castle‚Äôs defenses are impenetrable without understanding the magic that both summons tools and executes quests. As a Code Knight, your mission is to decipher the MCP Interface&#39;s mystical layers and unravel its spell-bound secrets.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Tool Invocation Ceremony</strong>: How are mythical tools dynamically listed and validated through magical schemas in <code class="inline-code">setupHandlers</code>?  </li>
<li>‚ö° <strong>Adventure Startup Ritual</strong>: What initialization spells are cast in the <code class="inline-code">run</code> function to awaken the mystical MCP server?  </li>
<li>üõ°Ô∏è <strong>Fortress Shutdown Protocols</strong>: How does <code class="inline-code">main</code> ensure graceful server shutdown and safeguard against unexpected threats?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: MCP Server Constructs</h3>
<p>The file reveals the spellcraft that summons and wields Repo Adventures as interactive quests. Here lies the heart of the MCP Interface: a castle brimming with logic for listing tools dynamically (<code class="inline-code">setupHandlers</code>) and executing them safely, along with ceremony-like commands for server initialization (<code class="inline-code">run</code>) and graceful shutdown (<code class="inline-code">main</code>).  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Maps tool names to their descriptions and schemas. Tools from the mystical <code class="inline-code">tools.js</code> file are dynamically listed for adventurers to wield, ensuring magical Zod schemas validate all input.  </li>
<li><code class="inline-code">run</code>: Activates the MCP Interface using a <code class="inline-code">StdioServerTransport</code>. Pre-generates cached content via <code class="inline-code">repoAnalyzer</code> for seamless workflows while awaiting adventurer commands.  </li>
<li><code class="inline-code">main</code>: Handles ultimate control over the castle‚Äôs operations. It summons the server, listens for shutdown signals, and guards against destructive errors.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {   
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  
    
    return { tools: toolList };  
  });  

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    try {  
      const { name, arguments: args } = request.params;  

      if (!(name in tools)) {  
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
      }  

      const tool = tools[name as keyof typeof tools];  
      const validationResult = tool.schema.safeParse(args);  
      if (!validationResult.success) {  
        const errorMessages = validationResult.error.issues.map((err) =&gt;   
          `${err.path.join(&#39;.&#39;)}: ${err.message}`  
        ).join(&#39;, &#39;);  
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
      }  

      return await tool.handler(validationResult.data as any);  

    } catch (error) {  
      if (error instanceof McpError) {  
        throw error;  
      }  
      throw new McpError(  
        ErrorCode.InternalError,  
        `Tool execution failed: ${error}`  
      );  
    }  
  });  
}  
</code></pre>
<ul>
<li>This snippet dynamically lists tools, converting SDK-defined schemas into JSON schemas using <code class="inline-code">zodToJsonSchema</code>. It‚Äôs crucial for maintaining compatibility between tools and MCP adventures.  </li>
<li><code class="inline-code">CallToolRequestSchema</code> ensures arguments are validated to prevent adventurer errors during tool execution with helpful feedback.  </li>
<li>Patterns like safe parsing (<code class="inline-code">safeParse</code>) and central error handling emphasize robust and fail-safe tool invocation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  

  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> function invokes the MCP castle‚Äôs mystical transport: <code class="inline-code">StdioServerTransport</code>, a conduit for quest communication between client and server.  </li>
<li>The <code class="inline-code">repoAnalyzer.preGenerate</code> prewarms caches for efficient operation, epitomizing forward-thinking design in enchanted systems.  </li>
<li>This function links setup rituals to community service; adventurers can immediately explore quests without waiting for barren caches to populate.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
    });  
    
    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}  
</code></pre>
<ul>
<li><code class="inline-code">main</code> serves as the castle‚Äôs summoning chamber. It initializes the <code class="inline-code">RepoAdventureServer</code>, attaches robust signal handlers for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, and shields the MCP Interface from rogue promise rejections.  </li>
<li>By centralizing shutdown logic (<code class="inline-code">gracefulShutdown</code>), this code protects the interface from chaotic exits, ensuring ritualistic order in unforeseen scenarios.  </li>
<li>Its modularity makes the castle easy to expand, combining elegance with a methodical fail-safe design.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Understand the interaction between server transport initialization (<code class="inline-code">run</code>) and tool invocation logic (<code class="inline-code">setupHandlers</code>). These constructs operate in harmony to uphold the MCP Interface magic.  </li>
<li>Investigate error-handling constructs in <code class="inline-code">main</code> and <code class="inline-code">CallToolRequestSchema</code> to study patterns that defend the interface against edge cases and chaos.</li>
</ul>
<hr>
<p>The secrets of the Castle of the MCP Interface have been unveiled! Dare to continue your quest and explore the enchanted depths of Codethoria?</p>
<p>Huzzah, noble learner, for you have stormed the castle gates of the MCP Interface and claimed the first jewel of wisdom on your epic quest‚Äîonward to the next legendary challenge! ‚öîÔ∏èüíéüìú</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>