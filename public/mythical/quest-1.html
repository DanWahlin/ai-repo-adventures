<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Castle's Mystic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Castle&#39;s Mystic Interface</h1>
<hr>
<p>In the heart of the Enchanted Kingdom of Code lies the Repository ‚Äì a castle brimming with magical scrolls and boundless wisdom. Developers brave its winding corridors in search of the Quest Scrolls to create legendary adventures. Your journey begins in the castle‚Äôs Mystic Interface ‚Äì a portal where spells known as &quot;tools&quot; awaken to life. Discover the ancient mechanisms of the server that brings these tools to eager heroes across the kingdom. Brace yourself, adventurer, as the castle grows more complex with every step.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Spell Cataloging</strong>: How does the server dynamically assemble the list of available tools in the kingdom?</li>
<li>‚ö° <strong>Ritual Execution</strong>: What steps does the server follow to validate and invoke a magical tool‚Äôs handler?</li>
<li>üõ°Ô∏è <strong>Failsafe Enchantments</strong>: How is error handling woven into the server to protect the kingdom from unworthy spells or mishaps?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server Infrastructure for Tool Invocation</h3>
<p>This file outlines the enchanted infrastructure of the Mystic Interface. The <code class="inline-code">RepoAdventureServer</code> class is the centerpiece, imbuing the castle with the power to list available tools and execute them. Its <code class="inline-code">setupHandlers</code> method initializes the two key components: the dynamic tool catalog and the invocation mechanism. The <code class="inline-code">run</code> method breathes life into the server, creating a direct channel between the realm of Developers and the tool repository. Graceful shutdown mechanisms ensure the magic fades without disrupting the delicate balance of the repository.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers all available tools and configures the castle‚Äôs magical response system, combining intuitive input validation with execution logic.</li>
<li><code class="inline-code">run</code> establishes the Mystic Interface‚Äôs transport layer, triggers tool-loading rituals, and warms up the cache for smoother adventures.</li>
<li><code class="inline-code">main</code> acts as the central summoning spell, connecting heroes to the server while guarding against unplanned interruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map(err =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers all tools, ensuring a scalable and flexible system for adding new magical spells.</li>
<li>Validates tool arguments against schemas to reject malformed invocations before execution.</li>
<li>Implements structured error handling to distinguish tool-specific failures from internal server errors.</li>
<li>Converts Zod schemas to JSON schemas, enabling broader compatibility across the castle‚Äôs systems.</li>
<li>Maintains an organized response structure to facilitate smooth integration with mystical Developer interfaces.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Activates the Mystic Interface, enabling communication between tools and Developers.</li>
<li>Initializes the working directory‚Äôs context to showcase prepared content during the Developer‚Äôs journey.</li>
<li>Prefetches repository data to optimize the spell-casting experience in real-time.</li>
<li>Employs the <code class="inline-code">StdioServerTransport</code> layer for robust message transmission between realms.</li>
<li>Prints status updates to inform Developers of the castle‚Äôs readiness and ongoing preparations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Orchestrates the startup sequence, ensuring the Mystic Interface is ready for the Developer‚Äôs journey.</li>
<li>Listens for termination signals, executing a graceful shutdown that preserves the castle‚Äôs stability.</li>
<li>Implements recovery mechanisms to handle unhandled promise rejections during runtime.</li>
<li>Provides detailed logging to keep Developers informed, aiding troubleshooting in the face of unexpected errors.</li>
<li>Centralizes the logic for error handling and process lifecycle management.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>ü™Ñ <strong>Uncover Connections</strong>: Observe how <code class="inline-code">setupHandlers</code> relies on shared tool registries, discovering the modularity underpinning the castle‚Äôs design.</li>
<li>üîÆ <strong>Trace the Path</strong>: Follow the invocation flow from tool listing to execution for hidden patterns.</li>
<li>üõ†Ô∏è <strong>Expand the Castle</strong>: Consider how additional tools can be integrated into this architecture.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Huzzah, brave adventurer, for you have unraveled the arcane secrets of the Mystic Interface in the Castle&#39;s labyrinth‚Äîa triumphant first step on your legendary quest, shining like a ‚≠ê among the stars of the realm!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>