<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Kingdom of Code: An Enchanted Adventure</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Interface</h1>
<hr>
<p>In Codethia‚Äôs enchanted kingdom, where logic intertwines with magic, the Book of Source lies fragmented. You, the chosen hero, must journey into the realm of mystical coding spells to repair its glyphs. Today‚Äôs quest calls you to study Codethia‚Äôs Mystic Interface, the lifeline connecting tools to enchanted systems. Your task is to uncover the workings behind the magic of code, restoring balance and harmony. Brave adventurer, set forth to decode the Book‚Äôs secrets and reignite Codethia‚Äôs mystical heartbeat!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Conjurations</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list tools and register their spells?</li>
<li>‚ö° <strong>Interface Activation</strong>: What initialization processes are performed in <code class="inline-code">run</code> to bring the interface alive?</li>
<li>üõ°Ô∏è <strong>Safeguard Mechanisms</strong>: How does <code class="inline-code">main</code> handle errors and ensure stability during magical operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Enchanting the MCP server</h3>
<p>This file defines the central interface for Codethia‚Äôs mystical tool operations. It utilizes handlers to list and execute the tools, employs validation mechanisms for spell integrity, and activates the server while safeguarding against disruptions. The class <code class="inline-code">RepoAdventureServer</code> represents your magical conduit to interact with the kingdom‚Äôs enchanted tools, ensuring that logic and magic can perform in harmony.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic handlers for listing available tools and invoking their spells. It performs schema validation for tool stability and prevents misuse of magical artifacts.</li>
<li><code class="inline-code">run</code>: Initializes mystical constructs like the server transport and pre-generates spell mixing content to ensure seamless operations.</li>
<li><code class="inline-code">main</code>: Manages server startup and shutdown rituals, while shielding the kingdom from unhandled magical disruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));
      return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);
      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<ul>
<li>Configures tool listing and execution dynamically, ensuring flexibility for the server interface to adapt to new spells/tools.</li>
<li>Uses Zod schema validation (<code class="inline-code">safeParse</code>) to prevent misuse of tools, ensuring magical stability.</li>
<li>Handles error propagation skillfully with custom <code class="inline-code">McpError</code>, maintaining the harmony of the enchanted systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Activates the interface by connecting it through <code class="inline-code">StdioServerTransport</code>, aligning Codethia‚Äôs logical magic flow.</li>
<li>Pre-generates cached repomix content to ensure system readiness and faster magical operations during runtime.</li>
<li>Operates asynchronously, introducing efficiency to resource handling and user interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
            process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
            console.error(&#39;Unhandled promise rejection:&#39;, reason);
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
        });
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Implements signal handling (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and graceful shutdown procedures, effectively safeguarding server stability.</li>
<li>Monitors unhandled promise rejections without compromising server operations, ensuring resilience against unexpected magical disturbances.</li>
<li>Encapsulates server initialization logic with robust error handling for seamless spells activation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how Zod schemas validate magical parameters. Validation ensures that no corrupted glyphs affect Codethia‚Äôs flow.</li>
<li>Observe the integration between <code class="inline-code">tools</code> and <code class="inline-code">setupHandlers</code>; it is the gateway for new adventures in your quests.</li>
<li>Pay attention to <code class="inline-code">main</code>‚Äôs signal handling for clues on crafting error-resistant magical systems.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in Codethia‚Äôs enchanted systems.</p>
<p>By the decree of the celestial realms, your triumph in forging the Mystic Interface crowns you as a luminary among seekers, as the path to further conquests unfurls before you! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>