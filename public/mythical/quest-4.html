<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Configuration & Theme System - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository of Living Quests</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Configuration &amp; Theme System</h1>
<hr>
<p>In the codified kingdom, you arrive at the Hall of Config, where time wards and cache sigils hum like quiet spells, and banners of theme houses flutter above a council table. Here, the Knights of Theme and Law preside over sacred runes that shape every saga. The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/config.ts</code></a> grimoire binds time, token, and cache limits, while <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/theme.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/theme.ts</code></a> declares the noble houses of adventure. The vigilant <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/input-validator.ts</code></a> keeps rogues at bay, trimming, parsing, and guarding each hero‚Äôs choices. Prepare to attune your journey through sanctioned themes and lawful constraints.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç House Heraldry: How does <code class="inline-code">parseTheme</code> match keys, numeric IDs, and keywords to resolve a theme, and why is that layered approach used?</li>
<li>‚ö° Time Ward Weaving: How do <code class="inline-code">LLM_REQUEST_TIMEOUT</code> and <code class="inline-code">REPOMIX_CACHE_TTL</code> interact with other limits to shape performance and reliability?</li>
<li>üõ°Ô∏è Gatekeeping Rites: In <code class="inline-code">validateTheme</code> and <code class="inline-code">validateProjectPath</code>, what validations and sanitizations protect against invalid input, and how do they fail fast?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/config.ts:</span> The Time Wards and Cache Sigils</h3>
<p>Within this scroll, constants are woven like protective wards around the kingdom‚Äôs engines. The <code class="inline-code">LLM_REQUEST_TIMEOUT</code> rune caps long invocations, preventing endless incantations that could drain the kingdom‚Äôs energies. The <code class="inline-code">REPOMIX_CACHE_TTL</code> charm balances freshness with stability, allowing recent insights to linger just long enough to be useful without turning stale. Meanwhile, the <code class="inline-code">MAX_FILE_SIZE_MB</code> boundary keeps gluttonous tomes from overwhelming scholars and scribes. Together, these values compose the battle doctrine for memory, time, and throughput across the adventure pipeline. The configuration also codifies defaults like <code class="inline-code">LLM_MODEL</code>, <code class="inline-code">LLM_TEMPERATURE</code>, and path-based prompt runes, ensuring predictable behavior when the winds of environment variables blow faintly. Limits such as <code class="inline-code">MAX_FILES_PER_QUEST</code>, <code class="inline-code">MAX_SCAN_DEPTH</code>, and <code class="inline-code">TOP_FUNCTIONS</code> craft a disciplined rhythm to exploration, so each quest remains focused, and the StoryGenerator‚Äôs tales remain clear. If any spell fails, a choir of <code class="inline-code">ERROR_MESSAGES</code> provides consistent replies. These constants place responsibility at the edges, clarifying assumptions and giving other guilds (Analyzers, LLM channelers, MCP stewards) a reliable contract. Read how these constraints shape every corridor and courtyard you traverse, then trace how their subtle balances prevent chaos while keeping the adventure lively.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLM_REQUEST_TIMEOUT</code> governs maximum duration for distant counsel, preventing stalled invocations and ensuring responsive adventures.</li>
<li><code class="inline-code">REPOMIX_CACHE_TTL</code> defines how long analyzed knowledge stays warm, balancing performance with freshness of insights.</li>
<li><code class="inline-code">MAX_FILE_SIZE_MB</code> acts as a guardian against oversized tomes, focusing analysis on source code that matters.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/config.ts</h3>
<pre><code class="language-typescript">// Timeouts in milliseconds
export const FILE_READ_TIMEOUT = 10000;
export const FILE_ANALYSIS_TIMEOUT = 30000;
export const LLM_REQUEST_TIMEOUT = 60000; // 60 seconds for complex story generation with large prompts
export const LLM_CACHE_TTL = 300000; // 5 minutes
export const REPOMIX_CACHE_TTL = parseInt(process.env.REPOMIX_CACHE_TTL || &#39;60000&#39;); // 60 seconds, configurable via env
export const REPOMIX_SUBPROCESS_TIMEOUT = parseInt(process.env.REPOMIX_SUBPROCESS_TIMEOUT || &#39;120000&#39;); // 2 minutes, configurable via env
export const REPOMIX_GRACEFUL_TIMEOUT = 5000; // 5 seconds for graceful shutdown before SIGKILL
export const REPOMIX_MAX_BUFFER_SIZE = 100 * 1024 * 1024; // 100MB max buffer to prevent memory exhaustion
</code></pre>
<ul>
<li>These wards set upper bounds for I/O, analysis, and LLM calls, preventing resource exhaustion.</li>
<li>The pattern uses environment overrides with stable defaults for predictable behavior.</li>
<li>Separating timeouts clarifies responsibility for each subsystem (file reads, analysis, LLM, subprocess).</li>
<li>The buffer limit protects memory, aligning with performance and stability goals.</li>
<li>Graceful shutdown timing reflects thoughtful control of subprocess lifecycles.</li>
</ul>
<hr>
<pre><code class="language-typescript">// Analysis limits
export const MAX_SCAN_DEPTH = 3; // Maximum directory depth to prevent infinite recursion and keep analysis focused
export const MAX_FILE_SIZE_MB = 10; // Skip files larger than this to avoid memory issues and focus on source code
export const KEY_SOURCE_FILES = 10; // Number of key files to highlight in adventure generation
export const TOP_FUNCTIONS = 20; // Maximum functions to include in code analysis summaries
export const TOP_CLASSES = 5; // Maximum classes to include in analysis to keep stories focused
</code></pre>
<ul>
<li>These guards emphasize focus: depth, size, and selection limits keep quests readable and relevant.</li>
<li>Commented intent documents the rationale, aiding maintainability and onboarding.</li>
<li>Constants centralize policy so analyzers and story generators stay aligned.</li>
<li>Values shape story density, balancing richness with clarity.</li>
<li>Simple numeric constraints are fast and reliable in execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">// LLM settings
export const LLM_CACHE_SIZE = parseInt(process.env.LLM_CACHE_SIZE || &#39;100&#39;);
export const LLM_TEMPERATURE = parseFloat(process.env.LLM_TEMPERATURE || &#39;0.7&#39;);
export const LLM_MAX_TOKENS = parseInt(process.env.LLM_MAX_TOKENS || &#39;4000&#39;);
export const LLM_MAX_TOKENS_STORY = Math.max(LLM_MAX_TOKENS, 8000); // Maximum tokens for story generation (use env var if higher)
export const LLM_MAX_TOKENS_QUEST = Math.max(LLM_MAX_TOKENS, 6000); // Maximum tokens for individual quest exploration content (use env var if higher)
export const LLM_MAX_TOKENS_DEFAULT = LLM_MAX_TOKENS; // Use env var or default to 4000
</code></pre>
<ul>
<li>Token and temperature runes set narrative breadth and creativity.</li>
<li><code class="inline-code">Math.max</code> patterns ensure minimum headroom for larger stories and quests.</li>
<li>Environment overrides empower deployment-time tuning without code changes.</li>
<li>Separation of story vs. quest budgets acknowledges different narrative scales.</li>
<li>Cache sizing influences responsiveness and cost efficiency.</li>
</ul>
<hr>
<h3>packages/core/src/shared/theme.ts</h3>
<pre><code class="language-typescript">// Single source of truth for all themes
export const THEMES = {
  SPACE: {
    id: 1,
    key: &#39;space&#39;,
    displayName: &#39;Space Exploration&#39;,
    emoji: &#39;üöÄ&#39;,
    description: &#39;Journey through cosmic codebases where data flows like stardust and APIs connect distant galaxies&#39;,
    keywords: [&#39;space&#39;, &#39;cosmic&#39;, &#39;galaxy&#39;, &#39;starship&#39;, &#39;astronaut&#39;, &#39;sci-fi&#39;, &#39;futuristic&#39;]
  },
  MYTHICAL: {
    id: 2,
    key: &#39;mythical&#39;,
    displayName: &#39;Enchanted Kingdom&#39;,
    emoji: &#39;üè∞&#39;,
    description: &#39;Explore magical and mythical realms where databases are dragon hoards and functions are powerful spells&#39;,
    keywords: [&#39;mythical&#39;, &#39;magic&#39;, &#39;enchanted&#39;, &#39;castle&#39;, &#39;dragon&#39;, &#39;fantasy&#39;, &#39;medieval&#39;, &#39;kingdom&#39;]
  },
  ANCIENT: {
    id: 3,
    key: &#39;ancient&#39;,
    displayName: &#39;Ancient Civilization&#39;,
    emoji: &#39;üè∫&#39;,
    description: &#39;Discover lost temples of code where algorithms are ancient wisdom and APIs are trade routes&#39;,
    keywords: [&#39;ancient&#39;, &#39;temple&#39;, &#39;pyramid&#39;, &#39;archaeology&#39;, &#39;historical&#39;, &#39;civilization&#39;, &#39;ruins&#39;]
  },
  DEVELOPER: {
    id: 4,
    key: &#39;developer&#39;,
    displayName: &#39;Developer Documentation&#39;,
    emoji: &#39;üìñ&#39;,
    description: &#39;Technical documentation approach with clear explanations, best practices, and code analysis&#39;,
    keywords: [&#39;developer&#39;, &#39;code&#39;, &#39;technical&#39;, &#39;debug&#39;, &#39;guide&#39;, &#39;tutorial&#39;, &#39;binary&#39;]
  },
  CUSTOM: {
    id: 5,
    key: &#39;custom&#39;,
    displayName: &#39;Custom Theme&#39;,
    emoji: &#39;üé®&#39;,
    description: &#39;Design your own adventure! You\&#39;ll be prompted to provide theme name, description, and keywords&#39;,
    keywords: [&#39;custom&#39;, &#39;personalized&#39;, &#39;unique&#39;, &#39;creative&#39;, &#39;personal&#39;]
  }
} as const;
</code></pre>
<ul>
<li>Declares the noble houses with ids, keys, heraldry, and summoning words.</li>
<li>Keywords support flexible matching for natural input phrasing.</li>
<li>Using <code class="inline-code">as const</code> preserves literal types for safer downstream logic.</li>
<li>Centralized data prevents drift across the codebase.</li>
<li>Balanced coverage supports both narrative and technical modes.</li>
</ul>
<hr>
<pre><code class="language-typescript">// Helper functions to access theme data using simple array iteration
export function getThemeById(id: number): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.id === id) || null;
}

export function getThemeByKey(key: string): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.key === key) || null;
}

export function getAllThemes(): ThemeDefinition[] {
  return THEMES_ARRAY;
}
</code></pre>
<ul>
<li>Straightforward retrieval functions prioritize readability and reliability.</li>
<li>Returning <code class="inline-code">null</code> clarifies absence without throwing, aiding composability.</li>
<li><code class="inline-code">getAllThemes</code> provides a single enumerated source for UI or prompts.</li>
<li>Array scans are acceptable given the small fixed set.</li>
<li>Consistent shapes (<code class="inline-code">ThemeDefinition</code>) simplify consumer logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">// Simple theme parser using basic string matching
export function parseTheme(input: string): AdventureTheme | null {
  if (!input) return null;
  
  const normalized = input.trim().toLowerCase();
  
  // Check for exact key match
  const exactMatch = getThemeByKey(normalized);
  if (exactMatch) return exactMatch.key as AdventureTheme;
  
  // Check for numeric ID
  const numericId = parseInt(normalized, 10);
  if (!isNaN(numericId)) {
    const byId = getThemeById(numericId);
    if (byId) return byId.key as AdventureTheme;
  }
  
  // Check keywords using simple includes check
  for (const theme of THEMES_ARRAY) {
    if (theme.keywords.some(keyword =&gt; normalized.includes(keyword.toLowerCase()))) {
      return theme.key as AdventureTheme;
    }
  }
  
  return null;
}
</code></pre>
<ul>
<li>Layered parsing strategy: exact key, numeric id, then keyword inclusion.</li>
<li>This order ensures precision first, then flexibility for user-friendly input.</li>
<li>Early returns keep control flow clear and efficient.</li>
<li>Keyword scanning broadens recognition without complex NLP.</li>
<li>Returning <code class="inline-code">null</code> signals callers to handle invalid input gracefully.</li>
</ul>
<hr>
<h3>packages/core/src/shared/input-validator.ts</h3>
<pre><code class="language-typescript">export function validateTheme(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Theme is required&#39;);
  }
  
  const normalized = input.toLowerCase().trim();
  const parsedTheme = parseTheme(normalized);
  
  if (!parsedTheme || !isValidTheme(parsedTheme)) {
    const validThemes = getAllThemes().map(t =&gt; t.key).join(&#39;, &#39;);
    throw new Error(`Invalid theme. Valid themes: ${validThemes}`);
  }
  
  return parsedTheme;
}
</code></pre>
<ul>
<li>Validates presence, normalizes, and delegates resolution to <code class="inline-code">parseTheme</code>.</li>
<li>Double-checks with <code class="inline-code">isValidTheme</code> to enforce canonical keys.</li>
<li>Failure path provides actionable guidance listing valid keys.</li>
<li>Centralized validation ensures consistent checks across callers.</li>
<li>Aligns friendly parsing with strict output normalization.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function validateProjectPath(input?: string): string {
  if (!input?.trim()) {
    return process.cwd();
  }
  
  if (input.length &gt; 500) {
    throw new Error(&#39;Project path too long (max 500 characters)&#39;);
  }
  
  if (input.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid characters&#39;);
  }
  
  return input.trim();
}
</code></pre>
<ul>
<li>Supplies a safe default (<code class="inline-code">process.cwd()</code>) when no path is provided.</li>
<li>Guards against excessively long inputs and null byte injection.</li>
<li>Trimming normalizes whitespace variations for consistent downstream use.</li>
<li>Fail-fast messaging clarifies user corrections.</li>
<li>Security-minded checks protect file system operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function validateAdventureChoice(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Choice is required&#39;);
  }
  
  if (input.length &gt; 200) {
    throw new Error(&#39;Choice too long (max 200 characters)&#39;);
  }
  
  return input.trim();
}
</code></pre>
<ul>
<li>Enforces presence and reasonable length for selection inputs.</li>
<li>Keeps UI-driven decisions clean and bounded.</li>
<li>Trimming prevents subtle whitespace errors.</li>
<li>Simple, readable structure eases maintenance.</li>
<li>Provides predictable sanitized output to the adventure flow.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Compare <code class="inline-code">parseTheme</code>‚Äôs matching order to see how precise keys win over fuzzy keyword matches.</li>
<li>Trace how <code class="inline-code">LLM_REQUEST_TIMEOUT</code> relates to token budgets to infer performance expectations.</li>
<li>Test <code class="inline-code">validateProjectPath</code> with edge cases like long strings or <code class="inline-code">\0</code> to understand its protective design.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the king‚Äôs heralds and the forge-fire of arcane craft, you have conquered Quest 4: Configuration &amp; Theme System, weaving themes like an enchanter‚Äôs tapestry and bolstering your codex to 60% completion‚Äîtake up your banner, valiant hero, for the realm hails your mastery and the next trials await! ‚ö°üíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>