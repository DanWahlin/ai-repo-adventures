<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Arcane Texts of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository: Quests of the Mystic Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Arcane Texts of Analysis</h1>
<hr>
<p>In the enchanted Kingdom of Codevale, the Mystic Codex reveals its fourth challenge: mastering the arcane art of analysis‚Äîa sacred skill designed to extract meaning from the scripts of mythical realms. Within the Codex&#39;s intricately woven spells lies the key to processing enchanted texts and decoding patterns that prepare the kingdom&#39;s adventures. To complete this trial, adventurers must venture deep into the files <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a> and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>, where two powerful artifacts, the <code class="inline-code">RepoAnalyzer</code> engine and <code class="inline-code">LLMClient</code>, hold cryptic incantations for unlocking creative and efficient storytelling.</p>
<p>Adventure awaits, brave hero. May your path be guided by analysis and revelations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Analyzer&#39;s Compass</strong>: How does the <code class="inline-code">validateProjectPath</code> ensure safe traversal within the repository without risking instability?</li>
<li>‚ö° <strong>Patterns of Extraction</strong>: What techniques does <code class="inline-code">extractFunctionFocusedContent</code> employ to highlight essential mythical patterns while reducing unnecessary complexity?</li>
<li>üõ°Ô∏è <strong>Guarded Knowledge</strong>: How does <code class="inline-code">generateResponse</code> handle error scenarios and ensure clean interactions with the enchanted texts generated by the LLM?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Repository Analyzer</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> acts as a magical lens over vast repositories, deciphering code and condensing chapters of scripts into optimally focused summaries. This engine not only processes entire realms of files but carefully validates paths and optimizes outputs for future quests. It highlights essential code constructs and eliminates extraneous or unsafe lines, ensuring heroes only interact with vital elements of the repository.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Ensures the repository path is legitimate, guarding against null bytes and traversal risks.</li>
<li><code class="inline-code">extractFunctionFocusedContent</code>: Refines code by extracting critical functions and patterns, allowing token-efficient representations.</li>
<li><code class="inline-code">generateOptimizedContent</code>: Combines validation and optimization for efficient analysis across interconnected scripts.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">/**
 * Basic validation for project path - minimal checks for actual use case
 */
private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  // Basic safety check for null bytes (can break file system operations)
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures the <code class="inline-code">projectPath</code> is well-formed and non-empty, rejecting invalid input.</li>
<li>Guards against null byte injection, preventing potential filesystem exploits.</li>
<li>Protects the stability of repository operations by validating path integrity before processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Extract function-focused content from full repomix output
 * Optimizes token usage by keeping only essential code patterns
 */
private extractFunctionFocusedContent(fullContent: string): string {
  const lines = fullContent.split(&#39;\n&#39;);
  const optimizedLines: string[] = [];
  let currentFile = &#39;&#39;;
  let inCodeBlock = false;
  let codeBlockLanguage = &#39;&#39;;
  let currentCodeBlock: string[] = [];
  let skipFile = false;

  for (let i = 0; i &lt; lines.length; i++) {
    const line = lines[i];
    const trimmedLine = line.trim();

    // Track current file
    if (trimmedLine.startsWith(&#39;## File:&#39;) || trimmedLine.startsWith(&#39;# File:&#39;)) {
      currentFile = trimmedLine.replace(/^##?\s*File:\s*/, &#39;&#39;);
      skipFile = this.shouldSkipFile(currentFile);
      
      if (!skipFile) {
        optimizedLines.push(line); // Keep file header
      }
      continue;
    }

    // Handle code blocks
    if (trimmedLine.startsWith(&#39;```&#39;)) {
      if (!inCodeBlock) {
        inCodeBlock = true;
        codeBlockLanguage = trimmedLine.replace(&#39;```&#39;, &#39;&#39;);
        currentCodeBlock = [line];
      } else {
        inCodeBlock = false;
        currentCodeBlock.push(line);
        optimizedLines.push(this.optimizeCodeBlock(currentCodeBlock, codeBlockLanguage));        
      }
      continue;
    }

    if (inCodeBlock) {
      currentCodeBlock.push(line);
      continue;
    }

    optimizedLines.push(line); // Add only useful lines at top-level
  }

  return optimizedLines.join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Focuses on extracting critical functions, classes, and patterns from the repository scripts.</li>
<li>Filters only &quot;important&quot; lines such as exports, imports, and key code structures.</li>
<li>Uses brace depth tracking and pattern matching to identify relevant code topics while excluding trivial data or comments.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Generate optimized function-focused content for specific files
 */
async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);

  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
  const optimizedContent = this.extractFunctionFocusedContent(fullContent);

  this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });
  return optimizedContent;
}
</code></pre>
<ul>
<li>Combines path validation and file optimization with caching to enhance performance.</li>
<li>Guarantees that analysis focuses only on validated and safe paths.</li>
<li>Provides token-efficient summaries for efficient processing in subsequent workflows.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: LLM Interaction Module</h3>
<p>The <code class="inline-code">LLMClient</code> is an enchanted messenger that whispers prompts to mythical AI models, such as GPT-5. It is tasked with both generating creative outputs for kingdom adventures and protecting the process through rigorous error handling and token management. Its design ensures seamless integration with complex realms produced by Content Generators while safeguarding stability during interactions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Sends prompts to AI models, validates their responses, and handles errors gracefully.</li>
<li><code class="inline-code">constructor</code>: Initializes the client with either OpenAI or Azure configurations based on the kingdom&#39;s needs.</li>
<li><code class="inline-code">getApiKey</code>: Resolves the API key for integration and ensures compatibility with mystical servers.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
  }
}
</code></pre>
<ul>
<li>Manages interactions with the LLM, from prompt creation to response validation.</li>
<li>Includes measures for handling incomplete, malformed, or empty outputs.</li>
<li>Ensures consistent post-processing of JSON responses wrapped in Markdown.</li>
</ul>
<hr>
<pre><code class="language-typescript">  constructor() {
    this.model = LLM_MODEL;
    
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model
      });
    } else {
      this.client = new OpenAI({
        apiKey,
        baseURL: LLM_BASE_URL
      });
    }
  }
</code></pre>
<ul>
<li>Ensures proper setup of either OpenAI or Azure configurations depending on the environment.</li>
<li>Verifies the presence of necessary keys and URLs, preventing misconfigured setups.</li>
<li>Dynamically adjusts the behavior for specialized deployments like GPT-5.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Resolve API key for integrations
 */
private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Resolves and validates the API key based on the chosen platform (Azure or OpenAI).</li>
<li>Prevents missing or incorrect configurations during client initialization.</li>
<li>Guards the flow of setup by raising clear errors when required parameters are absent.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üó∫Ô∏è Validate repository paths before embarking on any major analysis to avoid runtime missteps.</li>
<li>üîé Focus your investigation on the optimization patterns used in <code class="inline-code">extractFunctionFocusedContent</code> for efficient token use.</li>
<li>üí° Study the error handling mechanisms in <code class="inline-code">generateResponse</code> to master safe LLM interactions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Mystic Codex and its enchanted kingdom!</p>
<p>Upon the grand battleground of knowledge, you have claimed victory over Quest 4: The Arcane Texts of Analysis, wielding wisdom like a legendary blade‚Äîpress onward, for the realms of mastery lie within your heroic grasp! ‚ö°üì°‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>