<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Sage's Observatory - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Framework of Mythica</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Sage&#39;s Observatory</h1>
<hr>
<p>In the heart of Mythica lies the Sage&#39;s Observatory, perched atop the Mystic Peaks. The observatory, said to house the secrets of the Code of Unity, serves as a beacon for those seeking mastery over their magical tools. The Sage scribes ancient spells on enchanted scrolls and studies cosmic patterns to ensure the observatory‚Äôs mechanisms align with the artifact. Brave adventurer, your task is to descend into the labyrinth of code that powers these tools, uncover their mysteries, and preserve the Observatory‚Äôs delicate harmony.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Mechanism of Invocation</strong>: How does the <code class="inline-code">generateResponse</code> function build and execute the requests to the language model, and what considerations are accounted for in the implementation?</li>
<li>‚ö° <strong>Foundations of Communication</strong>: In the <code class="inline-code">RepoAnalyzer</code>, how are project files validated and normalized to ensure secure and efficient analysis?</li>
<li>üõ°Ô∏è <strong>Error Sentinels</strong>: How do both the <code class="inline-code">LLMClient</code> and <code class="inline-code">RepoAnalyzer</code> handle and log errors to maintain robustness and transparency during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Language Model Driver</h3>
<p>The <code class="inline-code">LLMClient</code> serves as a guide between the Code of Unity and the users of its magic. It forms the bridge, enabling adventurers to converse with mythical models. This file defines how the connection is initialized, how prompts are prepared, and how the responses are managed. Its capability to switch between OpenAI and AzureOpenAI models demonstrates its adaptability to varying power sources within Mythica.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Constructs and sends requests to the LLM, processing responses or errors effectively for further use.</li>
<li><code class="inline-code">constructor</code>: Initializes the client, ensuring the proper configuration for either Azure or OpenAI-based engines.</li>
<li><code class="inline-code">getApiKey</code>: Validates and selects the appropriate API key based on the environment and the target LLM.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">generateResponse</code> function plays a pivotal role, orchestrating how prompts are transformed into actionable outputs.</li>
<li>Demonstrates robust error logging through <code class="inline-code">logDetailedError</code> to maintain transparency.</li>
<li>Ensures adaptability with optional response formatting, allowing for both text and structured JSON outputs.</li>
<li>Integrates token usage logging to keep track of resource utilization.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Ensures all initialization variables are configured securely before establishing connectivity with LLM engines.</li>
<li>Differentiates Azure-specific configurations to handle its unique deployment structure.</li>
<li>Highlights modularity through decoupled LLM implementations for adaptability to new engines.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Applies environment-based validation to ensure the API key‚Äôs compatibility with the chosen model.</li>
<li>Prioritizes Azure compatibility through GitHub tokens, emphasizing flexibility.</li>
<li>Solidifies security through exhaustive validation of critical credentials.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Codebase Custodian</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> acts as the wise overseer, importing and condensing the context of entire repositories for the Code of Unity&#39;s consumption. Its focus lies in preserving the integrity of the observatory&#39;s scrolls while optimizing their readability. With validation mechanisms, file target optimizations, and caching, the <code class="inline-code">RepoAnalyzer</code> supports smooth code adventures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Creates the core context for the repository, choosing between adventure-aligned configurations or complete compression-based analysis.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Extensively validates selected files for secure access and accurate normalization.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes subsystem commands for repository inspection, protecting against timeout overflows and unbounded memory use.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;.git&#39;, &#39;tests&#39;];
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;)
    };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);

    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Uses caching to prevent unnecessary recomputation and enhance performance.</li>
<li>Offers configurability between full repository analysis and specific optimizations.</li>
<li>Implements fault tolerance by falling back to error handling during execution failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const projectRoot = path.resolve(projectPath);
  
  return [...new Set(targetFiles)]
    .slice(0, 50) // Limit on target files
    .map(file =&gt; {
      const fullPath = path.resolve(projectPath, file.trim());
      if (!fullPath.startsWith(projectRoot + path.sep)) {
        console.warn(`Rejecting file outside project directory: ${file}`);
        return null;
      }
      if (!fs.existsSync(fullPath)) {
        return null;
      }
      return path.relative(projectPath, fullPath);
    })
    .filter(file =&gt; file !== null) as string[];
}
</code></pre>
<ul>
<li>Ensures target files are validated for paths, existence, and uniqueness.</li>
<li>Limits resource consumption effectively by restricting the number of files to prevent overload.</li>
<li>Provides thorough sanitization to prevent path injection vulnerabilities.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;], { cwd });
    let stdout = &#39;&#39;;
    let stdoutSize = 0;

    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      reject(new Error(`Repomix timeout (${REPOMIX_SUBPROCESS_TIMEOUT}ms)`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdoutSize += data.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(`Output exceeded buffer size (${REPOMIX_MAX_BUFFER_SIZE})`));
      }
      stdout += data;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; reject(new Error(data.toString())));
    repomix.on(&#39;close&#39;, () =&gt; resolve(stdout));
  });
}
</code></pre>
<ul>
<li>Executes system-level subprocesses with strict time and memory constraints to prevent runaway operations.</li>
<li>Logs errors for debugging problematic subsystem interactions.</li>
<li>Limits excessive resource usage, ensuring graceful degradation during overloads.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To investigate the Sage&#39;s Observatory further, consider writing a sample prompt for the <code class="inline-code">generateResponse</code> function and observing the response.</li>
<li>Experiment with extending the <code class="inline-code">validateAndNormalizeTargetFiles</code> function to include additional security validations.</li>
<li>The <code class="inline-code">captureRepomixStdout</code> function is a useful template if you need to build subprocess handlers elsewhere‚Äîstudy its patterns carefully.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the shimmering light of astral constellations, you have triumphed in unraveling the sage‚Äôs celestial secrets, charting heroic progress through the realms of wisdom‚Äîonward, noble seeker, for the stars still await your dominion! üöÄ‚ö°üëÅÔ∏èüíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>