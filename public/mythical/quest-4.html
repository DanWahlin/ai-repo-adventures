<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Thousand-Eyes Oracle of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Thousand-Eyes Oracle of Analysis</h1>
<hr>
<p>In the Kingdom of Enchanted Adventures, the Oracle of Analysis beckons brave heroes to unravel the mysteries hidden deep within the kingdom&#39;s ancient archives. To summon her wisdom, one must decipher the magical essence of the <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code>, two sacred tools guarded by enchanted algorithms. Each line of code is a rune, revealing how the Kingdom&#39;s knowledge flows and interacts. Arm yourself with curiosity and embark on this journey to master the enchanted art of analysis. The thousand eyes of the Oracle await your triumphant insight!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Oracle&#39;s Ritual</strong>: How does the <code class="inline-code">generateRepomixContext</code> method handle content generation and manage caching for efficiency?</li>
<li>‚ö° <strong>Summoning the Oracle&#39;s Voice</strong>: What patterns are used by <code class="inline-code">generateResponse</code> in <code class="inline-code">LLMClient</code> to craft and validate replies from a mystical source?</li>
<li>üõ°Ô∏è <strong>Enchanted Safeguards</strong>: How do the <code class="inline-code">validateProjectPath</code> method and <code class="inline-code">getApiKey</code> ensure secure and reliable operation within the enchanted system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Keeper of Archives</h3>
<p>This file houses the <code class="inline-code">RepoAnalyzer</code>, a mystical class responsible for processing and optimizing the kingdom&#39;s archives using the legendary <code class="inline-code">repomix</code> tool. It ensures that only critical knowledge is preserved for the Oracle&#39;s wisdom, validating paths and caching results for swift access. Features include rich caching mechanisms, secure path validations, and efficient code extraction methods to reduce resource consumption.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code> orchestrates the retrieval of the enchanted code context while ensuring cache efficiency and fallback mechanisms.</li>
<li><code class="inline-code">validateProjectPath</code> ensures safe exploration of the archives by performing critical path validations.</li>
<li><code class="inline-code">captureRepomixStdout</code> summons the power of a subprocess to extract knowledge from the codebase with memory and timeout safeguards.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Oracle&#39;s Voice</h3>
<p>The Oracle&#39;s voice is manifested through the <code class="inline-code">LLMClient</code>, a magical conduit to external models of wisdom such as OpenAI and Azure OpenAI. This file reveals the intricate spells required to generate responses, validate mystical inputs, and handle errors gracefully. It ensures adaptability between providers while safeguarding secrets of configuration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code> generates oracle-esque answers while verifying the integrity of the mystical outputs.</li>
<li><code class="inline-code">constructor</code> initializes the Oracle&#39;s connection, adapting to specified providers such as OpenAI and Azure OpenAI.</li>
<li><code class="inline-code">getApiKey</code> extracts the sacred keys required for summoning the Oracle&#39;s insights, ensuring provider compatibility.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error.message}`);
      try {
        return await this.generateTargetedContent(projectPath, configuredFiles);
      } catch {
        console.log(&#39;Falling back to full content generation&#39;);
      }
    }
  }
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;];
    if (!options.includeTests) {
      ignorePatterns.push(&#39;**/*.test.ts&#39;);
    }

    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;),
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Utilizes efficient caching to reduce redundant executions.</li>
<li>Implements fallback mechanisms for resilience when files are missing or inaccessible.</li>
<li>Leverages CLI-based subprocess execution to gather extensive context without memory overflow.</li>
<li>Demonstrates flexibility for customized inclusion or exclusion of files.</li>
<li>Handles errors gracefully to ensure uninterrupted flow of oracle operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Validates paths to prevent traversal vulnerabilities or malformed inputs.</li>
<li>Enforces strict checks for null bytes, enhancing reliability and security.</li>
<li>Ensures standardized input for downstream processes.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });

    let stdout = &#39;&#39;;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        isResolved = true;
        reject(new Error(`Execution timeout after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed with code: ${code}`));
    });
  });
}
</code></pre>
<ul>
<li>Executes subprocess commands for dynamic code extraction.</li>
<li>Implements robust timeout protection to avoid indefinite blocking.</li>
<li>Captures and limits memory usage during execution for stability.</li>
<li>Provides detailed error handling for subprocess failures.</li>
</ul>
<hr>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Builds response parameters dynamically based on specified options.</li>
<li>Validates outputs to ensure proper structure and content integrity.</li>
<li>Implements logging mechanisms for usage tracking and debugging.</li>
<li>Dissects errors with extensive information for troubleshooting.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;Configuration required: Set LLM_BASE_URL and API key.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes connections to external providers dynamically based on configurations.</li>
<li>Handles Azure-specific adaptations seamlessly for compatibility.</li>
<li>Provides a security layer by enforcing required API keys and base URLs.</li>
<li>Ensures scalability by supporting multiple models and providers.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN is required for Azure-based models.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set it in environment variables.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Ensures precise provider-based API key assignment for security and compatibility.</li>
<li>Provides detailed error messages for missing configurations.</li>
<li>Enhances adaptability by supporting diverse backends like Azure and OpenAI.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace how caching improves performance in <code class="inline-code">RepoAnalyzer</code>.</li>
<li>Examine error handling patterns in <code class="inline-code">LLMClient</code> for inspiration on safe implementation.</li>
<li>Study the validation methods for securing pathways and keys.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries that bind the enchanted codebase together.</p>
<p>Hail, valiant seeker of truths, for you have unlocked the wisdom of the Thousand-Eyes Oracle of Analysis, weaving its divine foresight into your growing legend‚Äîpress onward, for the stars themselves align in your favor! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>