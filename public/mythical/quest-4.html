<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Analyzing Mystic Scrolls - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Codex: A Kingdom's Tale</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Analyzing Mystic Scrolls</h1>
<hr>
<p>In the mythical Kingdom of Codora, an ancient order of magical scribes once whispered secrets into enchanted scrolls, empowering the wise to traverse the arcane realms of knowledge. But the art of interpreting mystic scrolls lies at the heart of Codora‚Äôs future. As a courageous adventurer of the realm, this journey beckons you to wield your spell of investigation upon two pivotal scrolls: the <code class="inline-code">LLMClient</code>, which channels the sage voices of oracles, and the <code class="inline-code">RepoAnalyzer</code>, the map-maker of Codora‚Äôs enchanted code repository. Decipher their secrets to unite Codora under righteous coding magic!  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Scroll of Conduits</strong>: How does the <code class="inline-code">generateResponse</code> function in <code class="inline-code">LLMClient</code> construct and handle interactions with magical sages (LLM models)?  </li>
<li>‚ö° <strong>Arcane Mechanisms</strong>: How does the <code class="inline-code">generateOptimizedContent</code> method in <code class="inline-code">RepoAnalyzer</code> optimize massive scrolls of knowledge to reduce the burden on the arcane compendium?  </li>
<li>üõ°Ô∏è <strong>Guardian of Stability</strong>: What error-handling mechanisms does the <code class="inline-code">validateResponse</code> function implement in <code class="inline-code">LLMClient</code> when deciphering cryptic responses?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Sage‚Äôs Codex</h3>
<p>The <code class="inline-code">LLMClient</code> is a masterful conjuration that connects Codora‚Äôs minds (LLM models) to the adventurers. It authenticates spells (API keys), determines the chosen sage (model selection), and communicates through structured commands. Here, its <code class="inline-code">generateResponse</code> function creates bespoke incantations and safeguards against incomplete or corrupted translations from the sages. Additionally, <code class="inline-code">validateResponse</code> protects against void responses, ensuring that only meaningful prophecies are returned.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Initiates communication with the chosen magic sage (LLM), handles configurations like verbosity and reasoning effort, and retrieves responses.  </li>
<li><code class="inline-code">validateResponse</code>: Examines the elder‚Äôs prophecy (LLM response), rejects empty or invalid results, and logs debugging insight about any voids encountered.  </li>
<li><code class="inline-code">getApiKey</code>: Determines and retrieves the correct incantation (API key) for external magical gateways, ensuring configuration validity.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>This function prepares and sends a request to the magical sage (LLM), building appropriate parameters for customized responses.  </li>
<li>Incorporates error-resilient design with detailed logging to address failures during invocation.  </li>
<li>Employs robust post-processing for specific formats while maintaining insight into resource consumption.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateResponse(completion: any): string {
  const choice = completion.choices[0];
  const content = choice?.message?.content;

  if (!choice) {
    throw new Error(&#39;LLM returned no choices in response&#39;);
  }

  if (!choice.message) {
    throw new Error(&#39;LLM returned choice without message&#39;);
  }

  if (!content || content.trim() === &#39;&#39;) {
    this.handleEmptyResponse(choice);
  }

  return content;
}
</code></pre>
<ul>
<li>Ensures all oracular responses are valid, handling critical cases like empty content to avoid cascading failure.  </li>
<li>Logs vital diagnostic information about void responses, guiding adventurers through debugging.  </li>
<li>Includes specialized handling for token limitations, providing clarity when truncation occurs.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Retrieves the necessary incantation (API key) for accessing LLMs based on the specified source.  </li>
<li>Includes safeguard validations that ensure only properly configured gateways are used.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Mystic Cartographer</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> harmonizes the vast knowledge of Codora‚Äôs enchanted compendium into comprehensible, optimized glyphs for adventurers. Through <code class="inline-code">generateOptimizedContent</code>, it filters unnecessary paths and condenses scrolls into extracts of functionally relevant content. This method relies on validations, targeted aggregations, and smart caching of patterns to reduce token usage while preserving essential runes.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateOptimizedContent</code>: Condenses scrolls into precise magical extracts using multi-layered validations and optimization routines.  </li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Protects the scroll selection process by securing against path traversal and ensuring uniqueness.  </li>
<li><code class="inline-code">captureRepomixStdout</code>: Enchants Repomix to capture outputs with safeguards for long-running processes and memory overflows.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);

    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });

    return optimizedContent;
  } catch (error) {
    throw new Error(`Optimized content generation failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Integrates cache for enhancing performance by avoiding redundant computations on unchanged content.  </li>
<li>Establishes rigorous validations for file paths to ensure safety and correct processing.  </li>
<li>Employs filtering and extraction mechanisms to provide symbolic code most aligned with the adventurer‚Äôs quest.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) {
        return null;
      }

      const trimmed = file.trim();

      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
        console.warn(`Rejecting potentially unsafe file path: ${trimmed}`);
        return null;
      }

      return trimmed;
    })
    .filter((file): file is string =&gt; file !== null)
    .map(file =&gt; {
      const fullPath = path.resolve(projectPath, file);

      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) {
        console.warn(`Rejecting file outside project directory: ${file}`);
        return null;
      }

      if (!fs.existsSync(fullPath)) {
        console.warn(`Skipping non-existent file: \`${file}\``);
        return null;
      }

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null)
    .sort();

  return safeFiles;
}
</code></pre>
<ul>
<li>Normalizes all file paths to prevent path traversal exploits and validates file existence.  </li>
<li>Deduplicates files and restricts the number of files processed to avoid resource exhaustion.  </li>
<li>Applies a deterministic sorting order for stable results and key generation.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [
      ...directories,
      &#39;--stdout&#39;,
      &#39;--style&#39;, options.style || &#39;markdown&#39;
    ];

    if (options.compress) args.push(&#39;--compress&#39;, &#39;--remove-comments&#39;, &#39;--remove-empty-lines&#39;);
    if (options.include) args.push(&#39;--include&#39;, options.include);

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        code === 0 ? resolve(stdout) : reject(new Error(`Repomix failed with code ${code}: ${stderr}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Manages asynchronous interactions with repomix to extract usable output under strict time and resource constraints.  </li>
<li>Implements graceful fallback mechanisms and resolves subprocess issues to protect the system.  </li>
<li>Captures and returns processed scrolls while detecting and escaping hazardous behaviors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>When analyzing <code class="inline-code">LLMClient</code>, consider how <code class="inline-code">generateResponse</code> ensures customizable outputs for adventurer preferences like verbosity.  </li>
<li>While exploring <code class="inline-code">RepoAnalyzer</code>, focus on the layers of path validation to comprehend the safety protocols employed for file access.  </li>
<li>Review caching mechanisms in both files to understand how repeated invocations are optimized within memory.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>The wise hero has triumphantly deciphered the arcane whispers of the Mystic Scrolls, unveiling hidden knowledge and ascending ever closer to the legendary summit of the Kingdom‚Äôs Great Quest! ‚ö°üíéüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>