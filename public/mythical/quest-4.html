<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Wizard of Analytical Glyphs - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Wizard of Analytical Glyphs</h1>
<hr>
<p>In the heart of Codethra lies an ancient tower, cloaked in storms of logic and protected by a maze of analytical glyphs. Here resides the Wizard of Analytical Glyphs, a reclusive figure tasked with decoding Codethra&#39;s most perplexing arcane scripts. However, the wizard&#39;s spells have grown unstable, scattering malformed glyphs across the land. To restore balance, you must navigate the tower&#39;s layers, uncovering the secrets behind his magic. Your quest will dive into the Wizard&#39;s tomes of <code class="inline-code">LLMClient</code> incantations and the analyzer&#39;s enchanted <code class="inline-code">repomix</code> scrolls to find the source of the disruption.</p>
<p>The fate of Codethra’s woven harmony hangs by the strength of your resolve. Seek the truth, brave adventurer, and return order to the kingdom!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>🧩 <strong>Glyph Assembly</strong>: How does <code class="inline-code">LLMClient.generateResponse</code> craft and execute an LLM request while maintaining stability in extreme cases?</li>
<li>🌀 <strong>Flow of Enchanted Inputs</strong>: What sequences unfold within <code class="inline-code">RepoAnalyzer.generateRepomixContext</code> to transform project paths into optimized code summaries?</li>
<li>⛔ <strong>Barrier Runes</strong>: How do methods like <code class="inline-code">RepoAnalyzer.validateProjectPath</code> and <code class="inline-code">LLMClient.getApiKey</code> safeguard against improper configurations and paths?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Wizard&#39;s Script</h3>
<p>This file focuses on <code class="inline-code">LLMClient</code>, a spellbound class for sending prompts to mystical Large Language Model (LLM) gateways like OpenAI and Azure. The class carefully balances connection parameters, error handling, and token constraints to ensure magical precision in generating responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code> orchestrates requests to the LLM, employs defensive measures to validate results, and adapts processing based on specific model parameters.</li>
<li><code class="inline-code">constructor</code> initializes the wizard’s tools, ensuring correct API keys and server configurations while distinguishing between OpenAI and Azure deployments.</li>
<li><code class="inline-code">getApiKey</code> selects the appropriate key based on the infrastructure being used and enforces rules to reject undefined keys.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Validates the prompt and options while constructing the <code class="inline-code">LLM</code> request properly.</li>
<li>Includes defensive programming to ensure error logs capture all necessary debugging details.</li>
<li>The response handling ensures clean and formatted content, such as unwrapping JSON objects embedded in markdown.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes the wizard’s magical tools, ensuring compatibility with both OpenAI and Azure enchantments.</li>
<li>Ensures proper API configuration and throws errors if any vital configuration settings are missing.</li>
<li>Differentiates between cloud providers, seamlessly adapting the connection strategy for each.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Determines the correct API key to use based on the magical gateway being invoked.</li>
<li>Throws definitive errors for missing keys, ensuring no undefined configurations pollute the connection.</li>
<li>Simplifies API key management across different platforms like Azure and OpenAI, eliminating manual checks.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Enchanted Glyph Analyzer</h3>
<p>This file supports the processing of codebase fragments through the <code class="inline-code">RepoAnalyzer</code> class. It focuses on validating file paths, extracting optimized content, and generating context from <code class="inline-code">repomix</code> encoded scrolls.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code> serves as the primary function for analyzing files and generating textual representations using <code class="inline-code">repomix</code>.</li>
<li><code class="inline-code">validateProjectPath</code> ensures safety by rejecting invalid paths or potential null-byte injection attempts.</li>
<li><code class="inline-code">captureRepomixStdout</code> manages the invocation of the <code class="inline-code">repomix</code> tool to extract code summaries while safeguarding against execution timeouts and memory overflow.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to other options: ${error}`);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error}`);
  }
}
</code></pre>
<ul>
<li>Merges external functions and files into a unified representation optimized for the specific context.</li>
<li>Logs errors at various points but ensures fallbacks exist to generate content, preventing failures in analysis.</li>
<li>Uses caching to mitigate performance overhead for repeated function calls.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures that the given project path is valid and does not include harmful null bytes.</li>
<li>Prevents accidental or deliberate exploitation of path traversal vulnerabilities.</li>
<li>Acts as a guardian against scenarios that might disrupt file operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    
    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGKILL&#39;);
      reject(new Error(`Repomix subprocess timed out`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) {
        resolve(stdout);
      } else {
        reject(new Error(`Repomix failed with code ${code}`));
      }
    });

    repomix.on(&#39;error&#39;, (err) =&gt; {
      clearTimeout(timeout);
      reject(new Error(`Repomix spawn failed: ${err.message}`));
    });
  });
}
</code></pre>
<ul>
<li>Manages the <code class="inline-code">repomix</code> subprocess, guaranteeing a steady flow of optimized code outputs.</li>
<li>Implements a timeout mechanism to kill the subprocess if it exceeds predefined limits.</li>
<li>Safeguards against memory overflows by carefully tracking the subprocess&#39;s output size.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Carefully trace how files are validated and normalized to ensure proper path usage.</li>
<li>Pay attention to defensive programming patterns in error handling for troubleshooting techniques.</li>
<li>Observe caching strategies for performance improvements during repetitive analysis tasks.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With a triumphant flourish befitting a legendary hero, you have deciphered the arcane riddles of the Wizard of Analytical Glyphs and ascended to 60% mastery on this epic journey—press on, valiant seeker, for the crown of ultimate enlightenment gleams ever brighter on the horizon! ⚡✨📜</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">← Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>