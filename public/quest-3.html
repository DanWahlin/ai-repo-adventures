<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú Quest 3: The Codex of Repomancy (Codebase Analysis) - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <script>
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'mythical' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">‚öîÔ∏è Realm of Enchanted Code: The Quest for the Eternal Compiler</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1><span class="header-prefix">üìú Quest 3:</span> The Codex of Repomancy (Codebase Analysis)</h1>
<hr>
<p>In the shadowy recesses of Codoria, where the mystical convergence of enchanted scripts holds sway, whispers of buried knowledge resound. The &quot;Codex of Repomancy,&quot; a sacred tome containing the arcane wisdom for unraveling codebound secrets, awaits rediscovery. This chapter of your journey demands courage and clarity, for within the heart of the Codex lie bound tests of precision and interpretation. To reunite the fragments into a coherent symphony, you must confront this enigma head-on, delving deep into its intricate spells of analysis.</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/mcp-repo-adventure/blob/main/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/analyzer/repo-analyzer.ts</code></a>: The Repository Analyze Master&#39;s Guide</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file encapsulates the mythical wisdom of the Codex of Repomancy, serving as the kingdom‚Äôs compass for understanding vast codebases. The RepoAnalyzer class acts as a seasoned spellcaster that interprets the enchanted scripts (code files) by extracting their essence through Repomix, a long-standing magical tool. It employs various protective wards‚Äîsuch as the <code class="inline-code">validateProjectPath</code> incantation, which ensures that no dark forces tamper with input paths. Furthermore, the <code class="inline-code">generateTargetedContent</code> spell is particularly powerful, enabling the creation of focused enchantments (context) for specific files. This is achieved through secure file validation to prevent dangerous path traversal and other sinister invasions. Finally, the file captures the Codex‚Äôs core incantation: <code class="inline-code">captureRepomixStdout</code>, which summons the power of the Repomix subprocess using timeout constraints to ensure no rogue magic can cause corruption.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.generateRepomixContext</code>: Orchestrates full codebase analysis with caching and security mechanisms.</li>
<li><code class="inline-code">RepoAnalyzer.generateTargetedContent</code>: Refines analysis to specific files, ensuring both efficiency and security.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code>: Executes the core subprocess with safety measures, capturing Repomix&#39;s output.</li>
<li><code class="inline-code">RepoAnalyzer.validateProjectPath</code>: Protects data integrity by rejecting unsafe project paths.</li>
<li>Integration with Repomix to safely interpret and compress codebases.</li>
</ul>
<h3><a href="https://github.com/danwahlin/mcp-repo-adventure/blob/main/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">src/llm/llm-client.ts</code></a>: The Oracle‚Äôs Whisper</h3>
<p>The <code class="inline-code">llm-client.ts</code> acts as the Oracle of Codoria, translating cryptic incantations into practical advice through the power of multiple magical centers (aka LLMs). The <code class="inline-code">LLMClient</code> class cleverly balances the inputs, outputs, and quirks of various providers‚Äîwhether OpenAI, AzureOpenAI, or GitHub Models. At its heart lies the <code class="inline-code">generateResponse</code> spell, which crafts a conversation with the oracles to unlock insights hidden within the Codoria codebase. By detecting the appropriate API keys and endpoint configurations, the Oracle ensures authenticated and optimized communication with each provider. With error-handling protocols as intricate as castle defenses, the Oracle‚Äôs operations not only gather knowledge but protect its seekers from calamity.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code>: Facilitates communication with mystical oracles (LLMs) for meaningful guidance.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Manages API keys for various lore keepers (providers).</li>
<li>Supports OpenAI, AzureOpenAI, and GitHub Models with auto-detection of magical routes.</li>
<li>Proactive error logging ensures even failures are learning opportunities.</li>
<li>Simplifies the enchanted lexicon of LLM requests into structured and predictable responses.</li>
</ul>
<h2>Code</h2>
<h3>src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">/**
 * Generate repomix context for a project
 */
async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    const configuredFiles = extractUniqueFilePaths(projectPath);
    
    if (configuredFiles.length &gt; 0) {
        console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files`);
        try {
            return await this.generateTargetedContent(projectPath, configuredFiles);
        } catch (error) {
            console.warn(`Failed to generate targeted content, falling back to full repomix content: ${error instanceof Error ? error.message : String(error)}`);
        }
    }

    console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
    const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }

    try {
        const ignorePatterns = [
            &#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;
        ];
        if (!options.includeTests) ignorePatterns.push(&#39;**/*.test.ts&#39;, &#39;**/*.spec.ts&#39;);

        const cliOptions: CliOptions = {
            style: options.style || &#39;markdown&#39;,
            stdout: true,
            compress: options.compress !== false,
            ignore: ignorePatterns.join(&#39;,&#39;),
            removeComments: true,
            removeEmptyLines: true,
            noDirectoryStructure: true
        };
        const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
        this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
        return context;
    } catch (error) {
        throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
    }
}
</code></pre>
<p>This is like setting up a crystal ball to analyze everything in the file system, with fallback plans if the first attempt doesn‚Äôt work.</p>
<h3>src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        const content = this.validateResponse(completion);
        this.logTokenUsage(completion);
        return { content };
    } catch (error) {
        this.logDetailedError(error, prompt);
        const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
        throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<p>This functions as a messenger who delivers vital queries to the Oracle and ensures the traveler receives answers safely.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to validations like <code class="inline-code">validateProjectPath</code> to understand how security mechanisms guard the magical tools of the system.</li>
<li>Consider exploring the <code class="inline-code">config.js</code> file next to uncover how configuration parameters influence timeouts and cache settings.</li>
<li>Dive deeper into Repomix‚Äôs CLI interface to fully comprehend how its reliance on subprocess errors impacts the system‚Äôs resilience.</li>
</ul>
<hr>
<p>üè∞ Hark, noble seeker! With the Codex of Repomancy unraveled and the arcane glyphs of the codebase illuminated, your legend grows brighter than a phoenix‚Äôs flame‚Äîonward to glory, valiant hero! ‚ö°‚ú®</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: üí† Quest 4: Themes of the Arcane (Config... ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/mcp-repo-adventure" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="images/github-mark.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>