<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analysis Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repository Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis Engine</h1>
<hr>
<p>The Code Analysis Engine hums with precision, dissecting vast codebases into digestible insights. This quest delves into the inner workings of the <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code> modules, showcasing how they collaborate to analyze repositories and generate meaningful content. The analyzer extracts structured data while the LLM client transforms it into coherent narratives, forming the backbone of the adventure system. Prepare to uncover the mechanisms that turn static code into dynamic stories.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Repository Analysis Pipeline</strong>: How <code class="inline-code">RepoAnalyzer</code> extracts and processes codebase content for targeted analysis.</li>
<li>üîç <strong>LLM Integration</strong>: The role of <code class="inline-code">LLMClient</code> in generating responses and managing API interactions.</li>
<li>‚ö° <strong>Caching Strategies</strong>: How caching optimizes performance and reduces redundant operations in analysis workflows.</li>
<li>üí° <strong>Error Handling</strong>: Techniques for managing rate limits and ensuring robust communication with external APIs.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is the heart of the code analysis pipeline, responsible for extracting and optimizing content from repositories. It interfaces with the <code class="inline-code">repomix</code> tool to generate structured outputs and applies additional processing to tailor content for the adventure system. This file highlights techniques for caching, validation, and targeted content generation.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a>: Orchestrates the analysis of the entire repository or specific files, applying caching for efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a>: Focuses on extracting content from specific files, ensuring only relevant data is processed.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a>: Executes the <code class="inline-code">repomix</code> CLI as a subprocess, capturing its output while enforcing resource limits.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error.message}`);
    }
  }
  
  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;],
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true
    };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This method validates the project path and checks for pre-configured files in <code class="inline-code">adventure.config.json</code>.</li>
<li>It uses caching to avoid redundant analysis, improving performance for repeated requests.</li>
<li>The <code class="inline-code">repomix</code> CLI is invoked with options for content compression and ignoring irrelevant directories.</li>
<li>Error handling ensures fallback to alternative strategies when optimized content generation fails.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;], { cwd });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdoutSize += data.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(`Output too large (${stdoutSize} bytes)`));
      }
      stdout += data.toString();
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (code === 0) resolve(stdout);
      else reject(new Error(`Repomix failed with exit code ${code}: ${stderr}`));
    });
  });
}
</code></pre>
<ul>
<li>This function spawns a subprocess to execute <code class="inline-code">repomix</code> and captures its output.</li>
<li>Memory limits (<code class="inline-code">REPOMIX_MAX_BUFFER_SIZE</code>) prevent excessive resource usage during execution.</li>
<li>Comprehensive error handling ensures subprocess failures are gracefully managed.</li>
<li>The method supports asynchronous workflows, enabling non-blocking operations.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> provides a unified interface for interacting with various LLM providers, such as OpenAI or Azure OpenAI. It manages API requests, handles rate limits, and processes responses, making it a critical component for generating adventure content.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a>: Sends prompts to the LLM and processes the generated responses, with support for custom options.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a>: Initializes the client with provider-specific configurations, including API keys and endpoints.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a>: Identifies rate limit errors and classifies them for adaptive throttling.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();
    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      this.activateThrottling(error);
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This method builds request parameters, executes the API call, and validates the response.</li>
<li>It includes adaptive throttling to manage rate limits dynamically.</li>
<li>JSON responses are cleaned to ensure proper formatting for downstream processing.</li>
<li>Detailed error handling provides robust failure recovery and logging.</li>
</ul>
<hr>
<pre><code class="language-typescript">private detectRateLimitType(error: any): RateLimitInfo {
  const errorMessage = error?.message || &#39;&#39;;
  const is429Error = error?.status === 429 || errorMessage.includes(&#39;429&#39;);

  if (!is429Error) {
    return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
  }

  if (errorMessage.includes(&#39;exceeded token rate limit&#39;)) {
    return {
      type: RateLimitType.TOKEN_RATE_EXCEEDED,
      waitSeconds: TOKEN_RATE_WINDOW_SECONDS,
      message: &#39;Token rate limit exceeded&#39;
    };
  }

  return {
    type: RateLimitType.REQUEST_RATE_LIMIT,
    waitSeconds: 60,
    message: &#39;429 rate limit encountered&#39;
  };
}
</code></pre>
<ul>
<li>This function inspects error messages to classify rate limit issues into token or request limits.</li>
<li>It provides actionable information, such as wait times and error descriptions.</li>
<li>This classification enables the client to respond appropriately to different rate-limiting scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> uses caching to optimize repeated analysis tasks.</li>
<li>Examine the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> function for subprocess handling patterns, including resource limits.</li>
<li>Study the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> method to understand how adaptive throttling is implemented.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Extend Validation</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> in <code class="inline-code">RepoAnalyzer</code> to include additional checks for symbolic links. Test it with different project structures to ensure robustness.</li>
<li><strong>Custom Rate Limit Handling</strong>: Enhance <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> in <code class="inline-code">LLMClient</code> to include retry logic for specific error codes. Experiment with different wait times to observe the behavior.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the codebase.</p>
<p>Congratulations on successfully deploying the Code Analysis Engine‚Äîyour dev journey is 60% complete, and your codebase optimization is now running at ‚≠ê production-level efficiency üöÄ!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>