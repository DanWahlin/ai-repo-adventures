<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analysis System - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repo Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis System</h1>
<hr>
<p>The Code Analysis System serves as the backbone of AI Repo Adventures, transforming raw codebases into structured content for interactive exploration. This system leverages advanced repository scanning and LLM integration to extract meaningful insights from code, optimize token usage, and dynamically generate adventure-ready content. As a developer, mastering this system will unlock the ability to analyze complex projects efficiently while maintaining high-quality outputs.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Repository Analysis</strong>: How <code class="inline-code">RepoAnalyzer</code> validates paths and extracts targeted content from codebases.</li>
<li>üîç <strong>LLM Request Optimization</strong>: How <code class="inline-code">LLMClient</code> manages adaptive throttling and builds structured prompts for efficient API calls.</li>
<li>‚ö° <strong>Caching Strategy</strong>: How caching reduces redundant computation and improves system performance.</li>
<li>üí° <strong>Error Handling</strong>: Techniques for managing rate limits and ensuring robust API integration.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class is responsible for extracting relevant codebase content and preparing it for analysis. It employs techniques like path validation, targeted file extraction, and content optimization to ensure that only essential information is processed. Additionally, it integrates caching mechanisms to minimize redundant operations and improve performance.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> ensures the project path is secure and valid, preventing path traversal vulnerabilities.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> extracts specific files from the repository and applies compression for token efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> runs the <code class="inline-code">repomix</code> CLI as a subprocess, capturing output with memory and timeout protection.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Validates the project path to ensure it is secure and usable.</li>
<li>Protects against null byte injection and empty string errors.</li>
<li>Provides a foundation for safe file system operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  const cliOptions: CliOptions = {
    style: &#39;markdown&#39;,
    stdout: true,
    compress,
    include: safeFiles.join(&#39;,&#39;),
    removeComments: compress,
    removeEmptyLines: compress,
    noDirectoryStructure: true
  };

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>Extracts targeted content from specified files, optimizing for token efficiency.</li>
<li>Employs caching to avoid redundant repomix executions.</li>
<li>Configures repomix options dynamically, including compression and file inclusion.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;], { cwd });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        reject(new Error(`Repomix output too large (${stdoutSize} bytes)`));
        return;
      }
      stdout += chunk;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (code === 0) {
        resolve(stdout.trim());
      } else {
        reject(new Error(`Repomix failed (exit ${code}): ${stderr}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Executes the <code class="inline-code">repomix</code> CLI as a subprocess to extract repository context.</li>
<li>Implements memory protection and timeout handling to ensure reliable execution.</li>
<li>Provides detailed error handling for subprocess failures.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> class facilitates communication with AI models, handling API requests, error management, and adaptive throttling. It supports multiple providers, including OpenAI and Azure OpenAI, and ensures robust integration through dynamic configuration and caching.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> builds structured prompts and processes LLM responses, including error handling for rate limits.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a> initializes the client with provider-specific configurations and adaptive throttling settings.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> identifies rate limit errors and provides actionable feedback for recovery.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();

    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      this.activateThrottling(error);
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }

    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Handles the complete lifecycle of an LLM request, including prompt generation and response validation.</li>
<li>Implements adaptive throttling to manage rate limits dynamically.</li>
<li>Provides detailed error handling for robust API integration.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes the LLM client with provider-specific configurations.</li>
<li>Supports multiple providers, including OpenAI and Azure OpenAI.</li>
<li>Ensures proper setup for secure API communication.</li>
</ul>
<hr>
<pre><code class="language-typescript">detectRateLimitType(error: any): RateLimitInfo {
  const errorMessage = error?.message || &#39;&#39;;
  const is429Error = error?.status === 429 || errorMessage.includes(&#39;429&#39;);

  if (!is429Error) {
    return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
  }

  if (errorMessage.includes(&#39;exceeded token rate limit&#39;) &amp;&amp; !errorMessage.includes(&#39;retry after&#39;)) {
    return {
      type: RateLimitType.TOKEN_RATE_EXCEEDED,
      waitSeconds: TOKEN_RATE_WINDOW_SECONDS,
      message: `Token rate limit exceeded (200K tokens/${TOKEN_RATE_WINDOW_SECONDS}s window)`
    };
  }

  if (errorMessage.includes(&#39;retry after&#39;)) {
    const retryMatch = errorMessage.match(/retry after (\d+) seconds/);
    const waitSeconds = retryMatch ? parseInt(retryMatch[1]) : 60;

    return {
      type: RateLimitType.REQUEST_RATE_LIMIT,
      waitSeconds,
      message: `Request rate limit hit, retry after ${waitSeconds} seconds`
    };
  }

  return {
    type: RateLimitType.REQUEST_RATE_LIMIT,
    waitSeconds: 60,
    message: &#39;429 rate limit encountered&#39;
  };
}
</code></pre>
<ul>
<li>Identifies rate limit errors and provides actionable feedback for recovery.</li>
<li>Differentiates between token rate limits and request rate limits.</li>
<li>Supports adaptive error handling for robust API integration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> ensures security in file system operations.</li>
<li>Study the adaptive throttling logic in <code class="inline-code">LLMClient</code> to understand rate limit management.</li>
<li>Review the caching mechanism in <code class="inline-code">RepoAnalyzer</code> for optimizing repeated operations.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add Targeted File Extraction</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> to include additional file types, such as <code class="inline-code">.json</code> or <code class="inline-code">.config</code>. Observe how this impacts the extracted content and token efficiency.</li>
<li><strong>Trace LLM Response Flow</strong>: Add logging statements to <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> and trace the complete flow of an LLM request. Identify bottlenecks and optimize prompt size or API parameters.</li>
<li><strong>Enhance Error Handling</strong>: Extend <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> to handle additional error codes or retry strategies. Test these changes by simulating API errors.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of AI Repo Adventures.</p>
<p>Congratulations on successfully deploying the Code Analysis System‚Äîyour debugging prowess and refactoring skills have pushed the repository of progress to 60% completion; keep committing to greatness! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>