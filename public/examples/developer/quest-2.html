<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Developer's Guide to AI Repository Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>The MCP Tool Interface is the heart of the system&#39;s interactive capabilities, where tools are dynamically registered and executed to transform codebases into engaging adventures. This interface ensures seamless communication between user requests and tool functionalities, validating inputs and executing handlers with precision. Dive into the architecture that powers this interaction and explore how tools like <code class="inline-code">start_adventure</code> and <code class="inline-code">choose_theme</code> are orchestrated to deliver immersive learning experiences.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are listed and validated using schemas for runtime flexibility.</li>
<li>üîç <strong>Handler Execution</strong>: The architecture for securely executing tool handlers with validated inputs.</li>
<li>‚ö° <strong>Graceful Shutdown</strong>: Techniques for ensuring system stability during termination and error handling.</li>
<li>üí° <strong>Tool Organization</strong>: How modular design supports scalability and maintainability.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">RepoAdventureServer</code> class handles the core MCP server operations, including tool registration, input validation, and execution. This file demonstrates dynamic tool handling using schemas and provides insights into how the server manages user requests and pre-generates content for improved responsiveness.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates their inputs using Zod schemas.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Establishes the server transport, pre-generates repository analysis, and ensures readiness for user commands.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup, graceful shutdown, and error handling mechanisms.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools using schemas, enabling runtime flexibility for tool registration.</li>
<li>Validates inputs using Zod schemas, ensuring type safety and preventing invalid data execution.</li>
<li>Implements defensive programming with custom error handling (<code class="inline-code">McpError</code>) to maintain server stability.</li>
<li>Separates tool validation from execution, following the single responsibility principle.</li>
<li>Demonstrates extensibility by decoupling tool definitions from server logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the MCP server via <code class="inline-code">StdioServerTransport</code>, enabling communication with external systems.</li>
<li>Pre-generates repository analysis content to improve responsiveness during user interactions.</li>
<li>Uses asynchronous operations to initialize transport and analysis concurrently for efficiency.</li>
<li>Ensures server readiness by warming up the cache, reducing latency for initial user commands.</li>
<li>Demonstrates proactive resource management by handling pre-generation in the background.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the MCP server, handling startup and error scenarios with robust logging.</li>
<li>Implements graceful shutdown for signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure resource cleanup.</li>
<li>Logs unhandled promise rejections for debugging without interrupting server operations.</li>
<li>Demonstrates separation of concerns by delegating server operations to <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Provides a clear error recovery strategy to maintain stability during unexpected failures.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file organizes the MCP tools into modular components, enabling dynamic registration and execution. The tools (<code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, <code class="inline-code">view_progress</code>) are designed to handle specific user interactions, each contributing to the overall adventure system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and initializes the adventure system.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates themed adventures based on user-selected options.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes individual quest exploration requests.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides completion status and remaining quest details.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports tools as a unified object for easy registration with MCP server handlers.</li>
<li>Follows modular design principles, separating tool logic into individual files.</li>
<li>Enables scalability by allowing new tools to be added without modifying core server logic.</li>
<li>Demonstrates maintainability by organizing tools with clear naming conventions.</li>
<li>Provides a centralized entry point for tool definitions, simplifying integration.</li>
</ul>
<hr>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Imports individual tool implementations, ensuring clear separation of concerns.</li>
<li>Re-exports tools with MCP naming conventions, aligning with server expectations.</li>
<li>Demonstrates modular organization, improving readability and simplifying debugging.</li>
<li>Provides flexibility for tool-specific enhancements without impacting other components.</li>
<li>Ensures consistent integration with the MCP server by adhering to naming standards.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <code class="inline-code">setupHandlers</code> uses Zod schemas for input validation to ensure type safety.</li>
<li>Observe how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> pre-generates content to improve responsiveness during user interactions.</li>
<li>Explore the modular design in <code class="inline-code">tools.ts</code> to understand how tool organization supports scalability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_active_quests</code> that lists all currently active quests. Register it in <code class="inline-code">tools.ts</code> and implement the handler using the adventure manager.</p>
<ul>
<li>Example: &quot;This will help you understand how tools are dynamically registered and executed.&quot;</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution Flow</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> and <code class="inline-code">tools.ts</code> to trace the flow of a tool request from the MCP server to its handler. Observe how inputs are validated and outputs are returned.</p>
<ul>
<li>Example: &quot;This reveals the complete lifecycle of a tool request.&quot;</li>
</ul>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the error handling in <code class="inline-code">setupHandlers</code> to include suggestions for resolving invalid parameters. For example, provide a list of expected fields or suggest corrections for common mistakes.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the MCP architecture.</p>
<p>Congratulations on successfully deploying the MCP Tool Interface‚Äîyour codebase just hit a stellar breakpoint in the development lifecycle, propelling you 20% closer to full-stack mastery! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>