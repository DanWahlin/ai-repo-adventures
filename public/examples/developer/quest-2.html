<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Developer's Codebase Expedition</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Step into the developer&#39;s forge, where tools are meticulously crafted to transform static codebases into dynamic, interactive journeys. This quest explores the heart of the MCP Tool Interface, the gateway through which all user commands flow. Here, you will uncover how requests are handled, tools are registered, and the server seamlessly integrates dynamic storytelling capabilities with adaptive input validation.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Error Handling in MCP</strong>: The mechanisms ensuring stability and resilience during tool execution.</li>
<li>‚ö° <strong>Server Lifecycle Management</strong>: How the MCP server gracefully handles initialization and shutdown.</li>
<li>üí° <strong>Extensibility Patterns</strong>: Techniques for adding new tools or handlers without modifying the core server logic.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file serves as the backbone of the MCP server, coordinating tool registration, request handling, and server lifecycle management. Through its <code class="inline-code">RepoAdventureServer</code> class, the file demonstrates modular design, leveraging Zod schemas for robust input validation and employing graceful shutdown patterns to ensure reliability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically, exposing their schemas and handlers to the MCP interface.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server transport, pre-generates repository context, and prepares the system for user commands.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates the full server lifecycle, including error handling and graceful shutdown procedures.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools with robust schema validation, ensuring type safety and accurate request handling.</li>
<li>Schema conversion (<code class="inline-code">zodToJsonSchema</code>) enables seamless integration with external clients by exposing tool input formats.</li>
<li>The defensive programming approach ensures invalid inputs are caught early, improving system reliability.</li>
<li>By decoupling tool validation and execution, the architecture allows independent extensibility for new tools.</li>
<li>Error handling categorizes issues into predefined MCP error codes, aiding client-side debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method establishes the server&#39;s transport layer for communication with the MCP client.</li>
<li>Pre-generating repository context improves performance during interactive tool usage by warming up the cache.</li>
<li>By logging critical startup events, the method ensures transparency and aids in debugging deployment issues.</li>
<li>The use of <code class="inline-code">StdioServerTransport</code> demonstrates compatibility with standard input/output-based communication protocols.</li>
<li>This modular initialization pattern allows for seamless integration of additional server transports in the future.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function manages the entire server lifecycle, including startup, runtime error handling, and shutdown.</li>
<li>Signal listeners (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) enable graceful shutdown, ensuring resources are cleaned up properly.</li>
<li>Unhandled promise rejections are logged without halting the server, maintaining operational continuity.</li>
<li>The clear separation of concerns (initialization, error handling, shutdown) simplifies debugging and enhances maintainability.</li>
<li>This centralized lifecycle management pattern establishes a reliable foundation for deploying the MCP server.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file organizes the MCP toolset, providing a structured interface for managing and exporting tools. By centralizing tool definitions, this file simplifies registration and facilitates modular expansion of tool capabilities.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">tools</code>: Exports all available tools, enabling dynamic registration and execution through the MCP server.</li>
<li><code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, <code class="inline-code">view_progress</code>: Handlers for core MCP tool functionalities, each encapsulating a specific feature of the interactive experience.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object consolidates all available tools, simplifying dynamic registration in the server setup.</li>
<li>By exporting tools with descriptive names, the system ensures clear intent and easy integration with the MCP interface.</li>
<li>This centralized approach enables consistent management of tool dependencies and shared state.</li>
<li>Adding new tools involves minimal changes, adhering to the open/closed principle of software design.</li>
<li>The modular organization enhances readability and maintainability by separating tool logic from server code.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how Zod schemas are used to validate tool inputs and consider replicating this pattern in your own projects.</li>
<li>Explore the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L98" target="_blank" rel="noopener noreferrer"><code class="inline-code">gracefulShutdown</code></a> method to understand how resources like caches and connections are cleaned up.</li>
<li>Notice how the <code class="inline-code">tools.ts</code> file decouples tool definitions from server logic, promoting modularity and extensibility.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool, <code class="inline-code">list_files</code>, that lists all files in the project directory. Define its schema, handler, and register it in <code class="inline-code">tools.ts</code> and <code class="inline-code">setupHandlers</code>.</p>
<ul>
<li>Example: Use Node.js <code class="inline-code">fs</code> module to implement the tool&#39;s functionality.</li>
</ul>
</li>
<li><p><strong>Trace Error Handling</strong>: Modify the <code class="inline-code">setupHandlers</code> method to log additional details about request validation errors. Run the server and test invalid inputs to observe the error messages.</p>
</li>
<li><p><strong>Enhance Pre-Generation</strong>: Extend the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method to include a progress bar for the pre-generation process. Use a library like <code class="inline-code">cli-progress</code> to visualize the progress.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the MCP system.</p>
<p>Congratulations on successfully deploying the MCP Tool Interface‚Äîyour first commit to the quest repository is live, and you&#39;re now 20% closer to achieving the full release pipeline! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>