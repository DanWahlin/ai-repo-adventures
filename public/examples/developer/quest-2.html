<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface Design - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Repository Adventurer's Technical Blueprint</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface Design</h1>
<hr>
<p>This quest focuses on the heart of the MCP Tool Interface Design, examining how the system dynamically generates and executes developer tools. By delving into the provided files, you will learn how the server initializes and coordinates tool-related operations, as well as how individual tools are structured and integrated. The insights gained here are essential for extending and maintaining the MCP interface seamlessly.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Handler Dynamics</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register and handle multiple tools within the server interface?</li>
<li>‚ö° <strong>Initialization Workflow</strong>: What steps are performed in the <code class="inline-code">run</code> method to prepare the MCP server for operation, and how are background tasks managed?</li>
<li>üõ°Ô∏è <strong>Error Validation Patterns</strong>: How is argument validation implemented in tool execution to prevent invalid inputs from causing runtime failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Core</h3>
<p>This file contains the main entry point for the MCP server and its core functionality. It defines the <code class="inline-code">RepoAdventureServer</code> class, which is responsible for setting up the server, registering tool handlers, and managing tool execution. With a focus on extensibility, the implementation demonstrates robust error handling, dynamic tool registration, and pre-caching strategies.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools for listing and execution, validating input schemas and handling parameter errors.</li>
<li><code class="inline-code">run</code>: Starts the server, connects to the transport mechanism, and initializes background caching for faster operations.</li>
<li><code class="inline-code">main</code>: Orchestrates server initialization, including signal handling for clean server shutdown and error resilience during operation.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tools Definition</h3>
<p>This file defines the toolbox available to the MCP server. Each tool has a specific responsibility, wrapped in a modular and scalable design for ease of maintenance. Tools are grouped into a single exportable object for centralized registration and invocation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and generates options for storytelling themes.</li>
<li><code class="inline-code">choose_theme.handler</code>: Creates a custom story and quests based on the chosen theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Explores individual quests dynamically.</li>
<li><code class="inline-code">view_progress.handler</code>: Displays progress and checks the status of completed and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools based on the configuration in <code class="inline-code">tools.js</code>, enabling extensibility without modification of server logic.</li>
<li>Converts Zod schemas into JSON Schema for standardized input validation across tools.</li>
<li>Ensures input validation using a structured error-handling pipeline, reducing risk of runtime failures.</li>
<li>Demonstrates separation of concerns by delegating schema generation, error creation, and tool execution to appropriate subsystems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes communication using <code class="inline-code">StdioServerTransport</code> to manage input/output streams.</li>
<li>Logs server status messages to provide operational transparency during startup.</li>
<li>Pre-generates content caches to improve subsequent tool performance, showcasing asynchronous background processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements robust signal handling for process termination, ensuring clean resource cleanup.</li>
<li>Captures unhandled promise rejections and prevents abrupt server crashes, contributing to overall fault tolerance.</li>
<li>Combines asynchronous initialization with comprehensive error reporting for transparency and debuggability.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Consolidates multiple tools under a unified registry, streamlining their integration and management by the server.</li>
<li>Promotes modularity by dividing tools into distinct files but aggregating exports for centralized control.</li>
<li>Facilitates dynamic registration by listing tools programmatically, reducing boilerplate.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">ListToolsRequestSchema</code> to understand how tools are dynamically reported to clients.</li>
<li>Study how <code class="inline-code">safeParse</code> within <code class="inline-code">CallToolRequestSchema</code> guarantees valid inputs while handling user error gracefully.</li>
<li>Explore the design choice of pre-caching with <code class="inline-code">repoAnalyzer</code> for long-term benefits in applications that require heavy file analysis.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üéâ Quest 2: MCP Tool Interface Design successfully debugged and deployed‚Äîcongratulations on shipping this MVP milestone with 20% roadmap completion! üöÄüíª‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>