<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repo Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>The MCP Tool Interface lies at the heart of the system, serving as a gateway for developers to interact with the adventure engine. It dynamically orchestrates tool registration, validates user inputs, and ensures seamless execution of the tools that power the adventure experience. This quest delves into the server and tool management architecture, revealing how the system processes requests, validates schemas, and handles errors gracefully.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How the server dynamically lists and validates tools using Zod schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing tool execution failures and invalid inputs.</li>
<li>‚ö° <strong>Server Lifecycle Management</strong>: How the server initializes, runs, and gracefully shuts down.</li>
<li>üí° <strong>Tool Modularity</strong>: How tools are organized and exported for scalability and maintainability.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>This file implements the <code class="inline-code">RepoAdventureServer</code>, the core MCP server responsible for managing tool interactions and coordinating the adventure flow. Key functionalities include dynamic tool registration, schema-based input validation, and error handling during tool execution. The server also pre-generates content to optimize performance and supports graceful shutdowns for reliability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates their schemas for safe execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Starts the server, connects the transport, and pre-generates repomix content for caching.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates the server lifecycle, including initialization and handling shutdown signals.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This method dynamically registers tools and validates their schemas using <code class="inline-code">zodToJsonSchema</code>.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler returns a manifest of available tools, ensuring discoverability.</li>
<li>The <code class="inline-code">CallToolRequestSchema</code> handler validates input parameters and executes the corresponding tool.</li>
<li>Error handling ensures robust operation, distinguishing between user errors and internal failures.</li>
<li>This approach decouples tool registration from execution, enhancing modularity and scalability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server and connects it to the <code class="inline-code">StdioServerTransport</code>.</li>
<li>Pre-generating repomix content warms up the cache, reducing latency for subsequent requests.</li>
<li>This method demonstrates proactive resource management, ensuring a smooth user experience.</li>
<li>The separation of transport connection and content pre-generation highlights clear responsibility allocation.</li>
<li>This design supports extensibility, allowing additional initialization steps to be added easily.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function orchestrates the server lifecycle, handling initialization and shutdown signals.</li>
<li>Signal listeners ensure a graceful shutdown, cleaning up resources to prevent leaks.</li>
<li>The unhandled promise rejection handler logs errors without disrupting server operation.</li>
<li>This design prioritizes reliability, ensuring the server remains operational despite recoverable errors.</li>
<li>The centralized lifecycle management simplifies debugging and enhances maintainability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file organizes and exports the MCP tools, which are the building blocks of the adventure system. Each tool represents a distinct functionality, such as starting an adventure, choosing a theme, or exploring a quest. The modular design ensures that tools can be independently developed and maintained.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates the adventure by analyzing the codebase and presenting theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Processes individual quests, allowing iterative exploration.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks and displays the completion status of the adventure.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const tools = {
  start_adventure: startAdventure,
  choose_theme: chooseTheme,
  explore_quest: exploreQuest,
  view_progress: viewProgress
};
</code></pre>
<ul>
<li>This code imports and re-exports tools, aligning their names with the MCP convention.</li>
<li>Each tool is encapsulated in its own module, promoting separation of concerns.</li>
<li>The <code class="inline-code">tools</code> object serves as a registry, simplifying dynamic tool listing and execution.</li>
<li>This modular structure facilitates testing and enables incremental development.</li>
<li>The clear mapping between tool names and their implementations improves code readability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <code class="inline-code">setupHandlers</code> uses Zod schemas for input validation to ensure type safety.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how caching improves performance.</li>
<li>Explore how tools are modularized in <code class="inline-code">tools.ts</code> to support scalability and maintainability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that lists all files in the current directory. Add it to the <code class="inline-code">tools</code> registry and ensure it validates input parameters.</p>
<ul>
<li>Example: Use <code class="inline-code">zod</code> to define an optional parameter for filtering by file extension.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add <code class="inline-code">console.log</code> statements in <code class="inline-code">setupHandlers</code> to trace the flow of a tool request from validation to execution. This will help you understand the complete lifecycle of a tool invocation.</p>
</li>
<li><p><strong>Improve Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for available tools when an unknown tool is requested. This will enhance the developer experience.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the adventure system.</p>
<p>Quest MCP Tool Interface successfully deployed‚Äîyour progress has been committed and pushed to the master branch of excellence, setting the foundation for the next 80% of your development journey! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>