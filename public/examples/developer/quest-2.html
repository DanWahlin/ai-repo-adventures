<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Operations - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repository Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Operations</h1>
<hr>
<p>The MCP Tool Interface is the heart of the system, enabling dynamic exploration of codebases through interactive storytelling. By managing tool registration, execution, and user interaction, this module ensures seamless communication between the MCP server and its tools. Dive into the technical implementation of the <code class="inline-code">RepoAdventureServer</code> and its tool orchestration mechanisms to uncover the architecture that powers this gamified code exploration platform.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Tool Execution Flow</strong>: The process of validating user input and executing tool handlers securely.</li>
<li>‚ö° <strong>Graceful Shutdown</strong>: Techniques for ensuring stability during server termination.</li>
<li>üí° <strong>Error Handling Patterns</strong>: How errors are managed to maintain system integrity and provide informative feedback.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">RepoAdventureServer</code> class is the backbone of the MCP Tool Interface. It handles tool registration, user requests, and server lifecycle management. This file showcases advanced patterns like schema validation, dynamic tool execution, and warm-up caching for repository analysis. The implementation ensures extensibility and robustness, allowing developers to easily add new tools while maintaining stability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically and validates their schemas for secure execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server transport and pre-generates repository analysis content for improved responsiveness.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup, signal handling, and error management for seamless operation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Registers tools dynamically by iterating through the <code class="inline-code">tools</code> object and validating schemas using <code class="inline-code">zodToJsonSchema</code>.</li>
<li>Ensures secure tool execution by validating user input against Zod schemas before passing it to tool handlers.</li>
<li>Implements defensive programming with detailed error handling to protect against invalid requests and execution failures.</li>
<li>Demonstrates extensibility by decoupling tool registration and execution logic, allowing new tools to be added without modifying core functionality.</li>
<li>Provides clear feedback to users when errors occur, enhancing usability and debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server transport using <code class="inline-code">StdioServerTransport</code> for communication.</li>
<li>Pre-generates repository analysis content to reduce latency during user interactions.</li>
<li>Demonstrates the importance of background processing for improving responsiveness.</li>
<li>Uses <code class="inline-code">process.cwd()</code> to dynamically determine the project path, ensuring flexibility for different environments.</li>
<li>Logs key events for transparency and easier debugging during server operation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Handles server startup and graceful shutdown using signal listeners (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>).</li>
<li>Logs unhandled promise rejections without terminating the server, ensuring resilience during runtime.</li>
<li>Demonstrates separation of concerns by delegating server initialization and lifecycle management to distinct methods.</li>
<li>Uses defensive error handling to prevent crashes during startup, improving reliability.</li>
<li>Provides a clear mechanism for reporting errors, aiding in debugging and system maintenance.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file organizes the MCP tools into a cohesive interface, mapping their implementations to user-facing commands. It ensures modularity and maintainability, allowing tools to be updated or replaced without impacting other parts of the system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates repository analysis and returns theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Explores individual quests dynamically based on user input.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides completion status and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool definitions for easy registration and management within the MCP server.</li>
<li>Maps tools to user-facing commands, ensuring clarity and consistency in the interface.</li>
<li>Promotes modularity by separating tool implementations into individual files.</li>
<li>Enables extensibility by allowing new tools to be added without modifying the <code class="inline-code">tools</code> object structure.</li>
<li>Facilitates testing by providing a clear entry point for tool-related functionality.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how Zod schemas are used for input validation in <code class="inline-code">setupHandlers</code> to ensure type safety and prevent invalid tool executions.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how caching improves responsiveness during user interactions.</li>
<li>Explore the modular design of <code class="inline-code">tools.ts</code> to learn how tool definitions are organized for maintainability and extensibility.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that lists all files in the current project directory. Define its schema and handler, then register it in <code class="inline-code">tools.ts</code> and test its functionality.</p>
<ul>
<li>Example: Use Node.js <code class="inline-code">fs</code> module to implement the file listing functionality.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> to trace the flow of tool execution, from user input validation to handler execution. Analyze the logs to understand how the system processes requests.</p>
</li>
<li><p><strong>Improve Error Feedback</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for similar tool names when an unknown tool is requested. This will enhance usability and demonstrate advanced error handling techniques.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the MCP system.</p>
<p>Congratulations on successfully deploying your first MCP Tool Operations module‚Äîyour codebase of skills is growing stronger, and you&#39;re now 20% closer to achieving the full-stack mastery of this quest! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>