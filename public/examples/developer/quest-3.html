<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repo Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Quest Generation Engine</h1>
<hr>
<p>You find yourself in the heart of the Quest Generation Engine, where the intricate machinery of dynamic storytelling hums with precision. This engine is the brain behind the adventures, analyzing repositories, generating tailored quests, and weaving narratives that guide developers through their codebases. The air is thick with the promise of discovery as you delve into the mechanisms that transform static code into interactive journeys.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>State Management</strong>: How <code class="inline-code">AdventureState</code> tracks progress and manages quests dynamically.</li>
<li>üîç <strong>Quest Initialization</strong>: The process of generating quests and merging configuration with LLM-generated content.</li>
<li>‚ö° <strong>Story Parsing</strong>: Techniques used to parse and validate markdown content into structured quest data.</li>
<li>üí° <strong>File Integration</strong>: How configuration files influence quest generation and storytelling.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> is the central orchestrator of the quest generation engine. It coordinates the initialization of adventures, manages state, and interacts with the <code class="inline-code">StoryGenerator</code> to produce dynamic content. This file exemplifies stateful design patterns and the integration of external configurations into runtime processes.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a>: Initializes the adventure, generating the story and quests while merging configuration data.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a>: Handles user interactions to execute selected quests, utilizing caching for efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Produces detailed quest content, leveraging repository analysis and chunking for scalability.</li>
<li><code class="inline-code">progressPercentage</code>: Calculates the user&#39;s progress through the adventure.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>This function initializes the adventure by resetting the state and setting project context.</li>
<li>It merges quests generated by the <code class="inline-code">StoryGenerator</code> with those defined in the configuration file.</li>
<li>The modular design allows for custom themes and dynamic quest limits.</li>
<li>The use of async operations ensures non-blocking initialization, crucial for responsive systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>This method validates user input and determines the appropriate action (progress view or quest execution).</li>
<li>It employs helper functions to locate quests by various identifiers, enhancing user experience.</li>
<li>The modular design simplifies the addition of new quest handling logic.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> transforms repository analysis results into structured story and quest data. It integrates with LLMs to generate narratives and provides robust parsing mechanisms to ensure content validity.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a>: Produces the overall story and quests for an adventure, using LLMs and configuration data.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a>: Parses markdown responses into structured <code class="inline-code">StoryResponse</code> objects.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Creates detailed content for individual quests, handling chunked codebases effectively.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>This function validates the theme and delegates story generation to the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L627" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateWithLLM</code></a> method.</li>
<li>It ensures that the project context is set, enabling consistent data flow across the adventure lifecycle.</li>
<li>The design allows for future extensibility, such as additional theme validation logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);

  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];

  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};
  let titleFound = false;

  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      if (token.depth === 1) {
        titleFound = true;
        currentSection = &#39;story&#39;;
      } else if (token.depth === 2) {
        currentSection = token.text.toLowerCase();
      } else if (token.depth === 3 &amp;&amp; isQuestSection(currentSection)) {
        if (currentQuest.title &amp;&amp; currentQuest.description) {
          quests.push(createQuest(currentQuest, quests.length));
        }
        currentQuest = { title: token.text, description: &#39;&#39;, codeFiles: [] };
      }
    } else if (token.type === &#39;paragraph&#39;) {
      if (isStorySection(currentSection, titleFound)) {
        story += token.text + &#39;\n\n&#39;;
      } else if (currentQuest.title) {
        currentQuest.description += token.text + &#39;\n\n&#39;;
      }
    }
  }

  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push(createQuest(currentQuest, quests.length));
  }

  return { title, story: story.trim(), quests };
}
</code></pre>
<ul>
<li>This function parses markdown content into a <code class="inline-code">StoryResponse</code>, supporting multiple formats for quests.</li>
<li>It uses the <code class="inline-code">marked</code> library for tokenization, ensuring robust handling of markdown syntax.</li>
<li>The modular structure simplifies the addition of new parsing rules or formats.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<p>This file handles the loading and parsing of the <code class="inline-code">adventure.config.json</code> file, providing essential configuration data for quest generation.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">loadAdventureConfig</code></a>: Reads the raw configuration file from the project directory.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L28" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseAdventureConfig</code></a>: Parses the configuration into a structured object, with error handling for invalid JSON.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a>: Extracts file paths referenced in the configuration for validation and processing.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>This function reads the raw configuration file, returning <code class="inline-code">null</code> for missing or unreadable files.</li>
<li>The use of a helper function (<a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L6" target="_blank" rel="noopener noreferrer"><code class="inline-code">readFileIfExists</code></a>) simplifies error handling and improves code readability.</li>
<li>The modular design makes it easy to extend functionality, such as adding logging or metrics.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>This function extracts unique file paths from the configuration, validating their existence.</li>
<li>It uses a depth-first traversal to handle nested structures, ensuring comprehensive extraction.</li>
<li>The design supports flexible configuration formats, making it robust for various use cases.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <code class="inline-code">AdventureManager</code> merges configuration data with LLM-generated quests to understand the interplay between static and dynamic content.</li>
<li>Examine the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a> function to learn about robust markdown parsing techniques.</li>
<li>Explore the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a> function to see how file validation is integrated into the quest generation process.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Modify Quest Limits</strong>: Update the <code class="inline-code">adventure.config.json</code> file to enforce a specific number of quests. Observe how the <code class="inline-code">AdventureManager</code> adapts the generated quests to respect this limit.</p>
</li>
<li><p><strong>Add Custom Parsing Rules</strong>: Extend the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a> function to support a new quest format, such as YAML-based definitions. Test your changes with a sample markdown file.</p>
</li>
<li><p><strong>Optimize File Validation</strong>: Modify the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a> function to log missing files and suggest alternatives. This will enhance the robustness of the configuration processing.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Quest Generation Engine.</p>
<p>Congratulations on deploying the Quest Generation Engine‚Äîyour codebase just leveled up with 40% progress achieved; keep refactoring brilliance into reality! üöÄ üíé ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>