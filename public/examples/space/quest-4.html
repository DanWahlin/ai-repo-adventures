<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analysis Core - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Galactic Code Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis Core</h1>
<hr>
<p>As the Galactic Voyager approaches the Code Nebula, the crew prepares to delve into its most intricate systems. The Code Analysis Core is the ship&#39;s repository intelligence center, responsible for extracting meaningful insights from vast codebases and communicating with advanced LLMs. Your mission is to ensure the seamless operation of these systems, navigating through layers of validation, optimization, and dynamic content generation. The core&#39;s outputs fuel the ship&#39;s adventures, making this exploration critical to the success of your cosmic journey.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Content Generation</strong>: How targeted code analysis reduces resource usage while retaining essential functionality.</li>
<li>üîç <strong>LLM Integration</strong>: How adaptive throttling and error handling ensure reliable communication with large language models.</li>
<li>‚ö° <strong>Caching Strategies</strong>: How caching improves performance and prevents redundant computations in high-demand systems.</li>
<li>üí° <strong>Validation Techniques</strong>: How input sanitization and normalization protect against security vulnerabilities.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The Code Analysis Core operates as a gateway to the Code Nebula, leveraging the <code class="inline-code">RepoAnalyzer</code> class to extract targeted insights from codebases and optimize them for LLM processing. This file demonstrates advanced validation techniques, caching strategies, and subprocess orchestration to efficiently handle large-scale repositories.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> analyzes the entire codebase, applying compression and filtering to produce actionable insights.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> extracts specific files from the repository, optimizing content for token usage and relevance.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> executes the <code class="inline-code">repomix</code> CLI, capturing its output while enforcing memory and timeout constraints.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> ensures the input path is secure and free from malicious elements.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L368" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractFunctionFocusedContent</code></a> reduces token usage by keeping only essential functions and patterns.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;.git&#39;],
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true,
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This method validates the project path and generates repository insights using the <code class="inline-code">repomix</code> CLI.</li>
<li>Caching prevents redundant computations, significantly improving performance in repeated analyses.</li>
<li>Compression and filtering reduce token usage, ensuring the output is LLM-friendly.</li>
<li>The ignore patterns protect against unnecessary processing of irrelevant files.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

    let stdout = &#39;&#39;;
    let stdoutSize = 0;

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(`Repomix output too large (${stdoutSize} bytes)`));
      }
      stdout += chunk;
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed with exit code ${code}`));
    });
  });
}
</code></pre>
<ul>
<li>This method executes the <code class="inline-code">repomix</code> CLI as a subprocess, capturing its output for further processing.</li>
<li>Memory protection prevents excessive resource usage by enforcing a buffer size limit.</li>
<li>Graceful error handling ensures subprocess failures are logged and managed appropriately.</li>
<li>This approach demonstrates robust subprocess orchestration techniques.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> class bridges the Code Analysis Core with external LLMs, managing requests, responses, and adaptive throttling. This file showcases advanced error handling, dynamic parameter configuration, and rate limit detection to maintain reliable communication with AI systems.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> builds and executes LLM requests, handling rate limits and adaptive throttling.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a> initializes the client with the appropriate API key and endpoint based on the LLM provider.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> identifies rate limit errors, providing actionable information for recovery.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L462" target="_blank" rel="noopener noreferrer"><code class="inline-code">applyThrottling</code></a> dynamically adjusts request delays based on system load and rate limits.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L234" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateResponse</code></a> ensures the content returned by the LLM meets quality and completeness standards.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    const content = this.validateResponse(completion);

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();

    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      this.activateThrottling(error);
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This method executes LLM requests while handling rate limits and adaptive throttling.</li>
<li>Error detection provides detailed feedback for upstream recovery.</li>
<li>Logging and validation ensure the response meets quality standards and provides actionable insights.</li>
<li>Adaptive throttling prevents system overloads during high-demand periods.</li>
</ul>
<hr>
<pre><code class="language-typescript">private detectRateLimitType(error: any): RateLimitInfo {
  const is429Error = error?.status === 429 || error.message.includes(&#39;429&#39;);
  if (!is429Error) return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };

  if (error.message.includes(&#39;exceeded token rate limit&#39;)) {
    const retryMatch = error.message.match(/retry after (\d+) seconds/);
    const waitSeconds = retryMatch ? parseInt(retryMatch[1]) : 60;
    return { type: RateLimitType.REQUEST_RATE_LIMIT, waitSeconds, message: `Request rate limit hit, retry after ${waitSeconds} seconds` };
  }

  return { type: RateLimitType.REQUEST_RATE_LIMIT, waitSeconds: 60, message: &#39;429 rate limit encountered&#39; };
}
</code></pre>
<ul>
<li>This method identifies rate limit errors, extracting retry information for adaptive throttling.</li>
<li>Specific error patterns are matched to provide detailed feedback.</li>
<li>This approach demonstrates defensive programming techniques to handle API limitations effectively.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how caching in <code class="inline-code">RepoAnalyzer</code> improves performance and reduces redundant computations.</li>
<li>Explore the adaptive throttling mechanism in <code class="inline-code">LLMClient</code> to understand how delays are dynamically adjusted.</li>
<li>Review the subprocess orchestration in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> to learn robust error handling patterns.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add Custom Validation</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> to reject paths containing forbidden characters or patterns. Test with various inputs to ensure robustness.</p>
<ul>
<li>Example: Reject paths containing the substring &quot;temp&quot; or starting with &quot;backup_&quot;.</li>
</ul>
</li>
<li><p><strong>Trace LLM Interactions</strong>: Add logging statements in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> to capture the complete flow of an LLM request, including parameters, responses, and errors. Observe how data transforms at each step.</p>
</li>
<li><p><strong>Optimize Content Extraction</strong>: Enhance <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L368" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractFunctionFocusedContent</code></a> to include additional patterns for detecting important functions. Test with various codebases to validate the improvements.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, Code Analysis Core unlocked‚Äîyour starship of knowledge is now 60% closer to the galactic finish line, blazing through the cosmos with unstoppable brilliance! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>