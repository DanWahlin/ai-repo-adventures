<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Starship Repository Explorer</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Quest Generation Engine</h1>
<hr>
<p>The Repository Explorer&#39;s systems hum with anticipation as you enter the Quest Generation Engine, a vital module where the starship transforms raw code into interactive adventures. This is where the magic of storytelling meets the logic of TypeScript. The engine analyzes repositories, crafts compelling narratives, and generates quests tailored to each project. Your mission is to delve into this intricate system, uncovering how it orchestrates adventures, processes configurations, and ensures thematic consistency.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>State Management</strong>: How <code class="inline-code">AdventureState</code> tracks progress and caches quest content for efficient execution.</li>
<li>üîç <strong>Quest Generation Flow</strong>: How <code class="inline-code">StoryGenerator</code> combines LLM responses and project data to create dynamic adventures.</li>
<li>‚ö° <strong>Config Integration</strong>: How <code class="inline-code">adventure-config.ts</code> merges user-defined configurations into generated quests.</li>
<li>üí° <strong>Chunked Content Processing</strong>: How large codebases are handled in smaller, manageable parts for LLM-based quest generation.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> module acts as the captain of the Quest Generation Engine, coordinating the creation and execution of quests. It manages state, integrates user configurations, and ensures that generated adventures align with the selected theme. This file highlights the interplay between dynamic content generation and user-defined constraints.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a>: Resets the adventure state, generates the story and quests, and integrates configuration files.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a>: Executes a selected quest, leveraging caching for completed quests.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Processes codebase content to generate detailed quest narratives and exploration tasks.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the adventure state to ensure a clean slate for new stories.</li>
<li>Integrates user-defined configurations and custom themes into the story generation process.</li>
<li>Demonstrates dependency injection for flexible theme and project integration.</li>
<li>Highlights the importance of merging and validating quests against user configurations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates user input to ensure safe and accurate quest selection.</li>
<li>Handles progress requests separately, allowing users to view their current status.</li>
<li>Finds and executes quests, leveraging caching for completed ones to enhance performance.</li>
<li>Demonstrates modular design with clear separation of concerns.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> is the creative engine behind the Repository Explorer, transforming repository data and themes into compelling narratives. It interacts with LLMs to generate quests and provides fallback mechanisms for reliability.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a>: Combines project data and themes to produce stories and quests.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Processes code chunks to create detailed quest content.</li>
<li><code class="inline-code">processChunkedQuestContent</code>: Handles large codebases by iteratively generating content for each chunk.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Validates the selected theme to ensure compatibility with the story generation process.</li>
<li>Coordinates with LLMs to dynamically generate stories and quests based on repository data.</li>
<li>Demonstrates flexibility by supporting various themes and project contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async processChunkedQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  chunkResult: ChunkResult,
  adventureGuidance: string,
  customInstructions: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  let accumulatedContent = &#39;&#39;;
  let contextSummary = &#39;&#39;;

  for (let i = 0; i &lt; chunkResult.chunks.length; i++) {
    const chunk = chunkResult.chunks[i];
    const isFirstChunk = i === 0;
    const isLastChunk = i === chunkResult.chunks.length - 1;

    const prompt = isFirstChunk
      ? `Generate the foundation for the quest adventure.`
      : isLastChunk
      ? `Finalize the adventure story.`
      : `Enhance the story with this additional context.`;

    const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST, context: &#39;quest chunk&#39; });
    const chunkContent = this.extractMarkdownContent(response.content);
    accumulatedContent = isFirstChunk ? chunkContent : accumulatedContent + chunkContent;

    if (!isLastChunk) {
      contextSummary = await this.generateContextSummary(accumulatedContent, theme, i + 1, chunkResult.chunks.length);
    }
  }

  return {
    adventure: accumulatedContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Processes large codebases by breaking them into manageable chunks.</li>
<li>Ensures thematic consistency and narrative flow across all parts of the quest.</li>
<li>Demonstrates iterative content generation with context-aware prompts.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<p>The <code class="inline-code">adventure-config.ts</code> file bridges user-defined configurations and the quest generation engine. It parses configuration files, extracts relevant data, and integrates it into the adventure flow.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">loadAdventureConfig</code></a>: Reads the raw configuration file from the project path.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L28" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseAdventureConfig</code></a>: Parses and validates the configuration file into a usable format.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a>: Extracts file paths referenced in the configuration for targeted quest generation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the adventure configuration file from the specified project path.</li>
<li>Provides a robust mechanism for handling missing or unreadable files.</li>
<li>Demonstrates separation of concerns by isolating file reading logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses the configuration file to extract all unique file paths.</li>
<li>Validates file existence to ensure only relevant paths are used.</li>
<li>Demonstrates the use of recursive traversal for flexible data extraction.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Inspect how <code class="inline-code">AdventureManager</code> caches quest content to improve performance during revisits.</li>
<li>Notice how <code class="inline-code">StoryGenerator</code> handles chunked content processing for large repositories.</li>
<li>Explore how <code class="inline-code">adventure-config.ts</code> integrates user-defined configurations into the quest generation flow.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a Custom Quest</strong>: Modify <code class="inline-code">adventure.config.json</code> to include a new quest with specific file paths. Observe how the system integrates this quest into the adventure.</li>
<li><strong>Trace Chunk Processing</strong>: Add logging to <code class="inline-code">processChunkedQuestContent</code> to track how each chunk contributes to the final quest content. Analyze the iterative generation process.</li>
<li><strong>Validate Config Changes</strong>: Introduce an invalid configuration in <code class="inline-code">adventure.config.json</code> and observe how the system handles parsing errors. Improve error handling if necessary.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Repository Explorer&#39;s systems.</p>
<p>Mission accomplished, star voyager! You&#39;ve ignited the thrusters of the Quest Generation Engine and are now 40% through your cosmic odyssey‚Äîkeep charting those stellar paths! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>