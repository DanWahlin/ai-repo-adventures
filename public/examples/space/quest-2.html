<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Galactic Code Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Command Interface</h1>
<hr>
<p>As you navigate the Galactic Voyager&#39;s command deck, the MCP Command Interface hums with activity, orchestrating the ship&#39;s tools with precision. This system is the bridge between the crew and the starship&#39;s advanced capabilities, dynamically routing requests and executing commands. Your mission is to explore the intricate mechanisms that power this interface, ensuring the tools work in harmony to execute adventures and analyze codebases. The fate of future explorations depends on your ability to decode and optimize this vital system.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically registered and validated using schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing and recovering from tool execution errors.</li>
<li>‚ö° <strong>Pre-Execution Optimization</strong>: How pre-generating content improves system responsiveness.</li>
<li>üí° <strong>Graceful Shutdown Design</strong>: Strategies for ensuring clean resource management during system termination.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file is the heart of the MCP Command Interface, managing the server&#39;s lifecycle, registering tools, and handling requests. It leverages Zod schemas for input validation, ensuring robust communication between the interface and the tools. The file also demonstrates best practices in error handling and resource management, including pre-generating content to optimize performance and implementing graceful shutdown mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools and validates incoming requests using Zod schemas.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server, connects the transport layer, and pre-generates content to improve responsiveness.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates the server startup, handles shutdown signals, and manages unhandled promise rejections.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools and their schemas, enabling extensibility without hardcoding tool definitions.</li>
<li>Validates input parameters using Zod schemas, ensuring type safety and preventing invalid requests.</li>
<li>Implements defensive programming with detailed error messages for invalid or unknown tools.</li>
<li>Decouples tool registration from execution, supporting modular tool development.</li>
<li>Demonstrates robust error handling, ensuring the server remains operational during failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server to the transport layer, enabling communication with external clients.</li>
<li>Pre-generates content for the current project, reducing latency during tool execution.</li>
<li>Uses asynchronous operations to ensure non-blocking initialization.</li>
<li>Demonstrates the importance of warming up caches for performance optimization.</li>
<li>Highlights the use of the <code class="inline-code">repoAnalyzer</code> module to streamline repository analysis.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Handles initialization and shutdown signals, ensuring clean resource management.</li>
<li>Logs unhandled promise rejections without terminating the server, improving resilience.</li>
<li>Provides a clear error-handling strategy for startup failures.</li>
<li>Demonstrates separation of concerns by delegating server logic to the <code class="inline-code">RepoAdventureServer</code> class.</li>
<li>Highlights the importance of robust logging for debugging and monitoring.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file defines the tools available to the MCP Command Interface, organizing them into a centralized registry. Each tool represents a specific functionality, such as starting an adventure or viewing progress. The file demonstrates modular design principles, allowing tools to be independently developed and maintained.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code> initiates the codebase analysis and adventure generation process.</li>
<li><code class="inline-code">choose_theme</code> allows users to select a story theme, customizing the adventure experience.</li>
<li><code class="inline-code">explore_quest</code> handles individual quest exploration, dynamically generating content.</li>
<li><code class="inline-code">view_progress</code> provides progress updates, tracking completed and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool definitions in a single object, simplifying registration and lookup.</li>
<li>Uses descriptive names for tools, improving code readability and maintainability.</li>
<li>Supports modular development by exporting individual tools for independent testing.</li>
<li>Demonstrates the use of consistent naming conventions for clarity.</li>
<li>Facilitates dynamic tool registration in the MCP server.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <code class="inline-code">setupHandlers</code> uses Zod schemas to validate inputs and ensure type safety.</li>
<li>Study the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how caching improves performance.</li>
<li>Explore the graceful shutdown implementation in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> to learn about resource cleanup techniques.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that returns a list of all files in the current directory. Register it in <code class="inline-code">tools.ts</code> and implement its handler function. This will help you understand the tool registration process.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> to trace the flow of a tool request from validation to execution. Observe how errors are handled and responses are generated.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for resolving common issues, such as listing available tools when an unknown tool is requested.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, Cadet‚Äîyour mastery of the MCP Command Interface has ignited the first star in your galaxy of quests; onward to the next cosmic milestone! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>