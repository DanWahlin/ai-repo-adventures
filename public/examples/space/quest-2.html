<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Code Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Command Interface Calibration</h1>
<hr>
<p>As the <em>Code Voyager</em> approaches the encrypted nebula, your task is to calibrate the ship&#39;s MCP Command Interface. This interface serves as the nerve center, connecting the starship‚Äôs tools to its mission-critical systems. By configuring dynamic handlers and ensuring seamless tool execution, you will unlock the repository‚Äôs secrets and enable the crew to navigate the galaxy‚Äôs vast knowledge networks. The nebula pulses with encrypted signals‚Äîwill you decode them in time?</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically registered and validated at runtime using schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for robust error management to ensure system stability.</li>
<li>‚ö° <strong>Transport Initialization</strong>: How the MCP server establishes communication channels and pre-generates content for efficiency.</li>
<li>üí° <strong>Graceful Shutdown</strong>: Strategies for cleaning up resources during unexpected interruptions.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file is the core of the MCP Command Interface, responsible for initializing the server, dynamically registering tools, and handling communication protocols. It employs schema validation for safe input handling and includes mechanisms for error recovery and graceful shutdown. This file demonstrates how the server orchestrates tool execution and pre-generates repository content for optimized performance.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools and validates inputs using Zod schemas.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server transport, pre-generates repository content, and starts the command interface.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates server startup and handles graceful shutdown signals for uninterrupted operation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Registers tools dynamically, allowing flexibility in adding or modifying tools without changing core logic.</li>
<li>Validates inputs with Zod schemas to ensure type safety and prevent invalid commands.</li>
<li>Implements defensive error handling to protect the server from unknown or invalid tool requests.</li>
<li>Decouples tool registration and execution, promoting modularity and maintainability.</li>
<li>Converts Zod schemas to JSON schemas, ensuring compatibility with external systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server with a <code class="inline-code">StdioServerTransport</code>, enabling communication over standard input/output streams.</li>
<li>Pre-generates repository content using <code class="inline-code">repoAnalyzer</code> to improve performance during user interactions.</li>
<li>Logs server status and project path for debugging and operational transparency.</li>
<li>Demonstrates efficient resource utilization by performing pre-generation in the background.</li>
<li>Ensures the server is ready to handle requests immediately after startup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Sets up signal handlers for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to gracefully shut down the server during interruptions.</li>
<li>Catches unhandled promise rejections, logs them, and ensures the server remains operational.</li>
<li>Encapsulates the server startup process in a try-catch block to handle fatal errors and exit cleanly.</li>
<li>Demonstrates robust error recovery and resource management in a production-grade system.</li>
<li>Highlights the importance of operational resilience in long-running server applications.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file defines the tools available to the MCP Command Interface. Each tool corresponds to a specific functionality, such as starting an adventure or viewing progress. The tools are modularly organized for maintainability and exported for dynamic registration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code> initializes the adventure by analyzing the repository and presenting theme options.</li>
<li><code class="inline-code">choose_theme</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code> allows users to interact with individual quests.</li>
<li><code class="inline-code">view_progress</code> tracks completion status and provides a summary of remaining tasks.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const tools = {
  start_adventure: startAdventure,
  choose_theme: chooseTheme,
  explore_quest: exploreQuest,
  view_progress: viewProgress
};
</code></pre>
<ul>
<li>Organizes tools into a single exportable object for easy integration with the MCP server.</li>
<li>Adheres to the single-responsibility principle by separating tool logic into individual files.</li>
<li>Ensures consistency in tool naming conventions for intuitive usage.</li>
<li>Facilitates dynamic registration in the server by providing a centralized tool registry.</li>
<li>Promotes scalability, allowing new tools to be added without modifying existing functionality.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <code class="inline-code">setupHandlers</code> uses Zod schemas for input validation and consider how this approach prevents runtime errors.</li>
<li>Study the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method to understand how pre-generating repository content improves responsiveness.</li>
<li>Examine the graceful shutdown logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> to learn best practices for resource cleanup in long-running servers.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that lists all files in the current project directory. Use Zod schemas to validate optional parameters like file extensions.</p>
<ul>
<li>Example: Add the tool to <code class="inline-code">tools.ts</code> and register it in <code class="inline-code">setupHandlers</code>.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add console logs in <code class="inline-code">setupHandlers</code> to trace the flow of a tool request from input validation to execution. Observe how errors are handled during invalid requests.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tools when an unknown tool is requested. This will improve the user experience.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the galaxy‚Äôs encrypted repository.</p>
<p>Mission accomplished, Cadet‚Äîyour mastery of the MCP Command Interface has ignited the thrusters for this starship&#39;s journey, propelling you 20% closer to cosmic conquest! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>