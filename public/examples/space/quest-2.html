<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Starship Repository Explorer</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>As the Repository Explorer drifts through the cosmic sea of codebases, you find yourself in the MCP Tool Interface chamber. This critical station acts as the ship&#39;s translator, bridging the crew&#39;s commands with the starship&#39;s powerful instruments. Here, tools are dynamically registered, validated, and executed, ensuring seamless communication with the vast galaxy of repositories. Your mission is to uncover how the interface orchestrates tool operations, validates input schemas, and maintains the ship&#39;s operational stability during exploration.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How the system dynamically registers tools and their schemas for flexible operations.</li>
<li>üîç <strong>Input Validation with Zod</strong>: How schemas ensure safe and accurate tool execution by validating inputs.</li>
<li>‚ö° <strong>Graceful Error Handling</strong>: How the server recovers from tool execution errors without disrupting operations.</li>
<li>üí° <strong>MCP Protocol Design</strong>: How the MCP server implements a modular, extensible architecture for tool interactions.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file is the heart of the MCP Tool Interface, managing the lifecycle of the server and its tools. It dynamically registers tools, validates inputs using Zod schemas, and executes commands through the MCP protocol. This file demonstrates robust error handling, modular design, and dependency injection to ensure the system remains stable and extensible.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers handlers for listing and executing tools, validating inputs dynamically.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Starts the MCP server, initializes transport, and pre-generates repository content for efficient operations.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates the server lifecycle, including graceful shutdown and error management.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>The <code class="inline-code">setupHandlers</code> method dynamically registers handlers for tools, ensuring flexibility in tool operations.</li>
<li>Zod schemas validate tool inputs, transforming them into JSON schemas for compatibility across systems.</li>
<li>The error handling mechanism distinguishes between invalid parameters and internal errors, improving robustness.</li>
<li>This modular design allows new tools to be added without modifying the core server logic.</li>
<li>Dynamic validation ensures only well-formed inputs are processed, enhancing security.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the MCP server and connects it to the transport layer for communication.</li>
<li>Pre-generating repository content warms up the cache, reducing latency during tool execution.</li>
<li>The use of <code class="inline-code">StdioServerTransport</code> demonstrates adherence to the MCP protocol for seamless communication.</li>
<li>This method ensures the server is ready to handle requests immediately after startup.</li>
<li>Background processing of repository analysis optimizes performance for subsequent operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function coordinates the server&#39;s lifecycle, including startup and graceful shutdown.</li>
<li>Signal handlers ensure the server cleans up resources properly when terminated.</li>
<li>Unhandled promise rejections are logged but do not crash the server, enhancing resilience.</li>
<li>This pattern separates initialization concerns, making the code easier to maintain and test.</li>
<li>Error handling ensures that startup failures are clearly reported and do not leave the server in an unstable state.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file defines the tools available in the MCP Tool Interface. Each tool encapsulates a specific functionality, such as starting an adventure or exploring a quest. This file demonstrates how tools are registered and exported for use by the server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initializes the adventure by analyzing the codebase and presenting theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Explores individual quests, allowing users to interact with specific parts of the adventure.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides a status update on completed and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object centralizes all tool definitions, making them easily accessible for registration.</li>
<li>Each tool follows a consistent structure, simplifying integration with the MCP server.</li>
<li>This modular approach allows tools to be developed and tested independently.</li>
<li>The clear separation of responsibilities ensures that each tool focuses on a specific aspect of the adventure.</li>
<li>Exporting tools in this format simplifies dynamic registration and enhances extensibility.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how Zod schemas are used for input validation and consider how this pattern can improve security in your own projects.</li>
<li>Observe how the <code class="inline-code">setupHandlers</code> method dynamically registers tools, making it easy to add new functionalities.</li>
<li>Explore the error handling patterns to understand how the system maintains stability during tool execution.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Implement a new tool that summarizes the repository&#39;s README file. Register it in the <code class="inline-code">tools.ts</code> file and validate its input using a Zod schema.</p>
<ul>
<li>Example: Create a <code class="inline-code">summarize_readme</code> tool that extracts key points from the README.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add <code class="inline-code">console.log</code> statements to the <code class="inline-code">setupHandlers</code> method to trace how tools are registered and executed. Observe the flow of data during a tool invocation.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for resolving common issues, such as missing or invalid parameters.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Repository Explorer&#39;s systems.</p>
<p>Mission accomplished, star navigator! You&#39;ve successfully docked the MCP Tool Interface into your cosmic arsenal‚Äîkeep fueling your momentum for the next stellar quest! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>