<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Command Operations Console - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: A stellar voyage into exploration systems</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Command Operations Console</h1>
<hr>
<p>The Command Operations Console hums softly as its circuits awaken. You find yourself aboard the Starship Infinitum, tasked with configuring and activating the MCP (Mission Command Protocol) interface. This system, housed across various interconnected modules, manages the ship‚Äôs interactive storytelling engine. From coordinating tool operations to processing interstellar repository data, every line of code fuels the AI&#39;s ability to generate epic space adventures. As you interface with the codebase‚Äôs core architecture, prepare to unlock the mysteries that power the MCP tools, ensuring this mission‚Äôs launch into the digital cosmos is flawless.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Starship Tools</strong>: How does the console dynamically list and validate interactive tools before execution?</li>
<li>‚ö° <strong>Mission Initialization</strong>: How are the core systems and handlers set up and activated in the MCP server?</li>
<li>üõ°Ô∏è <strong>Navigational Safety</strong>: What mechanisms are in place to ensure error handling and mission stability during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Tool Management</h3>
<p>This file hosts the main processes for the MCP server, including its initialization, tool setup, and runtime operations. The <code class="inline-code">RepoAdventureServer</code> class acts as the orchestrator, setting up handlers, managing server communication, and pre-generating analysis data for optimal performance when handling requests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the MCP server to handle dynamic tool listing and execution using schemas for input validation.</li>
<li><code class="inline-code">run</code>: Initiates the communication layer with the command interface and preps the interstellar repository exploration.</li>
<li><code class="inline-code">main</code>: Boots the MCP server, integrates signal-based shutdown handling, and logs errors for seamless mission continuity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists and executes tools using schemas to validate inputs, which guarantees precise control over the tools activated.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> ensures only known tools are presented to users, while <code class="inline-code">CallToolRequestSchema</code> evaluates and validates tool invocation.</li>
<li>Use of <code class="inline-code">zodToJsonSchema</code> highlights a structured and adaptable validation approach suitable for mission-critical tasks.</li>
<li>Error handling, using <code class="inline-code">McpError</code>, ensures the server maintains stability even when tools fail or inputs are invalid.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server transport with <code class="inline-code">StdioServerTransport</code> to form the backbone of MCP communication.</li>
<li>Pre-generates repository data with <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize performance during exploration.</li>
<li>The process emphasizes proactive initialization to reduce latency and improve responsiveness for users.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function serves as the hub for server initialization, starting both the server and error listeners.</li>
<li>Included signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) activate <code class="inline-code">gracefulShutdown</code>, preventing data loss during early termination.</li>
<li>Proper error logging and unhandled rejection management ensure that unforeseen issues do not compromise overall system integrity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the highlighted sections as a reference to understand how tool validation and execution are centralized in the MCP server setup.</li>
<li>Pay attention to the structured handling of user inputs and errors ‚Äì this is crucial for adapting similar architectural designs in future systems.</li>
<li>Review <code class="inline-code">main</code> as a blueprint for constructing resilient system initialization sequences.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Commander‚ÄîQuest 2: Command Operations Console is a go, propelling you to 20% completion and lighting the engines for your stellar odyssey ahead! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>