<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Codebase Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Command Interface</h1>
<hr>
<p>The Starship Codex&#39;s MCP Command Interface hums with activity as it prepares to decode the Repository Nebula&#39;s secrets. This system acts as the bridge between the explorers and the ship&#39;s tools, routing requests to specialized modules and ensuring seamless communication. As you step into the control room, the holographic panels display a dynamic list of instruments, ready to execute commands and unravel the mysteries of the galaxy of code. Your mission is to ensure the interface operates flawlessly, guiding the crew through the nebula&#39;s cosmic data streams.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas for safe execution.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing tool execution failures and invalid requests gracefully.</li>
<li>‚ö° <strong>Server Lifecycle Management</strong>: How to handle initialization, shutdown, and background processes in MCP servers.</li>
<li>üí° <strong>Communication Protocols</strong>: How MCP interfaces ensure seamless interaction between tools and external systems.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The MCP Command Interface, implemented in <code class="inline-code">server.ts</code>, is the backbone of the Starship Codex&#39;s communication system. It dynamically registers tools, validates incoming requests, and executes commands. This file showcases robust error handling and lifecycle management, including graceful shutdown procedures and background caching processes. The <code class="inline-code">RepoAdventureServer</code> class encapsulates these functionalities, ensuring reliable operation during exploration missions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically and validates input schemas for safe execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Activates the MCP server, connects transport systems, and pre-generates repository content for improved responsiveness.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Coordinates server initialization and handles graceful shutdown signals to ensure stability.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools and validates their schemas, ensuring safe and predictable execution.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler provides a manifest of available tools, enabling external systems to understand capabilities.</li>
<li>Input validation using Zod prevents errors caused by malformed or unexpected arguments.</li>
<li>The error handling pattern ensures stability, even when tools fail or invalid requests are made.</li>
<li>This modular approach allows new tools to be added without modifying the core server logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server, connects transport systems, and pre-generates repository content to optimize responsiveness.</li>
<li>Background caching ensures that initial user queries are handled efficiently without delays.</li>
<li>The transport connection pattern supports dynamic communication protocols, enhancing flexibility.</li>
<li>This method demonstrates the importance of preemptive resource allocation in interactive systems.</li>
<li>The use of asynchronous operations ensures non-blocking execution during server startup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function orchestrates server initialization, handling shutdown signals and unhandled promise rejections.</li>
<li>Signal handling ensures the server can gracefully terminate while preserving critical resources.</li>
<li>Error logging provides transparency and aids debugging during unexpected failures.</li>
<li>The separation of concerns between initialization, signal handling, and error management enhances maintainability.</li>
<li>This approach demonstrates robust lifecycle management for long-running services.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file defines the interactive tools available for exploration missions. These tools are organized into separate modules for maintainability and dynamically registered within the MCP server. The file highlights the modular design of the tool system, enabling flexible expansion and clear separation of responsibilities.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the repository and presents theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes individual quests, facilitating deeper exploration.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides completion status and remaining quests, guiding the crew&#39;s progress.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>This snippet exports tools in a structured format, enabling dynamic registration in the MCP server.</li>
<li>Each tool is defined as a modular handler, simplifying code organization and future expansions.</li>
<li>The naming convention aligns with MCP standards, ensuring consistent interaction patterns.</li>
<li>This approach decouples tool definitions from their execution logic, improving maintainability.</li>
<li>Modular design allows individual tools to be tested and updated independently without affecting others.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Investigate how <code class="inline-code">setupHandlers</code> uses Zod schemas for input validation and dynamic tool registration.</li>
<li>Observe how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> pre-generates content to improve responsiveness during initial user interactions.</li>
<li>Explore the modular structure of tools in <code class="inline-code">tools.ts</code> to understand how new functionalities can be added seamlessly.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">analyze_dependencies</code> that scans the repository for dependency usage. Register it in <code class="inline-code">tools.ts</code> and implement its handler logic in a separate file.</p>
<ul>
<li>Example: &quot;Use Zod schemas to validate input parameters for the tool and ensure safe execution.&quot;</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> and <code class="inline-code">CallToolRequestSchema</code> to trace the lifecycle of a tool request. Observe how requests are validated, executed, and responded to by the MCP server.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tool names when an unknown tool is requested. This improves user experience and demonstrates defensive programming.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Mission accomplished, Star Commander‚ÄîMCP Command Interface is now fully operational, propelling you 20% closer to cosmic mastery! üöÄüíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>