<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Stellar Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Stellar Tool Integration</h1>
<hr>
<p>The Starship Codebreaker NX-2023 orbits a massive repository nebula, where cosmic code clusters glow with untapped potential. Inside the ship‚Äôs MCP Command Interface, the crew is preparing to engage the dynamic tool registry, enabling seamless interaction with alien technologies embedded within the nebula. As navigator, you must ensure the tools are properly registered and validate their parameters before execution. Only by mastering the interface can the crew unlock the secrets hidden in the repository‚Äôs depths.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated within the MCP server.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques to manage invalid inputs and runtime failures gracefully.</li>
<li>‚ö° <strong>Tool Execution Flow</strong>: The lifecycle of MCP tools, from validation to execution.</li>
<li>üí° <strong>Pre-Generation Strategy</strong>: How background initialization improves responsiveness during runtime.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">RepoAdventureServer</code> class is the heart of the MCP Command Interface, managing tool registration and execution within the Codebreaker‚Äôs systems. This file demonstrates how the server orchestrates tool interactions using structured schemas for input validation and error handling. The asynchronous <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method ensures the system is prepared for complex operations, including pre-generating repository analysis content to reduce latency during missions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> registers tools dynamically, ensuring validated input schemas and secure execution protocols.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server transport and pre-generates repository content for faster responses during user commands.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates server startup, graceful shutdown, and error recovery mechanisms.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;, 
        $refStrategy: &#39;none&#39; 
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li><code class="inline-code">setupHandlers</code> enables dynamic listing of tools, mapping each tool to its schema and description for external clients.</li>
<li>Input schema validation with Zod ensures strict parameter checks before executing tool handlers.</li>
<li>Defensive programming patterns handle errors gracefully, differentiating between invalid input and internal failures.</li>
<li>The modular design decouples tool registration from execution, enhancing maintainability and scalability.</li>
<li>The use of <code class="inline-code">zodToJsonSchema</code> integrates schema conversion for interoperability between the server and clients.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the MCP server using the stdio transport protocol, enabling communication with external systems.</li>
<li>Pre-generating repository content warms up the cache, improving responsiveness during subsequent tool executions.</li>
<li>Logging provides transparency into initialization progress, aiding diagnostics during deployment.</li>
<li>The separation of transport connection and background initialization minimizes startup delays while optimizing runtime performance.</li>
<li>The asynchronous flow ensures operations like content generation do not block server readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function handles server initialization, including signal-based graceful shutdown and error monitoring.</li>
<li>Event listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> ensure proper cleanup during termination, preventing resource leaks.</li>
<li>Unhandled promise rejection logging safeguards against silent failures, ensuring issues are visible for debugging.</li>
<li>Centralized error handling improves system stability by isolating startup failures from runtime errors.</li>
<li>The separation of concerns between initialization, shutdown, and error handling maintains modularity.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file serves as the entry point for registering tools in the MCP Command Interface. By exporting tools with standardized naming conventions, it ensures compatibility with the server‚Äôs dynamic tool registry. Each tool represents a distinct operation in the Codebreaker‚Äôs mission, from adventure initialization to progress tracking.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">tools</code> exports the complete set of MCP tools for dynamic registration in the server.</li>
<li><code class="inline-code">start_adventure.handler</code> analyzes codebases and provides theme options for storytelling.</li>
<li><code class="inline-code">choose_theme.handler</code> generates custom adventures based on user-selected themes.</li>
<li><code class="inline-code">explore_quest.handler</code> processes individual quests, allowing iterative exploration.</li>
<li><code class="inline-code">view_progress.handler</code> retrieves mission progress to guide the crew‚Äôs next steps.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object consolidates all MCP tools for easy integration with the server.</li>
<li>Each tool has a well-defined handler function, maintaining consistent naming conventions for client interactions.</li>
<li>Modular organization simplifies tool management, allowing new tools to be added without modifying existing code.</li>
<li>The export structure ensures compatibility with dynamic registration patterns in <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Centralized tool definitions enhance maintainability by reducing duplication across the codebase.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Individual tool exports maintain compatibility with MCP naming conventions for seamless server integration.</li>
<li>Each tool corresponds to a specific step in the adventure lifecycle, enabling clear separation of responsibilities.</li>
<li>The export structure supports dependency injection and testing, allowing tools to be independently validated.</li>
<li>The consistent naming pattern aligns with server registration requirements, streamlining integration.</li>
<li>This approach enables developers to focus on tool-specific functionality without worrying about registry mechanics.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">setupHandlers</code> uses Zod schemas to validate tool input for enhanced security and type safety.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>, which trades initial startup time for improved runtime responsiveness.</li>
<li>Explore the modular tool export pattern in <code class="inline-code">tools.ts</code>, noting how it simplifies integration with the MCP server.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool named <code class="inline-code">analyze_files</code> that scans the repository for specific file types. Use Zod schemas for input validation and register it in <code class="inline-code">tools.ts</code>. Test its integration with <code class="inline-code">RepoAdventureServer</code>.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> to trace tool execution, from request arrival to handler invocation. Run the server and observe the flow for different tools.</p>
</li>
<li><p><strong>Improve Error Feedback</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for correcting invalid inputs. For example, suggest similar tool names when the requested tool is not found.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Codebreaker‚Äôs systems.</p>
<p>Mission accomplished, star navigator‚Äîyour mastery of the MCP Command Interface has launched you into the cosmos of potential, lighting up your progress at warp speed to 20% completion! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>