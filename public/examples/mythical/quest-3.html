<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Quest Generation Codex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Quest Generation Codex</h1>
<hr>
<p>In the heart of Codethia‚Äôs enchanted library lies the Quest Generation Codex, a mystical tome that transforms the essence of code into epic adventures. This Codex, bound by magical glyphs, interprets the repository‚Äôs structure and weaves it into heroic tales. However, its power is locked behind layers of intricate spells and ancient scripts. To master it, you must delve into the Codex‚Äôs mechanisms, uncover its secrets, and learn the art of crafting adventures from raw code.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Quest Initialization</strong>: How <code class="inline-code">AdventureManager</code> initializes adventures and merges file-specific configurations.</li>
<li>üîç <strong>Dynamic Quest Generation</strong>: How the <code class="inline-code">StoryGenerator</code> converts repository context into themed quests using LLMs.</li>
<li>‚ö° <strong>Configuration Parsing</strong>: How <code class="inline-code">adventure-config.ts</code> extracts and formats configuration files for quest generation.</li>
<li>üí° <strong>Content Optimization</strong>: Techniques for handling large codebases with chunking and targeted content generation.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> orchestrates the entire lifecycle of a quest, from initializing adventures to executing specific quests. It bridges the repository analysis, configuration parsing, and dynamic content generation. This file demonstrates how quests are dynamically tailored by merging LLM-generated content with project-specific configurations.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a>: Sets up the adventure by resetting state, generating story and quests, and merging configuration files.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a>: Executes a selected quest, caching results for revisiting and validating prerequisites.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Dynamically generates quest content by prioritizing quest-specific files, configuration optimizations, and full repository context.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);

  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the adventure state to ensure a clean slate for new quests.</li>
<li>Integrates project-specific configurations and custom themes into quest generation.</li>
<li>Merges LLM-generated quests with file references from <code class="inline-code">adventure.config.json</code>.</li>
<li>Enforces consistency between generated quests and configuration-defined quest counts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates user input to ensure valid quest selection.</li>
<li>Supports viewing progress or executing specific quests.</li>
<li>Handles scenarios where quests are not found, providing appropriate feedback to users.</li>
<li>Executes quests with caching for previously completed ones.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;

  if (this.state.projectPath) {
    const config = parseAdventureConfig(this.state.projectPath);
    const hasConfigOptimization = config &amp;&amp; typeof config === &#39;object&#39; &amp;&amp; &#39;adventure&#39; in config;

    if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0) {
      try {
        codeContent = await repoAnalyzer.generateTargetedContent(this.state.projectPath, quest.codeFiles, false);
        codeContent = repoAnalyzer.prependCoreProjectContext(this.state.projectPath, codeContent);
      } catch {
        codeContent = hasConfigOptimization
          ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
          : this.state.projectInfo!.repomixContent;
      }
    } else {
      codeContent = hasConfigOptimization
        ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
        : this.state.projectInfo!.repomixContent;
    }
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  const chunkResult = ContentChunker.chunkContent(codeContent);
  return await this.storyGenerator.generateQuestContent({
    quest,
    theme: this.state.currentTheme!,
    chunkResult,
    questPosition: this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1,
    totalQuests: this.state.quests.length
  });
}
</code></pre>
<ul>
<li>Prioritizes quest-specific files for targeted content generation.</li>
<li>Falls back to optimized or full repository context when specific files are unavailable.</li>
<li>Uses chunking to handle large codebases efficiently, ensuring optimal LLM processing.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> is responsible for transforming repository context into themed quests. It leverages LLMs to dynamically generate stories, quests, and completion summaries. This file showcases advanced prompt engineering and chunked processing for large codebases.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a>: Creates the overarching story and quests by combining repository context with theme-specific prompts.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Dynamically generates detailed quest content using chunked code analysis.</li>
<li><code class="inline-code">processChunkedQuestContent</code>: Handles iterative processing of large codebases, ensuring coherent quest narratives.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Validates the selected theme to ensure compatibility with the generation process.</li>
<li>Integrates project-specific configurations into the story generation workflow.</li>
<li>Initiates the LLM-based generation of stories and quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, chunkResult, questPosition, totalQuests } = config;

  if (chunkResult.chunks.length === 1) {
    const prompt = loadQuestContentPrompt({
      theme,
      adventureTitle: quest.title,
      codeContent: chunkResult.chunks[0].content,
      storyContent: this.currentStoryContent || &#39;&#39;,
      questPosition,
      totalQuests
    }) + this.QUEST_FORMAT_INSTRUCTIONS;

    const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST });
    return { adventure: response.content.trim(), fileExploration: &#39;&#39;, codeSnippets: [], hints: [] };
  }

  return await this.processChunkedQuestContent(quest, theme, chunkResult, &#39;&#39;, &#39;&#39;, questPosition, totalQuests);
}
</code></pre>
<ul>
<li>Dynamically adjusts the prompt based on the size of the codebase.</li>
<li>Handles single-chunk and multi-chunk scenarios for efficient LLM processing.</li>
<li>Ensures the generated content aligns with the quest‚Äôs narrative and theme.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<p>This file handles the parsing and formatting of <code class="inline-code">adventure.config.json</code>, ensuring that configuration data is seamlessly integrated into the quest generation process.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">loadAdventureConfig</code></a>: Reads the raw configuration file from the project directory.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L28" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseAdventureConfig</code></a>: Parses and validates the configuration file into a usable object.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L75" target="_blank" rel="noopener noreferrer"><code class="inline-code">formatAdventureConfigForPrompt</code></a>: Formats the configuration for inclusion in LLM prompts.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the configuration file from the specified project path.</li>
<li>Ensures that missing or unreadable files do not cause critical failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Centralizes JSON parsing and validation for the configuration file.</li>
<li>Provides a fallback mechanism for invalid or missing configurations.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
    const functions = quest.files.flatMap((f: any) =&gt; f.highlights || []).map((h: any) =&gt; h.name).filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Optimizes the configuration format for LLM prompts, reducing redundant data.</li>
<li>Highlights quest-specific files and functions for targeted content generation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a> method to understand how quests and themes are integrated.</li>
<li>Explore the chunking logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> for handling large codebases.</li>
<li>Review the formatting logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L75" target="_blank" rel="noopener noreferrer"><code class="inline-code">formatAdventureConfigForPrompt</code></a> to see how configuration data is optimized.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a Custom Theme</strong>: Modify the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a> method to include a new theme. Define its keywords and test how it impacts quest generation.</li>
<li><strong>Trace Quest Execution</strong>: Add logging to <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a> to trace the flow of quest selection and execution. Observe how caching works for revisited quests.</li>
<li><strong>Optimize Config Parsing</strong>: Enhance the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L28" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseAdventureConfig</code></a> function to validate the structure of <code class="inline-code">adventure.config.json</code> and log warnings for missing fields.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codethia‚Äôs enchanted systems.</p>
<p>With the wisdom of the ancients and the valor of a true hero, you have unlocked the second sigil of the Quest Generation Codex, lighting the path to glory with a brilliance as steadfast as a celestial star! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>