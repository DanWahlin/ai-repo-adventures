<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Arcane MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Arcane MCP Tool Interface</h1>
<hr>
<p>In the mystical Kingdom of Code, the Enchanted Repository holds secrets that only the bravest adventurers dare to uncover. Among its treasures lies the Arcane MCP Tool Interface, a magical mechanism that channels the kingdom&#39;s tools into harmonious orchestration. As you approach the shimmering portal, runes of Zod and spells of JSON Schema swirl in the air, promising to reveal the secrets of dynamic tool execution. Prepare yourself to wield this magic and unlock the path to interactive storytelling.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are listed and validated using Zod schemas and JSON Schema transformations.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing tool execution errors and ensuring system stability.</li>
<li>‚ö° <strong>Pre-Generation Workflow</strong>: How background processes optimize system responsiveness for real-time interactions.</li>
<li>üí° <strong>Graceful Shutdown</strong>: How signal handling ensures clean resource management during server termination.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">RepoAdventureServer</code> in this file serves as the enchanted portal for the MCP Tool Interface, managing the registration and execution of tools. It uses Zod schemas for input validation and JSON Schema for compatibility with external systems. The server dynamically registers tools and executes them based on user requests while handling errors gracefully. This file showcases key architectural patterns such as dependency injection, error handling, and async workflows.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically, converting Zod schemas into JSON Schema for external compatibility.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server transport and pre-generates repository content to reduce latency during tool execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup and graceful shutdown, ensuring clean resource management and error logging.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools, ensuring compatibility with external systems via JSON Schema transformation.</li>
<li>Validates tool arguments using Zod schemas to prevent invalid or malicious inputs.</li>
<li>Implements defensive error handling, protecting the server from unexpected failures.</li>
<li>Demonstrates modularity by decoupling tool registration from execution logic.</li>
<li>Highlights extensibility, allowing new tools to be added without modifying core server functionality.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server transport, enabling communication between the MCP interface and external clients.</li>
<li>Pre-generates repository content in the background to optimize response times for interactive storytelling.</li>
<li>Demonstrates asynchronous workflows, ensuring non-blocking server initialization.</li>
<li>Uses dependency injection for transport configuration, enabling flexible integration with different systems.</li>
<li>Ensures scalability by warming up the cache for large codebases.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Orchestrates server startup, handling initialization and error logging.</li>
<li>Implements signal handling for graceful shutdown, ensuring clean resource management.</li>
<li>Logs unhandled promise rejections to maintain server stability during recoverable errors.</li>
<li>Demonstrates separation of concerns by delegating server logic to <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Provides robust error recovery, ensuring the server remains operational under non-critical failures.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file acts as the spellbook for the Arcane MCP Tool Interface, organizing the tools that enable interactive storytelling. Each tool is implemented as a separate file and re-exported for easy registration. The centralized <code class="inline-code">tools</code> object ensures consistency and simplifies dynamic registration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and presents theme options for storytelling.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Enables exploration of individual quests, allowing repeated invocations.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides a summary of completed and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool management, ensuring consistent registration and execution.</li>
<li>Demonstrates modular design by organizing tools into separate files for maintainability.</li>
<li>Enables dynamic tool registration, simplifying server setup and reducing boilerplate.</li>
<li>Facilitates extensibility, allowing new tools to be added without modifying core logic.</li>
<li>Provides a clear interface for MCP clients, enhancing usability and interoperability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">setupHandlers</code> uses Zod schemas to validate tool inputs and convert them into JSON Schema for external compatibility.</li>
<li>Observe the pre-generation workflow in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>, which optimizes responsiveness for interactive storytelling.</li>
<li>Explore the modular design of <code class="inline-code">tools.ts</code>, which simplifies tool registration and supports extensibility.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">generate_summary</code> that provides a high-level overview of the analyzed codebase. Register it in <code class="inline-code">tools.ts</code> and validate its inputs using Zod schemas.</p>
</li>
<li><p><strong>Trace Tool Execution Flow</strong>: Add console.log statements in <code class="inline-code">setupHandlers</code> to trace the flow of tool requests from registration to execution. Observe how arguments are validated and handlers are invoked.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for similar tool names when an unknown tool is requested. This improves developer experience and usability.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Enchanted Repository.</p>
<p>By the luminous glow of ancient stars, you have unlocked the first arcane seal of the MCP Tool Interface, a feat worthy of a rising hero‚Äîforge onward, for the realms await your brilliance! ‚ö°üíéüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>