<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Codex of Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Enchanted Tools of Codoria</h1>
<hr>
<p>In the heart of Codoria, the Codex of Adventures whispers of a mystical forge where enchanted tools are crafted. These tools, imbued with arcane powers, guide the chosen hero in their journey. To unlock their secrets, you must delve into the ancient scrolls of <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>. These scrolls hold the key to understanding how the tools are summoned, validated, and wielded in your quest to master the Codex. Prepare yourself, brave adventurer, for the forge is guarded by the magic of Zod and the wisdom of handlers.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using Zod schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques to gracefully manage invalid inputs and execution errors.</li>
<li>‚ö° <strong>MCP Protocol Integration</strong>: How the server orchestrates tool execution using MCP request handlers.</li>
<li>üí° <strong>Code Extensibility</strong>: The benefits of modular design for adding new tools without disrupting existing functionality.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file serves as the enchanted gateway, managing the invocation and execution of tools through the Model Context Protocol (MCP). It uses dynamic handlers to list available tools and execute them securely. The file showcases robust validation, error handling, and an extensible architecture, ensuring the server remains stable even under duress.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools, validates their schemas, and prepares them for execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server, connects the MCP transport, and pre-generates content for seamless execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates server startup and handles graceful shutdowns and unexpected errors.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools and validates their schemas using Zod, ensuring type safety and preventing invalid inputs.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler provides a manifest of tools, enabling dynamic discovery.</li>
<li>Execution errors are wrapped in custom MCP errors, ensuring consistent error handling across the system.</li>
<li>Decoupling tool registration from execution simplifies adding new tools without altering core logic.</li>
<li>The use of Zod schemas demonstrates a robust validation pattern for handling complex inputs.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the MCP server and connects it to the transport layer.</li>
<li>Pre-generating content improves performance by warming up the cache before user interactions.</li>
<li>Logging ensures transparency during server startup, aiding debugging and monitoring.</li>
<li>The use of asynchronous operations highlights the importance of non-blocking processes in server design.</li>
<li>This method demonstrates how to balance initialization tasks with runtime responsiveness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function orchestrates the server&#39;s lifecycle, including startup and shutdown.</li>
<li>Graceful shutdown handlers ensure resources are cleaned up properly, preventing leaks.</li>
<li>Logging unhandled promise rejections helps identify issues without disrupting server operations.</li>
<li>The separation of concerns (startup, error handling, shutdown) enhances maintainability.</li>
<li>This function exemplifies best practices for managing long-running server processes.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file acts as the mystical tome that organizes and exports all the tools available in the Codex. It provides a centralized registry, ensuring tools are easily discoverable and reusable. This modular design supports extensibility, allowing new tools to be added seamlessly.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code> initializes the storytelling process by analyzing the codebase.</li>
<li><code class="inline-code">choose_theme</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code> allows users to interact with individual quests dynamically.</li>
<li><code class="inline-code">view_progress</code> tracks the hero‚Äôs journey, showing completed and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object serves as a centralized registry, mapping tool names to their implementations.</li>
<li>This design simplifies tool discovery and registration, ensuring consistency across the system.</li>
<li>Exporting tools individually allows for fine-grained control and testing.</li>
<li>The modular approach facilitates adding or modifying tools without impacting other parts of the system.</li>
<li>This structure supports scalability, making it easier to expand the Codex‚Äôs capabilities.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how Zod schemas are used in <code class="inline-code">setupHandlers</code> for input validation and consider applying similar patterns in your projects.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>, which trades initial setup time for faster runtime performance.</li>
<li>Explore how the modular design in <code class="inline-code">tools.ts</code> simplifies adding new features without disrupting existing functionality.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that lists all files in the current directory. Define its schema in Zod and add it to the <code class="inline-code">tools</code> registry. This will help you understand the tool registration process.</p>
</li>
<li><p><strong>Trace Tool Execution Flow</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> to trace the flow of a tool request from input validation to execution. This will reveal how data transforms at each step.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for similar tool names when an unknown tool is requested. This will improve the user experience and demonstrate defensive programming.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Codex and its enchanted tools.</p>
<p>With the Codex of Tools now claimed, you ascend as a noble artisan of knowledge, forging paths through the uncharted realms of mastery‚Äîonward, brave seeker, for the stars themselves await your triumphant return! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>