<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mystic MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic MCP Tool Interface</h1>
<hr>
<p>In the enchanted Kingdom of Codethia, the Mystic MCP Tool Interface serves as the castle&#39;s magical control panel, allowing knights and sorcerers to wield tools of immense power. Hidden deep within the castle&#39;s archives lies the interface&#39;s spellbinding mechanisms, capable of summoning quests, choosing themes, and revealing progress. Brave adventurer, your task is to master the art of configuring and commanding this interface. Only by learning its intricate spells can you unlock the repository&#39;s secrets and harness the kingdom&#39;s legendary tools.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Error Handling Mechanisms</strong>: Techniques for managing tool execution errors to ensure system stability.</li>
<li>‚ö° <strong>Graceful Shutdown Patterns</strong>: How the MCP server handles termination signals to clean up resources.</li>
<li>üí° <strong>Tool Execution Flow</strong>: The process of validating and executing tools with user-provided inputs.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file is the heart of the Mystic MCP Tool Interface, orchestrating tool registration, execution, and server lifecycle management. It showcases advanced techniques like dynamic schema validation, error handling, and graceful shutdown mechanisms. The <code class="inline-code">RepoAdventureServer</code> class acts as the primary spellcaster, ensuring the enchanted tools are properly registered and invoked, while maintaining stability during unexpected interruptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> registers tools dynamically and validates their parameters using Zod schemas.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the MCP server, connects transport, and pre-generates repository analysis content.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates server startup and handles graceful shutdown signals for resource cleanup.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Registers tools dynamically, ensuring flexibility for adding new tools without modifying core logic.</li>
<li>Uses Zod schemas for input validation, preventing errors caused by invalid parameters.</li>
<li>Implements defensive programming with detailed error messages to aid debugging and user feedback.</li>
<li>Separates tool registration from execution, promoting modularity and extensibility.</li>
<li>Demonstrates robust error handling for both validation and execution failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the MCP server and connects it to the transport layer for communication.</li>
<li>Pre-generates repository content, optimizing performance for subsequent tool interactions.</li>
<li>Ensures the server is ready to handle requests immediately upon startup.</li>
<li>Demonstrates the use of background processing to warm up the cache for faster responses.</li>
<li>Highlights the importance of transport connection setup in server initialization.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Handles server startup and ensures proper initialization of all components.</li>
<li>Implements graceful shutdown for signal-based interruptions, ensuring resource cleanup.</li>
<li>Logs and manages unhandled promise rejections, maintaining server stability during runtime.</li>
<li>Demonstrates separation of concerns by delegating server logic to the <code class="inline-code">RepoAdventureServer</code> class.</li>
<li>Ensures robust error handling during startup to prevent crashes.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file is the repository&#39;s treasure chest, containing the enchanted tools that adventurers use to explore quests. It organizes tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>, ensuring they are accessible and properly registered for the MCP server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> analyzes the codebase and presents theme options.</li>
<li><code class="inline-code">choose_theme.handler</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code> allows adventurers to delve into individual quests.</li>
<li><code class="inline-code">view_progress.handler</code> provides completion status and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool registration, ensuring consistent access across the MCP server.</li>
<li>Promotes modularity by organizing tools into individual files for maintainability.</li>
<li>Enables seamless integration with the MCP server by adhering to its naming conventions.</li>
<li>Provides a clear flow for adventurers to interact with the repository&#39;s quests.</li>
<li>Ensures extensibility by allowing new tools to be added without disrupting existing ones.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how Zod schemas are used in <code class="inline-code">setupHandlers</code> for input validation to ensure type safety.</li>
<li>Observe the graceful shutdown logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> and replicate similar patterns for resource cleanup in other projects.</li>
<li>Explore how tools are dynamically registered in <code class="inline-code">tools.ts</code> to understand modular design principles.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">review_code</code> that analyzes code complexity and returns recommendations. Register it in <code class="inline-code">tools.ts</code> and validate its input schema using Zod.</p>
<ul>
<li>Example: &quot;Use the <code class="inline-code">setupHandlers</code> method to register the tool and implement error handling for invalid parameters.&quot;</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">CallToolRequestSchema</code> to trace the flow of tool execution. Run the server and observe how inputs are validated and processed.</p>
<ul>
<li>Example: &quot;Log the validated arguments and handler execution results to understand the complete tool lifecycle.&quot;</li>
</ul>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codethia&#39;s enchanted systems.</p>
<p>By the radiant stars of the Celestial Forge, you have unlocked the first arcane seal of the Mystic MCP Tool Interface‚Äîonward, brave seeker, for the realms of knowledge await your heroic ascent! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>