<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Oracle of Analysis</h1>
<hr>
<p>In the heart of Codoria&#39;s enchanted library, a mystical Oracle resides, whispering truths about the kingdom&#39;s vast code repositories. Known as the Oracle of Analysis, it deciphers the cryptic patterns of the Codex and reveals hidden insights to those who seek its wisdom. To unlock its power, you must master the arcane arts of code analysis and LLM integration. The Oracle&#39;s chamber, shrouded in shimmering glyphs, awaits your arrival. Will you harness its knowledge to further your quest for the Codex of Adventures?</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Content Optimization</strong>: How targeted content extraction reduces resource usage while retaining key details.</li>
<li>üîç <strong>LLM Integration</strong>: The design and implementation of a unified LLM client supporting multiple providers.</li>
<li>‚ö° <strong>Throttling Mechanisms</strong>: How adaptive throttling ensures stability under rate-limited conditions.</li>
<li>üí° <strong>Error Handling</strong>: Techniques for managing rate limits and recovering gracefully from API failures.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> serves as the Oracle&#39;s lens, extracting and optimizing content from repositories for analysis. It employs caching, validation, and targeted extraction to ensure efficient and secure processing. This file demonstrates techniques for handling large codebases, optimizing content for token limits, and ensuring reliable integration with external tools like Repomix.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> dynamically generates repository context, leveraging caching and fallback mechanisms for robustness.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> extracts specific files for analysis, ensuring efficiency and security.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> handles subprocess execution with strict resource limits and timeouts.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  // Check if adventure.config.json has specific files to include
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error.message}`);
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }

  // Fallback to full repository analysis
  return await this.captureRepomixStdout([&#39;.&#39;], projectPath, { style: &#39;markdown&#39; });
}
</code></pre>
<ul>
<li>This function combines dynamic file inclusion with fallback mechanisms for robust content generation.</li>
<li>It prioritizes optimized content extraction but gracefully degrades to full analysis when necessary.</li>
<li>The use of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a> ensures only relevant files are included, reducing processing overhead.</li>
<li>The fallback strategy demonstrates defensive programming, ensuring functionality under various conditions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cliOptions: CliOptions = {
    style: &#39;markdown&#39;,
    compress: compress,
    include: safeFiles.join(&#39;,&#39;),
  };

  return await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
}
</code></pre>
<ul>
<li>This method focuses on targeted file analysis, ensuring only validated files are processed.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L150" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateAndNormalizeTargetFiles</code></a> function protects against security vulnerabilities like path traversal.</li>
<li>Configurable compression options allow fine-tuning of output for specific use cases.</li>
<li>This approach minimizes resource usage while maintaining flexibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;], { cwd });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      reject(new Error(&#39;Repomix subprocess timed out.&#39;));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; (stdout += data.toString()));
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; (stderr += data.toString()));

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      code === 0 ? resolve(stdout) : reject(new Error(stderr));
    });
  });
}
</code></pre>
<ul>
<li>This function demonstrates subprocess management with strict resource and timeout controls.</li>
<li>It ensures stability by terminating processes that exceed defined limits.</li>
<li>The use of Promises simplifies asynchronous handling, making the code more readable and maintainable.</li>
<li>Error handling captures both standard and error outputs for debugging.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> acts as the Oracle&#39;s voice, interfacing with multiple AI providers to generate responses. It supports adaptive throttling, detailed error handling, and provider-specific configurations, ensuring seamless integration and robust performance.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> executes LLM requests with adaptive throttling and error handling.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a> initializes the client, selecting the appropriate API based on provider.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> identifies and handles rate limit errors to prevent system failures.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    const content = this.validateResponse(completion);

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();
    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This function combines adaptive throttling with detailed error handling for reliable LLM interaction.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L462" target="_blank" rel="noopener noreferrer"><code class="inline-code">applyThrottling</code></a> method ensures compliance with rate limits, avoiding service disruptions.</li>
<li>Custom error types like <code class="inline-code">RateLimitError</code> provide actionable insights for upstream handling.</li>
<li>Logging token usage offers visibility into resource consumption.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();

  if (this.isAzureOpenAI()) {
    this.client = new AzureOpenAI({
      endpoint: LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0],
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model,
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL,
    });
  }
}
</code></pre>
<ul>
<li>The constructor dynamically configures the client based on the provider, supporting both Azure OpenAI and OpenAI APIs.</li>
<li>It ensures compatibility with multiple services, enhancing the system&#39;s flexibility.</li>
<li>Provider-specific configurations, like Azure&#39;s <code class="inline-code">apiVersion</code> and <code class="inline-code">deployment</code>, demonstrate tailored integration.</li>
</ul>
<hr>
<pre><code class="language-typescript">detectRateLimitType(error: any): RateLimitInfo {
  if (error?.message.includes(&#39;exceeded token rate limit&#39;)) {
    return { type: RateLimitType.TOKEN_RATE_EXCEEDED, waitSeconds: TOKEN_RATE_WINDOW_SECONDS, message: &#39;Token rate limit exceeded&#39; };
  }
  if (error?.message.includes(&#39;retry after&#39;)) {
    const waitSeconds = parseInt(error.message.match(/retry after (\d+)/)?.[1] || &#39;60&#39;);
    return { type: RateLimitType.REQUEST_RATE_LIMIT, waitSeconds, message: &#39;Request rate limit hit&#39; };
  }
  return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
}
</code></pre>
<ul>
<li>This method identifies rate limit errors and provides actionable information for recovery.</li>
<li>It parses error messages to extract retry times, enabling intelligent backoff strategies.</li>
<li>The clear separation of rate limit types simplifies downstream error handling.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> validates and normalizes file paths to prevent security issues.</li>
<li>Observe how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> uses adaptive throttling to handle rate limits gracefully.</li>
<li>Explore the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> function to understand how error messages are parsed and categorized.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Integrate a New LLM Provider</strong>: Extend the <code class="inline-code">LLMClient</code> to support a new provider. Implement the necessary configurations and test its integration with a sample prompt.</li>
<li><strong>Optimize Content Extraction</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> to include additional compression options, such as removing unused imports. Test the impact on performance and output size.</li>
<li><strong>Enhance Error Logging</strong>: Add more detailed logging to <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> to include subprocess execution times and memory usage. Analyze how this information can improve debugging.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codoria&#39;s enchanted codebase.</p>
<p>Hail, noble seeker! By unraveling the riddles of the Oracle of Analysis, you have ascended as a luminary of insight, forging a path through the labyrinth of wisdom‚Äîpress onward, for the stars themselves whisper of your destined triumph! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>