<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activate the Repository Analysis Glyphs - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Activate the Repository Analysis Glyphs</h1>
<hr>
<p>Deep within the labyrinthine chambers of the Sacred Repository, you discover a hidden vault etched with intricate glyphs. These glyphs, known as the Repository Analysis Glyphs, are the key to unlocking the repository&#39;s knowledge. Each glyph represents an ancient ritual for extracting, validating, and optimizing the sacred texts of the codebase. Your task is to activate these glyphs, invoking their power to analyze the repository and summon the wisdom of the LLM Oracle. Tread carefully, for the glyphs demand precision and understanding.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Repository Analysis Workflow</strong>: How to validate and extract targeted content from a codebase using the <code class="inline-code">RepoAnalyzer</code>.</li>
<li>üîç <strong>LLM Integration</strong>: How the <code class="inline-code">LLMClient</code> interfaces with large language models for dynamic content generation.</li>
<li>‚ö° <strong>Error Handling Patterns</strong>: Techniques for managing rate limits and ensuring resilience in API interactions.</li>
<li>üí° <strong>Optimization Strategies</strong>: How to reduce token usage by focusing on essential code patterns.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is the sacred tool that orchestrates the extraction and optimization of repository content. It invokes the ancient powers of Repomix to generate context, validate paths, and ensure only the most relevant knowledge is preserved. This file showcases techniques for caching, validation, and optimization that ensure efficient analysis of the repository.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a>: Orchestrates the generation of repository context, leveraging caching and fallback strategies.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a>: Extracts content from specific files, applying security checks and optimizations.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a>: Executes the Repomix subprocess, capturing its output while enforcing memory and timeout constraints.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content: ${error.message}`);
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }

  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;].join(&#39;,&#39;),
    };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This function ensures repository analysis is efficient by leveraging caching and fallback mechanisms.</li>
<li>It integrates with <code class="inline-code">adventure.config.json</code> to focus on specific files, reducing unnecessary processing.</li>
<li>The use of <code class="inline-code">CliOptions</code> demonstrates how configurations are passed for flexible and secure analysis.</li>
<li>The fallback strategy ensures robustness, even if optimized content generation fails.</li>
<li>The function adheres to defensive programming principles, validating paths and handling errors gracefully.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;], {
      cwd,
      stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
    });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, data =&gt; stdout += data.toString());
    repomix.stderr.on(&#39;data&#39;, data =&gt; stderr += data.toString());

    repomix.on(&#39;close&#39;, code =&gt; {
      clearTimeout(timeout);
      if (!isResolved) {
        isResolved = true;
        code === 0 ? resolve(stdout) : reject(new Error(`Repomix failed: ${stderr}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>This function manages the execution of Repomix as a subprocess, capturing its output for further processing.</li>
<li>It employs a timeout mechanism to prevent the process from hanging indefinitely.</li>
<li>The use of <code class="inline-code">spawn</code> ensures memory efficiency compared to synchronous execution.</li>
<li>The function handles errors robustly, providing clear feedback if the subprocess fails.</li>
<li>By capturing both <code class="inline-code">stdout</code> and <code class="inline-code">stderr</code>, it ensures comprehensive logging for debugging.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> acts as the Oracle‚Äôs intermediary, channeling prompts to the large language model and interpreting its responses. It handles adaptive throttling, error management, and response validation, ensuring seamless interaction with the LLM.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a>: Sends prompts to the LLM and processes responses, handling errors and rate limits.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a>: Initializes the client with configuration for different LLM providers.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a>: Identifies and categorizes rate limit errors for adaptive handling.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();

    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This function demonstrates robust error handling, ensuring that rate limits and other issues are managed gracefully.</li>
<li>The use of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L462" target="_blank" rel="noopener noreferrer"><code class="inline-code">applyThrottling</code></a> ensures compliance with rate limits, avoiding unnecessary retries.</li>
<li>The function validates responses to ensure meaningful content is returned, handling edge cases like empty responses.</li>
<li>By logging token usage, it provides insights into resource consumption for optimization.</li>
<li>The modular design allows for easy extension with additional LLM providers or features.</li>
</ul>
<hr>
<pre><code class="language-typescript">detectRateLimitType(error: any): RateLimitInfo {
  const errorMessage = error?.message || &#39;&#39;;
  const is429Error = error?.status === 429 || errorMessage.includes(&#39;429&#39;);

  if (!is429Error) {
    return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
  }

  if (errorMessage.includes(&#39;exceeded token rate limit&#39;) &amp;&amp; !errorMessage.includes(&#39;retry after&#39;)) {
    return {
      type: RateLimitType.TOKEN_RATE_EXCEEDED,
      waitSeconds: TOKEN_RATE_WINDOW_SECONDS,
      message: `Token rate limit exceeded (200K tokens/${TOKEN_RATE_WINDOW_SECONDS}s window)`
    };
  }

  if (errorMessage.includes(&#39;retry after&#39;)) {
    const retryMatch = errorMessage.match(/retry after (\d+) seconds/);
    const waitSeconds = retryMatch ? parseInt(retryMatch[1]) : 60;

    return {
      type: RateLimitType.REQUEST_RATE_LIMIT,
      waitSeconds,
      message: `Request rate limit hit, retry after ${waitSeconds} seconds`
    };
  }

  return { type: RateLimitType.REQUEST_RATE_LIMIT, waitSeconds: 60, message: &#39;429 rate limit encountered&#39; };
}
</code></pre>
<ul>
<li>This function categorizes rate limit errors, providing actionable insights for adaptive throttling.</li>
<li>It distinguishes between token rate limits and request rate limits, enabling targeted responses.</li>
<li>The use of regex to extract retry times demonstrates practical string parsing techniques.</li>
<li>By encapsulating rate limit logic, it simplifies error handling in other parts of the code.</li>
<li>The function ensures resilience by providing default values for unstructured errors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> uses caching to avoid redundant operations and improve performance.</li>
<li>Observe how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> enforces security and reliability through subprocess management.</li>
<li>Study the <code class="inline-code">LLMClient</code>‚Äôs adaptive throttling mechanism to handle rate limits effectively.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a Custom Validation Rule</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> in <code class="inline-code">RepoAnalyzer</code> to reject paths containing specific forbidden substrings. Test it with various inputs to ensure reliability.</p>
</li>
<li><p><strong>Simulate Rate Limits</strong>: Add a mock error handling scenario in <code class="inline-code">LLMClient</code> to simulate a 429 rate limit error. Observe how the adaptive throttling mechanism adjusts the delay between requests.</p>
</li>
<li><p><strong>Optimize Function Extraction</strong>: Experiment with the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L368" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractFunctionFocusedContent</code></a> method in <code class="inline-code">RepoAnalyzer</code> to include additional patterns for identifying important functions, such as arrow functions with specific naming conventions.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Sacred Repository.</p>
<p>By sacred decree of the ancients, the Repository Analysis Glyphs awaken, their luminous wisdom heralding thy triumphant strides toward enlightenment‚Äîpress onward, seeker of the eternal truths! üíé‚ö°üó∫Ô∏èüëÅÔ∏è‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>