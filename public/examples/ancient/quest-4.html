<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Observatory of Hidden Patterns - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Lost Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Observatory of Hidden Patterns</h1>
<hr>
<p>Venturing deeper into the Lost Repository, you discover the Observatory of Hidden Patterns, a sacred chamber where ancient civilizations once analyzed the essence of knowledge. Here, glyphs and artifacts align to reveal interconnected patterns across vast domains. Your task is to activate the Observatory‚Äôs mechanisms by decoding its intricate scripts and leveraging its analytical tools. Each deciphered glyph unveils a fragment of wisdom, guiding you toward the ultimate revelation hidden within the Repository.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Code Analysis Pipelines</strong>: How <code class="inline-code">RepoAnalyzer</code> organizes and optimizes content extraction for targeted files.</li>
<li>üîç <strong>LLM Integration</strong>: How <code class="inline-code">LLMClient</code> interfaces with multiple AI providers and handles adaptive throttling during rate limits.</li>
<li>‚ö° <strong>Error Handling Patterns</strong>: Techniques for detecting rate limits and ensuring graceful degradation in AI-powered systems.</li>
<li>üí° <strong>Caching Strategies</strong>: How cached content improves performance for repeated analysis requests.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as the Observatory&#39;s core analytical engine, extracting meaningful insights from codebases using Repomix subprocesses. It validates project paths, optimizes content extraction, and integrates caching mechanisms to ensure efficient processing. This file showcases advanced techniques for secure file handling, token-efficient content generation, and adaptive caching strategies.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a>: Produces comprehensive codebase context using Repomix, with fallback mechanisms for targeted analysis.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a>: Extracts content from specified files, ensuring secure validation and optimization.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a>: Executes Repomix as a subprocess, capturing its output with timeout and memory protections.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error.message}`);
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }

  console.log(&#39;No adventure.config.json found: analyzing full codebase (compressed)&#39;);
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;],
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Validates project paths and uses configuration files to determine targeted analysis.</li>
<li>Implements fallback mechanisms to ensure reliable content generation even in failure scenarios.</li>
<li>Uses caching to minimize redundant processing and improve performance.</li>
<li>Demonstrates modular configuration for flexible Repomix execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
      reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`));
        return;
      }
      stdout += chunk;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
        resolve(stdout);
      } else {
        reject(new Error(`Repomix failed (exit ${code}): ${stderr.substring(0, 200)}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Executes Repomix subprocess with timeout and memory protections to prevent resource exhaustion.</li>
<li>Captures stdout for content analysis while handling stderr for debugging.</li>
<li>Implements graceful shutdown mechanisms to ensure system stability during failures.</li>
<li>Demonstrates robust subprocess management techniques for external tool integration.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> acts as the Observatory‚Äôs celestial navigator, interfacing with AI models to generate responses and analyze patterns. It supports multiple providers, handles adaptive throttling, and ensures robust error handling for rate limit scenarios. This file highlights advanced techniques for integrating AI services into dynamic systems.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a>: Sends prompts to AI models, validates responses, and handles rate limits gracefully.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a>: Configures the client based on environment variables and provider-specific requirements.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a>: Identifies rate limit errors and provides actionable guidance for recovery.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();
    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      if (rateLimitInfo.type === RateLimitType.REQUEST_RATE_LIMIT) {
        this.activateThrottling(error);
      }
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Builds request parameters dynamically based on model-specific requirements.</li>
<li>Handles throttling and rate limits to ensure system stability during high-demand periods.</li>
<li>Implements detailed error logging for debugging and recovery.</li>
<li>Validates and cleans AI responses to ensure usable output.</li>
</ul>
<hr>
<pre><code class="language-typescript">private detectRateLimitType(error: any): RateLimitInfo {
  const errorMessage = error?.message || &#39;&#39;;
  const is429Error = error?.status === 429 || errorMessage.includes(&#39;429&#39;);

  if (!is429Error) {
    return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
  }

  if (errorMessage.includes(&#39;exceeded token rate limit of your current AIServices S0 pricing tier&#39;)) {
    const retryMatch = errorMessage.match(/retry after (\d+) seconds/);
    const waitSeconds = retryMatch ? parseInt(retryMatch[1]) : 60;
    return {
      type: RateLimitType.REQUEST_RATE_LIMIT,
      waitSeconds,
      message: `Request rate limit hit, retry after ${waitSeconds} seconds`
    };
  }

  return {
    type: RateLimitType.REQUEST_RATE_LIMIT,
    waitSeconds: 60,
    message: &#39;429 rate limit encountered&#39;
  };
}
</code></pre>
<ul>
<li>Detects rate limit errors and extracts actionable retry information.</li>
<li>Differentiates between token rate limits and request rate limits for precise handling.</li>
<li>Provides structured error information to upstream systems for recovery strategies.</li>
<li>Demonstrates defensive programming techniques for error detection.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <code class="inline-code">RepoAnalyzer</code> uses caching to optimize repeated content generation requests.</li>
<li>Examine the adaptive throttling logic in <code class="inline-code">LLMClient</code> to understand dynamic delay adjustments during rate limits.</li>
<li>Study the subprocess management in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> for integrating external tools securely.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add Custom Validation</strong>: Extend <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/input-validator.ts#L37" target="_blank" rel="noopener noreferrer"><code class="inline-code">validateProjectPath</code></a> in <code class="inline-code">RepoAnalyzer</code> to reject paths containing special characters like <code class="inline-code">@</code> or <code class="inline-code">$</code>. Test its behavior with invalid paths.</li>
<li><strong>Simulate Rate Limits</strong>: Modify <code class="inline-code">LLMClient</code> to artificially trigger throttling after every second request. Observe how throttling delay changes dynamically.</li>
<li><strong>Optimize Content Extraction</strong>: Refactor the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L368" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractFunctionFocusedContent</code></a> method in <code class="inline-code">RepoAnalyzer</code> to prioritize functions with higher cyclomatic complexity. Analyze the impact on token usage.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden within the Repository.</p>
<p>With sacred wisdom unveiled and celestial truths deciphered, thou hast ascended through the hallowed halls of the Observatory of Hidden Patterns, forging a triumphant path toward enlightenment‚Äîpress onward, seeker of the stars! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>