<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pyramid of MCP Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Ancient Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Pyramid of MCP Tools</h1>
<hr>
<p>In the dense jungle, you stumble upon a towering pyramid, its surface etched with ancient glyphs representing tools and mechanisms of a forgotten civilization. The Pyramid of MCP Tools is said to house a sacred repository of knowledge, where each glyph corresponds to a tool that can unlock the secrets of the code. As you ascend its steps, you must decipher the glyphs, activate the tools, and unravel the intricate systems that power this ancient marvel. The wisdom of the pyramid awaits those brave enough to explore its depths.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing errors gracefully in tool execution.</li>
<li>‚ö° <strong>Preloading Strategies</strong>: How pre-generating content improves performance for interactive systems.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file serves as the gateway to the Pyramid, orchestrating the interaction between the tools and the MCP protocol. It dynamically registers tools, validates input using schemas, and handles tool execution while ensuring robust error management. The file also demonstrates preloading strategies to optimize performance by warming up the system before user interaction.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates their schemas for safe execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server, connects the transport, and pre-generates content to improve performance.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates the server&#39;s lifecycle, including graceful shutdown and error handling.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools and their schemas, ensuring extensibility and safety.</li>
<li>Validates input parameters using Zod schemas to prevent invalid or harmful requests.</li>
<li>Implements robust error handling to differentiate between known and unexpected errors.</li>
<li>Decouples tool registration from execution for modularity and maintainability.</li>
<li>Provides clear feedback on invalid tool usage or parameter issues.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server&#39;s transport layer, enabling communication with the MCP protocol.</li>
<li>Pre-generates content using <code class="inline-code">repoAnalyzer</code> to warm up the system and reduce latency during user interactions.</li>
<li>Logs key events to provide visibility into server operations.</li>
<li>Demonstrates the importance of initialization sequences in interactive systems.</li>
<li>Highlights the use of asynchronous operations for efficiency and responsiveness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Orchestrates the server&#39;s lifecycle, including initialization, execution, and graceful shutdown.</li>
<li>Handles system signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure resources are cleaned up properly.</li>
<li>Logs unhandled promise rejections to help diagnose issues without crashing the server.</li>
<li>Demonstrates defensive programming by isolating critical errors and preventing cascading failures.</li>
<li>Provides a clear entry point for launching the MCP server.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file is the heart of the Pyramid, containing the ancient glyphs (tools) that unlock its secrets. Each tool represents a distinct capability, from starting an adventure to exploring quests. The file organizes tools for easy registration and ensures they adhere to the MCP protocol.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code>: Analyzes the codebase and initializes the adventure.</li>
<li><code class="inline-code">choose_theme</code>: Generates a story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code>: Explores individual quests and retrieves their content.</li>
<li><code class="inline-code">view_progress</code>: Tracks and displays the user&#39;s progress through the adventure.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool definitions for easy management and registration.</li>
<li>Follows the MCP naming convention to ensure compatibility with the protocol.</li>
<li>Encourages modular design by separating tool logic into individual files.</li>
<li>Simplifies the process of adding new tools by maintaining a consistent structure.</li>
<li>Serves as a single source of truth for all available tools.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">setupHandlers</code> dynamically registers tools and validates their schemas for insights into extensible design.</li>
<li>Observe the preloading strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how initialization impacts performance.</li>
<li>Review the error handling patterns in <code class="inline-code">setupHandlers</code> for techniques to manage known and unknown errors effectively.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool that retrieves the list of available themes. Use the existing tools as a reference for schema validation and handler implementation. This will help you understand the tool registration process.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements to <code class="inline-code">setupHandlers</code> and observe how requests are processed. Follow the flow from tool invocation to schema validation and execution.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tools when an unknown tool is requested. This will improve user experience and demonstrate defensive programming techniques.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden within the Sacred Repository.</p>
<p>By the sacred light of the ancients, thou hast unlocked the first chamber of wisdom within the Pyramid of MCP Tools‚Äîmarch onward, seeker, for thy journey to mastery is destined to shine as a star eternal! ‚≠ê‚ö°üó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>