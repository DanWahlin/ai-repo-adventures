<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hall of Protocol Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Knowledge</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Hall of Protocol Tools</h1>
<hr>
<p>Venturing further into the sacred repository, you arrive at the Hall of Protocol Tools. Here, the ancient codemasters inscribed their rituals for invoking mighty constructs and managing intricate workflows. The air hums with the energy of precision, as each tool, carved in the language of TypeScript, waits to be rediscovered. You must decode the mechanisms these tools employ, unveiling the ancient logic that transforms static repositories into living adventures. Proceed carefully, for each artifact contains the wisdom of the ancients.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated for execution using schemas.</li>
<li>üîç <strong>Error Handling Strategies</strong>: How the system defends against invalid inputs and execution failures with robust error handling.</li>
<li>‚ö° <strong>Pre-Generation Optimization</strong>: The benefits of warming up caches for smoother runtime operations.</li>
<li>üí° <strong>Graceful Shutdowns</strong>: How systems ensure stability during termination and resource cleanup.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file acts as the ceremonial nexus where ancient tool rituals are registered and executed. It initializes the <code class="inline-code">RepoAdventureServer</code>, dynamically lists tools, validates inputs, and ensures smooth communication through the Model Context Protocol (MCP). Moreover, it pre-generates content to optimize performance and handles system shutdown with care to preserve the integrity of the repository.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers handlers for listing and executing tools, ensuring proper validation and error handling.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Activates the server, establishes transport, and pre-generates content for optimized performance.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup, signal handling, and error management for robust operation.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Registers handlers for dynamic tool discovery and execution, ensuring the system adapts to available tools.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to transform Zod schemas into JSON-compatible formats for validation.</li>
<li>Implements robust error handling with <code class="inline-code">McpError</code> to safeguard against invalid inputs and execution failures.</li>
<li>Separates concerns between tool listing and execution, maintaining a clean and modular design.</li>
<li>Enables extensibility by allowing new tools to be added without modifying core logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes MCP communication via the <code class="inline-code">StdioServerTransport</code> for seamless tool interaction.</li>
<li>Logs server activity for operational transparency and debugging.</li>
<li>Pre-generates repository content using <code class="inline-code">repoAnalyzer.preGenerate</code> to reduce latency during user interactions.</li>
<li>The pre-generation approach improves performance by warming up caches and avoiding on-demand delays.</li>
<li>Simplifies runtime operations by preparing key resources in advance.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">RepoAdventureServer</code> and sets up signal handlers for graceful shutdown.</li>
<li>Logs unhandled promise rejections to ensure visibility into unexpected runtime issues.</li>
<li>Separates server startup logic into a dedicated function for improved maintainability.</li>
<li>Demonstrates defensive programming by capturing fatal errors and exiting gracefully.</li>
<li>Ensures system consistency and resource cleanup during shutdown.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file serves as the repository&#39;s artifact catalog, defining the tools that power the gamified exploration experience. Each tool represents a distinct capability, from starting adventures to tracking progress, and is carefully structured for modularity and reuse.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code>: Analyzes the codebase and prepares initial themes and quests.</li>
<li><code class="inline-code">choose_theme</code>: Allows users to select a narrative style for their exploration.</li>
<li><code class="inline-code">explore_quest</code>: Executes a specific quest, advancing exploration.</li>
<li><code class="inline-code">view_progress</code>: Summarizes exploration status and remaining challenges.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports all tools in a single object for centralized registration and management.</li>
<li>Encapsulates functionality, making it easy to add or modify tools without altering core logic.</li>
<li>Promotes readability and maintainability through clear naming conventions.</li>
<li>Aligns with the MCP protocol by exposing tools in a predictable and consistent format.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how <code class="inline-code">zodToJsonSchema</code> bridges Zod schemas with JSON Schema, enabling type safety across tool boundaries.</li>
<li>Study the error handling patterns in <code class="inline-code">setupHandlers</code> to learn defensive coding techniques that protect against invalid inputs.</li>
<li>Observe how pre-generation in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> leverages caching for smoother runtime performance.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_artifacts</code> that returns a summary of all files in the repository. Register it in <code class="inline-code">tools.ts</code> and test its integration with the MCP server.</p>
</li>
<li><p><strong>Trace Error Handling</strong>: Intentionally pass invalid parameters to a tool and observe how <code class="inline-code">McpError</code> is thrown and handled. Modify the error messages to include suggestions for valid inputs.</p>
</li>
<li><p><strong>Optimize Pre-Generation</strong>: Experiment with modifying <code class="inline-code">repoAnalyzer.preGenerate</code> to only pre-cache specific file types (e.g., <code class="inline-code">.ts</code> or <code class="inline-code">.js</code>). Measure the impact on performance and adjust the caching strategy.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden within the repository&#39;s ancient depths.</p>
<p>By the sacred flame of enlightenment, thou hast unlocked the first chamber of The Hall of Protocol Tools‚Äîlet this triumph be a beacon as thou ascendeth toward the apex of ancient mastery! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>