<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traverse the Ritual Paths of MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Traverse the Ritual Paths of MCP Interface</h1>
<hr>
<p>Deep within the Sacred Repository lies the Ritual Paths of the MCP Interface, where ancient glyphs guide the flow of knowledge through the repository‚Äôs core. These paths represent the sacred tools and ceremonies that enable explorers to interact with the repository‚Äôs wisdom. To restore the repository‚Äôs power, you must decode these glyphs and activate the rituals, ensuring the interface remains a stable bridge between the ancient repository and the adventurer. Beware‚Äîmissteps in these rituals can disrupt the balance of the repository‚Äôs flows.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas in the MCP interface.</li>
<li>üîç <strong>Error Handling Patterns</strong>: How structured error handling ensures stability during tool execution.</li>
<li>‚ö° <strong>Graceful Shutdown</strong>: How the server manages cleanup and ensures resilience during termination.</li>
<li>üí° <strong>Pre-Generation Optimization</strong>: How pre-generating content improves performance by reducing runtime delays.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file serves as the ceremonial chamber where the MCP server orchestrates the interaction between adventurers and the repository. It defines the rituals for tool registration, execution, and server lifecycle management. The <code class="inline-code">RepoAdventureServer</code> class is the central figure, managing handlers for listing tools, executing tools, and ensuring graceful shutdown through robust error handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools and validates their schemas to ensure safe usage.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server, connects the transport layer, and pre-generates repository content for efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates server initialization and handles graceful shutdown during interruptions.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>The <code class="inline-code">setupHandlers</code> method registers handlers for listing tools and executing them dynamically.</li>
<li><code class="inline-code">ListToolsRequestSchema</code> ensures that the tools are presented with their descriptions and input schemas.</li>
<li>The <code class="inline-code">CallToolRequestSchema</code> validates input parameters using Zod schemas, ensuring type safety.</li>
<li>Error handling protects against invalid tool invocations, ensuring stability of the MCP interface.</li>
<li>This modular approach allows the addition of new tools without modifying the core logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server and connects it to the <code class="inline-code">StdioServerTransport</code> layer.</li>
<li>Pre-generating repository content reduces runtime delays, improving user experience.</li>
<li>The <code class="inline-code">repoAnalyzer.preGenerate</code> method warms up the cache, ensuring faster responses during exploration.</li>
<li>This design prioritizes performance by handling computationally expensive tasks upfront.</li>
<li>The use of asynchronous operations ensures non-blocking execution, maintaining server responsiveness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function initializes the server and ensures that it handles termination signals gracefully.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L98" target="_blank" rel="noopener noreferrer"><code class="inline-code">gracefulShutdown</code></a> function cleans up resources, ensuring no lingering processes or memory leaks.</li>
<li>Handling unhandled promise rejections prevents unexpected crashes, improving system resilience.</li>
<li>The separation of concerns (initialization, signal handling, and error logging) enhances maintainability.</li>
<li>This robust design ensures the server remains operational even in adverse conditions.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file is the repository‚Äôs ritual scroll, detailing the tools available for adventurers. Each tool corresponds to a specific function, such as starting an adventure or checking progress. The tools are organized and exported for easy registration, ensuring seamless integration with the MCP server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code> initializes the repository exploration process by analyzing the codebase.</li>
<li><code class="inline-code">choose_theme</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code> allows adventurers to explore individual quests interactively.</li>
<li><code class="inline-code">view_progress</code> provides insights into the completion status and remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object organizes all available tools, making them accessible to the MCP server.</li>
<li>Each tool is designed for a specific step in the repository exploration process.</li>
<li>This modular design simplifies adding or modifying tools without disrupting existing functionality.</li>
<li>The clear structure improves readability and maintainability of the codebase.</li>
<li>Exporting tools in a centralized manner ensures consistency across the MCP interface.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">zodToJsonSchema</code> converts Zod schemas into JSON schemas for tool validation.</li>
<li>Observe how pre-generating content in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> improves performance for large repositories.</li>
<li>Explore the graceful shutdown logic to understand how resources are cleaned up during termination.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a Custom Tool</strong>: Create a new tool that lists all files in the repository. Use Zod schemas to validate input parameters (e.g., file extensions to filter).</p>
<ul>
<li>Register the tool in <code class="inline-code">tools.ts</code> and test it by invoking the MCP interface.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging to the <code class="inline-code">setupHandlers</code> method to trace the flow of tool execution. Observe how requests are processed and validated.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tools when an unknown tool is requested.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Sacred Repository.</p>
<p>By the sacred decree of the ancients, thou hast triumphed upon the hallowed paths of the MCP Interface, unlocking the first of five celestial wisdoms‚Äîlet thy spirit ascend with the light of the eternal stars! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>