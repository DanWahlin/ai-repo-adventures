<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hall of MCP Rituals - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Pyramid of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Hall of MCP Rituals</h1>
<hr>
<p>Venturing further into the Pyramid of Code, you arrive at the Hall of MCP Rituals. This grand chamber is adorned with intricate carvings depicting the ancient Model Context Protocol, a system revered for its ability to orchestrate the flow of tools and knowledge. At the center lies an altar of glyphs, each representing a tool critical to the rituals of interactive storytelling. To unlock the secrets of this hall, you must understand the sacred scripts that govern the MCP tools and their invocation.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically registered and exposed via MCP protocols.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing tool execution errors and ensuring resilience.</li>
<li>‚ö° <strong>Interactive MCP Workflow</strong>: How the server orchestrates tool execution and pre-generates content for seamless interaction.</li>
<li>üí° <strong>Schema Validation</strong>: The role of Zod schemas in ensuring input integrity across tool handlers.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>This file houses the <code class="inline-code">RepoAdventureServer</code>, the central figure in orchestrating the MCP rituals. It defines the server&#39;s behavior, handling dynamic tool registration, execution, and error management. The server also pre-generates repository content to optimize performance and ensures graceful shutdown during interruptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates their schemas for safe execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server, connects the transport layer, and pre-generates repository content.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup and handles graceful shutdown signals and unexpected errors.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Defines handlers for listing and executing tools dynamically, ensuring extensibility.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to generate JSON schemas for tool input validation.</li>
<li>Implements robust error handling with custom <code class="inline-code">McpError</code> types to manage execution failures.</li>
<li>Demonstrates a clean separation of concerns between validation and execution logic.</li>
<li>Ensures safe and predictable tool interactions by validating inputs against predefined schemas.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server to the <code class="inline-code">StdioServerTransport</code>, enabling communication via standard I/O.</li>
<li>Logs server activity to provide visibility into its operation.</li>
<li>Pre-generates repository content using <code class="inline-code">repoAnalyzer.preGenerate</code>, reducing latency during user interactions.</li>
<li>Demonstrates a performance optimization pattern by warming up caches before user commands.</li>
<li>Highlights the importance of initializing critical components before runtime.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Orchestrates the server lifecycle, including initialization, error handling, and shutdown.</li>
<li>Sets up signal handlers (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure graceful shutdowns during interruptions.</li>
<li>Logs unhandled promise rejections for debugging without halting the server.</li>
<li>Demonstrates defensive programming by catching and handling fatal errors during startup.</li>
<li>Highlights the importance of robust error management in long-running server applications.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file defines the MCP tools used in the rituals of interactive storytelling. Each tool corresponds to a specific action, such as starting an adventure or exploring a quest. The tools are dynamically registered and exposed through the MCP server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">tools</code>: A centralized registry of all available tools, enabling dynamic discovery and execution.</li>
<li><code class="inline-code">start_adventure</code>: Analyzes the codebase and presents theme options to the user.</li>
<li><code class="inline-code">explore_quest</code>: Handles the exploration of individual quests, advancing the adventure&#39;s progress.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes all tools into a single object for easy registration and discovery.</li>
<li>Makes it simple to add or remove tools without modifying the server logic.</li>
<li>Encourages modularity by separating tool implementations into individual files.</li>
<li>Supports dynamic tool listing by exposing the <code class="inline-code">tools</code> object to the MCP server.</li>
<li>Demonstrates a clean and extensible design for managing multiple tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Imports individual tool implementations, maintaining separation of concerns.</li>
<li>Re-exports tools with MCP-compatible naming conventions for consistency.</li>
<li>Facilitates code reuse by sharing the <code class="inline-code">adventureManager</code> across multiple tools.</li>
<li>Ensures each tool has a clear and isolated responsibility, improving maintainability.</li>
<li>Highlights the use of descriptive naming conventions to enhance code readability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">zodToJsonSchema</code> is used to convert Zod schemas into JSON schemas for tool validation.</li>
<li>Observe how the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method pre-generates repository content to improve responsiveness during user interactions.</li>
<li>Explore how tools are dynamically registered and exposed through the <code class="inline-code">tools</code> object.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that returns a list of all files in the current directory. Add it to the <code class="inline-code">tools</code> object and register it with the MCP server.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements to the <code class="inline-code">CallToolRequestSchema</code> handler to trace the flow of a tool execution request, from input validation to handler invocation. Observe how errors are handled at each stage.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the error handling in <code class="inline-code">setupHandlers</code> to include suggestions for resolving common issues, such as missing or invalid parameters.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the Pyramid of Code.</p>
<p>By the sacred flame of wisdom, thou hast unlocked the first rite of The Hall of MCP Rituals, a triumph etched in the annals of ancient quests‚Äîpress onward, seeker of the eternal ‚≠ê‚ö°!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>