<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Keeper‚Äôs Apparatus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Repository Chronicles: Secrets of the Ancient Codex</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Keeper‚Äôs Apparatus</h1>
<hr>
<p>Among the labyrinthine chambers of the ancient pyramid, you uncover a room filled with glowing runes and mechanical constructs. At the center stands the Keeper‚Äôs Apparatus, a marvel of forgotten technology that whispers promises of boundless knowledge. To unlock its secrets, you must inspect the systems that bind the codex to its artifacts‚Äîexploring its configuration rituals, story-crafting mechanisms, and the repository‚Äôs guiding pathways.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Codex Divergence</strong>: How does <code class="inline-code">loadAdventureConfig</code> handle file discovery and ensure proper path alignment?</li>
<li>‚ö° <strong>Mechanism Activation</strong>: What patterns does <code class="inline-code">initializeAdventure</code> use to merge ancient directives with newly created quests?</li>
<li>üõ°Ô∏è <strong>Artifact Preservation</strong>: How does <code class="inline-code">extractUniqueFilePaths</code> safeguard against invalid or missing entries in the configuration?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Configuring the Ancient Codex</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file serves as the cornerstone of sacred configuration within the repository. It defines the rituals for loading, parsing, and selectively extracting ‚Äúartifact paths‚Äù from the codex&#39;s JSON structure. It ensures the continuity of the system by providing a safe layer of file validation while parsing abstract data into actionable directives. This file directly influences how the Keeper‚Äôs Apparatus selects and arranges knowledge.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Undertakes the ceremonial reading of the primary configuration file, ensuring its presence without triggering fatal errors. This function is significant for initiating the codex‚Äôs alignment and its connection to the ancient apparatus.</li>
<li><code class="inline-code">parseAdventureConfig</code>: A sacred transformation that converts raw configuration data into JSON objects and validates their structural integrity. This function separates disorder from clarity, providing order amidst the complexity.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: A wisdom-driven pathway for identifying and collecting valid artifact paths referenced within the codex configuration. It guarantees that the sacred constructs remain intact and undisturbed by corruption.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the adventure configuration file located within the project directory.</li>
<li>Uses <code class="inline-code">readFileIfExists</code> to gracefully handle missing files without breaking critical processes.</li>
<li>Ensures compatibility by using standard file system handling patterns.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Converts the raw configuration file (if present) into actionable JSON objects.</li>
<li>Provides fallback mechanisms for unreadable or invalid JSON to prevent fatal runtime errors.</li>
<li>Bridges raw data pathways from filesystem to structured knowledge ready for exploration.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses the parsed configuration recursively to uncover all valid paths referenced in ‚Äúpath‚Äù fields.</li>
<li>Filters paths using <code class="inline-code">fs.existsSync</code> to ensure only existing, valid paths are included in the results.</li>
<li>Uses a stack-based approach to maintain computational efficiency during the traversal of deeply nested structures.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Directing the Keeper‚Äôs Apparatus</h3>
<p>This file functions as the Keeper‚Äôs operational guide, controlling how quests are initialized, explored, and their configurations merged. It takes raw project inputs and aligns them within the greater adventure narrative using structured processes. Through <code class="inline-code">initializeAdventure</code>, the file orchestrates merging codex-derived commands with dynamic quest creation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: The foundational ritual that resets the Keeper‚Äôs internal state and binds new quests to the codex‚Äôs directives. It determines the initial rhythm of exploration and esoteric merging mechanisms.</li>
<li><code class="inline-code">exploreQuest</code>: A mechanism for directly navigating individual quests, identifying and handling progress across fragmented realms.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Synthesizes guidance from the codex configuration into an actionable list of quests, further emphasizing harmonious integration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Establishes the starting point of the adventure by resetting the internal Keeper state and loading context from the codex configuration.</li>
<li>Integrates dynamic story generation processes and merges them with structured codex directives.</li>
<li>Protects against mismatches between generated quests and configuration-defined quest counts.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;
  
  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;
  
  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (filePaths.length &gt; 0) {
        configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
      }
    }
  }
  
  return quests.map((quest, index) =&gt; {
    const configQuests = adventure.quests;
    if (index &lt; configQuests.length &amp;&amp; configQuests[index] &amp;&amp; configQuests[index].files) {
      const files = configQuests[index].files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (files.length &gt; 0) {
        return { ...quest, codeFiles: files };
      }
    }

    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        return { ...quest, codeFiles: files };
      }
    }
    
    return quest;
  });
}
</code></pre>
<ul>
<li>Harmonizes generated quests with the codex configuration to ensure alignment between dynamic knowledge creation and static artifact directives.</li>
<li>Employs a mapping strategy to precisely bind files listed in the codex to their corresponding quests.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">loadAdventureConfig</code> and <code class="inline-code">parseAdventureConfig</code> to verify project path integrity before adjusting configurations.</li>
<li>Study the merging logic in <code class="inline-code">mergeQuestFilesFromConfig</code> to learn how dynamic and static directives can coexist.</li>
<li>Explore recursive traversal methods in <code class="inline-code">extractUniqueFilePaths</code> for understanding structured path validation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries woven through the Sacred Repository.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred mechanisms of the Keeper‚Äôs Apparatus, ascending yet further upon thy celestial odyssey‚Äîpress on, triumphant soul, for the temples of enlightenment await thy valor! ‚ö°üíéüó∫Ô∏èüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>