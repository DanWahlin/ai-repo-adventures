<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Code Analysis & Content Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Architect's Blueprint: A Modular Adventure into Repository Design</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis &amp; Content Pipeline</h1>
<hr>
<p>Embark on an investigative journey into the depths of the code analysis and content pipeline. These files form the backbone of the toolkit&#39;s ability to extract, process, optimize, and validate essential repository data for interactive adventure generation. As an architect, your mission is to understand how these systems operate and how they interconnect, leveraging advanced APIs and methodologies to ensure a seamless data flow. Explore the code below and uncover the secrets behind efficient code analysis and streamlined LLM integrations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Analyzer Optimization</strong>: How does <code class="inline-code">RepoAnalyzer</code> optimize content extraction to reduce token usage while maintaining functionality?</li>
<li>‚ö° <strong>LLM Request Flow</strong>: What are the essential patterns used in <code class="inline-code">LLMClient</code> to generate AI responses and handle different configurations like Azure OpenAI or GPT-5 models?</li>
<li>üõ°Ô∏è <strong>Validation Strategies</strong>: How does the pipeline validate project paths, API keys, and target files for safety and reliability?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Advanced code analysis and targeted content optimization</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class is designed to analyze, validate, and optimize repository content for processing. It takes raw file inputs, extracts function-focused content, and ensures robust validation mechanisms for paths and target files. Explore how caching is implemented to improve efficiency, and investigate token-saving methods applied during the optimization process.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Creates a comprehensive repository context using the <code class="inline-code">repomix</code> CLI while handling caching and configuration.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Validates input files to ensure no path traversal vulnerabilities and filters valid project files within size limits.</li>
<li><code class="inline-code">extractFunctionFocusedContent</code>: Reduces token usage by extracting only critical functions and stripping comments, empty lines, and irrelevant code.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch {
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached) return cached.content;

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
    style: options.style || &#39;markdown&#39;,
    compress: options.compress !== false,
    ignore: &#39;node_modules,dist,build&#39;,
  });

  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>This function generates repository context by leveraging cached results or executing the <code class="inline-code">repomix</code> CLI.  </li>
<li>It ensures validation of <code class="inline-code">projectPath</code> and applies fallback mechanisms for optimized content.  </li>
<li>Implements caching for efficient reuse of generated content and handles fallback behavior for recovery.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const projectRoot = path.resolve(projectPath);
  return [...new Set(targetFiles)]
    .map(file =&gt; path.resolve(projectPath, file))
    .filter(file =&gt; file.startsWith(projectRoot) &amp;&amp; fs.existsSync(file))
    .map(file =&gt; path.relative(projectPath, file));
}
</code></pre>
<ul>
<li>Ensures files are within project boundaries and exist before processing.  </li>
<li>Prevents path traversal vulnerabilities by validating resolved paths.  </li>
<li>Deduplicates target files for consistent and reliable operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private extractFunctionFocusedContent(fullContent: string): string {
  const lines = fullContent.split(&#39;\n&#39;);
  const optimizedLines: string[] = [];
  let inCodeBlock = false;

  for (const line of lines) {
    const trimmedLine = line.trim();
    if (!inCodeBlock &amp;&amp; trimmedLine.startsWith(&#39;```&#39;)) {
      inCodeBlock = true;
      optimizedLines.push(line);
    } else if (inCodeBlock &amp;&amp; trimmedLine.startsWith(&#39;```&#39;)) {
      inCodeBlock = false;
      optimizedLines.push(line);
    } else if (inCodeBlock &amp;&amp; !trimmedLine.startsWith(&#39;//&#39;) &amp;&amp; trimmedLine.length &gt; 0) {
      optimizedLines.push(line);
    }
  }

  return optimizedLines.join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Extracts focused content by filtering out comments and irrelevant lines from code blocks.  </li>
<li>Reduces token usage while maintaining essential patterns and functionality.  </li>
<li>Processes markdown-style code blocks to optimize their usability in downstream operations.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Configurable LLM client for API-driven AI responses</h3>
<p>The <code class="inline-code">LLMClient</code> class acts as an abstraction layer for integrating with large language model APIs, including OpenAI and Azure OpenAI. It dynamically configures API requests, validates keys and endpoints, and applies model-specific parameters like GPT-5 recommendations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Creates LLM-generated responses by constructing and executing requests, validating results, and processing JSON outputs.</li>
<li><code class="inline-code">constructor</code>: Initializes API client with dynamic handling for OpenAI and Azure configurations, supporting multiple providers.</li>
<li><code class="inline-code">getApiKey</code>: Validates and retrieves appropriate API keys based on the provider‚Äôs endpoint or configuration.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  const requestParams = this.buildRequestParams(prompt, options);
  try {
    const completion = await this.executeRequest(requestParams);
    const content = this.validateResponse(completion);
    return { content };
  } catch (error) {
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Constructs an API request and handles its execution while applying error-handling strategies.  </li>
<li>Validates and extracts response content, ensuring no malformed outputs reach downstream systems.  </li>
<li>Optimizes the prompt&#39;s use by applying tailored configuration options.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (LLM_BASE_URL.includes(&#39;azure&#39;)) {
    this.client = new AzureOpenAI({ endpoint: LLM_BASE_URL.split(&#39;/deployments&#39;)[0], apiKey });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Initializes <code class="inline-code">LLMClient</code> with API-specific settings, such as handling Azure endpoints dynamically.  </li>
<li>Ensures robust validation of API keys and configuration options before proceeding.  </li>
<li>Supports multiple model providers by branching initialization logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.ai.azure.com&#39;)) {
    return GITHUB_TOKEN;
  } else {
    return LLM_API_KEY;
  }
}
</code></pre>
<ul>
<li>Dynamically selects and validates API keys based on endpoint conditions.  </li>
<li>Differentiates between general OpenAI keys and GitHub-hosted Azure model tokens.  </li>
<li>Provides clear error messages when required configurations are missing.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Execution Strategy</strong>: Before testing <code class="inline-code">LLMClient</code> responses, ensure API keys and environment variables are correctly configured.  </li>
<li><strong>Optimization Review</strong>: Study the token-saving techniques in <code class="inline-code">RepoAnalyzer</code> and consider how similar approaches can apply to other LLM integrations.  </li>
<li><strong>Debugging Paths</strong>: Use strict input validation for file paths and prompt strings to prevent processing errors or vulnerabilities.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer! Your successful implementation of Quest 4: Code Analysis &amp; Content Pipeline proves you&#39;re debugging complexity into clarity at warp speed‚Äîkeep deploying brilliance, you&#39;re now 60% closer to your final milestone! üöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>