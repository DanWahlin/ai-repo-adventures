<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Code Analysis & Content Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository Atlas: A Guided Exploration of the Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis &amp; Content Pipeline</h1>
<hr>
<p>This quest delves into the critical backbone of the system: the code analysis and content pipeline. This section focuses on two essential files, <code class="inline-code">repo-analyzer.ts</code> and <code class="inline-code">llm-client.ts</code>, which collectively empower the platform&#39;s ability to analyze developer repositories and generate content through LLMs. The <code class="inline-code">RepoAnalyzer</code> class streamlines and validates codebase analysis, ensuring optimized output for language models, while <code class="inline-code">LLMClient</code> handles requests to underlying LLM APIs. Together, they form a cohesive pipeline for transforming repository data into story-driven adventure outputs.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Token Management Tactics</strong>: How does the content pipeline ensure efficient token usage when processing repositories or generating LLM requests?</li>
<li>‚ö° <strong>Validation Mechanisms</strong>: What safeguards exist to handle invalid inputs, misconfigurations, or external errors throughout the pipeline?</li>
<li>üõ°Ô∏è <strong>Error Handling Insights</strong>: How are errors captured, debugged, and communicated to ensure the system remains resilient and transparent?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Repository analyzer for structured content generation</h3>
<p>This file provides the <code class="inline-code">RepoAnalyzer</code> class, responsible for extracting, validating, and optimizing file data from a given project. Highlights include functionality to work securely with repository files, apply token-efficient optimizations, and interface with the <code class="inline-code">repomix</code> CLI for content extraction.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code> ensures project paths are valid, non-empty strings to prevent runtime crashes.</li>
<li><code class="inline-code">generateTargetedContent</code> focuses on generating optimized outputs for a specified subset of files, controlling the memory and runtime footprint.</li>
<li><code class="inline-code">captureRepomixStdout</code> executes the <code class="inline-code">repomix</code> CLI with timeouts and safeguards against resource overuse.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">/**
 * Basic validation for project path - minimal checks for actual use case
 */
private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures the input project path is non-empty and free from null bytes that could disrupt file operations.</li>
<li>By normalizing and validating project paths, it prevents potential security vulnerabilities or runtime errors.</li>
<li>Forms the foundation for safe file operations across the analyzer.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Generate targeted repomix content for specific files
 */
async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const cliOptions = {
      style: &#39;markdown&#39;,
      stdout: true,
      compress: compress,
      include: safeFiles.join(&#39;,&#39;),
      removeComments: compress,
      removeEmptyLines: compress,
      noDirectoryStructure: true
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Targeted repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Key functionality for targeted repository analysis, leveraging validation and caching to ensure efficiency.</li>
<li>Includes safeguards for memory usage, limiting processed files and caching outputs to prevent redundant operations.</li>
<li>Integrates a structured CLI interaction for file analysis using <code class="inline-code">repomix</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Capture repomix CLI as subprocess with timeout and memory protection
 */
private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
    let stdout = &#39;&#39;;
    let stdoutSize = 0;

    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGTERM&#39;);
      setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
      reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
      stdoutSize += data.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(&#39;Repomix output too large&#39;));
      }
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout);
      else reject(new Error(`Repomix failed (exit ${code})`));
    });
  });
}
</code></pre>
<ul>
<li>Implements resource control for CLI execution via timeouts and memory restrictions.</li>
<li>Handles subprocess interactions robustly, mitigating runtime risks like excessive output or long execution times.</li>
<li>Valuable for maintaining stability while processing large repositories.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: LLM interaction layer</h3>
<p>This file introduces the <code class="inline-code">LLMClient</code> class, which manages secure and structured API requests to LLMs. It incorporates mechanisms for handling API-specific configurations, managing JSON parsing, and logging detailed errors.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code> constructs and executes an LLM request, handling potential errors and post-processing responses for compatibility.</li>
<li><code class="inline-code">constructor</code> initializes the client with specific configurations and safeguards for API key handling.</li>
<li><code class="inline-code">getApiKey</code> determines and validates the appropriate API key based on the provider.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Coordinates the request-response cycle for generating content via LLMs.</li>
<li>Incorporates robust error logging, debugging, and detailed token usage tracking to optimize API interactions.</li>
<li>Ensures responses are post-processed and validated for downstream consumption.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required.&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Sets up the LLM client with required configurations, including API key validation and deployment-specific settings.</li>
<li>Differentiates between Azure and OpenAI configurations, offering flexibility based on the underlying provider.</li>
<li>Ensures critical preconditions for successful API interactions are satisfied.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;) &amp;&amp; !GITHUB_TOKEN) {
    throw new Error(&#39;GITHUB_TOKEN required for GitHub Models&#39;);
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required&#39;);
  }
  return LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;) ? GITHUB_TOKEN : LLM_API_KEY;
}
</code></pre>
<ul>
<li>Decides and validates the API key dynamically, based on the provider and environment setup.</li>
<li>Ensures secure handling of credentials to prevent runtime errors or security mishaps.</li>
<li>Provides clarity on which environment variables power the authentication process.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Tip</strong>: Focus on the error logging methods in <code class="inline-code">generateResponse</code> and <code class="inline-code">captureRepomixStdout</code> to understand their role in debugging and resilience.</li>
<li><strong>Recommendation</strong>: Pay special attention to how caching mechanisms are integrated within <code class="inline-code">generateTargetedContent</code> to optimize performance.</li>
<li><strong>Next Steps</strong>: Review the theme-system pipeline next to see how the generated content aligns with user-configured themes.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üöÄ Commit successful: Quest 4: Code Analysis &amp; Content Pipeline has been masterfully debugged and deployed‚Äîyour progress is compiling at blazing speed, unlocking 60% of the journey to full-stack domination! ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>