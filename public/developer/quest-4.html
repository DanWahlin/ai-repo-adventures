<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Code Analysis & Content Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Architecture of Adventures: An Exploration of a Developer's Toolkit</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis &amp; Content Pipeline</h1>
<hr>
<p>As the system thrives on analyzing repositories and generating dynamic narratives, mastering the code analysis and content generation pipeline is critical. In this quest, you&#39;ll explore how the <code class="inline-code">RepoAnalyzer</code> efficiently processes codebases for optimization, and how the <code class="inline-code">LLMClient</code> interfaces with large language models to provide context-aware responses and content generation. These mechanisms are the backbone of scalable, reusable components for adventure creation. By dissecting these tools, you&#39;ll uncover best practices in modular integration and robust pipeline management in developer ecosystems.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Content Extraction</strong>: How does <code class="inline-code">RepoAnalyzer</code> ensure secure and optimized extraction of useful code data from the repository?</li>
<li>‚ö° <strong>Model Integration</strong>: How is the <code class="inline-code">LLMClient</code> designed to adapt to different large language model providers such as OpenAI and Azure OpenAI?</li>
<li>üõ°Ô∏è <strong>Error Resilience</strong>: What mechanisms are in place in both classes to handle errors gracefully and maintain system stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Repository Analysis for Optimized Content</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class is a cornerstone utility for extracting and optimizing relevant content from code repositories. It manages the execution of the <code class="inline-code">repomix</code> tool, ensures security through strict file path validation, and leverages caching to improve performance. Its capability to preprocess and filter code blocks intelligently makes it indispensable for efficient pipeline workflows.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Initializes the content extraction process, leveraging adventure-config inclusions where available. It employs caching to save results for subsequent calls to the same repository.</li>
<li><code class="inline-code">generateTargetedContent</code>: Focuses on extracting data from specific files as per validation rules. It highlights adaptability by limiting its scope based on given targets.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Manages subprocess invocation for <code class="inline-code">repomix</code>, incorporating strict timeout and memory buffer safeguards to prevent resource overflow.</li>
<li><code class="inline-code">validateProjectPath</code>: Enforces security by validating and sanitizing repository paths to obstruct path traversal attacks.</li>
<li><code class="inline-code">extractFunctionFocusedContent</code>: Refines repomix outputs, isolating key functions and patterns to minimize token usage for downstream processing.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Fallback to targeted content due to error: ${error.message}`);
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  // Fallback: Full repomix context with compression
  return this.captureRepomixStdout([&#39;.&#39;], projectPath, { style: &#39;markdown&#39;, stdout: true });
}
</code></pre>
<ul>
<li>Utilizes <code class="inline-code">extractUniqueFilePaths</code> to integrate config-specific files dynamically.</li>
<li>Implements caching to reduce redundant operations and improve performance.</li>
<li>Demonstrates a fallback mechanism ensuring robustness even in failure scenarios.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  
  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  // Configure and execute with repomix
  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, { compress, include: safeFiles.join(&#39;,&#39;) });
  
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>Validates and normalizes target file paths for safety and precision.</li>
<li>Ensures output consistency with caching and configurable options.</li>
<li>Demonstrates support for compressibility and maintenance of minimal resource use.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--style&#39;, options.style || &#39;markdown&#39;, &#39;--stdout&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let isResolved = false;
    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        reject(new Error(&#39;Repomix subprocess timeout.&#39;));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);
    
    repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });
    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Exit code ${code}: ${stderr}`));
    });
  });
}
</code></pre>
<ul>
<li>Safeguards subprocess execution with timeout controls and graceful termination.</li>
<li>Monitors output size, preventing memory overflows.</li>
<li>Defends the pipeline against subprocess errors with detailed error reporting.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Smart Content Generation Interface</h3>
<p>The <code class="inline-code">LLMClient</code> class acts as the bridge to LLM (Large Language Models) providers such as OpenAI. It configures API access, validates requests, and processes responses intelligently to extract meaningful content. It exemplifies robust error handling and adaptability to multiple LLM providers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Orchestrates communication with the LLM, building requests and processing responses while managing errors effectively.</li>
<li><code class="inline-code">constructor</code>: Initializes the client with support for multiple providers via API configurations, toggling between OpenAI and Azure OpenAI setups.</li>
<li><code class="inline-code">getApiKey</code>: Safeguards API token retrieval, validating the type of token required (e.g., GitHub token for Azure-hosted inference).</li>
<li><code class="inline-code">isAzureOpenAI</code>: Confirms whether the active configuration points to an Azure OpenAI deployment.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    const content = this.validateResponse(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Defines the primary entry point for generating LLM-assisted responses.</li>
<li>Integrates error logs to support debugging and optimize fault diagnosis.</li>
<li>Validates and processes response content to ensure compatibility with consumer expectations.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  
  if (this.isAzureOpenAI()) {
    this.client = new AzureOpenAI({
      endpoint: LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0],
      apiKey,
      apiVersion: LLM_API_VERSION
    });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Facilitates seamless integration with multiple LLM providers through dynamic setup.</li>
<li>Enforces preconditions for API key configurations.</li>
<li>Configures provider-specific parameters based on endpoint conditions.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;) &amp;&amp; !GITHUB_TOKEN) {
    throw new Error(&#39;GITHUB_TOKEN required for Azure-hosted models.&#39;);
  }
  return LLM_BASE_URL.includes(&#39;.openai.com&#39;) ? LLM_API_KEY : GITHUB_TOKEN;
}
</code></pre>
<ul>
<li>Determines and validates appropriate API key types for each provider.</li>
<li>Implements protective measures against missing token setups.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>If you&#39;re encountering subprocess failures, try adjusting timeout settings or reducing file count for <code class="inline-code">RepoAnalyzer</code>.</li>
<li>Use breakpoints to explore API key configurations and ensure Azure-based provisioning is correctly routed.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully refactoring the Quest 4 pipeline with precision and achieving a 60% codebase milestone‚Äîyou&#39;re debugging the future, one quest at a time! üíéüöÄüëÅÔ∏è‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>