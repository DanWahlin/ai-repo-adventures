<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Architecture of Adventure: A Developer's Guide</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Dive into the core mechanics of the MCP tool interface to uncover how it bridges interactive exploration with gamified storytelling. This quest focuses on how the server processes requests and integrates with tools to deliver an innovative experience. Developers will investigate how handlers are dynamically set up, tools are executed, and the entire MCP server operates smoothly, encapsulating functionality and error management.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Dynamics</strong>: How does <code class="inline-code">setupHandlers</code> link incoming requests to the available tools and ensure proper schema validation?</li>
<li>‚ö° <strong>Execution Workflow</strong>: What are the primary steps performed in the <code class="inline-code">run</code> function to initialize and warm up the system for user interaction?</li>
<li>üõ°Ô∏è <strong>Error Resilience</strong>: How does the <code class="inline-code">main</code> function handle edge cases like system shutdown, unhandled rejections, and unexpected errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server Implementation</h3>
<p>This file implements the main server logic for the Repo Adventure MCP, handling tool requests and initializing the service. It demonstrates key design patterns like dependency encapsulation, dynamic request handling, and error management. The file highlights how handlers are dynamically registered for tool discovery and execution, ensuring a flexible and extensible system. Additionally, it configures graceful shutdown to maintain robustness in handling edge cases such as process termination signals.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures handlers for managing tool listing and execution, incorporating dynamic schema validation and error handling.</li>
<li><code class="inline-code">run</code>: Starts the server, initializes transport, and warms up the system cache for efficient operation.</li>
<li><code class="inline-code">main</code>: Boots up the server and manages critical process lifecycle actions, including signal handling and error resilience.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map(
            (err) =&gt; `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<ul>
<li>Dynamically sets up request handlers for tool discovery and execution, aligning MCP&#39;s extensibility with user demands.</li>
<li>Maps tools to their respective handlers while validating inputs with the <code class="inline-code">zod</code> schema targeting <code class="inline-code">jsonSchema7</code>.</li>
<li>Implements error handling using a custom <code class="inline-code">McpError</code> class to differentiate between internal and user-side issues.</li>
<li>Employs clear and precise error feedback for both unknown tools and invalid parameter inputs.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Starts and connects the server using the <code class="inline-code">StdioServerTransport</code>, enabling command-line-based tool interactions.</li>
<li>Logs essential status updates to the console to keep users informed about the server&#39;s state.</li>
<li>Invokes a pre-generation step for <code class="inline-code">repomix</code> content, enhancing performance by warming up caches with current project context.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
    try {
        const server = new RepoAdventureServer();
        
        // Handle graceful shutdown for both signals
        [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
            process.on(sig as NodeJS.Signals, gracefulShutdown)
        );
        
        // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
        process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
            console.error(&#39;Unhandled promise rejection:&#39;, reason);
            console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
            // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
        });
        
        await server.run();
    } catch (error) {
        console.error(&#39;Fatal error starting MCP server:&#39;, error);
        process.exit(1);
    }
}
</code></pre>
<ul>
<li>Orchestrates the server startup, including instancing and executing <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Ensures a robust process with shutdown handling for signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Logs unhandled rejections without shutting down, helping to debug issues safely without interrupting usability.</li>
<li>Uses a try-catch block to manage lifecycle-critical errors and exit cleanly on fatal issues.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <code class="inline-code">zod</code> schemas simplify input validation and tool registration within the <code class="inline-code">McpError</code> framework.</li>
<li>Altering or extending tool functionality? Focus on the <code class="inline-code">setupHandlers</code> method to align request patterns.</li>
<li>Test signal handling with <code class="inline-code">SIGINT</code>/<code class="inline-code">SIGTERM</code> for robustness before deploying into live environments.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully deploying Quest 2: MCP Tool Interface‚Äîyour codebase refactors and UI enhancements have been committed with precision, propelling your developer journey to 20% completion! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>