<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Developer's Codex: A Guide to Modular Systems</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The MCP Interface</h1>
<hr>
<p>The Modular Context Protocol (MCP) system houses an interface central to its operation: the MCP Server and Tools module. Together, these files establish the foundation for dynamically managing tool requests, validating inputs, and executing developer-oriented operations. Through extensible handlers and schema-driven validation, the system ensures a reliable and highly modular interface for interacting with repositories. This quest investigates the intricate design of dynamic tool setup and execution, providing a clear view of the server&#39;s and tools&#39; implementations. Prepare to dive into the core architecture of intuitive tool-based functionality.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Deployment</strong>: How does the <code class="inline-code">RepoAdventureServer</code> dynamically manage and validate requests for different tools, ensuring input schemas are correct?</li>
<li>‚ö° <strong>Initialization Workflow</strong>: What steps are involved in starting the Repo Adventure MCP server, including background processes and server transport setup?</li>
<li>üõ°Ô∏è <strong>Tool Integration</strong>: How are specific tools, such as <code class="inline-code">start_adventure</code>, structured and registered to make them accessible and validated during execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The MCP Server Backbone</h3>
<p>This file defines the <code class="inline-code">RepoAdventureServer</code> responsible for running the MCP system, handling tool-related requests, and managing server transport. Key highlights of this file include the setup of handlers for tool listing and execution, which use well-defined schemas to ensure input validity. Additionally, error handling mechanisms, graceful shutdown procedures, and repo content caching ensure both robustness and smooth operation for developers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines handlers for listing tools dynamically and executing specific tool requests via schemas. This ensures modularity and strict validation for request inputs.</li>
<li><code class="inline-code">run</code>: Configures and starts the MCP server transport, while pre-caching repository content to enhance performance.</li>
<li><code class="inline-code">main</code>: Bootstraps the server instance, sets up signal handling for graceful shutdowns, and manages unexpected errors during runtime.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists and executes tools based on predefined schemas, enabling extensibility and modularity.</li>
<li>Utilizes Zod schemas to validate input arguments before execution, promoting data integrity.</li>
<li>Provides tailored error handling to distinguish between invalid inputs and internal server errors.</li>
<li>Modular code structure ensures handlers can accommodate future tools seamlessly.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server with a <code class="inline-code">stdio</code> transport for handling communications.</li>
<li>Pre-generates content for the repository using the <code class="inline-code">repoAnalyzer</code> to improve responsiveness for subsequent commands.</li>
<li>Outputs diagnostic information to the console for easier debugging and status tracking.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Acts as the entry point for the server, ensuring all dependencies are initialized before operations begin.</li>
<li>Implements signal handling (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for a graceful server shutdown to clean up resources.</li>
<li>Logs unhandled promise rejections without terminating the server, ensuring non-critical errors do not disrupt functionality.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>: Managing Tools and Their Roles</h3>
<p>This file organizes the tools available to the MCP system, including their registration and modular configuration. It acts as the main entry point for tool setup, ensuring that each tool is self-contained and reusable.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes a codebase and prepares the interactive adventure, effectively launching the system‚Äôs gamified exploration.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows developers to select a narrative theme, tailoring the experience to their preferences.</li>
<li><code class="inline-code">explore_quest.handler</code>: Investigates specific aspects of the repository, iterating through multiple story-driven quests.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks the developer‚Äôs progress, providing a sense of achievement and visibility into remaining tasks.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool exports for streamlined management and registration with the MCP Server.</li>
<li>Uses semantic naming (<code class="inline-code">start_adventure</code>, <code class="inline-code">explore_quest</code>) for tools, making their roles transparent for developers.</li>
<li>Facilitates modular development by keeping tool definitions in their respective files to improve maintainability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Setup Inspection</strong>: When expanding functionality, ensure new tools are added to the <code class="inline-code">tools</code> object with proper schemas.</li>
<li><strong>Validation Checks</strong>: Observe how Zod schemas enforce robust parameter validation, reducing runtime errors.</li>
<li><strong>Server Logs</strong>: Use console outputs to trace activities during the server‚Äôs execution in real-world scenarios.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Achievement unlocked: &quot;Quest 2: The MCP Interface&quot; successfully merged into your skill set, pushing your developer stack to 20% completion‚Äîstellar performance, debugging greatness lies ahead! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>