<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Code Analysis and AI Collaboration - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository Chronicles: Exploring Modular Systems</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Code Analysis and AI Collaboration</h1>
<hr>
<p>Equip yourself with the tools to navigate the intricate layers of the MCP (Modular Code Platform) server and tool interfaces. In this quest, we will study how the server dynamically handles requests, validates user inputs, and executes tools built on top of MCP schemas. Dive into the underlying mechanics defined in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> to understand how AI and modular design collaborate to create an interactive developer experience. </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Configurations</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically define request handlers for tool listing and execution?</li>
<li>‚ö° <strong>Startup Sequence</strong>: What patterns or methods are used by the <code class="inline-code">run</code> or <code class="inline-code">main</code> functions to initialize the MCP server and ensure seamless startup?</li>
<li>üõ°Ô∏è <strong>Tool Execution Safety</strong>: What validation mechanisms are in place to ensure safe and accurate execution of tools?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Implementation</h3>
<p>This file encapsulates the configuration, handler setup, and startup logic for the MCP server. It ensures modular functionality by dynamically setting handlers for tools and preparing the environment for user interactions. Interaction safety is bolstered through structured validation and error handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures request handlers for listing and executing tools dynamically, incorporating input validation and schema conversions.</li>
<li><code class="inline-code">run</code>: Establishes the server&#39;s communication transport and pre-generates Repomix content for readiness.</li>
<li><code class="inline-code">main</code>: The entry point that initializes <code class="inline-code">RepoAdventureServer</code> and handles critical operational signals like graceful shutdowns.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));
      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;
        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }
        const tool = tools[name as keyof typeof tools];
        // Validate arguments using the tool&#39;s Zod schema
        return await tool.handler(tool.schema.parse(args));
      } catch (error) {
        if (error instanceof McpError) throw error;
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically registers request handlers for both listing and executing tools.</li>
<li>Converts tool schemas to a standardized format (<code class="inline-code">jsonSchema7</code>) for client usability.</li>
<li>Validates tool arguments through <code class="inline-code">zod</code> schemas to prevent invalid operations.</li>
<li>Catches errors with specific MCP error handling and propagates meaningful messages.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Instantiates a <code class="inline-code">StdioServerTransport</code> to manage transport protocols for the server.</li>
<li>Pre-generates content related to the repository&#39;s working directory, improving system readiness.</li>
<li>Logs meaningful details about server startup and pre-cache operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">RepoAdventureServer</code> class and handles signal-based shutdown behavior.</li>
<li>Catches unhandled promise rejections, ensuring the server remains operational in most scenarios.</li>
<li>Provides robust error handling for startup failures by exiting gracefully.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Registration and Definitions</h3>
<p>This file serves as the registry for MCP tools, encapsulating their structure, functionality, and entry points. Each tool is implemented as an independent module and re-exported for dynamic registration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates codebase analysis and presents theme options.</li>
<li><code class="inline-code">explore_quest.handler</code>: Facilitates interactions within specific developer-themed quests.</li>
<li><code class="inline-code">view_progress.handler</code>: Reports on the overall progress and remaining tasks.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const tools = {
  start_adventure: startAdventure,
  explore_quest: exploreQuest,
  view_progress: viewProgress
};
</code></pre>
<ul>
<li>Imports tool handlers from independent modules, ensuring modularity and maintainability.</li>
<li>Re-exports tools in a consolidated object for standardized usage across MCP components.</li>
<li>Encourages decoupled development by isolating tool logic and separating concerns.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Maps internal tool structures to MCP-compliant names (<code class="inline-code">start_adventure</code>, <code class="inline-code">explore_quest</code>).</li>
<li>Facilitates streamlined integrations with the MCP server and client endpoints.</li>
<li>Adds clear naming conventions for easier management and extensibility.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Validation Patterns</strong>: Study the <code class="inline-code">setupHandlers</code> method to understand how dynamic validation prevents runtime failures.</li>
<li><strong>Startup Design</strong>: Observe the interplay between <code class="inline-code">run</code> and <code class="inline-code">main</code> to identify key steps for resilient server initialization.</li>
<li><strong>Tool Modularity</strong>: Explore how <code class="inline-code">tools.ts</code> cleanly separates functionality for better codebase organization.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>‚≠ê System check complete: you&#39;ve refactored your way through Quest 2 with perfectly modular code and AI-driven synergy‚Äîkeep pushing toward full stack mastery! üöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>