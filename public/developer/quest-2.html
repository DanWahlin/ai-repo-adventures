<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository Atlas: A Guided Exploration of the Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Dive into the heart of the MCP framework, where tools come alive through structured schemas and precise execution logic. This quest focuses on how the MCP server connects disparate functionalities and executes dynamic tools with validation and error handling. Explore how the <code class="inline-code">Server</code> class integrates a set of tools and patterns to shape a modular architecture for code exploration.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Integration</strong>: How does the <code class="inline-code">RepoAdventureServer.setupHandlers</code> method dynamically manage tool listings and executions?</li>
<li>‚ö° <strong>Transport Mechanism</strong>: What initialization steps are used to configure the MCP server transport in <code class="inline-code">run</code>, and how does it interact with pre-caching mechanisms?</li>
<li>üõ°Ô∏è <strong>Error Handling Paradigm</strong>: How does the <code class="inline-code">main</code> function ensure robust error handling and graceful shutdown during server runtime?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server for Repo Adventure MCP</h3>
<p>The <code class="inline-code">server.ts</code> file defines the MCP server&#39;s core functionalities, focusing on how client requests are processed, tools are validated, and the server lifecycle is managed. The <code class="inline-code">RepoAdventureServer</code> class encapsulates tool registration, schema handling, and execution models. Crucial methods, such as <code class="inline-code">setupHandlers</code> and <code class="inline-code">run</code>, demonstrate the use of structured APIs to maintain consistency across operations. The <code class="inline-code">main</code> function serves as an entry point for initializing the server, setting up signal handlers for a controlled shutdown, and managing unhandled promise rejections.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers dynamic handlers for listing and invoking tools, ensuring requests conform to predefined schemas.</li>
<li><code class="inline-code">run</code>: Starts the MCP server, connects it to the transport interface, and pre-generates cache content for seamless operations.</li>
<li><code class="inline-code">main</code>: Handles lifecycle management, such as initialization, signal trapping for shutdown, and reporting for asynchronous errors.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tool Definitions</h3>
<p>The <code class="inline-code">tools.ts</code> file provides tools for gamified codebase exploration. Each tool is structured as a distinct module with handlers, schemas, and descriptions. Tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and <code class="inline-code">explore_quest</code> extend modular functionality, while <code class="inline-code">tools</code> serves as an aggregated export for MCP integration. The file demonstrates clean organization and separation of concerns, making it easier to maintain and enhance tool functionalities.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates a new adventure by analyzing the codebase.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows users to select themes for customized experiences.</li>
<li><code class="inline-code">explore_quest.handler</code>: Processes exploration requests for individual quests in the codebase.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks user progress across completed and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; `${err.path.join(&#39;.&#39;)}: ${err.message}`).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) throw error;
      throw new McpError(ErrorCode.InternalError, `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`);
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools with schemas using <code class="inline-code">zodToJsonSchema</code>, ensuring strict validation.</li>
<li>Simplifies error messaging through the <code class="inline-code">McpError</code> system for consistent responses.</li>
<li>Facilitates modular execution by extracting handlers and schemas from the tools registry.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Configures the <code class="inline-code">StdioServerTransport</code> for communication, keeping the implementation lightweight.</li>
<li>Activates caching via <code class="inline-code">repoAnalyzer.preGenerate</code> for improved performance during server runtime.</li>
<li>Logs runtime events for transparency and debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; process.on(sig as NodeJS.Signals, gracefulShutdown));
    process.on(&#39;unhandledRejection&#39;, reason =&gt; console.error(&#39;Unhandled promise rejection:&#39;, reason));
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server and prepares it for runtime operations.</li>
<li>Traps <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> signals for controlled shutdown using <code class="inline-code">gracefulShutdown</code>.</li>
<li>Enables resiliency against asynchronous errors with logging support.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Aggregates tools into a centralized structure for easy registration and access.</li>
<li>Supports dynamic tool integration, facilitating extension in future updates.</li>
<li>Promotes consistency and modularity across tools by adhering to MCP conventions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Detailed validation and error handling patterns can improve reliability in dynamic systems. Study <code class="inline-code">setupHandlers</code> for inspiration.</li>
<li>Investigate how <code class="inline-code">run</code> enhances performance through caching mechanisms to optimize your own projects.</li>
<li>Explore how modular exports in <code class="inline-code">tools.ts</code> streamline tool management across applications.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully pushing the MCP Tool Interface feature to production‚Äîyour codebase refactor prowess shines as a beacon of innovation at 20% quest completion; keep deploying greatness! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>