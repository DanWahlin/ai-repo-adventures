<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Forge of Adventure - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: Tales of the Automation Guild</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Forge of Adventure</h1>
<hr>
<p>Amid the intricate labyrinth of the Automation Guild&#39;s repository, you have reached the Forge of Adventure. Here lies the heart of the story generation engine‚Äîan ever-evolving artifact capable of crafting quests and adventures with unparalleled depth and flow. By wielding this mystical engine, you can uncover how quests are shaped and adventures are tailored, exploring the foundations of dynamic content generation. But be cautious, adventurer, for the code within holds both enlightenment and puzzles to unravel.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Heart of the Machine</strong>: How does <code class="inline-code">AdventureManager</code> initialize an adventure and merge its generated quests with configuration files?</li>
<li>‚ö° <strong>The Tale Weaver</strong>: What role does <code class="inline-code">StoryGenerator</code> play in dynamically generating the story content and quest structures?</li>
<li>üõ°Ô∏è <strong>Validation Runes</strong>: How does the system ensure the integrity of adventure configurations and quests through <code class="inline-code">parseAdventureConfig</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Core Adventure Manager</h3>
<p><code class="inline-code">adventure-manager.ts</code> orchestrates and executes core gameplay loops for quests and adventures, serving as the controller for initializing adventures, tracking progress, and handling quest execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Resets the adventure&#39;s state, applies themes, and generates story and quest data while integrating configuration-defined constraints.</li>
<li><code class="inline-code">progressPercentage</code>: Calculates the percentage of completed quests to provide seamless progress tracking functionality.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Enriches generated quests with specific file references and highlights based on configuration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets earlier adventure state to ensure clean initialization.</li>
<li>Utilizes <code class="inline-code">StoryGenerator</code> to dynamically generate a new story and quest structure.</li>
<li>Enhances generated quests by incorporating file references from configuration files.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Calculates progress dynamically based on completed quest count.</li>
<li>Ensures no division errors when quests are absent.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;
  
  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;

  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (filePaths.length &gt; 0) {
        configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
      }
    }
  }

  return quests.map((quest, index) =&gt; {
    if (index &lt; adventure.quests.length &amp;&amp; adventure.quests[index]?.files) {
      const files = adventure.quests[index].files
        .filter((f: any) =&gt; f.path)
        .map((f: any) =&gt; f.path);
      if (files.length &gt; 0) {
        return { ...quest, codeFiles: files };
      }
    }
    
    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        return { ...quest, codeFiles: files };
      }
    }
    return quest;
  });
}
</code></pre>
<ul>
<li>Maps configuration-defined file references to generated quests by title or order.</li>
<li>Ensures quests receive supplementary file contexts for better content generation.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> The Quest Architect</h3>
<p><code class="inline-code">story-generator.ts</code> is responsible for generating narratives and quests. It interacts with an LLM (language learning model) to dynamically compose consistent adventure structures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Generates narrative, quest descriptions, and themes dynamically based on the codebase context.</li>
<li><code class="inline-code">generateQuestContent</code>: Produces detailed content for individual quests by applying context-specific LLM prompts and file mappings.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Processes raw markdown responses into structured data for quests and guidance handling.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Orchestrates LLM-driven generation of unified narrative and quest structures.</li>
<li>Ensures thematic consistency through validation before interacting with the data model.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  });

  const response = await this.llmClient.generateResponse(
    prompt, { maxTokens: LLM_MAX_TOKENS_QUEST }
  );

  const cleanContent = this.removeLLMMetaCommentary(response.content);

  return {
    adventure: cleanContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Dynamically formulates detailed content for a specific quest using LLM responses.</li>
<li>Integrates story context, thematic elements, and file-specific exploration.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);
  let title = &#39;&#39;;
  let story = &#39;&#39;;

  for (const token of tokens) {
    if (token.type === &#39;heading&#39; &amp;&amp; token.depth === 1) {
      title = token.text;
    } else if (token.type === &#39;paragraph&#39;) {
      story += token.text + &#39;\n\n&#39;;
    }
  }
  return { title, story: story.trim(), quests: [] };
}
</code></pre>
<ul>
<li>Decodes markdown responses into story titles, narratives, and quest lists.</li>
<li>Implements structural parsing to ensure well-formed quest content.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> The Configuration Key</h3>
<p><code class="inline-code">adventure-config.ts</code> encapsulates utilities for reading and parsing the adventure&#39;s configuration file.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Parses the <code class="inline-code">adventure.config.json</code> file into a structured object for merging with quests and themes.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Extracts all file paths specified in the configuration, ensuring validity for quest usage.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Formats the configuration for concise LLM prompt integration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Converts JSON configuration into a structured JavaScript object.</li>
<li>Gracefully handles invalid or absent configurations, maintaining system stability.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed) return [];

  const unique = new Set&lt;string&gt;();
  const stack = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (node?.path &amp;&amp; typeof node.path === &#39;string&#39;) {
      unique.add(node.path);
    }
    stack.push(...Object.values(node || {}));
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Recursively extracts all distinct file paths from the configuration file.</li>
<li>Validates path existence to ensure reliable file references.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed) return &#39;&#39;;

  return Object.entries(parsed).map(([key, value]) =&gt; `${key}: ${JSON.stringify(value, null, 2)}`).join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Simplifies configuration content for LLM prompt inclusion.</li>
<li>Eliminates redundancy, focusing on minimal context delivery for better performance.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure configuration files are properly formatted to avoid errors in parsing.</li>
<li>When designing quests, consider file-specific context to enhance clarity and depth.</li>
<li>Use thematic consistency to engage users effectively throughout the story.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üéâ Congratulations, developer‚ÄîQuest 2: The Forge of Adventure has been successfully committed to the master branch of your journey, setting the foundation for scalable progression at 20% completion! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>