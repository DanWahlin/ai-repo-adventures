<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Modular Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Quest Generation Engine</h1>
<hr>
<p>The Quest Generation Engine is at the heart of the adventure creation system. It blends user-defined themes with dynamic code analysis to build interactive storytelling experiences tailored to the repository under inspection. By integrating modular tools and robust configurations, this engine ensures every generated quest is contextually rich and technically relevant. To unlock its full potential, we shall delve into its architecture and key components.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Theme Initialization</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> integrate the project context, theme data, and configuration file to prepare an adventure?</li>
<li>‚ö° <strong>Quest Execution Flow</strong>: What steps are executed when a user selects a quest with <code class="inline-code">AdventureManager.exploreQuest</code>, and how is quest content generated or retrieved?</li>
<li>üõ°Ô∏è <strong>Validation and Input Safety</strong>: How do functions like <code class="inline-code">loadAdventureConfig</code> and <code class="inline-code">parseAdventureConfig</code> ensure the reliability and security of configuration files?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Adventure Manager System</h3>
<p>The <code class="inline-code">AdventureManager</code> is responsible for orchestrating the flow of the adventure. This includes initializing an adventure, managing quests, and generating content dynamically through the <code class="inline-code">StoryGenerator</code> integration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Prepares the adventure by resetting state, integrating project context, and generating storylines and quests based on the given theme.</li>
<li><code class="inline-code">exploreQuest</code>: Handles user input to validate and execute a chosen quest, caching results for revisited quests.</li>
<li><code class="inline-code">generateQuestContent</code>: Dynamically generates new quest content based on the specified code files, theme, and project context.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Story and Content Generation</h3>
<p>The <code class="inline-code">StoryGenerator</code> is the core module for transforming themes and repository insights into structured narratives. It processes both overarching stories and detailed quest content.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Coordinates with the LLM client to generate a full story and quest list based on the repository content and the selected theme.</li>
<li><code class="inline-code">generateQuestContent</code>: Builds customized quest content, targeting specific file insights and incorporating adventure guidelines.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Parses markdown responses from the LLM client into structured <code class="inline-code">StoryResponse</code> data, ensuring quests and stories are accurately extracted.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Adventure Configuration Utilities</h3>
<p>This file focuses on the management of the adventure configuration file (<code class="inline-code">adventure.config.json</code>). It processes inputs and validates file structures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Loads the raw adventure configuration file from the project path without parsing.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Parses and validates the adventure configuration JSON, returning an object for further processing.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Scans the parsed configuration for unique file paths, ensuring only existing files are included.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;

  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}
</code></pre>
<ul>
<li>Initializes the adventure by resetting the state and processing the project and theme context.</li>
<li>Incorporates custom themes and adheres to configuration constraints when generating quests.</li>
<li>Ensures user-generated adventures remain aligned with repository insights.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates user input for quest selection and determines progress requests.</li>
<li>Locates the appropriate quest by title, ID, or number and executes it dynamically.</li>
<li>Incorporates caching for revisited quests to optimize performance and usability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;
    
  if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0 &amp;&amp; this.state.projectPath) {
    codeContent = await repoAnalyzer.generateTargetedContent(this.state.projectPath, quest.codeFiles);
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  return await this.storyGenerator.generateQuestContent({
    quest,
    theme: this.state.currentTheme!,
    codeContent,
    questPosition: this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1,
    totalQuests: this.state.quests.length,
  });
}
</code></pre>
<ul>
<li>Generates quest-specific contextual content, targeting relevant files or using fallback content.</li>
<li>Integrates with the <code class="inline-code">StoryGenerator</code> for personalized quest content.</li>
<li>Ensures quests reflect real project data and align with the selected theme.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  const formattedConfig = formatAdventureConfigForPrompt(projectPath || &#39;&#39;);
  const prompt = loadStoryGenerationPrompt({ theme, repomixContent: projectInfo.repomixContent, adventureGuidance: formattedConfig });

  const response = await this.llmClient.generateResponse(prompt);
  return parseMarkdownToStoryResponse(response.content);
}
</code></pre>
<ul>
<li>Constructs and transmits a story-generation prompt that aligns with the selected theme.</li>
<li>Ensures generated content reflects both the repository and user-defined configurations.</li>
<li>Parses the response into structured data for efficient quest integration.</li>
</ul>
<hr>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Retrieves the raw contents of the configuration file from the project directory.</li>
<li>Ensures missing or inaccessible configuration files are gracefully handled, preventing critical failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Converts the raw configuration file into a JSON object for further processing.</li>
<li>Validates the integrity of configuration data, eliminating corrupted input.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (typeof node.path === &#39;string&#39;) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }
    
    const children = Array.isArray(node) ? node : Object.values(node);
    stack.push(...children);
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Extracts all valid file paths specified in the configuration file.</li>
<li>Resolves relative paths to absolute ones, ensuring accuracy across the repository.</li>
<li>Optimized for performance through a stack-based tree traversal.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">initializeAdventure</code> as a blueprint for integrating themes with project metadata.</li>
<li>Follow <code class="inline-code">parseAdventureConfig</code> to ensure safe handling of user-specified configuration files.</li>
<li>For personalized quests, reference the interplay between <code class="inline-code">generateStoryAndQuests</code> and <code class="inline-code">generateQuestContent</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üéâ Congratulations on successfully deploying the Quest Generation Engine‚Äîyour code logic is now 20% closer to a fully optimized adventure system; keep refactoring greatness into this journey! üöÄüíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>