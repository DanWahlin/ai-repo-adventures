<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Codebase Chronicles: Mastering the Repository Realms</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>The heart of MCP lies in its robust and dynamic tool interface. This quest explores the foundational elements of the server and its tool integration layer, which provide the interactivity and dynamic capabilities for gamified code exploration. The combined architecture of the MCP server and the tools module allows seamless feature registration, user-command handling, and runtime validation. By diving into these files, you&#39;ll uncover the patterns behind efficient server-client communication and dynamic tool execution.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Registration Tracking</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register and validate supported tools from the <code class="inline-code">tools</code> module?</li>
<li>‚ö° <strong>Lifecycle Analysis</strong>: What key processes are initiated in the <code class="inline-code">run</code> and <code class="inline-code">main</code> functions, and how do they ensure the server runs smoothly?</li>
<li>üõ°Ô∏è <strong>Error Resilience and Validation</strong>: How does the MCP server handle invalid inputs and errors during tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core Server Architecture</h3>
<p>This file establishes the MCP server&#39;s structure and its fundamental functionalities. The <code class="inline-code">RepoAdventureServer</code> class is the centerpiece, defining the server&#39;s initialization, dynamic tool integration, tool execution flow, and operational lifecycle. Through its use of handlers and validation mechanisms, the server provides a modular, adaptable framework for processing tool-related commands.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures API endpoints for dynamic tool listing and execution. It ensures tools align with expected schemas and validates runtime inputs.</li>
<li><code class="inline-code">run</code>: Starts the MCP server, establishes transport, and implements caching using <code class="inline-code">repoAnalyzer</code> for efficient command handling.</li>
<li><code class="inline-code">main</code>: Bootstraps the server, handles termination signals, and manages unexpected errors gracefully to ensure uninterrupted service.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">// Function to set up tool listing and execution handlers
private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Provides a clean interface for dynamic registration of tool-related handlers.</li>
<li>Utilizes the <code class="inline-code">tools</code> object to dynamically process supported tools and their schemas.</li>
<li>Incorporates runtime validation using Zod schemas for robust client input validation.</li>
<li>Establishes error handling by categorizing known errors (<code class="inline-code">McpError</code>) and unexpected issues.</li>
<li>Sets groundwork for modular tool execution extensibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">// Function to start the MCP server and setup caching
async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Configures and starts the server using standard input/output transport.</li>
<li>Prints status updates for tracing server initialization phases.</li>
<li>Initiates background caching through <code class="inline-code">repoAnalyzer</code> for efficient project metadata retrieval.</li>
<li>Represents core operational readiness and pre-processing strategy.</li>
</ul>
<hr>
<pre><code class="language-typescript">// Entry point for the MCP server application
async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Bootstraps the <code class="inline-code">RepoAdventureServer</code> instance and initiates its execution through the <code class="inline-code">run</code> method.</li>
<li>Adds listeners for termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to ensure clean server shutdowns via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Includes an error management mechanism for unhandled promise rejections, logging issues robustly without disrupting the application.</li>
<li>Illustrates how lifecycle events ensure the server remains operationally resilient.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Definitions &amp; Entry Points</h3>
<p>The <code class="inline-code">tools.ts</code> file centralizes the available tools and exposes their respective handler functions. This modular design ensures scalable tool development and integration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates codebase analysis and provides theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Enables users to select a story theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Explores quests interactively, one at a time.</li>
<li><code class="inline-code">view_progress.handler</code>: Displays the current progress and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">// Exported tool handlers
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Provides a unified registry for all tools, maintaining a modular structure.</li>
<li>Links the exported identifiers (<code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, etc.) to their respective implementations for streamlined access.</li>
<li>Facilitates dynamic registration in the server via the <code class="inline-code">tools</code> object.</li>
<li>Highlights a clear, maintainable naming convention aligned with MCP&#39;s overall architecture.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Modularizing tools ensures easy addition or updates without affecting core server logic.</li>
<li>The Zod library strengthens input validation, making tools both robust and user-friendly.</li>
<li>An MCP server restart may be required after updating the toolset or configuration.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully implementing the MCP Tool Interface‚Äîyour code compilation soared past all logic gates with precision; Quest 2 unlocked at 20% progress‚Äîkeep refactoring toward greatness! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>