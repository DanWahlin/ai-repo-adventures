<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Engine of Infinite Stories - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Engine of Infinite Stories</h1>
<hr>
<p>In the digital expanse of creation, you stand at the gateway to the source of boundless tales. The Engine of Infinite Stories, a marvel of both logic and lore, pulses with fragments of forgotten narratives and dormant themes. Crafted with intricate pipelines and the essence of adaptive storytelling, its power lies untapped until a skilled seeker deciphers its mechanisms. As the Keeper of this engine, you are called to inspect its cogs and conduits, revealing how it weaves quests and selects themes to breathe life into any project.  </p>
<p>Adventure beckons, explorer ‚Äì wield the tools of the story generator and unlock its mysteries.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Narrative Assembly</strong>: How does <code class="inline-code">generateStoryAndQuests</code> synthesize the project context, theme, and other inputs to build a cohesive story structure with quests?</li>
<li>‚ö° <strong>Quest Handling Pipeline</strong>: How does <code class="inline-code">initializeAdventure</code> utilize internal state, configuration, and generator components to prepare quests for execution?</li>
<li>üõ°Ô∏è <strong>Fail-Safe Mechanisms</strong>: What safeguards are in place in <code class="inline-code">parseAdventureConfig</code> and <code class="inline-code">generateWithLLM</code> to handle invalid or missing configurations and responses?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Core manager for state and story integration</h3>
<p>This file defines <code class="inline-code">AdventureManager</code>, a class governing the orchestration of quest initialization and management. It combines configuration, generation, and validation to present players with seamless narratives.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Establishes the adventure by combining project data, selected themes, and generator output.</li>
<li><code class="inline-code">exploreQuest</code>: Processes and validates quest selections, ensuring prerequisites are met and caching is utilized for completed quests.</li>
<li><code class="inline-code">generateQuestContent</code>: Handles the detailed creation of quest content, utilizing configuration, project paths, and LLM-generated narratives.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;

  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the engine&#39;s state to ensure clean initialization for each session.</li>
<li>Configures the chosen theme and project-specific details, with support for custom themes.</li>
<li>Synthesizes the main story and quests through the <code class="inline-code">StoryGenerator</code>, integrating configuration and validations.</li>
<li>Merges configuration-driven quest files and enforces limits specified in the <code class="inline-code">adventure.config.json</code>.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Quest generation and storytelling logic</h3>
<p>The <code class="inline-code">StoryGenerator</code> class generates the primary narrative and quest structure, integrating dynamic themes and leveraging external input (LLM responses). It combines technical data with creative storytelling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Synthesizes the main story and associated quests using project context and selected themes.</li>
<li><code class="inline-code">generateQuestContent</code>: Generates detailed content for individual quests by combining configuration, code files, and story context.</li>
<li><code class="inline-code">generateWithLLM</code>: Validates and processes responses from the language model to maintain narrative coherence.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme,
  projectPath?: string
): Promise&lt;StoryResponse&gt; {
  const repomixContent = projectInfo.repomixContent || &#39;No repomix content available&#39;;
  let adventureGuidance = &#39;&#39;;

  if (projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
  }

  const prompt = loadStoryGenerationPrompt({
    theme,
    repomixContent,
    ...(adventureGuidance &amp;&amp; { adventureGuidance }),
  });

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt)
  );

  try {
    let cleanContent = response.content.trim();
    if (!cleanContent) throw new Error(&#39;Empty response for story generation&#39;);
    return parseMarkdownToStoryResponse(cleanContent);
  } catch (error) {
    throw new Error(`Invalid LLM response: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Gathers context from the project and formatted configuration for theme-guided storytelling.</li>
<li>Sends structured prompts to the LLM to generate the adventure&#39;s overarching story and associated quests.</li>
<li>Parses responses with strict validation to ensure error-free integration.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Config handling for adventures</h3>
<p>Handles the parsing, validation, and formatting of user-defined configuration files (<code class="inline-code">adventure.config.json</code>), enabling quest customization at runtime.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Loads and safely parses the JSON configuration, guarding against syntax errors.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Compiles a list of file paths referenced in the configuration, ensuring they exist.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Simplifies the config format for optimized prompt inclusion in stories.</li>
</ul>
<hr>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}

export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (quest.title &amp;&amp; Array.isArray(quest.files)) {
      formatted += `### ${quest.title}\nFiles: ${quest.files.map(f =&gt; f.path).join(&#39;, &#39;)}\n\n`;
    }
  }

  return formatted;
}
</code></pre>
<ul>
<li>Validates and parses configuration files to prevent runtime errors due to syntax or logic issues.</li>
<li>Extracts specific file paths for smoother integration with the quest engine&#39;s content pipeline.</li>
<li>Optimizes the configuration for LLM processing by structuring it in simpler terms for prompt formatting.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Trace Initialization</strong>: Follow the flow from <code class="inline-code">initializeAdventure</code> through the <code class="inline-code">StoryGenerator</code> to understand how each decision impacts the generated quests.</li>
<li><strong>Inspect Safeguards</strong>: Pay close attention to <code class="inline-code">parseAdventureConfig</code> and <code class="inline-code">generateWithLLM</code>, as these functions implement critical error handling.</li>
<li><strong>Explore Configuration</strong>: Test your modifications to <code class="inline-code">adventure.config.json</code> to see how they influence generated quests and themes.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully deploying &#39;Quest 2: The Engine of Infinite Stories&#39;‚Äîyour commit has been merged into the master branch of progress at 20%, keep coding towards the ultimate ‚≠ê of completion!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>