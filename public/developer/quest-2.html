<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Architecture of Adventures: An Exploration of a Developer's Toolkit</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Explore the inner workings of the MCP Tool Interface, an essential hub for interacting with interactive storytelling tools. This quest delves into how tools are dynamically listed, validated, and executed within a gamified code exploration environment. The files below reveal crucial foundations for managing tool requests and orchestrating codebase adventures.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Registration Dynamics</strong>: How are tools dynamically listed and validated during client requests?</li>
<li>‚ö° <strong>Server Initialization Insight</strong>: What patterns are used to initialize and connect the MCP server components?</li>
<li>üõ°Ô∏è <strong>Error Handling Mechanisms</strong>: How does the server handle validation errors and unexpected tool execution failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server Initialization and Tool Execution Management</h3>
<p>This file contains the core implementation for the MCP server, which manages tool requests, connects transport layers, and handles error reporting. With handlers defined for listing tools and executing them using dynamic runtime validation, it ensures seamless client interactions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tool listing and execution handlers, applying schema validation for error prevention.</li>
<li><code class="inline-code">run</code>: Initializes the MCP server, establishes transport connections, and pre-generates content caches for enhanced performance.</li>
<li><code class="inline-code">main</code>: Provides the entry point for server execution, orchestrating lifecycle management and signal handling for graceful shutdowns.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Defining and Exporting Tools</h3>
<p>This file defines the portfolio of MCP tools, each designed for specific actions within the gamified exploration system. It consolidates all tool logic for reuse, ensuring robust interactions during code exploration quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates codebase analysis and sets the stage for interactive storytelling.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows users to select a storytelling theme, generating tailored content.</li>
<li><code class="inline-code">explore_quest.handler</code>: Enables the exploration of individual quests within the codebase adventure system.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks quest completion status and provides insights into remaining objectives.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers handlers for tool listing and execution, ensuring robust schema validation using <code class="inline-code">zodToJsonSchema</code>.</li>
<li>Implements error handling to distinguish client errors (<code class="inline-code">MethodNotFound</code>, <code class="inline-code">InvalidParams</code>) and internal server failures (<code class="inline-code">InternalError</code>).</li>
<li>Demonstrates dynamic tool registration, highlighting modular design principles in action.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server and connects it via standard input/output transport, showcasing a lightweight communication approach.</li>
<li>Uses background pre-generation of content caches (<code class="inline-code">repoAnalyzer.preGenerate</code>) to optimize user experience and performance.</li>
<li>The focus on transport abstraction indicates flexibility for other communication strategies.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Defines lifecycle management, including signal handling for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to ensure graceful shutdowns via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Includes error logging for unhandled promise rejections to capture runtime anomalies without server interruptions.</li>
<li>Illustrates defensive programming practices, improving system reliability and user experience.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Consolidates tools into a single export for straightforward registration and management.</li>
<li>Demonstrates MCP naming convention adherence, ensuring consistent interface design.</li>
<li>Provides an abstraction layer over individual tool implementations, balancing modularity with maintainability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To understand tool validation, study <code class="inline-code">zodToJsonSchema</code> usage and its role in runtime schema transformations.</li>
<li>Investigate how <code class="inline-code">server.setRequestHandler</code> bridges tool logic with client queries, implementing dynamic functionality.</li>
<li>Analyze error handling constructs to learn best practices for reporting and recovery mechanisms in server applications.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Achievement unlocked: Quest 2 - MCP Tool Interface integrated successfully; your stack is optimized, progress committed, and you&#39;re officially 20% closer to shipping brilliance‚Äîkeep coding like a ‚≠ê!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>