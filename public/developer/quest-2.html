<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Dive deep into the modular system of the MCP Tool Interface! This interface empowers developers by integrating tools for code repository exploration. With dynamic handlers and gamified execution logic, the <code class="inline-code">RepoAdventureServer</code> class is a key component to understand for extending functionalities or troubleshooting issues. Let&#39;s explore how handlers interact with tools and dissect the mechanics behind execution flows.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools with schemas for execution?  </li>
<li>‚ö° <strong>Flow Synchronization</strong>: What initialization steps does <code class="inline-code">run</code> undertake to prepare the MCP server for operations?  </li>
<li>üõ°Ô∏è <strong>Error Defense</strong>: How does the <code class="inline-code">main</code> function handle fatal and non-fatal errors to ensure server reliability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server implementation</h3>
<p>This file defines the <code class="inline-code">RepoAdventureServer</code>, a core class responsible for initializing and connecting the MCP server. It dynamically registers tool handlers and executes tools based on user inputs, ensuring schema validation and robust error handling. Through its methods, the server maintains operational control and provides a seamless interface for exploring code repositories.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools, validates inputs, and facilitates execution. Ensures tools are listed securely and schemas are accessible in JSON format.</li>
<li><code class="inline-code">run</code>: Initializes the server transport, starts background repomix preparation, and connects the server to user inputs.</li>
<li><code class="inline-code">main</code>: Handles startup logic, graceful shutdown, and ensures the server remains operational, even amidst unhandled promises.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically builds a list of tools for execution, ensuring schemas are in JSON format.</li>
<li>Validates tool inputs against Zod schemas, reducing runtime errors.</li>
<li>Implements robust error handling to return detailed error messages for incorrect parameters.</li>
<li>Facilitates secure registrations and dependable execution of tools.</li>
<li>Centralizes handler logic for dynamic tool interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes server transport for connection via <code class="inline-code">StdioServerTransport</code>.</li>
<li>Logs operational status to inform users of server readiness.</li>
<li>Pre-generates repomix content in the background, accelerating subsequent requests.</li>
<li>Prepares cached data to handle large repositories efficiently.</li>
<li>Ensures initialization steps are streamlined and thorough.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server via <code class="inline-code">RepoAdventureServer</code> and ensures components are ready.</li>
<li>Implements signal-based triggers for graceful shutdown to prevent abrupt termination.</li>
<li>Logs unhandled promises without stopping the server, maintaining operational continuity.</li>
<li>Catches startup errors and exits cleanly if initialization fails.</li>
<li>Offers comprehensive error diagnostics to support troubleshooting.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool definitions and exports</h3>
<p>This file organizes the tools used by the MCP interface, exporting them through a centralized object and ensuring compatibility with the server setup. Each tool handler contributes unique functionality to the gamified exploration system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and initializes exploration.</li>
<li><code class="inline-code">choose_theme.handler</code>: Matches exploration prompts to selected themes for immersive storytelling.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes individual quests and dynamically fetches progress.</li>
<li><code class="inline-code">view_progress.handler</code>: Signals completion percentages for accessibility and progress review.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Organizes tools for clean registration and manageable imports in the server.</li>
<li>Maps tool logic (<code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, etc.) to MCP-compatible handlers seamlessly.</li>
<li>Provides reusable export structure to enhance maintainability.</li>
<li>Ensures all exported tools are self-documented for MCP clients.</li>
<li>Streamlines exploration flow through clear definitions and dependencies.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers</code> to identify integration patterns between Zod schemas and dynamic tools.</li>
<li>Review caching logic in <code class="inline-code">run</code> to optimize pre-generated content mechanisms for large projects.</li>
<li>Inspect tool handler exports in <code class="inline-code">tools.ts</code> to extend MCP functionalities with new tools.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully completing Quest 2: MCP Tool Interface‚Äîyour codebase is now 20% refactored towards mastery, a true ‚≠ê milestone worthy of a commit-worthy triumph!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>