<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Code Oracle's Insight - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Mythos of the Codebase Chronicles</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Code Oracle&#39;s Insight</h1>
<hr>
<p>In the land of coded tales, an ancient entity holds the secrets to perfect story generation: the Code Oracle. This being resides within a triad of magical scripts, responsible for crafting quests, analyzing repositories, and configuring adventures. Your journey will lead you to unveil the inner workings of these mechanisms, as you study their power and explore their interconnected nature. Will you unlock the Oracle&#39;s wisdom to shape the ultimate Repository Adventure Engine?</p>
<p>Adventure awaits, brave coder! Equip your intellect and dive into these arcane scripts.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Oracle&#39;s Invocation</strong>: How does the <code class="inline-code">initializeAdventure</code> method integrate project information, themes, and configurations to craft a coding journey?</li>
<li>‚ö° <strong>Story Alchemy</strong>: What steps are involved in <code class="inline-code">generateStoryAndQuests</code>, and how does it ensure the alignment of themes, generated stories, and quests?</li>
<li>üõ°Ô∏è <strong>Configuration Sage</strong>: How does <code class="inline-code">parseAdventureConfig</code> validate and process the adventure configuration file to guide quest generation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Responsible for managing the state and flow of adventures, calling foundational methods to generate and execute quests.</h3>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Loads project context, applies themes, parses configurations, and generates the main story and its quests.</li>
<li><code class="inline-code">exploreQuest</code>: Handles user input validation and executes the selected quest by utilizing caching for efficiency.</li>
<li><code class="inline-code">progressPercentage</code>: Provides a dynamic view of completion progress based on completed quests.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Houses the logic for creating stories and quests, utilizing language models to ensure the output aligns with themes and project data.</h3>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Executes the story and quest generation process using project context and themes.</li>
<li><code class="inline-code">generateQuestContent</code>: Produces detailed quest narratives and exploration prompts, incorporating relevant file snippets.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Converts markdown responses from the model into a structured format for stories and quests.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Provides utilities for handling the adventure configuration file, ensuring smooth access and processing.</h3>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Reads and parses the adventure configuration file to extract JSON data.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Retrieves all file paths referenced in the configuration.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Optimizes configuration data for contextual usage in prompts.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
    projectInfo: ProjectInfo, 
    theme: AdventureTheme, 
    projectPath?: string,
    customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
    this.state.reset();
    this.state.projectInfo = projectInfo;
    this.state.currentTheme = theme;
    this.state.projectPath = projectPath || process.cwd();

    if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
        this.storyGenerator.setCustomTheme(customThemeData);
    }

    const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);

    this.state.title = storyResponse.title;
    this.state.story = typeof storyResponse.story === &#39;string&#39; ? storyResponse.story : storyResponse.story.content;
    this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
    this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

    return this.formatStoryWithQuests({
        ...storyResponse,
        quests: this.state.quests
    });
}
</code></pre>
<ul>
<li>This method initializes the adventure by resetting state, applying project and theme data, and generating stories and quests.</li>
<li>It uses <code class="inline-code">mergeQuestFilesFromConfig</code> to align generated quests with configuration data.</li>
<li>Custom themes and configurations are validated and applied effectively.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
    this.currentProject = projectInfo;
    this.projectPath = projectPath;
    
    const validatedTheme = this.validateTheme(theme);
    return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Initiates the story and quest generation process based on project context and themes.</li>
<li>Calls <code class="inline-code">generateWithLLM</code> to delegate the task of generating coherent results aligned with validated themes.</li>
<li>Ensures uniformity by setting <code class="inline-code">currentProject</code> and <code class="inline-code">projectPath</code>.</li>
</ul>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
    const tokens = marked.lexer(markdownContent);
    let title = &#39;&#39;;
    let story = &#39;&#39;;
    const quests: Quest[] = [];
    let currentSection = &#39;&#39;;
    let currentQuest: Partial&lt;Quest&gt; = {};
    let titleFound = false;

    for (const token of tokens) {
        if (token.type === &#39;heading&#39;) {
            if (token.depth === 1) {
                title = token.text;
                titleFound = true;
                currentSection = &#39;story&#39;;
            } else if (token.depth === 3) {
                if (currentQuest.title &amp;&amp; currentQuest.description) {
                    quests.push({
                        id: `quest-${quests.length + 1}`,
                        title: currentQuest.title,
                        description: currentQuest.description,
                        codeFiles: currentQuest.codeFiles || []
                    });
                }
                currentQuest = { title: token.text, description: &#39;&#39;, codeFiles: [] };
            }
        } else if (token.type === &#39;paragraph&#39; &amp;&amp; currentQuest.title) {
            currentQuest.description += token.text + &#39;\n\n&#39;;
        }
    }

    if (currentQuest.title &amp;&amp; currentQuest.description) {
        quests.push({
            id: `quest-${quests.length + 1}`,
            title: currentQuest.title,
            description: currentQuest.description.trim(),
            codeFiles: currentQuest.codeFiles || []
        });
    }

    return {
        title: title.trim() || &#39;Adventure&#39;,
        story: story.trim() || &#39;Welcome to your coding adventure!&#39;,
        quests
    };
}
</code></pre>
<ul>
<li>Converts markdown content into a structured representation of stories and quests.</li>
<li>Extracts key data like <code class="inline-code">title</code> and <code class="inline-code">quests</code> while handling nested structures and section demarcations.</li>
<li>Ensures seamless parsing of content generated by the language model.</li>
</ul>
<hr>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
    const raw = loadAdventureConfig(projectPath);
    if (!raw) return null;
    try {
        return JSON.parse(raw);
    } catch {
        return null;
    }
}
</code></pre>
<ul>
<li>Parses the adventure configuration file into an object or returns <code class="inline-code">null</code> on failure.</li>
<li>Centralizes JSON parsing for consistent validation across the system.</li>
<li>Handles missing or malformed files gracefully to avoid runtime interruptions.</li>
</ul>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
    const parsed = parseAdventureConfig(projectPath);
    if (!parsed || typeof parsed !== &#39;object&#39;) return [];
    const unique = new Set&lt;string&gt;();
    const stack: any[] = [parsed];

    while (stack.length) {
        const node = stack.pop();
        if (typeof node.path === &#39;string&#39; &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path))) {
            unique.add(node.path);
        }
        const children = Array.isArray(node) ? node : Object.values(node);
        children.forEach(child =&gt; child &amp;&amp; typeof child === &#39;object&#39; &amp;&amp; stack.push(child));
    }

    return Array.from(unique);
}
</code></pre>
<ul>
<li>Extracts file paths referenced across the parsed adventure configuration.</li>
<li>Avoids duplication using a <code class="inline-code">Set</code> and validates paths to prevent errors.</li>
<li>Facilitates targeted quest generation by providing precise file references.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Focus on how modular design promotes separation of concerns between adventure management, story generation, and configuration parsing.</li>
<li>Pay attention to techniques for integrating language model outputs, such as structured markdown parsing.</li>
<li>Explore the alignment of configuration data with dynamically generated quests to enhance user experience.</li>
</ul>
<hr>
<p>Congratulations on completing &quot;Quest 2: The Code Oracle&#39;s Insight&quot;! Your understanding of these mechanisms will empower you to shape even more compelling adventures. Onward to the next challenge!</p>
<p>Deployment successful: You&#39;ve debugged the Oracle&#39;s systems, unlocked new algorithms, and achieved a 20% codebase milestone‚Äîkeep refactoring brilliance into the architecture of Quest 3! ‚ö°üöÄüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>