<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Interactive Toolset - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Repository Exploration: The Architecture Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Interactive Toolset</h1>
<hr>
<p>Explore the architectural intricacies of the MCP Tool Interface, where code repositories transform into interactive adventures. This quest focuses on the modular design of the server and tools integration, offering insights into dynamic tool handlers and a unified command interface. Delve into the methods that define and execute tools while maintaining robust error handling mechanisms.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Calibration</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically manage the MCP tool interfaces and schemas for execution?</li>
<li>‚ö° <strong>Execution Flow</strong>: What is the lifecycle of <code class="inline-code">RepoAdventureServer.run</code>, and how does it orchestrate server startup and preprocessing tasks?</li>
<li>üõ°Ô∏è <strong>Failure Containment</strong>: How does <code class="inline-code">main</code> ensure graceful shutdown and error handling during MCP server operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Implementation</h3>
<p>The <code class="inline-code">server.ts</code> file establishes the MCP server by linking tools, error handling mechanisms, and transport protocols. Key operations include dynamic requests setup through <code class="inline-code">setupHandlers</code>, lifecycle management in <code class="inline-code">run</code>, and main startup. These functions are integral to the modular pipeline, allowing seamless communication between the MCP client and tools tailored for codebase exploration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools for listing and execution, ensuring schemas are validated and tools are invoked correctly.</li>
<li><code class="inline-code">run</code>: Starts server transport, connects it to the MCP server, and triggers critical pre-generation processes for content caching and analysis.</li>
<li><code class="inline-code">main</code>: Serves as the entry point, managing error logging, graceful shutdowns, and initialization of the server instance.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps MCP tools to handlers, leveraging <code class="inline-code">zodToJsonSchema</code> for schema conversions and validation.</li>
<li>Implements error handling through custom <code class="inline-code">McpError</code> exceptions, ensuring consistent error reporting and recoverability.</li>
<li>Enhances adaptability by decoupling tool definitions from specific methods, enabling scalable extensions and alterations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Engages <code class="inline-code">StdioServerTransport</code> for standardized input/output communication.</li>
<li>Prepares content cache in the background using <code class="inline-code">repoAnalyzer.preGenerate</code> for optimized tool execution.</li>
<li>Simplifies server start-up while laying the groundwork for future user commands.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Monitors termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and promises for stable server operations.</li>
<li>Implements proactive error logging for unhandled promise rejections without compromising server functionality.</li>
<li>Consolidates server initialization, ensuring minimal disruption in case of unexpected failures.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tools Interface</h3>
<p>The <code class="inline-code">tools.ts</code> file provides modular definitions for each MCP tool, exporting them in a unified structure. This centralization simplifies tool registrations and extensions by using consistent schemas and handlers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes repositories and initiates the quest creation workflow.</li>
<li><code class="inline-code">choose_theme.handler</code>: Constructs quests dynamically based on user-selected themes.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes single-quest exploration by targeting specific code segments.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks user completion status across quests, aiding progress monitoring.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Aggregates tool exports into a single <code class="inline-code">tools</code> object for simplified registration and dynamic invocation.</li>
<li>Enhances modular flexibility by separating tool definitions by functionality while maintaining centralized control.</li>
<li>Serves as the primary entry point for connecting tool utilities to the MCP server, ensuring consistency across operations.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Keep an eye on schema validation patterns to identify reusable approaches in other modules.</li>
<li>Investigate <code class="inline-code">McpError</code> usage for insights into designing robust error-handling frameworks.</li>
<li>Consider cross-referencing tool handlers with server methods to understand their integration depth.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on completing Quest 2: MCP Interactive Toolset‚Äîyour codebase now encapsulates 20% progress üöÄ, refactored into triumph and ready to scale for the next milestone! ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>