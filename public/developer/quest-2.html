<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Forge of Quests - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Realm of Repository Adventures</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Forge of Quests</h1>
<hr>
<p>Brave adventurer, you now embark on a journey into the Forge of Quests, where the art of quest creation is revealed‚Äîand its power harnessed. Within the fiery depths of the Quest Generation Engine, code is transformed into immersive and challenging narratives. It is here that the core functionality of the adventure system lies, where quests are sparked to life and the threads of stories are intricately woven. Stay vigilant, for the secrets of initialization, exploration, and validation are known only to those who dare to forge ahead.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Spark of Initiation</strong>: How does the AdventureManager&#39;s <code class="inline-code">initializeAdventure</code> method set the stage by combining project data, themes, and quest configurations?</li>
<li>‚ö° <strong>The Flow of Exploration</strong>: What happens inside <code class="inline-code">exploreQuest</code>, and how does the system handle quest interactions such as validation and caching?</li>
<li>üõ°Ô∏è <strong>The Role of Validation</strong>: How does <code class="inline-code">parseAdventureConfig</code> ensure that adventure configuration files provide the correct context, and what happens if they contain errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> AdventureManager and AdventureState</h3>
<p>The <code class="inline-code">adventure-manager.ts</code> file defines the <code class="inline-code">AdventureManager</code> class and the <code class="inline-code">AdventureState</code> structure, orchestrating the creation, progression, and exploration of quests. Key highlights of this file include the initialization of adventures, validation of user input, and the execution of quests using cached or newly generated content. This file represents the central hub of the quest generation process.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Configures the adventure state, including the story, quests, and themes by combining project information and AI-generated content.</li>
<li><code class="inline-code">exploreQuest</code>: Handles the user‚Äôs choice for a quest, validating the input and returning cached results or generating new content.</li>
<li><code class="inline-code">validateAndSanitizeChoice</code>: Ensures user selections are valid through the <code class="inline-code">validateAdventureChoice</code> function to prevent errors or unexpected inputs.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>This method initializes the entire adventure by setting up project details, selecting themes, and generating the story/quests.</li>
<li>AI integration is tightly coupled through <code class="inline-code">generateStoryAndQuests</code>, producing a dynamic narrative experience.</li>
<li>Ensures adventure consistency by enforcing quest limits and merging additional configurations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Manages user interaction with quests, determining intent and handling invalid inputs gracefully.</li>
<li>Validates user input through <code class="inline-code">validateAndSanitizeChoice</code> to avoid crashes or unexpected results.</li>
<li>Supports progress requests and quest execution, with flexibility for revisiting cached quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndSanitizeChoice(input: string): string {
  try {
    return validateAdventureChoice(input);
  } catch (error) {
    throw new Error(`Invalid adventure choice: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
  }
}
</code></pre>
<ul>
<li>Ensures the integrity of user inputs via the <code class="inline-code">validateAdventureChoice</code> function.</li>
<li>Provides user-friendly error handling to guide adventurers toward correct input formats.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Config Loader and Parser</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file focuses on reading, parsing, and validating the <code class="inline-code">adventure.config.json</code> file. It plays a crucial role in ensuring the adventure system adapts to different projects and scenarios by extracting and formatting the configuration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig</code>: Safely parses the adventure configuration file to load quest-related data and prevents system failure on invalid files.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Gathers all relevant file paths from the configuration, ensuring only existing paths are returned.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Formats the configuration for efficient AI processing, removing redundancy for clarity.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Focuses on error safety when parsing the adventure configuration.</li>
<li>Returns meaningful data when parsing succeeds, while gracefully returning <code class="inline-code">null</code> on failure to maintain system stability.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    // Extract and validate path
    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    // Add children to stack
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Implements a recursive approach to traverse and extract valid file paths from deeply nested configurations.</li>
<li>Ensures file paths exist before inclusion, reducing unnecessary processing on invalid paths.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    
    // Just file paths, no verbose descriptions
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
    
    // Just function names, no descriptions
    const functions = quest.files
      .flatMap((f: any) =&gt; f.highlights || [])
      .map((h: any) =&gt; h.name)
      .filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Outputs a streamlined configuration format optimized for use in AI prompts.</li>
<li>Ignores redundant descriptions, emphasizing file paths and function names for direct exploration.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the quest structure as a roadmap to deepen your understanding of quest initialization, input validation, and configuration handling.</li>
<li>Observe how modularized designs enable separating concerns for story generation and configuration parsing.</li>
<li>Consider how error handling strategies in <code class="inline-code">validateAndSanitizeChoice</code> and <code class="inline-code">parseAdventureConfig</code> contribute to system resilience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully deploying Quest 2: The Forge of Quests‚Äîyour codebase of skills is now 20% compiled, building momentum toward the epic 100% refactor! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>