<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Forge the Quest Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Spacebound Repository Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h2>Quest 2: Forge the Quest Engine</h2>
<p>In this chapter, you will examine the quest generation engine that powers journey setup, execution, and configuration guidance. The focus is on how the system initializes adventures with repository context, renders quests with LLM prompts, and applies configuration from <code class="inline-code">adventure.config.json</code>. Follow the investigation prompts to understand data flow, validation, timeout handling, and how configuration is fused into generated content. The objectives are exploration guides to use while reading the code, not prerequisites. All code references and highlights are scoped to the files below.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">AdventureManager.initializeAdventure</code> integrate formatted config guidance and enforce quest counts when preparing the initial story and quest list?</li>
<li>‚ö° Reactor Flow: In <code class="inline-code">StoryGenerator.generateQuestContent</code>, how are adventure config data and custom instructions incorporated into prompts, and how is response content sanitized via delimiters?</li>
<li>üõ°Ô∏è Safety Protocols: How do <code class="inline-code">AdventureState.progressPercentage</code> and <code class="inline-code">AdventureManager.exploreQuest</code> constrain operations using validation, caching, and prerequisite checks for reliable execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Orchestrates story initialization, quest selection, execution, caching, and progress reporting</h3>
<p>This module coordinates the end-to-end lifecycle of an adventure. <code class="inline-code">AdventureManager.initializeAdventure</code> resets state, sets theme and project path, configures a custom theme on the <code class="inline-code">StoryGenerator</code> when needed, retrieves the story and initial quests, then merges quest-specific files from <code class="inline-code">adventure.config.json</code>. It also enforces quest count limits based on configuration. <code class="inline-code">AdventureManager.exploreQuest</code> validates user choice input, supports progress-view requests, locates a quest by number, ID, or title, and executes it with caching to avoid repeated LLM calls. <code class="inline-code">AdventureState.progressPercentage</code> provides a simple but important metric for progress UI and completion summaries. The execution path defers content generation to <code class="inline-code">StoryGenerator.generateQuestContent</code>, which may use targeted repository slices. Additional safeguards include prerequisite validation through <code class="inline-code">validateQuestPrerequisites</code>, result formatting for narrative and choices, and a consistent progress view through <code class="inline-code">getProgress</code>. These patterns ensure predictable behavior, robust handling of configuration, and smooth user navigation across quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">AdventureManager.initializeAdventure</code> prepares the story and quests, merges file targets from config, and enforces config-defined quest counts for consistency.</li>
<li><code class="inline-code">AdventureManager.exploreQuest</code> validates choices, supports progress queries, resolves quest selection, executes with caching, and returns structured results.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code> computes completion progress for UI and summaries, ensuring a consistent metric across the system.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Initializes a new run by resetting state and storing project/theme context.</li>
<li>Applies <code class="inline-code">customThemeData</code> only when <code class="inline-code">theme</code> is <code class="inline-code">custom</code>, delegating details to <code class="inline-code">StoryGenerator</code>.</li>
<li>Generates story and quests via <code class="inline-code">StoryGenerator.generateStoryAndQuests</code>, then merges config file targets.</li>
<li>Enforces config-defined quest count to align UI with authored expectations.</li>
<li>Returns a formatted markdown story with the finalized quest list for display.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates and normalizes user input before any processing.</li>
<li>Supports a special ‚Äúview progress‚Äù path by interpreting text and numeric inputs.</li>
<li>Resolves quests by number, ID, or title, improving UX flexibility.</li>
<li>Executes the selected quest and returns a structured <code class="inline-code">AdventureResult</code>.</li>
<li>Centralizes navigation concerns, keeping execution and rendering concerns separate.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Provides a standardized completion metric across UI and completion summaries.</li>
<li>Uses integer rounding for consistent presentation.</li>
<li>Handles zero-quest scenarios safely by returning 0.</li>
<li>Serves as a simple state-derived property avoiding repeated calculation code.</li>
<li>Enables progress reporting without extra parameters or external state.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Generates stories and quests, crafts prompts, validates output, and sanitizes LLM content</h3>
<p><code class="inline-code">StoryGenerator</code> is responsible for transforming repository context and configuration into story and quest content. <code class="inline-code">generateQuestContent</code> constructs a prompt that includes formatted adventure config and optional custom instructions, calls the LLM with a timeout boundary, and sanitizes the output by extracting text between explicit delimiters. <code class="inline-code">generateWithLLM</code> performs the initial story and quest creation, drawing from repomix context and optional config, then parses markdown into a structured <code class="inline-code">StoryResponse</code> validated with Zod. The design uses <code class="inline-code">withTimeout</code> to guard against hanging requests and <code class="inline-code">removeLLMMetaCommentary</code> to strip non-content boilerplate. These patterns support reliable content generation and predictable formatting for downstream rendering.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">StoryGenerator.generateQuestContent</code> builds context-rich prompts from code and config, applies timeouts, and cleans the LLM response with delimiter-based extraction.</li>
<li><code class="inline-code">StoryGenerator.generateStoryAndQuests</code> validates theme, stores project context, and delegates to LLM generation with config guidance.</li>
<li><code class="inline-code">StoryGenerator.generateCompletionSummary</code> produces a short progress-aware message tuned to the active theme and custom vocabulary hints.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n

Quest 2: Forge the Quest Engine successfully compiled and deployed‚Äîgreat job modularizing core logic, validating interfaces, and optimizing the execution pipeline; you‚Äôve achieved a key milestone at 20% completion, proving production-readiness and momentum toward the full roadmap ‚≠êüöÄ‚ö°
</code></pre>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>