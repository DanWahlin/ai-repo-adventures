<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Call of the MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: A Tale of Code and Quests</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Call of the MCP Tool Interface</h1>
<hr>
<p>In a sprawling kingdom of interconnected programs and libraries, brave adventurers seek to command the mystical MCP Tool Interface. A legendary artifact, it orchestrates interactive storytelling and repository exploration. To wield its power, one must navigate the intricate interplay of server initialization, dynamic tool management, and graceful execution. The trails of code lead through the <code class="inline-code">RepoAdventureServer</code> and the mighty toolsets, where secrets of automation lie dormant, awaiting discovery. The Repository‚Äôs first challenge begins here - are you ready to decode its mysteries?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Manifest Decoding</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically generate and validate available tools in the MCP system?</li>
<li>‚ö° <strong>Server Activation</strong>: What steps are taken in the <code class="inline-code">run</code> method to initialize and prepare the RepoAdventure MCP server for use?</li>
<li>üõ°Ô∏è <strong>Graceful Shutdown Protocol</strong>: How does the <code class="inline-code">main</code> function handle server errors, shutdowns, and unhandled exceptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The MCP Server Core</h3>
<p>This file contains the core server logic, managing initialization, tool handling, and execution of the MCP environment. The <code class="inline-code">RepoAdventureServer</code> class is the heart of the operation, defining server behavior using the <code class="inline-code">setupHandlers</code> and <code class="inline-code">run</code> methods. Error resilience is woven into the <code class="inline-code">main</code> function to ensure a smooth story-building experience. The server interfaces dynamically with tools and pre-generates contextual content for performance optimization.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Sets up dynamic request handlers for listing and executing tools, ensuring schema-based validation for arguments.</li>
<li><code class="inline-code">run</code>: Initializes the server, connects it to the communication transport, and pre-generates content to optimize processing time.</li>
<li><code class="inline-code">main</code>: Manages server lifecycle, handling startup, graceful shutdown, and unhandled promise rejections with robust error management.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers request handlers to manage tool listing and execution queries.</li>
<li>Converts tool schemas to JSON schema format for validation, simplifying integration.</li>
<li>Ensures arguments are validated using Zod schemas, preventing runtime errors.</li>
<li>Handles errors consistently, distinguishing between user and internal errors.</li>
<li>Highlights extensibility through the addition of new tools in the <code class="inline-code">tools</code> map.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server transport for communication, ensuring compatibility with dynamic interfaces.</li>
<li>Logs server startup messages to assist with debugging and monitoring.</li>
<li>Prepares the working environment by generating cache content for efficient operations.</li>
<li>Ensures non-blocking initialization by running pre-generation tasks alongside server setup.</li>
<li>Introduces project path awareness to isolate settings to the active working directory.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates an instance of the <code class="inline-code">RepoAdventureServer</code>, kickstarting the application&#39;s core logic.</li>
<li>Ensures a clean shutdown through signal-specific callbacks for termination signals.</li>
<li>Logs unhandled promise rejections, providing diagnostic insights without halting the server.</li>
<li>Encapsulates startup logic in a try-catch block to handle runtime errors gracefully.</li>
<li>Validates the robustness of server lifecycle management even in unpredictable situations.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as a template for adding more tools in the future.</li>
<li>Always validate input schemas to mitigate risks from invalid or unexpected data.</li>
<li>Modify the <code class="inline-code">run</code> function to enable additional preloading steps specific to your environment.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>You&#39;ve successfully instantiated your developer journey by debugging the MCP Tool Interface with precision‚ÄîQuest 1 complete, üöÄ now refactor forward toward mastery!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>