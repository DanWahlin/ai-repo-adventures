<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Nexus of MCP Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Nexus of MCP Tools</h1>
<hr>
<p>The world of code repositories hides its mysteries, but at its core lies the Nexus ‚Äì a hub where the tools of creation and exploration intertwine. Within a gamified adventure system, those who harness this power can dynamically forge tools and deploy quests that bring clarity to the labyrinth of code. To activate this potential, you must first master the key interfaces that define the Nexus. Venture forth, brave keeper, as you delve into the architecture of the Repo Adventure Server and its dynamic tools!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Listing Rituals</strong>: How does <code class="inline-code">setupHandlers</code> dynamically assemble and validate the list of tools made available by the server?</li>
<li>‚ö° <strong>Server Activation Flow</strong>: When <code class="inline-code">run</code> is called, what flow initiates the Nexus server and connects it to its tool transport layer?</li>
<li>üõ°Ô∏è <strong>Tool Call Protection</strong>: How does the server validate tool requests and ensure appropriate error handling in <code class="inline-code">setupHandlers</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core server setup and dynamic invocation management</h3>
<p>This file establishes a foundational gamified development server. It provides handlers for managing tools dynamically, validates user input using schemas, and ensures safe interactions with repository adventures. The critical highlights include:</p>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists tools, validates input with schemas, and enables handlers for interactive commands.</li>
<li><code class="inline-code">run</code>: Activates the server and pre-generates content for seamless experiences, warming up the cache ahead of user commands.</li>
<li><code class="inline-code">main</code>: The top-level entry point for startup, handling signals gracefully and defining resilience to promise rejections.</li>
</ul>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools using their schema and securely validates input requests, connecting users to appropriate handlers.</li>
<li><code class="inline-code">run</code> sets up the standard I/O-based transport server and triggers pre-generation of the repository&#39;s context, optimizing performance for interactive exploration.</li>
<li><code class="inline-code">main</code> ensures robust server initialization, gracefully handles shutdown signals, and designs error resilience mechanisms.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of valid tools by extracting metadata and schemas.</li>
<li>Validates input data using Zod schemas to enforce structure and format correctness.</li>
<li>Uses <code class="inline-code">McpError</code> for robust yet user-friendly error handling during execution.</li>
<li>Ensures that tool execution internally adheres to the declared contracts between client and server.</li>
<li>Models secure and extensible design for interactive tool invocation at runtime.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes and connects the Nexus server via standard I/O transport for bidirectional communication.</li>
<li>Implements logging to provide visibility into server startup processes and pre-generation status.</li>
<li>Warm-up functionality ensures that repository analysis is completed in the background, reducing latency during commands.</li>
<li>Adopts asynchronous handling to prevent blocking while waiting for client commands.</li>
<li>Demonstrates best practices in preparing data while keeping the server actively responsive.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Configures graceful termination for signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, ensuring proper cleanup.</li>
<li>Resilient to <code class="inline-code">unhandledRejection</code> events, prioritizing server uptime without premature shutdowns.</li>
<li>Coordinates startup logic by instantiating the server class and calling its entry point, <code class="inline-code">run</code>.</li>
<li>Incorporates structured error logging to aid debugging in case of startup failures.</li>
<li>Illustrates high fault tolerance, aligning it with realistic scenarios in server operations.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">ListToolsRequestSchema</code> to observe how tools are dynamically defined and validated.</li>
<li>Explore how Zod schemas enforce strict input validation in <code class="inline-code">setupHandlers</code>.</li>
<li>To understand signal handling, map <code class="inline-code">gracefulShutdown</code> to its invocation in <code class="inline-code">main</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>You‚Äôve successfully deployed your first module in the Quest Framework‚ÄîQuest 1: The Nexus of MCP Tools is now committed to the repository of progress‚Äîstellar work, developer! üöÄ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>