<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Developer Documentation Generator for Repository Analysis</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<h2>Technical Overview</h2>
<p>The MCP Tool Interface handles the registration, validation, and execution of interactive tools within the MCP server. It enables dynamic listing and invocation of tools using well-defined schemas. This module is implemented in <strong>packages/mcp/src/server.ts</strong> for server operations and <strong>packages/mcp/src/tools.ts</strong> for tool definitions. This section focuses on the communication logic related to tool management and the server&#39;s request/response infrastructure.</p>
<h2>Key Components</h2>
<ul>
<li><strong>RepoAdventureServer</strong>: Primary class for initializing the MCP server, handling requests for tool listing and execution.<ul>
<li><code class="inline-code">setupHandlers()</code>: Defines server request handlers for dynamic tool management.</li>
<li><code class="inline-code">run()</code>: Starts the server and initializes pre-generation of project data.</li>
</ul>
</li>
<li><strong>tools</strong>: Defined in <strong>packages/mcp/src/tools.ts</strong>, this exports individual tools as well as a consolidated module for use in the server.<ul>
<li><code class="inline-code">start_adventure</code>: Tool for analyzing a codebase and initiating an exploration workflow.</li>
<li><code class="inline-code">choose_theme</code>: Tool for customizing quests based on user-selected themes.</li>
<li><code class="inline-code">explore_quest</code>: Tool for progressing through generated quests.</li>
<li><code class="inline-code">view_progress</code>: Tool for tracking and visualizing progress through quests.</li>
</ul>
</li>
</ul>
<h2>Implementation Details</h2>
<p><strong>RepoAdventureServer:</strong></p>
<ul>
<li>The <code class="inline-code">RepoAdventureServer</code> class uses the <code class="inline-code">@modelcontextprotocol/sdk</code> library to create a server instance with:<ul>
<li>Static metadata (<code class="inline-code">name</code>, <code class="inline-code">version</code>, <code class="inline-code">description</code>) that identifies the server.</li>
<li>Dynamically determined tool capabilities, populated at runtime.</li>
</ul>
</li>
<li>Tools are loaded dynamically from <strong>packages/mcp/src/tools.ts</strong> and passed through <code class="inline-code">zodToJsonSchema</code> to validate input schemas and generate machine-readable specifications.</li>
<li>Request handlers for tools:<ul>
<li><code class="inline-code">ListToolsRequestSchema</code>: Enumerates available tools along with their descriptions and input schemas.</li>
<li><code class="inline-code">CallToolRequestSchema</code>: Invokes a given tool, ensuring its input matches the defined Zod schema.</li>
</ul>
</li>
</ul>
<p><strong>Error Handling:</strong></p>
<ul>
<li>Custom <code class="inline-code">McpError</code> instances, such as <code class="inline-code">ErrorCode.MethodNotFound</code> and <code class="inline-code">ErrorCode.InvalidParams</code>, encapsulate error types and messages for client communication.</li>
<li>The server gracefully handles runtime failures, including invalid tool execution and unexpected errors, falling back to <code class="inline-code">ErrorCode.InternalError</code> for unclassified issues.</li>
</ul>
<p><strong>tools.ts:</strong></p>
<ul>
<li>Tools follow a modular structure. Each tool exports:<ul>
<li>A <code class="inline-code">schema</code> (constructed using Zod): Defines tool-specific input validation rules.</li>
<li>A <code class="inline-code">handler</code>: Processes validated input and performs the tool&#39;s function.</li>
</ul>
</li>
<li>All tools are consolidated into the <code class="inline-code">tools</code> export for registration.</li>
</ul>
<h2>Code Examples</h2>
<p><strong>Defining a Request Handler for Tool Execution:</strong></p>
<pre><code class="language-typescript">this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
  try {
    const { name, arguments: args } = request.params;

    if (!(name in tools)) {
      throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
    }

    const tool = tools[name as keyof typeof tools];
    const validationResult = tool.schema.safeParse(args);
    if (!validationResult.success) {
      const errorMessages = validationResult.error.issues.map((err) =&gt;
        `${err.path.join(&#39;.&#39;)}: ${err.message}`
      ).join(&#39;, &#39;);
      throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
    }

    return await tool.handler(validationResult.data as any);
  } catch (error) {
    if (error instanceof McpError) {
      throw error;
    }
    throw new McpError(
      ErrorCode.InternalError,
      `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
    );
  }
});
</code></pre>
<p><strong>Tool Definition Example in tools.ts:</strong></p>
<pre><code class="language-typescript">export const start_adventure = {
  schema: z.object({
    projectDirectory: z.string().min(1, &quot;Project directory is required&quot;),
  }),
  description: &quot;Analyzes the codebase and presents initial theme options.&quot;,
  async handler(input: { projectDirectory: string }) {
    const { projectDirectory } = input;
    return adventureManager.initializeAdventure(projectDirectory);
  },
};
</code></pre>
<h2>Integration Points</h2>
<ul>
<li><strong>RepoAnalyzer</strong> (from <code class="inline-code">@ai-repo-adventures/core/analyzer</code>):<ul>
<li>Used for content pre-generation in <code class="inline-code">run()</code>.</li>
<li>Ensures that server operations are expedited by warming up caches.</li>
</ul>
</li>
<li><strong>Tools</strong>:<ul>
<li>Dynamic tool registration integrates with the core <code class="inline-code">Server</code> instance, ensuring tools are extensible and interpreted via Zod schemas.</li>
</ul>
</li>
<li><strong>Signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>)</strong>:<ul>
<li>Facilitates graceful shutdown handling, calling <code class="inline-code">repoAnalyzer.cleanup()</code> to release resources.</li>
</ul>
</li>
</ul>
<h2>Best Practices &amp; Considerations</h2>
<ul>
<li><strong>Tool Extensibility</strong>: Add new tools by defining their <code class="inline-code">schema</code>, <code class="inline-code">handler</code>, and <code class="inline-code">description</code> in a modular structure. Register them in <strong>tools.js</strong> by including them in the <code class="inline-code">tools</code> export.</li>
<li><strong>Error Propagation</strong>: Use <code class="inline-code">McpError</code> for predictable client-facing error responses. Always validate tool inputs using Zod schemas.</li>
<li><strong>Graceful Shutdown</strong>: Ensure resource cleanup (e.g., <code class="inline-code">repoAnalyzer.cleanup()</code>) is implemented for all long-running processes when the server shuts down.</li>
<li><strong>Zod Schema Usage</strong>: Define comprehensive schema validation to prevent invalid data propagation and improve client usability with detailed validation errors.</li>
<li><strong>Logging</strong>: Use <code class="inline-code">console.error</code> for runtime diagnostic messages. Avoid excessive logging that may obscure actionable errors.</li>
<li><strong>Background Task Efficiency</strong>: The <code class="inline-code">repoAnalyzer.preGenerate</code> call in <code class="inline-code">run()</code> should be monitored for heavy computational load that may impact server startup time.</li>
</ul>
<p>You&#39;ve successfully deployed the MCP Tool Interface moduleâ€”milestone achieved with precision; proceed to debug, refactor, and scale the codebase for Quest mastery! ðŸš€ðŸ’Ž</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 â†’</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>