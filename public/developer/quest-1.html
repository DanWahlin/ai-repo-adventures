<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Forge of Interaction - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Computational Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Forge of Interaction</h1>
<hr>
<p>Within the sprawling domain of the <strong>Codex of Computational Adventures</strong>, lies the fabled Forge of Interaction. Here, hammers of generative servers strike the molten data of developer tools, forging dynamic interfaces that breathe life into the codebase. To activate the forge&#39;s power, the <strong>RepoAdventureServer</strong> must configure itself as the ultimate mediator between commands and computational tools. But be warned - the success of this forge depends on methodical handlers, the calibration of tools, and the precision of execution!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Optimization</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> handle the dynamic listing of available tools and their execution?</li>
<li>‚ö° <strong>Server Activation</strong>: What steps does the <code class="inline-code">RepoAdventureServer.run</code> method take to initialize and prepare the system for use?</li>
<li>üõ°Ô∏è <strong>Failure Resilience</strong>: How does the <code class="inline-code">main</code> method manage unexpected errors during server execution or shutdown?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Interactive Engine</h3>
<p>This file contains the implementation of the primary server class, <code class="inline-code">RepoAdventureServer</code>, which facilitates interaction between the Codex‚Äôs tools and the command interface. The server processes requests for tool listings and command executions, validating both the tools and their input schemas dynamically. The foundational methods set up handlers for interaction and execute the server‚Äôs transport mechanism to manage connections.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Sets up dynamic request handlers for tools. This enables the server to validate and list tools interactively.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Manages the server&#39;s initialization and transport connection while warming up the cache with pre-generated content.</li>
<li><code class="inline-code">main</code>: Oversees the entire lifecycle of the server, handling fatal initialization errors, graceful shutdowns, and unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li><strong>Dynamic Handlers</strong>: This code dynamically lists and validates tools using schemas, ensuring new tools can be added without changing this logic.</li>
<li><strong>Error Management</strong>: Safeguards against invalid inputs and unknown tools, throwing clear and actionable errors for the client.</li>
<li><strong>Flexibility</strong>: By using schemas (<code class="inline-code">zodToJsonSchema</code>), it defines input expectations clearly, allowing tools to self-document.</li>
<li><strong>Dynamic Mapping</strong>: Tools are iterated dynamically using <code class="inline-code">Object.entries</code>, supporting extensibility without static code.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li><strong>Transport Initiation</strong>: Connects to a transport (<code class="inline-code">StdioServerTransport</code>) to enable interactive client-server communication.</li>
<li><strong>Cache Warm-Up</strong>: Prepares the content pipeline in advance to ensure fast responses during runtime.</li>
<li><strong>Logging</strong>: Logs critical startup information for debugging and monitoring purposes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li><strong>Lifecycle Management</strong>: Activates shutdown hooks (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for reliable termination.</li>
<li><strong>Error Recovery</strong>: Logs unhandled rejections, ensuring non-fatal errors don&#39;t crash the server.</li>
<li><strong>Fatal Error Reporting</strong>: Stops execution on unrecoverable initialization issues, increasing system reliability.</li>
<li><strong>Resilience</strong>: Provides robust handling mechanisms for operational reliability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review the <code class="inline-code">zodToJsonSchema</code> integration to see how data validation and input schemas are managed.</li>
<li>Investigate the <code class="inline-code">tools</code> array to understand how it connects tool metadata dynamically at runtime.</li>
<li>Examine <code class="inline-code">repoAnalyzer.preGenerate</code> for insight on the preprocessing pipeline that ensures performance.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer‚ÄîQuest 1: The Forge of Interaction has been successfully compiled and executed, signaling a stellar initialization of your coding adventure! üöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>