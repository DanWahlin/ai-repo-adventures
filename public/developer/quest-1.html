<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Toolsmith's Chamber - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Adventures in the Repository Realms</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Toolsmith&#39;s Chamber</h1>
<hr>
<p>In the Repository Realms, your mission begins within the chambers of the Toolsmiths. Here, tools are forged from the very essence of code to serve as magical artifacts in the Guild of Adventurers. Within the depths of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>, the setup and secrets of these tools wait to be uncovered. Dare to explore, Archivist Adventurer, and decode the power behind the tools that weave the threads of this interactive realm!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Toolsmith&#39;s Blueprint</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools and validate their configurations?</li>
<li>‚ö° <strong>Tools in Action</strong>: How does the <code class="inline-code">run</code> method initialize the server and prepare the adventure environment for operation?</li>
<li>üõ°Ô∏è <strong>Tool Execution Safety</strong>: How does the <code class="inline-code">CallToolRequestSchema</code> handler ensure tool invocation safety and handle errors during execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Construction of the Toolsmith&#39;s Repository</h3>
<p>This file describes the heart of the MCP server system and its integration with the tools. It reveals the <code class="inline-code">RepoAdventureServer</code> constructor and its key method <code class="inline-code">setupHandlers</code>, responsible for dynamically registering tools and their associated schemas. The runtime processes of <code class="inline-code">run</code> and <code class="inline-code">main</code> also play pivotal roles, initializing tool operations and setting up graceful shutdown mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Dynamic tool registration and schema validation</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Server initialization and preloading repository context</li>
<li><code class="inline-code">main</code>: Execution flow and error handling for MCP server startup</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];

      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>The <code class="inline-code">setupHandlers</code> method acts like a blacksmith, forging dynamic hooks for tool discovery and execution, with data validation as its anvil.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> method initializes the server and kick-starts the adventure pipeline, much like opening the gates to a sprawling city.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The <code class="inline-code">main</code> function orchestrates server startup, handling errors and unexpected interruptions with care, like a vigilant watchtower.</p>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Crafting the Adventurer&#39;s Tools</h3>
<p>This file assembles all available tools for the RepoAdventure system, ensuring seamless integration and accessibility. It highlights the shared <code class="inline-code">adventureManager</code> and re-exports key tools for use in the MCP server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Entry point for new adventures, initializing the journey</li>
<li><code class="inline-code">choose_theme.handler</code>: Mechanism for selecting narrative themes</li>
<li><code class="inline-code">explore_quest.handler</code>: Exploration logic for interactive quests</li>
<li><code class="inline-code">view_progress.handler</code>: Progress tracking across completed quests</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<p>These handlers combine to provide tools for shaping and navigating adventures, akin to a toolbox gifted to every Archivist Adventurer.</p>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>By exporting a unified <code class="inline-code">tools</code> object, the file ensures all tools are wielded effectively by the server, forming an interconnected arsenal.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure tools are properly implemented with robust Zod schemas to prevent invalid executions.</li>
<li>For debugging, examine the <code class="inline-code">CallToolRequestSchema</code> handler during dynamic invocation pipelines.</li>
</ul>
<hr>
<p>The Toolsmith&#39;s Chamber yields its secrets to those who seek with precision. Well done, adventurer!</p>
<p>üéâ Congratulations, developer! You&#39;ve successfully debugged the Toolsmith&#39;s Chamber, hitting your first milestone in this adventure‚Äîkeep refactoring your journeys as you forge towards 100%! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>