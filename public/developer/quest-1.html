<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Toolwright‚Äôs Summit - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Adventures of the Repository Chronicles</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Toolwright‚Äôs Summit</h1>
<hr>
<p>In a world brimming with digital potential and untamed source code, the realm of repository adventures remains uncharted, awaiting the guiding hand of a toolwright. Your mission, brave developer, is to journey into the realm of repository tools and lay the groundwork for code-driven storytelling. The heart of today‚Äôs summit lies in the <code class="inline-code">MCP Tool Interface</code>, where handlers are forged, adventures launched, and quests brought to life. By studying the mechanisms for tool orchestration and server flows, you will gain the keys to unlock the next chapter of the Repository Chronicles.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Manifest Assembly</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically list tools with descriptions and schemas?</li>
<li>‚ö° <strong>Orchestration Initiation</strong>: What is the flow of initialization from <code class="inline-code">main</code> to <code class="inline-code">RepoAdventureServer.run</code>?</li>
<li>üõ°Ô∏è <strong>Execution Integrity</strong>: How does the system validate tool arguments and handle execution errors in <code class="inline-code">CallToolRequestSchema</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Orchestrator</h3>
<p>This file defines the <code class="inline-code">RepoAdventureServer</code> class, which serves as the heart of the MCP tool interface. It handles tool requests, validates arguments, and ensures proper error management. Key functions include <code class="inline-code">setupHandlers</code>, which dynamically generates a list of available tools, and <code class="inline-code">run</code>, which initializes the server transport and pre-generates repository content. The <code class="inline-code">main</code> function ties it all together by managing lifecycle events and ensuring graceful shutdown.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically generates a tool manifest, converting each tool‚Äôs schema to JSON Schema for validation.</li>
<li><code class="inline-code">run</code>: Initializes the STDIO transport, prepares the repository analyzer, and starts the server.</li>
<li><code class="inline-code">main</code>: The application‚Äôs entry point, handling startup, shutdown signals, and unhandled rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists all registered tools and maps their metadata for clients.</li>
<li>Utilizes <code class="inline-code">zodToJsonSchema</code> to convert Zod schemas into JSON Schema for validation.</li>
<li>Enforces strong validation by parsing tool arguments against defined schemas.</li>
<li>Handles exceptions gracefully, distinguishing internal errors from invalid requests.</li>
<li>Ensures each tool implements both descriptive metadata and robust request validation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server with STDIO transport, ideal for inter-process communication.</li>
<li>Logs startup details to the console for debugging and monitoring.</li>
<li>Prepares repository content by warming up the <code class="inline-code">repoAnalyzer</code> cache asynchronously.</li>
<li>Uses <code class="inline-code">process.cwd()</code> to dynamically determine the project path at runtime.</li>
<li>Promotes efficient handling of incoming requests without delay.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Instantiates the <code class="inline-code">RepoAdventureServer</code>, which orchestrates all tool-related interactions.</li>
<li>Sets up signal handlers to ensure a graceful shutdown on <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Monitors and logs unhandled promise rejections for debugging purposes.</li>
<li>Executes the <code class="inline-code">run</code> function to bootstrap the server‚Äôs core functionality.</li>
<li>Handles fatal errors during startup, preventing the process from hanging indefinitely.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Focus on the interplay between <code class="inline-code">zodToJsonSchema</code> and <code class="inline-code">CallToolRequestSchema</code> for understanding validation flows.</li>
<li><strong>Exploration Recommendation</strong>: Investigate the <code class="inline-code">tools</code> module in the next quest to see how individual tools are defined and implemented.</li>
<li><strong>Next Steps</strong>: Prepare to venture deeper into the adventure tools and explore how their handlers drive quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer! üéâ You‚Äôve successfully debugged and compiled your way through Quest 1: The Toolwright‚Äôs Summit‚Äîa stellar first commit on your codebase to mastery; onward to the next feature build! üöÄüíª</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>