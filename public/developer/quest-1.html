<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Modular Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<hr>
<p>The first step in understanding the dynamic storytelling capabilities of the system lies in its tool interface, which acts as the heart of interactive functionality. This quest delves into how the system initializes, lists, and executes tools that empower developers to explore and interact with a code repository. By examining the server setup and tool definitions within the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> and <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> files, you&#39;ll uncover the architecture behind these operations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Integration</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> manage the dynamic listing and execution of tools, and what role do Zod schemas play in this flow?</li>
<li>‚ö° <strong>Server Initialization</strong>: How does the <code class="inline-code">RepoAdventureServer.run</code> method integrate with the <code class="inline-code">StdioServerTransport</code> and pre-generate content for smoother operations?</li>
<li>üõ°Ô∏è <strong>Tool Functions</strong>: How are tools such as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code> defined in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> and integrated into the larger system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server setup and request handling</h3>
<p>The <code class="inline-code">server.ts</code> file contains the core logic for initializing the MCP server and handling requests related to tools. It includes the <code class="inline-code">RepoAdventureServer</code> class, which encapsulates key methods for dynamically managing tools and launching the server. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists available tools using their Zod schemas and executes a specified tool with validated input.</li>
<li><code class="inline-code">run</code>: Starts the server using <code class="inline-code">StdioServerTransport</code> and pre-generates content for the current project path to optimize user interactions.</li>
<li><code class="inline-code">main</code>: Manages the server lifecycle, setting up shutdown handlers and logging unhandled errors without halting the system.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of tools using <code class="inline-code">ListToolsRequestSchema</code> and Zod schemas to standardize input descriptions as JSON Schema.</li>
<li>Validates tool execution requests to ensure they exist and arguments match expected formats.</li>
<li>Separates concerns by delegating validation to Zod and execution to the respective tool handlers.</li>
<li>Enhances error handling with <code class="inline-code">McpError</code> for consistent reporting and debugging of failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Uses <code class="inline-code">StdioServerTransport</code> for communication, ideal for CLI-based interactions.</li>
<li>Optimizes performance by pre-generating content for the current directory while the server awaits commands.</li>
<li>Provides clear logs for user feedback during initialization and background content generation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements robust lifecycle management with graceful shutdown hooks for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Logs unhandled promise rejections to prevent abrupt server crashes, ensuring stability during runtime.</li>
<li>Captures fatal errors during startup, providing detailed logs and a controlled exit.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool definitions</h3>
<p>This file defines the individual tools exported for integration by <code class="inline-code">RepoAdventureServer</code>. Each tool performs a focused operation in the gamified storytelling experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and sets up the initial repository exploration session.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates custom stories and quests based on the developer&#39;s selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Facilitates navigation through specific quests, providing generated content and insights.</li>
<li><code class="inline-code">view_progress.handler</code>: Retrieves progress data, showing completed and remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports the tools as a collection, ensuring seamless registration and accessibility within <code class="inline-code">setupHandlers</code>.</li>
<li>Leverages modular structure to keep tool definitions scalable and maintainable.</li>
<li>Simplifies tool consumption by wrapping exports using naming conventions consistent with MCP.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Analyze how <code class="inline-code">setupHandlers</code> connects the <code class="inline-code">tools</code> module with server requests to understand dynamic behavior.</li>
<li>Study the handlers in <code class="inline-code">tools.ts</code> to grasp how their structure impacts flow and execution within the MCP server.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully refactoring your skills and deploying the MCP Tool Interface‚Äîyour codebase of knowledge just committed a stellar milestone! ‚ö°üöÄ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>