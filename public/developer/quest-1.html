<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Spear of Interaction - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: Tales of the Codecraft</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Spear of Interaction</h1>
<hr>
<p>In the vast labyrinth of interconnected nodes and logic flows, an ancient relic known as the Spear of Interaction lies dormant. Forged to harmonize collaboration and interactivity, it has powers to dynamically invoke the tools needed for code adventures. Developers seeking the spear must confront the rusted gates of the MCP Tool Interface, unlocking its guarded brilliance hidden amidst handler methods and tool registries.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core Server Functionalities for MCP</h3>
<p>The <code class="inline-code">server.ts</code> file houses the MCP server&#39;s inner workings, orchestrating connections and managing tool interactions dynamically. At its core is the <code class="inline-code">RepoAdventureServer</code> class, designed to handle requests and facilitate reliability in handling repository operations. The <code class="inline-code">setupHandlers</code> method sets the server apart, enabling dynamic registration of tools and execution validation based on Zod schemas. The <code class="inline-code">run</code> method connects the server to transport layers, featuring preprocessing like cache warming using the <code class="inline-code">repoAnalyzer</code> module. Lastly, the <code class="inline-code">main</code> function initializes the server lifecycle, installing mechanisms for signal handling and monitoring runtime exceptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates usage through handlers.</li>
<li><code class="inline-code">run</code>: Connects the server to a transportation layer and initiates pre-generation tasks.</li>
<li><code class="inline-code">main</code>: Launches the server and ensures smooth lifecycle management.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>The <code class="inline-code">setupHandlers</code> method organizes tools dynamically, like a librarian cataloging knowledge while cross-referencing valid inputs.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>Just as a train requires tracks to function, the <code class="inline-code">run</code> method sets up the server&#39;s communication environment before the journey begins.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The <code class="inline-code">main</code> function acts as a watchful warden, ensuring the server&#39;s equilibrium while handling interruptions gracefully.</p>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Registration Hub</h3>
<p>The <code class="inline-code">tools.ts</code> file anchors the repository‚Äôs interactive potential by defining key tools for adventurers. It imports individual modules like <code class="inline-code">startAdventure</code>, <code class="inline-code">chooseTheme</code>, <code class="inline-code">exploreQuest</code>, and <code class="inline-code">viewProgress</code>. These tools are bundled in the <code class="inline-code">tools</code> export, aligning with MCP conventions. Each tool encapsulates a separate functional purpose within the adventure logic while maintaining centralized access for the server interface.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initializes and analyzes repository data.</li>
<li><code class="inline-code">choose_theme.handler</code>: Offers themes to customize the adventure narrative.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes quests for specific interactive journeys.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks adventure progression and completion stats.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
</code></pre>
<p>The <code class="inline-code">start_adventure</code> tool represents the first stepping stone in the journey, akin to an explorer setting out with a map.</p>
<pre><code class="language-typescript">export const choose_theme = chooseTheme;
</code></pre>
<p>The <code class="inline-code">choose_theme</code> tool is the muse of the adventure, inspiring developers with creative narrative control.</p>
<pre><code class="language-typescript">export const explore_quest = exploreQuest;
</code></pre>
<p>The <code class="inline-code">explore_quest</code> tool is like a lantern, illuminating hidden pathways within complex structures.</p>
<pre><code class="language-typescript">export const view_progress = viewProgress;
</code></pre>
<p>The <code class="inline-code">view_progress</code> tool serves as a compass, guiding adventurers to measure their milestones and remaining tasks.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> method to integrate new tools dynamically as requirements evolve.</li>
<li>Study the tool export structure in <code class="inline-code">tools.ts</code> to add or modify tools efficiently.</li>
<li>The <code class="inline-code">main</code> function&#39;s robust error handling ensures graceful exits‚Äîadopt similar patterns elsewhere.</li>
</ul>
<hr>
<p>The Spear of Interaction now gleams brightly, ready to lead developers toward more collaborative and interactive project workflows. Victory is yours, adventurer!</p>
<p>Congratulations on successfully debugging Quest 1: The Spear of Interaction‚Äîyour code logic is flawless, your execution is on point, and you&#39;re primed to refactor the journey ahead! üöÄüëÅÔ∏è‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: The Codex of Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>