<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Command the Repository Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: Building Adventures Through Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Command the Repository Interface</h1>
<hr>
<p>In the bustling coding realms, where logic and creativity intertwine, the Repository Chronicles call upon you, valiant adventurer, to engage with the core workings of the &quot;MCP Tool Interface.&quot; This crucial system harnesses the power of interactive storytelling to breathe life into codebases. Your mission is to delve into the repository‚Äôs architecture and uncover the secrets embedded within its dynamic tools and server behaviors. The code awaits - will you answer the Repository&#39;s challenge?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dynamic Mapping</strong>: What mechanism does the <code class="inline-code">setupHandlers</code> function use to dynamically list and validate tools, and how does this facilitate extensibility?</li>
<li>‚ö° <strong>Server Initialization</strong>: How does the <code class="inline-code">run</code> function handle process startup and ensure the system is prepped for user commands?</li>
<li>üõ°Ô∏è <strong>Fail-Safe Mechanisms</strong>: What strategies does the server employ in <code class="inline-code">main</code> to handle signal interruptions and unhandled promise rejections gracefully?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Interactive Server Core</h3>
<p>The <code class="inline-code">server.ts</code> file forms the backbone of the interactive MCP server, managing tool handlers, requests, and connectivity. It establishes a Server instance, binds dynamic handler functions, and initializes connections for facilitating interactive repository-based adventures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically maps tool definitions to server handlers and validates input schemas using Zod. This ensures tools are extensible and input validation remains strong.</li>
<li><code class="inline-code">run</code>: Initializes the server transport, connects the core components, and primes the repository content generation via <code class="inline-code">repoAnalyzer</code>. This is key for a seamless user experience.</li>
<li><code class="inline-code">main</code>: Orchestrates the server‚Äôs startup and handles potential shutdown scenarios. Implements signal listeners for graceful termination and robust error handling for unexpected rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      }),
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically constructs tool descriptions and schemas for registration.</li>
<li>Validates the tool input using Zod schemas to ensure correctness.</li>
<li>Executes tool handlers while catching and reporting errors for user feedback.</li>
<li>Implements a modular approach to tool integration, enabling future scalability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes a <code class="inline-code">stdio</code> transport for server communication.</li>
<li>Ensures repository content is pre-generated in parallel, avoiding delays for the user.</li>
<li>Provides informative error messages to track server startup status and background caching.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server and ensures signal-based shutdown is gracefully handled.</li>
<li>Catches unhandled promise rejections to prevent server crashes during runtime.</li>
<li>Provides robust logging for troubleshooting during both startup and operation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with Zod validation to understand the schema definitions in <code class="inline-code">tools</code>.</li>
<li>Trace the transport layer setup in <code class="inline-code">run</code> to see how requests flow through the server.</li>
<li>Study error-handling mechanisms in <code class="inline-code">main</code> to observe best practices in maintaining uptime.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in the Repository Chronicles.</p>
<p>üèÜ Milestone achieved: you&#39;ve successfully committed the first repository interface mastery‚Äînow merge your momentum into the main branch of learning excellence! üöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>