<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Enchanted Workshop - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codekeeper's Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Enchanted Workshop</h1>
<hr>
<p>In a realm of sprawling codebases and uncharted digital landscapes, the Enchanted Workshop awaits. Here, the Codekeeper has bestowed tools to generate dynamic, interactive adventures. Your journey begins with understanding the server that powers it all and the tools that provide its magic. As you uncover the secrets hidden in <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>, you will master the art of transforming raw data into thematic quests. Courage, adventurer, for the enchanted workshop&#39;s mysteries are not easily revealed!  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Toolsmith Inquiry</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically generate and validate tool interactions?  </li>
<li>‚ö° <strong>Server Activation Unveiled</strong>: What patterns enable the <code class="inline-code">run</code> function to initialize the server efficiently and prepare the repository analysis?  </li>
<li>üõ°Ô∏è <strong>Crashguard Protocol</strong>: How does the <code class="inline-code">main</code> method handle unexpected shutdown signals and runtime errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Server Entry Point</h3>
<p>The <code class="inline-code">server.ts</code> file contains the core logic required to initialize and manage the interactive MCP server. This includes handler configuration, runtime setup, and error management. Functions like <code class="inline-code">setupHandlers</code> illustrate the dynamic nature of creating and invoking tools, while <code class="inline-code">run</code> demonstrates how the server is brought to life alongside preloading repository data.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically maps server tools to handlers, ensuring requests are validated and processed correctly. Essential for extending functionality.  </li>
<li><code class="inline-code">run</code>: Launches the MCP server and pre-generates repository content with <code class="inline-code">repoAnalyzer</code>, optimizing user response time.  </li>
<li><code class="inline-code">main</code>: Acts as the entry point; handles graceful shutdowns, unhandled promise rejections, and fatal startup errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
  // Dynamic tool listing  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {  
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  

    return { tools: toolList };  
  });  

  // Dynamic tool execution  
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    try {  
      const { name, arguments: args } = request.params;  

      if (!(name in tools)) {  
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
      }  

      const tool = tools[name as keyof typeof tools];  
      
      // Validate arguments using the tool&#39;s Zod schema  
      const validationResult = tool.schema.safeParse(args);  
      if (!validationResult.success) {  
        const errorMessages = validationResult.error.issues.map((err) =&gt;   
          `${err.path.join(&#39;.&#39;)}: ${err.message}`  
        ).join(&#39;, &#39;);  
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
      }  

      // Execute the tool handler with validated arguments  
      return await tool.handler(validationResult.data as any);  

    } catch (error) {  
      if (error instanceof McpError) {  
        throw error;  
      }  
      throw new McpError(  
        ErrorCode.InternalError,  
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
      );  
    }  
  });  
}  
</code></pre>
<ul>
<li>Dynamically generates a tool list with input schemas by mapping over imported <code class="inline-code">tools</code>.  </li>
<li>Configures secure parameter validation with Zod schemas for each tool.  </li>
<li>Ensures the handler execution integrates with server-side error handling seamlessly.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  
    
  // Pre-generate repomix content for the current working directory to warm up the cache  
  // This happens in the background while waiting for user commands  
  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>Initializes the server with <code class="inline-code">StdioServerTransport</code> to handle requests from standard I/O streams.  </li>
<li>Logs server status updates to the developer console for transparency.  </li>
<li>Uses <code class="inline-code">repoAnalyzer.preGenerate</code> to analyze code repositories preemptively, reducing runtime delays.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  
      
    // Handle graceful shutdown for both signals  
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  
      
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation  
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error  
    });  
      
    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}  
</code></pre>
<ul>
<li>Captures exit signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to invoke a clean shutdown via <code class="inline-code">gracefulShutdown</code>.  </li>
<li>Provides robust logging for unhandled promise rejections during runtime, without affecting server availability.  </li>
<li>Ensures startup errors are critically logged before shutting down the process.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Investigate Tool Schemas</strong>: Study Zod schemas in <code class="inline-code">setupHandlers</code> to learn how tools validate and shape their input.  </li>
<li><strong>Trace Initialization Patterns</strong>: Follow the <code class="inline-code">run</code> function to understand background processes like pre-generating repository analysis data.  </li>
<li><strong>Handle the Unexpected</strong>: Review how <code class="inline-code">main</code> intercepts shutdown signals and runtime exceptions for stability.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Achievement unlocked: The Enchanted Workshop module has successfully compiled, showcasing your exceptional debugging prowess and initializing an unstoppable journey through code magic‚Äîstellar work, developer! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>