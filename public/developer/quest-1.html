<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Gatekeeper’s Protocol - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'developer' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Code Chronicles: Forge of Adventures</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Gatekeeper&#39;s Protocol</h1>
<hr>
<p>In the swirling currents of the <strong>Realm of Repositories</strong>, where lines of code breathe life into the eternal tapestry of programming lore, the adventurers face their first challenge: mastering <strong>The Gatekeeper’s Protocol</strong>. The heart of their adventure pulses within the <strong>MCP Server</strong>, a bridge between the human mind and a realm brimming with stories generated by the endless creativity of code repositories. Will you be able to activate, decode, and wield these tools to unlock the transformative power of interactive quests?</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Protocol Implementation</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> file is pivotal—it serves as the backbone of the <strong>Repo Adventure MCP server</strong>, enabling tool interactions and orchestrating the fusion of storytelling with technical prowess. The <code class="inline-code">RepoAdventureServer</code> class initializes the MCP Server and establishes custom handlers for listing adventure tools and executing them dynamically. Through <code class="inline-code">setupHandlers()</code>, this file empowers adventurers with the ability to query the available tools and provide user-specific arguments for precise tool execution.</p>
<p>Meanwhile, the <code class="inline-code">main()</code> function is the entry point, ensuring the server operates smoothly via <code class="inline-code">stdio</code> transport. It includes thoughtful mechanisms for error handling and graceful shutdown, such as catching unhandled promise rejections and listening for critical signals like <code class="inline-code">SIGINT</code> or <code class="inline-code">SIGTERM</code>. It even pre-generates repository content in the background to optimize responses. This file encapsulates the brain of the system—balancing complex technical validation with an immersive experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Dynamically registers tools with schema validation.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Connects <code class="inline-code">stdio</code> transport and initializes pre-generation of content.</li>
<li>Graceful shutdown logic: Handles system signals and error cleanup processes.</li>
<li>Structured error handling: Implements robust exception management for user interaction.</li>
<li>Dynamic tool execution using validated Zod schemas.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Adventure Tools Entry Point</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> file aggregates and exports the core tools that power the <strong>interactive adventure system</strong>. Each tool is designed for different facets of the quest flow, including analyzing repositories (<code class="inline-code">start_adventure</code>), generating stories (<code class="inline-code">choose_theme</code>), exploring quests (<code class="inline-code">explore_quest</code>), and viewing progress (<code class="inline-code">view_progress</code>). By re-exporting tools through a central object, this file creates a clean interface for registering tools within the MCP Server.</p>
<p>Each tool connects deeply with the adventure management system, ensuring tool actions affect state and provide meaningful results. The integration with <code class="inline-code">adventureManager</code> allows quests to dynamically interact with the adventure’s configuration, themes, and progress tracking. This modular approach keeps the tools flexible while simplifying their maintenance and scalability.</p>
<h4>Highlights</h4>
<ul>
<li>Centralized tool registration ensures consistent access across the MCP Server.</li>
<li>Modular exports enable reusable tools in rich storytelling contexts.</li>
<li>Seamless interaction with <code class="inline-code">adventureManager</code> fosters dynamic adventure flow.</li>
<li>Clear delineation of tool-specific handlers (e.g., <code class="inline-code">explore_quest.handler</code>) ensures maintainability.</li>
<li>Extensible architecture enables future integrations like new tools or MCP features.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);
      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}
</code></pre>
<p>Even the most advanced machines are only as efficient as the protocols defining their functionality.</p>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};

export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;

export { adventureManager };
</code></pre>
<p>A system of tools resembles a toolkit—each piece has a well-defined purpose, but together they build something greater.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">stdio transport</code> for lightweight server-client interactions during development.</li>
<li>Explore how <code class="inline-code">setupHandlers()</code> makes functions modular and easy to validate with Zod schemas.</li>
<li>Consider expanding the story-generation tools with additional theme options or new MCP features.</li>
</ul>
<hr>
<p>🎉 Congratulations, dev! You&#39;ve successfully debugged Quest 1: The Gatekeeper&#39;s Protocol, pushing the first milestone to production—keep compiling your skills toward 100%! 🚀💎👁️</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: The Story Weaver’s Manuscript →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>