<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository of Infinite Adventures</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Nexus</h1>
<hr>
<p>Within the Repository of Infinite Adventures, the MCP Nexus hums with energy. Its cryptic algorithms weave together tales of exploration and intrigue, each story a new challenge for the Keeper of Code. As you approach a glowing terminal, you recognize this as the interface to the &quot;MCP Tool Interface.&quot; Its purpose: to facilitate dynamic interactions between the codebase&#39;s tools and its users. Prepare yourself to decode its operations and uncover the secrets of interactive tool execution!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Construction</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically configure tool listing and execution within the server?</li>
<li>‚ö° <strong>Server Lifecycle</strong>: What steps does the <code class="inline-code">run</code> function take to initialize the MCP server and ensure readiness for operation?</li>
<li>üõ°Ô∏è <strong>Error Handling Protocol</strong>: How does the <code class="inline-code">main</code> function manage unexpected errors during startup and runtime?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server Setup and Lifecycle</h3>
<p>This file defines the <code class="inline-code">RepoAdventureServer</code>, the entry point for the MCP server that facilitates communication between tools and the user. It sets request handlers for dynamic tool management, initializes the server, and ensures operational stability through robust error handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically generates and configures handlers for listing and executing tools.</li>
<li><code class="inline-code">run</code> initializes the server and prepares it for user interaction while preloading the repository context.</li>
<li><code class="inline-code">main</code> orchestrates server startup, integrates graceful shutdown signals, and manages unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
}
</code></pre>
<p>The <code class="inline-code">setupHandlers</code> method is like a wizard configuring spells dynamically: here, tool listing is a map, and tool execution is invoked through validation and error-safe calls.</p>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> function is the launch pad for the server, connecting the transport layer and warming up cache for smooth user interaction.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The <code class="inline-code">main</code> function is like deploying a fortress: it handles fatal startup errors, sets up signals for safe shutdown, and maintains resilience against unhandled promises.</p>
<h2>Helpful Hints</h2>
<ul>
<li>To modify or add new tools, see <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>. Ensure the proper schemas and handlers are defined.</li>
<li>Investigate MCP&#39;s tool listing schema in <code class="inline-code">setupHandlers</code> to learn how tool metadata transforms into dynamic capabilities.</li>
<li>Preloading the repository context in <code class="inline-code">run</code> boosts user experience performance.</li>
</ul>
<hr>
<p>Quest completed! You have successfully decoded the intricate operations of the MCP server interface, uncovering the hidden sequences that power this interactive engine.</p>
<p>Congratulations, Developer! You&#39;ve successfully debugged Quest 1: The MCP Nexus‚Äîyour codebase just experienced a monumental merge; onward to deploy üöÄüíé!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>