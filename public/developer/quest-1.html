<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Interface of the Guild - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: Tales of the Automation Guild</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Interface of the Guild</h1>
<hr>
<p>In the bustling halls of the Automation Guild, a magical artifact known as the &quot;MCP Tool Interface&quot; governs the interactions between adventurers and their repositories. This artifact is maintained by ancient scripts, carefully crafted to enable explorers to embark on code-based journeys. As a recruit, you are entrusted with unraveling the workings of this interface. Equip yourself with patience and curiosity‚Äîyour task is to configure handlers, understand dynamic tool execution, and delve into the heart of modular tool design. The Guild is counting on your mastery!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Assembly</strong>: How does the <code class="inline-code">setupHandlers</code> method define dynamic tool management and request handling in <code class="inline-code">RepoAdventureServer</code>?</li>
<li>‚ö° <strong>Transport and Execution</strong>: What occurs during the <code class="inline-code">run</code> method execution, and how is the MCP server initialized and prepared for connection?</li>
<li>üõ°Ô∏è <strong>Graceful Endings</strong>: How does the <code class="inline-code">main</code> function manage lifecycle events and ensure safe shutdown sequences?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Exploring the MCP Server Core</h3>
<p>This file contains the main server logic for the Repo Adventure MCP system, defining crucial operations for dynamic tool management, server execution, and graceful shutdown procedures. It connects functionality in <code class="inline-code">tools.ts</code> to higher-level server mechanics.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates requests using Zod schemas.</li>
<li><code class="inline-code">run</code>: Initializes and runs the MCP server using <code class="inline-code">StdioServerTransport</code>.</li>
<li><code class="inline-code">main</code>: Boots up the server, handles lifecycle management, and ensures error resilience.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists available tools by converting Zod schemas to JSON schemas for client consumption.</li>
<li>Manages execution by validating input arguments against predefined Zod schemas for each tool.</li>
<li>Provides a robust error-handling structure using custom <code class="inline-code">McpError</code> exceptions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Starts the MCP server and establishes a connection using <code class="inline-code">StdioServerTransport</code>.</li>
<li>Logs server activity for monitoring and debugging.</li>
<li>Warms up the cache by pre-generating Repomix content for the current directory.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">RepoAdventureServer</code> and prepares for lifecycle events.</li>
<li>Handles system signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> for a graceful shutdown process.</li>
<li>Captures unhandled promise rejections, logging them without interrupting server operations.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how Zod schemas are used for validation before tool execution‚Äîdynamic typing is extensively demonstrated here.</li>
<li>Observe the implementation of lifecycle management in <code class="inline-code">main</code> to understand how the server prevents abrupt termination.</li>
<li>Use this foundational understanding of the MCP server interface when designing new tools or extending the system.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, developer‚ÄîQuest 1: The Interface of the Guild has been successfully delivered to production; your pathway to mastering the remaining endpoints is initialized‚Äîonward to build the full-stack masterpiece! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>