<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Invocation of the Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Mythos of the Codebase Chronicles</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Invocation of the Engine</h1>
<hr>
<p>As the dawn of innovation rises in the developer&#39;s storytelling realm, your journey begins in the Repository Adventure Engine itself. This tool, forged from code and creativity, empowers adventurers to unleash epic narratives from mere lines of TypeScript. To wield its power, you must dive into its mechanisms, understand its handlers, and learn how it connects the tools of adventure with the magic of storytelling. The engine awaits your invocation‚Äîyour quest begins here!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically connect tools to their corresponding schemas and methods?</li>
<li>‚ö° <strong>Engine Activation</strong>: What patterns and architectural choices guide the execution flow in the <code class="inline-code">run</code> method of the <code class="inline-code">RepoAdventureServer</code>?</li>
<li>üõ°Ô∏è <strong>Error Shielding</strong>: How does the <code class="inline-code">main</code> function manage potential errors and ensure seamless server operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Tool Management</h3>
<p>This file defines the main server for the Repository Adventure Engine, linking tools with dynamic handlers and initializing the server transport. It is the critical entry point for MCP functionality, enabling exploration and storytelling through code analysis.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates requests using Zod schemas for guaranteed input integrity.</li>
<li><code class="inline-code">run</code>: Activates the server, setting up the transport layer and initializing project pre-processing to enhance responsiveness.</li>
<li><code class="inline-code">main</code>: Governs server lifecycle management, handling graceful shutdowns and unhandled promise rejections for robust stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically links tools to schemas and descriptions for runtime validation and adaptability.</li>
<li>Implements error-resilient execution paths, ensuring safe request handling.</li>
<li>Utilizes Zod for schema validations, making the system robust against invalid input.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Configures and connects the transport layer for communication, enabling stdio-based interaction.</li>
<li>Initializes pre-processing of project data to reduce execution latency during adventures.</li>
<li>Leverages asynchronous operations to optimize server readiness without blocking commands.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Ensures server lifecycle management via signal handling for termination and clean exits.</li>
<li>Provides error logging for unhandled rejections without disrupting normal operation.</li>
<li>Combines robust error handling with initialization, promoting stability and reliability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To ensure tool compatibility, closely examine the integration of schemas within <code class="inline-code">setupHandlers</code>.</li>
<li>Track the initialization flow to learn how asynchronous operations optimize performance in <code class="inline-code">run</code>.</li>
<li>Investigate lifecycle hooks like signal handling and error catching for maintaining robust system behavior.</li>
</ul>
<hr>
<p>Adventure prepares to unfold‚Äîyour path now lies within the invocation engine itself. Harness its potential and uncover the secrets of storytelling through code!</p>
<p>Congratulations, developer warrior‚ÄîQuest 1 successfully deployed with zero runtime errors; you&#39;ve laid the core foundation for the codebase of this epic journey üöÄ‚ö°!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>