<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles: Developer's Blueprint</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<hr>
<p>At the core of the MCP (Model Context Protocol) lies a remarkable system for gamifying code exploration. The <code class="inline-code">MCP Tool Interface</code> serves as the command hub, orchestrating the seamless communication between interactive tools and the broader server framework. This interface is pivotal in converting developer inputs into actionable insights by validating requests, safely executing tools, and returning enriched responses. In this quest, we unearth the mechanisms behind tool integration, from dynamic tool registration to real-time execution workflows.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Mapping Mechanism</strong>: How does the system dynamically list and provide schema details for all available tools?</li>
<li>‚ö° <strong>Execution Workflows</strong>: What steps and validations are involved in executing a tool and its handler safely?</li>
<li>üõ°Ô∏è <strong>Error Handling Framework</strong>: How are errors during tool execution processed and communicated to the client?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core Server Logic and Tool Execution</h3>
<p>This file implements the MCP server responsible for facilitating tool interactions. It initializes the server, dynamically exposes tool metadata, and ensures safe tool execution by validating inputs and managing errors. Additionally, it preloads repository data to optimize performance during usage.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically configures request handlers for listing tools and executing them. It converts Zod schemas into JSON schemas and validates tool input parameters.</li>
<li><code class="inline-code">run</code> initiates the MCP server using standard I/O and pre-generates content to enhance responsiveness.</li>
<li><code class="inline-code">main</code> manages the server&#39;s lifecycle, including graceful shutdown and handling unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;, 
        $refStrategy: &#39;none&#39; 
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];

      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt;
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically maps tools from the <code class="inline-code">tools</code> module, automatically listing their descriptions and Zod-generated schemas.</li>
<li>Zod schemas safeguard input validation, ensuring only valid arguments are passed to tool handlers.</li>
<li>Errors during tool execution are intercepted with custom error messages and categorized using <code class="inline-code">McpError</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> method initializes the MCP server using standard I/O transport, enabling interaction with tools.</li>
<li>It warms up the repository analysis cache by pre-generating context, reducing delays during real-time operations.</li>
<li>This design ensures that users experience faster response times when interacting with large repositories.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();

    // Handle graceful shutdown
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    // Handle unhandled promise rejections
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function bootstraps the <code class="inline-code">RepoAdventureServer</code> and supervises its lifecycle.</li>
<li>It enforces graceful shutdowns by wrapping cleanup logic for signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Robust error handling ensures that the MCP server remains resilient even during unexpected rejections.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<p>This file serves as the central registry for tools that the MCP server interacts with. It integrates gamified functions for exploring codebases into a unified <code class="inline-code">tools</code> object, which is consumed by the server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> analyzes the codebase and initializes an interactive adventure.</li>
<li><code class="inline-code">choose_theme.handler</code> generates a tailored narrative by letting users select a theme.</li>
<li><code class="inline-code">explore_quest.handler</code> dives into individual quests, offering intricate details and progressions.</li>
<li><code class="inline-code">view_progress.handler</code> allows users to monitor their current progress and uncover remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object centralizes all game-related handlers, organizing them for dynamic registration with the MCP server.</li>
<li>Handlers include the core components of the gamified code exploration system: initializing adventures, selecting themes, progressing through quests, and tracking progress.</li>
<li>This modular approach simplifies the addition of new tools, promoting maintainability and scalability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: Focus on how Zod schemas define and enforce strong validation for tool parameters.</li>
<li><strong>Exploration Recommendation</strong>: Experiment with adding new tools to the <code class="inline-code">tools</code> module and observe how they are dynamically integrated by <code class="inline-code">setupHandlers</code>.</li>
<li><strong>Next Steps</strong>: As you proceed, delve into the Quest Generation Engine to uncover how narratives and quests are formulated for interactive adventures.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üéâ Quest 1: MCP Tool Interface successfully deployed‚Äîyour code logic is now a shining new commit in the repository of greatness, paving the way for stellar optimization ahead! üöÄüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>