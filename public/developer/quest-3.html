<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Quest Generation Engine Mechanics - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Repository Adventurer's Technical Blueprint</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Quest Generation Engine Mechanics</h1>
<hr>
<p>This quest delves into the architecture and implementation of the Quest Generation Engine, the core part of the framework that powers dynamic storytelling and quest creation. Through its modular design, the components of the engine efficiently handle configuration, quest content generation, and integration with external configuration files. Developers will explore how the <code class="inline-code">AdventureManager</code> orchestrates quests, the <code class="inline-code">StoryGenerator</code> builds narratives, and <code class="inline-code">adventure-config.ts</code> provides a vital link for external customization.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Narrative Design Flow</strong>: How does the <code class="inline-code">initializeAdventure</code> function in <code class="inline-code">AdventureManager</code> integrate project data, themes, and LLM-generated quests into a cohesive initialization process?</li>
<li>‚ö° <strong>Dynamic Content Handling</strong>: What is the significance of <code class="inline-code">generateQuestContent</code> in the <code class="inline-code">StoryGenerator</code> module, and how does it tailor quest-specific content?</li>
<li>üõ°Ô∏è <strong>Configuration Parsing</strong>: How do the <code class="inline-code">loadAdventureConfig</code> and <code class="inline-code">parseAdventureConfig</code> functions ensure robust handling of external configuration files?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Quest Orchestrator</h3>
<p>The <code class="inline-code">AdventureManager</code> class is the entry point for initiating and managing quests. It provides functionality to create quest narratives, validate user choices, and cache content for revisited quests. The methods in this file are crucial for bridging the gap between raw configuration, project data, and dynamically generated content.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Loads project context, applies a theme, and initializes quests by combining AI-generated output with parsed external configurations.</li>
<li><code class="inline-code">exploreQuest</code>: Executes a quest, pulling from cache when revisiting completed quests, and ensures content is dynamically generated for new explorations.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code>: Tracks the percentage of completed quests, emphasizing the game&#39;s progression mechanics.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}
</code></pre>
<ul>
<li>This function initializes the adventure by resetting the internal state and configuring the theme.</li>
<li>It uses the <code class="inline-code">StoryGenerator</code> to generate the narrative and combines it with external configuration files.</li>
<li>The <code class="inline-code">mergeQuestFilesFromConfig</code> and <code class="inline-code">enforceConfigQuestCount</code> functions play critical roles in ensuring consistency with external configurations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li><code class="inline-code">exploreQuest</code> validates the user‚Äôs choice and determines whether it&#39;s a request to view progress or to execute a specific quest.</li>
<li>It retrieves the quest to be executed from either cache or the comprehensive quest list.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li><code class="inline-code">progressPercentage</code> calculates the completion rate for the adventure, critical for tracking user progress.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> The Narrative Builder</h3>
<p>The <code class="inline-code">StoryGenerator</code> class drives the creation of narratives and quest content. It uses Markdown parsing, configuration injection, and language models to generate immersive storytelling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Composes the initial story and creates quests by interacting with an LLM.</li>
<li><code class="inline-code">generateQuestContent</code>: Produces the content for individual quests, leveraging custom hints, guidance, and code snippets.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Structures the Markdown response into a clean, extractable format.</li>
</ul>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code> validates the theme and produces both the overall story and the quests using language model responses.</li>
<li>It integrates the project information, ensuring the narrative aligns with user code contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;

  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance,
    questPosition,
    totalQuests,
    ...(customInstructions &amp;&amp; { customInstructions }),
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST });
  return { adventure: response.content.trim(), fileExploration: &#39;&#39;, codeSnippets: [], hints: [] };
}
</code></pre>
<ul>
<li>This function combines the quest&#39;s configuration with LLM-generated content to deliver tailored narratives.</li>
</ul>
<hr>
<p>The <code class="inline-code">loadAdventureConfig</code> and related methods in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a> handle reading and parsing external adventure configurations. These functions ensure the integration of external settings for consistency.</p>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Try to trace the data flow from <code class="inline-code">initializeAdventure</code> in <code class="inline-code">AdventureManager</code> to <code class="inline-code">generateQuestContent</code> in <code class="inline-code">StoryGenerator</code>.</li>
<li>Observe how external configurations are seamlessly merged into LLM-generated quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üöÄ With Quest 3: Quest Generation Engine Mechanics successfully deployed, your development pipeline is 40% built‚Äîstellar debugging, and onward to crafting the ultimate logic layer! ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>