<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Compass of Discovery â€“ Analyzing Repositories and Extracting Insights - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'developer' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Codex of the Infinite Adventures</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Compass of Discovery â€“ Analyzing Repositories and Extracting Insights</h1>
<hr>
<p>The Codex opened again, revealing a shimmering trail of data, this time crafted for those who sought not treasures of gold, but insights from code repositories. With the &quot;Compass of Discovery&quot; in hand, the adventurers would venture deep into structured domains, where paths led through layers of repomix analysis, and maps were drawn with the intellect of language models. Patterns, configurations, and relationships awaited uncovering beneath the digital surfaceâ€”and the brave would come away not only with newfound understanding but the mastery of tools to guide others.  </p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Repomix Integration for Code Analysis</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file serves as the bridge between code repositories and high-dimensional insights. Its centerpiece is the <code class="inline-code">RepoAnalyzer</code> class, which runs <code class="inline-code">repomix</code> to extract project context while ensuring security and efficiency. The fileâ€™s key focus is on generating precise analyses tailored to specific files or entire codebases. This is achieved through a combination of validation methods that safeguard against path traversal and resource exhaustion and methods that format outputs for consumption by downstream systems. </p>
<p>The <code class="inline-code">generateRepomixContext()</code> function is a standout; it can fetch context for an entire codebase while adhering to ignore patterns and compression requirements. Similarly, <code class="inline-code">generateTargetedContent()</code> offers a precision strike, analyzing only selected files for more efficient and relevant results. Secure subprocess management is another highlight, with functions like <code class="inline-code">captureRepomixStdout()</code> ensuring repomix executions remain within buffer limits and execution time constraints.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext()</code>: Combines file validation and caching to produce a comprehensive project context.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles()</code>: Processes file paths to ensure security, deduplication, and within-directory validation.</li>
<li><code class="inline-code">captureRepomixStdout()</code>: Executes repomix as a subprocess with strict buffer and timeout controls.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Multi-Provider LLM Integration</h3>
<p>The <code class="inline-code">llm-client.ts</code> file enables seamless interaction with language models like OpenAIâ€™s GPT series and Azure OpenAI. Through its <code class="inline-code">LLMClient</code> class, this module abstracts connectivity, request building, and error handling, making it a linchpin for integrating natural language understanding into the adventure engine. The class constructor initializes the correct provider (e.g., OpenAI or Azure) based on environment configurations, while the <code class="inline-code">generateResponse()</code> function powers formatted prompt handling and parses responses. </p>
<p>An intelligent request interface ensures that the peculiarities of each model are handled with precision, as seen in the distinct handling of GPT-5 verbosity and reasoning parameters. Furthermore, the <code class="inline-code">logDetailedError()</code> function makes troubleshooting a breeze, logging useful diagnostics when something goes awry. This fileâ€™s role isnâ€™t just technicalâ€”itâ€™s the cornerstone of storytelling, feeding prompts and decoding the responses that shape the very narratives of the Codex. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse()</code>: Processes user prompts with timeout handling and response validation.</li>
<li><code class="inline-code">logTokenUsage()</code>: Tracks and displays token metrics for cost and efficiency management.</li>
<li><code class="inline-code">getApiKey()</code>: Determines the appropriate API key dynamically, ensuring provider compatibility.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) {
        return null;
      }

      const trimmed = file.trim();
      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
        console.warn(`Rejecting potentially unsafe file path: ${trimmed}`);
        return null;
      }

      return trimmed;
    })
    .filter((file): file is string =&gt; file !== null)
    .map(file =&gt; {
      const fullPath = path.resolve(projectPath, file);
      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) {
        console.warn(`Rejecting file outside project directory: ${file}`);
        return null;
      }

      if (!fs.existsSync(fullPath)) {
        console.warn(`Skipping non-existent file: \`${file}\``);
        return null;
      }

      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null)
    .sort();

  return safeFiles;
}
</code></pre>
<p>This is like filtering and cleaning a guest list before a party to ensure that attendees are valid, safe, and can actually show up.</p>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateTargetedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate targeted content, falling back to full repomix content: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const ignorePatterns = [
      &#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;
    ];

    if (!options.includeTests) {
      ignorePatterns.push(&#39;**/*.test.ts&#39;, &#39;**/*.spec.ts&#39;, &#39;**/tests/**&#39;, &#39;**/test/**&#39;);
    }

    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;),
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });

    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<p>This acts like compiling a travel guide from multiple sources, ensuring cached guides are updated and reusable for cost-efficiency.</p>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);

    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<p>This operates like sending a structured email to a professional, ensuring the response is clear and well-categorized.</p>
<pre><code class="language-typescript">private determineApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models.&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<p>This is like determining which key unlocks a specific set of doors, based on the type of lock.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">RepoAnalyzer.generateRepomixContext()</code> when you need all-encompassing data and cache efficiency.</li>
<li>Experiment with <code class="inline-code">LLMClient.generateResponse()</code> to fine-tune GPT-5-specific controls for verbosity or reasoning effort.</li>
<li>Review how caching strategies in <code class="inline-code">repo-analyzer.ts</code> balance performance with real-time data accuracy.</li>
</ul>
<hr>
<p>Congratulations on successfully refactoring your skill set and deploying new insights from Quest 3â€”your ability to analyze repositories and extract meaningful data structures is now a production-grade asset; onward to the next milestone, debug barriers crushed! ðŸš€âš¡ðŸ’Ž</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Gallery of Themes â€“ Shaping... â†’</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>