<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Chronicles of Code Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Chronicles of Code Analysis</h1>
<hr>
<p>In the realm of Codeoria, where creativity mingles with functionality, a great challenge looms. The sacred tools of the Code Guardians, <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code>, are intertwined in a delicate dance. They unlock secrets hidden deep within code repositories, forging pathways for adventurers to wield their power. Now, brave Devknights must master these tools and navigate the labyrinth of code analysis, where insights are fleeting and complexity reigns. Together, we decode the layers and build bridges between fragmented truths.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> RepoAnalyzer Analysis</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is a powerful utility for extracting actionable insights from repositories. Its primary tasks involve validating project paths, generating targeted Repomix content, and ensuring meaningful cache usage for efficient repeated analyses. Critical safeguard mechanisms prevent unsafe file manipulations, while compression options optimize content extraction. Functions such as <code class="inline-code">generateRepomixContext</code> and <code class="inline-code">captureRepomixStdout</code> offer advanced subprocess handling to integrate seamless codebase exploration workflows.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.generateRepomixContext</code>: Constructs contextual repository data using validated paths and modular options.</li>
<li><code class="inline-code">RepoAnalyzer.generateTargetedContent</code>: Focuses on extracting specific file content with optimized configurations.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code>: Handles subprocess interaction and extracts output with timeout/memory safeguards.</li>
<li><code class="inline-code">RepoAnalyzer.validateProjectPath</code>: Implements essential validation to ensure secure and predictable operations.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back: ${error.message}`);
    }
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);

  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const context = await this.captureRepomixStdout(
      [&#39;.&#39;], projectPath, { style: options.style || &#39;markdown&#39;, compress: options.compress !== false }
    );
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<p>Like a wise librarian retrieving relevant books from an expansive library, this function extracts meaningful repository snippets with efficiency.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);

  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);

  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const context = await this.captureRepomixStdout(
      [&#39;.&#39;], projectPath, { compress, include: safeFiles.join(&#39;,&#39;), style: &#39;markdown&#39; }
    );
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Targeted Repomix failed: ${error.message}`);
  }
}
</code></pre>
<p>Just like searching a specific section in the library, this function narrows focus to specific files and extracts only relevant content for analysis.</p>
<pre><code class="language-typescript">async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--style&#39;, options.style || &#39;markdown&#39;], { cwd });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;

    const timeout = setTimeout(() =&gt; {
      repomix.kill(&#39;SIGKILL&#39;);
      reject(new Error(`Timeout after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;

      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(`Output too large: ${stdoutSize} bytes`));
      }

      stdout += chunk;
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed (exit ${code}): ${stderr.trim()}`));
    });
  });
}
</code></pre>
<p>Similar to tuning an instrument to avoid errors during a performance, this function ensures precise subprocess control for smooth execution.</p>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> LLMClient Integration</h3>
<p>The <code class="inline-code">LLMClient</code> serves as the bridge between Codeoria&#39;s Devknights and large language models (LLMs). Its functions implement API interactions tailored to specific platforms like OpenAI or Azure. With configurations ensuring flexibility and error handling mechanisms for robustness, it manages critical operations such as fetching API credentials and invoking models for generating responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code>: Constructs and executes LLM requests, validating and post-processing their outputs.</li>
<li><code class="inline-code">LLMClient.constructor</code>: Initializes the client object, configuring the appropriate API and model.</li>
<li><code class="inline-code">LLMClient.getApiKey</code>: Determines the correct API key based on the provider‚Äôs requirements.</li>
<li><code class="inline-code">LLMClient.isAzureOpenAI</code>: Identifies if the Azure platform is used for interaction.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">export class LLMClient {
  constructor() {
    this.model = LLM_MODEL;

    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model
      });
    } else {
      this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
    }
  }
}
</code></pre>
<p>Like mapping the correct route for a journey, this constructor ensures that the right API setup powers LLM operations.</p>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    return { content };
  } catch (error) {
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<p>This function channels insightful prompts into the depths of the LLM, turning them into actionable results for Devknight quests.</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<p>Retrieving the key for a treasure chest, this function secures all necessary credentials for seamless access to the APIs.</p>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Caching Strategy:</strong> Utilize <code class="inline-code">generateOptimizedContent</code> in <code class="inline-code">RepoAnalyzer</code> for repeated target file analyses to save computation time.</li>
<li><strong>Timeout Handling:</strong> Adjust <code class="inline-code">LLM_REQUEST_TIMEOUT</code> in configurations for safer API integrations when dealing with longer prompts.</li>
<li><strong>Testing Workflow:</strong> Validate individual files with <code class="inline-code">validateAndNormalizeTargetFiles</code> before larger code extractions for predictable outputs.</li>
</ul>
<hr>
<p>Your mastery over the Realm of Codeoria grows stronger. Quest completed: Chronicles of Code Analysis!</p>
<p>Congratulations, developer! You&#39;ve successfully debugged the complexities of Quest 3: Chronicles of Code Analysis, optimizing your skills by 40% towards deployment-ready mastery‚Äîkeep pushing your codebase to infinity and beyond! üöÄüíé‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2: The Questsmith's Forg...</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: Thematic Frameworks o... ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>