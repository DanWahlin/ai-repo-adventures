<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Code Analysis & Content Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository Chronicles: Crafting a Dynamic Adventure Framework</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Code Analysis &amp; Content Pipeline</h1>
<hr>
<p>In this technical exploration, we delve into the heart of the repository‚Äôs code analysis and content pipeline capabilities. These tools form the backbone of Adventure Project‚Äôs ability to parse and optimize codebases for interactive storytelling. By understanding these components, developers can harness their full potential to extract targeted content and interact effectively with advanced LLM-powered systems. Let‚Äôs uncover the implementation facets of <code class="inline-code">repo-analyzer.ts</code> and <code class="inline-code">llm-client.ts</code> as they stand at the forefront of code analysis and LLM integration.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Analyzer Calibration</strong>: How does <code class="inline-code">RepoAnalyzer</code> validate project paths and ensure secure file handling?</li>
<li>‚ö° <strong>Pipeline Dynamics</strong>: What is the flow for generating optimized or targeted content, and how does caching improve performance?</li>
<li>üõ°Ô∏è <strong>LLM Interface Precision</strong>: How does <code class="inline-code">LLMClient</code> handle service-specific configurations and manage error responses for robustness?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Codebase Analyzer</h3>
<p>This file provides tools to process repository files and convert them into optimized storytelling elements. The <code class="inline-code">RepoAnalyzer</code> performs file validation, content optimization, caching, and invokes the Repomix CLI for code analysis. It ensures security, efficiency, and reliability in extracting relevant code sections.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Validates whether the provided project path is safe and usable.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Checks file paths for security risks and ensures they exist within acceptable boundaries.</li>
<li><code class="inline-code">generateOptimizedContent</code>: Produces a reduced token representation of repository files, focusing on essential functions.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Handles subprocess execution of Repomix with robust timeout and memory safeguards.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures the project path is not empty and checks against invalid inputs like null bytes.</li>
<li>Prevents potential file system errors by trimming and validating inputs.</li>
<li>Demonstrates basic defensive programming techniques to enhance reliability.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);

  // Deduplicate, validate, and normalize target files
  const safeFiles = [...new Set(targetFiles)].slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {/* security checks */})
    .filter(file =&gt; !!file)
    .sort();

  return safeFiles;
}
</code></pre>
<ul>
<li>Implements safety checks like deduplication, null byte filtering, and normalization.</li>
<li>Ensures target files exist within the project path to prevent path traversal vulnerabilities.</li>
<li>Limits the number of files for resource protection and sorts them for stable processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
  const optimizedContent = this.extractFunctionFocusedContent(fullContent);

  this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });

  return optimizedContent;
}
</code></pre>
<ul>
<li>Orchestrates content extraction with caching for efficiency.</li>
<li>Leverages <code class="inline-code">validateAndNormalizeTargetFiles</code> to ensure secure inputs.</li>
<li>Implements modular processing through <code class="inline-code">generateTargetedContent</code> and optimization methods.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The LLM Integration Hub</h3>
<p>This file connects the repository&#39;s capabilities with LLM services like OpenAI and Azure OpenAI. It manages API keys, models, and advanced functionality like GPT-5-specific parameters. Error handling and validations help create robust interactions with LLM systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">constructor</code>: Configures the LLM client while determining service-specific setup requirements.</li>
<li><code class="inline-code">getApiKey</code>: Selects appropriate API keys for different providers and validates their presence.</li>
<li><code class="inline-code">isAzureOpenAI</code>: Identifies if the base URL corresponds to Azure OpenAI endpoints.</li>
<li><code class="inline-code">generateResponse</code>: Prepares requests, handles errors, and processes returned content.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key.&#39;);
  }
  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, apiVersion: LLM_API_VERSION, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Configures the client to support both OpenAI and Azure OpenAI services.</li>
<li>Splits logic for endpoint setup and creates service-specific configurations.</li>
<li>Incorporates modularity for compatibility across multiple providers.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Handles logic to retrieve API keys for different use cases.</li>
<li>Ensures required environment variables are set, validating critical configurations.</li>
<li>Adds flexibility for multiple token configurations based on deployment contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Builds request parameters dynamically based on user input and model specifications.</li>
<li>Includes detailed error logging for robust debugging in production.</li>
<li>Processes and validates the response, including handling JSON formatting and token usage metrics.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Follow secure file validation patterns when working with user input or repository paths.</li>
<li>Consider implementing caching mechanisms to improve efficiency in recurring code processing or API calls.</li>
<li>Explore error handling techniques for external APIs to improve application resilience.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Quest 3 complete: You&#39;ve debugged the pipeline, refactored the codebase, and pushed your progress to 40%‚Äîa stellar commit in your dev journey; keep shipping brilliance! ‚ö°üöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>