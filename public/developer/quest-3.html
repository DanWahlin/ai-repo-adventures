<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Chamber of Analytical Repositories - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of the Codebase</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Chamber of Analytical Repositories</h1>
<hr>
<p>The Chamber of Analytical Repositories awaits! As caretaker of the Adventure Forge, you now face the intricate systems that process repositories into engaging adventures. The path leads you to the meticulous craftsmanship of the code analysis and content generation pipeline. With the aid of enchanted tools like the <code class="inline-code">RepoAnalyzer</code> and the <code class="inline-code">LLMClient</code>, you will weave together understanding from complex data structures and API integrations. Can you summon these powers to orchestrate precise responses and optimized repository analysis?</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Code Analysis Engine</h3>
<p>This file defines the <code class="inline-code">RepoAnalyzer</code> class, a core utility for interpreting and optimizing repository content. By leveraging cached results, file validation, and subprocess orchestration via <code class="inline-code">repomix</code>, it transforms project files to provide consumable insights for downstream processes. Critical functions include <code class="inline-code">generateRepomixContext</code>, <code class="inline-code">generateTargetedContent</code>, and <code class="inline-code">captureRepomixStdout</code>, which coordinate to ensure efficiency, security, and performance in analyzing repositories. These tools exemplify attention to both practical usage and resilient design.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAnalyzer.generateRepomixContext</code> dynamically generates codebase context using a layered caching strategy and fallback mechanisms.</li>
<li><code class="inline-code">RepoAnalyzer.generateTargetedContent</code> extracts content for specific files, ensuring secure file handling and robust error management.</li>
<li><code class="inline-code">RepoAnalyzer.captureRepomixStdout</code> executes the <code class="inline-code">repomix</code> tool, managing subprocess interactions with memory and timeout protections.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  // Check for specific files in the configuration
  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(&#39;Fallback to full repomix due to error:&#39;, error.message);
    }
  }

  // Generate full repomix output
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
      ...options,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;],
    });

    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<p>This function is akin to drawing a detailed map of a city, ensuring essential landmarks are highlighted while avoiding irrelevant noise.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) throw new Error(&#39;No valid target files found&#39;);

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
      compress,
      include: safeFiles.join(&#39;,&#39;),
    });

    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Targeted repomix failed: ${error.message}`);
  }
}
</code></pre>
<p>Much like extracting key chapters from a book, this function focuses only on the most relevant sections of the repository.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;];
    if (options.compress) args.push(&#39;--compress&#39;);
    if (options.include) args.push(&#39;--include&#39;, options.include);

    const repomix = spawn(&#39;npx&#39;, args, { cwd });
    let stdout = &#39;&#39;;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        isResolved = true;
        repomix.kill(&#39;SIGKILL&#39;);
        reject(new Error(&#39;Timeout exceeded for repomix subprocess&#39;));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdout += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (!isResolved) {
        isResolved = true;
        code === 0 ? resolve(stdout) : reject(new Error(&#39;Repomix subprocess failed&#39;));
      }
    });
  });
}
</code></pre>
<p>This subprocess manager mirrors a conductor coordinating an orchestra, ensuring each player performs within set time and memory limits.</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: AI-Powered Analysis Helper</h3>
<p>This file introduces the <code class="inline-code">LLMClient</code> class, which facilitates interaction with language models like OpenAI&#39;s APIs or Azure&#39;s cognitive services. By providing utilities for configuration, request construction, and retry logic, it ensures robust communication with external LLM (large language model) providers. The <code class="inline-code">generateResponse</code> function stands out as a powerful tool for transforming prompts into model-generated insights efficiently.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code> structures requests and processes responses from the LLM.</li>
<li><code class="inline-code">LLMClient.constructor</code> establishes API client configurations with fallback error checks.</li>
<li><code class="inline-code">LLMClient.getApiKey</code> determines the appropriate authentication key for the selected LLM provider.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);

    let content = this.validateResponse(completion);
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);
    return { content: content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<p>This function is similar to a translator, taking raw input (prompt) and conveying it as polished language for interaction.</p>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, apiVersion: LLM_API_VERSION });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<p>The constructor operates like a forge where all necessary tools are assembled to craft the desired output.</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<p>This function is like a keymaster determining which magical key unlocks the gates of the LLM.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Be judicious with cache policies in <code class="inline-code">RepoAnalyzer</code> for performance optimization.</li>
<li>Use the <code class="inline-code">generateResponse</code> function to abstract complex LLM operations into reusable workflows.</li>
<li>When interacting with <code class="inline-code">captureRepomixStdout</code>, ensure subprocess timeouts align with the average repository size.</li>
</ul>
<hr>
<p>Well done, adventurer! With deep insights into the Chamber of Analytical Repositories, you are one step closer to mastering this domain. Continue your journey, and let the Adventure Forge guide you onward!</p>
<p>Congratulations, developer‚ÄîQuest 3: Chamber of Analytical Repositories successfully committed; your codebase of knowledge now branches to 40%, unlocking robust analytical patterns and elevating your querying prowess to production-grade excellence! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>