<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle of Code Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Repository Chronicles</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle of Code Analysis</h1>
<hr>
<p>Amidst the labyrinth of computational wonder, you‚Äôve arrived at a critical juncture. The Oracle of Code Analysis awaits, its wisdom hidden within the intertwined threads of powerful code and exquisitely tuned mechanisms. Here lies the secret to transforming scattered data into coherent insights. The journey through these enchanted files will reveal pathways to automated understanding, bridging the laws of logic and the art of language models. To unlock the essence of the repository‚Äôs analyzer, you must study its core tools with precision and find harmony between validation, optimization, and invocation.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Optimization Effort</strong>: How does <code class="inline-code">RepoAnalyzer</code> optimize content output for reduced token usage while maintaining relevance?</li>
<li>‚ö° <strong>Invocation Mastery</strong>: What parameters does the <code class="inline-code">LLMClient</code> use to ensure compatibility with different APIs and models?</li>
<li>üõ°Ô∏è <strong>Validation Safeguards</strong>: How do safety and security checks protect against invalid paths or risky requests?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Content Extraction and Validation Logic</h3>
<p>This file houses the <code class="inline-code">RepoAnalyzer</code> class, a key component responsible for analyzing projects, optimizing content for lightweight representation, and invoking <code class="inline-code">repomix</code>. It ensures only valid file paths are processed while caching results for efficiency. By capturing the repomix subprocess‚Äôs output and providing function-focused filtering, it reduces redundancy and enhances utility. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Facilitates the generation of context from the entire codebase, incorporating caching and fallback mechanisms.</li>
<li><code class="inline-code">generateTargetedContent</code>: Tailors repomix output to specific files, validating paths and ensuring content focus.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes repomix as a subprocess, with timeout and memory protection to handle outputs safely.</li>
<li><code class="inline-code">validateProjectPath</code>: Performs basic validation for paths, ensuring reliability and security.</li>
<li><code class="inline-code">extractFunctionFocusedContent</code>: Optimizes the repomix output by keeping essential functions and discarding irrelevant details.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed optimized content, fallback to targeted: ${error}`);
    }
  }

  console.log(&#39;No specific config: analyzing full codebase (compressed)&#39;);
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const cliOptions = { 
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false, 
      removeComments: true, 
      removeEmptyLines: true, 
      noDirectoryStructure: true
    };
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Establishes context generation for a whole project, with a fallback hierarchy to ensure robust data extraction.</li>
<li>Utilizes caching for performance optimization and reduces redundant analysis of unchanged paths.</li>
<li>Supports dynamic configuration with optional parameters for customizing output.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  
  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Enforces basic checks to validate project paths, ensuring they are secure and properly formatted.</li>
<li>Prevents errors caused by empty strings or unsafe characters.</li>
<li>Guards against potentially malicious paths that include null bytes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [
      ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;
    ];
    if (options.compress) args.push(&#39;--compress&#39;);
    
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
    let stdout = &#39;&#39;, isResolved = false;
    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        isResolved = true;
        reject(new Error(`Timeout: ${REPOMIX_SUBPROCESS_TIMEOUT}`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      resolve(stdout.trim());
    });
    repomix.on(&#39;error&#39;, (error) =&gt; reject(new Error(`Repomix failed: ${error.message}`)));
  });
}
</code></pre>
<ul>
<li>Spawns a subprocess to execute repomix with runtime safety mechanisms.</li>
<li>Implements timeout handling to prevent memory exhaustion and excessive processing delays.</li>
<li>Uses flexible options to customize execution based on caller requirements.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Managing LLM Interactions</h3>
<p>This file contains the <code class="inline-code">LLMClient</code> class that interfaces with AI models such as OpenAI and Azure. It abstracts API interactions, handles dynamic configuration, and processes responses with robust error handling. Parameter validation ensures compatibility with various models.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Orchestrates the API request, determines request format, and ensures responses are validated for correctness.</li>
<li><code class="inline-code">constructor</code>: Configures the client, differentiating between OpenAI and Azure APIs.</li>
<li><code class="inline-code">getApiKey</code>: Dynamically fetches the appropriate API key based on the configured endpoint.</li>
<li><code class="inline-code">isAzureOpenAI</code>: Identifies if the service is utilizing Azure OpenAI endpoints.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Synthesizes a response by orchestrating request dispatch, content validation, and result logging.</li>
<li>Handles response formatting to adapt to JSON or plaintext output needs.</li>
<li>Includes robust error handling and logging for diagnostics.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Set LLM_BASE_URL and appropriate API key.&#39;);
  }
  this.client = this.isAzureOpenAI() ? 
    new AzureOpenAI({ endpoint: LLM_BASE_URL.split(&#39;/openai/&#39;)[0], apiKey, apiVersion: LLM_API_VERSION }) : 
    new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
}
</code></pre>
<ul>
<li>Dynamically initializes the client with the appropriate API provider.</li>
<li>Differentiates between OpenAI and Azure OpenAI using endpoint checks.</li>
<li>Ensures configuration variables are set to avoid runtime errors.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for Azure-hosted GitHub Models.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Retrieves API keys dynamically depending on the endpoint type.</li>
<li>Validates environmental variables to ensure correct authentication details are available.</li>
<li>Prevents misconfigured use cases by throwing descriptive errors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üó∫Ô∏è <strong>For Exploration</strong>: Trace how caching is achieved in both files to enhance reusability and performance.</li>
<li>üîí <strong>Validation Tips</strong>: Focus on how <code class="inline-code">validateProjectPath</code> and <code class="inline-code">validateResponse</code> enforce safety and correctness.</li>
<li>‚úçÔ∏è <strong>Next Steps</strong>: Prepare for interactions between the analyzer and story generator in upcoming quests.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations on successfully debugging the mysteries of &quot;Quest 3: The Oracle of Code Analysis&quot;‚Äîyour stack of skills is compounding faster than an optimized algorithm, keep refactoring towards greatness! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>