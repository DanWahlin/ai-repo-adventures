<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 5: Foundation & Utilities - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Modular Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 5: Foundation &amp; Utilities</h1>
<hr>
<p>This quest centers on the underlying code utilities that support the larger architecture of the storytelling experience. Focusing on foundational elements, you&#39;ll explore how critical configuration files are read, parsed, and formatted to enable seamless integration with other components. These utilities ensure proper data flow, structure validation, and optimization for dynamic processes.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Config Loader Investigation</strong>: How does <code class="inline-code">loadAdventureConfig</code> read raw configuration data, and what safeguards exist for file I/O?</li>
<li>‚ö° <strong>Parsing and Validation Study</strong>: What role does <code class="inline-code">parseAdventureConfig</code> play in managing configuration states, and how does it handle errors in JSON?</li>
<li>üõ°Ô∏è <strong>Path Extraction Analysis</strong>: How does <code class="inline-code">extractUniqueFilePaths</code> traverse the configuration to identify valid file paths, and what validation patterns does it use?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Adventure Configuration Utilities</h3>
<p>This utility file contains key functions tied to the loading, parsing, and processing of the adventure configuration file, <code class="inline-code">adventure.config.json</code>. At the heart of configuring quests and managing integrations with other components, these utilities include reading files, parsing JSON safely, and optimizing data transformation for use with language models and storytelling mechanisms.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Reads the raw configuration file based on the project path. It ensures graceful handling of cases where the file may be missing or unreadable.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Converts raw configuration text into a structured JSON object, catching and handling parsing errors effectively.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Traverses the parsed configuration to extract all unique and valid file paths, ensuring these paths exist within the project.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Formats the configuration into a compact structure suitable for large language models, reducing size and redundancy while preserving critical data.</li>
<li><code class="inline-code">extractCustomInstructions</code>: Retrieves custom instructions from the configuration for optimizing outputs in dynamic scenarios.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">function readFileIfExists(filePath: string): string | null {
  try {
    return fs.readFileSync(filePath, &#39;utf-8&#39;);
  } catch {
    // Missing or unreadable file is non-fatal
    return null;
  }
}

/**
 * Loads the raw adventure config text if present.
 * Pure file read - no parsing here.
 */
export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>This code handles file reading for the adventure configuration in a fail-safe manner, ensuring that missing or unreadable files will not break the operation.</li>
<li>The <code class="inline-code">readFileIfExists</code> helper wraps <code class="inline-code">fs.readFileSync</code> and gracefully returns <code class="inline-code">null</code> in case of errors, protecting against unhandled exceptions.</li>
<li><code class="inline-code">loadAdventureConfig</code> combines dynamic path resolution with this safe helper, ensuring that the operation is robust even in environments with corrupted or missing configuration files.</li>
<li>These utilities demonstrate fundamental patterns for reliability in file I/O operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Parses the adventure config into an object (or null on error/missing).
 * Single point of JSON parsing and validation.
 */
export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>This function is the central point for transforming the raw configuration string into a usable JSON object.</li>
<li>Safeguards against exceptions during JSON parsing are implemented using <code class="inline-code">try-catch</code>, ensuring null is returned for invalid input.</li>
<li>By layering on <code class="inline-code">loadAdventureConfig</code>, the function inherits its error handling for file reading, creating a cascade of protections.</li>
<li>This approach isolates JSON parsing into a dedicated function, adhering to the Single Responsibility Principle and improving testability.</li>
</ul>
<hr>
<pre><code class="language-typescript">/**
 * Extracts all unique, existing file paths referenced by &quot;path&quot; fields anywhere in the config.
 */
export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    // Extract and validate path
    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    // Add children to stack
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>This function identifies and validates file paths referenced within the configuration by traversing nested objects.</li>
<li>By utilizing a stack-based approach, it efficiently handles arbitrarily deep structures, avoiding recursion‚Äôs risk of stack overflow.</li>
<li>The <code class="inline-code">Set</code> is used to maintain uniqueness, ensuring that duplicate paths are filtered out automatically.</li>
<li>Validation is achieved through <code class="inline-code">fs.existsSync</code>, ensuring that only existing file paths are included in the results.</li>
<li>The function bridges configuration logic with filesystem state, serving as a critical intermediary between configuration data and the project structure.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To verify the configuration file‚Äôs structure, try testing with both valid and invalid JSON examples.</li>
<li>Experiment with the <code class="inline-code">extractUniqueFilePaths</code> function by adding nested <code class="inline-code">path</code> fields to the configuration to observe its traversal patterns.</li>
<li>Note the role of fail-safe mechanisms (e.g., <code class="inline-code">try-catch</code>) in building robust utilities.</li>
</ul>
<hr>
<p>You have mastered all the secrets of this storytelling system! Your adventure is complete.</p>
<p>Congratulations on successfully deploying Quest 5: Foundation &amp; Utilities‚Äîyour codebase is now 80% refactored with precision; you&#39;re just one final commit away from mastering the full stack! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="prev-quest-btn">‚Üê Previous: Quest 4</a>
        <a href="summary.html" class="next-quest-btn complete-btn">Complete Adventure ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>