<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Arcane Interface of Codexia - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codex of Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Arcane Interface of Codexia</h1>
<hr>
<p>In the bustling Kingdom of Codexia, a disturbance has reverberated through the Repository Core. The enchanted tools that weave the magical pathways are misaligned, threatening the intricate balance of interconnected realms. As a courageous Repository Chronicler, you are summoned to investigate the mystical underpinnings of the MCP Tool Interface. Your journey begins here, where you must decipher the methods that govern tool functionality and ensure the Codex remains a beacon of knowledge.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Inventory Compilation</strong>: How does <code class="inline-code">setupHandlers</code> dynamically generate and validate the list of tools available for the Codexia repository?</li>
<li>‚ö° <strong>Server Activation</strong>: What processes does <code class="inline-code">run</code> use to initialize the MCP server and prepare it for interaction?</li>
<li>üõ°Ô∏è <strong>Resilience in Chaos</strong>: How does the <code class="inline-code">main</code> function safeguard the server against unexpected failures during operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: Core MCP server implementation</h3>
<p>This file is the central hub for initializing and managing the MCP server within Codexia‚Äôs digital infrastructure. It orchestrates server setup, dynamically configures tool handlers, and ensures smooth communication between the Codex‚Äôs magical tools and its explorers. The highlights below reveal the inner workings of critical server functions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures request handlers, dynamically listing tools and validating their parameters using schemas. Ensures only valid tools execute.</li>
<li><code class="inline-code">run</code>: Activates the server, establishes communication transport, and warms up the repository content cache using <code class="inline-code">repoAnalyzer</code>.</li>
<li><code class="inline-code">main</code>: The entry point for the server, handling graceful shutdowns, error resilience, and signal-based cleanups to ensure continuous operations.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This function creates two request handlers for listing tools and executing them dynamically.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to convert validation schemas into JSON-compatible formats.</li>
<li>Ensures invalid tool names or arguments are caught early with descriptive error messages.</li>
<li>Delegates valid requests to tool handlers, maintaining modularity and extensibility.</li>
<li>Protects against unexpected errors using structured exception handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initiates the server with the <code class="inline-code">StdioServerTransport</code>, enabling communication with clients.</li>
<li>Prepares the repository cache in the background for optimized tool performance.</li>
<li>Logs critical steps and ensures the server is operational upon launch.</li>
<li>Links the server‚Äôs lifecycle to the current working directory, reinforcing dynamic adaptability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Ensures graceful termination for common OS signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Logs unhandled promise rejections without abruptly terminating the server, improving resilience.</li>
<li>Serves as the main entry point, wrapping server initialization in a robust error-handling block.</li>
<li>Offers diagnostic information when failures occur, aiding troubleshooting and support.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers</code> as a blueprint for adding new tools to Codexia‚Äôs interface.</li>
<li>Experiment with <code class="inline-code">run</code> in a local environment to understand cache pre-warming effects.</li>
<li>Extend <code class="inline-code">main</code> with additional signal handlers for customized shutdown procedures.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Successfully deployed &quot;Quest 1: The Arcane Interface of Codexia&quot; with zero critical bugs, refactored knowledge paths, and initialized momentum for the remaining sprints‚Äîstellar execution, dev pioneer! üöÄ‚ö°üíé</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>