<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Code Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<hr>
<p>A distress signal echoes across the Andromeda Cluster. The navigation systems of the <strong>Nebula Architect</strong> have fallen prey to a cascade of interstellar anomalies. Your mission begins with the intricate internals of the MCP Tool Interface‚Äîan essential module that will enable you to interact with cosmic subsystems and unlock new horizons. As you unravel its mysteries, you will discover the tools that power its precision and the mechanisms that ensure harmonized orchestration. Keep your scanners ready, adventurer, as this is just the beginning of your journey.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Dynamics Investigation</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically validate and register tools for the server?</li>
<li>‚ö° <strong>Operational Flow Analysis</strong>: What sequence of operations does the <code class="inline-code">run</code> function initialize for the MCP server‚Äôs execution?</li>
<li>üõ°Ô∏è <strong>Command Safety Protocol</strong>: How does the <code class="inline-code">main</code> function handle errors and ensure graceful shutdowns during unexpected events?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The heart of the MCP server</h3>
<p>This file orchestrates the entire server interface, combining user-request handlers, dynamic tool management, and system robustness. It also safeguards interstellar operations by validating tools through Zod schemas and enabling mission continuity via graceful shutdowns. Core methods like <code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code> are pivotal to initializing and ensuring the server‚Äôs effective operations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers available tools with validation. It converts schemas to JSON for communication, ensuring input integrity while allowing flexibility for new tools.</li>
<li><code class="inline-code">run</code> establishes the primary MCP transport, leveraging <code class="inline-code">StdioServerTransport</code>. It also pre-generates analysis content in the background, improving performance for future requests.</li>
<li><code class="inline-code">main</code> coordinates the entire startup process, handling graceful shutdowns and unexpected errors, crucial for long-term system stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code performs dynamic tool management through <code class="inline-code">setRequestHandler</code>. It maps and validates tools in real-time.</li>
<li>Zod schemas safeguard input validation, converting structures to JSON for interoperability.</li>
<li>Developers using this function enjoy extensibility for new tools while ensuring robust error handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server using <code class="inline-code">StdioServerTransport</code> for seamless interaction via standard I/O.</li>
<li>Background tools like <code class="inline-code">repoAnalyzer.preGenerate</code> improve performance by priming the analysis cache for operations.</li>
<li>This approach leverages asynchronous processing to balance initialization with real-time interactivity.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function oversees the server lifecycle, leveraging signal-based shutdown mechanisms for safe termination.</li>
<li>Resilient to unhandled promise rejections, the function ensures the server continues to operate where recoverable.</li>
<li>This robust design incorporates error logging and rapid diagnostics for mission-critical stability.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Repository tools module</h3>
<p>This file implements the MCP tools for codebase exploration. Each tool encapsulates a specific mission-critical function‚Äîcreating immersive, gamified experiences for managing repositories. These tools conform to the MCP framework and are dynamically registered to the server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> analyzes the codebase and sets introductory stage options.</li>
<li><code class="inline-code">choose_theme.handler</code> generates custom narratives by selecting a thematic journey.</li>
<li><code class="inline-code">explore_quest.handler</code> handles the individual exploration of quests for step-wise code discovery.</li>
<li><code class="inline-code">view_progress.handler</code> compiles quest progress and tracks achievements for the overarching mission.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>This code exports all tools for instant registration, aligning with MCP‚Äôs modular design.</li>
<li>Each external tool module (e.g., <code class="inline-code">start-adventure.js</code>) simplifies maintenance and promotes reusability.</li>
<li>These tools are essential for clients to interact with MCP, ensuring a consistent and gamified interface.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review the <code class="inline-code">setupHandlers</code> code for dynamic approaches to listing and validating tools.</li>
<li>Consider the <code class="inline-code">run</code> function‚Äôs use of background processing to anticipate high-performance requirements.</li>
<li>Study how <code class="inline-code">main</code> protects the system from unexpected failures and ensures uptime during anomalies.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar work on mastering the MCP Tool Interface‚Äîyour mission has thrusted into orbit, clearing the launchpad for the next cosmic adventure! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>