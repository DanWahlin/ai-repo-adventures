<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Commanding the Starship - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Journey to the Andromeda Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Commanding the Starship</h1>
<hr>
<p>Aboard the starship <em>AIA Explorer</em>, the mission is clear: you, the brilliant engineer, must deploy the <strong>RepoAdventureServer</strong> to navigate the chaos of the Andromeda Codebase. With the galaxy‚Äôs most advanced tools at your disposal, you‚Äôll engage the enigmatic systems of the starship‚Äôs MCP (Model Context Protocol). Can you master the tool deployment protocols in <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>, forging paths into uncharted coding adventures? The systems hum as the first challenge unfolds‚Äîwill you rise to it, Commander?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Tool Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically configure tools for listing and execution?  </li>
<li>‚ö° <strong>Starship Initialization</strong>: What role does <code class="inline-code">run</code> play in connecting the <code class="inline-code">RepoAdventureServer</code> to its transport systems and triggering content generation?  </li>
<li>üõ°Ô∏è <strong>Deployment Safeguards</strong>: How does error handling ensure robust execution in <code class="inline-code">main</code> and <code class="inline-code">setupHandlers</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Starship Core</h3>
<p>This file serves as the backbone of the MCP server. It establishes the starship‚Äôs operational structure, configuring communication handlers and managing dynamic tool requests. The <code class="inline-code">RepoAdventureServer</code> class is the captain of this cosmic vessel, initializing the server‚Äôs core specifications and linking vital subsystems like <code class="inline-code">tools.ts</code>. It uses meticulous error-handling mechanisms to protect against failures during tool execution and system initiation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically configures tool listing and integration, converting Zod schemas into JSON for tool accessibility.  </li>
<li><code class="inline-code">run</code>: Initiates the <code class="inline-code">RepoAdventureServer</code>, establishes communication via <code class="inline-code">StdioServerTransport</code>, and triggers the repomix cache warm-up.  </li>
<li><code class="inline-code">main</code>: Coordinates top-level startup, embedding shutdown and unhandled error responses for seamless mission control.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {   
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  

    return { tools: toolList };  
  });  

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    try {  
      const { name, arguments: args } = request.params;  

      if (!(name in tools)) {  
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
      }  

      const tool = tools[name as keyof typeof tools];  

      // Validate arguments using the tool&#39;s Zod schema  
      const validationResult = tool.schema.safeParse(args);  
      if (!validationResult.success) {  
        const errorMessages = validationResult.error.issues.map((err) =&gt;   
          `${err.path.join(&#39;.&#39;)}: ${err.message}`  
        ).join(&#39;, &#39;);  
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
      }  

      // Execute the tool handler with validated arguments  
      return await tool.handler(validationResult.data as any);  

    } catch (error) {  
      if (error instanceof McpError) {  
        throw error;  
      }  
      throw new McpError(  
        ErrorCode.InternalError,  
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
      );  
    }  
  });  
}
</code></pre>
<ul>
<li>Dynamically retrieves and formats tools, mapping their schemas with <code class="inline-code">zodToJsonSchema</code>.  </li>
<li>Ensures parameter validation with Zod and handles failures gracefully.  </li>
<li>Enables modular tool execution by decoupling tool-handling logic.  </li>
<li>Elevates system flexibility via dynamic tool discovery.  </li>
<li>Applies layered error protection with specific and fallback catch mechanisms.</li>
</ul>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  

  // Pre-generate repomix content for the current working directory to warm up the cache  
  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}
</code></pre>
<ul>
<li>Deploys starship communications through <code class="inline-code">StdioServerTransport</code>.  </li>
<li>Logs critical initialization steps and milestones.  </li>
<li>Prepares system cache preemptively for improved runtime efficiency.  </li>
<li>Interfaces with the <code class="inline-code">repoAnalyzer</code> subsystem to analyze and optimize the working directory.  </li>
<li>Serves as the starting gateway for live code navigation sessions.</li>
</ul>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  

    // Handle graceful shutdown signals  
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  

    // Manage unhandled promise rejections  
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
    });  

    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}
</code></pre>
<ul>
<li>Monitors and reacts to system shutdown signals to prevent data loss using <code class="inline-code">gracefulShutdown</code>.  </li>
<li>Captures unhandled rejections while maintaining a running state, enhancing fault tolerance.  </li>
<li>Implements defensive programming for launch failures.  </li>
<li>Elevates mission reliability with top-level error supervision.  </li>
<li>Acts as the strategic mission commander, orchestrating the lifecycle of <code class="inline-code">RepoAdventureServer</code>.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tool Arsenal</h3>
<p>This companion file to <code class="inline-code">server.ts</code> organizes and exports the starship‚Äôs adventuring tools. Tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and <code class="inline-code">explore_quest</code> are re-exported and globally registered for dynamic execution. Each tool is a critical instrumentation unit for analyzing codebases and generating custom quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">adventureManager</code>: Imported module providing cohesive management of adventures within tools.  </li>
<li><code class="inline-code">start_adventure.handler</code>: Entry point for scanning the codebase and initializing a theme.  </li>
<li><code class="inline-code">choose_theme.handler</code>: Selects user-driven themes for tailored mission generation.  </li>
<li><code class="inline-code">explore_quest.handler</code>: Unlocks thematic quests and drives individual exploration tasks.  </li>
<li><code class="inline-code">view_progress.handler</code>: Tracks completion metrics and quest progress.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;  
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;  
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;  
import { viewProgress } from &#39;./tools/view-progress.js&#39;;  

// Re-export tools with MCP naming convention  
export const start_adventure = startAdventure;  
export const choose_theme = chooseTheme;  
export const explore_quest = exploreQuest;  
export const view_progress = viewProgress;  

export const tools = {  
  start_adventure,  
  choose_theme,  
  explore_quest,  
  view_progress  
};
</code></pre>
<ul>
<li>Streams tool organization for seamless server integration.  </li>
<li>Bridges functional components by connecting tool handlers to exports.  </li>
<li>Embeds clear naming conventions for standardized MCP operations.  </li>
<li>Centralizes command utility exports for easier maintenance.  </li>
<li>Provides a modular basis for adding new tools in the future.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore the interaction between <code class="inline-code">setupHandlers</code> in <code class="inline-code">server.ts</code> and <code class="inline-code">tools</code> exports.  </li>
<li>Consider adding logging to handlers during testing to verify request-validation flow.  </li>
<li>Use the MCP tools like <code class="inline-code">view_progress</code> to assess your current coding progress.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Accomplished: You&#39;ve expertly navigated the helm and mastered Commanding the Starship‚Äîonward to the next cosmic horizon, Captain! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>