<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the Galactic MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Horizons: Adventures in Galactic Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the Galactic MCP Interface</h1>
<hr>
<p>The data streams of the Code Nebula pulse with enigmas waiting to be unraveled. Your crew aboard the <em>Horizons</em> has received its first directive: establish a connection and deploy tools to navigate the Galactic MCP Interface. This cutting-edge system will be the bridge to exploring the mysteries hidden within the Nebula&#39;s computational currents. Featuring dynamic tool management and stellar integration points, your mission is to calibrate and launch the MCP server, investigate its modular architecture, and dive into its tool-driven functions. Success will pave the way to greater cosmic revelations. Will your crew rise to the challenge?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Signal Mapping</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically configure and handle MCP server tools?</li>
<li>‚ö° <strong>Server Initialization</strong>: What processes are orchestrated by <code class="inline-code">run</code> to establish a stable connection with the Galactic MCP Interface?</li>
<li>üõ°Ô∏è <strong>Safeguard Protocols</strong>: How does the <code class="inline-code">main</code> function implement safety measures to ensure graceful degradation during unexpected errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server</h3>
<p>The <code class="inline-code">server.ts</code> file serves as the headquarters for launching and powering the Repo Adventure MCP server. It constructs the server, maps tools dynamically, and ensures smooth operation during runtime. Key concepts include dynamic tool setups, graceful shutdown handling, and maintaining robustness through error management.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the server by dynamically listing tools and setting up handlers to validate and execute tool requests.</li>
<li><code class="inline-code">run</code>: Establishes the server connection, pre-generates content, and initializes the Galactic MCP Interface.</li>
<li><code class="inline-code">main</code>: Coordinates server startup, handles termination signals, and protects against unrecoverable errors.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically resolves all available tools, using <code class="inline-code">zodToJsonSchema</code> to convert schemas into JSON-compatible formats.</li>
<li>Handles execution validation with <code class="inline-code">zod</code> to ensure inputs meet the defined schema requirements.</li>
<li>Implements error handling for unknown tools, invalid parameters, and internal failures.</li>
<li>Separates tool listing and execution workflows to maintain modularity and readability.</li>
<li>Demonstrates robust API design by wrapping operations in try-catch blocks for better error control.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the MCP server connection using the <code class="inline-code">StdioServerTransport</code> protocol for inter-process communication.</li>
<li>Logs server status and announces readiness for operational commands.</li>
<li>Boots up background systems like <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize performance by caching project data.</li>
<li>Integrates diagnostics with <code class="inline-code">console.error</code> calls to enhance visibility during runtime.</li>
<li>Illustrates asynchronous programming patterns using <code class="inline-code">await</code> in server operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Centralizes server management by encapsulating all initialization logic in <code class="inline-code">main</code>.</li>
<li>Implements shutdown hooks to capture termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and initiate cleanup via <code class="inline-code">gracefulShutdown</code>.</li>
<li>Handles promise rejections globally and ensures error reporting does not disrupt server operations.</li>
<li>Protects against fatal failures with top-level exception handling around server initialization.</li>
<li>Coordinates lifecycle stages to ensure smooth startup and safe termination of the MCP server.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üõ†Ô∏è When reviewing <code class="inline-code">setupHandlers</code>, notice how <code class="inline-code">tools</code> are dynamically converted into structured metadata using <code class="inline-code">zodToJsonSchema</code> for schema validation.</li>
<li>üöÄ Understand the <code class="inline-code">run</code> function within the broader context of pre-generating content‚Äîa key efficiency step for large repositories.</li>
<li>üåå Pay close attention to how <code class="inline-code">main</code> ensures the system can recover gracefully during unexpected errors or signals.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Accomplished, Star Voyager‚ÄîQuest 1 complete! You&#39;ve boldly mastered the Galactic MCP Interface, igniting your cosmic journey with stellar precision and unstoppable momentum! üöÄ‚ú®üì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>