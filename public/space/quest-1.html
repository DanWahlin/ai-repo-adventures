<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Command Bridge Synchronization - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship RepoVenture: Charting the Code Galaxy</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Command Bridge Synchronization</h1>
<hr>
<p>Your starship‚Äôs command bridge hums as reactors funnel context toward the LLM core. The crew gathers: scanners tuned to repositories, navigation validating themes, and analyzers ready to stream nebula slices. Today‚Äôs mission: synchronize the bridge‚Äôs MCP interface so tools can be listed, validated, and executed across the cosmic bus. You will chart how requests flow from the Stdio transport to tool handlers and back, ensuring clean error vectors and warm caches. Steady your orbit, captain‚Äîthis synchronization aligns our trajectory for all future adventures.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">setupHandlers</code> dynamically enumerate tools and transform Zod schemas into JSON Schema for MCP discovery?</li>
<li>‚ö° Reactor Warm-Up: In <code class="inline-code">run</code>, how does the server initialize transport and pre-generate analysis to optimize future calls without blocking the bridge?</li>
<li>üõ°Ô∏è Fault Containment Shields: In <code class="inline-code">setupHandlers</code> and <code class="inline-code">main</code>, how are invalid tool names, parameter validation errors, and unhandled rejections managed to keep the ship stable?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP command bridge server and lifecycle</h3>
<p>This file establishes the MCP server that coordinates the crew‚Äôs tools over stdio, validates incoming requests, and executes tool handlers with schema-validated inputs. The <code class="inline-code">RepoAdventureServer</code> configures name, version, and declared capabilities, then calls <code class="inline-code">setupHandlers</code> to bind two essential request pathways: listing available tools and executing a selected tool. For discovery, it translates each tool‚Äôs Zod <code class="inline-code">schema</code> into a JSON Schema via <code class="inline-code">zodToJsonSchema</code>, enabling the navigation systems (MCP clients) to visualize expected inputs. For execution, the server cross-checks tool existence and validates arguments by invoking each tool‚Äôs <code class="inline-code">schema.safeParse</code>. On failure, it throws <code class="inline-code">McpError</code> with precise <code class="inline-code">ErrorCode</code> values, ensuring clean diagnostics to the caller. The <code class="inline-code">run</code> method connects the <code class="inline-code">StdioServerTransport</code>, logs operational status, and triggers <code class="inline-code">repoAnalyzer.preGenerate</code> to warm the cache for the current project path, improving responsiveness during later missions. The <code class="inline-code">main</code> function brings it together: registers graceful shutdown on <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, captures unhandled promise rejections without terminating normal operation, and starts the server. The auxiliary <code class="inline-code">gracefulShutdown</code> attempts <code class="inline-code">repoAnalyzer.cleanup</code> and exits safely, ensuring the bridge maintains integrity during orbit changes or reactor cooldowns.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools, converts Zod schemas to JSON Schema for MCP discovery, validates inputs, executes handlers, and maps failures to <code class="inline-code">McpError</code> for reliable telemetry.</li>
<li><code class="inline-code">run</code> activates stdio transport, connects the MCP server, logs operational status, and warms analysis caches with <code class="inline-code">repoAnalyzer.preGenerate</code> to reduce future latency.</li>
<li><code class="inline-code">main</code> orchestrates startup, signal-based graceful shutdown, and unhandled rejection logging to maintain stability without abrupt deorbiting.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}
</code></pre>
<ul>
<li>This code defines the MCP server configuration and attaches request handlers for tool listing and execution.</li>
<li>It uses <code class="inline-code">zodToJsonSchema</code> to expose tool input contracts to MCP clients, aiding navigation systems.</li>
<li>Validation via <code class="inline-code">schema.safeParse</code> ensures only correct inputs reach tool handlers, improving reliability.</li>
<li>Errors are normalized into <code class="inline-code">McpError</code> with <code class="inline-code">ErrorCode</code> mappings for consistent client responses.</li>
<li><code class="inline-code">run</code> connects the stdio transport and warms caches to reduce latency for subsequent analysis missions.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}

async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li><code class="inline-code">gracefulShutdown</code> ensures analyzers are cleaned up and the process exits predictably on termination signals.</li>
<li><code class="inline-code">main</code> constructs the server, binds signal listeners, and logs unhandled rejections without stopping normal operations.</li>
<li>The decision to avoid shutdown on unhandled rejections favors uptime and resilience for long-running missions.</li>
<li>Fatal startup errors still trigger a non-zero exit, preserving observability and operational correctness.</li>
<li>The final <code class="inline-code">main().catch</code> safety net captures unexpected top-level failures to maintain consistent logging.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace the flow from <code class="inline-code">setRequestHandler</code> to tool execution and observe how validation gates tool handlers.</li>
<li>Compare <code class="inline-code">ErrorCode.MethodNotFound</code>, <code class="inline-code">ErrorCode.InvalidParams</code>, and <code class="inline-code">ErrorCode.InternalError</code> to see layered fault isolation.</li>
<li>Note how cache warm-up in <code class="inline-code">run</code> is non-blocking for incoming requests, optimizing throughput after launch.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission log update: With Quest 1: Command Bridge Synchronization secured, your starship systems align in flawless orbit‚Äîstellar work, Captain‚Äîlaunch momentum engaged for the remaining 4 quests as we chart a victorious course through the cosmos! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>