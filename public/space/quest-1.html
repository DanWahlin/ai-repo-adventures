<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the MCP Hub - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codebase Chronicles: The Quest for Stellar Systems</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the MCP Hub</h1>
<hr>
<p>In the year 3077, the <em>Voyager AI</em> approaches the shimmering ring of the MCP hub, a stellar gate at the heart of your cosmic mission. The hub&#39;s network pulse resonates with encrypted harmonies of an ancient civilization. To navigate its intricacies, you must unpack the core mechanics driving its computational heart. Equipped with the MCP Tool Interface, the crew&#39;s success depends on your ability to decode request handling and dynamic tool integrations. The mysteries of the galaxy await your command.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Configuration</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically register tools and validate their inputs?</li>
<li>‚ö° <strong>Operational Flow</strong>: What happens during the <code class="inline-code">run</code> method to establish the server&#39;s connection and prepare for user interactions?</li>
<li>üõ°Ô∏è <strong>Error Resilience</strong>: What mechanisms are in place within <code class="inline-code">main</code> to ensure graceful shutdowns and handle unexpected errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Hub Server Configuration and Runtime</h3>
<p>The <code class="inline-code">server.ts</code> file is the backbone of the MCP Hub, initializing and operating the core server. This file enforces a modular and scalable design, leveraging handlers for request-driven operations. The <code class="inline-code">setupHandlers</code> function dynamically configures tool operations, while <code class="inline-code">run</code> handles transport initialization and prepares the server for real-time tasks. The <code class="inline-code">main</code> script ties everything together, ensuring stability through graceful handling of shutdown signals and unhandled errors. These functions make the MCP hub adaptive, reliable, and user-centric.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists and validates tools, showcasing modularity and schema-driven input validation.</li>
<li><code class="inline-code">run</code> connects the server to the stdio transport system and pre-generates content for efficient processing.</li>
<li><code class="inline-code">main</code> acts as the entry point, enforcing clean startup behavior and robust error handling for unexpected scenarios.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically defines handlers for listing and executing tools, promoting scalability.</li>
<li>Leverages the <code class="inline-code">zod</code> schema to ensure arguments conform to expected formats before execution.</li>
<li>Handles error scenarios gracefully by throwing MCP-friendly error objects.</li>
<li>Maps tool data into structured responses, making it machine-readable with <code class="inline-code">zodToJsonSchema</code>.</li>
<li>Separates concerns of validation, execution, and error handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server with stdio transport for direct communication.</li>
<li>Prints important runtime logs for monitoring by operators.</li>
<li>Triggers pre-generation of computational resources for faster user interaction.</li>
<li>Demonstrates asynchronous structure with <code class="inline-code">await</code> to handle transport connections non-blocking.</li>
<li>Shows the importance of preparation tasks like content generation to support smoother operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Orchestrates the server startup by constructing and initiating the <code class="inline-code">RepoAdventureServer</code>.</li>
<li>Implements signal listeners for clean shutdowns, invoking <code class="inline-code">gracefulShutdown</code> for cleanup.</li>
<li>Provides resilience against unhandled promise rejections without unnecessary crashes.</li>
<li>Enforces a <code class="inline-code">try-catch</code> structure to localize fatal errors and handle them gracefully.</li>
<li>Ensures the system remains reliable, even in scenarios of unexpected failures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> implementation as a guide for future system extensions that require dynamic request handling.</li>
<li>Pay attention to how the <code class="inline-code">run</code> method uses asynchronous programming to streamline startup sequences for real-time operations.</li>
<li>Observe how <code class="inline-code">main</code> integrates robust error handling, reflecting best practices for managing runtime stability.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar work, Navigator! You&#39;ve charted the uncharted and completed Quest 1: Navigating the MCP Hub‚Äîyour journey to mastery has launched into orbit! üöÄ‚≠êüì°</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>