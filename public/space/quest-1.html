<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Command Deck Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Cosmic Codebase</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Command Deck Interface</h1>
<hr>
<p>The <strong>Starship Repomix</strong> is alive with the hum of data coursing through its systems, but the Command Deck Interface remains the nerve center of the ship. Tasked with coordinating countless operations, it serves as the crew&#39;s primary gateway for exploration and interaction with the galaxy of code hidden in the Repomix&#39;s vast data cores. Today, your mission is clear: explore the intricate mechanisms around tool execution and server connectivity within the Command Deck. From handling dynamic requests to pre-generating mission-critical content, your work ensures the success of every mission.</p>
<p>Step forward, adventurer. The deck awaits your direction.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Command Layout Scan</strong>: How are tools dynamically listed and verified for compatibility in <code class="inline-code">setupHandlers</code>?</li>
<li>‚ö° <strong>Interface Flow</strong>: How does the server establish connection and initialize pre-generation in <code class="inline-code">run</code> and <code class="inline-code">main</code>?</li>
<li>üõ°Ô∏è <strong>Error Horizon</strong>: What safeguards and error responses are in place for tool execution and server operations?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> packages/mcp/src/server.ts</h3>
<p>The Command Deck setup revolves around the <code class="inline-code">RepoAdventureServer</code>. This file implements the server interface that processes incoming requests, dynamically lists available tools, and ensures error-resilient operation. It also introduces pre-cached content generation for seamless performance. Entirely modular, the <code class="inline-code">run</code> and <code class="inline-code">setupHandlers</code> methods coordinate the lifecycle of this server.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically configures the server to list and execute tools while validating inputs using the Zod schema system.</li>
<li><code class="inline-code">run</code>: Initializes the server, sets up transport, and pre-generates repository context for improved performance.</li>
<li><code class="inline-code">main</code>: Handles lifecycle control including startup, shutdown, and unhandled errors for a robust operational interface.</li>
</ul>
<h2>Code</h2>
<h3><span class="header-prefix">File:</span> packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically builds a tool list by parsing entries from <code class="inline-code">tools</code> with Zod schema validation.</li>
<li>Implements robust verification for unknown tools and invalid arguments, raising precise error messages.</li>
<li>Enables modularity, allowing addition or removal of tools without major structural changes.</li>
<li>Utilizes <code class="inline-code">zodToJsonSchema</code> for seamless schema conversion into JSON Schema draft 7 for compatibility.</li>
<li>Guarantees input validation, improving tool execution stability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server connectivity using <code class="inline-code">StdioServerTransport</code>, ensuring reliable I/O transport for commands.</li>
<li>Pre-generates repository context for faster response times during actual tool execution.</li>
<li>Demonstrates asynchronous design patterns to initialize essential processes without blocking the main execution thread.</li>
<li>Highlights modular principles, enabling future enhancement of transport methods.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements lifecycle management, ensuring the server can handle startup, shutdown, and runtime errors cleanly.</li>
<li>Employs signal handling with <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> for safe termination during interruptions.</li>
<li>Logs unhandled promise rejections for effective error analysis while maintaining server uptime.</li>
<li>Builds fault tolerance into critical initialization steps, enhancing the robustness of service launch.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the Command Deck handler validation patterns (<code class="inline-code">zodToJsonSchema</code>, <code class="inline-code">safeParse</code>) to standardize your own validation systems.</li>
<li>Pay attention to the modular structure of <code class="inline-code">tools</code>‚Äîit ensures that each functionality remains self-contained and easier to debug or extend in future updates.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Cadet! You&#39;ve expertly charted the Command Deck Interface‚Äîyour starship systems are now primed for cosmic exploration! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>