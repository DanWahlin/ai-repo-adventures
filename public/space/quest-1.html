<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface Deployment - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Repository Adventures</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface Deployment</h1>
<hr>
<p>Amid the vast nebulas of Codex Prime, your mission as crew aboard the <em>CodeSeeker</em> has entered a critical phase. The alien repository has revealed its next enigma: deploying the Master Control Protocol (MCP) Tool Interface. This toolset is the keystone to decoding Codex Prime‚Äôs encrypted data streams. To succeed, you must master its initialization routines and handler execution pathways. Remember, brave explorer, every <code class="inline-code">function</code> is a map to the repository‚Äôs stellar secrets. Are you ready to interface with the unknown?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Protocol Scanner</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically manage tool discovery and usage?</li>
<li>‚ö° <strong>Stellar Initialization</strong>: What sequence of operations do <code class="inline-code">run</code> and <code class="inline-code">main</code> set up to start the MCP server?</li>
<li>üõ°Ô∏è <strong>Core Command Safety</strong>: How does the system handle validation and error scenarios during tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server and handlers</h3>
<p>This file is the backbone of the MCP Tool Interface, defining its server structure, capabilities, and handlers. The <code class="inline-code">RepoAdventureServer</code> class encapsulates the server‚Äôs creation, tool registration, and execution logic. Key functionalities ensure a seamless blend of dynamic programming and robust error management.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists and validates tools for interactive user commands.</li>
<li><code class="inline-code">run</code> initializes the server transport and prepares pre-generated repository analysis.</li>
<li><code class="inline-code">main</code> orchestrates the server launch while handling signals and unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This function registers handlers for listing and executing tools dynamically at runtime.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> organizes the tools and generates schemas for their inputs using <code class="inline-code">zod-to-json-schema</code>.</li>
<li>It uses <code class="inline-code">safeParse</code> to validate user inputs against the required schema, ensuring robust error handling before execution.</li>
<li>Connecting this to the <code class="inline-code">CallToolRequestSchema</code> creates a seamless pipeline for requesting and applying tools dynamically.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the MCP server by connecting it to <code class="inline-code">StdioServerTransport</code>, a key component for the interprocess exchange.</li>
<li>The <code class="inline-code">preGenerate</code> function warms up the cache for the current project directory by precomputing repository analysis.</li>
<li>This design improves performance, enabling faster responses during runtime exploration.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function is the primary entry point for the server and handles lifecycle events such as initialization, signal shutdown, and unexpected errors.</li>
<li>Gracefully manages resources during shutdown using <code class="inline-code">gracefulShutdown</code>, a vital component for preventing residual state issues.</li>
<li>Ensures the server remains robust by not shutting down due to unhandled promise rejections, which would otherwise disrupt ongoing tasks.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool definitions</h3>
<p>This file exports the tools available in the MCP system. Each tool has clear boundaries, roles, and schema-based validations for input/output. The <code class="inline-code">tools</code> object serves as the root directory for tool registration and execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initializes a new adventure based on the user‚Äôs selected repository.</li>
<li><code class="inline-code">choose_theme.handler</code> creates a custom story and quests tied to a specific theme.</li>
<li><code class="inline-code">explore_quest.handler</code> allows ongoing engagement with individual challenges within an adventure.</li>
<li><code class="inline-code">view_progress.handler</code> traces a user‚Äôs exploration status and percentage completion.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Each tool serves a distinct purpose in the exploration journey and is registered using MCP naming conventions.</li>
<li>The <code class="inline-code">tools</code> object centralizes all available operations, simplifying dynamic tool handling in the server.</li>
<li>Modular design enables extending the toolset without modifying the core components.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Modularity Matters</strong>: Study how each tool and the server interacts; this is key for expanding capabilities while preserving stability.</li>
<li><strong>Validation for the Win</strong>: Observe how input schemas are leveraged to safeguard tool executions.</li>
<li><strong>Follow the Flow</strong>: Trace function calls between <code class="inline-code">RepoAdventureServer</code> and <code class="inline-code">tools</code> to ensure understanding of the toolset lifecycle.</li>
</ul>
<hr>
<p>Your navigation into the MCP interface has just begun, intrepid explorer! The secrets of Codex Prime await‚Äîforge ahead with knowledge as your guide.</p>
<p>üöÄ Stellar achievement unlocked: Quest 1 complete‚ÄîMCP Tool Interface Deployment is a flawless liftoff toward your cosmic learning odyssey!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>