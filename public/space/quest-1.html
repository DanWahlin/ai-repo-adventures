<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Command Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Stellar Repository Exploration: A Space Adventure</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Command Bridge</h1>
<hr>
<p>The Command Bridge of your starship has initiated the core MCP system, central to decoding alien codebases across the cosmic galaxy. This interactive server system will serve as the backbone for future quests, enabling your crew to execute advanced tools and dynamically process requests. Your mission begins with investigating the structure and operational mechanics of this bridge‚Äìensure its protocols are safeguarded and its tools calibrated for deep-space mysteries.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Protocol Scanning</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically validate tools and handle their execution requests?</li>
<li>‚ö° <strong>Transport Link Activation</strong>: What is the role of the <code class="inline-code">run</code> function in connecting the MCP server to its interstellar transport system?</li>
<li>üõ°Ô∏è <strong>Signal Shielding Mechanisms</strong>: How does the <code class="inline-code">main</code> function handle system interruptions and safeguard operations against unexpected failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Functionality Overview</h3>
<p>This file serves as the primary interface of the starship&#39;s MCP Command Bridge. It initiates a <code class="inline-code">RepoAdventureServer</code> instance, orchestrating tool execution via dynamic handler requests and establishing a connection through transport systems like <code class="inline-code">StdioServerTransport</code>. The <code class="inline-code">main</code> function also integrates graceful shutdown mechanisms, ensuring crisis mitigation during cosmic turbulence. Additionally, error handling mechanics prevent disruptions and allow system recovery.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines how tools are dynamically listed and executed with argument validation provided by Zod schemas. Error handling systems protect tool execution pathways.</li>
<li><code class="inline-code">run</code>: Establishes the MCP server transport and initiates background processes for analyzing repository data.</li>
<li><code class="inline-code">main</code>: Coordinates graceful shutdown processes for signals like <code class="inline-code">SIGINT</code> and protects against unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This represents a cosmic control center where tools are verified and securely executed using schemas like Zod.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>Think of this as activating a space relay station to ensure seamless interstellar communication flows.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The starship&#39;s safeguards ensure the system remains operational under cosmic disturbances like unexpected shutdowns.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Always validate tool inputs using the provided Zod schemas to prevent execution anomalies.</li>
<li>Monitor the <code class="inline-code">run</code> function&#39;s logs to diagnose connectivity issues with the transport system.</li>
<li>Investigate how signal handling mechanisms prioritize error recovery while preserving runtime stability.</li>
</ul>
<hr>
<p>Your starship&#39;s command bridge now pulses with activity, unlocking dynamic tool integration for future interstellar quests. Adventure onward, brave explorer, to unravel the galaxy&#39;s programming mysteries!</p>
<p>Stellar success achieved, Commander‚ÄîQuest 1: MCP Command Bridge is complete; your cosmic journey ignites at warp speed toward the galaxies of knowledge ahead! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>