<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Odyssey of the Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Tool Interface</h1>
<hr>
<p>Aboard the <em>Codex Voyager</em>, the cosmic code repository expands before you like a stellar nebula. Your mission is to man the MCP Tool Interface, a core engine that powers interaction with the ship&#39;s diagnostic tools and exploration modules. Without seamless tool orchestration, the ship&#39;s ability to navigate technical galaxies would falter. The interface is your galactic map and dispatcher, and every input must be calibrated to drain error from the system. Ready your terminal and engage‚Äîyour first step into this universe awaits.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Mapping Analysis</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list and validate tools in preparation for command handling?</li>
<li>‚ö° <strong>Command Execution Flow</strong>: What mechanisms are used in <code class="inline-code">run</code> to initialize the interface and connect the MCP server to user transports seamlessly?</li>
<li>üõ°Ô∏è <strong>Error Handling Protocols</strong>: How does <code class="inline-code">main</code> ensure clean server shutdown and manage edge cases like unhandled rejections?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Interface Core</h3>
<p>The <code class="inline-code">server.ts</code> file lies at the heart of the MCP Tool Interface, responsible for hosting the server, registering tools, and facilitating interactions. Its <code class="inline-code">RepoAdventureServer</code> class defines handlers for tool listing and execution, while error mitigation and workflow orchestration safeguard the system. Each function showcases thoughtful design for scalability and user input validation, ensuring reliable exploration of technical galaxies.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically maps tools from <code class="inline-code">tools.ts</code>, translating schemas into executable configurations. Ensures arguments align with each tool&#39;s specifications by validating JSON schemas.</li>
<li><code class="inline-code">run</code>: Activates the server transport layer via standard I/O and initializes necessary tool caching systems to optimize performance during runtime.</li>
<li><code class="inline-code">main</code>: Implements startup logic and graceful shutdown procedures for signals, preventing unhandled interruptions that might destabilize MCP operations.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools for runtime availability, leveraging <code class="inline-code">zodToJsonSchema</code> for schema consistency.</li>
<li>Validates user input with Zod schemas to ensure compatibility and communicate errors effectively.</li>
<li>Adds robust error handling paths to distinguish between known issues and unexpected failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects MCP server to standard I/O transport layer for direct user interactions via terminal.</li>
<li>Warms tool caches with a pre-generation mechanism, improving responsiveness during runtime.</li>
<li>Includes clear communication of server readiness and diagnostic actions via console logs.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initiates the server and configures clean-up protocols for system interrupts like <code class="inline-code">SIGINT</code>.</li>
<li>Captures and logs unhandled promise rejections, isolating them from critical workflows.</li>
<li>Guarantees error visibility while retaining system stability, preventing premature shutdowns.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Registry</h3>
<p>The <code class="inline-code">tools.ts</code> file serves as the registration hub for MCP tools. Tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code> are defined and exported for dynamic server integration. Each tool enhances exploration in themed environments and tracks progress along quests.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the active codebase to uncover potential quests and generates initial exploration options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Selects a story theme and personalizes quest generation based on user preferences.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes individual quests, offering detailed inspections of specific code fragments or patterns.</li>
<li><code class="inline-code">view_progress.handler</code>: Summarizes quest completion and identifies outstanding segments for further exploration.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Consolidates all tools in a single registry for streamlined management and server integration.</li>
<li>Promotes modular tool design, ensuring each serves a discrete function while being cohesive in operation.</li>
<li>Lays the groundwork for operating them within the MCP Tool Interface dynamically.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the logs generated from <code class="inline-code">run</code> to monitor server activities and diagnose any tool-related issues.</li>
<li>Study the structure of <code class="inline-code">tools</code> to see how modular design simplifies integration into <code class="inline-code">setupHandlers</code>.</li>
<li>Investigate how <code class="inline-code">zodToJsonSchema</code> establishes dynamic schemas compatible with MCP tool validations.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üéâ Stellar job completing Quest 1: MCP Tool Interface‚Äîyou&#39;re igniting propulsion on your learning starship and charting a bold course toward cosmic mastery! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>