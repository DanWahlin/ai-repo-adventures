<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Command Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Repository Adventures</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Command Bridge</h1>
<hr>
<p>Aboard the starship <em>Code Voyager</em>, the Command Bridge buzzes with activity as the MCP interface boots up for the first time. Your mission: navigate the intricacies of the <code class="inline-code">RepoAdventureServer</code> and its tools to ensure seamless interstellar communication with the repository galaxy. As your crew prepares for the cosmic expanse ahead, you must analyze the system&#39;s dynamic handlers and transport protocols to ensure all tools function at maximum efficiency. With your command hat on, embark on this critical mission to decode the ship&#39;s core operations and chart a successful course into the unknown.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Bridge Blueprint Analysis</strong>: How does <code class="inline-code">setupHandlers</code> dynamically populate tool listings and validate responses for intergalactic missions?</li>
<li>‚ö° <strong>Transport Calibration</strong>: What processes are involved in <code class="inline-code">run</code> when establishing the MCP transport system and warming up caches for faster flows?</li>
<li>üõ°Ô∏è <strong>Server Safety Protocols</strong>: How does <code class="inline-code">main</code> ensure error handling and graceful shutdown, protecting the Command Bridge from unexpected disruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server setup and dynamic MCP transport</h3>
<p>This file contains the definition of the <code class="inline-code">RepoAdventureServer</code> class, responsible for initializing and managing the MCP server environment. It defines dynamic tool handlers, connects to the transport system, and handles lifecycle events such as shutdown and error management. The key focus is on setting up request handlers that dynamically execute tools based on user input while validating against predefined schemas. Additionally, the <code class="inline-code">run</code> method establishes the communication channel via the <code class="inline-code">StdioServerTransport</code> and optimizes performance through cache pre-generation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic handlers for listing available tools and executing them with appropriate schema validation.</li>
<li><code class="inline-code">run</code>: Establishes the transport connection, logs server startup, and pre-generates repository context for improved responsiveness.</li>
<li><code class="inline-code">main</code>: Initializes the MCP server, manages lifecycle events including shutdown and uncaught errors for robust server operations.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool registration for MCP operations</h3>
<p>This file manages the registration of dynamic tools used by the MCP interface. Each tool represents a cosmic utility for exploration and progress tracking within repository galaxies. Tools are exported following standardized interfaces, and their handlers emphasize modular functionality while ensuring clarity in the execution flow.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates an interactive session to analyze codebases and introduce theme options.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows users to configure a mission theme, generating customized quests tailored to their choices.</li>
<li><code class="inline-code">explore_quest.handler</code>: Facilitates exploration of individual quests with options for repeat analysis as needed.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides status updates on current quest completion, guiding users on their mission trajectory.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Defines dynamic tool handling for listing and executing tools.</li>
<li>Ensures validation using <code class="inline-code">zod</code> schemas for accurate input processing.</li>
<li>Implements error handling and response generation mechanisms to prevent disruptions.</li>
<li>Integrates tools dynamically via descriptors and structured return objects.</li>
<li>Optimizes runtime execution by modularizing validation and handler calls.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes connection to MCP transport via <code class="inline-code">StdioServerTransport</code>.</li>
<li>Pre-generates repository context for faster content retrieval during missions.</li>
<li>Logs server startup and initialization details for operational transparency.</li>
<li>Utilizes asynchronous workflows to optimize transport and cache setup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server and sets up lifecycle event management.</li>
<li>Implements graceful handling of shutdown signals such as <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>.</li>
<li>Captures and logs unhandled promise rejections without interrupting operations.</li>
<li>Ensures stability through structured error detection and fallback operations.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Registers core MCP tools for modular exploration and quest handling.</li>
<li>Provides access to key utilities supporting dynamic storytelling and configuration.</li>
<li>Groups tool handlers under a single export for streamlined integration.</li>
<li>Facilitates organized tool management through descriptive naming conventions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as a reference framework when implementing custom tools with schemas.</li>
<li>Pre-generating repository context significantly reduces runtime parsing delays‚Äîensure proper configuration during <code class="inline-code">run</code>.</li>
<li>Investigate error handling mechanisms in <code class="inline-code">main</code> for robust lifecycle management practices.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Accomplished: You&#39;ve docked at the MCP Command Bridge with cosmic precision‚Äîstellar work on achieving liftoff for your galactic learning journey! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>