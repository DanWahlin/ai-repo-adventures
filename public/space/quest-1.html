<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Command the Codex Systems - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Odyssey: The Codex of Knowledge</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Command the Codex Systems</h1>
<hr>
<p>Across the vast cosmic landscape, the starship <strong>Codex</strong> begins its inaugural mission to unlock the mysteries behind galactic code repositories. As the lead explorer aboard the craft, your task is to synchronize the Codex&#39;s navigational systems, decode intricate tool interfaces, and command its processing core. Guided by cutting-edge AI and the <strong>RepoAdventureServer</strong>, this quest focuses on forging reliable connections and fostering interactive storytelling tools to chart interstellar journeys. Prepare to dive deep into the Codex&#39;s operational systems as curiosity drives your cosmic exploration!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Coordination</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically map tools to actionable schema for intergalactic command?</li>
<li>‚ö° <strong>Server Propulsion</strong>: What mechanisms in <code class="inline-code">run</code> ensure seamless initialization and background operations?</li>
<li>üõ°Ô∏è <strong>Stellar Shutoff</strong>: How does <code class="inline-code">gracefulShutdown</code> provide safe termination protocols for the Codex&#39;s systems?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server Operations</h3>
<p>The <strong>server.ts</strong> file is the heart of the Codex‚Äôs MCP server, managing its interactive storytelling capabilities and processing incoming commands. It defines the <strong>RepoAdventureServer</strong> class, which initializes the server, configures tool handlers, and establishes robust startup and shutdown procedures. Additionally, it anticipates errors through validation and incorporates responsive mechanisms to ensure system stability during unhandled issues. This file is critical for understanding how the Codex operates as an intergalactic command center.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools, associates schemas, and ensures tool compatibility against incoming requests.</li>
<li><code class="inline-code">run</code>: Activates server transport, pre-generates cached data for speed, and sets the system into operational orbit.</li>
<li><code class="inline-code">gracefulShutdown</code>: Implements cleanup routines and signal handling for smooth operational termination.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools via <code class="inline-code">setRequestHandler</code> to incoming requests using their schemas for validation and interaction.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to transform tool schemas into JSON Schema, ensuring universal compatibility.</li>
<li>Error-proof execution of tools through detailed validation and exception handling mechanisms.</li>
<li>Streamlines tool accessibility for external requests, bridging explorers with actionable resources.</li>
<li>Offers modular extensibility for adding additional tools with minimal complexity.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes <code class="inline-code">StdioServerTransport</code> to synchronize input/output handling efficiently during the server&#39;s operation.</li>
<li>Pre-generates cached data using <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize story-tool interactions for users.</li>
<li>Logs server activity clearly for seamless debugging and monitoring during operation.</li>
<li>Operates asynchronously, ensuring non-blocking execution in the flow of requests.</li>
<li>Sets the MCP server into continuous operation for multi-purpose tooling activation.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Safely handles <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to close processes without corrupting ongoing serialized operations or cached data.</li>
<li>Ensures cleanup logic via <code class="inline-code">repoAnalyzer.cleanup</code> to remove unused content artifacts, conserving resources.</li>
<li>Provides detailed error logging during cleanup for informed resolution workflows.</li>
<li>Immediately terminates the process upon successful completion of cleanup logic for operational finality.</li>
<li>Protects system integrity when initiated under unexpected circumstances such as signals or critical system errors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Utilize <code class="inline-code">setupHandlers</code> to adapt new tools dynamically without modifying server logic.</li>
<li>Experiment with <code class="inline-code">run</code> to test seamless server initialization amidst changing project paths.</li>
<li>Conduct stress tests by simulating various shutdown scenarios to observe the resilience of <code class="inline-code">gracefulShutdown</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries about the galactic archives.</p>
<p>You&#39;ve successfully docked at the first starbase of knowledge, commanding the Codex Systems with cosmic precision‚Äîstellar work, Captain! ‚≠êüöÄüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>