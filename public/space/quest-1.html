<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Repository Adventures</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Command Interface</h1>
<hr>
<p>Stationed at the edge of an ancient nebula, the Repository Voyager drifts silently, its galactic guidance systems locked behind cryptic interfaces. Your mission: gain access to the MCP Command Interface, the vessel‚Äôs heart for coordinating exploration tools. Navigate its modular structure to uncover dynamic tool activation, streamline interstellar requests, and ensure stellar stability in execution. This is no ordinary operation; the Repository Voyager‚Äôs systems are a labyrinth designed for only the bravest of cosmic adventurers. Ready your neural link, Astronaut-Coder; the galaxy awaits.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Activation Sequence</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register and execute tools while validating their inputs?</li>
<li>‚ö° <strong>Server Initialization Orbit</strong>: What is the role of <code class="inline-code">run</code> in establishing the server&#39;s operational flow and preparing the system for exploration missions?</li>
<li>üõ°Ô∏è <strong>Signal Synchronization Protocol</strong>: How does the <code class="inline-code">main</code> function handle shutdown signals and unexpected errors to maintain interstellar stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Command Interface Implementation</h3>
<p>This file establishes the backbone of the Repository Voyager‚Äôs MCP Command Interface. It houses the <code class="inline-code">RepoAdventureServer</code> class, managing server capabilities and tool-handling logic. Key components include the dynamic registration of tools for missions, integration of stellar safety protocols through error handling, and the orchestration of its cosmic event-driven architecture.</p>
<p>The <code class="inline-code">setupHandlers</code> method dynamically processes and validates incoming tool requests while ensuring compatibility with the Repository Voyager‚Äôs onboard module schemas. The <code class="inline-code">run</code> function acts as the ignition sequence for the command interface, connecting the system to its controlled transport layer and initializing pre-flight checks. Meanwhile, the <code class="inline-code">main</code> function acts as the mission control center, coordinating signal handling and error recovery.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamic tool registration and request handling</li>
<li><code class="inline-code">run</code>: Command interface activation and server flow</li>
<li><code class="inline-code">main</code>: Signal management and system initialization</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This section functions as a docking station for tools, validating and executing incoming requests with precision.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>This is the rocket launch system for the MCP, connecting server transport and ensuring readiness for missions.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>This is the starship‚Äôs mission control, ensuring smooth launches and handling anomalies mid-flight.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Carefully observe the <code class="inline-code">zodToJsonSchema</code> integration for tool validation within <code class="inline-code">setupHandlers</code>.</li>
<li>Pay attention to how <code class="inline-code">run</code> connects server transport and launches preprocessing utilities.</li>
<li>Study the <code class="inline-code">main</code> function‚Äôs signal handling and unhandled rejection recovery for operational robustness.</li>
</ul>
<hr>
<p>Congratulations! The cosmic systems are coming alive under your command. Prepare to engage the next sequence of missions as you delve deeper into the Repository Voyager‚Äôs navigational core.</p>
<p>üöÄ Stellar achievement unlocked: Quest 1 complete‚Äîyour cosmic command skills are now ready to chart a brilliant course among the stars!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>