<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Code Chronicles: The Quest for Stellar Harmony</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Nexus</h1>
<hr>
<p>The <em>SS Code Explorer</em> arrives at the MCP Nexus, a critical system within the Repository Galaxy struggling with fragmented tool integrations and unresponsive system commands. Your mission is to investigate the MCP Tool Interface that governs interactions between the server and tools, ensuring dynamic tool execution and robust communication protocols. The galaxy depends on the restoration of this command center to move forward in its journey toward stability. Engage your crew, calibrate your scanners, and uncover the secrets of the MCP Nexus to restore balance!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Registry Scans</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically register tools and validate their schemas for execution requests?</li>
<li>‚ö° <strong>Core System Activation</strong>: How does the <code class="inline-code">run</code> method initialize server transport and handle pre-generation of repository context?</li>
<li>üõ°Ô∏è <strong>Error Shield Diagnostics</strong>: How does the <code class="inline-code">main</code> function manage fatal errors, signal handling, and promise rejections for system reliability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Tool Interface</h3>
<p>The MCP Tool Interface in this file provides the backbone for dynamic tool registration and execution processes. The <code class="inline-code">RepoAdventureServer</code> class encapsulates the system configuration, handlers, and runtime operations. It connects sophisticated tools with storytellers in a seamless manner, ensuring that valid inputs trigger meaningful outputs for server commands while addressing errors gracefully.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Establishes dynamic handlers for listing and invoking tools, ensuring validated schemas for tool execution requests.</li>
<li><code class="inline-code">run</code>: Activates server transport, connects it to standard IO, and pre-generates repository context to optimize tool responsiveness.</li>
<li><code class="inline-code">main</code>: Manages the lifecycle of the server, ensuring proper error handling for unexpected issues and enabling graceful shutdown mechanisms.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tool schemas dynamically with <code class="inline-code">zodToJsonSchema</code>, ensuring compatibility with JSON schemas.</li>
<li>Handles execution logic using structured <code class="inline-code">schema.safeParse</code> for argument validation.</li>
<li>Mitigates tool request errors with precise exceptions (<code class="inline-code">McpError</code>) for improved troubleshooting.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes <code class="inline-code">StdioServerTransport</code> for reliable standard IO communication.</li>
<li>Pre-generates content with <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize caching.</li>
<li>Logs operational steps for clear visibility during execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal listeners (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for safe shutdowns.</li>
<li>Captures <code class="inline-code">unhandledRejection</code> events to ensure continuity during recoverable faults.</li>
<li>Integrates structured error reporting to avoid server crashes on initialization issues.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Observe how dynamic schemas enable integration with many tools while maintaining validation rigor.</li>
<li>Note the role of transport initialization and pre-generation processes for tool responsiveness.</li>
<li>Explore error-handling strategies to enhance system robustness in recovery scenarios.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Repository Galaxy.</p>
<p>Quest 1: The MCP Nexus complete‚Äîstellar work, Cadet! You&#39;ve launched your cosmic voyage with a blazing start, charting new galaxies of knowledge! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>