<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Command Hub - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codex: Adventures in Repository Space</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Command Hub</h1>
<hr>
<p>As the <em>Code Odyssey</em> orbits the Repository Nebula, your mission gains focus. You are tasked with activating the MCP Command Hub, the ship&#39;s interactive platform for repository exploration. The ship&#39;s AI systems depend on this hub for managing tools, executing commands, and ensuring that all operational protocols are followed. Your journey begins in the core operations bay, where the command system must be fully functional. Can you repair, analyze, and optimize the MCP tools required for the galaxy-wide expedition that lies ahead?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Calibration</strong>: How does the MCP dynamically register and validate tools through <code class="inline-code">setupHandlers</code>?</li>
<li>‚ö° <strong>Command Activation</strong>: What processes ensure that the MCP Command Hub is initialized and connected for operations in <code class="inline-code">run</code>?</li>
<li>üõ°Ô∏è <strong>Failsafe Mechanisms</strong>: How does the server handle unexpected errors or interruptions in <code class="inline-code">main</code>?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Command Hub Core</h3>
<p>The core server file defines the MCP Command Hub (managed by the <code class="inline-code">RepoAdventureServer</code> class), allowing interactive and tool-driven engagement with the galaxy of repositories. It ensures dynamic registration of tools, validation of user inputs, and error handling, making it the central control system for your adventure. Functions in this file control server setup, request handling, and its lifecycle, preparing the ship for error-free operations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> sets up request handling for listing tools and executing commands. This function ensures real-time tool registration and validation.</li>
<li><code class="inline-code">run</code> initializes and connects the server to the <code class="inline-code">stdio</code> transport system and pre-generates repository insights for enhanced performance.</li>
<li><code class="inline-code">main</code> manages the lifecycle of the server, including initialization, graceful shutdown, and error resilience.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools for registration, ensuring scalability and modular functionality.</li>
<li>Uses <code class="inline-code">zod</code> for schema validation to guarantee correct input parameters, avoiding runtime errors.</li>
<li>Demonstrates structured error handling through custom <code class="inline-code">McpError</code> objects, improving debugging and user feedback.</li>
<li>Implements a clear separation of concerns, isolating validation and execution.</li>
<li>Prepares the system for seamless integration with new tools in future missions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server transport over <code class="inline-code">stdio</code>, enabling communication between mission control systems.</li>
<li>Displays useful status logs for monitoring the server&#39;s operational state.</li>
<li>Uses <code class="inline-code">repoAnalyzer</code> to generate content in the background, reducing latency during interactive sessions.</li>
<li>Adopts asynchronous patterns to maintain non-blocking operations.</li>
<li>Easily extensible for future enhancements, such as supporting additional transport mechanisms.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Wraps the server initialization in a robust <code class="inline-code">try-catch</code> block, preventing crashes from unanticipated errors.</li>
<li>Registers signal listeners to handle graceful termination on mission-abort commands.</li>
<li>Reports and logs unhandled promise rejections for diagnostic analysis while keeping the server operational.</li>
<li>Serves as the entry point for the core MCP server, centralizing lifecycle management.</li>
<li>Ensures operational continuity, akin to robust fail-safes on any deep-space exploration vessel.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Deploy Safeguards:</strong> Dynamic validation in <code class="inline-code">setupHandlers</code> ensures that tools work seamlessly. Focus on the integration of schemas for safe execution.</li>
<li><strong>System Warmup:</strong> Pre-generating content in <code class="inline-code">run</code> reduces delay for future interactions. Understand this optimization within real-time systems.</li>
<li><strong>Graceful Shutdowns:</strong> Signal handling in <code class="inline-code">main</code> prevents abrupt server failure. Explore how this contributes to a fault-tolerant system.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Cadet‚ÄîQuest 1: The MCP Command Hub secured and trajectory locked; you‚Äôve ignited your thrusters and set a stellar course toward intergalactic mastery! üöÄ ‚≠ê ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>