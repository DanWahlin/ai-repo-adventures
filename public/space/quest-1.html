<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the MCP Interface Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Expedition: Chronicles of the Codebase</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the MCP Interface Nexus</h1>
<hr>
<p>Amidst the glittering expanse of the repository cosmos, you stand aboard the <em>Codexus</em>. Today&#39;s mission: decode a vital communication link within the MCP Interface Nexus. This system lies at the heart of our quest engine, processing user inputs and orchestrating rich voyages. However, even the most sophisticated interfaces need explorers to chart their intricate designs. You‚Äôll uncover how requests flow through the stellarly aligned <em>handlers</em>, translate user commands, and trigger distant tools within the MCP galaxy. The real treasure? Empowering your crew with mastery over this starship tech.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Initialization Scanner</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically construct and validate available tools?</li>
<li>‚ö° <strong>Mission Flow Map</strong>: What sequence does the <code class="inline-code">run</code> function follow to start the MCP server and pre-generate repository data for smoother operation?</li>
<li>üõ°Ô∏è <strong>Safety Protocol Review</strong>: How does the <code class="inline-code">main</code> function handle graceful shutdowns and unexpected interruptions in the MCP Interface Nexus?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: Server setup and request pipeline</h3>
<p>This file is the neural core of the MCP Interface Nexus, responsible for initializing services, routing requests, and handling error scenarios. From creating the MCP <code class="inline-code">Server</code> instance to validating requests for tools, it shapes the user‚Äôs journey through the MCP galaxy. The <code class="inline-code">setupHandlers</code> method deploys dynamic request routing, while the <code class="inline-code">run</code> function prepares the adventure engine. Mindful safety measures in the <code class="inline-code">main</code> function ensure smooth operations amidst unforeseen galactic storms.</p>
<h4>Highlights</h4>
<ul>
<li>Dynamic request handlers in the <code class="inline-code">setupHandlers</code> method, including tool validation</li>
<li>Server activation and repository pre-generation in the <code class="inline-code">run</code> function</li>
<li>Error handling and shutdown procedures in the <code class="inline-code">main</code> function</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>The <code class="inline-code">setupHandlers</code> function acts like the mission control center, dynamically routing requests to the correct &quot;tools&quot; after validating them with Zod schemas.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>The <code class="inline-code">run</code> function powers up the MCP Interface Nexus, establishes communication via <code class="inline-code">StdioServerTransport</code>, and prepares repository analysis in advance of user input.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<p>The <code class="inline-code">main</code> function performs critical system checks and establishes safeguards to ensure the MCP Interface Nexus can survive unexpected cosmic disruptions.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function to study how dynamic routing mechanisms utilize <code class="inline-code">Zod</code> schemas during validation.</li>
<li>Investigate the pre-execution <code class="inline-code">repoAnalyzer.preGenerate</code> call in <code class="inline-code">run</code> to understand its role in optimizing the MCP server&#39;s startup.</li>
<li>Pay close attention to signals (<code class="inline-code">SIGINT</code>/<code class="inline-code">SIGTERM</code>) handled in <code class="inline-code">main</code> for clues on implementing robust shutdown strategies.</li>
</ul>
<hr>
<p>Return now to Captain&#39;s console and await the subsequent mission briefing. The repository galaxy awaits your command, adventurer!</p>
<p>Quest 1 complete: you&#39;ve successfully charted the galactic corridors of the MCP Interface Nexus‚Äîstellar precision, Cadet, the cosmos awaits your next launch! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>