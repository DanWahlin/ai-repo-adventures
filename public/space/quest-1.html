<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Chronicles: The Codebase Voyager</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the MCP Tool Interface</h1>
<hr>
<p>The <em>Infinitum</em> drifts through the luminous expanse of the Digital Nebula, your crew poised for their next challenge. Ahead lies the complex architecture of the <strong>Model Context Protocol (MCP)</strong> system, whose tools will guide the journey‚Äôs future paths. Your mission: decode the interfaces, uncover their adaptive mechanisms, and ensure their seamless function. The cosmic labyrinth of modular design invites a deep investigation, where every method and file is a stellar point of discovery. Engage with the <em>Infinitum&#39;s</em> analytical core, chart your course, and operationalize the MCP&#39;s potential.  </p>
<p><strong>Adventure Awaits</strong> ‚Äì Let us uncover the stellar patterns hidden within the MCP Tool Interface.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Tool Calibration</strong>: How does the <code class="inline-code">setupHandlers</code> method dynamically register and validate the tools in the system?  </li>
<li>‚ö° <strong>Subsystem Ignition</strong>: What setup and initialization processes are executed in the <code class="inline-code">run</code> method to prepare the server for intergalactic communication?  </li>
<li>üõ°Ô∏è <strong>Failsafe Protocols</strong>: How does the <code class="inline-code">main</code> function establish error handling and shutdown protocols to ensure cosmic operational stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Server Initialization and MCP Tool Handling</h3>
<p>This file powers the central <strong>RepoAdventureServer</strong>, responsible for initializing the MCP, configuring tools, and handling requests from clients. Specifically, the <code class="inline-code">setupHandlers</code> method dynamically registers tools and validates arguments. The <code class="inline-code">run</code> method initializes the server transport and pre-generates caches for enhanced performance. Finally, <code class="inline-code">main</code> configures error handling mechanisms and gracefully shuts down the MCP in adverse conditions. Collectively, these methods illustrate the cosmic interplay between initialization, execution, and error management.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools, validates arguments through schemas, and ensures error-free execution.  </li>
<li><code class="inline-code">run</code>: Initializes the <strong>StdioServerTransport</strong>, prepares the cache for the current project, and launches the server.  </li>
<li><code class="inline-code">main</code>: Orchestrates server startup, error handling, and shutdown processes to ensure fault tolerance.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically maps and validates tools using their schema for compatibility in interactive missions.  </li>
<li>Converts the tool&#39;s Zod schema into JSON Schema during the registration process.  </li>
<li>Provides robust error handling by distinguishing invalid parameters and unknown tools.  </li>
<li>Supports a modular approach where new tools can easily be added to the MCP ecosystem.  </li>
<li>Demonstrates dynamic validation patterns that ensure input data integrity during runtime.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Establishes transport communication with the <strong>StdioServerTransport</strong>, enabling MCP-request handling.  </li>
<li>Pre-generates content for the current project directory to optimize response times.  </li>
<li>Provides asynchronous initialization to ensure the server is fully prepared before accepting requests.  </li>
<li>Lays the groundwork for mission-specific tool functionality by warming required caches.  </li>
<li>Highlights the use of background processes for maintaining system readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Configures signal-based graceful shutdown (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to protect long-running operations.  </li>
<li>Logs unrecoverable promise rejections and avoids disruptions in normal processing.  </li>
<li>Safeguards server startup with try-catch blocks for resilient failure handling.  </li>
<li>Encapsulates all initialization logic within a single entry point.  </li>
<li>Promotes clean resource management during both expected and unexpected shutdown scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers</code> as a pattern for dynamic registration and argument validation across other tools.  </li>
<li>Study the pre-generation logic during <code class="inline-code">run</code> to improve performance in future system designs.  </li>
<li>Investigate the <code class="inline-code">main</code> structure for best practices in handling signals and unhandled promises.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar work, Cadet‚ÄîQuest 1 complete! You&#39;ve successfully charted the cosmic map of the MCP Tool Interface; your journey to the stars is off to a blazing start! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>