<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Calibrate the MCP Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Aurora: Navigating the Repository Constellation</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Calibrate the MCP Bridge</h1>
<hr>
<p>Your crew assembles on the Aurora‚Äôs command deck, consoles aglow like nebulae. The mission: calibrate the MCP Bridge so allied ships can request guided repo adventures via standard cosmic channels. You‚Äôll tune handlers, validate payloads, and ignite background analyzers that warm the LLM reactor. Navigation charts point to exactly two system modules: the bridge server and its tool registry. Study their orbits, observe signal flows, and ensure tool telemetry aligns with star maps. These are exploration guides to follow while reading the code below, not prerequisites.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">setupHandlers</code> transform Zod schemas into JSON Schema and assemble the dynamic <code class="inline-code">tools</code> manifest for discovery?</li>
<li>‚ö° Reactor Warm Start: In <code class="inline-code">run</code>, why is <code class="inline-code">repoAnalyzer.preGenerate</code> initiated after transport connection, and how does that impact perceived latency and flow?</li>
<li>üõ°Ô∏è Fault Containment: How do <code class="inline-code">setupHandlers</code> and <code class="inline-code">main</code> distinguish between <code class="inline-code">McpError</code> and unknown failures, and what strategies keep the MCP server resilient?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server that exposes tools over stdio and coordinates analyzer warm-up</h3>
<p>This file defines the MCP Bridge‚Äôs core. The <code class="inline-code">RepoAdventureServer</code> encapsulates a <code class="inline-code">Server</code> configured with a capability to expose <code class="inline-code">tools</code>. Initialization immediately calls <code class="inline-code">setupHandlers</code>, which registers request handlers for <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code>. The former enumerates <code class="inline-code">tools</code> and converts each tool‚Äôs Zod <code class="inline-code">schema</code> to JSON Schema via <code class="inline-code">zodToJsonSchema</code> so clients can understand parameter contracts without bespoke knowledge. The latter executes tools by name, validates arguments with <code class="inline-code">schema.safeParse</code>, and returns tool results or throws structured <code class="inline-code">McpError</code> responses using <code class="inline-code">ErrorCode</code> variants for precise failure signaling. The <code class="inline-code">run</code> method establishes a <code class="inline-code">StdioServerTransport</code>, connects the server, logs status, and triggers <code class="inline-code">repoAnalyzer.preGenerate</code> to pre-warm repository context in the background, reducing mission-time delays. Outside the class, <code class="inline-code">gracefulShutdown</code> coordinates analyzer cleanup, and <code class="inline-code">main</code> wires OS signal handling (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and an <code class="inline-code">unhandledRejection</code> listener that logs issues but maintains uptime. Errors during startup are treated as fatal with a non-zero exit. Together, these patterns create a stable, discoverable tool surface, precise validation, and operational robustness suitable for a multi-ship fleet relying on standardized MCP channels.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> registers discovery and execution handlers, converting Zod schemas to JSON Schema and validating arguments before invoking tool handlers. This ensures interoperable contracts and safety at the bridge.</li>
<li><code class="inline-code">run</code> connects the server over stdio and initiates <code class="inline-code">repoAnalyzer.preGenerate</code> to warm caches, improving responsiveness for early tool calls like adventure initialization.</li>
<li><code class="inline-code">main</code> orchestrates lifecycle: constructs the server, installs signal listeners for graceful shutdown, logs unhandled rejections without crashing, and handles fatal startup errors, preserving mission continuity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Registers discovery and execution paths so clients can list and call tools via standard schemas.</li>
<li>Converts Zod to JSON Schema to advertise precise input contracts without <code class="inline-code">$ref</code> complexity.</li>
<li>Validates inputs with <code class="inline-code">schema.safeParse</code> and returns granular <code class="inline-code">McpError</code> codes for predictable failures.</li>
<li>Defends against unknown exceptions by wrapping them in <code class="inline-code">InternalError</code>, isolating faults from the transport.</li>
<li>Centralizes tool lookup and invocation, enabling a consistent execution orbit for all tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Connects the MCP server over stdio, establishing the comms channel for allied ships.</li>
<li>Initiates background <code class="inline-code">repoAnalyzer.preGenerate</code> to cache repository content, reducing first-call latency.</li>
<li>Logs status to stderr for operational awareness in headless environments.</li>
<li>Defers heavy work until after connection to avoid blocking the handshake.</li>
<li>Chooses non-blocking warm-up to keep the bridge responsive while caches fill.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>Constructs the server and governs lifecycle with signal traps for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, enabling safe dock-out and analyzer cleanup.</li>
<li>Logs unhandled rejections without stopping the mission, favoring uptime in long-running operations.</li>
<li>Treats startup failures as fatal with explicit non-zero exit for operator clarity.</li>
<li>Uses <code class="inline-code">main().catch</code> as a final safety net, ensuring no silent failures escape logs.</li>
<li>Demonstrates separation of concerns: initialization, runtime resilience, and shutdown protocols.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool exports, mapping internal modules to MCP names used by the server‚Äôs discovery and execution handlers.</li>
<li>Exposes a shared <code class="inline-code">adventureManager</code> for cross-tool state coherence.</li>
<li>Aggregates <code class="inline-code">tools</code> for straightforward enumeration in <code class="inline-code">setupHandlers</code>.</li>
<li>Keeps handler surfaces decoupled from transport specifics, aligning with the server‚Äôs dynamic listing.</li>
<li>Establishes a clear convention for extending the toolset without modifying the server‚Äôs core logic.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Trace how <code class="inline-code">tools</code> is built and then consumed by <code class="inline-code">setupHandlers</code> to understand discovery and execution alignment.</li>
<li>Compare error codes in <code class="inline-code">setupHandlers</code> to see where client-usable messages are formed versus internal logs.</li>
<li>Consider adding telemetry around <code class="inline-code">preGenerate</code> completion to observe cache warm-up impacts on first mission calls.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission update: with Quest 1‚ÄîCalibrate the MCP Bridge‚Äîsuccessfully executed, your starship systems are locked on vector and humming at optimal thrust, a stellar first step toward the cosmic campaign ahead‚Äîstellar work, cadet! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>