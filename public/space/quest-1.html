<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Adventures Across the Codeverse</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the MCP Interface</h1>
<hr>
<p>The starship <em>Infinity Loop</em> drifts through the myriad streams of the Codeverse, its shimmering hull casting beams of command-line precision into the surrounding data nebulas. Today, the crew sets their scanners on a vital mission: interfacing with the MCP (Model Context Protocol) through its finely tuned server and tooling architecture. Successfully navigating the MCP interface will require deft handling of message schemas, the agility to execute tools dynamically, and the foresight to uncover how the server powers the <em>Infinity Loop‚Äôs</em> interactive explorations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scanner Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically generate a list of tools and validate their parameters for mission-critical operations?</li>
<li>‚ö° <strong>Command Uplink</strong>: What mechanisms in <code class="inline-code">run</code> ensure seamless operation and pre-warming of the ship&#39;s content analysis pipeline during flight?</li>
<li>üõ°Ô∏è <strong>Error Field Analysis</strong>: How does <code class="inline-code">main</code> handle failures and ensure graceful shutdown of the interface in the event of cosmic anomalies?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The MCP Server</h3>
<p>This file defines the core operational construct of the MCP server, the <code class="inline-code">RepoAdventureServer</code>. Acting as the central command hub, it connects incoming transport protocols, validates dynamic tool interactions, and orchestrates initialization routines. The <code class="inline-code">setupHandlers</code> function equips the server to dynamically handle a broad range of requests, while the <code class="inline-code">run</code> function prepares the server for stable operation, pre-generating content to optimize performance. Meanwhile, the <code class="inline-code">main</code> function ensures robust initialization and safe shutdown protocols.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures dynamic handlers for listing tools and executing tools, including schema-based request validation.</li>
<li><code class="inline-code">run</code>: Connects server transport protocols, activates the MCP interface, and pre-warms the analysis cache for efficient operation.</li>
<li><code class="inline-code">main</code>: Serves as the entry point for the server, setting up robust error management and handling shutdown signals.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps available tools for discovery, packaging metadata and request schemas.</li>
<li>Validates input parameters against the tool-specific schema using Zod for robust arguments handling.</li>
<li>Handles execution errors with custom exceptions (<code class="inline-code">McpError</code>) to ensure actionable diagnostics.</li>
<li>Implements dynamic routing of tool execution requests to maintain a flexible and extensible interface.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Configures standard I/O-based transport for server communication, ensuring compatibility with CLI-based clients.</li>
<li>Pre-generates data context (<code class="inline-code">repomix</code>) for the current working directory, reducing latency for initial queries.</li>
<li>Logs operational status and prepares the server for immediate input handling upon startup.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Manages lifecycle signals (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) to ensure a controlled shutdown of server resources.</li>
<li>Logs and reports unhandled promise rejections for continuous stability during operational anomalies.</li>
<li>Serves as the final call to action for initializing the entire server lifecycle.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">tools.ts</code> file to understand which tools are registered and map functionality back to <code class="inline-code">setupHandlers</code>.</li>
<li>Explore the <code class="inline-code">repoAnalyzer</code> object in the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a> file for details on <code class="inline-code">preGenerate</code>.</li>
<li>Observe the Zod validation patterns in <code class="inline-code">setupHandlers</code> for crafting strongly-typed tools.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Stargazer! You&#39;ve successfully charted the uncharted realms of the MCP Interface‚Äîonward to the next cosmic adventure, captain of the infinite üöÄ‚≠ê‚ö°!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>