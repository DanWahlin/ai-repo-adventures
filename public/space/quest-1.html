<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Mastering the Starship Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Codex: The Tales of the Starship Codexia</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="../index.html" class="nav-link">Change Theme</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Mastering the Starship Interface</h1>
<hr>
<p>In the distant reaches of the Andromeda Galaxy, the Starship Codexia orbits a mysterious celestial vault of knowledge known as the Repository Nebula. Within its swirling cosmic archives lie the blueprints for understanding and navigating vast clusters of data. Your mission is to guide the Codexia crew through the Repository Nebula, analyze its stellar secrets, and unlock the potential of the data streams. But beware, each sector of the nebula reveals fragmented systems requiring precise calibration and interstellar cooperation.</p>
<p><strong>Adventure Awaits</strong> ‚Äì Choose your quest wisely, brave adventurer!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scanner Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list tools and validate inputs to support Codexia&#39;s mission?</li>
<li>‚ö° <strong>Starship Diagnostics</strong>: What processes ensure the MCP server initializes smoothly through the <code class="inline-code">run</code> function in <code class="inline-code">RepoAdventureServer</code> and properly handles shutdown procedures in <code class="inline-code">gracefulShutdown</code>?</li>
<li>üõ°Ô∏è <strong>Nebula Safeguards</strong>: How does the system manage and report errors during <code class="inline-code">CallToolRequestSchema</code> tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The MCP Starship Command Center</h3>
<p>The <code class="inline-code">server.ts</code> file serves as the core operating system for the Starship Codexia&#39;s interactive missions. It uses the <code class="inline-code">RepoAdventureServer</code> class to dynamically list and execute tools that guide crews through code exploration. This file includes handlers for managing tool schemas, validating commands, and leveraging tool integrations. To ensure reliability during exploration, it handles both standard operations and edge cases like unhandled errors or invalid inputs. Additionally, the <code class="inline-code">gracefulShutdown</code> function ensures the system can close operations safely during interruptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines how the server dynamically lists mission tools and validates their input schemas for error-free operations. This ensures the list remains current and accurate while protecting against invalid requests.</li>
<li><code class="inline-code">run</code>: Activates the MCP server, initializes the transport layer via <code class="inline-code">StdioServerTransport</code>, and pre-generates contextual content for efficient mission startup. Keeps Codexia ready for interstellar operations.</li>
<li><code class="inline-code">main</code>: Acts as the server&#39;s launch sequence, initializing the <code class="inline-code">RepoAdventureServer</code> and supporting safe shutdowns and unhandled error logging.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps tools for the MCP server using <code class="inline-code">ListToolsRequestSchema</code>. This ensures that any newly added tools are seamlessly integrated.</li>
<li>Sanitizes and validates data input with Zod schemas to eliminate risks from invalid or malformed arguments.</li>
<li>Implements robust error handling with <code class="inline-code">McpError</code> to provide clear feedback for operational failures, enhancing the system&#39;s resilience.</li>
<li>Supports flexible additions by dynamically connecting tools to the server, ensuring adaptability for future mission updates.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes a seamless connection via <code class="inline-code">StdioServerTransport</code>, enabling Codexia to transmit exploration commands directly.</li>
<li>Pre-generates contextual content for the current working directory with <code class="inline-code">repoAnalyzer.preGenerate</code>, significantly reducing initialization delays during live missions.</li>
<li>Logs critical initialization details for diagnostics and mission tracking, ensuring engineers on Codexia can monitor performance.</li>
<li>By focusing on asynchronous execution, the server efficiently prepares critical data streams in parallel with user operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Acts as a launch sequence, orchestrating the <code class="inline-code">RepoAdventureServer</code> startup for Codexia&#39;s missions.</li>
<li>Captures termination signals (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) to trigger <code class="inline-code">gracefulShutdown</code>, preserving mission data during unexpected exits.</li>
<li>Logs unhandled promise rejections without halting operations, improving tolerance to recoverable errors during long-range missions.</li>
<li>Safeguards mission-critical processes by immediately exiting on catastrophic failure, preventing undue system damage.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To dive deeper into tool data validation, explore the <code class="inline-code">tools.js</code> file for specific schemas.</li>
<li>As you unlock further quests, notice how <code class="inline-code">repoAnalyzer</code> plays a pivotal role in interacting with code repositories.</li>
<li>Familiarize yourself with how <code class="inline-code">main</code> and <code class="inline-code">run</code> initiate system workflows to maintain consistent mission readiness.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Congratulations, Cadet! You‚Äôve successfully navigated the cosmic labyrinth of the Starship Interface‚Äîyour stellar skills are the fuel propelling this mission toward the infinite horizon! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>