<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Galactic Command Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codebase Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Galactic Command Interface</h1>
<hr>
<p>Your mission aboard the Starship Repo Voyager begins in earnest. As the glowing holographic controls spring to life, a mission briefing scrolls across the command interface. You are tasked with investigating the core operational systems that keep the starship&#39;s Galactic Command Interface running. This vital module ensures seamless communication with the myriad tools of the Starship‚Äôs systems, empowering the crew with the ability to decode the strangest of file nebulae. Be prepared‚Äîthere may be surprises hiding within the architecture of the interface. All adventurers must navigate this vast stellar field of code to unlock the true power of the Galactic Command.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scanner Calibration</strong>: How does the dynamic tool registration process work in <code class="inline-code">RepoAdventureServer.setupHandlers</code>, and what role does Zod schema play in ensuring compatibility?</li>
<li>‚ö° <strong>Command Sequencing</strong>: What initialization processes occur in the <code class="inline-code">RepoAdventureServer.run</code> function, and how are onboard tools prepared for execution?</li>
<li>üõ°Ô∏è <strong>Stellar Safeguards</strong>: How does the <code class="inline-code">main</code> function handle system interruptions and unexpected errors to ensure the stability of the command interface?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Galactic Mainframe</h3>
<p>This file contains the primary operational commands for the <code class="inline-code">RepoAdventureServer</code>. From tool registration to input validation, it handles every interaction with the Galactic Command Interface. This system is essential for establishing communication between the starship‚Äôs core and its adventurous tooling suite. Highlights include dynamic handlers for tool listing and execution, pre-initialization processes for runtime efficiency, and robust error management to withstand unexpected cosmic anomalies.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Configures tool-registration and tool-execution handlers dynamically, converting Zod schemas into runtime metadata.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Initializes the StdioServerTransport for communication and pre-generates content caches to ensure smooth interstellar navigation.</li>
<li><code class="inline-code">main</code>: Launches the application, installs graceful shutdown hooks, and ensures error handling for unpredicted issues.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This method dynamically configures the Galactic Command for both tool listing and tool execution.</li>
<li>Zod schemas ensure that all tools adhere to strict definitions, preventing runtime discrepancies.</li>
<li>The design separates validation logic from execution, making the system modular and easy to extend.</li>
<li>Errors are standardized with <code class="inline-code">McpError</code> codes for transparency and debug clarity.</li>
<li>Prepares the system to dynamically interact with tools as they evolve or expand.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> function establishes communication using a <code class="inline-code">StdioServerTransport</code>.</li>
<li>Pre-generating cache data improves runtime performance, reducing delays for end-users.</li>
<li>The asynchronous setup provides non-blocking initialization, allowing for responsiveness during startup.</li>
<li>This proactive approach aligns with the space navigator&#39;s goal of efficiency under uncertainty.</li>
<li>Tracks the current working directory dynamically, adapting to different deployment contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function orchestrates the server initialization and ensures its long-term stability.</li>
<li>Graceful shutdown hooks are installed for safety, catching termination signals like <code class="inline-code">SIGINT</code>.</li>
<li>A robust response to unhandled promise rejections minimizes the fallout from unexpected errors.</li>
<li>Logs critical information to facilitate debugging while maintaining operational continuity.</li>
<li>Demonstrates the principles of defensive programming for highly accessible systems.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Regularly examine Zod schemas for gaps in input validation‚Äîstrong controls stop invalid input from ever reaching production.</li>
<li>Investigate how pre-generated content caches could be replicated for similar startup optimizations.</li>
<li>To better handle long-term mission operation, study other graceful shutdown examples‚Äîreliability is critical in space!</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Cadet‚ÄîQuest 1: Galactic Command Interface is successfully charted; you&#39;ve ignited the thrusters for cosmic mastery and are cleared for interstellar expansion! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>