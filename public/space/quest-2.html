<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Commanding the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codex: Chronicles of the Stellar Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Commanding the MCP Interface</h1>
<hr>
<p>The year is 3027, and aboard the starship <em>Codemancer</em>, your crew has begun deciphering the Stellar Repository‚Äôs enigmatic gateways. Tensions are high after the first breakthrough, but now, a critical milestone lies ahead: mastering the MCP interface. This interface is your bridge to understanding the advanced tools required for cosmic navigation and the decoding of ancient archives. You must investigate its elaborate structure, dynamic behaviors, and error-management protocols. Prepare to interface with the heartbeat of your mission!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Interface Synchronization</strong>: How does the MCP interface dynamically register and handle tool requests through the server? </li>
<li>‚ö° <strong>Command Execution Protocols</strong>: What mechanisms are in place to validate and execute commands issued to tools via the MCP interface?</li>
<li>üõ°Ô∏è <strong>Error Containment Systems</strong>: How does the system manage and respond to invalid requests or runtime errors during tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: Central MCP Interface Server</h3>
<p>The <code class="inline-code">server.ts</code> file implements the core infrastructure for the MCP server, enabling communication between clients and interactive tools. It houses the <code class="inline-code">RepoAdventureServer</code> class, which sets up the server, manages request handling, and ensures seamless tool execution. The <code class="inline-code">run</code> method establishes the transport mechanism, while <code class="inline-code">setupHandlers</code> dynamically registers tools and validates command inputs. Error handling is carefully orchestrated to respond gracefully to client issues, ensuring a resilient interface.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers supported tools and manages input validation and schema generation.</li>
<li><code class="inline-code">run</code>: Initializes the MCP server transport, pre-generates cache content, and starts the service.</li>
<li><code class="inline-code">main</code>: Handles server startup, process signals, and graceful shutdown procedures.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>: Tools Entry Point</h3>
<p>The <code class="inline-code">tools.ts</code> file defines and exports tool-related handlers, connecting them with the MCP server. It introduces high-level tool entry points such as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, and others, consolidating them into a unified interface for server registration. This modular approach makes tool management intuitive and scales well for new functionality.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Launches an introduction to exploring code repositories contextually.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows a user to select thematic styles for quests, personalizing their journey.</li>
<li><code class="inline-code">explore_quest.handler</code>: Triggers interactive exploration of a chosen quest in the repository.</li>
<li><code class="inline-code">view_progress.handler</code>: Fetches mission completion data and progress percentages.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of tools by converting Zod schemas to JSON Schema for client compatibility.</li>
<li>Validates input parameters before tool execution, ensuring only appropriate commands are processed.</li>
<li>Provides robust error handling for unregistered tools and invalid parameters, shielding the system from unexpected failures.</li>
<li>Integrates well with the tool architecture (<code class="inline-code">tools</code>) for dynamic updates.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes and starts the server using the <code class="inline-code">StdioServerTransport</code>, ensuring compatibility with client streams.</li>
<li>Pre-generates repository metadata to enhance performance and reduce delays during client operations.</li>
<li>Logs useful server state information, aiding mission monitoring and diagnostics.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown));
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Manages the full lifecycle of the MCP server, from initialization to managing shutdown signals.</li>
<li>Implements graceful shutdown logic to clean up resources safely, maintaining system integrity.</li>
<li>Catches and logs unhandled promise rejections without disrupting ongoing operations.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Registers the main tools for interactive exploration, providing a clear, extensible interface for tool management.</li>
<li>Encapsulates tool definitions, streamlining registration processes in the MCP server setup.</li>
<li>Highlights modularity by separating tool logic for maintainability and scalability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> method as a reference for adding new tools while adhering to established validation protocols.</li>
<li>Trace the flow from <code class="inline-code">main</code> to the server initialization process to gain deeper insight into lifecycle management.</li>
<li>Look at the exported <code class="inline-code">tools</code> object in <code class="inline-code">tools.ts</code> to understand how each tool fits into the overall mission framework.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Quest 2: Commanding the MCP Interface is a stellar success‚Äîyour cosmic navigation is surging toward the stars at warp speed, with 20% of your galactic mission now charted! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>