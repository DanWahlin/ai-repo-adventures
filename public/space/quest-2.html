<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Unlocking the Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Chronicles: The Codebase Voyager</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Unlocking the Quest Generation Engine</h1>
<hr>
<p>Your starship, the <em>Infinitum</em>, approaches a glowing repository in the heart of the Digital Nebula‚Äîthe <strong>Quest Generation Engine</strong>. This advanced system converts the cosmic fabric of code into guided adventures for exploration. Equipped with the <strong>Model Context Protocol (MCP)</strong>, you must delve into its core mechanics, decode interstellar generation patterns, and adapt its outputs to the needs of future explorers. But beware! In its intricate design lies countless possibilities‚Äîand hidden challenges.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Generator Calibration</strong>: How does the <code class="inline-code">AdventureManager.initializeAdventure</code> function create and calibrate quests based on project context and user-selected themes?</li>
<li>‚ö° <strong>Orbital Flow Analysis</strong>: What are the mechanics behind <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> in generating narratives and linking quests to project structures?</li>
<li>üõ°Ô∏è <strong>Stellar Safeguards</strong>: How does <code class="inline-code">loadAdventureConfig</code> handle missing, invalid, or malformed configuration files to ensure stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Managing Quest Lifecycle and State</h3>
<p>The <code class="inline-code">AdventureManager</code> orchestrates the creation, execution, and progression of quests. It interacts heavily with the <strong>StoryGenerator</strong> module and configuration systems to dynamically prepare adventures based on project context. By utilizing the <code class="inline-code">AdventureState</code>, it preserves the starship crew‚Äôs exploration progress while adapting on-the-fly.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">AdventureManager.initializeAdventure</code>: Initiates a new adventure, processing themes, configuration merging, and quest initialization based on project context.</li>
<li><code class="inline-code">AdventureManager.exploreQuest</code>: Handles quest execution by validating user decisions, retrieving cached adventures, or generating new quest data dynamically.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code>: Tracks quest completion progress in percentage, guiding explorers toward overall mission fulfillment.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Sets up the adventure by initializing context variables like <code class="inline-code">projectInfo</code> and <code class="inline-code">currentTheme</code>.</li>
<li>Merges configuration-defined quest files into generated quest structures.</li>
<li>Enforces quest boundaries, ensuring parity with adventure.config.json when available.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Manages player decisions for exploration, validating their choice through sanitization methods.</li>
<li>Handles both progress tracking and quest execution requests.</li>
<li>Implements dynamic quest resolution logic: retrieves cached quests or generates new quest content.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>A simple but essential metric function for tracking stellar progress.</li>
<li>Converts the ratio of completed quests to total quests into a percentage, providing key feedback for explorers.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Crafting Narratives and Adventures</h3>
<p>The <code class="inline-code">StoryGenerator</code> is the engine behind quest creation and narrative design, responsible for using LLMs to analyze project structure and produce dynamic, interactive guides. This module ensures thematic consistency and integrates storytelling into technical exploration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">StoryGenerator.generateStoryAndQuests</code>: Analyzes project repositories and generates both overarching narratives and quests.</li>
<li><code class="inline-code">StoryGenerator.generateQuestContent</code>: Generates detailed content for individual quests using user-selected themes, parsed configuration, and code highlights.</li>
<li><code class="inline-code">StoryGenerator.removeLLMMetaCommentary</code>: Cleans LLM-generated content, ensuring readable and theme-appropriate responses.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Organizes the story creation pipeline by combining project-level data with validated themes.</li>
<li>Interfaces directly with LLMs for generating structured guidance and quests.</li>
<li>Ensures consistency by funneling project data through standard validation mechanisms.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    const customInstructions = extractCustomInstructions(this.projectPath);
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    questPosition,
    totalQuests
  });

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST })
  );

  if (!response.content || response.content.trim() === &#39;&#39;) {
    throw new Error(&#39;LLM returned empty response for quest content&#39;);
  }
  
  let cleanContent = response.content.trim();
  return { adventure: cleanContent, fileExploration: &#39;&#39;, codeSnippets: [], hints: [] };
}
</code></pre>
<ul>
<li>Handles LLM-based quest content generation using project-specific prompts based on parsed configurations.</li>
<li>Implements fallback mechanisms, formatting input carefully to reduce prompt token usage during LLM requests.</li>
<li>Handles context loss gracefully by incorporating stored narrative data.</li>
</ul>
<hr>
<pre><code class="language-typescript">private removeLLMMetaCommentary(content: string): string {
  const lines = content.split(&#39;\n&#39;);
  const metaCommentaryPatterns = [
    /^Here is the continuation of/i,
    /^Below is the content generated/i
  ];

  let startIndex = 0;
  for (let i = 0; i &lt; Math.min(lines.length, 10); i++) {
    const line = lines[i].trim();
    if (metaCommentaryPatterns.some(pattern =&gt; pattern.test(line))) {
      startIndex = i + 1;
    } else {
      break;
    }
  }
  return lines.slice(startIndex).join(&#39;\n&#39;).trim();
}
</code></pre>
<ul>
<li>Removes unnecessary descriptions from LLM-generated outputs, ensuring that explorers receive theme-appropriate content.</li>
<li>Refines quest guides to prevent confusion caused by AI meta-commentary.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Harnessing Configuration Files</h3>
<p>This file interconnects the space adventure with its configuration system. By extracting directives and file-level highlights, it builds context-aware exploration paths. Essential for mapping quests to the starship‚Äôs cosmic pathways.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Reads raw adventure configuration files and checks their presence.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Parses and extracts usable data from the configuration while validating its structure.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Formats configuration files into concise formats optimized for LLM prompt generation.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Implements file existence checks and reads the <code class="inline-code">adventure.config.json</code> file securely.</li>
<li>Serves as the entry point for loading configuration data from the project repository.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Validates and parses configuration content, providing rich error management pathways.</li>
<li>Ensures malformed input doesn‚Äôt disrupt system operation, reducing risks during quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  let formatted = `## Quest Structure\n`;

  for (const quest of adventure?.quests || []) {
    formatted += `### ${quest.title}\nFiles: ${quest.files?.map((f: any) =&gt; f.path).join(&#39;, &#39;)}\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Optimizes configuration information for compact LLM usage, reducing token overhead.</li>
<li>Assists narrative generation by pre-formatting quest-linked file structures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Space Explorer Tip: Begin by tracking how <code class="inline-code">initializeAdventure</code> adapts quests to project-specific contexts‚Äîthis will reveal the Quest Generation Engine‚Äôs dynamic capacity!</li>
<li>Navigate the Cosmic Configs: Pay attention to how <code class="inline-code">formatAdventureConfigForPrompt</code> reduces complexity, making prompts smaller and more effective.</li>
<li>Stellar Validation: Test edge cases by examining how <code class="inline-code">parseAdventureConfig</code> handles empty or malformed configuration files.</li>
</ul>
<hr>
<p>You have revealed the mysteries of the Quest Generation Engine! Excellent work! Continue your journey to uncover more cosmic secrets among the stars.</p>
<p>Mission accomplished, Explorer‚ÄîQuest 2 successfully unlocked the Quest Generation Engine, propelling your starship to 20% completion and igniting cosmic brilliance on your journey to the stars! üöÄ‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>