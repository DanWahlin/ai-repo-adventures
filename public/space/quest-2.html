<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Activating the Command Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: Navigating the Nebula of Innovation</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Activating the Command Bridge</h1>
<hr>
<p>Across the stars of the digital universe, your starship approaches a critical juncture‚Äîa luminous nebula containing the Command Bridge of the adventure-hosting core. This bridge, a key layer of the ship&#39;s interactive systems, must be activated to orchestrate collaboration between tools and systems. As captain, your task is to unravel the workings of the bridge&#39;s intricate mechanisms.</p>
<p>Prepare your scanners, brave explorer, as the files before you hold the key to understanding the MCP Tool Interface. The time has come to decode its secrets and chart your course forward.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Subsystem Diagnostics</strong>: How does <code class="inline-code">setupHandlers</code> ensure seamless integration of tools into the MCP server architecture?</li>
<li>‚ö° <strong>Bridge Activation</strong>: What processes are triggered by the <code class="inline-code">run</code> function to initialize the server and prepare it for operation?</li>
<li>üõ°Ô∏è <strong>Navigational Stability</strong>: How does <code class="inline-code">main</code> ensure resilient startup and graceful shutdown in the face of errors and system signals?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Creation and Management</h3>
<p>This file defines and initializes the <code class="inline-code">RepoAdventureServer</code> class, an essential vessel for hosting the MCP (Model Context Protocol) server. Key features include dynamically registering tools, managing server-state lifecycles, and handling graceful shutdowns to ensure reliability. The intricate role of handlers within this server highlights the modularity of tool execution, enabling a flexible and error-resilient architecture.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> maps various tools and their validation schemas to the server, ensuring dynamic execution and extensive error handling.</li>
<li><code class="inline-code">run</code> initiates the server transport, connects to the system, and prepares underlying content structures like cache warming for optimized operations.</li>
<li><code class="inline-code">main</code> serves as the operational nucleus, managing startup, shutdown signals, and unhandled errors to safeguard system integrity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools by extracting their schemas and descriptions, adapting to new functionalities without static configuration.</li>
<li>Validates tool inputs using Zod schemas, ensuring data integrity and providing clear error feedback for invalid requests.</li>
<li>Handles various error conditions with custom exceptions like <code class="inline-code">McpError</code>, maintaining robust error-reporting mechanics.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes communication via <code class="inline-code">StdioServerTransport</code>, ensuring smooth IO between the server and client tools.</li>
<li>Uses <code class="inline-code">repoAnalyzer.preGenerate</code> to warm up content caches in the background, optimizing subsequent tool executions.</li>
<li>Logs essential runtime information to the console, aiding diagnostics and transparency during operation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the <code class="inline-code">RepoAdventureServer</code> and sets up listeners for termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to facilitate graceful shutdowns.</li>
<li>Monitors unhandled promise rejections, logging them for debugging without crashing the server unnecessarily.</li>
<li>Acts as the starting point for the program‚Äôs lifecycle, coordinating all server initialization and error handling.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Definition and Registration</h3>
<p>This file introduces the core tools of the MCP system, mapping their individual functionalities into the system namespace. The tools drive the interactive exploration experience, including adventure initialization, theme selection, quest navigation, and progress tracking.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">tools</code> provides a registry of all tools, linking their handlers and schemas to the MCP interface.</li>
<li><code class="inline-code">start_adventure.handler</code> launches the first exploratory step for users, setting the stage for further engagement.</li>
<li><code class="inline-code">choose_theme.handler</code>, <code class="inline-code">explore_quest.handler</code>, and <code class="inline-code">view_progress.handler</code> expand the narrative journey, enabling customization and tracking.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Aggregates all tools into a single export, simplifying server-side registration and updates to the toolset.</li>
<li>Offers a unified interface for accessing functionalities, promoting modularity and extensibility.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>‚öôÔ∏è Use <code class="inline-code">setupHandlers</code> as a reference point for adding new tools or modifying server response behaviors.</li>
<li>üöÄ Dive into <code class="inline-code">run</code> to understand how server initialization connects with subsystems like transport and cache warm-up.</li>
<li>üí° Explore <code class="inline-code">main</code> for insights into crafting robust entry points with proper error handling and shutdown procedures.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of this cosmic engine.</p>
<p>Stellar work, Commander‚ÄîQuest 2 is complete, and the Command Bridge is fully operational; your mission trajectory is lighting up like a supernova‚Äîkeep charting the stars! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>