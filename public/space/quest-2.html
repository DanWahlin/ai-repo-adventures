<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Commanding the MCP Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Repository Missions: The Codebase Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Commanding the MCP Nexus</h1>
<hr>
<p>As the Stellar Code Alliance ventures deeper into the galactic expanse of logic and code, the <em>RepoStar Matrix</em> must rely on the intricate systems of the <em>MCP Nexus</em>. This powerful interface bridges human command with AI precision. Your mission? To calibrate its handlers, energize its transport system, and ensure its tools execute flawlessly. The crew‚Äôs navigation, storytelling, and technical assets hinge on the Nexus‚Äô integrity. Prepare to decode the mysteries of its finely-tuned mechanisms and unlock the tools that bring adventures to life.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Calibration Scanner</strong>: How does the MCP Nexus dynamically list tools and validate schemas before execution?</li>
<li>‚ö° <strong>Transport Energizer</strong>: What patterns enable seamless communication between the MCP server and its transport layer during runtime?</li>
<li>üõ°Ô∏è <strong>Error Shield Command</strong>: How does the Nexus guard against execution errors and recover from unexpected scenarios?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Nexus Server Module</h3>
<p>The file <code class="inline-code">server.ts</code> contains the main MCP interface for the <em>RepoStar Matrix</em>. It initializes server mechanisms, establishes protocols for dynamic tool handling, and integrates error management strategies to ensure reliable operations during missions. Here, you‚Äôll discover how handlers are set up to manage tool listings and tool execution, as well as the graceful shutdown mechanism designed for high-risk operations in space missions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates schemas for command-line requests.</li>
<li><code class="inline-code">run</code>: Activates server transport and pre-generates content for background operations.</li>
<li><code class="inline-code">main</code>: Starts the MCP server and implements graceful shutdown protocols to prevent catastrophic failures.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tool Registry</h3>
<p>This file defines the tools available to the MCP Nexus system and their corresponding handlers. Each tool serves a specific purpose in the storytelling and exploration pipelines. The tools module also regulates the schema and descriptions for client requests. Tools such as <code class="inline-code">start_adventure</code> and <code class="inline-code">choose_theme</code> orchestrate immersive experiences for the crew as they unravel cosmic mysteries.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Automatically analyzes the codebase and initializes interactive adventures.</li>
<li><code class="inline-code">choose_theme.handler</code>: Aligns system resources to the chosen narrative style for the mission.</li>
<li><code class="inline-code">explore_quest.handler</code>: Enables quest exploration by processing parameters and returning relevant outcomes.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks quest completion and overall mission status for monitoring achievements.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) throw error;
      throw new McpError(ErrorCode.InternalError, `Tool execution failed: ${error.message}`);
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps available tools into the system, ensuring scalability as new tools are added to the codebase.</li>
<li>Validates user input with Zod schemas, showcasing robust error handling.</li>
<li>Throws structured errors using <code class="inline-code">McpError</code> for consistent feedback during failures.</li>
<li>Directly ties tool execution with pre-validation, maintaining Nexus reliability during runtime operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the connection with <code class="inline-code">StdioServerTransport</code>, creating a direct communication line for tools.</li>
<li>Pre-generates content in the background, boosting runtime efficiency for tool access during missions.</li>
<li>Highlights asynchronous operations and parallel task execution for operational readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal-based shutdown mechanisms (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) for high-stakes mission scenarios.</li>
<li>Detects unhandled promise rejections, offering resilience in unpredictable cosmic environments.</li>
<li>Ensures ungraceful process exits are avoided, critical in maintaining starship stability.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Categorizes all available MCP tools, streamlining registration and execution flow.</li>
<li>Maintains modular tool design, promoting reusability across diverse quests and themes.</li>
<li>Connects each handler to its respective purpose in navigational story systems.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure schemas are updated for all tools when making changes to their arguments.</li>
<li>Analyze <code class="inline-code">setupHandlers</code> alongside <code class="inline-code">tools.ts</code> to evaluate seamless integration between handlers and tools.</li>
<li>Utilize graceful shutdown methods for debugging live server connections during exploratory missions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the infinite cosmos of code and logic.</p>
<p>Stellar work, Commander! You&#39;ve successfully navigated the cosmic currents of Quest 2: Commanding the MCP Nexus‚Äîengines primed, you&#39;re now 20% closer to mastering this galactic voyage! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>