<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Cosmic Story Forge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Stellar Chronicles: Galactic Codebase Expeditions</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Cosmic Story Forge</h1>
<hr>
<p>The Odyssey cruises through a stellar storm, its hull gleaming as strings of exotic particles ripple across space. The AI Starship Odyssey, more than just a ship, is your companion in unraveling the cosmic mysteries hidden within deep sectors of galactic code. Your mission: refine and bolster the Alliance&#39;s critical infrastructure systems. Today, the crew sets a course for a celestial forge of data‚Äîwhere the tools to tailor quests and generate immersive cosmic narratives reside. It is here that the art of adventure assembly awaits your expertise as the crew delves into interactive tale-shaping technologies.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Calibration</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically list tools and validate tool execution?</li>
<li>‚ö° <strong>Engine Ignition</strong>: What processes are initiated in the <code class="inline-code">run</code> function to prepare the MCP environment for action?</li>
<li>üõ°Ô∏è <strong>Fail-Safe Protocols</strong>: How does the <code class="inline-code">main</code> function provide robust server initialization and handle graceful shutdowns?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server Implementation</h3>
<p>This file covers the foundational code for the MCP server, responsible for managing tools and processing requests. The <code class="inline-code">RepoAdventureServer</code> class is central to this setup, orchestrating the communication layer and interactive storytelling mechanisms. Key functions handle request validation, response generation, and critical server operations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists available tools and ensures validations for tool execution to maintain system integrity.</li>
<li><code class="inline-code">run</code>: Initializes the server, connects transports, and pre-generates content for seamless interactivity with the repository.</li>
<li><code class="inline-code">main</code>: Acts as the entry point for the application, encapsulating server creation, signal handling, and error management.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically lists tools by iterating over the <code class="inline-code">tools</code> object, ensuring that every tool exposed has its schema and description clearly defined.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to render tool input schemas into JSON schema format, simplifying compatibility with client-side systems.</li>
<li>Implements robust validation through Zod schema parsing before execution, ensuring only valid inputs are processed.</li>
<li>Throws specific errors for <code class="inline-code">MethodNotFound</code> or parameter validation, enhancing maintainability and diagnostics in the pipeline.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Establishes the <code class="inline-code">StdioServerTransport</code>, a lightweight transport designed for CLI environments, ensuring server communication.</li>
<li>Logs server status to confirm successful initialization, providing clarity during runtime monitoring.</li>
<li>Pre-generates repomix content using the <code class="inline-code">repoAnalyzer</code> utility for efficient caching‚Äîdrastically improving user responsiveness on first interaction.</li>
<li>Gracefully integrates multi-thread operations by decoupling commands from the pre-generation process.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates the central <code class="inline-code">RepoAdventureServer</code> instance, encapsulating all server functionality for modular design.</li>
<li>Attaches signal listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to trigger the <code class="inline-code">gracefulShutdown</code> function, ensuring a clean exit under termination commands.</li>
<li>Logs unhandled promise rejections, preventing system crashes and providing actionable debugging information without compromising runtime stability.</li>
<li>Wraps server startup in a <code class="inline-code">try-catch</code> block, logging fatal errors and exiting with appropriate codes for system-level consistency.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Always cross-reference <code class="inline-code">zodToJsonSchema</code> documentation to understand how JSON schemas streamline communication between server and client.</li>
<li>Experiment with simulated tool requests in <code class="inline-code">CallToolRequestSchema</code> to observe the error handling systems in action.</li>
<li>Trace the lifecycle initiated by <code class="inline-code">main</code> using breakpoints or console logs to fully grasp initialization and failure recovery.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar work, cosmic voyager‚ÄîQuest 2: Cosmic Story Forge has been charted with brilliance, propelling your learning mission 20% closer to the stars! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>