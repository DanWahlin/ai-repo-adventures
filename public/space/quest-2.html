<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Starforge of Narratives - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship RepoVenture: Charting the Code Galaxy</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h2>Quest 2: Starforge of Narratives</h2>
<p>The LLM core hums like a newborn star as your research starship approaches the Starforge of Narratives. Here, story-plasma is refined into mission-grade quests that plot your trajectory across the code galaxy. The command bridge speaks the Model Context Protocol while reactors channel configuration flux into a stable narrative orbit. Your scanners align on three modules: the adventure manager helm, the story generator foundry, and the adventure configuration beacon. Decode their signals, trace their control loops, and calibrate the forge to shape reliable, theme-aligned quests from raw repository constellations.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">initializeAdventure</code> merge config-driven quest files and then enforce a config-defined quest count without losing LLM-generated structure?</li>
<li>‚ö° Reactor Flow Mapping: In <code class="inline-code">generateQuestContent</code>, how are adventure config guidance and custom instructions woven into prompts alongside targeted code slices?</li>
<li>üõ°Ô∏è Shield Integrity Check: What safety nets do <code class="inline-code">withTimeout</code> and Zod schema validation provide in <code class="inline-code">generateWithLLM</code>, and how do they interact with markdown parsing?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Orchestrates narrative initialization, quest selection, and execution</h3>
<p>This helm coordinates initialization, selection, and execution of quests. In <code class="inline-code">initializeAdventure</code>, the system first resets state, locks in theme and project context, and optionally installs custom theme parameters into the story generator. It then requests a fresh StoryResponse from the generator before carefully weaving in configuration constraints from <code class="inline-code">adventure.config.json</code>. Two vital calibration passes occur: <code class="inline-code">mergeQuestFilesFromConfig</code> injects file paths into per-quest payloads using positional and fallback title matching, and <code class="inline-code">enforceConfigQuestCount</code> trims the quest manifest to match config cadence. During exploration, <code class="inline-code">exploreQuest</code> validates the traveler‚Äôs choice, resolves it to a quest by number, id, or title, and runs <code class="inline-code">executeQuest</code>. Execution validates prerequisites, selects targeted code context using <code class="inline-code">repoAnalyzer.generateTargetedContent</code> when available, and funnels content and completion summary back through the story generator. Caching ensures completed quests can be revisited efficiently while preserving narrative flow. Finally, progress beacons are emitted with <code class="inline-code">progressPercentage</code>, and presentation helpers format storyline and choices for the command bridge. The result is a cohesive navigation stack that fuses theme, config, and repository signals into a consistent, replayable mission loop.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code> establishes project/theme context, requests LLM story+quests, merges config file mappings, enforces quest counts, and formats the opening star chart for players.</li>
<li><code class="inline-code">exploreQuest</code> validates and interprets user navigation, resolves a quest via number/id/title matching, and delegates to execution while supporting a progress-view path.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code> computes completion progress as a percentage, powering progress beacons that guide trajectory across the adventure galaxy.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
  ): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Initializes the navigation state and binds theme/project context to subsequent mission steps.</li>
<li>Integrates custom themes early via <code class="inline-code">setCustomTheme</code>, ensuring downstream prompts carry tailored vocabulary.</li>
<li>Calls <code class="inline-code">generateStoryAndQuests</code> to obtain the raw narrative skeleton from the LLM core.</li>
<li>Applies a two-stage config synchronization: file path injection and quest count enforcement.</li>
<li>Returns a formatted story with choices, aligning the bridge UI with the current quest manifest.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Acts as the primary helm input, validating traveler intent via <code class="inline-code">validateAdventureChoice</code>.</li>
<li>Supports a non-quest progress path, mapping bridge commands to a progress beacon.</li>
<li>Resolves quests by multiple identifiers, enhancing usability on the command bridge.</li>
<li>Delegates the heavy lifting to <code class="inline-code">executeQuest</code>, which handles caching, content generation, and summary.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Computes completion telemetry, keeping the crew informed of mission trajectory.</li>
<li>Uses rounding for a human-friendly beacon indicator.</li>
<li>Guards against zero-division when no quests are present.</li>
<li>Powers status overlays and completion acknowledgments throughout the mission UI.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Central entry to the Starforge, setting project and path context for prompt composition.</li>
<li>Validates the theme to ensure narrative alignment with approved vocabularies.</li>
<li>Delegates generation to <code class="inline-code">generateWithLLM</code>, encapsulating prompt assembly and response handling.</li>
<li>Keeps <code class="inline-code">currentStoryContent</code> updated indirectly via the LLM pipeline.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  codeContent: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  // Include formatted adventure config as context if available
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;
  
  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }
    
    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  }) + &#39;\n\nIMPORTANT: Respond with ONLY markdown content between explicit delimiters.\n\nFormat your response EXACTLY like this:\n\n---BEGIN MARKDOWN---\n[Your markdown content here starting with the quest title]\n

Mission log update: You‚Äôve successfully forged constellations of storycraft in Quest 2: Starforge of Narratives‚Äîblasting to 20% completion‚Äîyour narrative thrusters are humming, shields of skill reinforced, and the starship of learning is cleared for the next hyperspace jump‚Äîstellar work, Captain! üöÄ‚≠ê‚ö°üì°
</code></pre>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>