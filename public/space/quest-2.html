<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Ignite the Story Reactor - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Aurora: Navigating the Repository Constellation</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Ignite the Story Reactor</h1>
<hr>
<p>Aboard the starship Aurora, you route extra power to the LLM reactor, aligning its output with the repo analyzer‚Äôs constellations. Your mission: convert raw repository nebulae into navigable adventures and track progress across the galaxy. The bridge exposes an MCP interface for allied ships, while your scanners use configuration star maps to calibrate every sweep. This chapter focuses your sensors on the Story Reactor and its control conduits, ensuring the narrative core ignites cleanly and delivers stable quest plasma to the crew.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">initializeAdventure</code> weave theme settings, project path, and config-driven quest files into a single aligned story output?</li>
<li>‚ö° Reactor Flow: When <code class="inline-code">exploreQuest</code> selects and executes a mission, how do caching and prerequisite verification shape the control flow and performance?</li>
<li>üõ°Ô∏è Safety Shielding: Where do <code class="inline-code">progressPercentage</code> and config parsers enforce constraints, and how do <code class="inline-code">parseAdventureConfig</code> plus <code class="inline-code">formatAdventureConfigForPrompt</code> prevent invalid inputs from destabilizing the reactor?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Command deck orchestrating story ignition and quest execution</h3>
<p>This command module coordinates the ignition sequence by invoking <code class="inline-code">StoryGenerator</code> and applying navigation overlays from local configs. <code class="inline-code">initializeAdventure</code> resets the ship‚Äôs state, sets up the theme harmonics, merges quest file targets from <code class="inline-code">adventure.config.json</code>, and enforces quest count alignment to avoid drift. When a crew member selects a mission, <code class="inline-code">exploreQuest</code> validates input through bridge controls, checks for a progress scan request, resolves the quest by number or title, and executes it via <code class="inline-code">executeQuest</code>. During execution, the reactor draws on targeted file payloads through <code class="inline-code">repoAnalyzer</code> and caches results in <code class="inline-code">questContentCache</code>, minimizing energy draw on subsequent passes. The <code class="inline-code">AdventureState.progressPercentage</code> getter monitors mission completion across the constellation of quests, informing progress telemetry and the MCP-facing responses. This file emphasizes resilient flow control: it sanitizes choices, implements fallbacks when targeted analysis fails, and ensures completion summaries are generated with consistent theme output. Watch for the interplay between <code class="inline-code">mergeQuestFilesFromConfig</code> and <code class="inline-code">enforceConfigQuestCount</code> to understand how configuration star maps constrain and guide the narrative vectors. The design prioritizes deterministic output for clients while still taking advantage of LLM flexibility through well-bounded prompts and context.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code> bootstraps the story reactor by resetting state, validating theme inputs, generating story and quests, then merging and enforcing config-driven quest structures to maintain a stable mission map.</li>
<li><code class="inline-code">exploreQuest</code> governs selection and execution, routing through validation, progress checks, quest resolution, caching, and summary generation to optimize reactor cycles and user flow.</li>
<li><code class="inline-code">progressPercentage</code> provides real-time telemetry for mission status, crucial for displaying progress scans and guiding next steps in the galaxy.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  // Set custom theme data if provided
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  // Generate the overall story and quests using LLM
  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  // Merge files from adventure config into the generated quests
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  
  // Enforce quest count from adventure.config.json if it exists
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  // Return the story with available quests
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Bootstraps the mission by resetting navigation memory and binding theme harmonics and project path.</li>
<li>Delegates story and quest generation to <code class="inline-code">StoryGenerator.generateStoryAndQuests</code>, then integrates config-driven file targets.</li>
<li>Applies <code class="inline-code">mergeQuestFilesFromConfig</code> and <code class="inline-code">enforceConfigQuestCount</code> to keep the quest constellation aligned to config star maps.</li>
<li>Returns a formatted composite suitable for MCP broadcast and UI rendering.</li>
<li>Shows a pattern of LLM output constrained by deterministic configuration data for stability.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  
  // Check if this is a progress request
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  // Find the quest based on the choice
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  // Execute the quest
  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates operator input via <code class="inline-code">validateAndSanitizeChoice</code> to prevent malformed commands.</li>
<li>Supports quick progress scans without executing missions by detecting progress requests.</li>
<li>Resolves quests by number, id, or title for flexible helm control.</li>
<li>Bridges selection to <code class="inline-code">executeQuest</code>, where caching and generation occur.</li>
<li>Encapsulates a clean mission control loop for predictable UX.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Computes real-time completion telemetry across all missions.</li>
<li>Guards against division by zero when quests are not yet provisioned.</li>
<li>Centralizes progress logic for consistent reporting in MCP and UI layers.</li>
<li>Encourages UI elements like progress bars or status beacons to remain synchronized.</li>
<li>Lightweight and deterministic, suitable for frequent reads.</li>
</ul>
<hr>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Single entry point for safely parsing <code class="inline-code">adventure.config.json</code>.</li>
<li>Returns <code class="inline-code">null</code> on read or parsing failure to keep the reactor running without hard faults.</li>
<li>Prevents invalid JSON from contaminating navigation logic.</li>
<li>Enables upstream callers to apply conservative fallbacks.</li>
<li>Contributes to a fail-soft configuration pipeline.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    // Extract and validate path
    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    // Add children to stack
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses the config nebula to collect valid file paths, ensuring only real, reachable targets are referenced.</li>
<li>Uses a stack-based object graph walk to remain robust against nested structures.</li>
<li>Validates existence with <code class="inline-code">fs.existsSync</code> to prevent dead links in navigation.</li>
<li>Outputs deduplicated lists to streamline targeted analysis passes.</li>
<li>Supports precise sensor locks for targeted quest generation.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    
    // Just file paths, no verbose descriptions
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
    
    // Just function names, no descriptions
    const functions = quest.files
      .flatMap((f: any) =&gt; f.highlights || [])
      .map((h: any) =&gt; h.name)
      .filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li>Produces a compact star map for LLM prompts, emphasizing structure over verbosity.</li>
<li>Lists file paths and function names to guide the reactor‚Äôs focus during generation.</li>
<li>Returns empty strings when data is missing, allowing higher layers to skip prompt augmentation cleanly.</li>
<li>Reduces token mass to keep transmissions efficient.</li>
<li>Aligns LLM context with deterministic configuration to stabilize output quality.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Prefer <code class="inline-code">View progress</code> during testing to confirm <code class="inline-code">progressPercentage</code> telemetry before executing heavy quests.</li>
<li>Compare targeted file lists produced by config with actual repo files to verify <code class="inline-code">extractUniqueFilePaths</code> assumptions.</li>
<li>If quests feel misaligned, inspect how <code class="inline-code">initializeAdventure</code> merges and trims quests using your <code class="inline-code">adventure.config.json</code>.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Update: With Quest 2‚ÄîIgnite the Story Reactor‚Äîsuccessfully completed, your narrative engines are firing at full thrust as you chart a 20% course toward the stars, plotting the next jump on your creative flight plan‚Äîstellar work, captain! üöÄ‚≠ê‚ö°üì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>