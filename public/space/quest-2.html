<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Command Nexus of MCP - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Starship Nexus: Adventures in the Code Cosmos</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Command Nexus of MCP</h1>
<hr>
<p>The cosmic voyage continues aboard the Starship Nexus, delving deeper into the unexplored Code Cosmos. In the sector known as &quot;MCP Command Nexus,&quot; the crew investigates dynamic systems for interactive storytelling and tool integration. Before this mission is complete, explorers must uncover how the MCP server orchestrates tools and generates cosmic adventures from raw data streams. The Command Nexus is both the steward and guide for the crew, ensuring seamless operation across lightyears of code. Onward, heroes, for this mission is critical to the success of the Nexus‚Äô journey into the Code Cosmos!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Nexus Handlers</strong>: How does <code class="inline-code">setupHandlers</code> dynamically link tools to the MCP server, and what validation layers ensure accuracy during operation?</li>
<li>‚ö° <strong>Core Operations</strong>: What sequence does the <code class="inline-code">run</code> function follow to initialize the transport and pre-generate essential data for seamless adventures?</li>
<li>üõ°Ô∏è <strong>Shutdown Protocols</strong>: How does the <code class="inline-code">main</code> function handle system failures, promise rejections, and graceful shutdowns to ensure sustainable navigation?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: MCP server orchestration and tool integration</h3>
<p>This file encapsulates the core functions of the MCP Command Nexus, responsible for managing tools and interactions for gamified code exploration. It defines the MCP server, setups dynamic handlers for tools, ensures validation using <code class="inline-code">zod</code> schemas, and incorporates warm-up processes for adventure generation. It also establishes a robust error-handling and shutdown protocol for dependable performance across starship operations. The crew relies on this code to maintain the MCP server&#39;s functionality for every tool-based interaction.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically links tools into the MCP system by mapping <code class="inline-code">tools</code> using schemas for validation and execution. This ensures error-free activation across all tool commands.</li>
<li><code class="inline-code">run</code> initializes the server transport, connects the MCP system to the command interface, and pre-generates cosmic content to reduce latency during exploratory missions.</li>
<li><code class="inline-code">main</code> oversees lifecycle management, including error handling and cleanup processes, responding to shutdown signals and promise rejections for safe system navigation.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically maps every tool in <code class="inline-code">tools</code> to the MCP server, ensuring accessibility through structured schemas.</li>
<li>Utilizes <code class="inline-code">zod</code> schemas for input validation, establishing strong error prevention at the interaction level.</li>
<li>Handles execution errors gracefully, translating them into meaningful responses for optimal user feedback.</li>
<li>Maintains modularity, allowing easy tool extension without changes to the core server structure.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the communication transport through <code class="inline-code">StdioServerTransport</code>, establishing seamless data flow to the MCP server.</li>
<li>Logs operational events such as initialization and data pre-generation for transparency during system execution.</li>
<li>Starts warm-up procedures with <code class="inline-code">repoAnalyzer.preGenerate</code> to reduce computation delay for incoming adventures.</li>
<li>Operates asynchronously, keeping the server available during caching operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Manages server lifecycle with robust signal handling for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, ensuring safe shutdown procedures.</li>
<li>Logs and identifies key issues arising from unhandled promise rejections while sustaining core operations under non-fatal errors.</li>
<li>Incorporates <code class="inline-code">repoAnalyzer.cleanup</code> to free resources before system termination, securing a smooth exit.</li>
<li>Prevents catastrophic failure by capturing fatal errors during initialization and responding with immediate process termination.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to the validation mechanism in <code class="inline-code">setupHandlers</code>. Notice how schemas dynamically interface with tools for precise error handling.</li>
<li>Observe how asynchronous processes such as <code class="inline-code">repoAnalyzer.preGenerate</code> integrate warm-up cycles with server launch operations.</li>
<li>Study the lifecycle controls in <code class="inline-code">main</code> to understand how signals and errors are processed in real-time during system navigation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar work, cadet, you&#39;ve navigated through the cosmic labyrinth of the Command Nexus of MCP‚Äîyour trajectory is locked onto greatness at warp speed! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>