<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Code Chronicles: Missions Beyond the Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>Aboard the starship <em>Celestial Refactor</em>, the crew detects an intriguing anomaly within the interstellar codebase: the Modular Command Protocol (MCP) Tool Interface. This interface, a crucial component of galactic navigation software, promises to streamline mission operations if properly decoded. However, its intricacies are formidable, demanding careful investigation into its dynamic tool registration, execution, and error handling mechanisms. With your AI copilots and stellar intellect, it‚Äôs time to decipher how this interface powers your starship‚Äôs quest generation systems!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>System Configuration Scan</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools and validate their parameters for execution?  </li>
<li>‚ö° <strong>Command Activation Sequence</strong>: How does <code class="inline-code">run</code> initialize the MCP server and pre-generate cached content, ensuring operational efficiency?  </li>
<li>üõ°Ô∏è <strong>Error Horizon Analysis</strong>: How are errors such as invalid parameters or unknown tools handled during the <code class="inline-code">main</code> function&#39;s lifecycle?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The heart of the MCP server</h3>
<p>The <code class="inline-code">server.ts</code> file orchestrates the MCP Tool Interface, connecting tools with requesting clients through dynamic handlers. It leverages the <code class="inline-code">Server</code> class to support two key features: registering tools at runtime via <code class="inline-code">setupHandlers</code>, and enabling tool execution with advanced error handling. The <code class="inline-code">run</code> function initializes the server, configures transport, and primes the system by pre-generating content in the background. Finally, <code class="inline-code">main</code> handles lifecycle management, including graceful shutdown routines and unhandled promise rejections. This file is critical for maintaining the adaptive capabilities of the interstellar codebase interface.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists and validates tools using schemas, enabling seamless operation within the MCP framework.</li>
<li><code class="inline-code">run</code> activates the server transport layer, connects it to the system, and ensures pre-generated content is ready for user commands.</li>
<li><code class="inline-code">main</code> ensures robust execution by safeguarding against lifecycle mishaps, handling shutdowns and errors gracefully.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists tools by iterating over the <code class="inline-code">tools</code> object and converting schema definitions to JSON schemas.</li>
<li>Validates tool parameters at runtime, ensuring robust input handling via Zod schemas.</li>
<li>Executes handler functions for tools, allowing dynamic and contextual tool functionality.</li>
<li>Implements error handling for unknown tools, invalid parameters, and execution failures, which enhances system resilience.</li>
<li>Converts validation errors into user-readable error messages, improving debugging efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes the server communication channel with the <code class="inline-code">StdioServerTransport</code> for seamless data exchange.</li>
<li>Logs key operational status messages, keeping the crew informed about the server‚Äôs readiness.</li>
<li>Executes a pre-generation process via <code class="inline-code">repoAnalyzer.preGenerate</code>, optimizing system efficiency by warming up the cache.</li>
<li>Uses <code class="inline-code">process.cwd()</code> to dynamically identify the project directory, ensuring adaptability to different environments.</li>
<li>Runs asynchronously, maintaining a responsive and non-blocking system design.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates and initializes an instance of the <code class="inline-code">RepoAdventureServer</code> class, setting the system in motion.</li>
<li>Implements event listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> signals, ensuring a clean shutdown with <code class="inline-code">gracefulShutdown</code>.</li>
<li>Handles unhandled promise rejections gracefully, improving fault tolerance without compromising runtime stability.</li>
<li>Encapsulates the entire server startup in a try-catch block to handle critical initialization errors.</li>
<li>Logs fatal errors and exits with an appropriate status code for effective troubleshooting.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> The command library</h3>
<p>This file defines the interactive tools used within the MCP interface. Each tool corresponds to an essential operation for exploring and understanding codebases. Tools are modular, with well-defined handlers and schemas, ensuring they integrate seamlessly into the larger framework.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initializes a repo analysis with theme suggestions for quest generation.</li>
<li><code class="inline-code">choose_theme.handler</code> enables users to select a narrative theme, tailoring the experience to their preferences.</li>
<li><code class="inline-code">explore_quest.handler</code> facilitates individual quest exploration, ensuring users can interact with generated content.</li>
<li><code class="inline-code">view_progress.handler</code> provides status updates on quest completion, helping users track their progress.</li>
<li><code class="inline-code">tools</code> consolidates all exported handlers into a structured object for seamless integration with the MCP interface.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const tools = {
  start_adventure: startAdventure,
  choose_theme: chooseTheme,
  explore_quest: exploreQuest,
  view_progress: viewProgress
};
</code></pre>
<ul>
<li>Imports core tools from dedicated files, maintaining modularity and clarity in the codebase.</li>
<li>Defines the <code class="inline-code">tools</code> object, which maps MCP tool names to their corresponding handlers.</li>
<li>Ensures handlers like <code class="inline-code">start_adventure</code> and <code class="inline-code">choose_theme</code> are discoverable and executable.</li>
<li>Maintains a structured design that simplifies tool registration within the MCP server.</li>
<li>Demonstrates the importance of modular organization to foster maintainability and scalability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Be sure to follow the flow of dynamic tool registration within <code class="inline-code">setupHandlers</code> to understand how tools are added at runtime.</li>
<li>Note how <code class="inline-code">main</code> ensures robust lifecycle management through its event listeners and error handling.</li>
<li>When exploring tools, pay attention to how modular organization supports the seamless addition of new functionality.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Star Navigator‚ÄîQuest 2: MCP Tool Interface is secure in the cosmic logbook‚Äîkeep rocketing forward, you&#39;re 20% closer to stardom! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>