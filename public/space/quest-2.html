<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Tool Command Nexus - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Chronicles: The AI Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Command Nexus</h1>
<hr>
<p>The starship <em>Cerebral Voyager</em> drifts into a new region of the Infinite Code Nebula. Ahead, your scanners detect an intricate latticework of alien code streams‚Äîthis is the MCP Control Nexus, a network hub enabling the integration and execution of tools vital for interstellar code exploration. To fulfill the mission, you must investigate the operational command structure of these tools and ensure that their intricate systems are functioning harmoniously. But beware‚Äîthe complexity is immense, and an unhandled fault could destabilize your entire mission. Captain, it is up to you to navigate this technological labyrinth!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scanner Calibration</strong>: How are requests dynamically routed to different tools, and how is each tool‚Äôs input validated before execution?</li>
<li>‚ö° <strong>Command Synchronization</strong>: What mechanisms ensure the MCP server remains operational during unforeseen promise rejections or shutdown signals?</li>
<li>üõ°Ô∏è <strong>System Integrity</strong>: How is error handling structured to manage issues like invalid parameters and unknown tools?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The main server orchestrating MCP tool commands</h3>
<p>This file contains the backbone of the MCP server, responsible for controlling how tools are registered, validated, and executed. Notably, it includes methods for dynamic tool discovery, the processing of tool execution requests, and the setup for running the server. Dive into the code to uncover how it ensures reliable operations, processes inputs seamlessly, and maintains robustness during unexpected situations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists available tools and validates input schemas, ensuring seamless communication between the server and tools.</li>
<li><code class="inline-code">run</code>: Initiates the server with a standard I/O transport, warming up the cache for better performance during quest execution.</li>
<li><code class="inline-code">main</code>: Coordinates the graceful startup and shutdown of the server, while also mitigating the risks of promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Validates tools dynamically at runtime by translating Zod schemas to JSON Schema, ensuring robust input verification.</li>
<li>Establishes modular communication between the server and tools, creating a framework for extensibility without modifying core logic.</li>
<li>Implements strong error handling by categorizing tool-related errors, promoting reliable system behavior and clear debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Bootstraps the MCP system with standard I/O as the primary communication layer, ensuring adaptability in various environments.</li>
<li>Uses background processes to preemptively analyze the codebase, reducing latency for incoming tool execution requests.</li>
<li>Centralizes initialization for one-touch server activation, simplifying deployment and scaling.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Ensures smooth server termination while releasing resources, prioritizing system stability through <code class="inline-code">gracefulShutdown</code>.</li>
<li>Captures promise rejections globally, logging issues without halting critical operations, showcasing battle-tested reliability.</li>
<li>Central to orchestrating the MCP lifecycle, encompassing initialization, error mitigation, and fault tolerance.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool registry for MCP commands</h3>
<p>This file defines the available tools for the MCP system. By leveraging modular imports, it provides an orderly structure for tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. Captains can use it to explore how tools are constructed and exported for server integration.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initializes the MCP adventure by analyzing the repository and setting the stage for exploration.</li>
<li><code class="inline-code">choose_theme.handler</code>: Customizes the storyline by selecting a thematic mood for the code exploration.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes core quest objectives, enabling participants to engage with NPC tools and progress through quests.</li>
<li><code class="inline-code">view_progress.handler</code>: Monitors the overall status of the mission, providing detailed insights into completed and remaining tasks.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<ul>
<li>Directly links handlers for key tools with the MCP architecture, facilitating seamless tool invocation.</li>
<li>Decouples tool logic into individual files for better maintainability and scalability across different use cases.</li>
<li>Provides clear naming conventions by mapping handlers to MCP commands, promoting uniformity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay attention to how error handling differentiates between internal faults and user-related issues.</li>
<li>Look for patterns in initialization processes to understand how the server anticipates user needs.</li>
<li>Experiment with integrating new tools into <code class="inline-code">tools.ts</code> using the modular approach demonstrated.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the Code Nebula.</p>
<p>Bravo, Space Cadet! You&#39;ve successfully launched the MCP Tool Command Nexus into the orbital trajectory of knowledge, accelerating toward the stars of mastery‚Äîkeep your thrusters at full power! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>