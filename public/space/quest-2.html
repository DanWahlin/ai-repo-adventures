<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Connect the Command Systems - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Code Chronicles: The Quest for Stellar Optimization</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Connect the Command Systems</h1>
<hr>
<p>The galaxy&#39;s vast unknowns are not for the fainthearted, and the VirtuScope must prepare for its most critical test yet: aligning its command systems to ensure seamless control across the ship&#39;s modules. As you orbit a nebula writhing with unstable cosmic energy, the AI starship&#39;s integrated tools must be calibrated and synchronized. You‚Äôll delve into the VirtuScope&#39;s core interface, examining how commands are dispatched, tools are executed, and handlers maintain operational harmony. The success of the mission relies on your ability to bridge these systems before the ship veers off course.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Command Bridge Alignment</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically configure the system to respond to tool requests?</li>
<li>‚ö° <strong>Operational Readiness</strong>: What steps occur during the <code class="inline-code">run</code> method to ensure the MCP server is ready for incoming commands?</li>
<li>üõ°Ô∏è <strong>Error Deflection System</strong>: How does the <code class="inline-code">main</code> function handle unexpected errors or shutdown signals to ensure system stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Establishes the main server and command handlers</h3>
<p>The <code class="inline-code">server.ts</code> file is the heart of the VirtuScope&#39;s command systems, where all tool integrations and transport layers are defined. This file contains the <code class="inline-code">RepoAdventureServer</code> class, which orchestrates dynamic tool handling, system initialization, and graceful shutdown mechanics. Critical methods like <code class="inline-code">setupHandlers</code> define how the system adapts to changes in available tools, while <code class="inline-code">run</code> ensures the server is fully operational before accepting commands. The <code class="inline-code">main</code> function ties everything together, managing lifecycle events and readiness.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools with their schemas and streamlines execution pathways.</li>
<li><code class="inline-code">run</code>: Starts the MCP server, initializes communication transports, and preloads repomix content for smoother operation.</li>
<li><code class="inline-code">main</code>: Handles initialization, error management, and graceful shutdown for system continuity.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists all tools from the <code class="inline-code">tools</code> module using <code class="inline-code">zodToJsonSchema</code> to generate detailed schemas for clients.</li>
<li>Validates incoming requests against Zod schemas, ensuring only properly structured data moves forward.</li>
<li>Implements robust error handling with <code class="inline-code">McpError</code> to prevent the system from failing due to edge cases or invalid requests.</li>
<li>Bridges the gap between client requests and server-side tool execution using handler functions.</li>
<li>Highlights the modularity and extendibility of the VirtuScope&#39;s architecture, allowing new tools to be added seamlessly.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes an <code class="inline-code">StdioServerTransport</code> for communication between the VirtuScope&#39;s modules and external interfaces.</li>
<li>Invokes the <code class="inline-code">connect</code> method to establish the server&#39;s readiness to receive commands.</li>
<li>Logs the server state and pre-caches repository content via <code class="inline-code">repoAnalyzer.preGenerate</code>, boosting performance for future requests.</li>
<li>Ensures that the system is operational before processing any incoming client commands or tool requests.</li>
<li>Demonstrates the importance of preloading critical data in enhancing overall mission efficiency.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Creates a new instance of the <code class="inline-code">RepoAdventureServer</code> to start the command interface.</li>
<li>Implements signal listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, calling <code class="inline-code">gracefulShutdown</code> to ensure a safe ship-wide halt.</li>
<li>Catches and logs unhandled promise rejections without forcing the server to terminate, ensuring uninterrupted operations.</li>
<li>Handles catastrophic errors during server startup, logging details and exiting with an appropriate status code.</li>
<li>Balances robustness and flexibility, keeping the VirtuScope operational even during unexpected events.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>If you&#39;re new to dynamic handlers, study the use of <code class="inline-code">zodToJsonSchema</code> for schema generation in <code class="inline-code">setupHandlers</code>.</li>
<li>Investigate the <code class="inline-code">repoAnalyzer.preGenerate</code> call in <code class="inline-code">run</code> for insights into caching optimization.</li>
<li>Pay close attention to how signals and unhandled rejections are managed within <code class="inline-code">main</code> for ideas on resilient system design.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>The starship is now powered up and Command Systems are linked‚Äîstellar work on igniting the cosmic journey forward! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>