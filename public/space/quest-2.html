<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Stellar Narrative Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Adventures: Uncovering the Starship‚Äôs Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Stellar Narrative Engine</h1>
<hr>
<p>The <em>Starship Codexus</em> drifts precariously as it approaches the mysterious Orion Nebula, its core systems faltering in the face of an unknown disruption. The starship‚Äôs computational engine is its lifeblood‚Äîa brilliant fusion of automation and adaptability‚Äîbut now, its interconnected toolset is failing, threatening the crew‚Äôs survival. Your mission: delve deep within the <em>MCP Tool Interface</em> aboard the vessel to restore its functionality. By unraveling the interplay of its handlers and tools, you‚Äôll guide the ship to stability and uncover the origin of the cosmic anomaly.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Calibration</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically configure the MCP tools to respond to system requests?</li>
<li>‚ö° <strong>Server Activation</strong>: What key procedures are executed within the <code class="inline-code">run</code> function to prepare the MCP server for operation, and how does it bridge the underlying systems?</li>
<li>üõ°Ô∏è <strong>Error Containment</strong>: How does the <code class="inline-code">CallToolRequestSchema</code> handler validate inputs and gracefully recover from tool execution errors?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Core MCP Server</h3>
<p>This file defines the core server class (<code class="inline-code">RepoAdventureServer</code>) responsible for managing the starship‚Äôs computational engine through the MCP interface. It implements critical components for tool registration, request handling, and server lifecycle management. The key methods include <code class="inline-code">setupHandlers</code>, which configures dynamic request handling, and <code class="inline-code">run</code>, which activates the server and orchestrates the necessary startup routines.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures handlers for listing and executing interactive tools, ensuring data validation and error handling.</li>
<li><code class="inline-code">run</code>: Starts the server, initializes the transport layer, and prepares the <code class="inline-code">repoAnalyzer</code> for mission execution.</li>
<li><code class="inline-code">main</code>: Orchestrates server creation, lifecycle signals, and recovery from unhandled rejections or critical failures.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Management</h3>
<p>This file defines the interactive tools used by the MCP server to manage and explore the codebase. It features modular tool functions like <code class="inline-code">start_adventure</code> and <code class="inline-code">choose_theme</code>, which collectively create a gamified model for navigating the starship‚Äôs systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates the first phase of tool-based exploration by analyzing code dependencies.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows dynamic selection of narrative elements to personalize the starship‚Äôs mission.</li>
<li><code class="inline-code">explore_quest.handler</code>: Provides tools to navigate specific quests generated by the core engine.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks the ship‚Äôs mission status and system progress.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Configures the MCP tools dynamically via <code class="inline-code">ListToolsRequestSchema</code> and validates input arguments with Zod schemas.</li>
<li>Employs structured error handling using the <code class="inline-code">McpError</code> class to ensure request consistency.</li>
<li>Maps the tools dynamically, enabling modular extensibility and adaptable functionality.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server with <code class="inline-code">StdioServerTransport</code>, connecting it to standard I/O streams for mission control communication.</li>
<li>Pre-generates analysis data for the codebase asynchronously to optimize future operations.</li>
<li>Acts as the pivotal entry point for operational readiness, logging all key processes for mission transparency.</li>
</ul>
<hr>
<pre><code class="language-typescript">function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements lifecycle management by catching system signals and ensuring graceful shutdowns to prevent state corruption.</li>
<li>Catches and logs unhandled promise rejections, providing resilience against unforeseen operational failures.</li>
<li>Serves as the central initialization routine for the MCP server.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Consolidates all MCP tools under a single export object, standardizing registration and usage.</li>
<li>Provides maintainable structure by isolating specific tool logic, improving modularity.</li>
<li>Enhances functionality extensibility, allowing new tools to be seamlessly added.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Observe Patterns</strong>: Pay close attention to how Zod schemas are used for validation. They ensure tool request data integrity within the system.</li>
<li><strong>Connect Processes</strong>: Map the relationships between the handlers in <code class="inline-code">server.ts</code> and the tools in <code class="inline-code">tools.ts</code>.</li>
<li><strong>Simulate Missions</strong>: Experiment with tracing control flow from tool invocation to handler execution to observe system interactions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the <em>Starship Codexus</em>. Thrilling discoveries lie ahead as you navigate its stellar systems.</p>
<p>Quest 2 complete: Stellar Narrative Engine ignited‚Äîa radiant milestone propelling your cosmic odyssey to 20% as you chart a course through the story galaxies with boundless brilliance! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>