<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Starship Operations - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Chronicles: The Codebase Expedition</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Starship Operations</h1>
<hr>
<p>Aboard the Codebreaker, the glowing interface of the MCP command module hums to life. The pulse of the galactic repository‚Äôs technological systems calls out, inviting your crew to unlock its full potential. You are tasked with mastering the operational modules that govern this intricate starship. By exploring the mysteries of handler configuration, dynamic tool execution, and procedural system activation, your mission is vital. Only deep comprehension of these functions can ensure your success in guiding future expeditions beyond the reaches of the known galaxy. Adventure awaits‚Äînavigate the uncharted!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Navigation</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically configure tool handlers, and what makes its schema validation reliable?</li>
<li>‚ö° <strong>Starship Interfaces</strong>: What is the purpose of the <code class="inline-code">run</code> method, and how does it initiate the MCP server&#39;s mission-critical operations?</li>
<li>üõ°Ô∏è <strong>System Integrity</strong>: How do the tools (<code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, etc.) ensure safe execution, and what patterns prevent errors during dynamic tool execution?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Starship Command Module</h3>
<p>In this file, the class <code class="inline-code">RepoAdventureServer</code> encapsulates the initialization and runtime behavior of the MCP server, effectively acting as the starship‚Äôs brain. This module begins by initializing handlers for dynamic tool discovery and execution, then connects to <code class="inline-code">StdioServerTransport</code> for robust communication. Pre-generation of repository content ensures stellar-level readiness by reducing runtime delays. Key focus areas include function-based tool validation and error handling, critical for maintaining starship safety. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists available tools from <code class="inline-code">tools.js</code>, validates input schemas using Zod, and ensures the validity of requests by configuring tool execution handlers.</li>
<li><code class="inline-code">run</code>: Establishes the server transport layer with <code class="inline-code">StdioServerTransport</code> and pre-generates repository content using <code class="inline-code">repoAnalyzer</code>, ensuring operational readiness before command inputs.</li>
<li><code class="inline-code">main</code>: Initializes the server, sets up graceful shutdown mechanisms, and manages unhandled rejections to maintain system integrity during voyages.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a list of tools using <code class="inline-code">zodToJsonSchema</code> for structured input validation.</li>
<li>Configures handlers for both tool listing and execution, ensuring dynamic adaptiveness to available tools.</li>
<li>Implements thorough error handling with custom <code class="inline-code">McpError</code> for clarity and system robustness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the MCP server to its transport layer, enabling command communication streams.</li>
<li>Initiates background tasks for pre-generating repository content, reducing operational latency during real-time requests.</li>
<li>Highlights the importance of preemptive actions in starship readiness.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Serves as the entry point, initializing <code class="inline-code">RepoAdventureServer</code> to begin all operations.</li>
<li>Implements graceful shutdown for system stability using <code class="inline-code">gracefulShutdown</code>.</li>
<li>Logs unhandled promise rejections to ensure visibility of issues without halting the entire system.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Stellar Equipment Repository</h3>
<p>This file defines the available tools for MCP missions. Each tool corresponds to a specific functionality (e.g., <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>), supporting the interactive narrative environment. By exporting these tools dynamically and associating schemas and handlers, the code ensures both modularity and strong input/output validation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and generates the initial setup for an exploratory adventure.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows the user to select a narrative theme, impacting quest generation and story flow.</li>
<li><code class="inline-code">explore_quest.handler</code>: Manages the progression and execution of individual quests.</li>
<li><code class="inline-code">view_progress.handler</code>: Provides insight into the current status of quest completion and all outstanding activities.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports all adventure tools in a centralized object for streamlined access.</li>
<li>Demonstrates modular design philosophy by encapsulating each tool with schemas and handlers.</li>
<li>Simplifies integration with the handler configuration in <code class="inline-code">setupHandlers</code>.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>To explore the full functionality of a tool, trace its handler definitions from this file to their respective modules.</li>
<li>Focus on schema validation mechanisms in <code class="inline-code">setupHandlers</code> for insights into input/output rigor.</li>
<li>Investigate the <code class="inline-code">repoAnalyzer</code> pre-generation process to understand caching benefits in dynamic systems.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, cadet! You&#39;ve successfully mastered MCP Starship Operations and boosted your cosmic command to 20%‚Äîstellar work worthy of a rocket-fueled ‚≠ê leap into the next quest!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>