<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: Activating MCP Systems - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: A Starship's Journey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Activating MCP Systems</h1>
<hr>
<p>The starship <em>Nebula Explorer</em> glides through the software galaxy, its mission echoing across the endless void of stars‚Äîto construct a self-sustaining system capable of generating boundless interactive adventures. Having navigated the outer orbits of system initialization, your next challenge looms: activating the starship‚Äôs MCP (Model Context Protocol) systems. These advanced systems form the lifeblood of your mission, enabling AI-driven storytelling to flourish. To achieve success, work with the MCP server and tool interfaces, meticulously calibrating handlers and operational flow. Brace yourself, for this adventure takes you close to the machine‚Äôs stellar heart.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Protocol Calibration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically register tools for listing and execution? What patterns ensure modularity and extensibility within the server?</li>
<li>‚ö° <strong>Engine Synchronization</strong>: What mechanisms in the <code class="inline-code">run</code> method establish server connections and prepare the system for dynamic content generation?</li>
<li>üõ°Ô∏è <strong>Emergency Protocols</strong>: How does <code class="inline-code">main</code> handle graceful shutdowns, unhandled rejections, and critical failures to ensure system stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Activating the MCP Server</h3>
<p>This file contains the <code class="inline-code">RepoAdventureServer</code> class, which serves as the command center for the MCP system. By setting up dynamic tool handlers and initializing communication channels, it facilitates the transformation of raw code data into interactive storytelling functionality. It also includes a robust flow for handling signals and exceptions, ensuring the system operates smoothly even in adverse conditions. Below are the highlights of the key processes detailed in this file.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically configures tool listing and execution, validating parameters and supporting modular growth of the system.</li>
<li><code class="inline-code">run</code> initializes the MCP server transport connection, pre-gens repomix content, and sets the stage for an interactive session.</li>
<li><code class="inline-code">main</code> oversees server lifecycle management, ensuring graceful shutdowns and capturing operational errors for diagnostics.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists and executes tools using MCP schemas, enabling modular integration of diverse functionalities.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> for schema conversions, ensuring compatibility with JSON Schema standards.</li>
<li>Validates input parameters with Zod schemas for reliability and catches errors for user-friendly diagnostics.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes an MCP server connection via <code class="inline-code">StdioServerTransport</code>, ensuring compatibility with existing communication protocols.</li>
<li>Starts content generation with <code class="inline-code">repoAnalyzer.preGenerate</code> to optimize user experiences and reduce latency during execution.</li>
<li>Outputs diagnostic messages to provide visibility into initialization and pre-generation processes.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initiates the server lifecycle and ensures graceful shutdowns via <code class="inline-code">gracefulShutdown</code> during interruptions like <code class="inline-code">SIGINT</code> or <code class="inline-code">SIGTERM</code>.</li>
<li>Captures <code class="inline-code">unhandledRejection</code> events to log errors while allowing the server to remain operational for non-critical issues.</li>
<li>Incorporates robust error handling to prevent startup failures from cascading into larger system outages.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with the <code class="inline-code">zod</code> schema validation patterns for designing robust data pipelines.</li>
<li>Note how <code class="inline-code">StdioServerTransport</code> simplifies transport-layer communication‚Äîthis is key for system compatibility.</li>
<li>Investigate the <code class="inline-code">gracefulShutdown</code> function to understand lifecycle management techniques.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the software galaxy aboard the <em>Nebula Explorer</em>!</p>
<p>Bravo, cosmic explorer! You‚Äôve ignited the stellar core of Quest 2, propelling your starship to 20% completion‚Äîkeep rocketing toward the stars! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>