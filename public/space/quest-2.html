<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Reactor of HTML Adventures - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Code Voyages: The Quest for Stellar Automation</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Reactor of HTML Adventures</h1>
<hr>
<p>The <em>Galactic Refactorer</em> cruises through the cosmic expanse, navigating bright nebulae and vast code repositories. Your crew‚Äôs scanners detect an unstable reactor within the MCP Tool Interface system. This reactor powers critical builds for interactive storytelling, but inefficiencies threaten its operation. To bring the system to optimal capacity, brave the challenges hidden within the <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code> files. Uncover the mechanics enabling tool integration and execution, ensuring stability for future adventures. The Universal Code Alliance depends on your expertise‚Äîventure forward!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Alignment Probe</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> manage dynamic tool listing and execution within the MCP server?</li>
<li>‚ö° <strong>Core Reactor Flow</strong>: What initialization and system flow processes are implemented in the <code class="inline-code">RepoAdventureServer.run</code> and <code class="inline-code">main</code> functions to ensure smooth operation?</li>
<li>üõ°Ô∏è <strong>Error Convergence Shield</strong>: How does error handling within <code class="inline-code">CallToolRequestSchema</code> safeguard tool execution from invalid parameters or unexpected failures?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Tool Interface Implementation</h3>
<p>This file configures the MCP server and provides handlers for tool integration, showcasing dynamic and extensible server design. It encapsulates the lifecycle management of the repository-based tools and ensures responsive error handling during tool execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically lists tools and validates tools with schemas, integrating them into the server.</li>
<li><code class="inline-code">run</code> initializes the MCP server transport and uses the <code class="inline-code">repoAnalyzer</code> for cache warm-up to optimize performance.</li>
<li><code class="inline-code">main</code> manages high-level orchestration, including lifecycle solutions like graceful shutdown and unhandled error recovery.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Registration System</h3>
<p>This file is the central registry for repository exploration tools. Each tool contributes specialized features for gamified analysis and user engagement with the codebase&#39;s structure. It ensures modularity and manageability in tool development.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initializes an adventure by analyzing a codebase and presenting options.</li>
<li><code class="inline-code">choose_theme.handler</code> generates personalized themes for quests.</li>
<li><code class="inline-code">explore_quest.handler</code> dynamically interacts with specific quests depending on user inputs.</li>
<li><code class="inline-code">view_progress.handler</code> tracks quest completion and status updates, maintaining user engagement.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];

      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(ErrorCode.InternalError, `Tool execution failed: ${error.message}`);
    }
  });
}
</code></pre>
<ul>
<li>Dynamically integrates tools using <code class="inline-code">Objective.entries</code>, ensuring flexibility as new tools are added.</li>
<li>Validates user inputs with Zod schemas, minimizing runtime errors and enforcing predictable behaviors.</li>
<li>Provides robust error handling with custom <code class="inline-code">McpError</code>, protecting critical processes and improving debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Establishes server transport with <code class="inline-code">StdioServerTransport</code>, ensuring smooth communication and input handling.</li>
<li>Initiates cache pre-generation with <code class="inline-code">repoAnalyzer.preGenerate</code>, improving performance during live requests.</li>
<li>Logs meaningful operational messages for monitoring and debugging.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal-based graceful shutdown with <code class="inline-code">process.on</code>, protecting the server during external interruptions.</li>
<li>Logs and isolates unhandled promise rejections, preventing them from interfering with normal operations.</li>
<li>Manages lifecycle orchestration effectively, encapsulating startup and shutdown processes.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports tools with MCP naming conventions, allowing seamless registration in the server interface.</li>
<li>Provides modular structure, promoting reusability across MCP operations.</li>
<li>Centralizes tool registration logic, simplifying future expansions and debugging.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers</code> as a guide to understand how tools interface with the server protocols.</li>
<li>Investigate the <code class="inline-code">tools.ts</code> file to see modular design patterns for scalable tool implementation.</li>
<li>Study error handling mechanisms to identify best practices for custom error definitions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Your starship has just powered up its core with stellar HTML knowledge‚ÄîQuest 2 complete, cosmic coder, onward to the stars at warp speed! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>