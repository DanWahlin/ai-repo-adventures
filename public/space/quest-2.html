<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: MCP Cosmic Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Code Chronicles: The Repository Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Cosmic Interface</h1>
<hr>
<p>As the starship <em>Code Voyager</em> ventures deeper into the dynamic code nebula, its sensors detect a signal from the MCP Tool Interface‚Äîa beacon promising enhanced exploration capabilities. To harness its full potential, the crew must decode and analyze its system architecture, ensuring seamless integration with onboard protocols. Embark on a mission to uncover how the MCP tools enable interstellar code manipulation, preparing <em>Code Voyager</em> for greater intergalactic feats of data processing and story-driven adventures.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Coordination</strong>: How does <code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically manage tool requests and validate parameters?</li>
<li>‚ö° <strong>Server Launch Sequence</strong>: What sequence of operations occurs in <code class="inline-code">RepoAdventureServer.run</code> to initialize the MCP server?</li>
<li>üõ°Ô∏è <strong>Mission Stability Check</strong>: What measures in <code class="inline-code">main</code> handle unanticipated errors, and why are they critical for uninterrupted operation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Setup and Operation</h3>
<p>This file implements the core of the MCP Tool Interface, including dynamic tool management and lifecycle control for the server. It defines the <code class="inline-code">RepoAdventureServer</code> class, which provides essential functions like request handling, tool validation, and background pre-generation processes. It also includes robust mechanisms to handle shutdown and error scenarios for uninterrupted cosmic navigation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This function registers dynamic handlers for listing and executing tools. It validates input schemas using Zod and ensures correct execution of designated tool commands.</li>
<li><code class="inline-code">run</code>: Activates the MCP server via <code class="inline-code">StdioServerTransport</code>, initiates communication, and pre-generates cache content for repository analysis while waiting for input.</li>
<li><code class="inline-code">main</code>: Handles server initialization, signal-based graceful shutdowns (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>), and recovery from unhandled promise rejections, ensuring consistent operation.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This function dynamically maps tools to the MCP server for both listing and execution.</li>
<li>Input schemas are converted using <code class="inline-code">zodToJsonSchema</code>, ensuring accurate validation during runtime.</li>
<li>Error handling with <code class="inline-code">McpError</code> provides rich feedback for invalid tool usage or execution failures.</li>
<li>Validation prevents unexpected inputs from affecting system stability, supporting interstellar precision.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes server transport with <code class="inline-code">StdioServerTransport</code> for reliable, low-latency communication.</li>
<li>Uses <code class="inline-code">repoAnalyzer</code> for pre-generating repository content, boosting responsiveness for incoming user commands.</li>
<li>Integration with <code class="inline-code">process.cwd()</code> ensures compatibility with diverse environments, adapting exploration to the current working directory.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>Implements signal handlers (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for gracefully terminating operations during shutdown.</li>
<li>Logs unhandled promise rejections to aid debugging without jeopardizing ongoing operations.</li>
<li>Ensures quick recovery or termination in critical failure states by catching and reporting errors before exiting.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP Tool Definitions and Integration</h3>
<p>This file provides the tools available to MCP clients, enabling intergalactic code exploration and progress tracking. Tools are designed to be modular, with functions such as <code class="inline-code">start_adventure</code> and <code class="inline-code">explore_quest</code> driving interactive storytelling experiences.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Begins code exploration and analyses the structure to present theme options for users.</li>
<li><code class="inline-code">choose_theme.handler</code>: Accepts user input to select a theme and generates custom quests for an immersive experience.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes individual code exploration quests, each tailored for specific goals.</li>
<li><code class="inline-code">view_progress.handler</code>: Reports completion status and outstanding quests, facilitating mission tracking.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Registers tools with MCP naming conventions for easy integration with the server.</li>
<li>Each tool is independently maintained, ensuring modularity and clear separation of concerns.</li>
<li>Provides functions designed for interactive storytelling, aligning technical exploration with cosmic themes.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as a reference for validating and mapping tools in gamified systems.</li>
<li>Analyze the <code class="inline-code">run</code> method to understand how servers can pre-cache resources for smoother workflows.</li>
<li>Explore error-handling strategies in <code class="inline-code">main</code> to strengthen your applications against unexpected faults.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Star Navigator! üöÄ You&#39;ve successfully calibrated the MCP Cosmic Interface, propelling your starship 20% closer to the galactic horizon‚Äîkeep blazing through the stardust and expanding your universe! ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>