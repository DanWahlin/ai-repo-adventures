<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Charting the Quest Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: Navigating the Nebula of Innovation</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Charting the Quest Engine</h1>
<hr>
<p>In the spiraling arms of the Adventure Codebase Nebula, you prepare to engage the hyperspace scanners to chart the complex circuitry of the Quest Engine. This crucial subsystem governs the fusion of narrative elements, quest exploration routes, and configuration intricacies into the perfect star map for generating interactive adventures. As captain, your assignment is to investigate how these stellar modules communicate and align their orbits.</p>
<p>Your navigational console displays a pulsating energy flux from three key systems: the <code class="inline-code">adventure-manager.ts</code> coordinates module, the <code class="inline-code">story-generator.ts</code> engine core, and the <code class="inline-code">adventure-config.ts</code> configuration rig. Decoding their patterns will help map a seamless quest-generation route through the galaxy of code. Strap in, explorer ‚Äì your journey continues!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Scanner Calibration</strong>: How does the <code class="inline-code">AdventureManager</code> class initialize an adventure and integrate quest data with external configuration files (<code class="inline-code">adventure-manager.ts</code>)?  </li>
<li>‚ö° <strong>Engine Synchronization</strong>: How does the <code class="inline-code">StoryGenerator</code> class manage narrative generation for both stories and quest details (<code class="inline-code">story-generator.ts</code>)?  </li>
<li>üõ°Ô∏è <strong>Configuration Rigging</strong>: How does the <code class="inline-code">loadAdventureConfig</code> function ensure proper access to configuration files and validate their structure (<code class="inline-code">adventure-config.ts</code>)?</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a>: The Navigation Hub</h3>
<p>The <code class="inline-code">adventure-manager.ts</code> file orchestrates adventure initialization and quest execution. As the primary control unit, it retrieves adventure metadata, generates quests, and ensures quests align with configuration limits. This module uses the <code class="inline-code">AdventureState</code> class to store operational state and relies on <code class="inline-code">StoryGenerator</code> to fetch story fragments.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Resets state, sets project context, and generates quests through story fusion.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Combines quest files with dynamically generated configuration data.</li>
<li><code class="inline-code">enforceConfigQuestCount</code>: Trims the number of quests to match constraints defined in <code class="inline-code">adventure.config.json</code>.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  // Reset state for new adventure
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);

  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}
</code></pre>
<ul>
<li>Resets all prior data using <code class="inline-code">AdventureState</code> for a fresh start.</li>
<li>Calls the <code class="inline-code">StoryGenerator</code> to populate storylines and quests based on <code class="inline-code">theme</code> and configuration.</li>
<li>Integrates <code class="inline-code">adventure.config.json</code> data, ensuring the quest list meets file specifications and quantity.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a>: The Engine Core</h3>
<p>This file houses the <code class="inline-code">StoryGenerator</code> class, which transforms a project&#39;s content into thematic stories and interactive quests. It parses adventure themes and coordinates with LLM (large language models) to construct narratives.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Generates a story and quest structure tailored to the chosen theme and project context.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Converts raw markdown responses into highly structured story and quest objects.</li>
<li><code class="inline-code">generateQuestContent</code>: Produces detailed, context-aware quest content for each exploration.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Primary entry point for story generation, validating themes and relaying requests to the LLM.</li>
<li>Encapsulates both metadata handling and theming logic, ensuring consistency.</li>
</ul>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);

  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];

  let currentQuest: Partial&lt;Quest&gt; = {};
  for (const token of tokens) {
    if (token.type === &#39;heading&#39; &amp;&amp; token.depth === 3) {
      if (currentQuest.title &amp;&amp; currentQuest.description) {
        quests.push(createQuest(currentQuest, quests.length));
      }
      currentQuest = { title: token.text, description: &#39;&#39; };
    } else if (token.type === &#39;paragraph&#39; &amp;&amp; currentQuest.title) {
      currentQuest.description += token.text + &#39;\n\n&#39;;
    }
  }
  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push(createQuest(currentQuest, quests.length));
  }

  return { title, story: story.trim(), quests };
}
</code></pre>
<ul>
<li>Uses markdown parsing to efficiently extract quest and story data from an incoming string.</li>
<li>Structures data into reusable objects, providing clarity to downstream operations.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a>: The Configuration Rig</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file handles reading, parsing, and validating the <code class="inline-code">adventure.config.json</code> file. It serves as the backbone for mapping file paths referenced in quests to their existence in the project.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Reads the adventure configuration file as a raw string.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Converts JSON data into an object and validates proper structure.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Maps all <code class="inline-code">path</code> fields within the configuration to actual files in the project.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the configuration file while gracefully handling file absence or permission issues.</li>
</ul>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Centralizes JSON parsing logic for better error management and validation at the entry point.</li>
</ul>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (node?.path &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path.trim()))) {
      unique.add(node.path.trim());
    }
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; stack.push(child));
  }
  return Array.from(unique);
}
</code></pre>
<ul>
<li>Traverses object trees to detect and validate all file paths described in the configuration, giving clarity to file usage.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Remember to trace how <code class="inline-code">initializeAdventure</code> integrates with <code class="inline-code">mergeQuestFilesFromConfig</code>, as this reveals the full mechanics of dynamic quest inclusion.</li>
<li>Pay attention to <code class="inline-code">generateStoryAndQuests</code> for understanding narrative synchronization with codebase content.</li>
<li>When reviewing <code class="inline-code">extractUniqueFilePaths</code>, focus on the depth-first traversal strategy for nested object exploration.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, Star Navigator‚ÄîQuest 3: Charting the Quest Engine is a celestial triumph, propelling your learning voyage to 40% completion as you blaze brighter than the cosmos itself! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>