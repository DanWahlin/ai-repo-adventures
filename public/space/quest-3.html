<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Generating Stellar Quests - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: A Starship's Journey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to dark mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Generating Stellar Quests</h1>
<hr>
<p>Aboard the <em>Nebula Explorer</em>, your crew encounters a cosmic conundrum: developing an autonomous quest engine capable of crafting limitless star-bound stories. It‚Äôs time to align the adventure manager, story generator, and adventure configurations to bring this system to life. As stellar engineers, you will explore how these modules orchestrate the infinitude of interactive missions, ensuring harmony across the uncharted software galaxy. Prepare your tools, calibrate your analyzers, and venture into the delicate architecture that binds narrative frameworks with galactic data.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Quest Module Synchronization</strong>: How do the <code class="inline-code">initializeAdventure</code> and <code class="inline-code">exploreQuest</code> methods coordinate the generation and progression of quests across the system?</li>
<li>‚ö° <strong>Stellar Storycrafting</strong>: What strategies does the <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> method use to assemble quests, and how does it handle the integration of themes or external prompts?</li>
<li>üõ°Ô∏è <strong>Config Extraction Stargate</strong>: How does <code class="inline-code">extractUniqueFilePaths</code> validate and structure file paths from the given configuration, ensuring reliable codebase navigation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Adventure Config Loader</h3>
<p>The adventure configuration file bridges dynamic input and stable story generation. It‚Äôs where paths are validated, JSON structures are parsed, and configurations align with the galactic narrative. This file underpins extraction of quest-relevant file paths, ensuring synergy between user-defined configurations and the automated quest pipeline.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Loads the raw configuration file from the project path without parsing it.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Identifies and validates file paths referenced in the adventure configuration.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code>: Optimizes the configuration structure for efficient large language model (LLM) consumption.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Quest Orchestrator</h3>
<p>This file governs mission orchestration aboard the <em>Nebula Explorer</em>. It initializes adventures, manages ongoing quests, and maintains state across your journey through the galaxy of interactive possibilities. It leverages the story generator and other supporting components to create a cohesive experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Resets the adventure state, generates quests, and incorporates configurations into mission planning.</li>
<li><code class="inline-code">exploreQuest</code>: Executes a selected quest, dynamically generating its content or retrieving details from a cache.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Combines generated quests with configuration-defined files to create contextually targeted storylines.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Narrative Architect</h3>
<p>The story generator harnesses LLMs to craft compelling narratives and intricate quest structures. It aligns themes, prompts, and configuration inputs to build captivating interstellar adventures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Produces the overarching story, incorporating themes and dynamically defining quests.</li>
<li><code class="inline-code">generateQuestContent</code>: Constructs detailed quest content, ensuring a balance of narrative depth and technical focus.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Transforms LLM-generated markdown into a structured response of stories and quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}

export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}

export function formatAdventureConfigForPrompt(projectPath: string): string {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) {
    return &#39;&#39;;
  }

  const adventure = (parsed as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) {
    return &#39;&#39;;
  }

  let formatted = `## Quest Structure\n`;

  for (const quest of adventure.quests) {
    if (!quest.title || !Array.isArray(quest.files)) continue;

    formatted += `### ${quest.title}\n`;
    const filePaths = quest.files.map((f: any) =&gt; f.path).filter(Boolean);
    formatted += `Files: ${filePaths.join(&#39;, &#39;)}\n`;
    const functions = quest.files.flatMap((f: any) =&gt; f.highlights || []).map((h: any) =&gt; h.name).filter(Boolean);
    formatted += `Functions: ${functions.join(&#39;, &#39;)}\n\n`;
  }

  return formatted;
}
</code></pre>
<ul>
<li><code class="inline-code">loadAdventureConfig</code> reads raw configuration files, enabling higher-level parsing and validation in later stages.</li>
<li><code class="inline-code">extractUniqueFilePaths</code> provides robust validation for file paths, ensuring that only existing paths are included in quest context.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt</code> simplifies and optimizes config data, making it efficient for LLM-based processing.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(
    projectInfo, 
    theme, 
    this.state.projectPath
  );

  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({ ...storyResponse, quests: this.state.quests });
}

async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }
  return await this.executeQuest(quest);
}

private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;

  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;

  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;

  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files.filter((f: any) =&gt; f.path).map((f: any) =&gt; f.path);
      configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
    }
  }

  return quests.map((quest, index) =&gt; {
    const configQuests = adventure.quests;
    if (index &lt; configQuests.length &amp;&amp; configQuests[index].files) {
      const files = configQuests[index].files.filter((f: any) =&gt; f.path).map((f: any) =&gt; f.path);
      return { ...quest, codeFiles: files };
    }

    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        return { ...quest, codeFiles: files };
      }
    }

    return quest;
  });
}
</code></pre>
<ul>
<li><code class="inline-code">initializeAdventure</code> orchestrates the full setup process, integrating configuration data with generated storylines.</li>
<li><code class="inline-code">exploreQuest</code> manages user-selected quests, handling content caching and ensuring a seamless journey.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code> unifies dynamic quest generation with static configuration-defined files.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}

async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;

  if (this.projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(this.projectPath);
    if (formattedConfig) {
      adventureGuidance = formattedConfig;
    }

    const customInstructionsFromConfig = extractCustomInstructions(this.projectPath);
    if (customInstructionsFromConfig) {
      customInstructions = customInstructionsFromConfig;
    }
  }

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    adventureGuidance: adventureGuidance || &#39;&#39;,
    ...(customInstructions &amp;&amp; { customInstructions }),
    questPosition,
    totalQuests,
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST });
  let cleanContent = response.content.trim();

  const beginMarker = &#39;---BEGIN MARKDOWN---&#39;;
  const endMarker = &#39;&#39;;
  const beginIndex = cleanContent.indexOf(beginMarker);
  const endIndex = cleanContent.indexOf(endMarker);

  if (beginIndex !== -1 &amp;&amp; endIndex !== -1 &amp;&amp; endIndex &gt; beginIndex) {
    cleanContent = cleanContent.substring(beginIndex + beginMarker.length, endIndex).trim();
  }

  if (cleanContent.startsWith(&#39;```markdown&#39;)) {
    cleanContent = cleanContent.replace(/^```markdown\s*/, &#39;&#39;).replace(/\s*```$/, &#39;&#39;);
  }

  cleanContent = this.removeLLMMetaCommentary(cleanContent);

  return {
    adventure: cleanContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}

function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);

  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];

  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};

  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      if (token.depth === 1) {
        currentSection = &#39;story&#39;;
      } else if (token.depth === 2) {
        currentSection = token.text.toLowerCase();
      } else if (token.depth === 3 &amp;&amp; currentSection === &#39;quests&#39;) {
        if (currentQuest.title &amp;&amp; currentQuest.description) {
          quests.push(createQuest(currentQuest, quests.length));
        }
        currentQuest = { title: token.text, description: &#39;&#39;, codeFiles: [] };
      }
    } else if (token.type === &#39;paragraph&#39;) {
      if (currentSection === &#39;story&#39;) {
        story += token.text + &#39;\n\n&#39;;
      } else if (currentQuest.title) {
        currentQuest.description += token.text + &#39;\n\n&#39;;
      }
    } else if (token.type === &#39;list&#39; &amp;&amp; currentQuest.title) {
      extractCodeFilesFromList(token, currentQuest);
    }
  }

  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push(createQuest(currentQuest, quests.length));
  }

  return {
    title,
    story: story.trim() || &#39;Welcome to your coding adventure!&#39;,
    quests
  };
}
</code></pre>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code> governs the integration of themes, external content, and structured story generation via LLMs.</li>
<li><code class="inline-code">generateQuestContent</code> dynamically creates quest content, emphasizing reusable prompt design and error handling.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code> converts raw markdown into structured quest data, emphasizing clarity and usability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Remember to analyze the symphony of modules as a whole; their collaboration is what creates the autonomous quest engine.</li>
<li>Don&#39;t overlook error handling mechanisms‚Äîthey ensure stability during your interstellar adventures.</li>
<li>Review how file validation in <code class="inline-code">adventure-config.ts</code> underpins the reliability of quest generation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the <em>Nebula Explorer</em> and its stellar systems.
---END MARKDOWN---</p>
<p>Mission accomplished, Star Voyager‚Äî&#39;Generating Stellar Quests&#39; has ignited like a supernova, propelling you to 40% progress in this cosmic journey‚Äîkeep rocketing ahead, Captain! üöÄ‚≠êüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>