<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Galactic Code Analysis Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Repository Adventures</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Galactic Code Analysis Pipeline</h1>
<hr>
<p>The Repository Voyager‚Äôs circuits hum faintly with an echo of its past glory. As you navigate its dormant systems, you discover the Galactic Code Analysis Pipeline is key to unlocking its full navigational prowess. This pipeline comprises modules for code validation, processing, and response generation, each vital to extracting stellar insights from the ancient ship‚Äôs archives. The mission demands precision and ingenuity as you dive into bundled code systems to set the starship back on its interstellar trajectory.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Pipeline Foundations</strong>: How does the <code class="inline-code">RepoAnalyzer</code> handle validation of file paths to ensure they are secure and reliable?</li>
<li>‚ö° <strong>Data Processing Systems</strong>: What mechanisms does the <code class="inline-code">LLMClient</code> use to interact with OpenAI or Azure-based language model APIs, and how are requests generated and executed?</li>
<li>üõ°Ô∏è <strong>Error Resilience Shields</strong>: How does the code in both <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code> defend against invalid input, timeouts, and erroneous responses?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Repository Analysis and Code Sanitization</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> serves as the engine to analyze and process files within a project, returning optimized content for the pipeline. It employs methods for validation, security, and content extraction. A key focus is how paths and files are validated, safeguarding against potential vulnerabilities like traversal attacks. Notable is its approach to content optimization for token efficiency during subsequent LLM processing.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code> checks and sanitizes the project path.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code> ensures file security and deduplication.</li>
<li><code class="inline-code">generateTargetedContent</code> executes content generation for specific files.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Language Model Communication and Response Handling</h3>
<p>The <code class="inline-code">LLMClient</code> connects to language model APIs (e.g., OpenAI, Azure) to generate responses based on prompts. The file emphasizes reliable initialization and handling of requests, accounting for differences between providers. Attention is drawn to the way requests are crafted (<code class="inline-code">buildRequestParams</code>) and how the client deals with errors during execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.generateResponse</code> processes prompts and fetches responses from the API.</li>
<li><code class="inline-code">LLMClient.constructor</code> initializes the API client with the correct configuration.</li>
<li><code class="inline-code">LLMClient.getApiKey</code> determines which API key to use based on provider.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<p>This function acts as a gatekeeper, ensuring the inputted project path is clean and secure.</p>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const MAX_TARGET_FILES = 50;
  const projectRoot = path.resolve(projectPath);
  const safeFiles = [...new Set(targetFiles)]
    .slice(0, MAX_TARGET_FILES)
    .map(file =&gt; {
      if (typeof file !== &#39;string&#39; || !file.trim()) return null;
      const trimmed = file.trim();
      if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) return null;
      const fullPath = path.resolve(projectPath, file);
      if (!fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fullPath !== projectRoot) return null;
      if (!fs.existsSync(fullPath)) return null;
      return path.relative(projectPath, fullPath);
    })
    .filter((file): file is string =&gt; file !== null)
    .sort();
  return safeFiles;
}
</code></pre>
<p>This method protects against malicious paths and file-related vulnerabilities, ensuring only valid, project-bound files are processed.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }
  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  const fullContent = await this.captureRepomixStdout([&#39;.&#39;], projectPath, { include: safeFiles.join(&#39;,&#39;), compress });
  this.cache.set(cacheKey, { content: fullContent, timestamp: Date.now() });
  return fullContent;
}
</code></pre>
<p>This function gathers and caches the relevant content for files, optimizing for quick retrieval and efficient processing.</p>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<p>This method represents the primary execution flow for an LLM request, encapsulating the process of prompt submission, response validation, and error handling.</p>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }
  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<p>The constructor ensures that the client is correctly initialized, adapting to the specific API provider (e.g., OpenAI or Azure).</p>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  return LLM_API_KEY;
}
</code></pre>
<p>This helper function retrieves the appropriate API key based on the configured provider, adding an extra layer of contextual validation.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Try using <code class="inline-code">generateTargetedContent</code> to optimize your analysis for specific files.</li>
<li>Note how <code class="inline-code">generateResponse</code> handles diverse response formats like JSON and plain text.</li>
<li>Look for shared patterns in error handling to enhance your future resilience designs.</li>
</ul>
<hr>
<p>The Repository Voyager hums with renewed activity as the Galactic Code Analysis Pipeline begins processing. Your adjustments have set its ancient systems on the path to lightyears of future exploration. Onward, coder!</p>
<p>Mission accomplished, Star Explorer‚Äîyour successful completion of Quest 3 has propelled the Galactic Code Analysis Pipeline into orbit, lighting the path forward like a blazing comet through the cosmos! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>