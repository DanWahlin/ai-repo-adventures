<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Interstellar Quest Core - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Code Chronicles: A stellar voyage into exploration systems</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Interstellar Quest Core</h1>
<hr>
<p>As the starship‚Äôs engines hum steadily, the Interstellar Quest Core beckons you to uncover its secrets. Your mission is to decode the intricate mechanisms powering the galaxy&#39;s premier adventure system. Navigate through constellations of explanatory scripts and orbit the stellar fields of configuration logic. Every method in the system pulsates like a star, ready for you to calibrate and investigate. The Quest Core holds the key to crafting the dazzling narratives that guide astronauts across the cosmos. Brave explorer, the adventure system awaits your investigation ‚Äì the universe depends on your ingenuity!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Config Loader Scan</strong>: How does the <code class="inline-code">loadAdventureConfig</code> function retrieve configuration files, and what happens when they cannot be found?</li>
<li>‚ö° <strong>Quest Initialization Orbit</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> assemble quests and ensure consistency across themes and configurations?</li>
<li>üõ°Ô∏è <strong>Story Synthesis Shielding</strong>: What validation steps does <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> use to ensure the generated story and quests are structured properly?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Configuration Management</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file handles critical operations for loading, parsing, and transforming the adventure configuration. It reads raw configuration data from the project&#39;s filesystem, interprets JSON content, and extracts actionable paths or metadata used throughout the quest generation pipeline.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Reads the raw configuration file and returns its content as a string, handling file read errors gracefully.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Parses the raw configuration file into a JSON object while handling invalid JSON formats.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Traverses the configuration data to collect unique file paths, verifying their existence before adding them.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>This function constructs the configuration file‚Äôs path relative to the project directory.</li>
<li>Uses <code class="inline-code">readFileIfExists</code> to handle missing or unreadable files without crashing the application.</li>
<li>Keeps the operation lightweight by focusing solely on file retrieval, leaving parsing to other functions.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Provides a safe JSON parsing mechanism for the configuration content.</li>
<li>Protects the system from malformed files by returning <code class="inline-code">null</code> when errors occur.</li>
<li>Delegates file reading to <code class="inline-code">loadAdventureConfig</code>, maintaining separation of concerns.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    // Extract and validate path
    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    // Parse recursively
    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Recursively processes the parsed configuration object to locate all <code class="inline-code">path</code> fields.</li>
<li>Verifies each path&#39;s existence on the filesystem before including it in the results.</li>
<li>Uses a stack-based recursion pattern to handle deeply nested configuration files.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Core Quest Orchestration</h3>
<p>The <code class="inline-code">adventure-manager.ts</code> file embodies the orchestration layer for quest initialization and execution. It combines project metadata, user preferences, and configuration data to construct a coherent adventure for participants.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">AdventureManager.initializeAdventure</code>: Coordinates the initialization of the adventure, including story generation and configuration enforcement.</li>
<li><code class="inline-code">AdventureState.progressPercentage</code>: Computes the percentage of completed quests to track exploration progress.</li>
<li><code class="inline-code">AdventureManager.enforceConfigQuestCount</code>: Ensures the number of generated quests adheres to the constraints specified in the configuration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the adventure state to ensure a clean slate for initialization.</li>
<li>Uses <code class="inline-code">generateStoryAndQuests</code> to dynamically synthesize a story and questline based on project-specific data.</li>
<li>Enforces rules from configuration files to ensure alignment between procedurally generated content and predefined constraints.</li>
</ul>
<hr>
<pre><code class="language-typescript">get progressPercentage(): number {
  return this.quests.length &gt; 0 
    ? Math.round((this.completedQuests.size / this.quests.length) * 100)
    : 0;
}
</code></pre>
<ul>
<li>Maintains a simple but vital indicator of exploration progress for the user.</li>
<li>Normalizes the calculation of the percentage to handle edge cases like zero quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">private enforceConfigQuestCount(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;
  
  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;
  
  const configQuestCount = adventure.quests.length;
  return quests.length &gt; configQuestCount ? quests.slice(0, configQuestCount) : quests;
}
</code></pre>
<ul>
<li>Ensures compliance with configuration-imposed limits on the number of quests.</li>
<li>Applies truncation logic to match or reduce the quest count based on the configuration file, ensuring consistency in user experiences.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Procedural Story Crafting</h3>
<p>The <code class="inline-code">story-generator.ts</code> file leverages LLM-based inference to craft compelling adventure stories. It parses markdown responses, validates structured data, and synthesizes thematic content.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Centralizes the generation of a story and its associated questline with safety checks for malformed input.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Converts markdown content to structured <code class="inline-code">StoryResponse</code> objects by analyzing headings and body text.</li>
<li><code class="inline-code">generateCompletionSummary</code>: Synthesizes themed summaries upon quest completion, dynamically reflecting the user‚Äôs progress.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  const repomixContent = projectInfo.repomixContent || &#39;No repomix content available&#39;;
  let adventureGuidance = &#39;&#39;;
  let customInstructions = &#39;&#39;;

  if (projectPath) {
    const formattedConfig = formatAdventureConfigForPrompt(projectPath);
    if (formattedConfig) adventureGuidance = formattedConfig;

    const customInstructionsFromConfig = extractCustomInstructions(projectPath);
    if (customInstructionsFromConfig) customInstructions = customInstructionsFromConfig;
  }

  const prompt = loadStoryGenerationPrompt({
    theme,
    repomixContent,
    ...(adventureGuidance &amp;&amp; { adventureGuidance }),
    ...(customInstructions &amp;&amp; { customInstructions }),
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_STORY });

  if (!response.content || response.content.trim() === &#39;&#39;) {
    throw new Error(&#39;LLM returned empty response&#39;);
  }

  let parsed = parseMarkdownToStoryResponse(response.content.trim());
  StoryResponseSchema.parse(parsed);

  this.currentStoryContent = parsed.story;
  return parsed;
}
</code></pre>
<ul>
<li>Constructs prompts using contextual information like repository analysis and configuration files.</li>
<li>Performs thorough validation of generated responses to guard against inconsistent quest structures.</li>
<li>Balances dynamic generation with a fallback mechanism for unreadable or invalid content.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">extractUniqueFilePaths</code> as an entry point to analyze project dependencies.</li>
<li>Observe how <code class="inline-code">enforceConfigQuestCount</code> transforms the quest list and ensures alignment with constraints.</li>
<li>Experiment with modifying <code class="inline-code">generateStoryAndQuests</code> to test the impact of theme-specific prompts.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries in the cosmic codebase.</p>
<p>Mission accomplished, Star Navigator: you‚Äôve propelled through the cosmic core of Quest 3 like a blazing comet, marking 40% completion with stellar precision‚Äîonward to the next galaxy! ‚≠êüöÄ‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>