<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Cartography of the Cosmic Repository - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codex: Chronicles of the Stellar Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Cartography of the Cosmic Repository</h1>
<hr>
<p>The Stellar Repository stretches before you, a cryptic labyrinth of networks and pathways suspended in the void of a far-off nebula. Your crew aboard the starship <em>Codemancer</em> must harness advanced analytics and decoding methods to chart its enigmatic corridors. The Repository&#39;s vast stores of galactic knowledge are encrypted behind intricate layers of dimensional gates, demanding precision in data extraction and algorithmic navigation. Failure could lead to corrupted maps or even the permanent loss of its celestial secrets. Are you ready to decode the Repository&#39;s map?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Navigation Schematics</strong>: How does <code class="inline-code">RepoAnalyzer</code> ensure secure and optimized processing of target files before generating content?</li>
<li>‚ö° <strong>Signal Coordination</strong>: What mechanisms does <code class="inline-code">LLMClient</code> use to adapt its request parameters based on the model type, and why does this matter for GPT-5 optimization?</li>
<li>üõ°Ô∏è <strong>Orbital Fail-Safes</strong>: How are errors detected, logged, and addressed to handle incomplete or broken pathways in both tools?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Generating and Validating Stellar Responses</h3>
<p>This file defines the <code class="inline-code">LLMClient</code> class, responsible for communicating with advanced language models like GPT-5 and Azure OpenAI. The <code class="inline-code">generateResponse</code> method facilitates querying these models while adapting to their specific requirements. Critical components, such as <code class="inline-code">buildRequestParams</code> and <code class="inline-code">validateResponse</code>, enforce flexibility and robustness, ensuring the models interact seamlessly across varied scenarios. Logging mechanisms are in place to monitor inputs, outputs, and resource usage.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLMClient.constructor</code>: Configures the client by detecting whether to use OpenAI, Azure OpenAI, or GitHub models, ensuring proper validation of API keys and base URLs.</li>
<li><code class="inline-code">generateResponse</code>: Handles LLM queries, including error management, post-response cleanup, and token usage logging.</li>
<li><code class="inline-code">buildRequestParams</code>: Constructs tailored request parameters, accommodating specific model behaviors like GPT-5‚Äôs verbosity settings.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  
  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({ endpoint: azureEndpoint, apiKey, apiVersion: LLM_API_VERSION, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>This constructor initializes <code class="inline-code">LLMClient</code>, detecting whether to use OpenAI or Azure, enforcing strict validation of environment variables to prevent misconfiguration.</li>
<li>Highlights model-specific setups like Azure OpenAI&#39;s APIs versus OpenAI&#39;s standard ones.</li>
<li>Demonstrates modular design allowing for seamless adaptation between providers.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);
    
    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);
    
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
  }
}
</code></pre>
<ul>
<li>This method drives the core interaction with language models, forming the bedrock of intelligent responses.</li>
<li>Error handling provides detailed debugging to prevent workflow stalling.</li>
<li>Token logging ensures operation costs remain in check and aids optimization during response scenarios.</li>
</ul>
<hr>
<pre><code class="language-typescript">private buildRequestParams(prompt: string, options?: LLMRequestOptions): OpenAIRequestParams {
  const requestParams: OpenAIRequestParams = { model: this.model, messages: [{ role: &#39;user&#39;, content: prompt }] };

  if (this.isGPT5Model()) {
    requestParams.temperature = 1;
    requestParams.max_completion_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.verbosity = options?.verbosity || GPT5_VERBOSITY;
    requestParams.reasoning_effort = options?.reasoningEffort || GPT5_REASONING_EFFORT;
  } else {
    requestParams.temperature = LLM_TEMPERATURE;
    requestParams.max_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
  }

  return requestParams;
}
</code></pre>
<ul>
<li>Demonstrates how request parameters adapt to model-specific features like GPT-5‚Äôs verbosity and reasoning effort.</li>
<li>Enables an efficient and precise fulfillment of input-output requirements for different AI systems.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Extracting Galactic Patterns</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class focuses on extracting and optimizing targeted content from a codebase using <code class="inline-code">repomix</code>. This involves complex file validation, cache management, and execution of external commands. Methods like <code class="inline-code">validateAndNormalizeTargetFiles</code> ensure safe and secure processing, while <code class="inline-code">generateOptimizedContent</code> applies function-level extraction for token efficiency.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Collects compressed or full codebase context, pre-validating configurations and adjusting options.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Runs <code class="inline-code">repomix</code> subprocesses for file analysis, mitigating memory overflow and timeouts.</li>
<li><code class="inline-code">validateProjectPath</code>: Prevents invalid, non-string, or malicious project paths to ensure secure access.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  const configuredFiles = extractUniqueFilePaths(projectPath);

  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  }

  return await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
    style: options.style || &#39;markdown&#39;,
    compress: options.compress !== false,
    ignore: defaultIgnorePatterns,
    removeComments: true,
    removeEmptyLines: true,
    noDirectoryStructure: true,
  });
}
</code></pre>
<ul>
<li>Collects the codebase context, balancing optimization with fallback strategies for broader compatibility.</li>
<li>Shows integration with external tools (<code class="inline-code">repomix</code>) and how configuration inputs refine the analysis.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

  let stdout = &#39;&#39;, stderr = &#39;&#39;, stdoutSize = 0;
  const timeout = setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_SUBPROCESS_TIMEOUT);

  repomix.stdout.on(&#39;data&#39;, data =&gt; {
    stdoutSize += data.toString().length;
    if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) throw new Error(&#39;Overflow&#39;);
    stdout += data.toString();
  });

  // Close repomix on done/error
  return new Promise((resolve, reject) =&gt; repomix.on(&#39;close&#39;, code =&gt; resolve(stdout)));
}
</code></pre>
<ul>
<li>Engages in external command execution with managed risks like timeouts and memory constraints to ensure reliable operation in resource-intensive contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39; || projectPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Invalid project path&#39;);
  }
}
</code></pre>
<ul>
<li>Guarantees safety by validating inputs to remove injection risks or malformed paths, preventing accidental access to unintended locations.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Always align model-specific configurations with their documentation to maximize compatibility.</li>
<li>For secure workflows, validate all inputs to remove anomalies and edge-case attacks.</li>
<li>Efficient error handling reduces debugging cycles and improves resource allocation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Stellar Repository.</p>
<p>Congratulations, Cosmic Cartographer‚Äîyour interstellar mission has mapped the celestial pathways of the Cosmic Repository with brilliance, propelling the crew toward the stars at warp speed üöÄ‚≠êüó∫Ô∏è!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>