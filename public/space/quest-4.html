<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Nebula Configuration and Theme Mapping - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Adventures: Uncovering the Starship‚Äôs Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Nebula Configuration and Theme Mapping</h1>
<hr>
<p>As the <em>Starship Codexus</em> ventures deeper into the Orion Nebula‚Äôs uncharted sector, the ship‚Äôs celestial navigation and configuration systems start to misalign, threatening the entire voyage. The ship‚Äôs Theme Mapping directive, an essential subsystem that generates visual aids for stellar themes, holds the key to restoring navigational harmony. Your mission is to analyze and optimize its interplay with the code analysis and content pipeline systems. This quest will thrust you into the cosmic depths of system integration, where every function illuminates the stellar pathways that guide the crew home.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Nebula Mapping Logic</strong>: How does <code class="inline-code">RepoAnalyzer.generateRepomixContext</code> orchestrate the processing of multiple files into a cohesive content map for the nebula navigation system?</li>
<li>‚ö° <strong>Stellar Insights Extraction</strong>: What role does <code class="inline-code">RepoAnalyzer.extractFunctionFocusedContent</code> play in refining cosmic data for theme mapping?</li>
<li>üõ°Ô∏è <strong>Orbital Safety Protocols</strong>: How does <code class="inline-code">LLMClient.validateResponse</code> ensure data integrity and prevent errors when working with theme-related prompts?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Code Analysis &amp; Content Optimization</h3>
<p>This file is responsible for extracting and optimizing key data points from the starship&#39;s codebase, enabling smooth integration with the nebula theme mapping systems. It ensures efficient extraction of relevant functions and patterns from various files for mission-critical operations like theme generation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: This function gathers and processes file context from the project directory to ensure the engine has accurate and optimized data. It prioritizes adventure-related files outlined in configuration files.</li>
<li><code class="inline-code">extractFunctionFocusedContent</code>: Responsible for reducing token usage during code analysis by identifying critical functions and filtering irrelevant details. It plays a crucial role in system optimization for large nebula calibrations.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code>: Ensures safe and reliable access to target files, preventing path traversal issues or invalid inputs that could derail the nebula mapping system.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Theme Prompt Validation and Response Handling</h3>
<p>This file handles interactions with external language models, ensuring data integrity and reliability when generating cosmic responses for the starship‚Äôs theme mapping system. Its robust validation mechanisms safeguard against malformed or incomplete responses.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Generates LLM responses from prompts and validates the output, ensuring thematic consistency and data quality for nebula visuals.</li>
<li><code class="inline-code">validateResponse</code>: Verifies the integrity and completeness of LLM responses, ensuring no critical information is lost when generating stellar themes.</li>
<li><code class="inline-code">logTokenUsage</code>: Provides insights into token consumption during LLM interactions, ensuring navigational resource limits are respected while processing large sets of cosmic data.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    console.log(`Using adventure.config.json: analyzing ${configuredFiles.length} configured files with optimization`);
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Failed to generate optimized content, falling back to targeted content: ${error instanceof Error ? error.message : String(error)}`);
      try {
        return await this.generateTargetedContent(projectPath, configuredFiles);
      } catch (fallbackError) {
        console.warn(`Failed to generate targeted content, falling back to full repomix content: ${fallbackError instanceof Error ? fallbackError.message : String(fallbackError)}`);
      }
    }
  }
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;];
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;),
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true
    };
    
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Constructs a unified content map for nebula navigation by gathering project files and optimizing their structure.</li>
<li>Error handling and fallback strategies ensure reliable processing even during unforeseen failures.</li>
</ul>
<hr>
<pre><code class="language-typescript">private extractFunctionFocusedContent(fullContent: string): string {
  const lines = fullContent.split(&#39;\n&#39;);
  const optimizedLines: string[] = [];
  let currentFile = &#39;&#39;;
  let inCodeBlock = false;
  let currentCodeBlock: string[] = [];
  let skipFile = false;

  for (let line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine.startsWith(&#39;## File:&#39;)) {
      currentFile = trimmedLine.replace(/^##?\s*File:\s*/, &#39;&#39;);
      skipFile = this.shouldSkipFile(currentFile);
      if (!skipFile) optimizedLines.push(line);
      continue;
    }
    if (skipFile) continue;
    
    if (trimmedLine.startsWith(&#39;```&#39;)) {
      if (!inCodeBlock) {
        inCodeBlock = true;
        currentCodeBlock = [line];
      } else {
        inCodeBlock = false;
        currentCodeBlock.push(line);
        optimizedLines.push(...currentCodeBlock);
        currentCodeBlock = [];
      }
      continue;
    }
    if (inCodeBlock) {
      currentCodeBlock.push(line);
      continue;
    }
    optimizedLines.push(line);
  }
  return optimizedLines.join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Extracts essential functions and patterns used for theme calibration.</li>
<li>Minimizes token usage by filtering out unused content, ensuring efficient performance in complex nebular contexts.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
  const projectRoot = path.resolve(projectPath);
  const safeFiles = [...new Set(targetFiles)].map(file =&gt; {
    const trimmed = file.trim();
    const fullPath = path.resolve(projectPath, file);
    if (fullPath.startsWith(projectRoot + path.sep) &amp;&amp; fs.existsSync(fullPath)) {
      return path.relative(projectPath, fullPath);
    }
    return null;
  }).filter((file): file is string =&gt; file !== null).sort();
  return safeFiles;
}
</code></pre>
<ul>
<li>Validates file paths for safety, ensuring they reside within the project directory.</li>
<li>Deduplicates entries and prevents errors caused by nonexistent or unsafe files.</li>
</ul>
<hr>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);
    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
  }
}
</code></pre>
<ul>
<li>Generates thematic data by interfacing with LLMs and validating responses for navigational accuracy.</li>
<li>Ensures prompt tuning and response parsing align with nebula mapping requirements.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateResponse(completion: any): string {
  const choice = completion.choices[0];
  const content = choice?.message?.content;
  if (!choice || !content) {
    throw new Error(&#39;LLM responded with empty or invalid data.&#39;);
  }
  return content;
}
</code></pre>
<ul>
<li>Validates LLM responses to ensure integral data is used for stellar theme mapping.</li>
<li>Prevents errors caused by incomplete or invalid responses.</li>
</ul>
<hr>
<pre><code class="language-typescript">private logTokenUsage(completion: any): void {
  const promptTokens = completion.usage.prompt_tokens || 0;
  const completionTokens = completion.usage.completion_tokens || 0;
  const totalTokens = completion.usage.total_tokens || 0;
  console.error(`LLM Usage: ${formatTokenCount(promptTokens)} prompt + ${formatTokenCount(completionTokens)} response = ${formatTokenCount(totalTokens)} total tokens`);
}
</code></pre>
<ul>
<li>Logs token usage, providing insight into resource allocation for large data processing.</li>
<li>Helps optimize responses in scenarios with strict token constraints, such as nebula mapping.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">validateProjectPath</code> to ensure safe operations within nebula configurations.</li>
<li>Analyze <code class="inline-code">extractFunctionFocusedContent</code> to see patterns for optimizing theme generation data.</li>
<li>Review <code class="inline-code">validateResponse</code> to safeguard against invalid or truncated responses.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the <em>Starship Codexus</em> and its stellar systems.</p>
<p>Congratulations, cosmic navigator! With Quest 4 complete, your expert Nebula Configuration and Theme Mapping skills have propelled this mission 60% closer to stellar success‚Äîonward to the next starry frontier! üöÄ‚ú®üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>