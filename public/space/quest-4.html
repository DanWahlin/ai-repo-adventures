<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Code Nebula Mapping - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Chronicles: The AI Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Nebula Mapping</h1>
<hr>
<p>As the captain of the <em>Cerebral Voyager</em>, your mission enters a turning point. A cryptic corner of the infinite code nebula whispers hints of unfathomable galactic knowledge. To chart this elusive frontier, you must depend on advanced capabilities: a dual partnership between the stellar analyzer and the onboard AI. With pulsars pressing against your navigation circuits, the analyzer extracts optimized code fragments while the AI deciphers alien constructs and unfurls patterns hidden in the cosmic chaos. Can your starship stabilize the nebula&#39;s complexity and relay its secrets‚Äîor will you be dashed against the stars?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Nebula Scanner Alignment</strong>: How does <code class="inline-code">RepoAnalyzer.validateProjectPath</code> ensure the galactic coordinates (file paths) are safe and secure for exploration?</li>
<li>‚ö° <strong>AI Conversation Protocol</strong>: What mechanisms within <code class="inline-code">LLMClient.generateResponse</code> unify token usage, content validation, and cosmic-scale request handling?</li>
<li>üõ°Ô∏è <strong>Code Safety Shields</strong>: How does <code class="inline-code">RepoAnalyzer.captureRepomixStdout</code> protect against nebulous subprocess timeouts and memory overflows?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> AI Nebula Decipherer</h3>
<p>The <code class="inline-code">LLMClient</code> module serves as the interstellar AI bridge for generating responses based on your cosmic data probes. This file is vital in orchestrating secure communication protocols with large language models, including OpenAI and Azure OpenAI, by navigating response formats, error handling, and integration settings.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Initiates LLM requests to decode galactic signals, including input validation, response processing, and post-deciphering formatting.</li>
<li><code class="inline-code">constructor</code>: Configures the client for seamless interaction with multiple LLM providers, including OpenAI and Azure AI, based on dynamic environment settings.</li>
<li><code class="inline-code">getApiKey</code>: Retrieves the correct key for secure communication with the configured nebula AI provider.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Code Nebula Mapping Core</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> module propels the mission forward by extracting optimized data from specified files. Acting as the ship&#39;s scanner, it validates paths, generates contextual outputs, and ensures reliable operations even under cosmic stress. This toolkit anchors the harmony between efficient exploration and safe navigation.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Protects the starship by validating the stability of file paths, ensuring cosmic coordinates are aligned and secure for scanning.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes subprocess calls with enhanced safety features such as timeout mechanisms and memory caps for maintaining system integrity during long cosmic analyses.</li>
<li><code class="inline-code">generateTargetedContent</code>: Extracts galactic content optimized for token efficiency, preserving critical functions and configurations from files essential to the mission.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
      const requestParams = this.buildRequestParams(prompt, options);
      const completion = await this.executeRequest(requestParams);
      let content = this.validateResponse(completion);
      
      if (options?.responseFormat === &#39;json_object&#39;) {
        content = this.cleanJsonResponse(content);
      }
      
      this.logTokenUsage(completion);
      
      return { content };
    } catch (error) {
      this.logDetailedError(error, prompt);
      const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
      throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<ul>
<li>Ensures proper LLM request initiation with input validation and error handling as the AI navigates deep cosmic pipelines.</li>
<li>Implements techniques like <code class="inline-code">validateResponse</code> for thorough content verification, preventing errors from obscuring the nebula&#39;s secrets.</li>
<li>Features token usage logging, which helps calibrate energy reserves for prolonged missions.</li>
<li>Shows integration with markdown cleaning (<code class="inline-code">cleanJsonResponse</code>) for better data usability.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
      throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
      const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
      this.client = new AzureOpenAI({
        endpoint: azureEndpoint,
        apiKey,
        apiVersion: LLM_API_VERSION,
        deployment: this.model
      });
    } else {
      this.client = new OpenAI({
        apiKey,
        baseURL: LLM_BASE_URL
      });
    }
}
</code></pre>
<ul>
<li>Dynamically configures the AI interface for OpenAI and Azure providers, establishing clear channels for stellar interaction.</li>
<li>Detects whether Azure-specific or standard OpenAI protocols should be applied, ensuring accurate compatibility.</li>
<li>Captures environmental variables to guarantee proper authorization with minimal hardcoding.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
      if (!GITHUB_TOKEN) {
        throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
      }
      return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) {
      throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Defines a safe and dynamic retrieval process for securing API keys, ensuring optimized access to nebula AI endpoints.</li>
<li>Differentiates between GitHub-hosted Azure models and general OpenAI services for contextual key usage.</li>
<li>Enhances reliability by explicitly throwing errors when required configurations are incomplete.</li>
</ul>
<hr>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
      throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (!trimmedPath) {
      throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    if (trimmedPath.includes(&#39;\0&#39;)) {
      throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<ul>
<li>Ensures cosmic coordinates (file paths) are valid and non-malicious by enforcing stringent validation checks.</li>
<li>Detects anomalies like null bytes and empty strings, critical for stabilizing exploration hardware during missions.</li>
<li>Protects against traversal attacks by requiring clean, predictable path inputs.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
      const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
      if (options.compress) args.push(&#39;--compress&#39;);
      const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
      let stdout = &#39;&#39;;
      let stderr = &#39;&#39;;
      let stdoutSize = 0;
      let isResolved = false;
      
      const timeout = setTimeout(() =&gt; {
        if (!isResolved) {
          console.warn(`Repomix subprocess timeout (${REPOMIX_SUBPROCESS_TIMEOUT}ms), killing process...`);
          repomix.kill(&#39;SIGTERM&#39;);
          setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
          isResolved = true;
          reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
        }
      }, REPOMIX_SUBPROCESS_TIMEOUT);
      
      repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
        const chunk = data.toString();
        stdoutSize += chunk.length;
        if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
          if (!isResolved) {
            isResolved = true;
            clearTimeout(timeout);
            repomix.kill(&#39;SIGKILL&#39;);
            reject(new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`));
          }
          return;
        }
        stdout += chunk;
      });

      repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });
      
      repomix.on(&#39;close&#39;, (code) =&gt; {
        if (!isResolved) {
          isResolved = true;
          clearTimeout(timeout);
          if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
            resolve(stdout);
          } else {
            reject(new Error(`Repomix failed (exit ${code}): ${stderr.substring(0, 200)}`));
          }
        }
      });

      repomix.on(&#39;error&#39;, (error) =&gt; {
        if (!isResolved) {
          isResolved = true;
          clearTimeout(timeout);
          reject(new Error(`Repomix spawn failed: ${error.message}`));
        }
      });
    });
}
</code></pre>
<ul>
<li>Implements robust timeout and subprocess termination strategies to avoid memory overflows and system stalls.</li>
<li>Actively monitors subprocess output size, ensuring cosmic processing stays within resource limits.</li>
<li>Provides clear feedback when subprocess errors or excessive runtime issues occur, supporting quick diagnostics.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    if (!targetFiles || targetFiles.length === 0) {
      throw new Error(&#39;Target files array cannot be empty&#39;);
    }
    const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
    if (safeFiles.length === 0) {
      throw new Error(&#39;No valid target files found after validation&#39;);
    }
    const cliOptions: CliOptions = {
        style: &#39;markdown&#39;,
        stdout: true,
        compress: compress,
        include: safeFiles.join(&#39;,&#39;)
    };
    try {
      return await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    } catch (error) {
      throw new Error(`Targeted repomix execution failed: ${error.message}`);
    }
}
</code></pre>
<ul>
<li>Highlights modular design by extracting optimized content for high-value files, balancing token economy with crucial data inclusion.</li>
<li>Relies on <code class="inline-code">validateProjectPath</code> and <code class="inline-code">validateAndNormalizeTargetFiles</code> for pre-processing, further enhancing cosmic navigation safety.</li>
<li>Uses subprocess results (<code class="inline-code">captureRepomixStdout</code>) to streamline the mission while focusing on target-specific nebula regions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">validateProjectPath</code> as a safeguard for directory exploration across alien environments.</li>
<li>Consider token management patterns in <code class="inline-code">LLMClient</code> for resource-efficient galactic communication.</li>
<li>Adapt timeout thresholds in <code class="inline-code">captureRepomixStdout</code> when exploring dense nebula regions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üöÄ Stellar success! You&#39;ve masterfully navigated the cosmic labyrinth of Code Nebula Mapping, propelling your mission to a triumphant 60%‚Äîkeep burning bright, star voyager! ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>