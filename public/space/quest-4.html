<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Mission Configuration Constellation - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Repo Odyssey</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Mission Configuration Constellation</h1>
<hr>
<p>Your console hums as the Starship Repo Odyssey drifts into the Mission Configuration Constellation. AdventureManager and StoryGenerator flicker across your HUD, but this sector centers on stabilizing core instruments: config arrays, validator shields, and the theme star map. Your task: calibrate LLM burn rates, sanitize transmissions, and align the theme beacons so MCP relays can chart safe routes for future crews. Follow the signal trails in these files and decode how the voyage parameters, safety checks, and display formatting synchronize the whole expedition.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How do <code class="inline-code">LLM_REQUEST_TIMEOUT</code>, <code class="inline-code">REPOMIX_CACHE_TTL</code>, and <code class="inline-code">MAX_FILE_SIZE_MB</code> shape exploration boundaries and resource usage?</li>
<li>‚ö° Constellation Mapping: In <code class="inline-code">parseTheme</code>, in what order do exact key matches, numeric IDs, and keyword includes determine the selected theme?</li>
<li>üõ°Ô∏è Signal Sanitization: How does <code class="inline-code">sanitizeForDisplay</code> neutralize risky characters while preserving readable telemetry, and where do validators fall back to safe defaults?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/config.ts:</span> Core mission parameters shaping LLM thrust, cache orbits, and scan limits</h3>
<p>This configuration module behaves like your ship‚Äôs navigation computer. It loads environment variables and exposes mission constants that define timing, resource safety, and exploration scope. The <code class="inline-code">LLM_REQUEST_TIMEOUT</code> dictates how long the LLM engine can burn before abort, while <code class="inline-code">REPOMIX_CACHE_TTL</code> and <code class="inline-code">REPOMIX_SUBPROCESS_TIMEOUT</code> stabilize repomix subprocess behavior and caching to prevent thruster stalls. Analysis ceilings like <code class="inline-code">MAX_FILE_SIZE_MB</code>, <code class="inline-code">MAX_SCAN_DEPTH</code>, and <code class="inline-code">KEY_SOURCE_FILES</code> focus scans to avoid drifting into data nebulas. Defaults like <code class="inline-code">DEFAULT_THEME</code> ensure the ship boots into a known orientation. Error message beacons keep operator feedback consistent, and <code class="inline-code">IGNORE_PATTERNS</code> forms a debris filter so scanners ignore noisy sectors. Finally, <code class="inline-code">PROMPT_PATHS</code> points StoryGenerator to prompt charts, ensuring coherent narrative plotting. Trace how the system prioritizes env overrides, numeric parsing with <code class="inline-code">parseInt</code>/<code class="inline-code">parseFloat</code>, and safe defaults, then map how these constants would constrain RepoAnalyzer and LLMClient burn profiles across the voyage.</p>
<h4>Highlights</h4>
<ul>
<li>Resource limits and timeouts govern safe traversal across large code galaxies</li>
<li>Environment-driven overrides allow mission control to tune behavior without redeploys</li>
<li>Default values create predictable startup vectors and reduce cold-start risk</li>
<li>Ignore patterns and file limits protect against black hole directories and massive binaries</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/theme.ts:</span> The theme star map and its resolution logic for selecting a navigation profile</h3>
<p>This module is the stellar atlas for thematic navigation. <code class="inline-code">THEMES</code> enumerates charted constellations like <code class="inline-code">SPACE</code>, <code class="inline-code">MYTHICAL</code>, and <code class="inline-code">ANCIENT</code>, each with <code class="inline-code">id</code>, <code class="inline-code">key</code>, <code class="inline-code">emoji</code>, and <code class="inline-code">keywords</code> for sensor matching. The parser <code class="inline-code">parseTheme</code> resolves user input by sequentially checking exact key hits, numeric ID mapping, then keyword includes, delivering a deterministic lock-on order. Type guards like <code class="inline-code">isValidTheme</code> confirm a theme lies within known space. Presentation utilities <code class="inline-code">formatThemeOption</code> and <code class="inline-code">getFormattedThemeOptions</code> construct readable flight briefings for pilots. The simple array <code class="inline-code">THEMES_ARRAY</code> keeps iteration straightforward, making lookups predictable and fast. Together, these utilities ensure consistent theme alignment for StoryGenerator and UI displays, while keyword includes allow fuzzy matching without losing control of the helm.</p>
<h4>Highlights</h4>
<ul>
<li>Themes are centralized for single-source truth, preventing drift between subsystems</li>
<li>The parser prioritizes precision before fuzzy matches, reducing mis-navigations</li>
<li>Formatting utilities produce pilot-friendly prompts for mission selection</li>
<li>Type guard <code class="inline-code">isValidTheme</code> doubles as a safety rail for validators</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/input-validator.ts:</span> Docking clamps and comms scrubbing for safe operator input</h3>
<p>Here, validator utilities secure approach vectors and ensure inputs don‚Äôt breach hull integrity. <code class="inline-code">validateAdventureChoice</code> enforces presence and a concise max length, ideal for cockpit prompts. <code class="inline-code">validateTheme</code> normalizes input, leverages <code class="inline-code">parseTheme</code>, and uses <code class="inline-code">isValidTheme</code> to confirm navigability, emitting a list of valid themes when selection fails. <code class="inline-code">validateProjectPath</code> defensively defaults to <code class="inline-code">process.cwd()</code> when unset, guards against null bytes, and caps length to prevent filesystem traps. <code class="inline-code">sanitizeForDisplay</code> removes risky delimiters and compresses whitespace, returning trimmed, bounded strings suitable for shipboard display, minimizing injection or overflow in console outputs. Together, these routines ensure clean telemetry and predictable behavior before requests hit analyzers or LLM engines.</p>
<h4>Highlights</h4>
<ul>
<li>Defaulting to current working directory preserves forward motion when paths are missing</li>
<li>Theme validation unifies parser logic with type guard checks for reliability</li>
<li>Display sanitization strips hazardous characters while preserving core message content</li>
<li>Clear error messages provide immediate corrective feedback to pilots</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/config.ts</h3>
<pre><code class="language-typescript">/**
 * Simplified configuration for the MCP Repo Adventure system
 */

import { config } from &#39;dotenv&#39;;

// Load environment variables
config({ quiet: true });

// Simple constants instead of complex nested objects
export const LLM_API_KEY = process.env.LLM_API_KEY || &#39;&#39;;
export const LLM_BASE_URL = process.env.LLM_BASE_URL || &#39;https://api.openai.com/v1&#39;;
export const LLM_MODEL = process.env.LLM_MODEL || &#39;gpt-4o-mini&#39;;
export const LLM_API_VERSION = process.env.LLM_API_VERSION || &#39;2023-12-01-preview&#39;;
export const GITHUB_TOKEN = process.env.GITHUB_TOKEN || &#39;&#39;;

// Timeouts in milliseconds
export const FILE_READ_TIMEOUT = 10000;
export const FILE_ANALYSIS_TIMEOUT = 30000;
export const LLM_REQUEST_TIMEOUT = 60000; // 60 seconds for complex story generation with large prompts
export const LLM_CACHE_TTL = 300000; // 5 minutes
export const REPOMIX_CACHE_TTL = parseInt(process.env.REPOMIX_CACHE_TTL || &#39;60000&#39;); // 60 seconds, configurable via env
export const REPOMIX_SUBPROCESS_TIMEOUT = parseInt(process.env.REPOMIX_SUBPROCESS_TIMEOUT || &#39;120000&#39;); // 2 minutes, configurable via env
export const REPOMIX_GRACEFUL_TIMEOUT = 5000; // 5 seconds for graceful shutdown before SIGKILL
export const REPOMIX_MAX_BUFFER_SIZE = 100 * 1024 * 1024; // 100MB max buffer to prevent memory exhaustion

// Analysis limits
export const MAX_SCAN_DEPTH = 3; // Maximum directory depth to prevent infinite recursion and keep analysis focused
export const MAX_FILE_SIZE_MB = 10; // Skip files larger than this to avoid memory issues and focus on source code
export const KEY_SOURCE_FILES = 10; // Number of key files to highlight in adventure generation
export const TOP_FUNCTIONS = 20; // Maximum functions to include in code analysis summaries
export const TOP_CLASSES = 5; // Maximum classes to include in analysis to keep stories focused

// LLM settings
export const LLM_CACHE_SIZE = parseInt(process.env.LLM_CACHE_SIZE || &#39;100&#39;);
export const LLM_TEMPERATURE = parseFloat(process.env.LLM_TEMPERATURE || &#39;0.7&#39;);
export const LLM_MAX_TOKENS = parseInt(process.env.LLM_MAX_TOKENS || &#39;4000&#39;);
export const LLM_MAX_TOKENS_STORY = Math.max(LLM_MAX_TOKENS, 8000); // Maximum tokens for story generation (use env var if higher)
export const LLM_MAX_TOKENS_QUEST = Math.max(LLM_MAX_TOKENS, 6000); // Maximum tokens for individual quest exploration content (use env var if higher)
export const LLM_MAX_TOKENS_DEFAULT = LLM_MAX_TOKENS; // Use env var or default to 4000

// GPT-5 specific settings
export const GPT5_VERBOSITY = (process.env.GPT5_VERBOSITY as &#39;low&#39; | &#39;medium&#39; | &#39;high&#39;) || &#39;medium&#39;;
export const GPT5_REASONING_EFFORT = (process.env.GPT5_REASONING_EFFORT as &#39;minimal&#39; | &#39;medium&#39; | &#39;high&#39;) || &#39;medium&#39;;

// Cache settings

// Adventure settings
export const DEFAULT_THEME = &#39;space&#39; as const;
export const MAX_FILE_LINES_FOR_LLM = 100; // Truncate files to keep LLM prompts manageable
export const MAX_FILES_PER_QUEST = 3; // Limit files per quest to maintain focus and readability

// Error settings
export const MAX_ERROR_MESSAGE_LENGTH = 200;
export const INCLUDE_STACK_TRACES = process.env.NODE_ENV === &#39;development&#39;;

// Default error messages
export const ERROR_MESSAGES = {
  LLM_UNAVAILABLE: &#39;LLM service is currently unavailable. Please check your configuration.&#39;,
  ANALYSIS_FAILED: &#39;Failed to analyze the project. Please ensure the path is valid.&#39;,
  THEME_INVALID: &#39;Invalid theme specified. Using default theme.&#39;,
  FILE_NOT_FOUND: &#39;The requested file could not be found.&#39;,
  PERMISSION_DENIED: &#39;Permission denied accessing the specified path.&#39;,
} as const;

// Directory patterns to ignore during scanning
export const IGNORE_PATTERNS = [
  &#39;node_modules&#39;,
  &#39;.git&#39;,
  &#39;.next&#39;,
  &#39;.nuxt&#39;,
  &#39;dist&#39;,
  &#39;build&#39;,
  &#39;coverage&#39;,
  &#39;.nyc_output&#39;,
  &#39;logs&#39;,
  &#39;*.log&#39;,
  &#39;.env&#39;,
  &#39;.DS_Store&#39;,
  &#39;Thumbs.db&#39;,
] as const;

// Prompt file paths
export const PROMPT_PATHS = {
  STORY_GENERATION: &#39;src/prompts/story-generation-prompt.md&#39;,
  QUEST_CONTENT: &#39;src/prompts/quest-content-prompt.md&#39;,
  COMPLETION: &#39;src/prompts/completion-prompt.md&#39;,
  THEME_GUIDELINES: &#39;src/prompts/theme-guidelines.json&#39;
} as const;
</code></pre>
<p>These constants are the ship‚Äôs flight plan and safety parameters, ensuring engines, scanners, and caches run within safe cosmic limits.</p>
<pre><code class="language-typescript">/**
 * Central theme definitions for the adventure system
 * Single source of truth for all theme-related data
 */

// Define the structure of a theme
export interface ThemeDefinition {
  readonly id: number;
  readonly key: string;
  readonly displayName: string;
  readonly emoji: string;
  readonly description: string;
  readonly keywords: readonly string[];  // For matching user input
}

// Custom theme data provided by user
export interface CustomThemeData {
  name: string;
  description: string;
  keywords: string[];
}

// Single source of truth for all themes
export const THEMES = {
  SPACE: {
    id: 1,
    key: &#39;space&#39;,
    displayName: &#39;Space Exploration&#39;,
    emoji: &#39;üöÄ&#39;,
    description: &#39;Journey through cosmic codebases where data flows like stardust and APIs connect distant galaxies&#39;,
    keywords: [&#39;space&#39;, &#39;cosmic&#39;, &#39;galaxy&#39;, &#39;starship&#39;, &#39;astronaut&#39;, &#39;sci-fi&#39;, &#39;futuristic&#39;]
  },
  MYTHICAL: {
    id: 2,
    key: &#39;mythical&#39;,
    displayName: &#39;Enchanted Kingdom&#39;,
    emoji: &#39;üè∞&#39;,
    description: &#39;Explore magical and mythical realms where databases are dragon hoards and functions are powerful spells&#39;,
    keywords: [&#39;mythical&#39;, &#39;magic&#39;, &#39;enchanted&#39;, &#39;castle&#39;, &#39;dragon&#39;, &#39;fantasy&#39;, &#39;medieval&#39;, &#39;kingdom&#39;]
  },
  ANCIENT: {
    id: 3,
    key: &#39;ancient&#39;,
    displayName: &#39;Ancient Civilization&#39;,
    emoji: &#39;üè∫&#39;,
    description: &#39;Discover lost temples of code where algorithms are ancient wisdom and APIs are trade routes&#39;,
    keywords: [&#39;ancient&#39;, &#39;temple&#39;, &#39;pyramid&#39;, &#39;archaeology&#39;, &#39;historical&#39;, &#39;civilization&#39;, &#39;ruins&#39;]
  },
  DEVELOPER: {
    id: 4,
    key: &#39;developer&#39;,
    displayName: &#39;Developer Documentation&#39;,
    emoji: &#39;üìñ&#39;,
    description: &#39;Technical documentation approach with clear explanations, best practices, and code analysis&#39;,
    keywords: [&#39;developer&#39;, &#39;code&#39;, &#39;technical&#39;, &#39;debug&#39;, &#39;guide&#39;, &#39;tutorial&#39;, &#39;binary&#39;]
  },
  CUSTOM: {
    id: 5,
    key: &#39;custom&#39;,
    displayName: &#39;Custom Theme&#39;,
    emoji: &#39;üé®&#39;,
    description: &#39;Design your own adventure! You\&#39;ll be prompted to provide theme name, description, and keywords&#39;,
    keywords: [&#39;custom&#39;, &#39;personalized&#39;, &#39;unique&#39;, &#39;creative&#39;, &#39;personal&#39;]
  }
} as const;

// Extract the theme type from the keys
export type AdventureTheme = typeof THEMES[keyof typeof THEMES][&#39;key&#39;];

// Simple array of themes - no need for complex Maps with only 5 themes
const THEMES_ARRAY = Object.values(THEMES);

// Helper functions to access theme data using simple array iteration
export function getThemeById(id: number): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.id === id) || null;
}

export function getThemeByKey(key: string): ThemeDefinition | null {
  return THEMES_ARRAY.find(theme =&gt; theme.key === key) || null;
}

export function getAllThemes(): ThemeDefinition[] {
  return THEMES_ARRAY;
}


// Type guard using simple find
export function isValidTheme(theme: string): theme is AdventureTheme {
  return THEMES_ARRAY.some(t =&gt; t.key === theme);
}

// Simple theme parser using basic string matching
export function parseTheme(input: string): AdventureTheme | null {
  if (!input) return null;
  
  const normalized = input.trim().toLowerCase();
  
  // Check for exact key match
  const exactMatch = getThemeByKey(normalized);
  if (exactMatch) return exactMatch.key as AdventureTheme;
  
  // Check for numeric ID
  const numericId = parseInt(normalized, 10);
  if (!isNaN(numericId)) {
    const byId = getThemeById(numericId);
    if (byId) return byId.key as AdventureTheme;
  }
  
  // Check keywords using simple includes check
  for (const theme of THEMES_ARRAY) {
    if (theme.keywords.some(keyword =&gt; normalized.includes(keyword.toLowerCase()))) {
      return theme.key as AdventureTheme;
    }
  }
  
  return null;
}

// Format theme for display with all its properties
export function formatThemeOption(theme: ThemeDefinition): string {
  return `${theme.emoji} **${theme.id}. ${theme.displayName}** - ${theme.description}`;
}

// Get formatted list of all theme options
export function getFormattedThemeOptions(): string {
  return getAllThemes()
    .sort((a, b) =&gt; a.id - b.id)
    .map(formatThemeOption)
    .join(&#39;\n&#39;);
}
</code></pre>
<p>This theme atlas is your star chart: precise keys first, IDs second, then keyword constellations for fuzzy locks.</p>
<pre><code class="language-typescript">/**
 * Simplified input validation
 */

import { getAllThemes, isValidTheme, parseTheme } from &#39;./theme.js&#39;;

// Simple validation functions instead of complex class
export function validateAdventureChoice(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Choice is required&#39;);
  }
  
  if (input.length &gt; 200) {
    throw new Error(&#39;Choice too long (max 200 characters)&#39;);
  }
  
  return input.trim();
}

export function validateTheme(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Theme is required&#39;);
  }
  
  const normalized = input.toLowerCase().trim();
  const parsedTheme = parseTheme(normalized);
  
  if (!parsedTheme || !isValidTheme(parsedTheme)) {
    const validThemes = getAllThemes().map(t =&gt; t.key).join(&#39;, &#39;);
    throw new Error(`Invalid theme. Valid themes: ${validThemes}`);
  }
  
  return parsedTheme;
}

export function validateProjectPath(input?: string): string {
  if (!input?.trim()) {
    return process.cwd();
  }
  
  if (input.length &gt; 500) {
    throw new Error(&#39;Project path too long (max 500 characters)&#39;);
  }
  
  if (input.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid characters&#39;);
  }
  
  return input.trim();
}

export function sanitizeForDisplay(input: string, maxLength = 1000): string {
  if (!input) return &#39;&#39;;
  
  return input
    .replace(/[&lt;&gt;{}&quot;`]/g, &#39;&#39;)
    .replace(/\s+/g, &#39; &#39;)
    .trim()
    .slice(0, maxLength);
}
</code></pre>
<p>These validators are docking clamps and comms scrubbers, ensuring clean, bounded inputs before the ship proceeds.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Tune environment variables to adjust timeouts and cache TTLs without touching code; think mission control knobs.</li>
<li>Trace <code class="inline-code">parseTheme</code>‚Äôs decision order to predict which input strings will map to which constellations.</li>
<li>Use <code class="inline-code">sanitizeForDisplay</code> on any untrusted display text to prevent noisy or hazardous output in mission logs.</li>
</ul>
<hr>
<p>Telemetry locked and orbit aligned. Your configuration constellation now shines bright on the navmap. Plot the next jump when ready, navigator. Adventure Awaits.</p>
<p>Mission Control applauds your stellar success completing Quest 4: Mission Configuration Constellation‚Äîyour starship‚Äôs systems are now expertly calibrated, propelling you 60% through the campaign as you blaze a trajectory toward final orbit with pinpoint navigation and thruster-hot momentum! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>