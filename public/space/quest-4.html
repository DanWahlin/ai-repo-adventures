<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Navigation Arrays and Reactor Limits - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship RepoVenture: Charting the Code Galaxy</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Navigation Arrays and Reactor Limits</h1>
<hr>
<p>Your research starship glides along a spiral arm of code, where navigation arrays chart themes and the reactor throttles story output. The command bridge speaks the Model Context Protocol while reactors funnel context heat toward the LLM core. Tonight‚Äôs mission: align the navigation arrays that categorize cosmic themes and enforce reactor limits that prevent overloads during analysis burns. Your scanners will verify safe courses, sanitize transmissions, and respect timeouts as you calibrate the ship‚Äôs configuration. Chart the constants, validate your thematic trajectory, and keep the core stable through the nebula.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">parseTheme</code> combine exact key, numeric ID, and keyword matching to lock onto a user‚Äôs intended trajectory?</li>
<li>‚ö° Reactor Throttle: Which exported constants in <code class="inline-code">config.ts</code> directly constrain analysis scope and LLM generation capacity, and how do they interact?</li>
<li>üõ°Ô∏è Safe Transmission: How do <code class="inline-code">validateTheme</code> and <code class="inline-code">sanitizeForDisplay</code> enforce safe, normalized inputs and prevent hazardous characters from destabilizing the comms channel?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/theme.ts:</span> Navigation array for themes and parsing heuristics</h3>
<p>The navigation arrays here define mission themes and how the ship‚Äôs systems interpret crew selections. <code class="inline-code">THEMES</code> serves as the master chart, enumerating Space, Mythical, Ancient, Developer, and Custom sectors with <code class="inline-code">id</code>, <code class="inline-code">key</code>, <code class="inline-code">displayName</code>, <code class="inline-code">emoji</code>, <code class="inline-code">description</code>, and <code class="inline-code">keywords</code>. The crew‚Äôs hails are routed through <code class="inline-code">parseTheme</code>, which attempts an exact <code class="inline-code">key</code> match, a numeric <code class="inline-code">id</code> translation, then a flexible keyword match using includes logic. <code class="inline-code">isValidTheme</code> locks the target by ensuring the final key appears in the array. Retrieval utilities like <code class="inline-code">getAllThemes</code>, <code class="inline-code">getThemeById</code>, and <code class="inline-code">getThemeByKey</code> provide indexed access for scanners and UI beacons. Finally, <code class="inline-code">formatThemeOption</code> and <code class="inline-code">getFormattedThemeOptions</code> assemble readable options for the bridge display. Collectively, these functions form the ship‚Äôs stellar cartography layer for theme navigation, resolving ambiguous inputs without overfitting. You will see how simple array iteration avoids unnecessary complexity while still delivering robust targeting. Pay attention to normalization, deterministic ordering, and how keyword affinity broadens discovery without sacrificing validation boundaries.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">THEMES</code> defines the canonical navigation catalog with ids, keys, descriptors, and keywords for targeting and display.</li>
<li><code class="inline-code">getAllThemes</code> returns the full chart for iteration, enabling consistent display ordering and lookup operations.</li>
<li><code class="inline-code">isValidTheme</code> validates final course selections by checking membership against known keys, preventing drift into uncharted space.</li>
<li><code class="inline-code">parseTheme</code> performs multi-path matching (key, id, keywords) to resolve ambiguous inputs into a stable navigation target.</li>
<li><code class="inline-code">formatThemeOption</code> formats theme data for bridge readouts, aiding crew selection and confirmation.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/theme.ts</h3>
<pre><code class="language-typescript">export const THEMES = {
  SPACE: {
    id: 1,
    key: &#39;space&#39;,
    displayName: &#39;Space Exploration&#39;,
    emoji: &#39;üöÄ&#39;,
    description: &#39;Journey through cosmic codebases where data flows like stardust and APIs connect distant galaxies&#39;,
    keywords: [&#39;space&#39;, &#39;cosmic&#39;, &#39;galaxy&#39;, &#39;starship&#39;, &#39;astronaut&#39;, &#39;sci-fi&#39;, &#39;futuristic&#39;]
  },
  MYTHICAL: {
    id: 2,
    key: &#39;mythical&#39;,
    displayName: &#39;Enchanted Kingdom&#39;,
    emoji: &#39;üè∞&#39;,
    description: &#39;Explore magical and mythical realms where databases are dragon hoards and functions are powerful spells&#39;,
    keywords: [&#39;mythical&#39;, &#39;magic&#39;, &#39;enchanted&#39;, &#39;castle&#39;, &#39;dragon&#39;, &#39;fantasy&#39;, &#39;medieval&#39;, &#39;kingdom&#39;]
  },
  ANCIENT: {
    id: 3,
    key: &#39;ancient&#39;,
    displayName: &#39;Ancient Civilization&#39;,
    emoji: &#39;üè∫&#39;,
    description: &#39;Discover lost temples of code where algorithms are ancient wisdom and APIs are trade routes&#39;,
    keywords: [&#39;ancient&#39;, &#39;temple&#39;, &#39;pyramid&#39;, &#39;archaeology&#39;, &#39;historical&#39;, &#39;civilization&#39;, &#39;ruins&#39;]
  },
  DEVELOPER: {
    id: 4,
    key: &#39;developer&#39;,
    displayName: &#39;Developer Documentation&#39;,
    emoji: &#39;üìñ&#39;,
    description: &#39;Technical documentation approach with clear explanations, best practices, and code analysis&#39;,
    keywords: [&#39;developer&#39;, &#39;code&#39;, &#39;technical&#39;, &#39;debug&#39;, &#39;guide&#39;, &#39;tutorial&#39;, &#39;binary&#39;]
  },
  CUSTOM: {
    id: 5,
    key: &#39;custom&#39;,
    displayName: &#39;Custom Theme&#39;,
    emoji: &#39;üé®&#39;,
    description: &#39;Design your own adventure! You\&#39;ll be prompted to provide theme name, description, and keywords&#39;,
    keywords: [&#39;custom&#39;, &#39;personalized&#39;, &#39;unique&#39;, &#39;creative&#39;, &#39;personal&#39;]
  }
} as const;
</code></pre>
<ul>
<li>Defines the mission‚Äôs total theme map with stable ids and keys for deterministic lookup.</li>
<li>Embeds keywords to enable approximate matching in <code class="inline-code">parseTheme</code> without external indices.</li>
<li>Keeps data immutable via <code class="inline-code">as const</code>, preserving type safety and preventing accidental mutation.</li>
<li>Centralizes display metadata so UI and validation share a single truth source.</li>
<li>Ensures Space remains the default anchor with id 1, aligning with config defaults.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function getAllThemes(): ThemeDefinition[] {
  return THEMES_ARRAY;
}

// Type guard using simple find
export function isValidTheme(theme: string): theme is AdventureTheme {
  return THEMES_ARRAY.some(t =&gt; t.key === theme);
}
</code></pre>
<ul>
<li><code class="inline-code">getAllThemes</code> exposes a curated array for consistent iteration and presentation.</li>
<li><code class="inline-code">isValidTheme</code> acts as a type guard, allowing downstream code to narrow types safely.</li>
<li>Uses <code class="inline-code">some</code> for O(n) membership checks, sufficient for a small fixed set.</li>
<li>Encourages validation before display or persistence, avoiding invalid states.</li>
<li>Keeps logic simple and predictable, aiding maintainability.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseTheme(input: string): AdventureTheme | null {
  if (!input) return null;
  
  const normalized = input.trim().toLowerCase();
  
  // Check for exact key match
  const exactMatch = getThemeByKey(normalized);
  if (exactMatch) return exactMatch.key as AdventureTheme;
  
  // Check for numeric ID
  const numericId = parseInt(normalized, 10);
  if (!isNaN(numericId)) {
    const byId = getThemeById(numericId);
    if (byId) return byId.key as AdventureTheme;
  }
  
  // Check keywords using simple includes check
  for (const theme of THEMES_ARRAY) {
    if (theme.keywords.some(keyword =&gt; normalized.includes(keyword.toLowerCase()))) {
      return theme.key as AdventureTheme;
    }
  }
  
  return null;
}
</code></pre>
<ul>
<li>Normalizes input, then resolves by exact key, numeric id, or keyword affinity for resilient navigation.</li>
<li>Prioritizes precise matches before fuzzy signals, minimizing unintended course corrections.</li>
<li>Uses simple includes-based keyword search, trading power for clarity and predictability.</li>
<li>Returns <code class="inline-code">null</code> on failure, enabling upstream error messages or fallback to defaults.</li>
<li>Demonstrates layered parsing strategy adaptable to future sources.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/config.ts:</span> Reactor limits, timeouts, and analysis boundaries</h3>
<p>This module configures how the reactor allocates energy to scanning and storytelling. Environment loading via <code class="inline-code">dotenv</code> is quiet to avoid noisy logs. The constants you see control everything from request timeouts to cache TTLs. <code class="inline-code">LLM_REQUEST_TIMEOUT</code> defines how long the core can sustain a generative burn. <code class="inline-code">REPOMIX_CACHE_TTL</code> and <code class="inline-code">REPOMIX_SUBPROCESS_TIMEOUT</code> manage analyzer subprocess behavior, keeping the ship responsive. File analysis safety is enforced by <code class="inline-code">MAX_FILE_SIZE_MB</code>, <code class="inline-code">MAX_SCAN_DEPTH</code>, and curated limits like <code class="inline-code">KEY_SOURCE_FILES</code>, <code class="inline-code">TOP_FUNCTIONS</code>, and <code class="inline-code">TOP_CLASSES</code>. Output breadth is balanced using <code class="inline-code">LLM_MAX_TOKENS_STORY</code> and <code class="inline-code">LLM_MAX_TOKENS_QUEST</code>, which clamp to at least configured defaults. These limits protect the mission from runaway prompts and memory hazards. Defaults like <code class="inline-code">DEFAULT_THEME</code> tether navigation to Space when no other beacons are present. Ignored directories reduce nebula noise for scanners, while prompt path constants provide known coordinates for narrative templates. Together, these values tune throughput and stability for long-range exploration without overloading the hull.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">LLM_REQUEST_TIMEOUT</code> sets maximum sustained generation time to prevent reactor stalls during long burns.</li>
<li><code class="inline-code">REPOMIX_CACHE_TTL</code> defines analyzer cache longevity, stabilizing repeated scans across nearby orbits.</li>
<li><code class="inline-code">MAX_FILE_SIZE_MB</code> clamps file size to avoid memory collapse and keep scans focused on source signals.</li>
<li><code class="inline-code">DEFAULT_THEME</code> provides a safe navigation fallback toward Space when signals are ambiguous.</li>
<li><code class="inline-code">LLM_MAX_TOKENS_STORY</code> and <code class="inline-code">LLM_MAX_TOKENS_QUEST</code> shape narrative output size for balanced throughput.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/config.ts</h3>
<pre><code class="language-typescript">export const LLM_REQUEST_TIMEOUT = 60000; // 60 seconds for complex story generation with large prompts
export const LLM_CACHE_TTL = 300000; // 5 minutes
export const REPOMIX_CACHE_TTL = parseInt(process.env.REPOMIX_CACHE_TTL || &#39;60000&#39;); // 60 seconds, configurable via env
export const REPOMIX_SUBPROCESS_TIMEOUT = parseInt(process.env.REPOMIX_SUBPROCESS_TIMEOUT || &#39;120000&#39;); // 2 minutes, configurable via env
export const REPOMIX_GRACEFUL_TIMEOUT = 5000; // 5 seconds for graceful shutdown before SIGKILL
export const REPOMIX_MAX_BUFFER_SIZE = 100 * 1024 * 1024; // 100MB max buffer to prevent memory exhaustion
</code></pre>
<ul>
<li>Establishes time ceilings for LLM and analyzer operations to avoid indefinite burns.</li>
<li>Introduces cache TTLs to reuse recent context, trimming redundant scans.</li>
<li>Bounds subprocess execution and buffer size to protect memory integrity.</li>
<li>Allows environment overrides for mission-specific tuning without code changes.</li>
<li>Coordinates graceful shutdown to prevent orphaned processes.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const MAX_SCAN_DEPTH = 3; // Maximum directory depth to prevent infinite recursion and keep analysis focused
export const MAX_FILE_SIZE_MB = 10; // Skip files larger than this to avoid memory issues and focus on source code
export const KEY_SOURCE_FILES = 10; // Number of key files to highlight in adventure generation
export const TOP_FUNCTIONS = 20; // Maximum functions to include in code analysis summaries
export const TOP_CLASSES = 5; // Maximum classes to include in analysis to keep stories focused
</code></pre>
<ul>
<li>Limits traversal depth and file size to maintain stable scan orbits.</li>
<li>Curates analysis scope with caps on highlighted assets to ensure clarity.</li>
<li>Prevents infinite recursion risks in complex repository structures.</li>
<li>Encourages concise mission briefings by bounding summary elements.</li>
<li>Supports predictable performance across repositories of varying sizes.</li>
</ul>
<hr>
<pre><code class="language-typescript">export const DEFAULT_THEME = &#39;space&#39; as const;
export const MAX_FILE_LINES_FOR_LLM = 100; // Truncate files to keep LLM prompts manageable
export const MAX_FILES_PER_QUEST = 3; // Limit files per quest to maintain focus and readability

export const LLM_MAX_TOKENS = parseInt(process.env.LLM_MAX_TOKENS || &#39;4000&#39;);
export const LLM_MAX_TOKENS_STORY = Math.max(LLM_MAX_TOKENS, 8000); // Maximum tokens for story generation (use env var if higher)
export const LLM_MAX_TOKENS_QUEST = Math.max(LLM_MAX_TOKENS, 6000); // Maximum tokens for individual quest exploration content (use env var if higher)
export const LLM_MAX_TOKENS_DEFAULT = LLM_MAX_TOKENS; // Use env var or default to 4000
</code></pre>
<ul>
<li>Sets Space as the default navigation vector if no theme is selected.</li>
<li>Truncates files and file counts per quest to keep prompts efficient.</li>
<li>Uses max guards to ensure sufficient tokens for stories and quests.</li>
<li>Separates defaults from adjustable env-driven values for clarity.</li>
<li>Balances output richness with token budgeting for stable throughput.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/shared/input-validator.ts:</span> Secure input lanes and sanitized comms</h3>
<p>The input validators secure the bridge‚Äôs command lanes. <code class="inline-code">validateAdventureChoice</code> enforces presence and length, trimming payloads to remove incidental drift. <code class="inline-code">validateTheme</code> normalizes input, routes it through <code class="inline-code">parseTheme</code>, and checks with <code class="inline-code">isValidTheme</code>, returning a stable theme key or surfacing a list of valid options via <code class="inline-code">getAllThemes</code>. This two-step resolution prevents the navigation array from locking on an invalid sector. <code class="inline-code">validateProjectPath</code> defaults to <code class="inline-code">process.cwd()</code> when absent, rejects null bytes, and bounds path length to avert path injection hazards. Finally, <code class="inline-code">sanitizeForDisplay</code> strips angle brackets, braces, quotes, and backticks, collapses whitespace, and applies a maximum length, ensuring outbound status panels cannot be compromised by unsafe characters. These utilities form a layered defense and provide predictable inputs to the analyzers and story engines downstream.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateTheme</code> normalizes and verifies theme selections using <code class="inline-code">parseTheme</code> and <code class="inline-code">isValidTheme</code>, returning a canonical key.</li>
<li><code class="inline-code">validateProjectPath</code> applies safe defaults, bounds, and invalid character checks for filesystem stability.</li>
<li><code class="inline-code">sanitizeForDisplay</code> removes hazardous characters and normalizes whitespace to protect HUD displays and logs.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/input-validator.ts</h3>
<pre><code class="language-typescript">export function validateTheme(input: string): string {
  if (!input?.trim()) {
    throw new Error(&#39;Theme is required&#39;);
  }
  
  const normalized = input.toLowerCase().trim();
  const parsedTheme = parseTheme(normalized);
  
  if (!parsedTheme || !isValidTheme(parsedTheme)) {
    const validThemes = getAllThemes().map(t =&gt; t.key).join(&#39;, &#39;);
    throw new Error(`Invalid theme. Valid themes: ${validThemes}`);
  }
  
  return parsedTheme;
}
</code></pre>
<ul>
<li>Enforces presence, normalizes case and whitespace for consistent parsing.</li>
<li>Delegates to <code class="inline-code">parseTheme</code> to resolve flexible inputs, then confirms with <code class="inline-code">isValidTheme</code>.</li>
<li>Provides actionable error feedback listing valid <code class="inline-code">key</code> options.</li>
<li>Returns a canonical key to stabilize downstream configuration and prompts.</li>
<li>Prevents invalid theme propagation that could corrupt navigation.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function validateProjectPath(input?: string): string {
  if (!input?.trim()) {
    return process.cwd();
  }
  
  if (input.length &gt; 500) {
    throw new Error(&#39;Project path too long (max 500 characters)&#39;);
  }
  
  if (input.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid characters&#39;);
  }
  
  return input.trim();
}
</code></pre>
<ul>
<li>Defaults to the current working directory to ensure a valid baseline path.</li>
<li>Enforces length limits to avoid absurd or malicious inputs.</li>
<li>Explicitly rejects null bytes, a common vector for path manipulation issues.</li>
<li>Trims whitespace to prevent subtle mismatches in path resolution.</li>
<li>Provides early, explicit failures rather than silent misconfiguration.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function sanitizeForDisplay(input: string, maxLength = 1000): string {
  if (!input) return &#39;&#39;;
  
  return input
    .replace(/[&lt;&gt;{}&quot;`]/g, &#39;&#39;)
    .replace(/\s+/g, &#39; &#39;)
    .trim()
    .slice(0, maxLength);
}
</code></pre>
<ul>
<li>Strips characters that might interfere with UIs or formatting in mission HUDs.</li>
<li>Collapses whitespace for consistent single-line or compact displays.</li>
<li>Applies a strict max length to protect panels and logs from overflow.</li>
<li>Returns empty string on falsy input to standardize downstream handling.</li>
<li>Provides a lightweight, dependable sanitation step before display.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Tune <code class="inline-code">LLM_MAX_TOKENS_STORY</code> and <code class="inline-code">LLM_MAX_TOKENS_QUEST</code> carefully to balance narrative richness and latency.</li>
<li>If theme selection fails, inspect <code class="inline-code">parseTheme</code> behavior with keyword inputs like <code class="inline-code">galaxy</code> or numeric ids like <code class="inline-code">1</code>.</li>
<li>Keep analyzer stability by respecting <code class="inline-code">MAX_SCAN_DEPTH</code> and <code class="inline-code">MAX_FILE_SIZE_MB</code> when configuring large repositories.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission update: Quest 4‚ÄîNavigation Arrays and Reactor Limits‚Äîsuccessfully charted and stabilized, propelling your starship to 60% completion with thruster-hot momentum and reactor-safe precision‚Äîstellar work, Commander! üöÄ‚≠êüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>