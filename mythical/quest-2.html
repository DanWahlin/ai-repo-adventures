<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Quill of Eternal Tales - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of the Enchanted Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Quill of Eternal Tales</h1>
<hr>
<p>An ethereal mist blankets the enchanted halls of Repositoria‚Äôs Grand Scriptorium, where the legendary Quill of Eternal Tales resides. This mystical artifact is said to shape the course of every written word in the kingdom. Yet, dark shadows‚Äîwhispers of confusion‚Äîhave unbalanced the quill‚Äôs rhythm. In your quest to restore clarity, you must delve into the sacred scrolls of the &quot;Quest Generation Engine,&quot; where arcs of logic and patterns of creation define the artistry of storytelling. The realm‚Äôs harmony rests upon your shoulders, Hero of Syntax.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üñãÔ∏è <strong>The Flow of the Quill</strong>: How does <code class="inline-code">AdventureManager.initializeAdventure</code> ensure a new adventure&#39;s setup aligns with the current theme and project context?</li>
<li>üîç <strong>The Art of Stitching Quests</strong>: How does <code class="inline-code">AdventureManager.mergeQuestFilesFromConfig</code> integrate quest files into the generated structure, and why is this crucial for the system&#39;s flexibility?</li>
<li>üí° <strong>The Spark of Motivation</strong>: How does <code class="inline-code">StoryGenerator.generateStoryAndQuests</code> synthesize a narrative and quest structure tailored to the given project information and themes?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> Managing the Hero&#39;s Journey</h3>
<p>The <code class="inline-code">AdventureManager</code> is the beating heart of Repositoria&#39;s quest generation system. This class manages the orchestration of adventures‚Äîfrom initializing stories to ensuring quests are immersive and aligned with project-specific details. By seamlessly merging procedural logic with external inputs (like configuration files), it demonstrates adaptability and modularity.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Establishes the adventure context, resetting the state while generating a new story and quest framework based on themes.</li>
<li><code class="inline-code">mergeQuestFilesFromConfig</code>: Dynamically integrates quest-specific file references from configuration data, ensuring precision in contextual expansions.</li>
<li><code class="inline-code">executeQuest</code>: Executes a quest while validating, caching, and marking it as completed, forming the bridge between setup and exploration.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> Crafting the Lore</h3>
<p>The <code class="inline-code">StoryGenerator</code> serves as the mystical bard of Repositoria, weaving tales and structuring quests to engage the Hero of Syntax. It leverages logical patterns and creative prompts to form narrative arcs and planned investigation points for explorers.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Synthesizes a story and quests by drawing upon project details, selected themes, and additional guidance.</li>
<li><code class="inline-code">parseMarkdownToStoryResponse</code>: Transforms raw markdown responses into structured story data, enabling smooth interplay between narrative frameworks and dynamic code explorations.</li>
<li><code class="inline-code">generateQuestContent</code>: Produces tailored content for individual quests, relying on both repository context and external configuration.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string, customThemeData?: CustomThemeData): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;

  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the <code class="inline-code">AdventureState</code>, ensuring a blank canvas for each new journey.</li>
<li>Dynamically sets values like theme and project path, allowing thematic customization through <code class="inline-code">customThemeData</code>.</li>
<li>Orchestrates story generation and quest integration with seamless fallback mechanisms for configuration data.</li>
</ul>
<hr>
<pre><code class="language-typescript">private mergeQuestFilesFromConfig(quests: Quest[], projectPath: string | undefined): Quest[] {
  if (!projectPath) return quests;
  const config = parseAdventureConfig(projectPath);
  if (!config || typeof config !== &#39;object&#39;) return quests;

  const adventure = (config as any).adventure;
  if (!adventure || !Array.isArray(adventure.quests)) return quests;

  const configQuestFiles = new Map&lt;string, string[]&gt;();
  for (const configQuest of adventure.quests) {
    if (configQuest.title &amp;&amp; Array.isArray(configQuest.files)) {
      const filePaths = configQuest.files.filter((f: any) =&gt; f.path).map((f: any) =&gt; f.path);
      if (filePaths.length &gt; 0) {
        configQuestFiles.set(configQuest.title.toLowerCase(), filePaths);
      }
    }
  }

  return quests.map((quest, index) =&gt; {
    const configQuests = adventure.quests;
    if (index &lt; configQuests.length &amp;&amp; configQuests[index] &amp;&amp; configQuests[index].files) {
      const files = configQuests[index].files.filter((f: any) =&gt; f.path).map((f: any) =&gt; f.path);
      if (files.length &gt; 0) return { ...quest, codeFiles: files };
    }

    const questTitleLower = quest.title.toLowerCase();
    for (const [configTitle, files] of configQuestFiles.entries()) {
      if (questTitleLower.includes(configTitle) || configTitle.includes(questTitleLower)) {
        return { ...quest, codeFiles: files };
      }
    }

    return quest;
  });
}
</code></pre>
<ul>
<li>Reads the adventure configuration to associate quests with specific file paths.</li>
<li>Implements a fallback pattern using both array indexing and title matching, ensuring no quest is left contextually ungrounded.</li>
<li>Enhances flexibility by decoupling quest generation from static file references.</li>
</ul>
<hr>
<pre><code class="language-typescript">async executeQuest(quest: Quest): Promise&lt;AdventureResult&gt; {
  this.validateQuestPrerequisites();

  let content: QuestContent;
  let summary: string;

  const cached = this.state.questContentCache.get(quest.id);
  if (cached) {
    await new Promise(resolve =&gt; setTimeout(resolve, 500));
    content = cached.content;
    summary = cached.summary;
    content = { ...content, adventure: `üîÑ **[REVISITING COMPLETED QUEST]**\n\n${content.adventure}` };
  } else {
    content = await this.generateQuestContent(quest);
    summary = await this.generateCompletionSummary(quest);
    this.state.questContentCache.set(quest.id, { content, summary });
  }

  this.markQuestCompleted(quest);
  return this.createQuestResult(content, summary);
}
</code></pre>
<ul>
<li>Validates prerequisites to ensure quests are undertaken in the proper context.</li>
<li>Leverages caching to enable faster revisiting of completed quests.</li>
<li>Marks quests as completed while returning polished results for the journey record.</li>
</ul>
<hr>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;
  
  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Validates and applies the selected theme to ensure consistent narrative settings.</li>
<li>Delegates to LLM-based generation functions, bridging creativity with project-specific data.</li>
<li>Forms the entry point for creating story arcs and quest lines.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);
  
  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];
  
  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};

  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      if (token.depth === 1) {
        currentSection = &#39;story&#39;;
      } else if (token.depth === 2) {
        currentSection = token.text.toLowerCase();
      } else if (token.depth === 3 &amp;&amp; currentSection === &#39;quests&#39;) {
        if (currentQuest.title &amp;&amp; currentQuest.description) quests.push({ ...currentQuest, codeFiles: currentQuest.codeFiles || [] });
        currentQuest = { title: token.text, description: &#39;&#39; };
      }
    } else if (token.type === &#39;paragraph&#39; &amp;&amp; currentQuest.title) {
      currentQuest.description += token.text + &#39;\n\n&#39;;
    }
  }

  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push({ title: currentQuest.title, description: currentQuest.description.trim(), codeFiles: currentQuest.codeFiles || [] });
  }

  return { title, story: story.trim(), quests };
}
</code></pre>
<ul>
<li>Extracts structured data (title, story, and quests) from raw markdown responses.</li>
<li>Ensures logical sections by leveraging markdown token patterns.</li>
<li>Prepares content for consumption by other storytelling components.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, codeContent, questPosition, totalQuests } = config;

  const prompt = `# Quest: ${quest.title}\n` + 
                 `Theme: ${theme}\n\n` + 
                 `Code Context:\n\`\`\`\n${codeContent}\n\`\`\`\n\n` + 
                 `Quest Position: ${questPosition}\nTotal Quests: ${totalQuests}`;
  
  const response = await this.withTimeout(this.llmClient.generateResponse(prompt));
  if (!response.content) throw new Error(&#39;LLM response was empty.&#39;);

  return { adventure: response.content, codeSnippets: [], hints: [] };
}
</code></pre>
<ul>
<li>Crafts an LLM prompt to generate quest-specific content tied to both theme and repository.</li>
<li>Combines input like code context and quest position for detailed insight into quest structure.</li>
<li>Returns a cleanly structured <code class="inline-code">QuestContent</code> object.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Interpret &quot;themes&quot; as guidelines for vocabulary and tone throughout the generated content.</li>
<li>Break down markdown responses into reusable structures for better configuration mapping.</li>
<li>Use caching effectively to minimize redundant data processing.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>üè∞ With the Quill of Eternal Tales now secured, your legend begins to unfurl like a celestial tapestry, brave hero‚Äîonward to glory as the constellations cheer your 20% triumph! ‚≠êüìú‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>