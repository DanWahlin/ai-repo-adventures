<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Mystic Toolsmiths - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Codex of Questoria</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic Toolsmiths</h1>
<hr>
<p>In the realm of Questoria, a wise council of Mystic Toolsmiths forges enchanted tools that empower adventurers to conquer the challenges of the Enchanted Codex. These tools, stored within a magical repository, adapt to the quests and stories crafted by the adventurous minds of Codex wielders. Heroes, to wield such power is no simple feat‚Äîyou must delve into the arcane scripts, decipher the spells of tool creation, and unveil the essence of their magic. Prepare yourself to unlock the secrets of the Mystic Toolsmiths!</p>
<h2>Quest Objectives</h2>
<p>As you explore the sacred code below, investigate these mystical queries:</p>
<ul>
<li>üîç <strong>The Enchanter‚Äôs Primer</strong>: How does <code class="inline-code">setupHandlers</code> dynamically forge tools into enchanted responses, and how are their properties defined?</li>
<li>‚ö° <strong>Arcane Activation</strong>: What magical protocols are initiated by the <code class="inline-code">run</code> method, and why is pre-generation of the repository content significant?</li>
<li>üõ°Ô∏è <strong>Safeguard of the Codex</strong>: In the <code class="inline-code">main</code> function, how does the system ensure the enchanted server resists unhandled curses and adapts to corrupting influences?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The Keystone of Mystic Tools</h3>
<p>The file <code class="inline-code">server.ts</code> is where the magic of the Repo Adventure Server begins, serving as the structural foundation for tool creation and interaction. It defines the server‚Äôs properties, initializes its tool-handling spells, and orchestrates its connection to the kingdom‚Äôs enchanted channels. Herein lies the system‚Äôs ability to list available tools and execute their associated magical operations dynamically, while maintaining safety nets to shield the server from corrupt incantations and unforeseen magical errors.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the server with dynamic spells that list and execute tools in response to adventurers‚Äô requests.</li>
<li><code class="inline-code">run</code>: Activates the enchanted MCP server, establishes communication channels, and pre-generates content for seamless quest execution.</li>
<li><code class="inline-code">main</code>: Launches the Repo Adventure Server, safeguarding it against existential errors like unhandled rejections and system signals.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists enchanted tools by transforming their properties into JSON schemas using <code class="inline-code">zodToJsonSchema</code>, ensuring consistent and valid descriptions for adventurers.</li>
<li>The server validates tool invocation spells with a robust schema parser, protecting against invalid arguments and casting meaningful error messages when incantations fail.</li>
<li>A central strategy evaluates tools dynamically, eliminating the need to hard-code behavioral specifics, allowing for flexible and expandable tool definitions.</li>
<li>Distinct error handling mechanisms, including <code class="inline-code">McpError</code>, enhance safety by discerning unknown tools, invalid parameters, and unexpected execution errors.</li>
<li>These handlers enable seamless integration between the server and toolsets, ensuring efficient and dynamic management of requests across the kingdom.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>This method establishes a transport layer for communication between the server and the adventurers‚Äô magical terminals.</li>
<li>By invoking <code class="inline-code">repoAnalyzer.preGenerate</code>, it proactively generates repository context, ensuring smooth tool execution during quests.</li>
<li>Console messages provide visibility into the server‚Äôs state, guiding users with informative prompts on its readiness and background tasks.</li>
<li>This strategic decision to pre-load repository context optimizes performance during runtime, minimizing latency for quests and magical operations.</li>
<li>The <code class="inline-code">run</code> process links core components, aligning the server setup with real-time interactive adventure management.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function acts as the anchor of the MCP server, ensuring a structured and reliable deployment across the mystical kingdom‚Äôs realms.</li>
<li>It integrates signal listeners for graceful shutdowns, invoking <code class="inline-code">gracefulShutdown</code> to safely release resources and clean up server states.</li>
<li>Handling <code class="inline-code">unhandledRejection</code> ensures the system remains resilient to unexpected failures, logging the issues without compromising server availability.</li>
<li>Exception handling within <code class="inline-code">main</code> prevents run failures from cascading, isolating fatal errors and delivering clear feedback to developers.</li>
<li>This approach prioritizes reliability and user experience, embodying the defensive features deemed essential within enchanted systems.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>ü™Ñ Dynamic registration of tools is key for flexible and expandable systems‚Äîexamine <code class="inline-code">setupHandlers</code> closely for ideas on schema-based validation.</li>
<li>üõ°Ô∏è Notice how error handling is layered for both graceful degradation (<code class="inline-code">unhandledRejection</code>) and fatal shutdown prevention (<code class="inline-code">gracefulShutdown</code>).</li>
<li>‚ö° Dig deeper into the purpose of pre-generating repository context (<code class="inline-code">repoAnalyzer.preGenerate</code>) for smoother quest execution.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the radiant will of the starlit forge, you have triumphed in Quest 2: The Mystic Toolsmiths, crafting knowledge into legendary brilliance‚Äîonward, noble hero, for your destiny shines at 20%! ‚ö°üíéüöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>