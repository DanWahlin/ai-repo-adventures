<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 2: The Mystic Tools of MCP - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic Tools of MCP</h1>
<hr>
<p>In the enchanted Kingdom of Codethos, the delicate balance of magic relies on harmony between mystical objects. Yet a shadow looms ‚Äì the Mystic Tools of MCP, integral to preserving the Great Repository scroll, are showing signs of disarray. These arcane instruments, each imbued with unique powers, risk falling into chaos as their enchantments wane. Adventurer, your mission awaits: to decipher the code of these mystical tools and restore their harmony before the kingdom falls into flux.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Arcane Integration</strong>: How does <code class="inline-code">setupHandlers</code> dynamically manage tool registration and validation in <code class="inline-code">RepoAdventureServer</code>?  </li>
<li>‚ö° <strong>Flow of Magic</strong>: What role does <code class="inline-code">run</code> play in initializing interplay between the MCP server and its tools?  </li>
<li>üõ°Ô∏è <strong>Fortress of Resilience</strong>: How does the <code class="inline-code">main</code> function ensure graceful handling of errors and shutdowns while starting the server?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: Dissecting Enchanted Middleware</h3>
<p>The <code class="inline-code">server.ts</code> file conjures the mystical workings of the <code class="inline-code">RepoAdventureServer</code> class, the cornerstone for tool orchestration in Codethos. Its dual-purpose design supports the registration of magical tools and execution of their spells. Critical handlers like <code class="inline-code">setupHandlers</code> ensure the safe and robust execution of tools, while <code class="inline-code">run</code> configures and activates communication through the MCP&#39;s enchanted StdIO network. Finally, the <code class="inline-code">main</code> function ensures the server weaves its magic securely, handling disruptions with grace.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically lists the Mystic Tools and validates user requests against predefined schemas to ensure seamless spellbinding.  </li>
<li><code class="inline-code">run</code>: Activates the mystical MCP server, pre-generates content for smoother spell execution, and calls upon the <code class="inline-code">repoAnalyzer</code> to prepare the magical groundwork.  </li>
<li><code class="inline-code">main</code>: Acts as the custodian for robust server operation, handling unforeseen errors and ensuring graceful termination of the server during disruptions.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">  private setupHandlers() {  
    // Dynamic tool listing  
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
        name,  
        description: tool.description,  
        inputSchema: zodToJsonSchema(tool.schema, {   
          target: &#39;jsonSchema7&#39;,  
          $refStrategy: &#39;none&#39;  
        })  
      }));  
      return { tools: toolList };  
    });  

    // Dynamic tool execution  
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
      try {  
        const { name, arguments: args } = request.params;  
        if (!(name in tools)) {  
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
        }  
        const tool = tools[name as keyof typeof tools];  
        const validationResult = tool.schema.safeParse(args);  
        if (!validationResult.success) {  
          const errorMessages = validationResult.error.issues.map((err) =&gt;   
            `${err.path.join(&#39;.&#39;)}: ${err.message}`  
          ).join(&#39;, &#39;);  
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
        }  
        return await tool.handler(validationResult.data as any);  
      } catch (error) {  
        if (error instanceof McpError) {  
          throw error;  
        }  
        throw new McpError(  
          ErrorCode.InternalError,  
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
        );  
      }  
    });  
  }  
</code></pre>
<ul>
<li>Dynamically registers Mystic Tools with validation using their schemas, guaranteeing proper casting of spells.  </li>
<li>Implements defensive programming by catching errors, raising custom <code class="inline-code">McpError</code> exceptions if tools are missing or parameters are invalid.  </li>
<li>Enhances extensibility with modular design to support easy addition of new tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {  
    const transport = new StdioServerTransport();  
    await this.server.connect(transport);  
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  
    const projectPath = process.cwd();  
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
    repoAnalyzer.preGenerate(projectPath);  
  }  
</code></pre>
<ul>
<li>Establishes connectivity through the MCP&#39;s enchanted StdIO Transport for bidirectional communication.  </li>
<li>Proactively generates the foundational repository analysis, optimizing future operations.  </li>
<li>Employs asynchronous design to maintain smooth spellcasting operations while preparing enchantments.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async function main() {  
    try {  
      const server = new RepoAdventureServer();  
      [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
        process.on(sig as NodeJS.Signals, gracefulShutdown)  
      );  
      process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
        console.error(&#39;Unhandled promise rejection:&#39;, reason);  
        console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
      });  
      await server.run();  
    } catch (error) {  
      console.error(&#39;Fatal error starting MCP server:&#39;, error);  
      process.exit(1);  
    }  
  }  
</code></pre>
<ul>
<li>Registers signal listeners (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to gracefully halt the server, ensuring spell energy is not leaked.  </li>
<li>Protects the mystical realm by handling uncaught promise rejections, ensuring errors are logged but do not compromise the repository defense.  </li>
<li>Promotes resilience with error handling during server startup to prevent unintentional disruptions in Codethos.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>: The Tome of Enchanted Instruments</h3>
<p>This file serves as the catalog for the Mystic Tools, each designed to fulfill a unique purpose in Codethos. The tools are managed cohesively through modular imports and direct exports, allowing seamless registration and execution by the MCP server.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initializes the journey for adventurers, analyzing the repository and presenting story themes.  </li>
<li><code class="inline-code">choose_theme.handler</code>: Creates personalized adventures based on user-selected themes, enabling tailored exploration.  </li>
<li><code class="inline-code">explore_quest.handler</code>: Facilitates deeper exploration of specified quests, enhancing the adventurer&#39;s understanding of Codethos.  </li>
<li><code class="inline-code">view_progress.handler</code>: Monitors quest progress, ensuring adventurers can measure their achievements.</li>
</ul>
<pre><code class="language-typescript">export const tools = {  
  start_adventure,  
  choose_theme,  
  explore_quest,  
  view_progress  
};  
</code></pre>
<ul>
<li>Aggregates all Mystic Tools into a unified object for efficient registration and handling within the MCP.  </li>
<li>Simplifies tool management, ensuring extensibility and maintainability.  </li>
<li>Promotes compliance with the MCP&#39;s conventions by aligning tool exports to predefined standards.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the <code class="inline-code">setupHandlers</code> function as a guide to add new tools or extend validations for existing ones.  </li>
<li>Investigate how <code class="inline-code">main</code> ensures seamless server operation and correct error handling patterns.  </li>
<li>Study the exported <code class="inline-code">tools</code> object to understand its structure for modular design and extensibility.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Huzzah, valiant hero, by completing &quot;Quest 2: The Mystic Tools of MCP,&quot; you‚Äôve harnessed the arcane wisdom of the ancients and taken a triumphant stride through the Labyrinth of Learning, earning your rightful place among the chosen on this grand odyssey! ‚öîÔ∏èüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>