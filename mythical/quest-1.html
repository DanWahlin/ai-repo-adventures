<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Forge of the MCP Guild - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Repository: A Hero's Tale</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Forge of the MCP Guild</h1>
<hr>
<p>In the mystical kingdom of Codemantle, the guild of Modelcraft Protocols (MCP) watches over repositories of knowledge. Deep within their archives lies the <strong>Mystic Forge</strong>, where enchanted tools are crafted to aid adventurers on their quests. Yet, the forge is inert without the secrets of the <strong>Codex of Creation</strong>, which governs these tools&#39; behavior and their magical purposes. It is whispered that the magical algorithms behind the forge‚Äôs operation are scattered across the realm‚Äôs sacred texts. Will you summon the wisdom to uncover them, brave adventurer, and unlock the secrets of the MCP tools?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Call of the Codex</strong>: How does the system dynamically generate and list available tools for adventurers to wield?</li>
<li>‚ö° <strong>Enchantment Unveiled</strong>: What happens during the execution of a tool, and what mechanisms ensure safe operation?</li>
<li>üõ°Ô∏è <strong>Fortress Defenses</strong>: How does the system handle unexpected errors during tool execution and maintain stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>: The Enchanted Server</h3>
<p>Guarding the gates of the Mystic Forge, the <code class="inline-code">RepoAdventureServer</code> is the heart of the MCP Guild‚Äôs operations. This file sets up the mystical protocols that define interactions between adventurers and the guild. Core functionality includes dynamically revealing the guild‚Äôs tools and executing them safely. It ensures no dark magic (errors) disrupts the realm‚Äôs harmony. The <code class="inline-code">main</code> function initializes the server, while <code class="inline-code">setupHandlers</code> and <code class="inline-code">run</code> govern its operations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the server to list tools dynamically and handle their execution with schema validations. This function is crucial for interfacing with adventurers and ensuring safe tool use.</li>
<li><code class="inline-code">run</code>: Activates the server and triggers preparatory background tasks like project analysis to warm up the Mystic Forge.</li>
<li><code class="inline-code">main</code>: Oversees the graceful startup and shutdown of the server, reacting to signals and unhandled promises to ensure stability.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically generates a tool list by iterating through all available tools and converts their schemas to JSON, keeping the Mystic Forge adaptable.</li>
<li>Validates parameters using Zod schema to protect against misuse of tools, ensuring only validated energy flows through the forge.</li>
<li>Catches errors gracefully, throwing meaningful messages to adventurers when a tool fails or inputs are invalid.</li>
<li>Handles unknown tool invocations by raising <code class="inline-code">MethodNotFound</code>, safeguarding the kingdom‚Äôs stability.</li>
<li>Separates tool validation and execution, demonstrating modular design and focus on safety.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Starts the server using <code class="inline-code">StdioServerTransport</code>, enabling communication with MCP adventurers via a mystic channel.</li>
<li>Logs its initialization with clear context, ensuring adventurers know the forge is active.</li>
<li>Pre-generates <code class="inline-code">repomix</code> content in the background, demonstrating proactive configuration to enhance subsequent tool use.</li>
<li>Leverages asynchronous operation for performance, avoiding blocking actions in the main flow.</li>
<li>Centralizes the warm-up process, reducing runtime delays later.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes and runs the <code class="inline-code">RepoAdventureServer</code>, ensuring all handlers and protocols are correctly configured.</li>
<li>Registers graceful shutdown hooks with <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, preventing abrupt disruptions to the realm‚Äôs delicate balance.</li>
<li>Logs unhandled rejections to facilitate debugging while keeping the server resilient against minor errors.</li>
<li>Manages catastrophic startup failures by logging the issue and exiting, preventing a half-operational forge from causing chaos.</li>
<li>Wraps operations in a <code class="inline-code">try-catch</code> block to ensure the system remains stable regardless of initialization errors.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review <code class="inline-code">setupHandlers</code> to understand how tools are defined, validated, and executed dynamically. This is the heart of the Mystic Forge‚Äôs flexibility.</li>
<li>Observe how <code class="inline-code">run</code> preps the system by pre-generating content. Consider how this optimization aids future tasks.</li>
<li>Examine <code class="inline-code">main</code> to see robust startup and error-handling strategies, which keep the rest of the kingdom safe.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Codex and the MCP Guild.</p>
<p>With valor unmatched and wisdom forged in celestial flames, you have emerged victorious in Quest 1 of the Mystic Forge, illuminating the path ahead for the realm&#39;s grand saga! ‚≠ê‚öîÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>