<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Instrument of the MCP - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of the Enchanted Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Instrument of the MCP</h1>
<hr>
<p>In the mythical Kingdom of Repositoria, the scrolls have fallen into entropy, causing a rift between the realms of structure and chaos. Within the castle‚Äôs enchanted workspace lies the Mystic Instrument of the MCP (Model Context Protocol), a tool of immense power designed to weave order into the codebase tapestry. The Master Codewrights have summoned you, the Hero of Syntax, to delve into this instrument‚Äôs design, uncover its secrets, and reinstate balance to the Kingdom through your wisdom.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Handler Enchantment</strong>: How does <code class="inline-code">RepoAdventureServer</code> use <code class="inline-code">setupHandlers</code> to dynamically register and validate mystical tools in a way that supports modularity and flexibility?</li>
<li>‚ö° <strong>Awakening the Server</strong>: What role does the <code class="inline-code">run</code> function play in activating the server amidst both initialization rituals and background preparation? </li>
<li>üõ°Ô∏è <strong>Safeguard of Continuity</strong>: How does the <code class="inline-code">main</code> function implement graceful shutdown and error resilience to ensure the kingdom‚Äôs stability, even during unforeseen interruptions?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Server‚Äôs Enchanted Framework</h3>
<p>This file acts as the cornerstone for the MCP‚Äôs operations, defining the server‚Äôs structural magic. It includes the <code class="inline-code">RepoAdventureServer</code>, which encapsulates key functions such as <code class="inline-code">setupHandlers</code> for managing tool registration and <code class="inline-code">run</code> for initiating operational flows. Additionally, it defines the <code class="inline-code">main</code> method for invocation rituals and spell-binding resilience against errors and abrupt terminations.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: This function dynamically lists and validates tools against schema definitions. It ensures that only well-defined tools are engaged, reinforcing modular adaptability and protecting against malformed invocations.</li>
<li><code class="inline-code">run</code>: Activates the Mystic Instrument, connecting transports to initiate communication channels and premixing code context for a smooth adventure narrative. It also runs background preparations for enhancing responsiveness.</li>
<li><code class="inline-code">main</code>: Orchestrates the activation ceremony and safeguards continuity through signal handling and error resilience, ensuring the server remains stalwart amidst disruptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically retrieves all registered tools, ensuring schema-based metadata is available for clients. </li>
<li>Utilizes the Zod library for input validation, strengthening robustness against schema mismatches.</li>
<li>Implements error-handling constructs to isolate and address both external and internal failures during execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Connects the server‚Äôs logical core to its communication transport, synchronizing data exchange with external agents.</li>
<li>Orchestrates cache pre-generation to minimize latency during real-time tool interactions and optimize client experience.</li>
<li>Logs operational readiness, ensuring any activation errors are immediately visible for resolution.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Executes the server&#39;s activation sequence while implementing graceful shutdown hooks to catch termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) and ensure cleanup operations.</li>
<li>Logs unhandled promises for debugging without crashing the server, preserving operational availability.</li>
<li>Centralizes error reporting and prevention of system-wide termination through fault-tolerant patterns.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with Zod‚Äôs schema validation and its role in ensuring tool compatibility within the MCP.</li>
<li>Observe the ‚Äúpre-generation‚Äù process in <code class="inline-code">run</code> for insights on optimizing server responses.</li>
<li>Recognize how graceful shutdown mechanisms are implemented to protect ongoing operations.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the triumphant echoes of ancient bards singing your name, brave hero, you have claimed the Mystic Instrument of the MCP, unlocking the first gem of knowledge on your legendary path‚Äîmay your next quests shine even brighter in the annals of the stars! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>