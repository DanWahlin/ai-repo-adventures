<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Mystic Interface of Codathia - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Enchanted Kingdom of Code</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Mystic Interface of Codathia</h1>
<hr>
<p>Within the enchanted halls of Codathia, the fabled MCP (Magical Codex Protocol) Server hums with latent magic, connecting the many tools and spells of the kingdom. For generations, scribes and coder-knights have honed its design to house tools that balance wisdom and power. Alas, the kingdom faces peril: a great entropy looms, disrupting the sacred harmony. Your charge, noble coder-knight, is to read the mystical scroll of <code class="inline-code">server.ts</code> and <code class="inline-code">tools.ts</code>, where the keystones of Codathia‚Äôs tool interface are laid. Let us uncover its secrets to wield this power for the realm‚Äôs salvation.  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Interface Chronicle</strong>: How does the <code class="inline-code">setupHandlers</code> function dynamically connect tools to the MCP server, and what patterns does it use?  </li>
<li>‚ö° <strong>Activation Pattern</strong>: What steps are involved in the initialization of the MCP server in the <code class="inline-code">run</code> function, and how does it facilitate the pre-generation of repomix content?  </li>
<li>üõ°Ô∏è <strong>Error Ward</strong>: How is error handling implemented within the <code class="inline-code">setupHandlers</code> and <code class="inline-code">main</code> functions, and what safeguards exist to ensure the kingdom‚Äôs resilience even in times of chaos?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Heart of the MCP Interface</h3>
<p>This file serves as the mystical bridge between MCP tools and the greater Codex. It instantiates the <code class="inline-code">RepoAdventureServer</code>, whose primary responsibility is the dynamic registration of tools, managing requests, and ensuring that the server operates harmoniously. Notable highlights include the <code class="inline-code">setupHandlers</code> function for dynamic tool listing and execution, the <code class="inline-code">run</code> function for initializing the MCP server, and the <code class="inline-code">main</code> function for orchestrating the full system launch.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Establishes the tool registry and manages request handling dynamically with schemas for validation, using Zod for strictly enforcing tool compatibility.  </li>
<li><code class="inline-code">run</code>: Launches the MCP server with transport protocols while pre-generating analytical content to optimize subsequent user queries.  </li>
<li><code class="inline-code">main</code>: The launchpad of the MCP server, orchestrating setup, signal handling for graceful shutdowns, and recovery mechanisms for unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools with schemas, enabling modular registration without hardcoding each individual tool.  </li>
<li>Uses Zod to enforce strict parameter validation for tool usage, ensuring interface reliability.  </li>
<li>Implements robust error handling with specific error codes to guide users toward resolving invocation issues.  </li>
<li>Decouples tool logic from server initialization, embodying the principle of separation of concerns.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Activates the MCP server using a standard I/O transport for communication between tools and external clients.  </li>
<li>Pre-generates project analysis (repomix), reducing latency for future tool queries and improving efficiency.  </li>
<li>Primed for real-time interaction while warming up caches asynchronously in the background.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>Coordinates the initialization of the MCP server and ensures seamless signal handling to prevent abrupt terminations.  </li>
<li>Logs unhandled promise rejections while preserving server integrity, an essential fallback strategy for mission-critical systems.  </li>
<li>Demonstrates a layered error-handling strategy to intercept and resolve issues early in the launch process.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Always include appropriate tool descriptions and schemas in the <code class="inline-code">tools</code> object for the MCP interface to function correctly.  </li>
<li>Explore server structure to understand how the handling of dynamic tools enhances modularity.  </li>
<li>Investigate <code class="inline-code">tools.ts</code> next to gain insights into the individual handlers and their inputs.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>By the radiant stars of Codathia and the triumph of heroic wisdom, you have unlocked the sacred gateway of the Mystic Interface, forging the first step in the celestial odyssey toward becoming a champion of the realm! ‚ö°üíéüöÄ</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>