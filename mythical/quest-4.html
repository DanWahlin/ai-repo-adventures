<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Harness the Arcane Eye - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Kingdom of Enchanted Code: An Epic Repository Adventure</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Harness the Arcane Eye</h1>
<hr>
<p>In the mystical Kingdom of Codethia, the Repository Tome whispers of an ancient spell embedded within the enchanted repositories. This spell, known as the <strong>Arcane Eye</strong>, grants those who master it the ability to divine insights from repositories and harness their magical tokens. Passing through the shimmering Portal of Parameters, you must decipher the instructions of two powerful scrolls: the <code class="inline-code">llm-client.ts</code> and <code class="inline-code">repo-analyzer.ts</code>. Beware, adventurer ‚Äì the Arcane Eye is as dangerous as it is powerful. Stability is key to taming its magic and restoring balance to Codethia.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Token Tapestry Insight</strong>: How does the <code class="inline-code">LLMClient</code> determine token limits and adjust parameters for various magical entities like GPT-5 and OpenAI?</li>
<li>‚ö° <strong>Invocation Channels</strong>: What steps does the <code class="inline-code">RepoAnalyzer</code> take to validate project paths and ensure safe invocation of the enchanted repomix subprocess?</li>
<li>üõ°Ô∏è <strong>Defensive Wards</strong>: What protections does the system have in place against faulty, unsafe inputs or errors when communicating with the Arcane Eye?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Managing the Arcane Eye‚Äôs whispers</h3>
<p>This scroll details the <code class="inline-code">LLMClient</code>, a class responsible for communicating with the Arcane Eye, configuring its settings, and enchanting prompts. Notable highlights include its ability to choose configurations such as the correct API key, token limits, and error handling mechanisms. It also contains spells to cleanse responses and optimize token cost.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">constructor</code> initializes the eye with correct API keys and differentiates between OpenAI, Azure, and special deployments.</li>
<li><code class="inline-code">generateResponse</code> creates and validates LLM responses, adding protective wards for errors and empty results.</li>
<li><code class="inline-code">buildRequestParams</code> bridges the user‚Äôs prompt into parameters the Arcane Eye understands.</li>
<li><code class="inline-code">logTokenUsage</code> monitors how much of the Arcane energy (tokens) was consumed during an invocation.</li>
<li><code class="inline-code">cleanJsonResponse</code> sanitizes outputs, preparing them for further magical use.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL,
    });
  }
}
</code></pre>
<ul>
<li>Ensures the correct magical key and endpoint are used.</li>
<li>Differentiates between Azure OpenAI and regular OpenAI configurations.</li>
<li>Protects against improper setup with an immediate error throw.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Converts prompts into API-ready enchantments via <code class="inline-code">buildRequestParams</code>.</li>
<li>Validates and post-processes outputs to ensure usable results.</li>
<li>Logs errors and token usage for debugging Arcane Eye interactions.</li>
</ul>
<hr>
<pre><code class="language-typescript">private buildRequestParams(prompt: string, options?: LLMRequestOptions): OpenAIRequestParams {
  const requestParams: OpenAIRequestParams = {
    model: this.model,
    messages: [{ role: &#39;user&#39;, content: prompt }],
  };

  if (this.isGPT5Model()) {
    requestParams.max_completion_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.verbosity = options?.verbosity || GPT5_VERBOSITY;
    requestParams.reasoning_effort = options?.reasoningEffort || GPT5_REASONING_EFFORT;
  } else {
    requestParams.max_tokens = options?.maxTokens || LLM_MAX_TOKENS_DEFAULT;
    requestParams.temperature = LLM_TEMPERATURE;
  }
  return requestParams;
}
</code></pre>
<ul>
<li>Adjusts magical parameters and token limits specifically for GPT-5 and other models.</li>
<li>Defaults to environment-configured settings, ensuring safekeeping of the Arcane energy.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Guiding the Repository‚Äôs Path</h3>
<p>This scroll outlines the <code class="inline-code">RepoAnalyzer</code>, a class responsible for interfacing with repositories, validating paths, and calling the repomix subprocess. Protections ensure that files and paths remain secure and contain only valid content.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code> ensures paths to repositories are legitimate and safe to use.</li>
<li><code class="inline-code">captureRepomixStdout</code> invokes the powerful subprocess for analysis, guarding against timeouts and memory issues.</li>
<li><code class="inline-code">generateTargetedContent</code> optimizes repository analysis, limiting to necessary files only.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles</code> enforces safety checks on file paths to defend against malicious inputs.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Prohibits empty or unsafe project paths.</li>
<li>Protects from null bytes that could disrupt the system.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  const cached = this.cache.get(cacheKey);
  if (cached) return cached.content;

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, { include: safeFiles.join(&#39;,&#39;), compress });
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>Focuses participation to only validated files, sparing unnecessary processing.</li>
<li>Leverages caching to reduce repeated computations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    let stdout = &#39;&#39;;
    let stdoutSize = 0;
    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      stdoutSize += data.length;
      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        repomix.kill(&#39;SIGKILL&#39;);
      }
      stdout += data.toString();
    });
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; reject(new Error(data.toString())));
    repomix.on(&#39;close&#39;, (code) =&gt; resolve(stdout));
  });
}
</code></pre>
<ul>
<li>Executes the external repomix subprocess while enforcing memory and timeout safety.</li>
<li>Handles subprocess output cleanly, rejecting oversized results.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üßô <em>Magic Key Retrieval</em>: Study the <code class="inline-code">getApiKey</code> method in <code class="inline-code">LLMClient</code> to understand differences between configurations.</li>
<li>üîç <em>Safe Repository Analysis</em>: Use <code class="inline-code">validateAndNormalizeTargetFiles</code> to review file and path safety mechanisms.</li>
<li>‚öî <em>Error Defense</em>: Pay special attention to error management in both classes to enhance your defensive coding approach.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, brave seeker of wisdom! With the Arcane Eye now bound to your will, you ascend as a herald of enchanted truths, drawing closer to the eternal laurels of the kingdom&#39;s destiny‚Äîlet the stars rejoice in your triumph! ‚≠ê‚ö°üëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>