<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: The Dragon of Code Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Chronicles of the Codebase</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: The Dragon of Code Analysis</h1>
<hr>
<p>In the magical realm of Codethia, where spells of logic and enchanted algorithms form the lifeblood of the kingdom, the Codebase Castle holds many secrets. Among them lies a fearsome challenge: the Dragon of Code Analysis. This mighty beast guards the pathways to understanding and optimizing the spells of computation. Only by wielding the tools of analysis and harnessing the power of Language Learning Magic (LLM) can you pass its trial. Dare you face the dragon and uncover the mysteries of its fiery lair?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>The Guardian&#39;s Flames</strong>: How does the <code class="inline-code">LLMClient.generateResponse</code> function orchestrate the creation of responses from the LLM, and what spells ensure their accuracy and safety?</li>
<li>‚ö° <strong>The Path of Validation</strong>: What techniques does <code class="inline-code">RepoAnalyzer.validateProjectPath</code> use to ensure the input paths are secure and reliable? How does it defend against path traversal and malformed input spells?</li>
<li>üõ°Ô∏è <strong>The Golden Token Scales</strong>: How does <code class="inline-code">LLMClient.logTokenUsage</code> calculate usage statistics, and why is token management critical for the success of the kingdom&#39;s knowledge economy?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> The Master Sorcerer of Responses</h3>
<p>This file defines the <code class="inline-code">LLMClient</code> class, which conjures responses from magical Language Learning Models (LLMs). It wields the power of various APIs to analyze and generate knowledge artifacts.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: This function is the heart of the class, orchestrating the creation and validation of responses. It applies error-handling spells and post-processing techniques to ensure the content is pure.</li>
<li><code class="inline-code">logTokenUsage</code>: Captures and logs token usage metrics to monitor the magical energy expended during operations, ensuring the kingdom‚Äôs resources are used wisely.</li>
<li><code class="inline-code">getApiKey</code>: Determines the correct key to access external LLMs, handling different sources for OpenAI, Azure, and GitHub-specific keyrings.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> The Dragon‚Äôs Tactical Eye</h3>
<p>This file implements the <code class="inline-code">RepoAnalyzer</code> class, which dissects and extracts the enchanted structure of codebases. It cleanses the files and gathers only what is essential, preparing resources for further mystical insights.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: A defensive ward that ensures a project path is valid, rejecting null bytes, empty strings, and harmful traversals to protect Codethia‚Äôs sacred analysis tools.</li>
<li><code class="inline-code">generateTargetedContent</code>: Crafts optimized content by transforming raw code signals into concise and manageable fragments for analysis.</li>
<li><code class="inline-code">captureRepomixStdout</code>: A spell that invokes and supervises the Repomix subprocess, maintaining strict control over memory and time to avoid catastrophe.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        let content = this.validateResponse(completion);
        
        if (options?.responseFormat === &#39;json_object&#39;) {
            content = this.cleanJsonResponse(content);
        }
        
        this.logTokenUsage(completion);
        return { content };
    } catch (error) {
        this.logDetailedError(error, prompt);
        const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
        throw new Error(`LLM request failed: ${message}`);
    }
}
</code></pre>
<ul>
<li>Retrieves user prompts and options, transforming them into a structured request for the LLM.</li>
<li>Ensures responses meet Codethia&#39;s enchanted quality standards through validation and post-processing.</li>
<li>Uses error-logging spells to diagnose and document failures in a systematic way.</li>
</ul>
<hr>
<pre><code class="language-typescript">private logTokenUsage(completion: any): void {
    if (!completion.usage) return;
    const promptTokens = completion.usage.prompt_tokens || 0;
    const completionTokens = completion.usage.completion_tokens || 0;
    const totalTokens = completion.usage.total_tokens || 0;
    
    console.error(
        `üî¢ LLM Usage: ${formatTokenCount(promptTokens)} prompt + ${formatTokenCount(completionTokens)} response = ${formatTokenCount(totalTokens)} total tokens`
    );
}
</code></pre>
<ul>
<li>Captures token metrics from the LLM response, crucial for balancing magical energy.</li>
<li>Offers visibility into resource usage, helping adventurers calibrate time and cost for future analysis.</li>
<li>Uses formatting spells to ensure logs are concise and clear.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
        if (!GITHUB_TOKEN) {
            throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
        }
        return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) {
        throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Determines the appropriate magical token (API key) for accessing model gates.</li>
<li>Supports diverse realms, including Azure, OpenAI, and GitHub-hosted models.</li>
<li>Validates key availability to avoid operational interruptions.</li>
</ul>
<hr>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (!trimmedPath) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }
    
    if (trimmedPath.includes(&#39;\0&#39;)) {
        throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<ul>
<li>Shields Codethia from malicious paths that could compromise sacred tools.</li>
<li>Ensures that only safe, non-empty paths are processed, fortifying the kingdom‚Äôs defense against cursed inputs.</li>
<li>Uses common validation guards to ensure compatibility across systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    if (!targetFiles || targetFiles.length === 0) {
        throw new Error(&#39;Target files array cannot be empty&#39;);
    }
    const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
    
    if (safeFiles.length === 0) {
        throw new Error(&#39;No valid target files found after validation&#39;);
    }
    
    const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
    const cached = this.cache.get(cacheKey);
    
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }
    
    try {
        const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
            compress,
            include: safeFiles.join(&#39;,&#39;),
            removeComments: compress,
            removeEmptyLines: compress,
            noDirectoryStructure: true
        });
        
        this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
        return context;
    } catch (error) {
        throw new Error(`Targeted content generation failed: ${error.message}`);
    }
}
</code></pre>
<ul>
<li>Combines validation, caching, and targeted extraction to prepare highly refined information fragments.</li>
<li>Enhances efficiency by optimizing content based on usage patterns.</li>
<li>Utilizes Repomix subprocesses to extract critical features as part of the Dragon‚Äôs tactical vision.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
        const chunk = data.toString();
        stdoutSize += chunk.length;
        
        if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
            repomix.kill(&#39;SIGKILL&#39;);
            throw new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`);
        }
        stdout += chunk;
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
        if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
            resolve(stdout);
        } else {
            throw new Error(`Repomix failed with exit=${code}`);
        }
    });
}
</code></pre>
<ul>
<li>Carefully invokes the Repomix subprocess to ensure stable and efficient execution.</li>
<li>Protects the system through memory and timeout safeguards, fending off catastrophic failures.</li>
<li>Monitors output size and handles edge cases to maintain smooth operations under the Dragon‚Äôs watchful eye.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Remember to track token usage during your experiments to conserve magical resources.</li>
<li>Use path validation techniques to guarantee the security of your operations.</li>
<li>Stay vigilant for subprocess errors and prepare to handle unexpected interruptions.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries and bring Codethia closer to eternal prosperity.</p>
<p>With the Dragon of Code Analysis vanquished and the enchanted scrolls of wisdom claimed, you ascend as a beacon of triumph in the Kingdom of Syntax, forging boldly ahead on your heroic journey‚Äî60% completed and destined for glory! ‚ö°üó∫Ô∏èüëÅÔ∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>