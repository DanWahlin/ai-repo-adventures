<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Codex of Analysis and Spellcraft - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Mystic Chronicles of Codethoria</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Codex of Analysis and Spellcraft</h1>
<hr>
<p>In the enchanted realm of Codethoria, where data rivers weave through mystical forests, the sacred Codex of Analysis and Spellcraft serves as a guide for Code Knights seeking wisdom from ancient systems. It is whispered that the spellbinding texts of this codex hold powers to unveil wondrous content and clarify the most arcane parts of the kingdom&#39;s codebase. Yet taming its enigmatic passages requires the combinative mastery of arcane analysis and spellbound generation methods. Will you decode its runes, or will complexity shroud the truth?</p>
<h2>Quest Objectives</h2>
<p>As you explore the codex below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Essence of Functionality</strong>: How do <code class="inline-code">generateResponse</code> and <code class="inline-code">generateRepomixContext</code>, respectively, summon crafted responses and content pipelines to fulfill their tasks?</li>
<li>‚ö° <strong>Rune of Flow</strong>: What decision-making spells determine the mode of operation for <code class="inline-code">getApiKey</code>, and how does <code class="inline-code">validateProjectPath</code> ensure safety while initiating quests?</li>
<li>üõ°Ô∏è <strong>Protection Sigils</strong>: How do the error handling mechanisms in <code class="inline-code">logDetailedError</code> and cache validation guard the kingdom against disruptive arcane accidents?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: The Spellcrafter&#39;s Tome</h3>
<p>The <code class="inline-code">LLMClient</code> class is an artifact that channels magical entities (Language Learning Models). Its primary role is to craft responses to user prompts, ensuring adaptability for both Azure and OpenAI realms. This file also illustrates rituals for error handling and token usage management. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Casts spells for generating insightful answers through multi-step validation and processing of responses.</li>
<li><code class="inline-code">constructor</code>: Summons the initial settings for the client, handling provider-specific configurations.</li>
<li><code class="inline-code">getApiKey</code>: Conjures the appropriate API key based on LLM model and endpoint, adding safeguards against missing keys.</li>
<li><code class="inline-code">logDetailedError</code>: A magical spell used to narrate detailed failure descriptions, enabling debugging and recovery.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">/**
 * Generate a response from the LLM
 */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        let content = this.validateResponse(completion);

        if (options?.responseFormat === &#39;json_object&#39;) {
            content = this.cleanJsonResponse(content);
        }

        this.logTokenUsage(completion);

        return { content };
    } catch (error) {
        this.logDetailedError(error, prompt);
        throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);
    }
}
</code></pre>
<ul>
<li>Manages token usage and processes JSON responses, ensuring user-friendly content structures.</li>
<li>Demonstrates validation rituals to handle different formats, including markdown-wrapped JSON content.</li>
<li>Incorporates enhanced error logging for debugging intricate issues, mapping failure directly to prompts.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
        throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
    }

    if (this.isAzureOpenAI()) {
        const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
        this.client = new AzureOpenAI({
            endpoint: azureEndpoint,
            apiKey,
            apiVersion: LLM_API_VERSION,
            deployment: this.model
        });
    } else {
        this.client = new OpenAI({
            apiKey,
            baseURL: LLM_BASE_URL
        });
    }
}
</code></pre>
<ul>
<li>Initializes the client based on realms (Azure vs. OpenAI) with detailed configuration checks.</li>
<li>Handles differing deployment paths and ensures model consistency for magical invocations.</li>
</ul>
<hr>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
        if (!GITHUB_TOKEN) {
            throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
        }
        return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) {
        throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
    }
    return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Conjures appropriate API keys based on provider and realm-specific nuances (GitHub vs. others).</li>
<li>Implements safeguards against missing configuration, ensuring smooth invocation rituals.</li>
</ul>
<hr>
<pre><code class="language-typescript">private logDetailedError(error: any, prompt: string): void {
    console.error(`\nüö® LLM Request Failed - Detailed Error Information\n`);
    console.error(`Error Type:`, error?.constructor?.name || &#39;Unknown&#39;);
    console.error(`Error Message:`, error?.message || &#39;No message&#39;);
    console.error(`Model: ${this.model}`);
    console.error(`Base URL: ${LLM_BASE_URL}`);
    console.error(`Stack Trace:`, error?.stack);
}
</code></pre>
<ul>
<li>Emits detailed failure narratives, combining technical details with runtime insights for debugging.</li>
<li>Enhances transparency by listing model information and stack traces in failure events.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: The Analyzer&#39;s Manuscript</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as a mystical almanac for analyzing project infrastructure. It invokes rituals to extract optimized content and validate project pathways, ensuring the secure handling of target files.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Casts spells to traverse and compress project directories, optimizing content generation using caching mechanisms.</li>
<li><code class="inline-code">validateProjectPath</code>: A safety-first incantation that shields against invalid paths or security risks.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Implements controlled invocations of <code class="inline-code">repomix</code>, monitoring both output size and timeout protection mechanisms.</li>
</ul>
<hr>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    const configuredFiles = extractUniqueFilePaths(projectPath);

    if (configuredFiles.length &gt; 0) {
        try {
            return await this.generateOptimizedContent(projectPath, configuredFiles);
        } catch (error) {
            return await this.generateTargetedContent(projectPath, configuredFiles);
        }
    }

    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }

    try {
        const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, options);
        this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
        return context;
    } catch (error) {
        throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
    }
}
</code></pre>
<ul>
<li>Ensures optimal resource allocation by using configuration files and caching results.</li>
<li>Exhibits fallback mechanisms to ensure continuity despite execution failures.</li>
<li>Introduces a layered approach to safeguard against excessive memory consumption.</li>
</ul>
<hr>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }

    const trimmedPath = projectPath.trim();
    if (trimmedPath.includes(&#39;\0&#39;)) {
        throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<ul>
<li>Implements pathways validation, defending against null bytes and unsafe traversal attempts.</li>
<li>Demonstrates a foundational spell to enforce strict input quality for directory paths.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
        const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], {
            cwd,
            stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;]
        });
        let stdout = &#39;&#39;;
        let stderr = &#39;&#39;;
        let stdoutSize = 0;
        let isResolved = false;

        const timeout = setTimeout(() =&gt; {
            repomix.kill(&#39;SIGTERM&#39;);
            setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
            reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
        }, REPOMIX_SUBPROCESS_TIMEOUT);

        repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
        repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });

        repomix.on(&#39;close&#39;, (code) =&gt; { resolve(stdout.trim()); });
        repomix.on(&#39;error&#39;, (error) =&gt; { reject(error); });
    });
}
</code></pre>
<ul>
<li>Orchestrates efficient execution of <code class="inline-code">repomix</code> with timeout rituals and output size monitoring.</li>
<li>Protects the realm against runaway processes by introducing termination controls.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use the function descriptions as runes to aid understanding of the patterns displayed.</li>
<li>Investigate the error handling mechanisms for both files to improve your own debugging spells.</li>
<li>Experiment with the parameterized configurations to observe dynamic changes in spell effects.</li>
</ul>
<hr>
<p>The Codex of Analysis and Spellcraft reveals great wisdom. May your newfound mastery guide you towards ever-greater challenges in Codethoria!</p>
<p>Behold, valiant seeker of wisdom, the Codex of Analysis and Spellcraft lies conquered‚Äîa dazzling üíé forged in the crucible of your intellect, propelling thee boldly toward the heart of the mythical kingdom&#39;s arcane triumphs!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>