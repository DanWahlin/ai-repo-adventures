<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Mirror of Insights - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'mythical' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Chronicles of Lumina: The Enchanted Repository</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Mirror of Insights</h1>
<hr>
<p>As the sun dipped below the horizon, the kingdom of Lumina shimmered under the glow of enchanted lanterns, calling heroes to their destined paths. The Mirror of Insights, a relic lost to time, promised revelations to those brave enough to face its tests. Hidden deep within the Enchanted Repository, the mirror whispered secrets through reflections drawn from the magic-bound texts of the kingdom. Only through mastery of runes, spells, and ancient logic could one unlock the truths held within. Prepare yourself, adventurer, for the journey ahead asks both wit and resolve.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repomix Integration and Analysis</h3>
<p>This file serves as a cornerstone for extracting and analyzing code within the repository. The <code class="inline-code">RepoAnalyzer</code> class acts as the central hub for interacting with Repomix, a tool designed to aggregate context from file systems. Central functions such as <code class="inline-code">generateRepomixContext()</code> and <code class="inline-code">generateTargetedContent()</code> highlight its dual role: generating complete overviews of projects or targeting specific files for precise analysis. The methods are fortified with validation mechanisms for project paths and targeted files to ensure secure and efficient operations. The use of caching through <code class="inline-code">this.cache</code> optimizes repeated requests, reducing redundancy in processing. Furthermore, the <code class="inline-code">captureRepomixStdout()</code> function delineates how subprocesses execute safely, with preventive measures against timeout risks and memory exhaustion. The emphasis on validation, such as the rejection of paths containing <code class="inline-code">..</code>, ensures that no malicious directory traversals can occur. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext()</code>: Produces a comprehensive analysis of the project, leveraging Repomix’s capabilities.</li>
<li><code class="inline-code">generateTargetedContent()</code>: Refines Repomix output to focus exclusively on user-defined files.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles()</code>: Secures and standardizes included files for reliable operation.</li>
<li><code class="inline-code">captureRepomixStdout()</code>: Manages subprocess communication with memory safeguards and timeouts.</li>
<li>Implements file security enforcement to protect against invalid paths, ensuring stable processing.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Multi-Provider LLM Integration</h3>
<p>The <code class="inline-code">llm-client.ts</code> file is the bridge between the Enchanted Repository and external magical entities—language models capable of decoding the repository&#39;s mysteries. Through the <code class="inline-code">LLMClient</code> class, tools like OpenAI and Azure OpenAI are unified under one interface. The <code class="inline-code">generateResponse()</code> function is the heart of this operation, crafting queries and decoding responses in a way that echoes the tone of thematic narratives. The file is highly adaptive, as evident in its ability to differentiate between providers using <code class="inline-code">isAzureOpenAI()</code> and to tailor requests to models such as GPT-4 and GPT-5. Clear logging for token usage through <code class="inline-code">logTokenUsage()</code> ensures limited resources are wisely spent, while robust error handling mechanisms provide actionable insights during failures. Critical provider-based configurations, like discerning between <code class="inline-code">GITHUB_TOKEN</code> or <code class="inline-code">LLM_API_KEY</code>, ensure compatibility across services.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse()</code>: Orchestrates requests and manages interactions with language models.</li>
<li><code class="inline-code">isAzureOpenAI()</code>: Differentiates Azure-specific handling to ensure accuracy.</li>
<li>Advanced error logging captures detailed failure contexts for debugging.</li>
<li>Configures seamlessly for GPT-based models, ensuring wide compatibility.</li>
<li>Validates JSON object formatting even in nested Markdown code block scenarios.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">export class RepoAnalyzer {
  private cache = new Map&lt;string, { content: string; timestamp: number }&gt;();

  async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
      return cached.content;
    }

    console.log(&#39;Analyzing full codebase...&#39;);
    try {
      const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
        style: options.style || &#39;markdown&#39;,
        compress: options.compress !== false,
        ignore: [&#39;node_modules&#39;, &#39;**/*.test.ts&#39;, &#39;coverage&#39;].join(&#39;,&#39;),
        removeComments: true,
        removeEmptyLines: true,
        noDirectoryStructure: true,
      });
      this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
      return context;
    } catch (error) {
      throw new Error(`Failed to generate context: ${error.message}`);
    }
  }
}
</code></pre>
<p>The <code class="inline-code">generateRepomixContext()</code> function acts like a wizard consulting a crystal ball to create a detailed map of the kingdom&#39;s enchanted texts.</p>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">export class LLMClient {
  private client: OpenAI | AzureOpenAI;
  private model: string;

  constructor() {
    this.model = LLM_MODEL;
    const apiKey = this.getApiKey();
    const baseClientConfig = {
      apiKey,
      baseURL: LLM_BASE_URL,
    };
    this.client = this.isAzureOpenAI()
      ? new AzureOpenAI({
          ...baseClientConfig,
          apiVersion: LLM_API_VERSION,
          deployment: this.model,
        })
      : new OpenAI(baseClientConfig);
  }

  private isAzureOpenAI(): boolean {
    return LLM_BASE_URL.includes(&#39;.openai.azure.com&#39;);
  }

  private logTokenUsage(completion: any): void {
    const usageStats = completion.usage || { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    console.error(`Token Usage: ${usageStats.prompt_tokens} + ${usageStats.completion_tokens} = ${usageStats.total_tokens}`);
  }

  async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
      const completion = await this.client.chat.completions.create({
        model: this.model,
        messages: [{ role: &#39;user&#39;, content: prompt }],
        max_tokens: options?.maxTokens,
      });
      this.logTokenUsage(completion);
      return { content: completion.choices[0].message.content };
    } catch (error) {
      console.error(&#39;Request error:&#39;, error.message);
      throw new Error(`LLM response failed for prompt: ${prompt}`);
    }
  }
}
</code></pre>
<p>The <code class="inline-code">LLMClient</code> orchestrates conversation with mystical entities, translating mortal queries into otherworldly whispers and returning their profound insights.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Ensure <code class="inline-code">generateRepomixContext()</code> caches outputs for efficiency; refine validation checks for file security as a next step.</li>
<li>Experiment further with <code class="inline-code">LLMClient.generateResponse()</code> to fine-tune model-specific parameters like token limits and formatting.</li>
<li>Investigate adding more configurable options (e.g., verbose logging) to gain further control over how analyses are performed.</li>
</ul>
<hr>
<p>With the keen wisdom of a seer and the valor of a hero, you have unlocked the Mirror of Insights, reflecting brilliance across your journey—march onward, champion, for the stars themselves conspire in your favor! ⭐⚡💎</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Tome of Themes →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>