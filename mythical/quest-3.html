<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Realm of Enchanted Repositories</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle of Analysis</h1>
<hr>
<p>In Codemia&#39;s enchanted kingdom, myths whisper of the Oracle of Analysis, a mystical being whose insights hold the key to unlocking the Repository of Knowledge&#39;s deepest secrets. Guarded by labyrinthine complexity and arcane algorithms, the Oracle only reveals its truth to those who prove their worth by mastering the magic of code analysis. Brave adventurer, you must face the challenge and wield the powers of <code class="inline-code">RepoAnalyzer</code> and the <code class="inline-code">LLMClient</code> to summon clarity from the depths of Codemia’s enchanted lines.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Code Analysis Engine</h3>
<p>This file serves as the cornerstone of Codemia&#39;s code analysis system, embracing the power of Repomix to transform chaotic repositories into structured understanding. The <code class="inline-code">RepoAnalyzer</code> class acts as the wielder of magical spells, harnessing functions to validate project paths, secure target files, and create content optimized for token-based adventures. With its ability to invoke Repomix’s subprocesses, this class summons the “Repomix Context” and channels specific functions via secure caching. It is equipped with enhanced validations and optimizations, ensuring the summoning does not falter. Highlights include <code class="inline-code">generateRepomixContext</code>, <code class="inline-code">generateTargetedContent</code>, <code class="inline-code">captureRepomixStdout</code>, and <code class="inline-code">validateProjectPath</code>, each serving as a key spell in the toolkit of the Oracle.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Constructs magical insights into the code universe for targeted transformation.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Summons subprocess outputs with guarded memory bounds.</li>
<li><code class="inline-code">validateProjectPath</code>: Shields Codemia from improper path traversal and null byte schemes.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    const configuredFiles = extractUniqueFilePaths(projectPath);

    if (configuredFiles.length &gt; 0) {
        return await this.generateOptimizedContent(projectPath, configuredFiles);
    }

    const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }

    const ignorePatterns = [&#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;];
    const cliOptions: CliOptions = {
        style: options.style || &#39;markdown&#39;,
        stdout: true,
        compress: options.compress !== false,
        ignore: ignorePatterns.join(&#39;,&#39;),
        removeComments: true,
        removeEmptyLines: true,
        noDirectoryStructure: true
    };

    return await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
}
</code></pre>
<p>As the Oracle conjures its context, this function traverses the Repository to summon structured insights.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
        const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
        if (options.compress) args.push(&#39;--compress&#39;);
        const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

        let stdout = &#39;&#39;;
        repomix.stdout.on(&#39;data&#39;, (data) =&gt; stdout += data.toString());
        repomix.on(&#39;close&#39;, (code) =&gt; {
            if (code === 0) resolve(stdout);
            else reject(`Repomix failed with code ${code}`);
        });
    });
}
</code></pre>
<p>Imagine summoning a scribe to transcribe a spell—this function encapsulates the Repomix subprocess invocation gracefully.</p>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
    if (!projectPath || typeof projectPath !== &#39;string&#39;) {
        throw new Error(&#39;Project path must be a non-empty string&#39;);
    }
    if (projectPath.trim().includes(&#39;\0&#39;)) {
        throw new Error(&#39;Project path contains invalid null bytes&#39;);
    }
}
</code></pre>
<p>This validation spell ensures only pure inputs pass through, protecting the Oracle from corrupted paths.</p>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Language Model Interface</h3>
<p>Serving as Codemia&#39;s mystical scroll writer, the <code class="inline-code">LLMClient</code> bridges the gap between raw code analysis and generative storytelling. It uses APIs such as OpenAI and AzureOpenAI to channel prompts into advanced models, conjuring polished responses. With functions for comprehensive validation, dynamic API configurations, and token optimization, <code class="inline-code">LLMClient</code> empowers the Oracle by ensuring all interactions are seamless and constructive. Three notable spells, <code class="inline-code">generateResponse</code>, <code class="inline-code">constructor</code>, and <code class="inline-code">getApiKey</code>, summon the essence of Codemia&#39;s magical narrative.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Channels prompts into refined, LLM-driven insights.</li>
<li>Constructor method: Caters to diverse AI models through dynamic initialization.</li>
<li><code class="inline-code">getApiKey</code>: Ensures secure access to magical APIs.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    try {
        const requestParams = this.buildRequestParams(prompt, options);
        const completion = await this.executeRequest(requestParams);
        let content = this.validateResponse(completion);

        if (options?.responseFormat === &#39;json_object&#39;) {
            content = this.cleanJsonResponse(content);
        }

        return { content };
    } catch (error) {
        throw new Error(`LLM request failed: ${error.message}`);
    }
}
</code></pre>
<p>With the flourish of a wand, this spell transforms raw input into creative wisdom from the enchanted LLM.</p>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    const apiKey = this.getApiKey();
    if (!apiKey || !LLM_BASE_URL) {
        throw new Error(&#39;LLM configuration required.&#39;);
    }

    this.client = LLM_BASE_URL.includes(&#39;openai.azure.com&#39;)
        ? new AzureOpenAI({ endpoint: LLM_BASE_URL, apiKey, deployment: this.model })
        : new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
}
</code></pre>
<p>Like an architect constructing a castle, this method ensures dynamic adaptation to Codemia&#39;s magical infrastructure.</p>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
        if (!GITHUB_TOKEN) throw new Error(&#39;GITHUB_TOKEN required for GitHub Models&#39;);
        return GITHUB_TOKEN;
    }
    if (!LLM_API_KEY) throw new Error(&#39;LLM_API_KEY required.&#39;);
    return LLM_API_KEY;
}
</code></pre>
<p>A key to Codemia’s treasure vault, this function grants access to infinite possibilities through its API links.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Before invoking <code class="inline-code">generateRepomixContext</code>, ensure project paths are valid and target files correctly normalized to avoid runtime errors.</li>
<li>Use <code class="inline-code">generateResponse</code> to refine raw code contexts into enriched, user-facing insights.</li>
<li>Explore how caching mechanisms in both classes reduce redundant processes to optimize resource usage.</li>
</ul>
<hr>
<p>With wisdom granted by the Oracle of Analysis, you have revealed hidden truths and gained the knowledge to shape Codemia’s magical codebase. Adventure onward, hero!</p>
<p>With the wisdom of the Oracle now woven into your heroic tapestry, you ascend as the star-forged champion of analysis, forging boldly through the realms—onto greater conquests and eternal glory! ⭐⚡💎</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Codex of Themes →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>