<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Watcher‚Äôs Eye - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'mythical' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Enchanted Repository: Chronicles of the Code Realm</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Watcher‚Äôs Eye</h1>
<hr>
<p>The Enchanted Repository hummed with mystical energy as you entered its shadowy depths once more. A new challenge had surfaced: &quot;The Watcher‚Äôs Eye&quot;. This artifact of ancient magic is said to peer into the heart of any codebase, unraveling its secrets. To wield it, you must defeat the Guardian Scripts and untangle the threads of their intricate spells. Your bravery will be tested as you navigate enchanted validations, decipher algorithmic riddles, and battle the chaos of poorly defined inputs. Courage calls‚Äîwill you rise to master this hidden knowledge?</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Adventure Configuration Parsing and Formatting</h3>
<p>The <code class="inline-code">adventure-config.ts</code> file forms the backbone of the quest customization process. It handles the reading, parsing, and preparation of the <code class="inline-code">adventure.config.json</code> file‚Äîan enchanted manuscript that details the journey&#39;s structure. The file provides heroes with the ability to extract paths to vital files, validate their existence, and transform this data into a compelling narrative for the LLM to weave into quests. This ensures every adventure is grounded in real, applicable coding examples tailored to the user‚Äôs repository. With key functions like <code class="inline-code">parseAdventureConfig()</code> and <code class="inline-code">extractUniqueFilePaths()</code>, the file acts as the bridge between the codebase reality and the mythical world of quests. Additionally, <code class="inline-code">formatAdventureConfigForPrompt()</code> meticulously crafts story-ready prompts, combining technical precision with poetic storytelling flair.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">parseAdventureConfig()</code>: Reads and validates the <code class="inline-code">adventure.config.json</code> file, ensuring it is suitable for the quest.</li>
<li><code class="inline-code">extractUniqueFilePaths()</code>: Traverses the configuration to gather unique and valid file paths for analysis.</li>
<li><code class="inline-code">formatAdventureConfigForPrompt()</code>: Converts configuration data into structured, LLM-friendly prompts.</li>
<li>Harmonizes technical details with story elements, maintaining balance between code and fantasy.</li>
<li>Ensures invalid paths or incomplete configurations don‚Äôt derail the narrative flow.</li>
</ul>
<hr>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Code Analysis and Repomix Integration</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file wields the powers of Repomix, a tool akin to a magical scepter that extracts the essence of a repository‚Äôs code. Responsible for analyzing the codebase and crafting a secure, focused snapshot, the file protects the adventure from malicious incursions while guiding the hero through validated and normalized content. Core functions like <code class="inline-code">generateRepomixContext()</code> generate detailed maps of the repository‚Äôs structure, while <code class="inline-code">generateTargetedContent()</code> acts as a precision strike, extracting only selected files. Security is paramount, with safeguards like <code class="inline-code">validateProjectPath()</code> ensuring no mischievous paths lead the adventurer astray or threaten to break the confines of the repository‚Äôs castle walls.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext()</code>: Creates a complete, cached representation of the repository for analysis.</li>
<li><code class="inline-code">generateTargetedContent()</code>: Builds tailor-made representations of specific files.</li>
<li><code class="inline-code">captureRepomixStdout()</code>: Executes Repomix CLI and captures its analyzed output securely.</li>
<li><code class="inline-code">validateProjectPath()</code>: Shields the system from unsafe paths, null bytes, and malicious inputs.</li>
<li>Uses caching to avoid redundant analysis, ensuring efficiency during quests.</li>
</ul>
<hr>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">/**
 * Extracts unique file paths from the adventure.config.json file.
 * Ensures files exist and are processed into a usable format for prompts.
 */
export function extractUniqueFilePaths(projectPath: string): string[] {
  const rawConfig = parseAdventureConfig(projectPath); // Parses the configuration
  const seen = new Set&lt;string&gt;();
  
  return rawConfig.files
    .map(file =&gt; path.resolve(projectPath, file.path))
    .filter(filePath =&gt; {
      if (fs.existsSync(filePath) &amp;&amp; !seen.has(filePath)) {
        seen.add(filePath); // Deduplicate file paths
        return true;
      }
      return false;
    });
}
</code></pre>
<p>This function works like a treasure map, ensuring only valid paths lead to the treasure vault and marking known paths to avoid revisiting them.</p>
<hr>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">/**
 * Validate and normalize the project path.
 * Prevents against invalid paths, null bytes, and directory traversal.
 */
private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }
  const trimmedPath = projectPath.trim();
  if (!trimmedPath || trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Invalid or unsafe project path&#39;);
  }
}
</code></pre>
<p>The function acts as the castle wall, refusing entry to anything that doesn‚Äôt meet the strict criteria for safety and integrity.</p>
<hr>
<pre><code class="language-typescript">/**
 * Generate full repomix content for the given repository.
 * Includes caching and options for compression or targeted file analysis.
 */
async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath); // Ensure project path is valid
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content; // Return cached content if available
  }
  
  try {
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false
    });
    
    // Store context in cache
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<p>This function works like a magical scribe, producing enchanted scrolls that chronicle the entire castle‚Äôs layout, ready to guide a brave hero on their journey.</p>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Always tailor your <code class="inline-code">adventure.config.json</code> file to include the most educational and intriguing sections of your repository.</li>
<li>Start with broad Repomix output before diving into specific files for detailed analysis.</li>
<li>Explore how <code class="inline-code">generateTargetedContent()</code> can be a powerful tool for focused quests involving complex file structures.</li>
</ul>
<hr>
<p>By the starlit decree of the ancient realms, you have triumphed in Quest 3: The Watcher‚Äôs Eye and ascended further on your heroic journey, proving valor and wisdom as a true champion destined for glory! ‚ö°üëÅÔ∏èüíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Rune Scroll of Callithor ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>