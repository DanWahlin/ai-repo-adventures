<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Wisdom of the Dragon Seer - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of the Enchanted Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Wisdom of the Dragon Seer</h1>
<hr>
<p>In the heart of Repositoria, where the Scrolls of Infinite Knowledge shimmer with enchanted power, a mighty disturbance has rippled through the land. The Dragon Seer, a guardian of mythical wisdom, slumbers amidst the Scrolls, its harmony disrupted by corrupted code. Summoned as the Hero of Syntax, your mission is clear: navigate the labyrinth of broken logic and restore the flow of ancient knowledge. Beware, for only the sharp wits of a master Codewright can temper the dragon‚Äôs enigmatic riddles hidden deep within the essence of logic and design. Step forth, brave Hero, to unearth the Wisdom of the Dragon Seer!</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Dragon‚Äôs Awakening</strong>: How does <code class="inline-code">RepoAnalyzer.generateRepomixContext</code> ensure the codebase is evaluated securely and efficiently? </li>
<li>‚ö° <strong>Flow of Magic</strong>: What role does the <code class="inline-code">LLMClient.generateResponse</code> function play in crafting responses and ensuring reliability during complex operations?</li>
<li>üõ°Ô∏è <strong>Protection Spells</strong>: How are validation procedures like <code class="inline-code">RepoAnalyzer.validateProjectPath</code> safeguarding against insecure inputs?</li>
</ul>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: Handling Mystical Requests</h3>
<p>The <code class="inline-code">LLMClient</code> acts as the spellcaster for processing linguistic queries and delivering structured outputs. This file implements features to interact with different LLM providers while maintaining rigorous checks and seamless adaptability to configuration setups. It ensures that magical invocations (requests) achieve precision with robust error handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Constructs and executes an LLM query, validating and post-processing outputs for application use. Crucial for maintaining system reliability.</li>
<li><code class="inline-code">constructor</code>: Initializes the client with the correct API (OpenAI or AzureOpenAI), factoring in key configurations and model specifications.</li>
<li><code class="inline-code">getApiKey</code>: Identifies the correct API key based on the provider, enforcing security and avoiding misconfiguration.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Handles communication with large language models, constructing and executing requests.</li>
<li>Uses advanced error logging (<code class="inline-code">logDetailedError</code>) to provide informative debugging insights.</li>
<li>Implements token usage monitoring (<code class="inline-code">logTokenUsage</code>) to optimize resource management.</li>
</ul>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes the client based on the chosen provider (OpenAI or AzureOpenAI).</li>
<li>Ensures that the correct endpoints and credentials are used, depending on the configuration.</li>
</ul>
<pre><code class="language-typescript">private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }
  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Validates and retrieves the appropriate API key depending on whether the provider is Azure-hosted or another service.</li>
<li>Prevents misconfigured setups by throwing detailed errors when required keys are missing.</li>
</ul>
<hr>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Ensuring Secure Pathways</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is a master Codewright‚Äôs tool, responsible for channeling the sprawling kingdom of code into coherent context. It generates optimized views of the codebase and inscribes only validated and relevant insights into the spellbook of the Scrolls. Meticulous validation ensures no intrusions unbalance the harmony.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Constructs a detailed context of the project‚Äôs codebase using targeted or full analysis, caching results for efficiency.</li>
<li><code class="inline-code">generateTargetedContent</code>: Highlights specific files or code paths, reducing noise in the overall analysis.</li>
<li><code class="inline-code">validateProjectPath</code>: Enforces input validation to detect unsafe paths and maintain secure operations.</li>
</ul>
<h2>Code</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const configuredFiles = extractUniqueFilePaths(projectPath);
  if (configuredFiles.length &gt; 0) {
    return await this.generateOptimizedContent(projectPath, configuredFiles);
  }

  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const ignorePatterns = [
      &#39;node_modules&#39;, &#39;dist&#39;, &#39;build&#39;, &#39;.git&#39;, &#39;coverage&#39;, &#39;.nyc_output&#39;
    ];

    if (!options.includeTests) {
      ignorePatterns.push(&#39;**/*.test.ts&#39;, &#39;**/*.spec.ts&#39;, &#39;**/tests/**&#39;, &#39;**/test/**&#39;);
    }

    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      stdout: true,
      compress: options.compress !== false,
      ignore: ignorePatterns.join(&#39;,&#39;),
      removeComments: true,
      removeEmptyLines: true,
      noDirectoryStructure: true
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });

    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Merges cached efficiency with fresh context generation for scalable analysis.</li>
<li>Ignores unwanted patterns (<code class="inline-code">node_modules</code>, test files) unless explicitly requested.</li>
</ul>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);

    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });

    return optimizedContent;
  } catch (error) {
    throw new Error(`Targeted content generation failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Ensures that only secure and validated files are included in analysis.</li>
<li>Optimizes code extraction to focus only on essential information, improving performance.</li>
</ul>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures no malformed or dangerous paths are processed by the system.</li>
<li>Prevents exploitation through null bytes and empty input checks.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üßô Consider the interaction between <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code>. How does one influence the efficiency of response generation and the other the accuracy of output?</li>
<li>üõ†Ô∏è Investigate how caching improves repetitive task performance across the two files.</li>
<li>üåü For the next exploration, focus on the <code class="inline-code">AdventureManager</code> and <code class="inline-code">StoryGenerator</code> to delve deeper into how quests are crafted.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>With the wisdom of the Dragon Seer now burning brightly within your soul, you rise as a beacon of truth in the mythical kingdom, proving that the courage of a hero shines like a celestial ‚≠ê gem on the path to destiny!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>