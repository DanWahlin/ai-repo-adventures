<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Interface to the Codex - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Codebound Chronicle of the Forgotten Jungle</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Interface to the Codex</h1>
<hr>
<p>Long ago, deep within the uncharted lands of the Forgotten Jungle, an ancient civilization encoded their wisdom in mechanisms of stone and light. The Pyramid of Codex‚Äîan awe-inspiring structure cloaked in vines‚Äîwas said to house a secret so profound, its discovery could shape the future of storytelling. To begin your journey, you must decipher the ancient interface: a mechanism that binds the tools of creation with ritual knowledge. What secrets lie within these mechanisms, and how do they reveal the foundation of the Codex?  </p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:  </p>
<ul>
<li>üîç <strong>Decree of Discovery</strong>: How does the <code class="inline-code">setupHandlers</code> ritual bind dynamic tools to user requests, and what role do schemas play in this process?  </li>
<li>‚ö° <strong>Invocation Flow</strong>: What steps occur when the <code class="inline-code">run</code> method prepares and executes the interface&#39;s transport layer?  </li>
<li>üõ°Ô∏è <strong>Final Protection</strong>: How does the <code class="inline-code">main</code> sequence ensure stability during unexpected events, and how does it honor a graceful shutdown?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Granite Interface</h3>
<p>The <code class="inline-code">server.ts</code> file serves as the primary touchpoint for the Codex interface. This ancient script weaves powerful tools into service rituals, bringing user commands to life. The <code class="inline-code">RepoAdventureServer</code> class encapsulates these mechanisms, providing both dynamic tool bindings and a robust startup sequence. From its handlers to error safeguards, this file explores how rituals of validation, execution, and disaster recovery are performed.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Defines the sacred bindings for tool invocation and validation through schemas, ensuring only righteous commands are executed.  </li>
<li><code class="inline-code">run</code>: Activates the Codex interface transport, allowing communication between the Pyramid‚Äôs mechanisms and the seeker‚Äôs terminal. It also pre-generates content for harmony.  </li>
<li><code class="inline-code">main</code>: Oversees the initialization of the server and safeguards against chaos through signal handling and recovery pathways.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {  
  // Dynamic tool listing  
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {  
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({  
      name,  
      description: tool.description,  
      inputSchema: zodToJsonSchema(tool.schema, {   
        target: &#39;jsonSchema7&#39;,  
        $refStrategy: &#39;none&#39;  
      })  
    }));  

    return { tools: toolList };  
  });  

  // Dynamic tool execution  
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {  
    try {  
      const { name, arguments: args } = request.params;  

      if (!(name in tools)) {  
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);  
      }  

      const tool = tools[name as keyof typeof tools];  

      // Validate arguments using the tool&#39;s Zod schema  
      const validationResult = tool.schema.safeParse(args);  
      if (!validationResult.success) {  
        const errorMessages = validationResult.error.issues.map((err) =&gt;   
          `${err.path.join(&#39;.&#39;)}: ${err.message}`  
        ).join(&#39;, &#39;);  
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);  
      }  

      // Execute the tool handler with validated arguments  
      return await tool.handler(validationResult.data as any);  

    } catch (error) {  
      if (error instanceof McpError) {  
        throw error;  
      }  
      throw new McpError(  
        ErrorCode.InternalError,  
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`  
      );  
    }  
  });  
}  
</code></pre>
<ul>
<li>Registers handlers for listing and executing tools dynamically using schemas to validate input, ensuring safety and correctness.  </li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> to integrate tool schemas for validation during runtime.  </li>
<li>Protects the integrity of the Codex interface by rejecting invalid or unauthorized tool invocations.  </li>
<li>Demonstrates robust error handling through custom exceptions and centralized error codes.  </li>
<li>Highlights modularity by leveraging external <code class="inline-code">tools</code> for dynamic logic injection.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {  
  const transport = new StdioServerTransport();  
  await this.server.connect(transport);  
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);  
    
  // Pre-generate repomix content for the current working directory to warm up the cache  
  const projectPath = process.cwd();  
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);  
  repoAnalyzer.preGenerate(projectPath);  
}  
</code></pre>
<ul>
<li>Initializes the server by connecting to a <code class="inline-code">StdioServerTransport</code> for interactivity.  </li>
<li>Outputs diagnostics to indicate active status and target paths.  </li>
<li>Pre-generates content asynchronously to optimize user interaction later.  </li>
<li>Ensures smooth initialization for complex workflows.  </li>
<li>Balances efficiency with clarity by providing detailed, real-time feedback.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {  
  try {  
    const server = new RepoAdventureServer();  

    // Handle graceful shutdown for both signals  
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt;   
      process.on(sig as NodeJS.Signals, gracefulShutdown)  
    );  

    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation  
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {  
      console.error(&#39;Unhandled promise rejection:&#39;, reason);  
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);  
    });  

    await server.run();  
  } catch (error) {  
    console.error(&#39;Fatal error starting MCP server:&#39;, error);  
    process.exit(1);  
  }  
}  
</code></pre>
<ul>
<li>Orchestrates critical initializations, including the <code class="inline-code">RepoAdventureServer</code>.  </li>
<li>Listens for shutdown signals like <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> to invoke <code class="inline-code">gracefulShutdown</code>.  </li>
<li>Handles edge cases such as unhandled promise rejections or fatal errors gracefully.  </li>
<li>Ensures comprehensive logging for issue diagnosis and robust fail-safe mechanisms.  </li>
<li>Serves as a defensive barrier against operational disruptions.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üåÄ Schema decoding can be tricky‚Äîtrace how tools dynamically integrate their validation logic.  </li>
<li>üîé Focus on how <code class="inline-code">run</code> prepares asynchronous resources for smoother gameplay.  </li>
<li>üîß Resilience is at the core of the interface‚Äîobserve how fail-safes are woven through the <code class="inline-code">main</code> function.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred Interface to the Codex; the temple doors creak open, and the path to eternal enlightenment beckons‚Äîlet thy journey be ever fearless and triumphant! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>