<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Chamber of Ancient Interfaces - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Codex: Adventures in the Repository of Lost Wisdom</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Chamber of Ancient Interfaces</h1>
<hr>
<p>In the heart of a forgotten digital temple, you step into the fabled Chamber of Ancient Interfaces. Pillars adorned with cryptic carvings of function signatures rise from the floor like sentinels of wisdom. Before you lies the Sacred Codex, its pages whispered to describe the structure of the temple&#39;s mighty tools and the secrets of their guardianship. To retrieve the artifacts within, you must unearth the inner workings of an enigmatic server, its purpose preserved by ritualistic handlers and flows of data. Go forth, adventurer, and decode the ancient wisdom that awaits.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Ritual of Handlers</strong>: How does <code class="inline-code">setupHandlers</code> enable dynamic functionality for tool listing and execution on the server?</li>
<li>‚ö° <strong>Server&#39;s Incantation</strong>: What role does the <code class="inline-code">run</code> function play in preparing and starting the code exploration journey?</li>
<li>üõ°Ô∏è <strong>Graceful Demise</strong>: How does the <code class="inline-code">main</code> function handle unexpected errors or shutdown signals to ensure stability?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The Ancient Server Logic</h3>
<p>This file houses the <code class="inline-code">RepoAdventureServer</code>, the central orchestrator that ensures tools are properly registered and server operations remain robust. It integrates core guardians of wisdom (tools) with dynamic response handling. Structures like <code class="inline-code">setupHandlers</code> enable precise rituals for validating and invoking these tools, while <code class="inline-code">run</code> oversees initiation ceremonies for adventurers. The <code class="inline-code">main</code> function is the temple&#39;s guardian, prepared for disruptive intrusions yet ensuring continuity in the face of uncertainty.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code> establishes foundational rituals for dynamically listing and executing tools. This ensures the system remains adaptable and extensible.</li>
<li><code class="inline-code">RepoAdventureServer.run</code> initializes the server, connects transports, and primes the repomix content cache, setting the stage for seamless code adventures.</li>
<li><code class="inline-code">main</code> acts as the vigilant overseer, managing server lifecycle events like unexpected shutdowns or unhandled promise rejections, ensuring stability and user safety.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>This routine dynamically manages the listing and execution of tools, exemplifying modern extensibility in ancient patterns of modular wisdom.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler ensures all available tools are documented, facilitating easy integration.</li>
<li>Validation via <code class="inline-code">zod</code> emphasizes spiritual purity of input, preventing misuse of sacred mechanisms.</li>
<li>Error codes and exceptions act as ritual safeguards to ensure that perpetrators of invalid requests are appropriately admonished.</li>
<li>The reliance on handlers and schemas reflects robust design principles found in adaptable systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>This function provides the incantation to awaken the server and establish its connection over <code class="inline-code">stdio</code>, symbolizing readiness for exploration.</li>
<li>The invocation of <code class="inline-code">repoAnalyzer.preGenerate</code> serves as a cache-priming ritual, ensuring the temple is ready to offer its wisdom immediately.</li>
<li>Background execution ensures responsiveness, reflecting an architectural balance between foresight and immediacy.</li>
<li>The reuse of <code class="inline-code">process.cwd()</code> integrates context awareness, anchoring the adventure server in the explorer&#39;s current realm.</li>
<li>This function bridges server preparation and user interactivity, connecting the ritual to its practical application.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>This central function coordinates the startup sequence and ensures the server is prepared for both expected and unexpected challenges.</li>
<li>The <code class="inline-code">gracefulShutdown</code> function binds to system signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>), echoing rituals that prepare the temple for closure.</li>
<li>Error trapping and logging (<code class="inline-code">unhandledRejection</code>) reinforce stability without interrupting ongoing operations.</li>
<li>The invocation of <code class="inline-code">RepoAdventureServer</code> encapsulates server logic in a neatly contained ritual object.</li>
<li>The blend of robust preparation (<code class="inline-code">try-catch</code>) with ongoing error handling exemplifies fault-tolerant design principles.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay close attention to how schemas (<code class="inline-code">zod</code>) validate inputs and prevent misuse of tool handlers.</li>
<li>Reflect on how modular design (tools re-exported in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a>) creates an extensible and maintainable system.</li>
<li>Investigate the relationship between <code class="inline-code">setupHandlers</code> and tool configuration for evolving code exploration rituals.</li>
</ul>
<hr>
<p>The chamber hums as you absorb its wisdom. You feel the pull of another deeper mystery beyond this interface. Will you continue your exploration?</p>
<p>By the sacred fires of enlightenment, thou hast unlocked the wisdom of the ancients within the Chamber of Ancient Interfaces‚Äîpress on, for thy journey through the tapestry of quests hath but begun! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>