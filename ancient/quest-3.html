<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Crystal Analyzer - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'ancient' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Pyramid of Lost Code</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Crystal Analyzer</h1>
<hr>
<p>Deep within the Pyramid of Lost Code, past labyrinthine corridors illuminated only by the soft hum of ancient machinery, you find yourself standing before an elaborate altar. Positioned atop the altar is the &quot;Crystal Analyzer&quot;—an exquisite artifact shimmering with fragments of data from millennia past. The jungle seems to hold its breath as you approach, for this object is said to hold the ability to scan and reveal the encoded truths of entire civilizations. To harness such knowledge, you must first decipher the ancient rites etched into the surrounding walls, unlocking its secrets and connecting it to the sacred algorithms of old. The path forward will require resilience, understanding, and a fearless mind.</p>
<h2>File Exploration</h2>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a>: Integration for Repomix Content Analysis</h3>
<p>This file is the cornerstone of the Crystal Analyzer&#39;s sacred functionality. It contains the logic for combining the immense computational power of the Repomix tool with advanced file analysis strategies. The core class, <code class="inline-code">RepoAnalyzer</code>, ensures safe and efficient code extraction, protecting both the user and the temple’s knowledge from harm. It validates file paths, ensures secure subprocess execution of Repomix, and caches results to avoid reprocessing. Functions like <code class="inline-code">generateRepomixContext()</code> power the analyzer’s ability to comprehend the entirety of a project, while <code class="inline-code">generateTargetedContent()</code> zeroes in on specific codes of interest—ensuring no detail is missed but resources are conserved. </p>
<p>The artifact’s safety protocols are woven into methods like <code class="inline-code">validateAndNormalizeTargetFiles()</code>, preventing unintended traversal into forbidden lands (like system directories). This integration balances the sophisticated computational requirements of the LLM with the constraints of real-world systems. </p>
<p>The file features highly structured systems that toggle between full-project or targeted analysis modes—akin to selectively illuminating segments of a hieroglyph-laden wall to reveal patterns. </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext()</code>: Seamlessly provides a full project or targeted analysis with intelligent caching.</li>
<li><code class="inline-code">validateAndNormalizeTargetFiles()</code>: Heightens security and regulates the scope of investigated files.</li>
<li><code class="inline-code">captureRepomixStdout()</code>: Handles subprocess execution with built-in timeouts and memory protection.</li>
</ul>
<h3><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a>: LLM Integration to Decipher Ancient Knowledge</h3>
<p>In the grand ritual to unlock the Pyramid&#39;s forgotten wisdom, <code class="inline-code">llm-client.ts</code> serves as the soul of the Crystal Analyzer. This file links to multiple language model providers like OpenAI and Azure, overseeing how prompts (or ancient manuscripts) are transformed into usable insights. The <code class="inline-code">LLMClient</code> class is the high priest of these operations, skillfully managing API requests and carefully formatting results. From <code class="inline-code">generateResponse()</code>, which acts as the bridge between human queries and the machine’s revelations, to <code class="inline-code">validateResponse()</code>, which ensures the sanctity of the returned data, every aspect of the file emphasizes reliability.</p>
<p>Attributes like <code class="inline-code">getApiKey()</code> and <code class="inline-code">isAzureOpenAI()</code> make it adaptive to varied mystical sources, while <code class="inline-code">logTokenUsage()</code> ensures explorers know the cost of their inquiries. This file is a masterpiece of modular design, ensuring the Crystal Analyzer can inquire, adapt, and revise responses without succumbing to the temple’s (read: system’s) constraints on time or memory.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse()</code>: Harmonizes user queries with machine intelligence for profound insights.</li>
<li><code class="inline-code">validateResponse()</code>: Guarantees reliable and complete transmissions from the models.</li>
<li><code class="inline-code">logTokenUsage()</code>: Reflects token usage, enabling reflections on energy expenditure (and optimization).</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">/**
 * Validate and normalize target files for security and reliability
 * Prevents path traversal, ensures files exist, deduplicates, and limits count
 */
private validateAndNormalizeTargetFiles(projectPath: string, targetFiles: string[]): string[] {
    const MAX_TARGET_FILES = 50; // Reasonable limit to prevent resource exhaustion
    const projectRoot = path.resolve(projectPath);
    
    const safeFiles = [...new Set(targetFiles)]
      .slice(0, MAX_TARGET_FILES)
      .map(file =&gt; {
        const trimmed = (typeof file === &#39;string&#39;) ? file.trim() : &#39;&#39;;
        if (trimmed.includes(&#39;\0&#39;) || trimmed.includes(&#39;..&#39;)) {
          console.warn(`Rejecting unsafe path: ${trimmed}`);
          return null;
        }
        return trimmed;
      })
      .filter(Boolean)
      .map(file =&gt; {
        const fullPath = path.resolve(projectPath, file);
        if (!fullPath.startsWith(projectRoot + path.sep) || !fs.existsSync(fullPath)) {
          return null;
        }
        return path.relative(projectPath, fullPath);
      })
      .filter(Boolean)
      .sort();
    
    return safeFiles;
}
</code></pre>
<p>This code is like a vigilant gatekeeper ensuring that only safe, valid paths are permitted into the treasure vault for analysis.</p>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">/**
 * Validate and extract content from the LLM response
 */
private validateResponse(completion: any): string {
    const choice = completion.choices[0];
    const content = choice?.message?.content;
    
    if (!choice || !choice.message || !content?.trim()) {
      throw new Error(&#39;Invalid or empty response received from LLM&#39;);
    }
    return content;
}
</code></pre>
<p>This function inspects the wisdom received from the ritual, discarding any cryptic or hollow answers to assure only meaningful enlightenment.</p>
<h2>Helpful Hints</h2>
<ul>
<li>When handling delicate content extraction like in <code class="inline-code">RepoAnalyzer</code>, always consider security mechanisms like validating and limiting file paths.</li>
<li>To optimize token usage in <code class="inline-code">LLMClient</code>, prioritize concise prompts and review model-specific constraints before integration.</li>
<li>Understanding both full-project and targeted analyses will deepen your mastery of efficient repository exploration and context manipulation.</li>
</ul>
<hr>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred mysteries of the Crystal Analyzer, advancing boldly upon thy divine odyssey—press ever onward, for the stars themselves bear witness to thy ascent! ⭐💎⚡</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Ritual of Themes →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>