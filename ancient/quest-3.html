<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Unearthing the Analytical Lens - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Sacred Chronicles of the Repository</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Unearthing the Analytical Lens</h1>
<hr>
<p>The Temple of Code beckons once more, its walls echoing tales of the Analytical Lens – the fabled device said to grant unparalleled insight into the very essence of software. Only those able to navigate the hieroglyphic traps of logic and decipher riddles of optimization can reach this treasure. As the chosen archaeologist, you must delve into chambers guarded by ancient mechanisms like <code class="inline-code">RepoAnalyzer</code> and <code class="inline-code">LLMClient</code>. Will you unravel the secrets of adaptive systems and their computational wisdom, etched in the Scrolls of Adventure? Beware – vigilance and intellect are paramount.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repository Analyzer Utility</h3>
<p>At the heart of the Analytical Lens lies the <code class="inline-code">RepoAnalyzer</code>, a sacred artifact designed to interpret and extract insights from vast code repositories. This utility encapsulates rituals for project path validation, selective file analysis, and efficient code extraction. Critically, its power to generate repomix content and ensure efficient token handling underscores its significance within the temple. The methods <code class="inline-code">generateRepomixContext</code>, <code class="inline-code">generateTargetedContent</code>, and <code class="inline-code">captureRepomixStdout</code> highlight key processes—mapping logical paths, validating inputs, and initiating subprocesses to extract rich repository insights.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateRepomixContext</code>: Decides and orchestrates adventure journeys for analysis.</li>
<li><code class="inline-code">generateTargetedContent</code>: Builds curated avenues of content extraction, compressing and optimizing.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Harnesses subprocesses, ensuring efficient execution and guarding against resource exhaustion.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);
    const configuredFiles = extractUniqueFilePaths(projectPath);

    if (configuredFiles.length &gt; 0) {
        try {
            return await this.generateOptimizedContent(projectPath, configuredFiles);
        } catch (error) {
            console.warn(&#39;Falling back to targeted content due to error:&#39;, error.message);
            return await this.generateTargetedContent(projectPath, configuredFiles);
        }
    }
    console.log(&#39;Analyzing full codebase (compressed)&#39;);
    const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;

    const cached = this.cache.get(cacheKey);
    if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
        return cached.content;
    }
    return await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
        style: &#39;markdown&#39;,
        compress: options.compress !== false,
        ignore: &#39;node_modules,dist,build,.git&#39;
    });
}
</code></pre>
<p>This method acts as the ritual master, determining whether to focus on selective insights or navigate the full archaeological expanse.</p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
    this.validateProjectPath(projectPath);    
    const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);

    const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;

    if (this.cache.has(cacheKey)) {
        return this.cache.get(cacheKey).content;
    }

    try {
        const cliOptions: CliOptions = {
            style: &#39;markdown&#39;, compress, 
            include: safeFiles.join(&#39;,&#39;), 
            noDirectoryStructure: true
        };
        const context = await this.captureRepomixStdout(safeFiles, projectPath, cliOptions);
        this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
        return context;
    } catch (error) {
        throw new Error(`Targeted repomix execution failed: ${error.message}`);
    }
}
</code></pre>
<p>This function sharpens the map for exploration, singling out paths of interest among a labyrinth of potential targets.</p>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
    return new Promise((resolve, reject) =&gt; {
        const args = [&#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];
        if (options.compress) args.push(&#39;--compress&#39;);
        const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd });
        let stdout = &#39;&#39;, stderr = &#39;&#39;;

        const timeout = setTimeout(() =&gt; {
            repomix.kill(&#39;SIGTERM&#39;);
            reject(new Error(`Timeout reached: ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
        }, REPOMIX_SUBPROCESS_TIMEOUT);

        repomix.stdout.on(&#39;data&#39;, data =&gt; stdout += data.toString());
        repomix.stderr.on(&#39;data&#39;, data =&gt; stderr += data.toString());
        repomix.on(&#39;close&#39;, code =&gt; {
            clearTimeout(timeout);
            code === 0 ? resolve(stdout) : reject(new Error(`Exit ${code}: ${stderr}`));
        });
    });
}
</code></pre>
<p>This subprocess crafts the tools needed for extracting treasure while implementing measures to prevent burnout from trapped recursive tasks.</p>
<hr>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> LLM Client Interface</h3>
<p>Adjacent to the Analyzer, the <code class="inline-code">LLMClient</code> operates like the mystical guide, interpreting user prompts and relaying insights from computational energy fields. Critical steps include secure API key retrieval, engaging GPT-backed models, and optimizing token limits. The client streamlines interactions between adventurers and the knowledge repository, managing response generation through its <code class="inline-code">generateResponse</code>, constructor, and <code class="inline-code">getApiKey</code> functions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse</code>: Spearheads interaction, transforming prompts into actionable outputs.</li>
<li><code class="inline-code">constructor</code>: Establishes sacred configurations for client invocations.</li>
<li><code class="inline-code">getApiKey</code>: Secures the lifeblood (API key) essential for communication with the divine models.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
        content = this.cleanJsonResponse(content);
    }
    this.logTokenUsage(completion);
    return { content };
}
</code></pre>
<p>This function channels user-driven rituals into cohesive responses, ensuring their alignment with the Analytical Lens.</p>
<pre><code class="language-typescript">constructor() {
    this.model = LLM_MODEL;
    const apiKey = this.getApiKey();
    this.client = this.isAzureOpenAI() 
        ? new AzureOpenAI({endpoint: LLM_BASE_URL, apiKey, deployment: this.model})
        : new OpenAI({apiKey, baseURL: LLM_BASE_URL});
}
</code></pre>
<p>This initializes the sacred link between adventurer and divine tool, ensuring proper communication channels are protected.</p>
<pre><code class="language-typescript">private getApiKey(): string {
    if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;) &amp;&amp; GITHUB_TOKEN) {
        return GITHUB_TOKEN;
    }
    if (LLM_API_KEY) {
        return LLM_API_KEY;
    }
    throw new Error(&#39;No valid API key provided.&#39;);
}
</code></pre>
<p>This ensures that only the chosen bearers of the correct talisman (API key) can awaken the Lens.</p>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Validate paths comprehensively when constructing analytical journeys to avoid logical pitfalls.</li>
<li>Create distinctions in tool configurations to optimize usage for specific quests.</li>
<li>Watch for timeout behaviors in subprocesses during extraction.</li>
</ul>
<hr>
<p>The Analytical Lens grows within your grasp, its eternal mysteries awaiting further exploration, brave archaeologist! Will you proceed deeper into its sacred chambers?</p>
<p>Hail, seeker of sacred insight, for thou hast triumphed in Quest 3—Unearthing the Analytical Lens—and carved thy name upon the tablets of wisdom eternal; the temple of enlightenment now beckons thee onward with radiant glory! ⚡💎🗺️</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: Unlocking the Pyramid's Themes →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>