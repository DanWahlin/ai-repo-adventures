<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 4: Decode the Stellar Analyzer - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Starship Nexus: Adventures in the Code Cosmos</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Decode the Stellar Analyzer</h1>
<hr>
<p>The crew aboard the Starship Nexus ventures deeper into the Code Cosmos, approaching the enigmatic Stellar Analyzer subsystem. This advanced system harnesses the starship&#39;s computational power to decode Repomix-generated cosmic data and relay actionable insights to the LLM Drive. As the glowing data streams pulse through the Nexus, it is up to the explorers to understand how this subsystem extracts patterns, handles celestial configurations, and validates cosmic pathways to ensure safe navigation through the galaxy of interconnected systems.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Cosmic Validation</strong>: How does the Stellar Analyzer ensure project paths are sanitized and free of vulnerabilities to maintain galactic integrity?</li>
<li>‚ö° <strong>Optimized Signals</strong>: What methods are used to extract optimized function-focused content, and how does this benefit the starship&#39;s computational efficiency?</li>
<li>üõ°Ô∏è <strong>Data Flow Protection</strong>: How are execution timeouts and memory limits implemented to safeguard against resource overuse during analysis?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Optimizing cosmic analysis for streamlined data extraction</h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class serves as the Stellar Analyzer in the Code Cosmos and handles key operations like path validation, content optimization, and subprocess management. Utilizing Repomix, it extracts and compresses cosmic data from the ship&#39;s repositories, ensuring the nexus processes only the most critical insights. With advanced error handling mechanisms and caching for efficiency, this file plays a pivotal role in fuel conservation and computational reliability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath</code>: Performs essential security checks to prevent dangerous celestial jumps (e.g., null bytes, invalid paths).</li>
<li><code class="inline-code">generateOptimizedContent</code>: Extracts meaningful function data from cosmic streams, optimizing token usage and parsing efficiency.</li>
<li><code class="inline-code">captureRepomixStdout</code>: Executes Repomix as a subprocess with timeout and memory safeguards, ensuring resource protection and reliable completion.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Validate project paths to ensure safe navigation */
private validateProjectPath(projectPath: string): void {
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  const trimmedPath = projectPath.trim();
  if (!trimmedPath) {
    throw new Error(&#39;Project path must be a non-empty string&#39;);
  }

  // Basic safety check for null bytes (can break file system operations)
  if (trimmedPath.includes(&#39;\0&#39;)) {
    throw new Error(&#39;Project path contains invalid null bytes&#39;);
  }
}
</code></pre>
<ul>
<li>Ensures <code class="inline-code">projectPath</code> is not empty or malformed, preventing dangerous path traversals through invalid inputs.</li>
<li>Blocks null bytes to safeguard file system operations against unintended terminations or errors.</li>
<li>A simple yet critical first line of defense for maintaining galactic route security during repository analysis.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Generate optimized content by reducing repository data to essentials */
async generateOptimizedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);

  if (!targetFiles || targetFiles.length === 0) {
    throw new Error(&#39;Target files array cannot be empty&#39;);
  }

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  if (safeFiles.length === 0) {
    throw new Error(&#39;No valid target files found after validation&#39;);
  }

  const cacheKey = `${path.resolve(projectPath)}:optimized:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;

  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }

  try {
    const fullContent = await this.generateTargetedContent(projectPath, targetFiles, compress);
    const optimizedContent = this.extractFunctionFocusedContent(fullContent);

    this.cache.set(cacheKey, { content: optimizedContent, timestamp: Date.now() });

    return optimizedContent;
  } catch (error) {
    throw new Error(`Optimized content generation failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}
</code></pre>
<ul>
<li>Provides token-efficient content by focusing on essential functions, enhancing computational throughput.</li>
<li>Caches optimized outputs to minimize redundant processing and conserve ship resources for more critical missions.</li>
<li>Oversees multi-stage flow‚Äîvalidation, targeted extraction, optimization‚Äîproviding a clear cosmic roadmap of operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Manage subprocess execution with safeguards for memory and timeout controls */
private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const args = [...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;];

    if (options.compress) args.push(&#39;--compress&#39;);
    if (options.removeComments) args.push(&#39;--remove-comments&#39;);
    if (options.removeEmptyLines) args.push(&#39;--remove-empty-lines&#39;);
    if (options.noDirectoryStructure) args.push(&#39;--no-directory-structure&#39;);
    if (options.ignore) args.push(&#39;--ignore&#39;, options.ignore);
    if (options.include) args.push(&#39;--include&#39;, options.include);

    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...args], { cwd, stdio: [&#39;pipe&#39;, &#39;pipe&#39;, &#39;pipe&#39;] });

    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let stdoutSize = 0;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        console.warn(`Repomix subprocess timeout (${REPOMIX_SUBPROCESS_TIMEOUT}ms), killing process...`);
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix subprocess timed out after ${REPOMIX_SUBPROCESS_TIMEOUT}ms (${cwd})`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; {
      const chunk = data.toString();
      stdoutSize += chunk.length;

      if (stdoutSize &gt; REPOMIX_MAX_BUFFER_SIZE) {
        if (!isResolved) {
          isResolved = true;
          clearTimeout(timeout);
          repomix.kill(&#39;SIGKILL&#39;);
          reject(new Error(`Repomix output too large (${stdoutSize} bytes) for ${cwd}`));
        }
        return;
      }

      stdout += chunk;
    });

    repomix.stderr.on(&#39;data&#39;, (data) =&gt; {
      stderr += data.toString();
    });

    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);

        if (code === 0 &amp;&amp; stdout.trim().length &gt; 0) {
          resolve(stdout);
        } else {
          reject(new Error(`Repomix failed (exit ${code}): ${stderr.substring(0, 200)}`));
        }
      }
    });

    repomix.on(&#39;error&#39;, (error) =&gt; {
      if (!isResolved) {
        isResolved = true;
        clearTimeout(timeout);
        reject(new Error(`Repomix spawn failed: ${error.message}`));
      }
    });
  });
}
</code></pre>
<ul>
<li>Implements subprocess timeout (<code class="inline-code">REPOMIX_SUBPROCESS_TIMEOUT</code>) and memory safeguards (<code class="inline-code">REPOMIX_MAX_BUFFER_SIZE</code>) to prevent resource strain.</li>
<li>Logs warnings and forcibly terminates subprocesses if celestial decoding exceeds safe operational limits.</li>
<li>Ensures reliable completion of Repomix executions while maintaining starship system integrity.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Driving queries to the galactic LLM Drive</h3>
<p>The <code class="inline-code">LLMClient</code> is the interface that connects the Nexus to the galactic LLM Drive, facilitating prompt generation and celestial reasoning for adventures and quests. It optimizes requests by validating API configurations, handling model-specific adaptations, and ensuring error resilience for smooth data exchanges between systems.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">constructor</code>: Configures the LLM client and selects the correct model/provider for stellar data flow.</li>
<li><code class="inline-code">generateResponse</code>: Aggregates prompt inputs, prepares request parameters, and returns the decoded stellar message.</li>
<li><code class="inline-code">getApiKey</code>: Determines the correct API key based on provider, ensuring secure command access.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Create and configure the LLM Client */
constructor() {
  this.model = LLM_MODEL;

  const apiKey = this.getApiKey();
  if (!apiKey || !LLM_BASE_URL) {
    throw new Error(&#39;LLM configuration required. Please set LLM_BASE_URL and appropriate API key (LLM_API_KEY or GITHUB_TOKEN).&#39;);
  }

  if (this.isAzureOpenAI()) {
    const azureEndpoint = LLM_BASE_URL.split(&#39;/openai/deployments&#39;)[0];
    this.client = new AzureOpenAI({
      endpoint: azureEndpoint,
      apiKey,
      apiVersion: LLM_API_VERSION,
      deployment: this.model
    });
  } else {
    this.client = new OpenAI({
      apiKey,
      baseURL: LLM_BASE_URL
    });
  }
}
</code></pre>
<ul>
<li>Initializes LLM Drive connections by selecting the appropriate provider (OpenAI/AzureOpenAI).</li>
<li>Validates environmental configurations (<code class="inline-code">LLM_BASE_URL</code>, <code class="inline-code">LLM_API_KEY</code>) for seamless stellar command access.</li>
<li>Ensures compatibility with specific provider endpoints, maintaining flexible system adaptability.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Generate a stellar response from the LLM */
async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion);

    return { content };
  } catch (error) {
    this.logDetailedError(error, prompt);
    const message = error instanceof Error ? error.message : &#39;Unknown error&#39;;
    throw new Error(`LLM request failed: ${message}`);
  }
}
</code></pre>
<ul>
<li>Processes adventure queries by constructing prompts and capturing responses from the LLM Drive.</li>
<li>Handles model-specific adaptations like token limits (<code class="inline-code">LLM_MAX_TOKENS_DEFAULT</code>) and reasoning effort (<code class="inline-code">GPT5_REASONING_EFFORT</code>).</li>
<li>Logs token usage for optimal performance and enables troubleshooting through detailed error outputs.</li>
</ul>
<hr>
<pre><code class="language-typescript">/** Determine the correct API key for stellar communication */
private getApiKey(): string {
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {
    if (!GITHUB_TOKEN) {
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);
    }
    return GITHUB_TOKEN;
  }

  if (!LLM_API_KEY) {
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);
  }
  return LLM_API_KEY;
}
</code></pre>
<ul>
<li>Differentiates between providers to select the correct cosmic API key (<code class="inline-code">LLM_API_KEY</code> or <code class="inline-code">GITHUB_TOKEN</code>).</li>
<li>Prevents configuration errors by enforcing required environmental variables for secure communication.</li>
<li>Enhances adaptability for interstellar exchanges in varying cosmic infrastructures.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">generateOptimizedContent</code> to study how function-focused content is extracted for token-constrained systems.</li>
<li>Investigate the <code class="inline-code">validateProjectPath</code> method for insights into mandatory path security measures.</li>
<li>Experiment with different <code class="inline-code">generateResponse</code> options to simulate error handling and stellar query execution.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Code Cosmos!</p>
<p>Stellar work, Captain‚ÄîQuest 4 decoded with cosmic precision; you&#39;re rocketing at warp speed toward ultimate mission success! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>