<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: Quest Generation Engine - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Galactic Code Chronicles: Missions Beyond the Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Quest Generation Engine</h1>
<hr>
<p>Aboard the starship <em>Celestial Refactor</em>, the crew gathers around the glowing holo-interface as a series of cosmic maps unfurls before your eyes. Today&#39;s mission plunges you into the heart of the interstellar codebase that fuels the vessel&#39;s advanced quest generation engine. Half navigation system, half cosmic storyteller, this intricate machinery generates pathways for explorers across uncharted nebulae. To ensure the stellar itineraries are nothing short of cosmic artistry, you‚Äôll analyze and enhance the quest-generation code itself. The mysteries of the repository await‚Äîready your tools and prepare to traverse the logic galaxies.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Reactors of Storytelling</strong>: How does <code class="inline-code">AdventureManager</code> coordinate generating and merging quests with <code class="inline-code">StoryGenerator</code> for seamless storytelling?</li>
<li>‚ö° <strong>Energy Flow of Themes</strong>: How does <code class="inline-code">StoryGenerator</code> use themes to customize generated quest content dynamically?</li>
<li>üõ°Ô∏è <strong>Defense Mechanisms</strong>: What validation or error-handling patterns are utilized in <code class="inline-code">adventure-config.ts</code> to ensure robust quest creation?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/shared/adventure-config.ts:</span> Supporting the Cosmic Backbone</h3>
<p>This file empowers the adventure system by extracting and formatting configuration data from the repository. Critical for ensuring quests are aligned with project information, its functions form the spine of many operations across the starship.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">loadAdventureConfig</code>: Reads the raw adventure configuration file to provide foundational data. Helps ensure the cosmic maps are ready for exploration.</li>
<li><code class="inline-code">parseAdventureConfig</code>: Parses and validates the configuration file into a traversable object structure, preparing quest data for use.</li>
<li><code class="inline-code">extractUniqueFilePaths</code>: Extracts unique file paths from the configuration, ensuring accuracy in travel itineraries across the codebase.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/shared/adventure-config.ts</h3>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the adventure configuration file if it exists.</li>
<li>Handles missing or unreadable files gracefully with a <code class="inline-code">null</code> return value.</li>
<li>Acts as the initial entry point for loading configuration data.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Converts raw configuration content into an interactive object.</li>
<li>Ensures that malformed configurations are caught and handled safely.</li>
<li>Centralized JSON parsing allows robust validation without redundancy in the codebase.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  // Rest of the implementation here..
  return Array.from(unique);
}
</code></pre>
<ul>
<li>Ensures no duplicate paths pollute the quest generation process.</li>
<li>Traverses nested configuration objects to find all valid file paths.</li>
<li>Uses existing paths validation to support reliable navigation of the interstellar repository.</li>
</ul>
<hr>
<p>Helpful Hints</p>
<ul>
<li>Consider how <code class="inline-code">parseAdventureConfig</code> centralizes error handling for JSON parsing when extending functionality.</li>
<li>Notice how <code class="inline-code">extractUniqueFilePaths</code> implements recursion‚Äîideal for traversing complex, nested configurations.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/adventure-manager.ts:</span> The Navigator of Quests</h3>
<p>The <code class="inline-code">AdventureManager</code> serves as the neural hub of the adventure system, orchestrating the generation, caching, and management of quests. It bridges user interaction and the underlying content engine, ensuring every stellar itinerary is tailored and smooth.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">initializeAdventure</code>: Sets the stage for a cosmic journey by orchestrating story generation and quest alignment with repository data.</li>
<li><code class="inline-code">exploreQuest</code>: Executes chosen quests with dynamic caching and ensures resumption is frictionless for repeated engagements.</li>
<li><code class="inline-code">generateQuestContent</code>: Calls upon <code class="inline-code">StoryGenerator</code> to design and enrich quests with snippets of interstellar code.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/adventure-manager.ts</h3>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);
  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets and initializes the adventure state, aligning configuration with the selected theme.</li>
<li>Delegates story generation to <code class="inline-code">StoryGenerator</code>, encapsulating user-defined themes.</li>
<li>Integrates configuration-driven quest count enforcement to maintain consistency.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);
  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }
  
  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates and resolves quest choices, linking user preferences to actionable items.</li>
<li>Handles progress requests seamlessly by displaying the current state of exploration.</li>
<li>Integration with cached results minimizes redundant processing, ensuring efficient execution.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;
  
  // Use targeted content if quest has specific files
  if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0 &amp;&amp; this.state.projectPath) {
    codeContent = await repoAnalyzer.generateTargetedContent(
      this.state.projectPath,
      quest.codeFiles,
      false
    );
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  const questPosition = this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1;
  const totalQuests = this.state.quests.length;

  return await this.storyGenerator.generateQuestContent({
    quest,
    theme: this.state.currentTheme!,
    codeContent,
    questPosition,
    totalQuests
  });
}
</code></pre>
<ul>
<li>Integrates repository analysis for generating code-specific quest content dynamically.</li>
<li>Supports fallback logic, ensuring quests remain executable even without targeted files.</li>
<li>Enriches quests with thematic context and position-based adaptive prompts.</li>
</ul>
<hr>
<p>Helpful Hints</p>
<ul>
<li>Pay attention to how <code class="inline-code">initializeAdventure</code> integrates user-defined themes with dynamic story generation.</li>
<li>Reflect on how <code class="inline-code">exploreQuest</code> enriches the user experience by handling multiple intent paths seamlessly.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/adventure/story-generator.ts:</span> The Cosmic Storyteller</h3>
<p><code class="inline-code">StoryGenerator</code> personifies the AI-driven narrative engine that crafts the rich, thematic adventures designed for cosmic exploration. Every quest is infused with immersive elements based on repository data and themes.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateStoryAndQuests</code>: Initiates the storytelling process by synthesizing repository data with thematic accents.</li>
<li><code class="inline-code">generateQuestContent</code>: Details each quest with a laser focus on storytelling and code relevance.</li>
<li><code class="inline-code">removeLLMMetaCommentary</code>: Strips unnecessary model-generated content to ensure user-facing text remains clean.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/adventure/story-generator.ts</h3>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const prompt = loadStoryGenerationPrompt({
    theme,
    repomixContent: projectInfo.repomixContent || &#39;No content available&#39;,
    adventureGuidance: formatAdventureConfigForPrompt(this.projectPath || &#39;&#39;),
    customInstructions: extractCustomInstructions(this.projectPath || &#39;&#39;) || &#39;&#39;
  });

  const response = await this.withTimeout(
    this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_STORY })
  );

  return parseMarkdownToStoryResponse(response.content.trim());
}
</code></pre>
<ul>
<li>Uses the formatted adventure configuration to align story generation with project goals.</li>
<li>Relies on the <code class="inline-code">parseMarkdownToStoryResponse</code> function for consistent structural parsing.</li>
<li>Custom instructions and themes add a nuanced richness to the resultant adventures.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const prompt = loadQuestContentPrompt({
    theme: config.theme,
    adventureTitle: config.quest.title,
    codeContent: config.codeContent,
    totalQuests: config.totalQuests,
    questPosition: config.questPosition
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST });

  return parseMarkdownToStoryResponse(response.content.trim());
}
</code></pre>
<ul>
<li>Engages the LLM to generate tailored content for individual quests based on theme and position.</li>
<li>Ensures that code snippets and explanations are tightly integrated with the quest&#39;s narrative context.</li>
</ul>
<hr>
<pre><code class="language-typescript">private removeLLMMetaCommentary(content: string): string {
  const lines = content.split(&#39;\n&#39;);
  const metaCommentaryPatterns = [
    /^Here is the continuation of/i,
    /^Below is the content/i,
    /^Following the.*template/i
  ];
  return lines
    .filter(line =&gt; !metaCommentaryPatterns.some(pattern =&gt; pattern.test(line)))
    .join(&#39;\n&#39;);
}
</code></pre>
<ul>
<li>Cleans up unnecessary LLM-generated commentary, ensuring professional output.</li>
<li>Filters only user-relevant content to maintain a polished experience.</li>
</ul>
<hr>
<p>Helpful Hints</p>
<ul>
<li>Observe how <code class="inline-code">generateStoryAndQuests</code> employs structured Markdown parsing to transform LLM responses into actionable quests.</li>
<li>Explore the validation steps in <code class="inline-code">removeLLMMetaCommentary</code> that ensure user-facing content remains uncluttered.</li>
</ul>
<hr>
<p>You have unraveled the engines of adventure generation. Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission accomplished, star voyager! üöÄ Quest 3&#39;s Quest Generation Engine has ignited cosmic creativity, propelling us to 40% completion‚Äîkeep channeling that interstellar brilliance! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>