<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Navigating the Command Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Odyssey: The Codebase Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Navigating the Command Bridge</h1>
<hr>
<p>As the SS Code Explorer glides into the tumultuous void of the Code Nebula, its stellar mission shifts into high gear. The crew finds themselves aboard the Command Bridge, tasked with unlocking the ship‚Äôs operational core. The bridge‚Äôs system hums with complexity‚Äîa lattice of modules, protocols, and tools waiting to be configured. Your role is to navigate the intricate networks of code to ensure seamless coordination of the starship&#39;s evolving functionality. The fate of a stabilized galaxy of source files begins here. Will you step into the spotlight and enable the ship to operate in cosmic harmony?</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Mapping Protocol</strong>: How does <code class="inline-code">setupHandlers</code> dynamically list and validate tools, ensuring compatibility within the system?</li>
<li>‚ö° <strong>Stellar Initialization</strong>: In <code class="inline-code">run</code>, what design decisions ensure efficient server startup and pre-loading content for seamless operation?</li>
<li>üõ°Ô∏è <strong>Error Containment Systems</strong>: How does <code class="inline-code">main</code> handle shutdown signals and unexpected promise rejections to maintain resilience?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Main MCP Server Operations</h3>
<p>This file contains the implementation of the MCP server, responsible for managing the starship&#39;s request and execution flows. The <code class="inline-code">RepoAdventureServer</code> class encapsulates the core server logic, enabling dynamic tool integration and modular handling of requests. It ensures tools function cohesively, connects transport mechanisms, and prepares the system for command inputs. Error handling mechanisms are also baked into the server‚Äôs lifecycle, ensuring smooth operation during unexpected inputs or failures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically creates handlers for listing available tools and executing specific tool commands. This modular approach keeps the system extensible with new tools while ensuring input validation.</li>
<li><code class="inline-code">run</code> initializes the server and pre-generates key cached content, enhancing responsiveness while launching background operations.</li>
<li><code class="inline-code">main</code> ensures graceful shutdown, signal handling, and promises durability during fatal errors or unexpected rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>The <code class="inline-code">setupHandlers</code> function dynamically defines handlers for both tool listing and execution with schema-based validation.</li>
<li>It uses <code class="inline-code">zodToJsonSchema</code> to ensure tools‚Äô schemas are compatible with external systems while staying type-safe.</li>
<li>Validates tool parameters against their schemas, reducing runtime errors and ensuring robust execution.</li>
<li>By centralizing error handling, it avoids cascading failures in invalid tool use cases.</li>
<li>Promotes modularity, making it simple to expand functionality with new tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  // Pre-generate repomix content for the current working directory to warm up the cache
  // This happens in the background while waiting for user commands
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <code class="inline-code">run</code> method initializes the server, binds to its transport, and outputs key state information to the logs.</li>
<li>It pre-generates the Repomix content in the background, reducing startup latency during the first tool execution.</li>
<li>Adopts asynchronous patterns for smooth server connection and parallel task management.</li>
<li>The design balances readiness (pre-loading data) and responsiveness (serving commands).</li>
<li>By warming up the analyzer cache, it minimizes delays during initial tool interaction.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function boots the server and registers system-level signals for graceful termination.</li>
<li>Signal handlers ensure a clean shutdown, invoking <code class="inline-code">gracefulShutdown</code> to preserve system integrity.</li>
<li>Captures <code class="inline-code">unhandledRejection</code> to log errors while maintaining uptime‚Äîsupporting resilience during transient errors.</li>
<li>Fatal startup errors are logged, and the process exits non-zero for clear diagnostics.</li>
<li>Demonstrates robust system-level safeguards and lifecycle management best practices.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>üåå When reading the code, track how <code class="inline-code">tools</code> is passed between components‚Äîthis structuring is key to extensibility.</li>
<li>üõ†Ô∏è Try modifying a tool‚Äôs schema or handler to follow its journey from validation to execution.</li>
<li>üöÄ Review how background tasks, like <code class="inline-code">preGenerate</code>, offload work while maintaining interactivity.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Stellar achievement, Cadet‚ÄîQuest 1 complete; you&#39;ve successfully charted the Command Bridge, igniting your thrusters for a galaxy of discoveries ahead! üöÄ‚ö°‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
</body>
</html>