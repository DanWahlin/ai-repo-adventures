<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Cosmic Control Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Code Expeditions: Navigating the Stellar Core</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Cosmic Control Interface</h1>
<hr>
<p>Emerging from the shimmering void of the Alpha Nebula, the ARCS crew encounters a labyrinth of interwoven digital starlines. Ancient programming signals scatter like comets across your navigation dashboard. Your primary mission is to establish a &quot;Cosmic Control Interface&quot; to unify the fragmented tools scattered throughout the MCP system. By forging this connection, ARCS can streamline starship operations and empower exploration crews to decode the galaxy&#39;s most enigmatic signals. Your adventure hinges on mastering the server&#39;s setup, execution flow, and the treasures hidden within its integrated tools.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Signal Linking</strong>: How does <code class="inline-code">setupHandlers</code> dynamically manage the registration and execution of tools within the MCP server, and how does it ensure compatibility with tool schemas?</li>
<li>‚ö° <strong>Flight Activation</strong>: In <code class="inline-code">run</code>, what operational steps are taken to initialize the MCP server and prepare the ship for quest execution?</li>
<li>üõ°Ô∏è <strong>Emergency Protocols</strong>: What mechanisms are implemented in <code class="inline-code">main</code> to handle unexpected errors or shutdown scenarios, and how do they ensure the system can recover or exit gracefully?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Initialization and Lifecycle</h3>
<p>This file contains the code responsible for launching the MCP server, handling tool invocations, and ensuring the system operates under safe and reliable conditions. It introduces the <code class="inline-code">RepoAdventureServer</code> class to manage server setup, connect handlers, and operate efficiently within the backdrop of the ARCS mission. Special focus is paid to dynamic tool validation, execution, and mechanisms to handle errors or graceful shutdown scenarios.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and their schemas with the MCP server, ensuring tool availability is modifiable during server runtime. This function is key to enabling interstellar adaptability for handling mission objectives.</li>
<li><code class="inline-code">run</code>: Activates the server&#39;s operational state, sets up its transport mechanism, and integrates functionality to pre-cache repomix content. This prepares the ARCS crew for uninterrupted exploration.</li>
<li><code class="inline-code">main</code>: Orchestrates the overall initialization process, including error handling and shutdown logic, ensuring system stability across adverse cosmic conditions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
</code></pre>
<ul>
<li>Dynamically compiles a list of available tools by retrieving their metadata and schemas.</li>
<li>Ensures that tools are registered in a way that allows them to validate any incoming request using the <code class="inline-code">zodToJsonSchema</code> utility.</li>
<li>Validates command arguments against predefined schemas to prevent invalid request execution.</li>
<li>Implements a robust error-handling mechanism to manage unknown tools or schema mismatches gracefully.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Establishes the data transport layer using <code class="inline-code">StdioServerTransport</code>, forming the primary communication link for space operations.</li>
<li>Logs initialization progress to inform the crew of the MCP server&#39;s readiness.</li>
<li>Triggers pre-caching of repomix content, minimizing latency during data retrieval and optimizing exploration workflows.</li>
<li>Integrates smoothly with the <code class="inline-code">repoAnalyzer</code> utility to facilitate proactive readiness for subsequent requests.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Initializes the server and wraps operational-critical operations in a <code class="inline-code">try-catch</code> block to ensure seamless recovery in case of fatal errors.</li>
<li>Adds signal listeners (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) to invoke the <code class="inline-code">gracefulShutdown</code> function for safety during server interruptions.</li>
<li>Implements specific logic to log unhandled promise rejections for better diagnostics without immediately shutting down the server.</li>
<li>Demonstrates comprehensive error handling and event-driven programming to ensure long-term stability across unforeseen circumstances.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <code class="inline-code">zodToJsonSchema</code> ensures compatibility between JSON schemas and expected input structures.</li>
<li>Consider extending the <code class="inline-code">setupHandlers</code> function to add new tools or custom logging mechanisms for detecting their invocation patterns.</li>
<li>Investigate the interplay between <code class="inline-code">repoAnalyzer.preGenerate</code> and other codebase tools to understand its effect on caching strategies.</li>
</ul>
<hr>
<p>The Cosmic Control Interface is active, captain! Your understanding of the MCP server ensures stable operations as ARCS ventures deeper into the Alpha Nebula. New quests await among the stellar horizons!</p>
<p>Mission Accomplished: You&#39;ve successfully navigated the stars of Quest 1 and unlocked the Cosmic Control Interface‚Äîstellar work, Commander, the universe is yours to chart! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>