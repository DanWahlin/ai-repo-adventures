<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: MCP Command Module - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Galactic Codex: The Adventures of RepoQuest</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: MCP Command Module</h1>
<hr>
<p>In the far reaches of the Andromeda cluster, the starship <em>RepoQuest</em> traverses a dense nebula of data, searching for cosmic whispers of uncharted knowledge. Among its many systems, the MCP Command Module emerges as the centerpiece‚Äîa console capable of decoding the Galactic Codex. To reconfigure its stellar tools and initialize the adventure ahead, you must first ensure seamless functionality. Navigate through dynamic handlers and validate operational pipelines to prepare for interstellar anomalies and coding conundrums.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Configuration and Handlers</h3>
<p>This file lies at the heart of the MCP command system, orchestrating server initialization and tool execution. Through its key methods, <code class="inline-code">RepoAdventureServer</code> defines how the MCP interprets incoming data streams and routes tool commands. The <code class="inline-code">setupHandlers</code> function dynamically lists and validates tools, connecting tool descriptions to their execution schemas. Additionally, the <code class="inline-code">run</code> function translates these commands into actionable outcomes while preloading repository data using <code class="inline-code">repoAnalyzer</code>. Finally, the <code class="inline-code">main</code> function ensures the server starts fault-tolerantly, enabling graceful shutdowns and robust error-handling.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code> dynamically registers tool commands based on the defined schema.</li>
<li><code class="inline-code">RepoAdventureServer.run</code> executes the server transport while initializing caches for efficiency.</li>
<li><code class="inline-code">main</code> safely launches the MCP server, handling edge cases like shutdown and unhandled promise rejections.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>Just like mapping a constellation, the <code class="inline-code">setupHandlers</code> method connects each tool to its purpose using schemas to coordinate input and execution.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p>Imagine initializing the ship&#39;s engines‚Äîthis <code class="inline-code">run</code> method powers up the server and ensures preemptive data with <code class="inline-code">repoAnalyzer</code>.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>Like preparing the crew for launch, <code class="inline-code">main</code> oversees server initialization and ensures safe operations regardless of unexpected interruptions.</p>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Adventure Tool Registration</h3>
<p>This file acts as the proverbial toolbox of the MCP module, importing and organizing essential adventure-handling tools. Through curated tools such as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>, the file encapsulates primary activities for interactive exploration. It‚Äôs built for extensibility, allowing seamless tool integration while maintaining a structured registration system.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> provides analysis initiation capability to facilitate the exploration setup.</li>
<li><code class="inline-code">choose_theme.handler</code> empowers users to select a theme, personalizing the experience.</li>
<li><code class="inline-code">explore_quest.handler</code> drives modular quest engagement, keeping narrative momentum alive.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
</code></pre>
<p>This line signals the start, akin to setting course for the cosmos with the <code class="inline-code">start_adventure</code> module.</p>
<pre><code class="language-typescript">import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
</code></pre>
<p>Choosing a theme is like defining a starship‚Äôs mission objective‚Äîit enables personalized cosmic narratives.</p>
<pre><code class="language-typescript">import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
</code></pre>
<p>Quest modules like these are the warp drives, propelling the starship through its galactic journey.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Consider running <code class="inline-code">RepoAdventureServer.run</code> first on test data to familiarize yourself with interstellar debugging.</li>
<li>Use <code class="inline-code">setupHandlers</code> to delve deep into tool functionality and execution paths.</li>
<li>Review <code class="inline-code">explore_quest.handler</code> to uncover quest-specific mechanics.</li>
</ul>
<hr>
<p>Brave Captain, your MCP Command Module is primed for operation! Chart your course through the Codex and guide your crew boldly where no algorithm has gone before.</p>
<p>Mission accomplished, cadet‚ÄîQuest 1: MCP Command Module is secure in the cosmic archives, propelling you one giant leap closer to interstellar mastery! üöÄ‚≠ê</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: AstroNavigation Systems ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>