<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Command Nexus: Activating the Heart of the Mission - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'space' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Odyssey in the Code Galaxy: Adventures Among the Stellar Repositories</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Command Nexus: Activating the Heart of the Mission</h1>
<hr>
<p>The <em>Refactor Prism</em> glides into orbit around the legendary MCP Command Nexus, a node pulsating with the potential to reshape the Code Galaxy. Here, the crew must engage the intricately programmed heart of their mission: the MCP Server. Equipped with tools that unearth insights and spark exploration, the crew’s challenge is vital but precise—activating the Nexus to unlock paths through the nebula of complexity that awaits. The server’s handlers and tools hum like charged stars, poised for action as the galaxy’s fate rests in their hands.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server protocol implementation</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> file serves as the Mission Control Protocol (MCP) server’s central hub, orchestrating interaction between the tools and their user interface. Using the <code class="inline-code">RepoAdventureServer</code> class, this file demonstrates how to register handlers, execute protocol requests (like <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code>), and establish a communication bridge with the <code class="inline-code">StdioServerTransport</code>. The <code class="inline-code">run()</code> method activates the server, prepares the file analysis cache with <code class="inline-code">repoAnalyzer.preGenerate()</code>, and connects the interface for user commands. The <code class="inline-code">main</code> function concludes with seamless shutdown procedures through signal interception for errors or terminations. Every function in this file works cohesively, akin to a navigation system aligning a vessel’s coordinates for interstellar travel.</p>
<h4>Highlights</h4>
<ul>
<li>Registers MCP protocol handlers for dynamic tool management (<code class="inline-code">setupHandlers()</code>).</li>
<li>Connects <code class="inline-code">StdioServerTransport</code> for user communication via standard I/O.</li>
<li>Integrates <code class="inline-code">repoAnalyzer</code> for background codebase analysis and caching.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP tool interface and interactive exploration support</h3>
<p>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> file is the toolbox powering the adventure experience. It imports specialized tools like <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>, each critical for gamified interaction with code repositories. By centralizing tools and binding them to function handlers, this file acts as a universal gateway for users to dive into their quests. The <code class="inline-code">tools</code> object maps these functions with their descriptions and schemas, enabling seamless execution during server interactions. Each tool functions like an exploration drone, equipped with sensors to collect, analyze, and present vital information in an accessible manner.</p>
<h4>Highlights</h4>
<ul>
<li>Maps core tools (<code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, etc.) for unified registration.</li>
<li>Links tools’ Zod schemas to ensure validated inputs for smooth operation.</li>
<li>Facilitates user interaction through structured handlers and descriptions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
}
</code></pre>
<p>The <code class="inline-code">setupHandlers()</code> method operates like mission control recording every incoming request and dispatching it to the right process.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p>The <code class="inline-code">main()</code> function is like firing up the command deck, ensuring all mission-critical systems react properly to any anomalies.</p>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>The <code class="inline-code">tools</code> object is like bundling up explorer gadgets in one cargo bay, calibrated for discovery operations.</p>
<pre><code class="language-typescript">import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

export const start_adventure = startAdventure;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;
</code></pre>
<p>By re-exporting tools, this file functions as a launch platform, preparing each module for deployment into the adventure framework.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers()</code> to understand how requests map to tool functions.</li>
<li>Explore input validation in <code class="inline-code">CallToolRequestSchema</code> to ensure user safety and system stability.</li>
<li>Dive into <code class="inline-code">start_adventure.handler</code> in <code class="inline-code">tools.ts</code> for insight into theme-driven story mechanics.</li>
</ul>
<hr>
<p>Bravo, Cadet—Quest 1 complete! You&#39;ve ignited the cosmic core of the MCP Command Nexus, propelling your mission into the vast expanse of discovery—keep charting the stars! 🚀💎⭐</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: Stargates of Imagination: The C... →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
</body>
</html>