<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The MCP Command Bridge - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Cosmic Codex: Adventures Across the Codebase Nebula</a>
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The MCP Command Bridge</h1>
<hr>
<p>As <em>The Refactored Voyager</em> drifts through the data streams of the Codebase Nebula, the ship&#39;s MCP Command Bridge hums with activity. Your mission: to initiate the command protocols needed to bridge the gap between your tools and the ship&#39;s core server. This quest demands precision and collaboration, as your crew must establish robust handlers, enable tool support, and ensure safe activation of the MCP server. With exploration at stake, the outcome will lay the foundation for all future galactic endeavors to decode the ancient repository.</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Command Interface Setup</h3>
<p>This file is the foundation of the MCP server, acting as the interaction hub between command protocols and starship operations. Specifically, the <code class="inline-code">RepoAdventureServer</code> class defines critical setup routines, including handlers for dynamic tool listing and execution using schemas from the <code class="inline-code">tools</code> file. Among its highlights, <code class="inline-code">setupHandlers</code> provides dynamic registration logic for tools, <code class="inline-code">run</code> initiates the server&#39;s operational state, and <code class="inline-code">main</code> orchestrates the program lifecycle. These methods ensure smooth interaction between server protocols and user commands, and also handle errors during critical moments.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Configures how tools are listed and activated dynamically.  </li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Executes server start, connecting transport layers and warming up the cache.  </li>
<li><code class="inline-code">main</code>: Orchestrates the server lifecycle, handling initialization and shutting down gracefully.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;
      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }
      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p><code class="inline-code">setupHandlers</code> is like configuring the neural pathways of the ship&#39;s AI, setting up inputs and responses for mission-critical tools.</p>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<p><code class="inline-code">run</code> can be thought of as activating the &quot;warp drive&quot; of the MCP server, propelling it into operational readiness.</p>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<p><code class="inline-code">main</code> operates as the mission captain, orchestrating deployment and ensuring safety protocols are in place during journeys.</p>
<h2>Helpful Hints</h2>
<ul>
<li><strong>Practical Tip</strong>: When expanding tool availability, first add definitions in <code class="inline-code">tools.ts</code>. Ensure schemas and handlers align precisely.</li>
<li><strong>Exploration Tip</strong>: Investigate <code class="inline-code">tools.js</code> next for insight into how specific tools integrate with server requests.  </li>
<li><strong>Next Steps</strong>: Once handlers are in place, bootstrap the MCP server and test interactive commands using a sample project.</li>
</ul>
<hr>
<p>The MCP Command Bridge is prepared, captain! Server handlers mapped and systems initialized ‚Äì onward to cosmic discovery!</p>
<p>Mission accomplished, Commander! You&#39;ve successfully navigated the cosmic labyrinth of the MCP Command Bridge‚Äîstellar work propelling you into orbit for the quests ahead! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom nav-next-only">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>