<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Protocol Keepers of the MCP Sanctum - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'developer' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Codex of Repomix: Chronicles of the Advent</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Protocol Keepers of the MCP Sanctum</h1>
<hr>
<p>In the sprawling digital expanse of the <em>Codex of Repomix</em>, the elusive <strong>Protocol Keepers</strong> guard the pathways to interactive code adventures. As the developer-turned-adventurer, you&#39;ve uncovered the <strong>MCP Sanctum</strong>, an ancient core of protocol handlers and tools that powers the storytelling engine. Your quest is to delve deep into its architecture, unlock its secrets, and understand how it bridges the gap between data handling and gamified exploration. The Sanctum awaits your expertiseâ€”tools ready, handlers set, and repomix hummingâ€”are you prepared to navigate the labyrinth?</p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server protocol and transport system</h3>
<p>The <code class="inline-code">server.ts</code> file is the cornerstone of the <strong>MCP Sanctum</strong>, orchestrating the protocol for the entire adventure. The file introduces the <code class="inline-code">RepoAdventureServer</code> class, which initializes and manages the MCP server. Among its functions, <code class="inline-code">setupHandlers()</code> dynamically registers tool handlers for managing <code class="inline-code">ListTools</code> and <code class="inline-code">CallTool</code> requests, ensuring adaptability in tool interaction. The <code class="inline-code">run()</code> method establishes communication using the <code class="inline-code">StdioServerTransport</code> and pre-generates repomix data for the working directory, warming up the system for smooth responses during an adventure. The <code class="inline-code">main()</code> function acts as the entry point, wrapping the server in robust error handling, including shutdown signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) for graceful termination.</p>
<p>This file highlights the interplay between JSON schema validation (via <code class="inline-code">zodToJsonSchema</code>), structured error handling through <code class="inline-code">McpError</code>, and the seamless integration of tools managed in <code class="inline-code">tools.ts</code>. By abstracting away the low-level intricacies with the <code class="inline-code">Server</code> SDK and <code class="inline-code">repoAnalyzer</code>, the file ensures the MCP remains approachable for both developers and adventurous users.</p>
<h4>Highlights</h4>
<ul>
<li>Dynamic tool registration through <code class="inline-code">setupHandlers()</code> ensures extensibility of adventure tools.</li>
<li>Efficient startup procedures in <code class="inline-code">run()</code>, including warm-ups for faster repomix processing.</li>
<li>Comprehensive error handling and signal management in <code class="inline-code">main()</code> for reliable runtime behavior.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> MCP tool definitions and entry points</h3>
<p><code class="inline-code">tools.ts</code> serves as the tool station for the adventure system, offering a curated collection of MCP tools defined in separate modules. Each toolâ€”such as <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>â€”represents a distinct functional step in the storytelling workflow. The <code class="inline-code">tools</code> object bundles all of these for easy registration, while the shared <code class="inline-code">adventureManager</code> enables tools to access a unified context for maintaining state and logic.</p>
<p>This modular design makes the adventure framework scalable, allowing new tools to be added without disrupting existing functionality. Furthermore, each tool comes with well-documented descriptions, showcasing their place within the typical developer workflow. The file not only bridges the gap between the backend engine and the MCP client but also adheres to a clean and maintainable architecture.</p>
<h4>Highlights</h4>
<ul>
<li>Centralized tool registration using the <code class="inline-code">tools</code> export streamlines extensibility.</li>
<li>Modularized functionality ensures that each tool operates independently yet harmoniously.</li>
<li>The shared <code class="inline-code">adventureManager</code> fosters a consistent context across tool interactions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      // Validate arguments using the tool&#39;s Zod schema
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      // Execute the tool handler with validated arguments
      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<p>This code works like a command center, dynamically dispatching tools and ensuring every interaction is validated and precise.</p>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<p>This block functions as a toolbox, bundling independent utilities into a cohesive and accessible collection.</p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">setupHandlers()</code> as a blueprint for extending MCP protocol capabilities with new tool integrations.</li>
<li>Explore <code class="inline-code">start_adventure.handler</code> and <code class="inline-code">choose_theme.handler</code> in <code class="inline-code">tools.js</code> for deeper insights into interactive storytelling.</li>
<li>Next, review the <code class="inline-code">adventure-manager.ts</code> file for understanding adventure orchestration with state management.</li>
</ul>
<hr>
<p>ðŸŽ‰ Congratulations on resolving &quot;Quest 1: The Protocol Keepers of the MCP Sanctum&quot;â€”your debugging prowess and commitment to refactoring unnecessary complexity have set the foundation for scalable success; onward to the next function call! ðŸš€âš¡ðŸ’Ž</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="next-quest-btn">Next: Quest 2: The Architectâ€™s Tome in the Cha... â†’</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>