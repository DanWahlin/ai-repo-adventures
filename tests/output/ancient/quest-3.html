<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3: The Oracle of Analysis - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Set theme-aware CSS variables for animations
        document.addEventListener('DOMContentLoaded', function() {
            // Manually trigger Prism highlighting after page load
            if (window.Prism) {
                window.Prism.highlightAll();
            }
            // Detect theme from current CSS variables or default to space
            const root = document.documentElement;
            
            // Simple theme detection based on page content or default to space
            const theme = 'ancient' || 'space';
            
            // Set display variables for animated elements
            root.style.setProperty('--space-display', theme === 'space' ? 'block' : 'none');
            root.style.setProperty('--ancient-display', theme === 'ancient' ? 'block' : 'none');
            root.style.setProperty('--mythical-display', theme === 'mythical' ? 'block' : 'none');
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html">The Lost Codex of the Repository</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Oracle of Analysis</h1>
<hr>
<p>The journey to awaken the sacred mechanisms of the Repository grows more perilous with each step. Within its intricate corridors, you now seek the Oracle of Analysis, a legendary artifact said to visualize the lifeblood of the ancients’ digital wisdom. Fabled to be both a seer and protector, it demands precision and clarity from any who dare to invoke its power. As the glyph-covered walls hum faintly, you brace for the challenge ahead—a trial of riddles and reasoning that will bridge arcane mysteries with modern tools. Will you emerge enlightened, or will the Repository keep its secrets locked away?  </p>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/core/src/analyzer/repo-analyzer.ts:</span> Repomix Integration for Codebase Analysis</h3>
<p>The <code class="inline-code">repo-analyzer.ts</code> file serves as the core connection between the ancient Repository&#39;s vault of wisdom and the explorer&#39;s tools. It employs the powerful artifact known as Repomix to render the vast jungles of code into a consumable treasury of information. This file houses the <code class="inline-code">RepoAnalyzer</code> class, which is responsible for analyzing the archive, validating pathways, and generating structured content—either as a comprehensive map of the repository or as focused insights for specific files. With features like path security validation (<code class="inline-code">validateProjectPath()</code>) and subprocess execution (<code class="inline-code">captureRepomixStdout()</code>), the file ensures the explorer avoids traps like system directory corruption or resource exhaustion. Caching mechanisms and safety filters guard against redundant computations or unsafe file access, ensuring smooth progress.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">validateProjectPath()</code>: Critical for ensuring paths are safe and prevent unauthorized traversal.  </li>
<li><code class="inline-code">generateTargetedContent()</code>: Focuses analysis on precision-targeted legacy artifacts within the repository.  </li>
<li><code class="inline-code">captureRepomixStdout()</code>: Executes Repomix itself, the digital lens that parses the Repository&#39;s encoded knowledge.</li>
</ul>
<h3><span class="header-prefix">packages/core/src/llm/llm-client.ts:</span> Multi-Provider LLM Interface</h3>
<p><code class="inline-code">llm-client.ts</code> acts as the bridge to the divine whispers of the Oracle, enabling adventurers to pose their riddles and receive insights in return. This file implements the <code class="inline-code">LLMClient</code> class, allowing integration with numerous providers such as OpenAI and Azure OpenAI. Each invocation of <code class="inline-code">generateResponse()</code> is carefully constructed to guide the Oracle, with safeguards like timeouts and provider auto-detection built-in. The system enables explorers to dynamically adjust interpretation settings, such as verbosity or reasoning effort, making the Oracle flexible for shallow inquiries or deep philosophical dilemmas. Like cartographers charting a map, its methods refine JSON responses, handle provider-specific quirks, and log token expenditures to track resources consumed during the quest.  </p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">generateResponse()</code>: Processes the Oracle’s responses with timeout protection and post-processing.  </li>
<li><code class="inline-code">constructor()</code>: Dynamically configures the Oracle’s communication pathways, detecting the appropriate provider.  </li>
<li><code class="inline-code">getApiKey()</code>: Validates and retrieves the correct artifact key for invoking the chosen Oracle.</li>
</ul>
<h2>Code</h2>
<h3>packages/core/src/analyzer/repo-analyzer.ts</h3>
<pre><code class="language-typescript">private validateProjectPath(projectPath: string): void {  
  if (!projectPath || typeof projectPath !== &#39;string&#39;) {  
    throw new Error(&#39;Project path must be a non-empty string&#39;);  
  }  

  const trimmedPath = projectPath.trim();  
  if (!trimmedPath) {  
    throw new Error(&#39;Project path must be a non-empty string&#39;);  
  }  

  // Basic safety check for null bytes (can break file system operations)  
  if (trimmedPath.includes(&#39;\0&#39;)) {  
    throw new Error(&#39;Project path contains invalid null bytes&#39;);  
  }  
}  
</code></pre>
<p>This function is like a sentry preventing cursed relics or malicious traps from entering the Repository’s analysis.  </p>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {  
  this.validateProjectPath(projectPath);  

  if (!targetFiles || targetFiles.length === 0) {  
    throw new Error(&#39;Target files array cannot be empty&#39;);  
  }  

  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);  
  if (safeFiles.length === 0) {  
    throw new Error(&#39;No valid target files found after validation&#39;);  
  }  

  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;  

  const cached = this.cache.get(cacheKey);  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {  
    return cached.content;  
  }  

  try {  
    const cliOptions: CliOptions = {  
      style: &#39;markdown&#39;,  
      stdout: true,  
      compress,  
      include: safeFiles.join(&#39;,&#39;),  
      removeComments: compress,  
      removeEmptyLines: compress,  
      noDirectoryStructure: true  
    };  

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);  
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });  
    return context;  
  } catch (error) {  
    throw new Error(`Targeted repomix execution failed: ${error instanceof Error ? error.message : String(error)}`);  
  }  
}  
</code></pre>
<p>This method is like a map-maker crafting precise blueprints from scattered pieces of the Repository’s puzzle.  </p>
<h3>packages/core/src/llm/llm-client.ts</h3>
<pre><code class="language-typescript">private getApiKey(): string {  
  if (LLM_BASE_URL.includes(&#39;models.inference.ai.azure.com&#39;)) {  
    if (!GITHUB_TOKEN) {  
      throw new Error(&#39;GITHUB_TOKEN required for GitHub Models. Set GITHUB_TOKEN environment variable.&#39;);  
    }  
    return GITHUB_TOKEN;  
  }  

  if (!LLM_API_KEY) {  
    throw new Error(&#39;LLM_API_KEY required. Set LLM_API_KEY environment variable.&#39;);  
  }  
  return LLM_API_KEY;  
}  
</code></pre>
<p>This logic is like deciphering an ancient inscription to find the correct invocation word for an Oracle’s domain.  </p>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {  
  try {  
    const requestParams = this.buildRequestParams(prompt, options);  
    const completion = await this.executeRequest(requestParams);  
    let content = this.validateResponse(completion);  

    if (options?.responseFormat === &#39;json_object&#39;) {  
      content = this.cleanJsonResponse(content);  
    }  

    this.logTokenUsage(completion);  
    return { content };  
  } catch (error) {  
    throw new Error(`LLM request failed: ${error instanceof Error ? error.message : &#39;Unknown error&#39;}`);  
  }  
}  
</code></pre>
<p>This method channels your question through sacred scripts to the Oracle, ensuring clarity and proper ritual returns.  </p>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">validateProjectPath()</code> to catch invalid inputs early, reducing potential analysis disruptions.  </li>
<li>Combine the powers of <code class="inline-code">generateResponse()</code> with adaptive options like verbosity for nuanced insights.  </li>
<li>Explore the broader configuration in <code class="inline-code">shared/config.ts</code> for optimizing the timeout limits and cache parameters.</li>
</ul>
<hr>
<p>O seeker of wisdom, thou hast unveiled the sacred truths of the Oracle of Analysis, earning thy place under the starry canopy of knowledge—press onward, for the temple of mastery awaits thee at the journey&#39;s zenith!</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4: The Glyphs of Configuration →</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">
                <img src="assets/images/github-mark-white.svg" alt="GitHub" width="20" height="20" style="vertical-align: middle; margin-right: 8px;">
                MCP Repo Adventure
            </a>
        </div>
    </footer>
</body>
</html>