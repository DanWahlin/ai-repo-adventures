<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Mastering the MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Repository of Legends: The Code Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content quest-content-override">
    <h1>Quest 1: Mastering the MCP Tool Interface</h1>
<hr>
<p>In an ancient realm of digital kingdoms, the Repository of Legends holds many secrets for adventurous coders. Within its depths lies the <strong>Code Chronicles</strong>, designed to create unique journeys through the lands of programming lore. The valiant <code class="inline-code">Repo Rangers</code> work tirelessly to align automated creativity with intentional design. To join their ranks, you must first unlock the mysteries of the MCP Tool Interface, the centerpiece of their power. Beware‚Äîonly by mastering its intricacies can harmony be restored to the Repository.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Integration Enigma</strong>: How does <code class="inline-code">setupHandlers</code> dynamically manage tools in the MCP server?</li>
<li>‚ö° <strong>Operation Launch Sequence</strong>: What system-level preparations occur during the <code class="inline-code">run</code> function&#39;s execution?</li>
<li>üõ°Ô∏è <strong>Defense Protocol</strong>: How does the <code class="inline-code">main</code> function ensure resilience against unexpected failures or shutdowns?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Implementation</h3>
<p>This file initializes and manages the MCP server for interacting with tools and quests. Its core functions (<code class="inline-code">setupHandlers</code>, <code class="inline-code">run</code>, and <code class="inline-code">main</code>) demonstrate advanced patterns in server behavior, dynamic tool integration, and error handling strategies. The file showcases the interplay between server initialization, dynamic execution flows, and preemptive system safeguards to ensure stability during interactive adventures.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Configures the server to dynamically list and execute tools based on schemas, providing a seamless integration with the MCP interface.  </li>
<li><code class="inline-code">run</code>: Launches the server transport layer, pre-generates content using <code class="inline-code">repoAnalyzer</code>, and prepares for user inputs to ensure minimal latency in subsequent operations.  </li>
<li><code class="inline-code">main</code>: Orchestrates global error handling and signal-based graceful shutdown to secure consistent server performance during stressful conditions.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically lists available tools and their schemas, ensuring extensibility when new tools are added.  </li>
<li>Validates input parameters using Zod schemas, a robust mechanism for input safety.  </li>
<li>Handles discrepancies via MCP-specific error codes, maintaining strict protocol alignment.  </li>
<li>Demonstrates modular tool integration with reusable API definitions.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes MCP server transport, enabling standard input/output communication.  </li>
<li>Pre-generates repository content using <code class="inline-code">repoAnalyzer</code>, optimizing adventure execution.  </li>
<li>Logs key milestones, aiding observability during server operation.  </li>
<li>Prepares the system to minimize delays during runtime content generation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Implements signal handling for graceful shutdown, avoiding abrupt disruptions during termination events.  </li>
<li>Provides robust fallback by catching unhandled promise rejections without halting server operations.  </li>
<li>Propagates detailed error logs, enabling rapid debugging and recovery during failure.  </li>
<li>Combines initialization, cleanup, and error management into a centralized entry point.</li>
</ul>
<hr>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool Registration and Export</h3>
<p>This file registers multiple tools‚Äîeach facilitating one aspect of the MCP interactive experience. By exporting tools in a unified format (e.g., <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>), the file enables seamless integration between the core MCP server and auxiliary code exploration flows.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Initiates repository analysis and prepares theme generation.  </li>
<li><code class="inline-code">choose_theme.handler</code>: Enables users to select storytelling and quest themes for customization.  </li>
<li><code class="inline-code">explore_quest.handler</code>: Guides users through interactive exploration of specific quests.  </li>
<li><code class="inline-code">view_progress.handler</code>: Monitors completion rates and provides updates on remaining quests.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;

export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Exports all tools in a centralized, namespace-friendly format, preventing name collisions.  </li>
<li>Acts as a single entry point for tool availability, simplifying server-side integration.  </li>
<li>Enables dynamic tool discovery in <code class="inline-code">setupHandlers</code>, tying user inputs to specific adventure actions.  </li>
<li>Organizes tools into intuitive categories for easier maintenance and scalability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Familiarize yourself with Zod validation patterns to enhance input safety for tool handlers.  </li>
<li>Study signal processing in the <code class="inline-code">main</code> function to implement graceful shutdowns in other Node.js projects.  </li>
<li>Experiment with extending <code class="inline-code">tools</code> to add custom MCP functionalities.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries within the Repository of Legends.</p>
<p>üéâüèÜ Congratulations, developer! You&#39;ve successfully debugged your way through Quest 1, achieving a clean build and mastering the MCP Tool Interface‚Äîonward to coding glory! üöÄ‚ö°üíé</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>