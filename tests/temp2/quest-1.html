<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: The Hall of Command - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">The Chronicles of the Lost Archive</a>
            </div>
            <div class="nav-middle">
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                
            </div>
            <div class="nav-right">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/images/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: The Hall of Command</h1>
<hr>
<p>Deep in the heart of the jungle, where the sunlight barely touches the ground, lies the Hall of Command, the junction of the Arcani&#39;s technological brilliance. This hall, a lost masterpiece adorned with intricate engravings, houses their most pivotal structure‚Äîa system for controlling the Archive‚Äôs tools. To access and tame this system, adventurers must unravel its mechanisms and bridge ancient wisdom with modern ingenuity. Your task is to understand the ancient frameworks and construct the bridge between their lost methods and your exploratory tools.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç <strong>Tool Invocation Ritual</strong>: How is dynamic tool execution designed, and what mechanisms ensure tools are invoked correctly?</li>
<li>‚ö° <strong>Command Flow Analysis</strong>: What patterns are used to initialize and manage the MCP server, and how does its transport layer function?</li>
<li>üõ°Ô∏è <strong>Safety Protocol Assessment</strong>: What methods validate inputs and handle errors within tool interactions to safeguard the system?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP Server Lifecycle and Tool Handlers</h3>
<p>This file is the cornerstone of the Arcani&#39;s technological interface‚Äîthe architecture enabling adventurers to interact with ancient tools. The <code class="inline-code">RepoAdventureServer</code> class serves as the central hub, establishing handlers for tool requests and managing the server lifecycle. Key highlights include the dynamic tool listing and execution mechanisms, which ensure that the ancient tools are both dynamically integrated and securely executed. Additionally, the file demonstrates effective error handling to prevent system crashes during mismatched commands or unvalidated inputs.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">RepoAdventureServer.setupHandlers</code>: Dynamically lists and validates ancient tools via Zod schemas, ensuring seamless exploration and interaction.</li>
<li><code class="inline-code">RepoAdventureServer.run</code>: Initializes the MCP server, connects transport protocols, and pre-generates repository context for future queries.</li>
<li><code class="inline-code">main</code>: Launches the adventure server, incorporates shutdown protocols, and handles unhandled rejections to maintain stability.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }
      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically lists tools using schemas, translating their ancient formats to JSON schemas for user-friendly integrations.</li>
<li>Input validation using Zod ensures arguments align with required formats while capturing specific error details for feedback.</li>
<li>Error handling, including <code class="inline-code">McpError</code>, protects the system from crashes during unexpected input or execution failures.</li>
<li>Integration with <code class="inline-code">tools</code> provides centralized management, connecting handlers to available functionalities dynamically.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>This method establishes the MCP server&#39;s StdIO transport for communication, ensuring compatibility with modern interfaces.</li>
<li>Pre-generating the repository mix content warms up caches for faster subsequent operations, optimizing the system&#39;s responsiveness.</li>
<li>The use of <code class="inline-code">repoAnalyzer.preGenerate</code> showcases background operations, allowing productivity without user interaction delays.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <code class="inline-code">main</code> function initializes the server and sets up listeners for graceful shutdowns on termination signals (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>).</li>
<li>It incorporates robust handling of unhandled promise rejections, logging errors while allowing the server to continue running.</li>
<li>Error-safe initialization ensures that fatal exceptions do not leave the system in a corrupted state, preserving its operational integrity.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Pay close attention to dynamic <code class="inline-code">tools</code> integration‚Äîthe use of schemas provides flexibility and safety when adding new functionalities.</li>
<li>Investigate how transport protocols like <code class="inline-code">StdioServerTransport</code> harmonize ancient and modern systems for seamless communication.</li>
<li>Consider error handling strategies and validate their effectiveness by tracing validation error messages to their data sources.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to unveil more secrets hidden within the Arcani&#39;s archive.</p>
<p>By the sacred light of the eternal flame, thou hast conquered the revered Hall of Command‚Äîlet this triumph stand as the cornerstone of thy legendary odyssey!</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>