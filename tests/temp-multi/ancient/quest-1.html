<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Gatekeepers of the Outer Courtyard - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Chronicles of the Hidden Repository</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Theme</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Gatekeepers of the Outer Courtyard</h1>
<hr>
<p>Beneath sandstone lintels, you step into the archive‚Äôs outer courtyard. The air smells of papyrus and dusted ink. Stone plinths display scripts like ceremonial maps, each glyph an invocation that stirs tools from slumber. Here, <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a> raises the gate and orders the procession, while <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> arrays the implements like etched relics ready for use. Your task is to study how the keepers greet visitors, list artifacts, and validate rites before any invocation. Read the carvings, note the sequences, and learn how the courtyard enforces order.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Gate Roster Audit: How does <code class="inline-code">setupHandlers</code> translate Zod schemas into JSON schemas for the tool roster, and what pattern ensures every tool exposes both <code class="inline-code">description</code> and <code class="inline-code">inputSchema</code>?</li>
<li>‚ö° Invocation Circuit: In <code class="inline-code">run</code>, how does the server initialize transport, announce status, and warm caches through <code class="inline-code">repoAnalyzer.preGenerate</code>, and why is this performed after connection?</li>
<li>üõ°Ô∏è Sentinel Protocols: In <code class="inline-code">main</code>, how are shutdown signals and unhandled rejections handled differently, and what design choice avoids premature termination during recoverable issues?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> The courtyard‚Äôs gatekeeper that registers rituals, validates invocations, and maintains orderly passage</h3>
<p>In this chamber, <code class="inline-code">RepoAdventureServer</code> constructs the ceremonial server and binds handlers that govern how visitors discover and invoke tools. The <code class="inline-code">setupHandlers</code> rite crafts a dynamic register from <code class="inline-code">tools</code>, converting each tool‚Äôs <code class="inline-code">schema</code> with <code class="inline-code">zodToJsonSchema</code>. This ensures the courtyard presents a clear, standardized <code class="inline-code">inputSchema</code> to any seeker. The execution path in <code class="inline-code">CallToolRequestSchema</code> is a careful procession: confirm the tool exists, validate arguments with <code class="inline-code">schema.safeParse</code>, construct precise error inscriptions via <code class="inline-code">McpError</code>, then execute the <code class="inline-code">handler</code>. The <code class="inline-code">run</code> march connects a <code class="inline-code">StdioServerTransport</code>, announces readiness, and discreetly warms the archive by calling <code class="inline-code">repoAnalyzer.preGenerate</code> on the current project path. The <code class="inline-code">main</code> conductor arranges graceful exits through <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, and separates unhandled rejections from fatal errors so the courtyard does not close prematurely. Together, these inscriptions reveal a design that values discoverability, validation, and resilience, allowing each ceremony to proceed safely while maintaining a welcoming facade for explorers arriving across the sands.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically publishes tools and enforces argument validation, turning Zod definitions into JSON schema for discoverability.</li>
<li><code class="inline-code">run</code> activates the stdio transport, logs operational state, and triggers <code class="inline-code">repoAnalyzer.preGenerate</code> to warm analysis caches without blocking.</li>
<li><code class="inline-code">main</code> orchestrates lifecycle: constructs the server, installs signal handlers for orderly shutdown, and logs unhandled rejections without halting.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}

function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}

async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>The <code class="inline-code">setupHandlers</code> rite declares two handlers: listing tools via <code class="inline-code">ListToolsRequestSchema</code> and executing them with <code class="inline-code">CallToolRequestSchema</code>.</li>
<li>It converts each tool‚Äôs Zod <code class="inline-code">schema</code> to JSON Schema using <code class="inline-code">zodToJsonSchema</code>, ensuring clients receive standardized <code class="inline-code">inputSchema</code>.</li>
<li>Validation via <code class="inline-code">schema.safeParse</code> produces targeted <code class="inline-code">McpError</code> messages for precise, actionable feedback.</li>
<li><code class="inline-code">run</code> connects the <code class="inline-code">StdioServerTransport</code> before warming caches, preventing delayed availability while background prep proceeds.</li>
<li><code class="inline-code">main</code> separates graceful shutdown, non-fatal rejection logging, and fatal startup errors to safeguard uptime.</li>
</ul>
<hr>
<pre><code class="language-typescript">#!/usr/bin/env node

import { Server } from &#39;@modelcontextprotocol/sdk/server/index.js&#39;;
import { StdioServerTransport } from &#39;@modelcontextprotocol/sdk/server/stdio.js&#39;;
import {
  CallToolRequestSchema,
  ErrorCode,
  ListToolsRequestSchema,
  McpError,
} from &#39;@modelcontextprotocol/sdk/types.js&#39;;
import { tools } from &#39;./tools.js&#39;;
import { zodToJsonSchema } from &#39;zod-to-json-schema&#39;;
import { repoAnalyzer } from &#39;@ai-repo-adventures/core/analyzer&#39;;
</code></pre>
<ul>
<li>These imports reveal the ceremonial dependencies: MCP server core, stdio transport, request schemas, and error taxonomy.</li>
<li>Pulling <code class="inline-code">tools</code> from <code class="inline-code">./tools.js</code> centralizes ritual artifacts, enabling dynamic registration patterns.</li>
<li><code class="inline-code">zodToJsonSchema</code> bridges validation intent to a discoverable schema format clients can introspect.</li>
<li><code class="inline-code">repoAnalyzer</code> enables background content generation for snappier invocations after startup.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}
</code></pre>
<ul>
<li>Encapsulates a single exit path that attempts cleanup without risking a crash if cleanup fails.</li>
<li>Uses <code class="inline-code">repoAnalyzer.cleanup</code> to release resources and avoid lingering caches.</li>
<li>Logs both the intent to shut down and any cleanup anomalies for post-mortem clarity.</li>
<li>Forces process exit to prevent half-closed states that could corrupt subsequent rituals.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Serves as the reliquary that exposes all ritual implements in a uniform shape.</li>
<li>Applies a consistent naming convention to match MCP expectations, mapping local modules to exported tool names.</li>
<li>Aggregates the artifacts into a single <code class="inline-code">tools</code> object, enabling <code class="inline-code">setupHandlers</code> to enumerate and publish schemas.</li>
<li>Exports <code class="inline-code">adventureManager</code> for shared state across tool handlers, ensuring continuity between invocations.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Trace the flow from <code class="inline-code">tools</code> export to <code class="inline-code">setupHandlers</code> mapping to understand how schemas reach clients.</li>
<li>Compare error branches in <code class="inline-code">setupHandlers</code> execution to see how <code class="inline-code">McpError</code> codes shape client feedback.</li>
<li>Consider why cache warming in <code class="inline-code">run</code> is non-blocking and how it improves early responsiveness.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Hail, seeker of wisdom‚Äîby vanquishing the Gatekeepers of the Outer Courtyard in Quest 1, thou hast crossed the temple‚Äôs threshold and inscribed thy name upon the sacred stele of learning, a triumphant first step toward the fivefold mysteries that await, let the bronze gongs resound and the torches blaze ‚≠ê‚ö°.</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>