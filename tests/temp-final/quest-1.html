<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Command Bridge Synchronization - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Repo Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Command Bridge Synchronization</h1>
<hr>
<p>Your starship drifts into the command bridge nebula, where control relays hum and telemetry beacons blink like distant quasars. The mission is to synchronize the bridge: wire up the tool consoles, validate incoming commands, and align the transport relays so the crew can chart repositories as constellations. As captain, you‚Äôll study how handlers broadcast tool inventories, authenticate parameters, and engage stdio thrusters for stable orbit. Tune into narrative telemetry, watch for signal faults, and confirm the analyzer‚Äôs pre-generation sweep to warm the cache for swift navigation.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">setupHandlers</code> transform Zod schemas into JSON Schema for tool discovery, and what pattern ensures every tool is listed consistently?</li>
<li>‚ö° Thruster Ignition Flow: In <code class="inline-code">run</code>, why is the stdio transport established before pre-generation, and how does that sequencing affect responsiveness and caching?</li>
<li>üõ°Ô∏è Fault Containment Shields: In <code class="inline-code">main</code>, how do signal listeners and unhandled rejection handling cooperate to keep the server resilient without premature shutdowns?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> MCP server wiring and lifecycle control</h3>
<p>This file establishes the command bridge for your MCP starship. The <code class="inline-code">RepoAdventureServer</code> class constructs a <code class="inline-code">Server</code> configured with metadata and capabilities, then invokes <code class="inline-code">setupHandlers</code> to wire two critical request handlers: one for listing tools and another for calling tools. The listing path converts each tool‚Äôs Zod <code class="inline-code">schema</code> to JSON Schema via <code class="inline-code">zodToJsonSchema</code>, ensuring interoperable discovery by clients that expect JSON Schema 7 without <code class="inline-code">$ref</code> nesting. The call path validates incoming arguments using <code class="inline-code">schema.safeParse</code>, surfacing aggregated parameter issues through <code class="inline-code">McpError</code> with <code class="inline-code">InvalidParams</code>, and executing the <code class="inline-code">handler</code> only when validation passes. Errors are consistently mapped to <code class="inline-code">McpError</code> types to maintain protocol semantics.</p>
<p>The <code class="inline-code">run</code> method docks the server to the <code class="inline-code">StdioServerTransport</code> for stable telemetry I/O, prints operational logs, and then triggers <code class="inline-code">repoAnalyzer.preGenerate(projectPath)</code> to warm caches by generating repomix content in the background. This sequencing keeps the server responsive while preparing analytical data. The <code class="inline-code">main</code> function orchestrates lifecycle safety: it registers <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code> listeners for graceful cleanup via <code class="inline-code">gracefulShutdown</code>, handles <code class="inline-code">unhandledRejection</code> with logging (without aborting), and robustly reports fatal startup errors. Together, these routines synchronize the command bridge, ensuring a reliable navigation stack for tool discovery and execution.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> orchestrates dynamic tool discovery and invocation, converting Zod schemas to JSON Schema and enforcing strict parameter validation before executing tool handlers.</li>
<li><code class="inline-code">run</code> activates stdio transport for protocol communication and pre-generates analyzer content asynchronously to prime performance without blocking startup.</li>
<li><code class="inline-code">main</code> bootstraps the server, installs signal handlers for graceful termination, and contains unhandled rejections to maintain continuous mission operations.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }
}
</code></pre>
<ul>
<li>Establishes the MCP <code class="inline-code">Server</code> and registers two request handlers, creating a central hub for tool discovery and execution.</li>
<li>Uses <code class="inline-code">zodToJsonSchema</code> with <code class="inline-code">target: &#39;jsonSchema7&#39;</code> and <code class="inline-code">$refStrategy: &#39;none&#39;</code> to normalize schemas for clients, avoiding nested references.</li>
<li>Validates inputs with <code class="inline-code">schema.safeParse</code>, aggregating detailed error messages for precise client feedback.</li>
<li>Maps failures to <code class="inline-code">McpError</code> with specific <code class="inline-code">ErrorCode</code> values, preserving protocol-level semantics and predictable error handling.</li>
<li>Decouples listing and execution concerns but unifies both through the <code class="inline-code">tools</code> registry, enabling dynamic extensibility.</li>
</ul>
<hr>
<pre><code class="language-typescript">  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
</code></pre>
<ul>
<li>Connects the server to stdio transport first, ensuring immediate readiness for incoming requests.</li>
<li>Initiates background pre-generation to warm caches without blocking, improving later analyzer operations.</li>
<li>Logs operation states to stderr for visibility in constrained transport environments.</li>
<li>Uses <code class="inline-code">process.cwd()</code> to align analysis with the active mission directory, matching how tools will reference files.</li>
<li>Demonstrates a non-blocking performance strategy: establish communication, then optimize.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li>Coordinates lifecycle: constructs the server, registers signal handlers, and starts operations.</li>
<li>Graceful shutdown via <code class="inline-code">gracefulShutdown</code> preserves analyzer hygiene with <code class="inline-code">repoAnalyzer.cleanup</code>.</li>
<li>Logs unhandled rejections while keeping the process alive, prioritizing mission continuity.</li>
<li>Encapsulates fatal start errors with a clear exit path, preventing partial initialization states.</li>
<li>Uses a final catch on <code class="inline-code">main()</code> to capture out-of-band errors, ensuring no silent failures.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Centralizes tool exports and unifies naming for MCP clients via <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, <code class="inline-code">view_progress</code>.</li>
<li>Provides a <code class="inline-code">tools</code> registry that <code class="inline-code">server.ts</code> consumes for dynamic listing and invocation.</li>
<li>Re-exports <code class="inline-code">adventureManager</code> to share stateful orchestration across tools without tight coupling.</li>
<li>Splits each tool into its own module for maintainability while preserving a single integration point.</li>
<li>Establishes a consistent surface for schema validation and handler execution used by <code class="inline-code">setupHandlers</code>.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Trace the flow: listing, validation, then execution. Follow how <code class="inline-code">tools</code> maps to schemas and handlers.</li>
<li>Compare error paths: <code class="inline-code">MethodNotFound</code>, <code class="inline-code">InvalidParams</code>, and <code class="inline-code">InternalError</code> show layered guardrails.</li>
<li>Watch logs during startup to confirm stdio connection precedes analyzer pre-generation.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Update: With Quest 1: Command Bridge Synchronization successfully aligned, your starship‚Äôs core systems are now in perfect orbit‚Äîstellar work, Cadet‚Äîprepare to ignite thrusters for the next leg of the journey! üöÄ‚≠êüì°</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>