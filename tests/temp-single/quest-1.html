<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 1: Command Bridge Activation - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="assets/quest-navigator.css">
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
        
        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html">Starship Repo Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 1: Command Bridge Activation</h1>
<hr>
<p>The command bridge hums to life as your starship aligns with the codebase constellation. From <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a>, you calibrate the bridge consoles that list, validate, and execute mission tools. Nearby, <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a> slots in modular tool cartridges that fuel each expedition. Your crew awaits orders to scan repositories, narrate findings, and route control relays. This chapter charts how the bridge announces available instruments, enforces safe invocation, and pre-generates cosmic packets to reduce drift. These investigations are exploration guides to decode the bridge‚Äôs behavior in motion.</p>
<h2>Quest Objectives</h2>
<p>As you explore the code below, investigate these key questions:</p>
<ul>
<li>üîç Scanner Calibration: How does <code class="inline-code">setupHandlers</code> transform tool <code class="inline-code">schema</code> into <code class="inline-code">inputSchema</code> and ensure MCP-compliant listing for every tool exported by <code class="inline-code">tools</code>?</li>
<li>‚ö° Relay Synchronization: What flow connects <code class="inline-code">main</code> to <code class="inline-code">RepoAdventureServer.run</code>, and how does it prepare the analyzer via <code class="inline-code">repoAnalyzer.preGenerate</code> without blocking the bridge?</li>
<li>üõ°Ô∏è Shield Protocols: In <code class="inline-code">setupHandlers</code>, how are invalid tool calls surfaced via <code class="inline-code">McpError</code>, and what safety nets does <code class="inline-code">main</code> install for shutdown and unhandled rejections?</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">packages/mcp/src/server.ts:</span> Command bridge server that lists tools, validates calls, and primes repository analysis</h3>
<p>From the bridge, <code class="inline-code">RepoAdventureServer</code> provisions an MCP server, exports capabilities, and binds request handlers that both enumerate tools and execute them safely. The <code class="inline-code">setupHandlers</code> function configures two critical routes using <code class="inline-code">ListToolsRequestSchema</code> and <code class="inline-code">CallToolRequestSchema</code>. Tool listing is dynamic: it reflects the live <code class="inline-code">tools</code> registry, converts each Zod <code class="inline-code">schema</code> into a JSON Schema using <code class="inline-code">zodToJsonSchema</code>, and returns MCP-ready descriptors. Tool execution defends the hull: it verifies the tool exists, validates arguments via <code class="inline-code">tool.schema.safeParse</code>, composes a precise <code class="inline-code">InvalidParams</code> message on failure, and invokes <code class="inline-code">tool.handler</code> with strongly parsed input. The <code class="inline-code">run</code> method engages <code class="inline-code">StdioServerTransport</code>, connects the server, logs status, and initiates a background warmup with <code class="inline-code">repoAnalyzer.preGenerate(process.cwd())</code>, reducing latency for upcoming analysis bursts. System resilience is reinforced by <code class="inline-code">gracefulShutdown</code>, which calls <code class="inline-code">repoAnalyzer.cleanup</code> on termination signals. The <code class="inline-code">main</code> routine instantiates the server, installs listeners for <code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>, and logs unhandled rejections without forcing a shutdown, keeping navigation steady during recoverable turbulence. Together, these patterns ensure tool orchestration, input integrity, and stable runtime telemetry across the mission.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> configures dynamic tool discovery and safe execution, mapping Zod schemas to JSON Schema and enforcing argument validation with targeted <code class="inline-code">McpError</code> responses for reliability.</li>
<li><code class="inline-code">run</code> activates the stdio transport, announces server readiness, and primes analysis via <code class="inline-code">repoAnalyzer.preGenerate</code> to minimize cold-start delays during exploration.</li>
<li><code class="inline-code">main</code> initializes the server, wires graceful shutdown for <code class="inline-code">SIGINT</code>/<code class="inline-code">SIGTERM</code>, and logs unhandled rejections without aborting, balancing visibility with uptime.</li>
</ul>
<h3><span class="header-prefix">packages/mcp/src/tools.ts:</span> Tool registry that equips the bridge with adventure cartridges</h3>
<p>This module consolidates the mission‚Äôs toolset and exports a canonical <code class="inline-code">tools</code> registry consumed by the server. It imports the <code class="inline-code">adventureManager</code> from core systems and binds four mission tools: <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. Each is re-exported using MCP naming to align with client expectations. The <code class="inline-code">tools</code> object is the single source of truth for discovery and invocation in <code class="inline-code">server.ts</code>; <code class="inline-code">setupHandlers</code> reads from it to list tools and to route execution. This separation grants a clean boundary: transport and validation live in the server, while operational behaviors live in individual tool modules, encouraging modular addition of future instruments. The exported <code class="inline-code">adventureManager</code> provides shared state or orchestration utilities to the tools themselves without coupling to the transport layer. Overall, <code class="inline-code">tools.ts</code> acts as the hangar manifest: a straightforward, explicit catalog that aligns naming, discovery, and reuse, ensuring the bridge can always present accurate capabilities and confidently delegate execution to the correct handler.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initiates an analysis-powered mission kickoff flow; its handler is registered for execution through the <code class="inline-code">tools</code> manifest.</li>
<li><code class="inline-code">choose_theme.handler</code> binds the selection flow for narrative theming; the handler is wired for MCP execution via the exported registry.</li>
<li><code class="inline-code">explore_quest.handler</code> drives focused quest exploration; the handler becomes invokable through dynamic discovery.</li>
<li><code class="inline-code">view_progress.handler</code> reports mission progress; the handler is surfaced and callable through the bridge tool list.</li>
</ul>
<h2>Code</h2>
<h3>packages/mcp/src/server.ts</h3>
<pre><code class="language-typescript">class RepoAdventureServer {
  private server: Server;

  constructor() {
    this.server = new Server(
      {
        name: &#39;repo-adventure&#39;,
        version: &#39;1.0.0&#39;,
        description: &#39;A gamified MCP server for exploring code repositories through interactive storytelling&#39;
      },
      {
        capabilities: {
          tools: {},
        },
      }
    );

    this.setupHandlers();
  }

  private setupHandlers() {
    // Dynamic tool listing
    this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
      const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
        name,
        description: tool.description,
        inputSchema: zodToJsonSchema(tool.schema, { 
          target: &#39;jsonSchema7&#39;,
          $refStrategy: &#39;none&#39;
        })
      }));

      return { tools: toolList };
    });

    // Dynamic tool execution
    this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
      try {
        const { name, arguments: args } = request.params;

        if (!(name in tools)) {
          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
        }

        const tool = tools[name as keyof typeof tools];
        
        // Validate arguments using the tool&#39;s Zod schema
        const validationResult = tool.schema.safeParse(args);
        if (!validationResult.success) {
          const errorMessages = validationResult.error.issues.map((err) =&gt; 
            `${err.path.join(&#39;.&#39;)}: ${err.message}`
          ).join(&#39;, &#39;);
          throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
        }

        // Execute the tool handler with validated arguments
        return await tool.handler(validationResult.data as any);

      } catch (error) {
        if (error instanceof McpError) {
          throw error;
        }
        throw new McpError(
          ErrorCode.InternalError,
          `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
        );
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
    
    // Pre-generate repomix content for the current working directory to warm up the cache
    // This happens in the background while waiting for user commands
    const projectPath = process.cwd();
    console.error(`Pre-generating repomix content for project at ${projectPath}...`);
    repoAnalyzer.preGenerate(projectPath);
  }
}
</code></pre>
<ul>
<li>Establishes the MCP server identity and capabilities for mission tooling.</li>
<li><code class="inline-code">setupHandlers</code> uses <code class="inline-code">zodToJsonSchema</code> to align Zod-based <code class="inline-code">schema</code> with MCP <code class="inline-code">inputSchema</code>, enabling client-side validation and UI hints.</li>
<li>Tool execution validates inputs via <code class="inline-code">safeParse</code> and returns precise <code class="inline-code">McpError</code> messages to maintain navigational safety.</li>
<li><code class="inline-code">run</code> connects over stdio and warms caches with <code class="inline-code">repoAnalyzer.preGenerate</code>, reducing first-mission latency and improving responsiveness.</li>
<li>Clear separation of listing and execution paths reinforces modularity and debuggability.</li>
</ul>
<hr>
<pre><code class="language-typescript">function gracefulShutdown() {
  console.error(&#39;\nShutting down MCP server...&#39;);
  try {
    repoAnalyzer.cleanup();
  } catch (e) {
    console.error(&#39;Cleanup error:&#39;, e);
  }
  process.exit(0);
}

async function main() {
  try {
    const server = new RepoAdventureServer();
    
    // Handle graceful shutdown for both signals
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    // Handle unhandled promise rejections - log but don&#39;t shutdown during normal operation
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
      // Don&#39;t call gracefulShutdown() here as it may be a recoverable error
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}

main().catch((error) =&gt; {
  console.error(&#39;Unhandled error:&#39;, error);
  process.exit(1);
});
</code></pre>
<ul>
<li><code class="inline-code">main</code> constructs the server, then installs signal listeners for controlled shutdown with <code class="inline-code">gracefulShutdown</code>.</li>
<li>Unhandled rejections are logged while keeping the process alive, favoring uptime over abrupt termination.</li>
<li>Errors during startup trigger an explicit nonzero exit, ensuring clear failure semantics for orchestrators.</li>
<li><code class="inline-code">gracefulShutdown</code> invokes <code class="inline-code">repoAnalyzer.cleanup</code> before exit, preserving resource hygiene in the analyzer subsystem.</li>
<li>The final <code class="inline-code">.catch</code> on <code class="inline-code">main()</code> ensures any late-stage errors are surfaced and terminate predictably.</li>
</ul>
<hr>
<h3>packages/mcp/src/tools.ts</h3>
<pre><code class="language-typescript">import { adventureManager } from &#39;@ai-repo-adventures/core/adventure&#39;;
import { startAdventure } from &#39;./tools/start-adventure.js&#39;;
import { chooseTheme } from &#39;./tools/choose-theme.js&#39;;
import { exploreQuest } from &#39;./tools/explore-quest.js&#39;;
import { viewProgress } from &#39;./tools/view-progress.js&#39;;

// Export the shared adventure manager for tools that need it
export { adventureManager };

// Re-export tools with MCP naming convention
export const start_adventure = startAdventure;
export const choose_theme = chooseTheme;
export const explore_quest = exploreQuest;
export const view_progress = viewProgress;


// Export all tools for easy registration
export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Declares a centralized <code class="inline-code">tools</code> registry that <code class="inline-code">server.ts</code> uses to list and dispatch handlers.</li>
<li>Re-exports tool modules with MCP-aligned names so the bridge exposes consistent identifiers to clients.</li>
<li>Exposes <code class="inline-code">adventureManager</code> for shared orchestration while maintaining separation from transport concerns.</li>
<li>A single manifest simplifies discovery and validation logic inside <code class="inline-code">setupHandlers</code>, reducing duplication.</li>
<li>Encourages extensibility: adding a new tool requires import, re-export, and inclusion in <code class="inline-code">tools</code>.</li>
</ul>
<h2>Helpful Hints</h2>
<ul>
<li>Trace how <code class="inline-code">tools</code> fields must include <code class="inline-code">description</code>, <code class="inline-code">schema</code>, and <code class="inline-code">handler</code> for seamless listing and execution.</li>
<li>Compare error paths in <code class="inline-code">setupHandlers</code> to see how <code class="inline-code">MethodNotFound</code>, <code class="inline-code">InvalidParams</code>, and <code class="inline-code">InternalError</code> are distinguished.</li>
<li>Observe how <code class="inline-code">repoAnalyzer.preGenerate</code> runs without <code class="inline-code">await</code>, indicating a non-blocking warmup strategy.</li>
</ul>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries.</p>
<p>Mission Update: Quest 1‚ÄîCommand Bridge Activation‚Äîsuccessfully achieved, captain; your starship is now online and standing by for the next jump, a stellar launch that lights the way for the remaining 0/5 quests‚Äîstrap in for warp-speed progress! üöÄ‚≠êüì°</p>

</div>


    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="assets/quest-navigator.js"></script>
</body>
</html>