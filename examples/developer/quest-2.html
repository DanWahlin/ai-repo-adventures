<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repo Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: MCP Tool Interface</h1>
<hr>
<p>You step into the control room of the MCP Tool Interface, where a sleek console hums with activity. This module orchestrates communication between the MCP server and its tools, ensuring seamless interaction for developers exploring their codebase. The interface is robust, dynamically registering tools and validating user inputs before executing commands. As you delve deeper, you&#39;ll uncover how this central hub manages tool execution and gracefully handles errors, all while maintaining a responsive and extensible architecture.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Error Handling Patterns</strong>: Techniques for managing errors during tool execution.</li>
<li>‚ö° <strong>Server Initialization</strong>: How the MCP server initializes and connects to its transport layer.</li>
<li>üí° <strong>Extensibility</strong>: How the design supports adding new tools without modifying core logic.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file is the backbone of the MCP server, managing tool registration, request handling, and server lifecycle events. It uses Zod schemas for input validation and provides a robust error-handling mechanism to ensure stable operation. The file also demonstrates how the server integrates with the <code class="inline-code">repoAnalyzer</code> for pre-generating content, making it a critical component for seamless developer interaction.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates input using Zod schemas.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Initializes the server transport layer and pre-generates repository content.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server startup and handles graceful shutdown.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li><code class="inline-code">setupHandlers</code> registers two key handlers: one for listing tools and another for executing them.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler dynamically generates a list of tools with their descriptions and schemas.</li>
<li>The <code class="inline-code">CallToolRequestSchema</code> handler validates input using Zod schemas, ensuring only valid data reaches the tool&#39;s logic.</li>
<li>Error handling uses custom <code class="inline-code">McpError</code> exceptions to provide clear feedback and maintain server stability.</li>
<li>This approach decouples tool registration from execution, making it easy to add new tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server and connects it to the <code class="inline-code">StdioServerTransport</code>.</li>
<li>It logs server startup messages, providing visibility into the server&#39;s operational state.</li>
<li>The method pre-generates repository content using <code class="inline-code">repoAnalyzer.preGenerate</code>, warming up the cache for faster responses.</li>
<li>This design improves performance by reducing latency during the first user interaction.</li>
<li>The use of asynchronous operations ensures non-blocking execution, keeping the server responsive.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function initializes the <code class="inline-code">RepoAdventureServer</code> and sets up signal handlers for graceful shutdown.</li>
<li>It catches unhandled promise rejections, logging errors without crashing the server.</li>
<li>The function demonstrates robust error handling, ensuring the server can recover from unexpected issues.</li>
<li>This approach creates a reliable server lifecycle, handling both startup and shutdown gracefully.</li>
<li>The use of modular functions like <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L98" target="_blank" rel="noopener noreferrer"><code class="inline-code">gracefulShutdown</code></a> separates concerns, improving maintainability.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file acts as the registry and entry point for all MCP tools. It organizes tools into a single exportable object, making it easy for the server to access and register them. This modular design supports scalability by allowing new tools to be added independently.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and initializes the adventure.</li>
<li><code class="inline-code">choose_theme.handler</code>: Allows users to select a theme for their adventure.</li>
<li><code class="inline-code">explore_quest.handler</code>: Executes specific quests within the adventure.</li>
<li><code class="inline-code">view_progress.handler</code>: Displays the progress of the current adventure.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object consolidates all tool handlers into a single exportable structure.</li>
<li>Each tool is implemented as a separate module, promoting separation of concerns.</li>
<li>This design simplifies tool registration in the server, as all tools are accessible from one place.</li>
<li>The modular approach allows developers to add or modify tools without affecting existing functionality.</li>
<li>This structure aligns with the principles of scalability and maintainability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how Zod schemas are used for input validation to ensure type safety and prevent invalid data.</li>
<li>Observe the modular design of the <code class="inline-code">tools</code> object, which simplifies tool management and registration.</li>
<li>Study the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function to understand how signal handling ensures graceful server shutdown.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a Custom Tool</strong>: Create a new tool that analyzes the repository for unused dependencies. Register it in the <code class="inline-code">tools</code> object and validate its input using Zod schemas.</p>
</li>
<li><p><strong>Trace Error Flow</strong>: Introduce intentional errors in tool execution and observe how the <code class="inline-code">McpError</code> class handles them. Modify the error messages to include troubleshooting tips.</p>
</li>
<li><p><strong>Optimize Pre-Generation</strong>: Modify the <code class="inline-code">repoAnalyzer.preGenerate</code> call to log the time taken for pre-generation. Analyze whether caching improves performance for large repositories.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the MCP system.</p>
<p>Congratulations on successfully deploying the MCP Tool Interface‚Äîyour codebase just hit a major milestone, and with 20% of the journey complete, you&#39;re debugging the future like a true architect of innovation! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>