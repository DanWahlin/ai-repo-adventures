<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analysis & Content Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Developer's Guide to AI Repo Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis &amp; Content Pipeline</h1>
<hr>
<p>Step into the heart of the repository&#39;s analytical engine, where raw code transforms into actionable insights. This quest delves into the mechanisms behind codebase analysis and dynamic content generation, exploring the tools that enable seamless integration of technical data into interactive experiences. As you navigate through these components, you&#39;ll uncover the intricate interplay between repository scanning, optimization, and AI-driven response generation.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Repomix Integration</strong>: How repository analysis is performed to extract meaningful code insights.</li>
<li>üîç <strong>LLM Request Handling</strong>: Techniques for adaptive throttling and dynamic response validation in AI systems.</li>
<li>‚ö° <strong>Content Optimization</strong>: Strategies for reducing token usage while preserving essential code patterns.</li>
<li>üí° <strong>Error Handling</strong>: Effective methods for managing rate limits and ensuring system stability.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> class is the backbone of codebase analysis. It integrates with Repomix to extract structured content from repositories, validate project paths, and optimize code for efficient processing. This file demonstrates advanced caching mechanisms and targeted content extraction techniques, ensuring scalability and reliability in large codebases.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> analyzes the entire repository or specific files, applying compression and filtering for token efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> extracts content from specified files, ensuring security and validation through path normalization.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> executes Repomix as a subprocess, handling timeouts and memory constraints to prevent system overload.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const configuredFiles = extractUniqueFilePaths(projectPath);
  
  if (configuredFiles.length &gt; 0) {
    try {
      return await this.generateOptimizedContent(projectPath, configuredFiles);
    } catch (error) {
      console.warn(`Falling back to targeted content: ${error.message}`);
      return await this.generateTargetedContent(projectPath, configuredFiles);
    }
  }
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;.git&#39;]
    });
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This function integrates Repomix for repository analysis, applying caching to reduce redundant operations.</li>
<li>It validates project paths and uses fallback mechanisms for robust content generation.</li>
<li>Compression options and ignore patterns minimize token usage and focus on relevant code.</li>
<li>The modular design allows easy extension for additional analysis features.</li>
</ul>
<hr>
<pre><code class="language-typescript">async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style], { cwd });
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    let isResolved = false;

    const timeout = setTimeout(() =&gt; {
      if (!isResolved) {
        repomix.kill(&#39;SIGTERM&#39;);
        setTimeout(() =&gt; repomix.kill(&#39;SIGKILL&#39;), REPOMIX_GRACEFUL_TIMEOUT);
        isResolved = true;
        reject(new Error(`Repomix timeout after ${REPOMIX_SUBPROCESS_TIMEOUT}ms`));
      }
    }, REPOMIX_SUBPROCESS_TIMEOUT);

    repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });
    repomix.on(&#39;close&#39;, (code) =&gt; {
      clearTimeout(timeout);
      if (code === 0) resolve(stdout.trim());
      else reject(new Error(`Repomix failed with exit code ${code}: ${stderr}`));
    });
  });
}
</code></pre>
<ul>
<li>This code handles Repomix subprocess execution, ensuring graceful termination on timeouts.</li>
<li>Memory protection prevents excessive buffer usage, maintaining system stability.</li>
<li>Detailed error handling provides actionable insights for debugging failed executions.</li>
<li>The asynchronous design supports concurrent operations without blocking the main thread.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> class bridges the repository analysis with AI-driven content generation. It manages API requests to LLM providers, ensuring adaptive throttling and robust error handling. This file showcases techniques for handling rate limits, validating responses, and optimizing token usage.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> constructs and executes LLM requests, applying throttling and validating responses for robustness.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a> initializes the client with provider-specific configurations, supporting multiple APIs like OpenAI and Azure.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> identifies rate limit errors and provides actionable guidance for recovery.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    let content = this.validateResponse(completion);

    if (options?.responseFormat === &#39;json_object&#39;) {
      content = this.cleanJsonResponse(content);
    }

    this.logTokenUsage(completion, options?.context);
    this.onSuccessfulRequest();

    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);

    if (rateLimitInfo.type !== RateLimitType.NONE) {
      this.activateThrottling(error);
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }

    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This function handles LLM requests with adaptive throttling, ensuring stability during high-demand periods.</li>
<li>Response validation includes error detection and content filtering for reliable outputs.</li>
<li>Rate limit errors are transformed into actionable insights, enabling proactive recovery.</li>
<li>Modular design supports integration with multiple LLM providers.</li>
</ul>
<hr>
<pre><code class="language-typescript">detectRateLimitType(error: any): RateLimitInfo {
  const errorMessage = error?.message || &#39;&#39;;
  const is429Error = error?.status === 429 || errorMessage.includes(&#39;429&#39;);

  if (!is429Error) {
    return { type: RateLimitType.NONE, waitSeconds: 0, message: &#39;&#39; };
  }

  if (errorMessage.includes(&#39;exceeded token rate limit&#39;)) {
    return { type: RateLimitType.TOKEN_RATE_EXCEEDED, waitSeconds: TOKEN_RATE_WINDOW_SECONDS, message: &#39;Token rate limit exceeded&#39; };
  }

  return { type: RateLimitType.REQUEST_RATE_LIMIT, waitSeconds: 60, message: &#39;Request rate limit hit&#39; };
}
</code></pre>
<ul>
<li>This function identifies rate limit errors, distinguishing between token rate and request rate limits.</li>
<li>It provides structured information for handling errors, improving system resilience.</li>
<li>Configurable wait times enable adaptive recovery based on error context.</li>
<li>The detection logic is extensible for additional rate limit scenarios.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> integrates caching to optimize performance in large repositories.</li>
<li>Examine the adaptive throttling logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> to understand dynamic rate limit handling.</li>
<li>Study the subprocess management in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> for insights into secure external tool execution.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Optimize Content Extraction</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L202" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateOptimizedContent</code></a> to include additional filtering criteria for function names. Focus on extracting utility functions and validate the output.</li>
<li><strong>Trace Throttling Behavior</strong>: Add logging to <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L462" target="_blank" rel="noopener noreferrer"><code class="inline-code">applyThrottling</code></a> and observe how the delay changes over multiple requests. Analyze the impact of adaptive throttling on API performance.</li>
<li><strong>Improve Error Handling</strong>: Enhance <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L392" target="_blank" rel="noopener noreferrer"><code class="inline-code">detectRateLimitType</code></a> to include detailed logging for unknown errors. Test the system with simulated rate limit scenarios to evaluate robustness.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the repository&#39;s architecture.</p>
<p>Congratulations on successfully deploying the Code Analysis &amp; Content Pipeline quest‚Äîyour progress is compiling flawlessly at 60%, keep optimizing toward the final milestone! üöÄ‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>