<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analysis Core - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">Cosmic Codebase Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Code Analysis Core</h1>
<hr>
<p>The Starship Codex enters the swirling Repository Nebula, where streams of data form intricate cosmic patterns. Your mission is to navigate the Code Analysis Core, a critical subsystem that deciphers these data streams into actionable insights. As the nebula‚Äôs energy pulses through the ship, the RepoAnalyzer and LLMClient work in tandem to extract meaningful signals from the noise. These tools are the ship‚Äôs eyes and ears, enabling the crew to uncover hidden treasures within the galaxy of code.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Content Optimization</strong>: How the RepoAnalyzer extracts and optimizes project data for efficient analysis.</li>
<li>üîç <strong>LLM Integration</strong>: How the LLMClient interfaces with AI models to generate meaningful responses.</li>
<li>‚ö° <strong>Rate Limiting Strategies</strong>: How adaptive throttling ensures stability under heavy API usage.</li>
<li>üí° <strong>Caching Techniques</strong>: How caching improves performance and reduces redundant processing.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/analyzer/repo-analyzer.ts</code></a></h3>
<p>The <code class="inline-code">RepoAnalyzer</code> is a vital component of the Code Analysis Core, designed to process repository data efficiently. It integrates with Repomix to extract and optimize information from codebases, ensuring that only relevant content is analyzed. This file demonstrates how to validate inputs, manage caching, and optimize content for AI consumption.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a>: Generates a comprehensive context by analyzing the repository structure with Repomix.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a>: Focuses analysis on specific files, reducing noise and improving efficiency.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a>: Executes Repomix as a subprocess and captures its output with timeout and memory safeguards.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateRepomixContext(projectPath: string, options: RepomixOptions = {}): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const cacheKey = `${path.resolve(projectPath)}:${JSON.stringify(options)}`;
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  try {
    const cliOptions: CliOptions = {
      style: options.style || &#39;markdown&#39;,
      compress: options.compress !== false,
      ignore: [&#39;node_modules&#39;, &#39;dist&#39;, &#39;.git&#39;].join(&#39;,&#39;),
    };

    const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
    this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
    return context;
  } catch (error) {
    throw new Error(`Repomix execution failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>This method generates a detailed context of the repository, leveraging Repomix for structured analysis.</li>
<li>Caching ensures that repeated requests for the same context do not trigger redundant processing.</li>
<li>Input validation prevents issues like path traversal or invalid configurations.</li>
<li>The use of CLI options enables flexible customization of analysis parameters.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateTargetedContent(projectPath: string, targetFiles: string[], compress: boolean = true): Promise&lt;string&gt; {
  this.validateProjectPath(projectPath);
  
  const safeFiles = this.validateAndNormalizeTargetFiles(projectPath, targetFiles);
  const cacheKey = `${path.resolve(projectPath)}:targeted:${safeFiles.join(&#39;,&#39;)}:compress=${compress}`;
  
  const cached = this.cache.get(cacheKey);
  if (cached &amp;&amp; (Date.now() - cached.timestamp) &lt; REPOMIX_CACHE_TTL) {
    return cached.content;
  }
  
  const cliOptions: CliOptions = {
    style: &#39;markdown&#39;,
    compress,
    include: safeFiles.join(&#39;,&#39;),
    noDirectoryStructure: true,
  };

  const context = await this.captureRepomixStdout([&#39;.&#39;], projectPath, cliOptions);
  this.cache.set(cacheKey, { content: context, timestamp: Date.now() });
  return context;
}
</code></pre>
<ul>
<li>Focuses analysis on specific files, reducing resource usage and improving relevance.</li>
<li>Validates and normalizes file paths to ensure security and reliability.</li>
<li>Uses compression to minimize the size of the generated content.</li>
<li>Prevents redundant processing through caching mechanisms.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async captureRepomixStdout(directories: string[], cwd: string, options: CliOptions): Promise&lt;string&gt; {
  return new Promise((resolve, reject) =&gt; {
    const repomix = spawn(&#39;npx&#39;, [&#39;repomix&#39;, ...directories, &#39;--stdout&#39;, &#39;--style&#39;, options.style || &#39;markdown&#39;], { cwd });
    
    let stdout = &#39;&#39;;
    let stderr = &#39;&#39;;
    repomix.stdout.on(&#39;data&#39;, (data) =&gt; { stdout += data.toString(); });
    repomix.stderr.on(&#39;data&#39;, (data) =&gt; { stderr += data.toString(); });
    
    repomix.on(&#39;close&#39;, (code) =&gt; {
      if (code === 0) resolve(stdout);
      else reject(new Error(`Repomix failed with code ${code}: ${stderr}`));
    });
  });
}
</code></pre>
<ul>
<li>Executes Repomix as a subprocess, capturing its output for further processing.</li>
<li>Implements error handling to manage subprocess failures gracefully.</li>
<li>Provides a flexible interface for configuring Repomix execution parameters.</li>
<li>Ensures compatibility with various operating environments by using standard CLI tools.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/llm/llm-client.ts</code></a></h3>
<p>The <code class="inline-code">LLMClient</code> is the bridge between the Starship Codex and the AI models it relies on. It manages API interactions, handles rate limits, and ensures that responses are both accurate and timely. This file highlights how to adaptively throttle requests and process AI-generated content effectively.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a>: Sends a prompt to the AI model and processes the generated response.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L87" target="_blank" rel="noopener noreferrer"><code class="inline-code">constructor</code></a>: Configures the client based on the selected AI provider and model.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L437" target="_blank" rel="noopener noreferrer"><code class="inline-code">activateThrottling</code></a>: Implements adaptive throttling to manage rate limits dynamically.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateResponse(prompt: string, options?: LLMRequestOptions): Promise&lt;LLMResponse&gt; {
  await this.applyThrottling();

  try {
    const requestParams = this.buildRequestParams(prompt, options);
    const completion = await this.executeRequest(requestParams);
    const content = this.validateResponse(completion);
    
    this.onSuccessfulRequest();
    return { content };
  } catch (error) {
    const rateLimitInfo = this.detectRateLimitType(error);
    if (rateLimitInfo.type !== RateLimitType.NONE) {
      this.activateThrottling(error);
      throw new RateLimitError(rateLimitInfo.type, rateLimitInfo.waitSeconds, rateLimitInfo.message, error);
    }
    throw new Error(`LLM request failed: ${error.message}`);
  }
}
</code></pre>
<ul>
<li>Sends prompts to the AI model and handles responses with robust error management.</li>
<li>Integrates rate limit detection to identify and respond to API throttling scenarios.</li>
<li>Uses adaptive throttling to maintain system stability under high load.</li>
<li>Validates responses to ensure they meet the expected format and quality.</li>
</ul>
<hr>
<pre><code class="language-typescript">constructor() {
  this.model = LLM_MODEL;
  const apiKey = this.getApiKey();
  if (this.isAzureOpenAI()) {
    this.client = new AzureOpenAI({ endpoint: LLM_BASE_URL, apiKey, deployment: this.model });
  } else {
    this.client = new OpenAI({ apiKey, baseURL: LLM_BASE_URL });
  }
}
</code></pre>
<ul>
<li>Configures the LLM client based on the selected AI provider (e.g., OpenAI or Azure OpenAI).</li>
<li>Ensures compatibility with different API configurations and authentication methods.</li>
<li>Abstracts provider-specific details to provide a unified interface for generating responses.</li>
</ul>
<hr>
<pre><code class="language-typescript">private activateThrottling(error: any): void {
  this.isThrottling = true;
  const rateLimitInfo = this.detectRateLimitType(error);
  this.throttleDelay = Math.min(rateLimitInfo.waitSeconds * 1000, this.MAX_THROTTLE_DELAY);
}
</code></pre>
<ul>
<li>Dynamically adjusts the delay between requests based on detected rate limits.</li>
<li>Prevents excessive API usage that could lead to service interruptions.</li>
<li>Gradually reduces throttling as system conditions improve.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L246" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateTargetedContent</code></a> filters files to reduce noise in large repositories.</li>
<li>Notice how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L610" target="_blank" rel="noopener noreferrer"><code class="inline-code">captureRepomixStdout</code></a> uses subprocesses to integrate external tools efficiently.</li>
<li>Study the adaptive throttling logic in <code class="inline-code">LLMClient</code> to understand how it manages rate limits.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Optimize Content Extraction</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L368" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractFunctionFocusedContent</code></a> in <code class="inline-code">RepoAnalyzer</code> to include additional patterns for identifying important functions. Test your changes on a sample repository to see the impact.</p>
</li>
<li><p><strong>Trace API Calls</strong>: Add logging to <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/llm/llm-client.ts#L140" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateResponse</code></a> in <code class="inline-code">LLMClient</code> to trace the flow of API requests and responses. Observe how the system handles errors and rate limits under different conditions.</p>
</li>
<li><p><strong>Enhance Caching</strong>: Experiment with the caching logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/analyzer/repo-analyzer.ts#L296" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateRepomixContext</code></a> to adjust the cache expiration time. Analyze how this affects performance in scenarios with repeated requests.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Starship Codex.</p>
<p>Mission accomplished, star navigator‚ÄîCode Analysis Core has been decoded with cosmic precision, propelling your learning journey to 60% completion on this stellar quest‚Äîkeep rocketing toward the final frontier! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>