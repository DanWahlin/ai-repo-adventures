<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Quest Generator - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Starship Repository Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Quest Generation Engine</h1>
<hr>
<p>The Starship Odyssey approaches the heart of its operational intelligence: the Quest Generation Engine. This subsystem transforms raw repository data into engaging, story-driven adventures. As you delve into its complex algorithms, you‚Äôll uncover how the system dynamically generates quests, processes adventure configurations, and integrates LLM-powered storytelling. Prepare to navigate the intricate pathways of this engine, ensuring it continues to inspire interstellar explorers.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Quest Generation</strong>: How the system dynamically creates quests by analyzing repository data and configurations.</li>
<li>üîç <strong>Content Chunking</strong>: Techniques for processing large codebases into manageable chunks for LLM input.</li>
<li>‚ö° <strong>Adventure Configuration Integration</strong>: How custom configurations influence quest generation and content.</li>
<li>üí° <strong>Error Handling Patterns</strong>: Approaches to ensure robust quest generation even with incomplete or missing data.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> is the central orchestrator of the Quest Generation Engine. It initializes adventures, manages state, and dynamically generates quest content. This file showcases how repository data, adventure configurations, and LLM responses are combined to create a seamless user experience.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a> resets the system state, generates story and quests, and integrates configuration data for custom adventures.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a> validates user input, retrieves or generates quest content, and caches results for efficient subsequent access.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> processes repository data into quest-specific content, handling chunking and fallback strategies for large data sets.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the adventure state to ensure a clean start for each new session.</li>
<li>Integrates custom themes and configurations, enabling tailored user experiences.</li>
<li>Combines generated story data with configuration-defined quests for a cohesive narrative.</li>
<li>Demonstrates separation of concerns by delegating story generation to the <code class="inline-code">StoryGenerator</code>.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates user input to prevent invalid or malicious requests.</li>
<li>Implements a flexible search mechanism to locate quests by title, ID, or number.</li>
<li>Retrieves cached quest content or generates new content as needed, ensuring efficient resource use.</li>
<li>Employs defensive programming to handle edge cases, such as missing quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;

  if (this.state.projectPath) {
    const config = parseAdventureConfig(this.state.projectPath);
    const hasConfigOptimization = config &amp;&amp; typeof config === &#39;object&#39; &amp;&amp; &#39;adventure&#39; in config;

    if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0) {
      try {
        const targetedContent = await repoAnalyzer.generateTargetedContent(
          this.state.projectPath,
          quest.codeFiles,
          false
        );
        codeContent = repoAnalyzer.prependCoreProjectContext(this.state.projectPath, targetedContent);
      } catch {
        codeContent = hasConfigOptimization
          ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
          : this.state.projectInfo!.repomixContent;
      }
    } else {
      codeContent = hasConfigOptimization
        ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
        : this.state.projectInfo!.repomixContent;
    }
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  const chunkResult = ContentChunker.chunkContent(codeContent);

  return await this.storyGenerator.generateQuestContent({
    quest,
    theme: this.state.currentTheme!,
    chunkResult,
    questPosition: this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1,
    totalQuests: this.state.quests.length
  });
}
</code></pre>
<ul>
<li>Handles prioritized content generation, starting with quest-specific files and falling back to general repository data.</li>
<li>Demonstrates resilience by providing multiple fallback mechanisms for missing or incomplete data.</li>
<li>Uses content chunking to optimize processing of large codebases, ensuring efficient LLM usage.</li>
<li>Integrates project context to enhance the relevance of generated quest content.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> is responsible for generating the narrative and quests for each adventure. It processes repository data, applies themes, and formats content for presentation.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a> combines repository analysis with thematic storytelling to create engaging adventures.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> tailors quest content to specific files or contexts, using chunking for large data sets.</li>
<li><code class="inline-code">processChunkedQuestContent</code> iteratively processes repository data in manageable chunks, ensuring coherence across content parts.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>Validates the selected theme to ensure compatibility with the story generation process.</li>
<li>Delegates the heavy lifting of story and quest generation to the LLM, leveraging its contextual understanding.</li>
<li>Demonstrates modularity by separating theme validation and LLM interaction into distinct methods.</li>
</ul>
<hr>
<pre><code class="language-typescript">async generateQuestContent(config: QuestGenerationConfig): Promise&lt;QuestContent&gt; {
  const { quest, theme, chunkResult, questPosition, totalQuests } = config;

  const prompt = loadQuestContentPrompt({
    theme,
    adventureTitle: quest.title,
    codeContent: chunkResult.chunks[0].content,
    storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
    questPosition,
    totalQuests
  }) + this.QUEST_FORMAT_INSTRUCTIONS;

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST, context: &#39;quest content&#39; });

  return {
    adventure: response.content.trim(),
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Constructs detailed prompts to guide the LLM in generating quest content.</li>
<li>Handles single or multiple content chunks, ensuring scalability for large repositories.</li>
<li>Returns structured quest content, ready for integration into the adventure.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async processChunkedQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  chunkResult: ChunkResult,
  adventureGuidance: string,
  customInstructions: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  let accumulatedContent = &#39;&#39;;
  let contextSummary = &#39;&#39;;

  for (let i = 0; i &lt; chunkResult.chunks.length; i++) {
    const chunk = chunkResult.chunks[i];
    const isFirstChunk = i === 0;
    const isLastChunk = i === chunkResult.chunks.length - 1;

    const prompt = isFirstChunk
      ? `First chunk prompt with context`
      : isLastChunk
      ? `Last chunk prompt with finalization`
      : `Middle chunk prompt with continuation`;

    const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST, context: &#39;quest chunk&#39; });
    accumulatedContent = response.content.trim();
  }

  return {
    adventure: accumulatedContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Iteratively processes content chunks, maintaining coherence across multiple LLM calls.</li>
<li>Adjusts prompts dynamically based on the chunk&#39;s position, ensuring logical progression.</li>
<li>Accumulates content into a cohesive narrative, ready for user consumption.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Explore how <code class="inline-code">ContentChunker</code> divides large data sets into manageable pieces for LLM processing.</li>
<li>Review the fallback mechanisms in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> to understand how the system ensures robustness.</li>
<li>Investigate how <code class="inline-code">StoryGenerator</code> integrates custom themes to tailor the user experience.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Theme</strong>: Implement a new adventure theme by modifying the <code class="inline-code">StoryGenerator</code> and <code class="inline-code">AdventureManager</code>. Test how the system adapts to the new theme.</p>
<ul>
<li>Example: Create a &quot;Cyberpunk&quot; theme with futuristic terminology and visuals.</li>
</ul>
</li>
<li><p><strong>Trace Content Chunking</strong>: Add logging to <code class="inline-code">ContentChunker.chunkContent</code> and observe how large codebases are divided. Analyze the impact of chunk size on LLM performance and output coherence.</p>
</li>
<li><p><strong>Enhance Error Handling</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> to provide more detailed feedback when LLM responses are empty or malformed. Consider adding retries or alternative content generation strategies.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the starship&#39;s systems.</p>
<p>Stellar work, cadet‚Äîyour Galactic Quest Generator has ignited like a supernova, propelling you to 40% mission completion with cosmic brilliance! üöÄ‚≠ê‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>