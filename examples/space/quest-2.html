<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Bridge Protocols - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Starship Repository Odyssey</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: Command Bridge Protocols</h1>
<hr>
<p>As you step onto the Command Bridge of the Starship Odyssey, the hum of interconnected systems fills the air. The bridge is the nerve center of the vessel, where tools and protocols ensure smooth communication with distant galaxies of code. Your mission is to uncover the intricate mechanisms that govern these operations. From dynamic tool registration to the orchestration of tool execution, the Command Bridge is a marvel of engineering, and your understanding of its inner workings will be key to the Odyssey‚Äôs success.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas for extensibility and safety.</li>
<li>üîç <strong>Error Handling Patterns</strong>: How robust error handling protects the system from invalid or unexpected inputs during tool execution.</li>
<li>‚ö° <strong>Graceful Shutdown</strong>: How to implement cleanup procedures to ensure resource stability during system termination.</li>
<li>üí° <strong>Pre-Generation Optimization</strong>: The benefits of pre-generating content to improve performance and user experience.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>This file is the heart of the Command Bridge, implementing the <code class="inline-code">RepoAdventureServer</code> class. It manages the lifecycle of the MCP server, including tool registration, request handling, and graceful shutdown. The <code class="inline-code">setupHandlers</code> method dynamically registers tools, ensuring flexibility and scalability. The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method oversees server initialization and pre-generates content to optimize performance. The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function orchestrates the startup sequence and handles system signals for graceful termination.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools and validates their schemas for secure operation.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server, connects transport, and pre-generates content for smoother user interactions.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> coordinates the server&#39;s startup and handles shutdown signals to ensure stability.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);

      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools and ensures their schemas are validated before execution.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler provides a manifest of all available tools, enabling external systems to query capabilities dynamically.</li>
<li>Validation via Zod schemas ensures type safety and prevents invalid input from reaching the execution layer.</li>
<li>Error handling distinguishes between known and unknown errors, providing detailed feedback for debugging.</li>
<li>This design promotes extensibility by separating tool registration from execution logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server transport and connects the MCP protocol.</li>
<li>Pre-generating content ensures the system is ready to respond to user commands without delays.</li>
<li>The use of <code class="inline-code">process.cwd()</code> dynamically determines the project path, making the system adaptable to different environments.</li>
<li>The design prioritizes user experience by optimizing for faster interactions after startup.</li>
<li>This method highlights the importance of background processing in interactive systems.</li>
</ul>
<hr>
<pre><code class="language-typescript">async function main() {
  try {
    const server = new RepoAdventureServer();
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
    });
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function handles the startup sequence, including error handling and signal management.</li>
<li>Graceful shutdown ensures resources are cleaned up properly, preventing leaks or corruption.</li>
<li>The signal handlers (<code class="inline-code">SIGINT</code>, <code class="inline-code">SIGTERM</code>) allow the server to terminate safely when interrupted.</li>
<li>The separation of concerns between <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> and <code class="inline-code">RepoAdventureServer</code> simplifies testing and debugging.</li>
<li>This code demonstrates best practices for managing asynchronous systems with potential runtime errors.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file defines the tools available on the Command Bridge, mapping them to their respective handlers. The tools include <code class="inline-code">start_adventure</code>, <code class="inline-code">choose_theme</code>, <code class="inline-code">explore_quest</code>, and <code class="inline-code">view_progress</code>. Each tool encapsulates specific functionality, ensuring modularity and clarity.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> analyzes the codebase and initializes the adventure.</li>
<li><code class="inline-code">choose_theme.handler</code> generates a story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code> allows users to interact with individual quests dynamically.</li>
<li><code class="inline-code">view_progress.handler</code> tracks completion status and provides progress updates.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>This code exports all tools in a centralized object for easy registration and management.</li>
<li>The modular design ensures each tool can evolve independently without impacting others.</li>
<li>The naming convention aligns with MCP protocol standards, providing a consistent interface for external systems.</li>
<li>This structure simplifies tool discovery and integration, reducing the cognitive load for developers.</li>
<li>The organization of tools promotes scalability, allowing new tools to be added with minimal changes.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Review the <code class="inline-code">setupHandlers</code> method to understand how Zod schemas enforce input validation and type safety.</li>
<li>Examine the <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method to see how pre-generation improves performance for interactive systems.</li>
<li>Study the modular design of <code class="inline-code">tools.ts</code> to learn how to structure extensible systems with clear boundaries.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_technologies</code> that scans the repository and returns detected technologies. Register it in <code class="inline-code">tools.ts</code> and validate its schema in <code class="inline-code">setupHandlers</code>.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements to the <code class="inline-code">setupHandlers</code> method to trace the lifecycle of a tool request, from schema validation to execution. Observe how errors are handled during this process.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the error messages in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for resolving common issues, such as missing required parameters or invalid data types.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Odyssey‚Äôs systems.</p>
<p>Stellar work, Cadet‚ÄîCommand Bridge Protocols locked in and your mission is off to a blazing start at warp speed, charting the cosmos with 20% brilliance! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>