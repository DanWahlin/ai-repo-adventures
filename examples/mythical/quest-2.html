<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mystic Tools of the Kingdom - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository of Adventures</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic Tools of the Kingdom</h1>
<hr>
<p>In the mystical land of Codehaven, the enchanted scrolls are guarded by the Dragon Hoards, and their secrets are revealed only to those who wield the Mystic Tools. These tools, imbued with ancient magic, allow adventurers to summon stories, choose themes, and explore quests that shape the kingdom‚Äôs harmony. As a brave hero, you must master these tools by unraveling their spells and learning their intricacies. The fate of Codehaven rests on your ability to harness their powers and maintain balance within the enchanted realms.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Tool Execution Flow</strong>: The process of argument validation and execution for interactive storytelling.</li>
<li>‚ö° <strong>Graceful Shutdown Patterns</strong>: How the system ensures stability during termination and error handling.</li>
<li>üí° <strong>Background Pre-Generation</strong>: How caching and pre-processing improve system responsiveness.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The castle‚Äôs central tower, <code class="inline-code">server.ts</code>, acts as the heart of the Mystic Tools system, orchestrating the flow of magic between the adventurers and the enchanted scrolls. The <code class="inline-code">RepoAdventureServer</code> class manages tool registration, execution, and server lifecycle events. This file showcases how dynamic tool handling is achieved through schemas and how graceful shutdown ensures the kingdom‚Äôs stability during unexpected disruptions.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Registers tools dynamically, validating their parameters and exposing their capabilities.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Activates the server transport and pre-generates content to ensure smooth interactions.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Initializes the server, handles signals for shutdown, and logs unhandled promise rejections.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools, exposing their descriptions and schemas for validation.</li>
<li>The <code class="inline-code">zodToJsonSchema</code> function ensures compatibility with JSON schema standards.</li>
<li>Argument validation prevents invalid or malicious tool invocations, safeguarding the kingdom‚Äôs harmony.</li>
<li>Error handling demonstrates defensive programming, ensuring the server remains resilient during execution failures.</li>
<li>Decoupling tool registration and execution allows easy extension with new tools.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method initializes the server transport and connects it to the MCP protocol.</li>
<li>Background pre-generation of repomix content warms up the cache, improving responsiveness during user interactions.</li>
<li>Using <code class="inline-code">process.cwd()</code> ensures the server operates on the current project directory, making it adaptable to different environments.</li>
<li>This approach highlights the importance of pre-processing for interactive systems where latency impacts user experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function orchestrates the server lifecycle, handling initialization and graceful shutdown.</li>
<li>Signal handling ensures the server cleans up resources during termination, maintaining stability.</li>
<li>Logging unhandled promise rejections helps identify issues without disrupting normal operations.</li>
<li>Separating initialization, signal handling, and runtime logic creates a clear and testable structure.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The Mystic Tools themselves reside in <code class="inline-code">tools.ts</code>, where their magical properties are defined and exported. This file organizes the tools into a registry, enabling adventurers to summon and interact with them seamlessly. It demonstrates modular design principles and the importance of maintaining shared state across multiple tools.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code>: Analyzes the codebase and presents theme options to the adventurer.</li>
<li><code class="inline-code">choose_theme.handler</code>: Generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code>: Enables exploration of individual quests, revealing their secrets.</li>
<li><code class="inline-code">view_progress.handler</code>: Tracks completion status and remaining quests for adventurers.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object acts as a registry, consolidating all tools for easy access and dynamic registration.</li>
<li>Modular design separates tool implementations, improving maintainability and scalability.</li>
<li>Each tool follows a consistent naming convention, ensuring clarity and ease of integration.</li>
<li>Exporting tools as a single object simplifies their usage in other parts of the codebase.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">setupHandlers</code> uses schemas to validate tool inputs and prevent misuse.</li>
<li>Observe how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> pre-generates content to reduce latency during the first user interaction.</li>
<li>Explore the modular design of <code class="inline-code">tools.ts</code>, which organizes tools for maintainability and scalability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a custom tool that retrieves the most frequently modified files in the codebase. Add it to <code class="inline-code">tools.ts</code> and register it in <code class="inline-code">setupHandlers</code> to understand the tool registration process.</p>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add logging statements in <code class="inline-code">CallToolRequestSchema</code> to trace the complete execution flow of a tool. Run the server and observe how arguments are validated and handlers are invoked.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for similar tool names when an unknown tool is requested. This improves user experience and demonstrates advanced error handling techniques.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the enchanted kingdom.</p>
<p>With the first of five celestial relics claimed, the stars themselves herald your triumph, brave seeker, as the Mystic Tools of the Kingdom now gleam in your grasp‚Äîforge onward with valor and destiny as your guide! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>