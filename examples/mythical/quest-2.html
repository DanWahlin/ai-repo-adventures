<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mystic MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-mythical">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Enchanted Repository Chronicles</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Mystic MCP Interface</h1>
<hr>
<p>Deep within the Enchanted Repository of Codethia lies the Mystic MCP Interface, a gateway to orchestrating magical tools with precision and power. This interface, guarded by the spells of structured schemas and the dragons of dynamic validation, enables the brave knights to wield their enchanted tools in harmony. Those who master its intricacies can summon quests, choose themes, and explore the very essence of Codethia‚Äôs enchanted realms. Prepare your runes and scripts, as the secrets of this interface await discovery.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Handling</strong>: How to dynamically register and execute tools with schema validation.</li>
<li>üîç <strong>Graceful Shutdown Patterns</strong>: Techniques to ensure no resource leaks during server termination.</li>
<li>‚ö° <strong>Error Handling in Tool Execution</strong>: How robust error handling maintains system stability.</li>
<li>üí° <strong>Pre-Processing Optimization</strong>: The importance of pre-generating content for responsive user experiences.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The <code class="inline-code">server.ts</code> file serves as the heart of the Mystic MCP Interface, managing all interactions between the enchanted tools and adventurers through the MCP protocol. It dynamically lists and executes tools, pre-generates content for swift responses, and ensures graceful shutdowns in the face of unforeseen events. The file demonstrates the principles of modular design, schema-driven validation, and robust error handling, all essential for a stable and responsive interface.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code>: Dynamically registers tools and validates their schemas for safe execution.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>: Starts the MCP server, pre-generates repository content, and establishes the server transport.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>: Orchestrates server initialization and handles graceful shutdowns for system integrity.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  // Dynamic tool listing
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));
    return { tools: toolList };
  });

  // Dynamic tool execution
  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools and their schemas, enabling seamless extensibility.</li>
<li>Validates input arguments using Zod schemas, ensuring type safety and preventing invalid requests.</li>
<li>Implements error handling to distinguish between client errors (e.g., invalid parameters) and server-side failures.</li>
<li>Decouples tool registration from execution, allowing independent updates to tools without modifying core server logic.</li>
<li>Demonstrates defensive programming to maintain system stability during unexpected scenarios.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the MCP server using the <code class="inline-code">StdioServerTransport</code>, enabling communication through standard input/output.</li>
<li>Pre-generates repository content in the background, reducing latency during user interactions.</li>
<li>Logs server status and initialization details for monitoring and debugging purposes.</li>
<li>Demonstrates the use of asynchronous operations to handle long-running tasks without blocking server responsiveness.</li>
<li>Highlights the importance of pre-processing to enhance user experience by minimizing delays during critical operations.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Coordinates server initialization, ensuring all components are set up before the server starts.</li>
<li>Handles system signals (<code class="inline-code">SIGINT</code> and <code class="inline-code">SIGTERM</code>) to ensure a graceful shutdown and avoid resource leaks.</li>
<li>Logs unhandled promise rejections for debugging while keeping the server operational.</li>
<li>Separates initialization logic into distinct steps, following the single responsibility principle.</li>
<li>Demonstrates robust error handling, logging fatal errors and exiting gracefully when necessary.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The <code class="inline-code">tools.ts</code> file acts as a registry for all the enchanted tools in the MCP ecosystem. Each tool corresponds to a specific action adventurers can take, such as starting an adventure or exploring a quest. This file encapsulates tool logic and exports them for dynamic registration, ensuring modularity and maintainability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code>: Analyzes the codebase and initializes the adventure.</li>
<li><code class="inline-code">choose_theme</code>: Generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code>: Allows adventurers to delve into individual quests.</li>
<li><code class="inline-code">view_progress</code>: Reports the current progress and remaining challenges.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Provides a centralized registry for all tools, simplifying their dynamic registration in the MCP server.</li>
<li>Encapsulates tool logic to maintain separation of concerns between tool implementation and server functionality.</li>
<li>Exports individual tools with descriptive names, improving code readability and maintainability.</li>
<li>Ensures future extensibility by allowing new tools to be added without modifying the server logic.</li>
<li>Demonstrates how modular design principles enhance the clarity and scalability of the codebase.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how the <code class="inline-code">setupHandlers</code> method dynamically registers tools and validates schemas, as this pattern is critical for extensible systems.</li>
<li>Observe the use of asynchronous operations in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a>, which allow for non-blocking background tasks like pre-generating content.</li>
<li>Review the error handling patterns in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a>, especially how they distinguish between recoverable and fatal errors.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that lists all files in the current project directory. Update the <code class="inline-code">tools</code> registry and test its integration with the MCP server.</p>
<ul>
<li>Example: Use Node.js&#39; <code class="inline-code">fs</code> module to retrieve and return file names.</li>
</ul>
</li>
<li><p><strong>Trace Tool Lifecycle</strong>: Add logging statements to trace the lifecycle of a tool request, from <code class="inline-code">setupHandlers</code> to execution. Run the server and observe the logged output to understand the flow.</p>
</li>
<li><p><strong>Enhance Error Messages</strong>: Modify the error handling logic in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tool names when an unknown tool is called. This will improve user feedback and error clarity.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of Codethia‚Äôs enchanted codebase.</p>
<p>Brave seeker of knowledge, thou hast unlocked the first arcane seal of the Mystic MCP Interface, casting a radiant beacon upon thy path to mastery‚Äîpress on, for the stars themselves salute thy triumph! üåü‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>