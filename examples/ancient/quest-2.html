<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Glyphs of the MCP Interface - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Glyphs of the MCP Interface</h1>
<hr>
<p>Within the labyrinthine corridors of the Sacred Repository lies the MCP Interface Chamber, where ancient glyphs hum with arcane energy. These glyphs are not mere decorations but the keys to interacting with the repository&#39;s tools, each representing a unique ritual for code exploration. As you approach the interface, you must decipher the glyphs and activate their hidden mechanisms. Only by mastering these ancient inscriptions can you unlock the full potential of the repository and uncover the secrets of its operation.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically registered and validated using schemas.</li>
<li>üîç <strong>Defensive Error Handling</strong>: Techniques for ensuring robust error management in tool execution.</li>
<li>‚ö° <strong>Graceful Shutdown Patterns</strong>: How to safely terminate processes while preserving system integrity.</li>
<li>üí° <strong>Pre-Generation Strategies</strong>: How caching and warm-up sequences improve responsiveness in interactive systems.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>The MCP Interface Chamber is powered by the <code class="inline-code">RepoAdventureServer</code> class, which orchestrates tool registration, communication protocols, and system lifecycle management. This file showcases advanced patterns for dynamic tool handling, schema validation, and error recovery, ensuring the interface remains stable and responsive. The pre-generation strategy employed here warms up the repository analysis cache, enabling faster interactions during user commands.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools with schema validation and provides handlers for tool execution requests.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the MCP server, connects to the transport layer, and triggers pre-generation of repository content.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates the server startup, sets up signal handling for graceful shutdowns, and logs unhandled promise rejections.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);

    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>This code dynamically registers tools and validates their schemas, ensuring type safety and correctness.</li>
<li>The <code class="inline-code">ListToolsRequestSchema</code> handler lists available tools, aiding discoverability for users.</li>
<li>Defensive programming is demonstrated through error handling patterns, protecting the interface from invalid inputs.</li>
<li>The <code class="inline-code">safeParse</code> method ensures arguments conform to the tool&#39;s schema before execution.</li>
<li>This modular approach allows new tools to be added without modifying core server logic.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);
  
  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> method connects the MCP server to the transport layer, enabling communication with external clients.</li>
<li>Pre-generating repository content warms up the cache, reducing latency during initial user interactions.</li>
<li>The use of <code class="inline-code">process.cwd()</code> ensures the server operates on the current project directory.</li>
<li>This strategy highlights the importance of background processing for improving responsiveness.</li>
<li>The method balances initialization and resource management for optimal performance.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();
    
    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );
    
    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });
    
    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> function handles server startup and signal-based shutdowns, ensuring graceful termination during interruptions.</li>
<li>Signal handling demonstrates robust lifecycle management for long-running processes.</li>
<li>Logging unhandled promise rejections aids debugging while keeping the server operational.</li>
<li>The separation of initialization and error handling creates a clear startup pipeline.</li>
<li>This design ensures the MCP server maintains stability even under adverse conditions.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>The glyphs of the MCP Interface are represented by the <code class="inline-code">tools</code> object, which encapsulates all available tools for code exploration. This file demonstrates the modular organization of tools, each with a distinct purpose and handler function. By abstracting tools into separate files, the system achieves maintainability and scalability.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure.handler</code> initializes repository analysis and presents theme options to users.</li>
<li><code class="inline-code">choose_theme.handler</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest.handler</code> enables users to explore individual quests dynamically.</li>
<li><code class="inline-code">view_progress.handler</code> provides completion status and remaining quests for tracking user progress.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>The <code class="inline-code">tools</code> object aggregates all tool handlers, simplifying their registration and usage.</li>
<li>Each tool is modular, with its logic defined in separate files for better maintainability.</li>
<li>This structure supports the MCP naming convention, ensuring consistency across the interface.</li>
<li>The modular approach allows new tools to be added without impacting existing functionality.</li>
<li>The organization reflects the principle of separation of concerns, improving readability and scalability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">zodToJsonSchema</code> converts Zod schemas into JSON schemas for validation across communication boundaries.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how caching improves system responsiveness.</li>
<li>Explore the modular tool structure in <code class="inline-code">tools.ts</code> to see how abstraction aids maintainability.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a Custom Tool</strong>: Create a new tool called <code class="inline-code">analyze_code_quality</code> that evaluates the cyclomatic complexity of functions in the repository. Register it in <code class="inline-code">tools.ts</code> and test its integration with the MCP server.</p>
</li>
<li><p><strong>Trace Tool Execution Flow</strong>: Add logging statements in <code class="inline-code">setupHandlers</code> to trace the flow of tool execution, from request validation to handler invocation. Run the server and observe the logs to understand the lifecycle of a tool request.</p>
</li>
<li><p><strong>Improve Error Feedback</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to suggest the closest matching tool name when an unknown tool is requested. This will enhance user experience and demonstrate advanced defensive programming techniques.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Sacred Repository.</p>
<p>By the sacred light of the ancients, thou hast unveiled the first of five hallowed Glyphs, a triumph that illuminates thy path through the temple of wisdom‚Äîpress onward, seeker of truth, for destiny awaits! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>