<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hall of Ritual Tools - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Lost Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 2: The Hall of Ritual Tools</h1>
<hr>
<p>The Hall of Ritual Tools lies within the labyrinthine depths of the Lost Repository, shrouded in mystery and silence. Here, ancient scholars once crafted mechanisms to harness the wisdom of their civilization. Each tool, etched with glyphs of purpose, awaits an explorer capable of unlocking its secrets. As you step into this sacred chamber, the air hums with latent energy. Your task is to understand the intricate rituals embedded in these tools, decipher their roles, and awaken their dormant powers to progress further into the Repository.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Dynamic Tool Registration</strong>: How tools are dynamically listed and validated using schemas.</li>
<li>üîç <strong>Error Handling</strong>: The use of custom error types to ensure robust tool execution.</li>
<li>‚ö° <strong>Pre-Generation Optimization</strong>: How pre-generating content improves runtime performance.</li>
<li>üí° <strong>Graceful Shutdown</strong>: Techniques for managing server cleanup and ensuring a stable exit.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/server.ts</code></a></h3>
<p>This file serves as the gateway to the Hall of Ritual Tools, managing the lifecycle of the MCP server. It dynamically registers tools, validates user inputs, and executes tool handlers. It also ensures the server operates smoothly through robust error handling, pre-generates content to optimize performance, and gracefully shuts down when required.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">setupHandlers</code> dynamically registers tools and validates input schemas for secure and extensible operations.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> initializes the server transport, pre-generates repository content, and prepares the system for user interactions.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> orchestrates the server startup, handles process signals, and manages unhandled rejections for stability.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">private setupHandlers() {
  this.server.setRequestHandler(ListToolsRequestSchema, async () =&gt; {
    const toolList = Object.entries(tools).map(([name, tool]) =&gt; ({
      name,
      description: tool.description,
      inputSchema: zodToJsonSchema(tool.schema, { 
        target: &#39;jsonSchema7&#39;,
        $refStrategy: &#39;none&#39;
      })
    }));

    return { tools: toolList };
  });

  this.server.setRequestHandler(CallToolRequestSchema, async (request) =&gt; {
    try {
      const { name, arguments: args } = request.params;

      if (!(name in tools)) {
        throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
      }

      const tool = tools[name as keyof typeof tools];
      const validationResult = tool.schema.safeParse(args);
      if (!validationResult.success) {
        const errorMessages = validationResult.error.issues.map((err) =&gt; 
          `${err.path.join(&#39;.&#39;)}: ${err.message}`
        ).join(&#39;, &#39;);
        throw new McpError(ErrorCode.InvalidParams, `Invalid parameters: ${errorMessages}`);
      }

      return await tool.handler(validationResult.data as any);
    } catch (error) {
      if (error instanceof McpError) {
        throw error;
      }
      throw new McpError(
        ErrorCode.InternalError,
        `Tool execution failed: ${error instanceof Error ? error.message : String(error)}`
      );
    }
  });
}
</code></pre>
<ul>
<li>Dynamically registers tools and their schemas, enabling extensibility without modifying core logic.</li>
<li>Validates user inputs against Zod schemas, preventing invalid or malicious data from being processed.</li>
<li>Custom error handling ensures clear feedback for both tool validation and execution failures.</li>
<li>Decouples tool registration from execution, adhering to the single responsibility principle.</li>
<li>Demonstrates defensive programming by safeguarding against unknown tools and invalid parameters.</li>
</ul>
<hr>
<pre><code class="language-typescript">async run() {
  const transport = new StdioServerTransport();
  await this.server.connect(transport);
  console.error(&#39;Repo Adventure MCP server running on stdio&#39;);

  const projectPath = process.cwd();
  console.error(`Pre-generating repomix content for project at ${projectPath}...`);
  repoAnalyzer.preGenerate(projectPath);
}
</code></pre>
<ul>
<li>Initializes the server transport to facilitate communication between tools and clients.</li>
<li>Pre-generates repository content to warm up caches, reducing latency during runtime.</li>
<li>Logs key server events for monitoring and debugging purposes.</li>
<li>Uses asynchronous operations to ensure non-blocking execution during initialization.</li>
<li>Highlights the importance of pre-computation in optimizing user experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">async main() {
  try {
    const server = new RepoAdventureServer();

    [&#39;SIGINT&#39;, &#39;SIGTERM&#39;].forEach(sig =&gt; 
      process.on(sig as NodeJS.Signals, gracefulShutdown)
    );

    process.on(&#39;unhandledRejection&#39;, (reason) =&gt; {
      console.error(&#39;Unhandled promise rejection:&#39;, reason);
      console.error(&#39;MCP server continuing to run. Please report this error.&#39;);
    });

    await server.run();
  } catch (error) {
    console.error(&#39;Fatal error starting MCP server:&#39;, error);
    process.exit(1);
  }
}
</code></pre>
<ul>
<li>Manages the server&#39;s lifecycle, handling startup, runtime errors, and shutdown signals.</li>
<li>Implements graceful shutdown procedures to ensure resources are cleaned up properly.</li>
<li>Logs unhandled promise rejections for debugging without halting server operations.</li>
<li>Encapsulates error handling to prevent fatal crashes during initialization.</li>
<li>Demonstrates resilience and reliability in server design.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/tools.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/mcp/src/tools.ts</code></a></h3>
<p>This file defines the collection of tools available in the Hall of Ritual Tools. It organizes them into a single registry, ensuring a consistent interface for dynamic registration and execution. Each tool encapsulates a specific functionality, contributing to the overall exploration experience.</p>
<h4>Highlights</h4>
<ul>
<li><code class="inline-code">start_adventure</code> initializes the exploration process by analyzing the repository and presenting theme options.</li>
<li><code class="inline-code">choose_theme</code> generates a custom story and quests based on the selected theme.</li>
<li><code class="inline-code">explore_quest</code> allows users to delve into individual quests, uncovering specific details of the repository.</li>
<li><code class="inline-code">view_progress</code> tracks completion status and displays remaining quests.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export const tools = {
  start_adventure,
  choose_theme,
  explore_quest,
  view_progress
};
</code></pre>
<ul>
<li>Provides a centralized registry for all tools, simplifying dynamic registration in the server.</li>
<li>Adheres to the single responsibility principle by delegating tool-specific logic to individual modules.</li>
<li>Enables extensibility by allowing new tools to be added without modifying the core server logic.</li>
<li>Maintains a clear and consistent interface for clients interacting with the MCP server.</li>
<li>Demonstrates modular design by separating tool definitions from their implementation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">setupHandlers</code> uses Zod schemas to ensure type-safe communication between the server and tools.</li>
<li>Observe the pre-generation strategy in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">run</code></a> to understand how caching improves performance in interactive systems.</li>
<li>Explore the graceful shutdown logic in <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/mcp/src/server.ts#L108" target="_blank" rel="noopener noreferrer"><code class="inline-code">main</code></a> to learn techniques for managing server cleanup during unexpected terminations.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add a New Tool</strong>: Create a new tool called <code class="inline-code">list_files</code> that returns a list of files in the current repository. Register it in the <code class="inline-code">tools</code> registry and implement its schema and handler.</p>
<ul>
<li>Example: Use <code class="inline-code">fs</code> to read the directory structure and return the result.</li>
</ul>
</li>
<li><p><strong>Trace Tool Execution</strong>: Add <code class="inline-code">console.log</code> statements in <code class="inline-code">setupHandlers</code> to trace the flow of tool execution. Observe how requests are routed from the client to the server and back.</p>
</li>
<li><p><strong>Enhance Error Feedback</strong>: Modify the error handling in <code class="inline-code">CallToolRequestSchema</code> to include suggestions for valid tool names when an unknown tool is requested. This will improve the user experience.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries hidden within the Lost Repository.</p>
<p>Hail, seeker of wisdom, for thou hast unlocked the sacred Hall of Ritual Tools, etching the first triumphant mark upon thy journey toward divine mastery‚Äîpress onward, for the ancients favor thy path! ‚ö°üíéüó∫Ô∏è</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-1.html" class="prev-quest-btn">‚Üê Previous: Quest 1</a>
        <a href="quest-3.html" class="next-quest-btn">Next: Quest 3 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>