<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Forge of Sacred Tales - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Lost Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: The Forge of Sacred Tales</h1>
<hr>
<p>In the heart of the jungle lies the Forge of Sacred Tales, a hidden chamber within the Lost Repository. This enigmatic forge is said to refine raw knowledge into structured wisdom, crafting legendary narratives that guide explorers through the labyrinth of ancient code. Your task is to master the art of storytelling by deciphering the scripts that power the Repository‚Äôs quest generation engine. Each discovery will bring you closer to unlocking the secrets of the repository‚Äôs narrative core.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Quest Generation Workflow</strong>: How dynamic quests are generated and integrated into the adventure system.</li>
<li>üîç <strong>Content Parsing</strong>: Techniques for extracting structured data from markdown and JSON configurations.</li>
<li>‚ö° <strong>Dynamic Story Generation</strong>: How themes influence story and quest creation through LLM-driven prompts.</li>
<li>üí° <strong>Configuration Integration</strong>: How adventure configuration files enhance and guide the quest generation process.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> serves as the central orchestrator for generating and managing adventures. It initializes the adventure state, validates user choices, and dynamically constructs quests using LLM-generated content and configuration files. This file demonstrates the integration of repository analysis, configuration parsing, and LLM interactions to deliver a cohesive user experience.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a> resets the adventure state and generates the overarching story and quests.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a> handles user-selected quests, validating choices and caching completed content.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> dynamically generates quest-specific content using LLM responses and context chunking.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();

  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>Resets the adventure state to ensure a clean slate for new adventures.</li>
<li>Integrates configuration files to merge or limit quests based on predefined rules.</li>
<li>Utilizes LLM-generated story and quest data to dynamically adapt to the project context.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>Validates user input to ensure a valid quest choice.</li>
<li>Handles special cases such as progress requests and invalid choices gracefully.</li>
<li>Executes the selected quest, leveraging cached content for previously completed quests.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async generateQuestContent(quest: Quest): Promise&lt;QuestContent&gt; {
  let codeContent: string;

  if (this.state.projectPath) {
    const config = parseAdventureConfig(this.state.projectPath);
    const hasConfigOptimization = config &amp;&amp; typeof config === &#39;object&#39; &amp;&amp; &#39;adventure&#39; in config;

    if (quest.codeFiles &amp;&amp; quest.codeFiles.length &gt; 0) {
      try {
        const targetedContent = await repoAnalyzer.generateTargetedContent(
          this.state.projectPath,
          quest.codeFiles,
          false
        );
        codeContent = repoAnalyzer.prependCoreProjectContext(this.state.projectPath, targetedContent);
      } catch {
        codeContent = hasConfigOptimization
          ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
          : this.state.projectInfo!.repomixContent;
      }
    } else {
      codeContent = hasConfigOptimization
        ? await repoAnalyzer.generateRepomixContext(this.state.projectPath)
        : this.state.projectInfo!.repomixContent;
    }
  } else {
    codeContent = this.state.projectInfo!.repomixContent;
  }

  const chunkResult = ContentChunker.chunkContent(codeContent);
  return await this.storyGenerator.generateQuestContent({
    quest,
    theme: this.state.currentTheme!,
    chunkResult,
    questPosition: this.state.quests.findIndex(q =&gt; q.id === quest.id) + 1,
    totalQuests: this.state.quests.length
  });
}
</code></pre>
<ul>
<li>Prioritizes quest-specific files for targeted content generation.</li>
<li>Falls back to configuration-based or full repository content when specific files are unavailable.</li>
<li>Uses content chunking to optimize large codebases for LLM processing.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> is responsible for creating the narrative and quest content for adventures. It integrates with LLMs to generate dynamic stories and quests based on the project‚Äôs context and theme. This file showcases advanced prompt engineering and structured markdown parsing.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a> combines repository content and theme-specific prompts to generate the adventure‚Äôs narrative.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> processes code content in chunks, ensuring scalability for large projects.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a> extracts structured data from LLM-generated markdown responses.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  const repomixContent = projectInfo.repomixContent || &#39;No repomix content available&#39;;

  const adventureGuidance = this.projectPath ? formatAdventureConfigForPrompt(this.projectPath) : &#39;&#39;;
  const customInstructions = this.projectPath ? extractCustomInstructions(this.projectPath) : &#39;&#39;;

  const prompt = loadStoryGenerationPrompt({
    theme,
    repomixContent,
    ...(adventureGuidance &amp;&amp; { adventureGuidance }),
    ...(customInstructions &amp;&amp; { customInstructions }),
    ...(this.customThemeData &amp;&amp; { customThemeData: this.customThemeData })
  });

  const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_STORY, context: &#39;story &amp; quests&#39; });

  let parsed = parseMarkdownToStoryResponse(response.content.trim());
  StoryResponseSchema.parse(parsed);

  this.currentStoryContent = parsed.story;
  return parsed;
}
</code></pre>
<ul>
<li>Generates a cohesive story and quest list using a combination of repository content and theme-specific prompts.</li>
<li>Validates LLM responses with Zod schemas to ensure structured output.</li>
<li>Incorporates configuration data and custom instructions to guide the narrative.</li>
</ul>
<hr>
<pre><code class="language-typescript">function parseMarkdownToStoryResponse(markdownContent: string): StoryResponse {
  const tokens = marked.lexer(markdownContent);

  const title = extractTitle(tokens);
  let story = &#39;&#39;;
  const quests: Quest[] = [];

  let currentSection = &#39;&#39;;
  let currentQuest: Partial&lt;Quest&gt; = {};
  let titleFound = false;

  for (const token of tokens) {
    if (token.type === &#39;heading&#39;) {
      if (token.depth === 1) {
        titleFound = true;
        currentSection = &#39;story&#39;;
      } else if (token.depth === 2) {
        currentSection = token.text.toLowerCase();
      } else if (token.depth === 3 &amp;&amp; isQuestSection(currentSection)) {
        if (currentQuest.title &amp;&amp; currentQuest.description) {
          quests.push(createQuest(currentQuest, quests.length));
        }
        currentQuest = { title: token.text, description: &#39;&#39;, codeFiles: [] };
      }
    } else if (token.type === &#39;paragraph&#39;) {
      if (isStorySection(currentSection, titleFound)) {
        story += token.text + &#39;\n\n&#39;;
      } else if (currentQuest.title) {
        currentQuest.description += token.text + &#39;\n\n&#39;;
      }
    }
  }

  if (currentQuest.title &amp;&amp; currentQuest.description) {
    quests.push(createQuest(currentQuest, quests.length));
  }

  return { title, story: story.trim(), quests };
}
</code></pre>
<ul>
<li>Parses LLM-generated markdown into structured story and quest data.</li>
<li>Supports multiple quest formats, ensuring flexibility in content generation.</li>
<li>Handles nested structures and extracts relevant details for each quest.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<p>The <code class="inline-code">adventure-config.ts</code> file handles the parsing and validation of adventure configuration files. These configurations guide the quest generation process, ensuring alignment with user-defined rules and preferences.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">loadAdventureConfig</code></a> reads raw configuration data from the project directory.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L28" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseAdventureConfig</code></a> validates and parses the configuration into a usable format.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a> identifies and validates file paths referenced in the configuration.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, &#39;adventure.config.json&#39;);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>Reads the configuration file from the project directory.</li>
<li>Ensures non-fatal handling of missing or unreadable files.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function parseAdventureConfig(projectPath: string): unknown | null {
  const raw = loadAdventureConfig(projectPath);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
</code></pre>
<ul>
<li>Parses raw JSON configuration data into an object.</li>
<li>Provides a single point for JSON validation and error handling.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (node &amp;&amp; typeof node === &#39;object&#39;) {
      if (typeof node.path === &#39;string&#39; &amp;&amp; fs.existsSync(path.resolve(projectPath, node.path.trim()))) {
        unique.add(node.path.trim());
      }
      const children = Array.isArray(node) ? node : Object.values(node);
      stack.push(...children);
    }
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>Extracts all unique file paths referenced in the configuration.</li>
<li>Validates file existence to prevent errors during quest generation.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a> as a template for integrating new themes or custom configurations.</li>
<li>Study <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a> to understand how structured data is extracted from markdown.</li>
<li>Explore how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a> prioritizes quest-specific files for targeted content generation.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><strong>Add a New Quest Format</strong>: Modify <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L124" target="_blank" rel="noopener noreferrer"><code class="inline-code">parseMarkdownToStoryResponse</code></a> to support an additional quest format, such as bullet points with file paths. Test your changes by simulating LLM responses.</li>
<li><strong>Integrate Custom Instructions</strong>: Add a custom instruction in <code class="inline-code">adventure.config.json</code> and observe how it influences the generated story and quests.</li>
<li><strong>Optimize Content Chunking</strong>: Experiment with different chunk sizes in <code class="inline-code">ContentChunker</code> to see how it affects LLM performance and response quality.</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Repository‚Äôs sacred mechanisms.</p>
<p>By the eternal flame of the ancients, thou hast unlocked the hallowed wisdom of &#39;The Forge of Sacred Tales,&#39; a triumph worthy of the sacred scrolls‚Äîpress on, seeker, for thy journey nears the stars! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>