<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unearth the Quest Engine Chambers - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-ancient">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Sacred Repository of Ancient Wisdom</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Unearth the Quest Engine Chambers</h1>
<hr>
<p>Deep within the labyrinthine corridors of the Sacred Repository lies the Quest Engine Chambers, a marvel of ancient ingenuity. These chambers house the mechanisms that breathe life into every adventure, weaving narratives and challenges from the glyphs inscribed on sacred scrolls. Your task is to delve into these chambers, decipher their glyphs, and activate the ancient rituals that govern the quest generation process. Each discovery brings you closer to unlocking the full potential of the repository‚Äôs wisdom.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Quest Initialization</strong>: How <code class="inline-code">AdventureManager</code> orchestrates story and quest generation using project context and themes.</li>
<li>üîç <strong>Dynamic Content Processing</strong>: How <code class="inline-code">StoryGenerator</code> processes code chunks and generates coherent quest narratives.</li>
<li>‚ö° <strong>Config-Driven Enhancements</strong>: How <code class="inline-code">adventure-config.ts</code> integrates project-specific configurations into quests.</li>
<li>üí° <strong>Content Optimization</strong>: Techniques for chunking large codebases to optimize LLM processing.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/adventure-manager.ts</code></a></h3>
<p>The <code class="inline-code">AdventureManager</code> class serves as the heart of the quest engine, coordinating the initialization, execution, and management of quests. It leverages project context and user-selected themes to generate tailored adventures. By merging configuration data from <code class="inline-code">adventure-config.ts</code>, it ensures quests are enriched with project-specific insights. This file exemplifies state management, dynamic content generation, and user-driven exploration.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L59" target="_blank" rel="noopener noreferrer"><code class="inline-code">initializeAdventure</code></a>: Sets up the adventure by generating the story and quests, merging configuration data, and managing state.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a>: Executes a specific quest based on user input, caching completed quests for efficient revisits.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Dynamically generates quest content by processing code chunks and integrating project context.</li>
<li><code class="inline-code">progressPercentage</code>: Calculates the percentage of quests completed, providing a visual indicator of progress.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async initializeAdventure(
  projectInfo: ProjectInfo, 
  theme: AdventureTheme, 
  projectPath?: string,
  customThemeData?: CustomThemeData
): Promise&lt;string&gt; {
  this.state.reset();
  this.state.projectInfo = projectInfo;
  this.state.currentTheme = theme;
  this.state.projectPath = projectPath || process.cwd();
  
  if (theme === &#39;custom&#39; &amp;&amp; customThemeData) {
    this.storyGenerator.setCustomTheme(customThemeData);
  }

  const storyResponse = await this.storyGenerator.generateStoryAndQuests(projectInfo, theme, this.state.projectPath);
  this.state.title = storyResponse.title;
  this.state.story = storyResponse.story;
  this.state.quests = this.mergeQuestFilesFromConfig(storyResponse.quests, this.state.projectPath);
  this.state.quests = this.enforceConfigQuestCount(this.state.quests, this.state.projectPath);

  return this.formatStoryWithQuests({
    ...storyResponse,
    quests: this.state.quests
  });
}
</code></pre>
<ul>
<li>This code initializes an adventure by resetting state, setting project context, and generating story and quest data.</li>
<li>It merges files from <code class="inline-code">adventure-config.ts</code> to ensure quests align with project-specific requirements.</li>
<li>Custom themes are supported, allowing dynamic adjustment of narrative elements.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L502" target="_blank" rel="noopener noreferrer"><code class="inline-code">formatStoryWithQuests</code></a> method organizes the generated content for user presentation.</li>
</ul>
<hr>
<pre><code class="language-typescript">async exploreQuest(choice: string): Promise&lt;AdventureResult&gt; {
  const sanitizedChoice = this.validateAndSanitizeChoice(choice);

  if (this.isProgressRequest(sanitizedChoice)) {
    return this.getProgress();
  }

  const quest = this.findQuest(sanitizedChoice);
  if (!quest) {
    return this.createNotFoundResult();
  }

  return await this.executeQuest(quest);
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L109" target="_blank" rel="noopener noreferrer"><code class="inline-code">exploreQuest</code></a> method validates user input and executes the corresponding quest.</li>
<li>Progress requests are handled separately, allowing users to view their completion status.</li>
<li>Quest caching ensures efficient revisits without redundant content generation.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L198" target="_blank" rel="noopener noreferrer"><code class="inline-code">createNotFoundResult</code></a> method provides user-friendly error handling for invalid choices.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/adventure/story-generator.ts</code></a></h3>
<p>The <code class="inline-code">StoryGenerator</code> class is responsible for creating the narrative and quests for each adventure. It processes large codebases by chunking content and iteratively generating coherent stories. This file showcases advanced LLM integration, markdown parsing, and dynamic content enhancement.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L299" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateStoryAndQuests</code></a>: Generates the initial story and quests based on project context and selected theme.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/adventure-manager.ts#L269" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateQuestContent</code></a>: Processes code chunks to create detailed quest narratives and exploration content.</li>
<li><code class="inline-code">processChunkedQuestContent</code>: Handles iterative content generation for large codebases, ensuring coherence across chunks.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L524" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractMarkdownContent</code></a>: Cleans and extracts markdown content from LLM responses.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async generateStoryAndQuests(projectInfo: ProjectInfo, theme: AdventureTheme, projectPath?: string): Promise&lt;StoryResponse&gt; {
  this.currentProject = projectInfo;
  this.projectPath = projectPath;

  const validatedTheme = this.validateTheme(theme);
  return await this.generateWithLLM(projectInfo, validatedTheme);
}
</code></pre>
<ul>
<li>This method initializes the story and quests using LLM, validating the selected theme and project context.</li>
<li>It integrates configuration data to enhance the generated content.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L627" target="_blank" rel="noopener noreferrer"><code class="inline-code">generateWithLLM</code></a> method ensures reliable generation of structured story responses.</li>
</ul>
<hr>
<pre><code class="language-typescript">private async processChunkedQuestContent(
  quest: Quest,
  theme: AdventureTheme,
  chunkResult: ChunkResult,
  adventureGuidance: string,
  customInstructions: string,
  questPosition?: number,
  totalQuests?: number
): Promise&lt;QuestContent&gt; {
  let accumulatedContent = &#39;&#39;;
  let contextSummary = &#39;&#39;;

  for (let i = 0; i &lt; chunkResult.chunks.length; i++) {
    const chunk = chunkResult.chunks[i];
    const isFirstChunk = i === 0;
    const isLastChunk = i === chunkResult.chunks.length - 1;

    let prompt: string;
    if (isFirstChunk) {
      prompt = loadQuestContentPrompt({
        theme,
        adventureTitle: quest.title,
        codeContent: chunk.content,
        storyContent: this.currentStoryContent || &#39;No story context available.&#39;,
        adventureGuidance: adventureGuidance || &#39;&#39;,
        ...(customInstructions &amp;&amp; { customInstructions }),
        questPosition,
        totalQuests
      });
    } else if (isLastChunk) {
      prompt = `You are continuing to generate quest content for &quot;${quest.title}&quot; with a ${theme} theme.

Previous story context: ${contextSummary}

Here is the final part of the codebase:
${chunk.content}

Please enhance and finalize the adventure story based on this additional context. This is the final part (${i + 1}/${chunkResult.chunks.length}).`;
    } else {
      prompt = `You are continuing to generate quest content for &quot;${quest.title}&quot; with a ${theme} theme.

Previous story context: ${contextSummary}

Here is part ${i + 1} of ${chunkResult.chunks.length} of the codebase:
${chunk.content}

Please enhance and expand the adventure story based on this additional context.`;
    }

    const response = await this.llmClient.generateResponse(prompt, { maxTokens: LLM_MAX_TOKENS_QUEST, context: &#39;quest chunk&#39; });
    accumulatedContent = this.extractMarkdownContent(response.content);
    contextSummary = await this.generateContextSummary(accumulatedContent, theme, i + 1, chunkResult.chunks.length);
  }

  return {
    adventure: accumulatedContent,
    fileExploration: &#39;&#39;,
    codeSnippets: [],
    hints: []
  };
}
</code></pre>
<ul>
<li>Iterative chunk processing ensures large codebases are handled efficiently while maintaining narrative coherence.</li>
<li>Context summaries are generated between chunks to provide continuity for LLM responses.</li>
<li>The <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/adventure/story-generator.ts#L524" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractMarkdownContent</code></a> method cleans and formats the LLM output for user presentation.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">packages/core/src/shared/adventure-config.ts</code></a></h3>
<p>The <code class="inline-code">adventure-config.ts</code> file integrates project-specific configuration into the quest generation process. It extracts file paths, parses configuration data, and formats it for LLM prompts. This file highlights the importance of config-driven enhancements in dynamic systems.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L19" target="_blank" rel="noopener noreferrer"><code class="inline-code">loadAdventureConfig</code></a>: Reads the raw adventure configuration file from the project directory.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a>: Identifies unique file paths referenced in the configuration for targeted analysis.</li>
<li><a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L75" target="_blank" rel="noopener noreferrer"><code class="inline-code">formatAdventureConfigForPrompt</code></a>: Formats configuration data into a compact structure for LLM processing.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">export function loadAdventureConfig(projectPath: string): string | null {
  const configPath = path.join(projectPath, ADVENTURE_CONFIG_FILE);
  return readFileIfExists(configPath);
}
</code></pre>
<ul>
<li>This function reads the adventure configuration file, ensuring the system can access project-specific settings.</li>
<li>It handles missing or unreadable files gracefully, avoiding runtime errors.</li>
<li>The use of <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L6" target="_blank" rel="noopener noreferrer"><code class="inline-code">readFileIfExists</code></a> demonstrates defensive programming practices.</li>
</ul>
<hr>
<pre><code class="language-typescript">export function extractUniqueFilePaths(projectPath: string): string[] {
  const parsed = parseAdventureConfig(projectPath);
  if (!parsed || typeof parsed !== &#39;object&#39;) return [];

  const unique = new Set&lt;string&gt;();
  const stack: any[] = [parsed];

  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== &#39;object&#39;) continue;

    if (typeof node.path === &#39;string&#39; &amp;&amp; node.path.trim()) {
      const rel = node.path.trim();
      if (fs.existsSync(path.resolve(projectPath, rel))) {
        unique.add(rel);
      }
    }

    const children = Array.isArray(node) ? node : Object.values(node);
    children.forEach(child =&gt; {
      if (child &amp;&amp; typeof child === &#39;object&#39;) stack.push(child);
    });
  }

  return Array.from(unique);
}
</code></pre>
<ul>
<li>This function extracts unique file paths from the configuration, validating their existence in the project directory.</li>
<li>It uses a stack-based approach to traverse nested structures, ensuring all relevant paths are identified.</li>
<li>The use of <code class="inline-code">Set</code> ensures duplicate paths are eliminated.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Study how <code class="inline-code">AdventureManager</code> merges configuration data to enhance quest generation.</li>
<li>Observe the chunking process in <code class="inline-code">StoryGenerator</code> for handling large codebases efficiently.</li>
<li>Explore how <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L75" target="_blank" rel="noopener noreferrer"><code class="inline-code">formatAdventureConfigForPrompt</code></a> reduces configuration size for LLM processing.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add Custom Configurations</strong>: Modify <code class="inline-code">adventure.config.json</code> to include additional file paths and highlights. Observe how <code class="inline-code">AdventureManager</code> integrates these changes into quest generation.</p>
</li>
<li><p><strong>Trace Chunk Processing</strong>: Add logging statements in <code class="inline-code">processChunkedQuestContent</code> to visualize how content chunks are processed and summarized. This will help you understand iterative content generation.</p>
</li>
<li><p><strong>Optimize File Path Extraction</strong>: Refactor <a href="https://github.com/danwahlin/ai-repo-adventures/blob/main/packages/core/src/shared/adventure-config.ts#L41" target="_blank" rel="noopener noreferrer"><code class="inline-code">extractUniqueFilePaths</code></a> to improve performance for large configurations. Consider using asynchronous file system operations for better scalability.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Sacred Repository.</p>
<p>By the sacred light of the ancients, thou hast unlocked the hidden chambers of the Quest Engine, a feat most worthy of eternal lore‚Äîpress onward, seeker of wisdom, for the stars yet hold 60% of their secrets! ‚≠ê‚ö°üíé</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>